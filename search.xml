<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Markdown相關</title>
    <url>/Markdown%E7%9B%B8%E9%97%9C/</url>
    <content><![CDATA[<p>這邊我會介紹我常用的 markdown 語法</p>
<h2 id="標題"><a href="#標題" class="headerlink" title="# 標題"></a><font color=DarkGreen face="黑体">#</font> <font face="黑体">標題</font></h2><p>有六種標題的大小</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#        標題1</span><br><span class="line">##       標題2</span><br><span class="line">###      標題3</span><br><span class="line">####     標題4</span><br><span class="line">#####    標題5</span><br><span class="line">######   標題6</span><br></pre></td></tr></table></figure>
<h2 id="分隔線"><a href="#分隔線" class="headerlink" title="# 分隔線"></a><font color=DarkGreen face="黑体">#</font> <font face="黑体">分隔線</font></h2><p>“-“連續三個減號，也可以叫 dash 比較潮，這樣就會跑出一個分隔線</p>
<hr>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">---</span><br></pre></td></tr></table></figure>
<h2 id="縮排、引言"><a href="#縮排、引言" class="headerlink" title="# 縮排、引言"></a><font color=DarkGreen face="黑体">#</font> <font face="黑体">縮排、引言</font></h2><p>“&gt;” 大於符號後面所接的文字，就會向右縮排，如果越多 &gt; 的符號，就會縮排越多。</p>
<blockquote>
<p>至理名言</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt; 至理名言</span><br></pre></td></tr></table></figure>
<h2 id="特列顯示"><a href="#特列顯示" class="headerlink" title="特列顯示"></a>特列顯示</h2><p><del>刪除線</del></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">~~刪除線~~</span><br></pre></td></tr></table></figure>
<h2 id="Markdown-產生程式碼區塊"><a href="#Markdown-產生程式碼區塊" class="headerlink" title="Markdown 產生程式碼區塊"></a>Markdown 產生程式碼區塊</h2><p>在Markdown裡面產生程式碼區塊的方法很簡單，就是用三個``` 的符號<br>將程式碼的上下都用括起來</p>
<p>舉例：<br> ```<br>程式碼放這邊<br> ```</p>
<p>這樣會產生的畫面就是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">程式碼放這邊</span><br></pre></td></tr></table></figure>
<h2 id="Markdown-連結設定"><a href="#Markdown-連結設定" class="headerlink" title="Markdown 連結設定"></a>Markdown 連結設定</h2><p><img src="https://lh3.googleusercontent.com/ytDZt9pKlh84wDUYE04K49g-MGXYxfV1mET4-HpPtR9QpglNIT-v5Co_zzOC1FU0V0m2rnnhQ39afPeZlV47TOdZr4sLWAOAhzBEZ6AVJyyl8pM6OUNft2F5BxJuY2wtgCF1WAzcVd7WPIoT1FqgdDViYOKGYK9qn5nDdiRAc1bB3UIBPkBh_rDlbcrlROteZFRmegY81Gpx4uqR4cHYa0x9BVnA9M1vEYbxaH4IKvMAHdCQtKbls49RepPxbwqqXy4M_fOP6EMPCI-oX6A-fqXTE42auU5NyQheKKROPBZnbgcEm2Ffz-6-fxJiGzXm_DO9058v3cS9qAjzZmQCrCXDQKh3tWymRB9gHK4dgoruZJWws1Q6p9izxufh0SQ8KfL5TagK-xQK8s2ietie2kHwcWbwKOWpM4BQtNGqTMGbKT9nzVxkxk9kBiqEll7bcETz-O3zYeRMT6Adl6JDnfjshnIns6rj-dgwairU-ZYBHr7z7pdYL-rs92GrBtonZv1n1UUwKr1CG78Q3me-ZwBMXcJecTaeks0t2TL56BPYTh4SVphUZX_XGAApZp9DKdpeoN51tC8Sbh7yeGpSwWkl5rfbPBRH0lJntNs=w1032-h774-no" alt="image"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[Google](http://www.google.com/)</span><br><span class="line">![image](https://lh3.googleusercontent.com/ytDZt9pKlh84wDUYE04K49g-MGXYxfV1mET4-HpPtR9QpglNIT-v5Co_zzOC1FU0V0m2rnnhQ39afPeZlV47TOdZr4sLWAOAhzBEZ6AVJyyl8pM6OUNft2F5BxJuY2wtgCF1WAzcVd7WPIoT1FqgdDViYOKGYK9qn5nDdiRAc1bB3UIBPkBh_rDlbcrlROteZFRmegY81Gpx4uqR4cHYa0x9BVnA9M1vEYbxaH4IKvMAHdCQtKbls49RepPxbwqqXy4M_fOP6EMPCI-oX6A-fqXTE42auU5NyQheKKROPBZnbgcEm2Ffz-6-fxJiGzXm_DO9058v3cS9qAjzZmQCrCXDQKh3tWymRB9gHK4dgoruZJWws1Q6p9izxufh0SQ8KfL5TagK-xQK8s2ietie2kHwcWbwKOWpM4BQtNGqTMGbKT9nzVxkxk9kBiqEll7bcETz-O3zYeRMT6Adl6JDnfjshnIns6rj-dgwairU-ZYBHr7z7pdYL-rs92GrBtonZv1n1UUwKr1CG78Q3me-ZwBMXcJecTaeks0t2TL56BPYTh4SVphUZX_XGAApZp9DKdpeoN51tC8Sbh7yeGpSwWkl5rfbPBRH0lJntNs=w1032-h774-no) </span><br></pre></td></tr></table></figure>
<h2 id="Markdow-表格的設定"><a href="#Markdow-表格的設定" class="headerlink" title="Markdow 表格的設定"></a>Markdow 表格的設定</h2><p>如下的範例</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-|默認左對齊|居中對齊|內容右對齊</span><br><span class="line">:-:|-|:-:|-:</span><br><span class="line">1|Left|Center|Right</span><br><span class="line">2|Left|Center|Right</span><br><span class="line">3|Left|Center|Right</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="center">-</th>
<th>默認左對齊</th>
<th align="center">居中對齊</th>
<th align="right">內容右對齊</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td>Left</td>
<td align="center">Center</td>
<td align="right">Right</td>
</tr>
<tr>
<td align="center">2</td>
<td>Left</td>
<td align="center">Center</td>
<td align="right">Right</td>
</tr>
<tr>
<td align="center">3</td>
<td>Left</td>
<td align="center">Center</td>
<td align="right">Right</td>
</tr>
</tbody></table>
<h2 id="無序號"><a href="#無序號" class="headerlink" title="無序號"></a>無序號</h2><p>以<code>* 標題</code>來表示<br>如有有下一級<code>+ 1-1</code>來表示</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">* 註冊流程</span><br><span class="line">* db備份</span><br><span class="line">* 車主</span><br><span class="line">   + 1-1 車主主畫面的圖要換</span><br></pre></td></tr></table></figure>
<ul>
<li>註冊流程</li>
<li>db備份</li>
<li>車主<ul>
<li>1-1 車主主畫面的圖要換</li>
</ul>
</li>
</ul>
<h6 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h6><ul>
<li><a href="https://contemplator.github.io/blog/2017/07/14/Markdown-%E8%AA%9E%E6%B3%95/">Markdown 常用語法</a></li>
<li><a href="http://syxiaqj.github.io/2014/02/23/write-blog-with-markdown/">hexo命令及Markdown语法</a></li>
<li><a href="https://www.zybuluo.com/mdeditor">在线编辑器例文</a></li>
</ul>
]]></content>
      <categories>
        <category>記錄</category>
      </categories>
      <tags>
        <tag>Markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>PlantUML相關</title>
    <url>/PlantUML%E7%9B%B8%E9%97%9C/</url>
    <content><![CDATA[<h2 id="PlantUML和Hexo整合"><a href="#PlantUML和Hexo整合" class="headerlink" title="PlantUML和Hexo整合"></a>PlantUML和Hexo整合</h2><p>安装hexo-tag-plantuml</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-tag-plantuml --save</span><br></pre></td></tr></table></figure>
<h2 id="語法"><a href="#語法" class="headerlink" title="語法"></a>語法</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% plantuml %&#125;</span><br><span class="line">start</span><br><span class="line">:配置Java環境; </span><br><span class="line">:下載pantuml.jar;</span><br><span class="line">:編寫描述文件; </span><br><span class="line">:執行; </span><br><span class="line">stop</span><br><span class="line">&#123;% endplantuml %&#125;</span><br></pre></td></tr></table></figure>

<img src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXMtYXNjaWkiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIyOThweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjEzM3B4O2hlaWdodDoyOThweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMzMgMjk4IiB3aWR0aD0iMTMzcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48ZWxsaXBzZSBjeD0iNjYuNSIgY3k9IjIwIiBmaWxsPSIjMjIyMjIyIiByeD0iMTAiIHJ5PSIxMCIgc3R5bGU9InN0cm9rZTojMjIyMjIyO3N0cm9rZS13aWR0aDoxLjA7Ii8+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMy45Njg4IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjkzIiB4PSIyMCIgeT0iNTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3MyIgeD0iMzAiIHk9IjcxLjEzODciPiYjMzcxOTc7JiMzMjYyMjtKYXZhJiMyOTg3MjsmIzIyNjU5OzwvdGV4dD48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjMzLjk2ODgiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTExIiB4PSIxMSIgeT0iMTAzLjk2ODgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5MSIgeD0iMjEiIHk9IjEyNS4xMDc0Ij4mIzM3MTk3OyYjMzI2MjI7SmF2YSYjMjk4NzI7JiMyMjY1OTsuamFyPC90ZXh0PjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzMuOTY4OCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI5MiIgeD0iMjAuNSIgeT0iMTU3LjkzNzUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3MiIgeD0iMzAuNSIgeT0iMTc5LjA3NjIiPiYjMzIyMzI7JiMyMzUzMTsmIzI1NTUxOyYjMzY4NDg7JiMyNTk5MTsmIzIwMjE0OzwvdGV4dD48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjMzLjk2ODgiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDQiIHg9IjQ0LjUiIHk9IjIxMS45MDYzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjQiIHg9IjU0LjUiIHk9IjIzMy4wNDQ5Ij4mIzIyNTE5OyYjMzQ4OTI7PC90ZXh0PjxlbGxpcHNlIGN4PSI2Ni41IiBjeT0iMjc2Ljg3NSIgZmlsbD0ibm9uZSIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MS4wOyIvPjxlbGxpcHNlIGN4PSI2Ni41IiBjeT0iMjc2Ljg3NSIgZmlsbD0iIzIyMjIyMiIgcng9IjYiIHJ5PSI2IiBzdHlsZT0ic3Ryb2tlOiMyMjIyMjI7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI2Ni41IiB4Mj0iNjYuNSIgeTE9IjMwIiB5Mj0iNTAiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYyLjUsNDAsNjYuNSw1MCw3MC41LDQwLDY2LjUsNDQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjY2LjUiIHgyPSI2Ni41IiB5MT0iODMuOTY4OCIgeTI9IjEwMy45Njg4Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2Mi41LDkzLjk2ODgsNjYuNSwxMDMuOTY4OCw3MC41LDkzLjk2ODgsNjYuNSw5Ny45Njg4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI2Ni41IiB4Mj0iNjYuNSIgeTE9IjEzNy45Mzc1IiB5Mj0iMTU3LjkzNzUiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYyLjUsMTQ3LjkzNzUsNjYuNSwxNTcuOTM3NSw3MC41LDE0Ny45Mzc1LDY2LjUsMTUxLjkzNzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjY2LjUiIHgyPSI2Ni41IiB5MT0iMTkxLjkwNjMiIHkyPSIyMTEuOTA2MyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjIuNSwyMDEuOTA2Myw2Ni41LDIxMS45MDYzLDcwLjUsMjAxLjkwNjMsNjYuNSwyMDUuOTA2MyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNjYuNSIgeDI9IjY2LjUiIHkxPSIyNDUuODc1IiB5Mj0iMjY1Ljg3NSIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjIuNSwyNTUuODc1LDY2LjUsMjY1Ljg3NSw3MC41LDI1NS44NzUsNjYuNSwyNTkuODc1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48IS0tU1JDPVtBb3Y5QjJoWGlkaFBzbGp5eHBnbG5CQjR2dkNzRjV0S1JBczBBUVFOYkxYYXBNTnJWRmtBZi1qTkYtbGxWeDVfbXhEZnhLenNSbUNmVlpmXy11azVGSzFNU0tiLTBHMDBdLS0+PC9nPjwvc3ZnPg=='>

<h2 id="使用Astah繪製UML圖形"><a href="#使用Astah繪製UML圖形" class="headerlink" title="使用Astah繪製UML圖形"></a>使用Astah繪製UML圖形</h2><p>Astah這個提供免費版本的UML繪製工具</p>
<ul>
<li><p><a href="http://astah.net/">http://astah.net/</a></p>
<p> <a href="https://dotblogs.com.tw/clark/2015/02/12/149483">參考網址</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>學習</category>
        <category>UML</category>
      </categories>
      <tags>
        <tag>UML</tag>
        <tag>PlantUML</tag>
      </tags>
  </entry>
  <entry>
    <title>修理相關</title>
    <url>/%E4%BF%AE%E7%90%86%E7%9B%B8%E9%97%9C/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>  將有修理的東西記錄下來或是相關的資訊，以免以後要用到找不到。</p>
<span id="more"></span> 

<h2 id="apple-openvpn"><a href="#apple-openvpn" class="headerlink" title="apple openvpn"></a>apple openvpn</h2><h3 id="電腦上"><a href="#電腦上" class="headerlink" title="電腦上"></a>電腦上</h3><p>可以使用itunes,選擇手机圖示, 來將opven的檔案給apple的openvpn的app，記得要按下”同步”按鈕</p>
<h3 id="apple手機"><a href="#apple手機" class="headerlink" title="apple手機"></a>apple手機</h3><p>在打開openvpn的app,上選擇imported profile,有connect after import要勾選，在按下右上角的”ADD”</p>
<h2 id="五金"><a href="#五金" class="headerlink" title="五金"></a>五金</h2><p><a href="https://www.mobile01.com/topicdetail.php?f=635&t=3849586&p=2">https://www.mobile01.com/topicdetail.php?f=635&amp;t=3849586&amp;p=2</a></p>
<h2 id="馬桶"><a href="#馬桶" class="headerlink" title="馬桶"></a>馬桶</h2><p>toto sw767tw</p>
<h2 id="TOTO-恆溫沐浴龍頭-清潔保養"><a href="#TOTO-恆溫沐浴龍頭-清潔保養" class="headerlink" title="TOTO 恆溫沐浴龍頭 清潔保養"></a>TOTO 恆溫沐浴龍頭 清潔保養</h2><p><a href="https://www.mobile01.com/topicdetail.php?f=335&t=5242270">https://www.mobile01.com/topicdetail.php?f=335&amp;t=5242270</a></p>
<h1 id="sx4"><a href="#sx4" class="headerlink" title="sx4"></a>sx4</h1><p>SUZUKI SX4 stereo headunit removal 拆裝安卓主機<br><a href="https://www.youtube.com/watch?v=IHN8a7QvUjY">https://www.youtube.com/watch?v=IHN8a7QvUjY</a><br>【科P傳教室】EP33 SUZUKI SX4音響安裝，順便教你一些小知識<br><a href="https://www.youtube.com/watch?v=5gOp27gz-Us">https://www.youtube.com/watch?v=5gOp27gz-Us</a><br>SX4C後車廂內飾板拆卸<br><a href="https://www.youtube.com/watch?v=ynBUJIGfcKo">https://www.youtube.com/watch?v=ynBUJIGfcKo</a><br>SUZUKI SX4 CROSSOVER 副駕腳部出風管拆除<br><a href="https://www.youtube.com/watch?v=Wj-g8rqNHXA">https://www.youtube.com/watch?v=Wj-g8rqNHXA</a><br><a href="https://www.youtube.com/watch?v=3rmS0Vx0-oQ">https://www.youtube.com/watch?v=3rmS0Vx0-oQ</a><br>SUZUKI SX4 CROSSOVER 後冷氣出風口改裝 - 手套箱拆除、冷氣濾蕊更換<br><a href="https://www.youtube.com/watch?v=8Ftrivj5PnE">https://www.youtube.com/watch?v=8Ftrivj5PnE</a><br>Suzuki Vitara Baleno SX4 中央室內燈拆卸 改LED<br><a href="https://www.youtube.com/watch?v=AVMoEyBnPCI">https://www.youtube.com/watch?v=AVMoEyBnPCI</a><br>锐骑详尽安装倒车影像作业帖<br><a href="https://club.autohome.com.cn/bbs/thread/377948ed720efd4f/29995025-1.html">https://club.autohome.com.cn/bbs/thread/377948ed720efd4f/29995025-1.html</a><br>2011款SX4原装DVD自行加装倒车影像记实（不一样的接法）<br><a href="https://club.autohome.com.cn/bbs/thread/fe494d7733e344fe/17067824-1.html">https://club.autohome.com.cn/bbs/thread/fe494d7733e344fe/17067824-1.html</a><br>更换倒车摄像头（倒车影像）<br><a href="https://club.autohome.com.cn/bbs/thread/b92c595f1938d54c/88542549-1.html">https://club.autohome.com.cn/bbs/thread/b92c595f1938d54c/88542549-1.html</a><br>SX4椅套安裝<br><a href="https://www.youtube.com/watch?v=34U1t4AwCLQ">https://www.youtube.com/watch?v=34U1t4AwCLQ</a><br>sx4小改裝紀錄<br><a href="http://www.yinlih.com/2012/04/sx4.html">http://www.yinlih.com/2012/04/sx4.html</a></p>
<h1 id="FORD-TIERRA-修理相關"><a href="#FORD-TIERRA-修理相關" class="headerlink" title="FORD TIERRA 修理相關"></a>FORD TIERRA 修理相關</h1><h2 id="小福的保養與維修"><a href="#小福的保養與維修" class="headerlink" title="小福的保養與維修"></a>小福的保養與維修</h2><p><a href="https://sunkis.pixnet.net/blog/post/21886008">https://sunkis.pixnet.net/blog/post/21886008</a><br><a href="https://srg4125.pixnet.net/blog/category/1585815/2">https://srg4125.pixnet.net/blog/category/1585815/2</a></p>
<h2 id="FORD-TIERRA-後行李箱鎖簡易修"><a href="#FORD-TIERRA-後行李箱鎖簡易修" class="headerlink" title="FORD TIERRA 後行李箱鎖簡易修"></a>FORD TIERRA 後行李箱鎖簡易修</h2><p>家裡的車FORD TIERRA 後行李箱最近會自動跳開，網路找了一下說是六角鎖塑膠片老化，使間隙過大無法扣住，參考以下二篇大大做法，自己也來Diy簡易修一下，如同是FORD TIERRA 有後行李箱鎖問題，自己也可以試式簡易修看看哦!</p>
<p>PS.如後行李箱六角鎖簡易修後，行李箱還是會跳開，那代表真的要換新的後行李箱六角鎖了。</p>
<h2 id="蒸發器-鼓風機清潔"><a href="#蒸發器-鼓風機清潔" class="headerlink" title="蒸發器+鼓風機清潔"></a>蒸發器+鼓風機清潔</h2><p>弄了一下午的蒸發器+鼓風機清潔<br><a href="http://tapc.tw/content.php?id=82379&page=15">http://tapc.tw/content.php?id=82379&amp;page=15</a></p>
<h2 id="tierra-電瓶"><a href="#tierra-電瓶" class="headerlink" title="tierra 電瓶"></a>tierra 電瓶</h2><p><a href="https://blog.xuite.net/wruey/twblog/159051246-Tierra+%E6%8F%9B%E9%9B%BB%E7%93%B6">https://blog.xuite.net/wruey/twblog/159051246-Tierra+%E6%8F%9B%E9%9B%BB%E7%93%B6</a><br><a href="https://mama1978777.pixnet.net/blog/post/96940844">https://mama1978777.pixnet.net/blog/post/96940844</a><br>首先先確認一下你的愛車可不可以斷電 據我所知 三菱車系及foucs 都不可以斷電因為電腦會故障<br>電瓶的更換，以下以tierra為例，全程只需要一隻十號的鈑手即可搞定。<br>四個步驟，反之也是四個步驟裝回。不同廠牌的車子大同小異，可能只有在固定電瓶的方式有所不同而已。<br>我的車是Tierra  可以斷電 裝好後時鐘及電台再重設即可<br>換電瓶步驟如下:<br>1.拆負極 就是圖面上端無蓋端<br>2.拆正極 圖上有紅色塑膠蓋的那端<br>3.換電瓶<br>4.先鎖正極<br>5.再鎖上負極<br>6.相關固定板螺絲也要兩端平均鎖緊即可<br>7.最後檢查一下電瓶會不會晃動(記得用立可白寫上日期)</p>
<h1 id="手表"><a href="#手表" class="headerlink" title="手表"></a>手表</h1><p><a href="https://space.bilibili.com/384606208/video?tid=0&page=6&keyword=&order=pubdate">https://space.bilibili.com/384606208/video?tid=0&amp;page=6&amp;keyword=&amp;order=pubdate</a></p>
<h1 id="行車記錄相關"><a href="#行車記錄相關" class="headerlink" title="行車記錄相關"></a>行車記錄相關</h1><p>2017-07-06 12:09:32<br>請問,我的型車紀錄是後照鏡的,後鏡頭,是插五星線…我之前有在您這買-新視界180度品字三分割,那要如何改線.<br>答覆:<br>後鏡頭若用的是5芯寶馬線（非4芯），那這後鏡頭是用USB信號，而非AV信號，故無法切換 2017-07-06 13:01:17<br>新視界是AV信號， 2017-07-06 13:04:10</p>
<h2 id="汽車音響電源濾波"><a href="#汽車音響電源濾波" class="headerlink" title="汽車音響電源濾波"></a>汽車音響電源濾波</h2><p><a href="https://www.youtube.com/watch?v=_4iAktUbjIg">https://www.youtube.com/watch?v=_4iAktUbjIg</a></p>
<h2 id="改善行車記錄器之充電器干擾收音機及GPS經驗分享"><a href="#改善行車記錄器之充電器干擾收音機及GPS經驗分享" class="headerlink" title="改善行車記錄器之充電器干擾收音機及GPS經驗分享"></a>改善行車記錄器之充電器干擾收音機及GPS經驗分享</h2><p>19510省錢小秘招<br>許多朋友開車都喜歡打開收音機聽廣播，我也是此道中人，<br>不知何時開始，車上的收音機訊號就變得很不好，任何電台都會出現吵雜聲，<br>有一次我無意間將行車紀錄器的充電器自點煙座拿掉，廣播忽地變得很清晰，<br>之後再將行車紀錄器的充電器插入點煙座，奇怪的是，廣播又出現吵雜聲了，<br>因此我們可以推斷或許是行車紀錄器的充電器在此處作怪！<br>這兩天我在痞酷網瀏覽維修高手的文章，發現有網友對此情形貼出改善對策，<br>原來行車紀錄器的充電器為了減少熱源是採用交換式技術的DC-DC降壓電路，<br>而這類DC-DC的電路運作時，容易產生交換雜訊洩漏至輸入側匯流排，<br>因此必須加入濾波電路，隔絕此類雜訊進入汽車電路中干擾其他裝置，<br>汽車百貨行有賣汽車電源濾波器，查價得知一顆約在新臺幣80～90塊錢之間，<br>這種濾波器你要會接線路，不會接也是望『器』興歎(p.s.可以問我，我告訴你^^)<br>然而以下我們要用最低的成本加上動動手，直接在充電器裝個簡單的濾波器，<br>有興趣的朋友請按圖索驥，80%以上能夠擺脫充電器對收音機及GPS的干擾喔～。</p>
<p>1.行車紀錄器的充電器大多長這樣子，大家應該不陌生^^。</p>
<p>輸入：DC12~24V，輸出：DC5V，輸出最大電流：1500mA，中國大陸製造。<br><img src="https://i.imgur.com/duDeotn.png"><br><img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/duDeotn.png?raw=true" alt="image"></p>
<p><img src="https://i.imgur.com/JzWmyB4.png"><br><img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/JzWmyB4.png?raw=true" alt="image"></p>
<p>2.首先將充電器的頭部旋開(※類似旋開螺絲)，取出保險絲，再拔下金屬套圈。</p>
<p><img src="https://i.imgur.com/rLZYBDH.png"></p>
<p><img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/rLZYBDH.png?raw=true" alt="image"></p>
<p>3.然後沿著充電器外殼的接縫，慢慢的將兩邊外殼剝離、拆開。</p>
<p><img src="https://i.imgur.com/isu7AZz.png"></p>
<p><img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/isu7AZz.png?raw=true" alt="image"></p>
<p>4.取出充電器的電路板，上、下圖為電路板的正、反面。</p>
<p> <img src="https://i.imgur.com/RyhRDwv.png"><br> <img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/RyhRDwv.png?raw=true" alt="image"></p>
<p><img src="https://i.imgur.com/l3SRxGi.png"><br><img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/l3SRxGi.png?raw=true" alt="image"></p>
<p>5.上圖：在廢料中挖出一顆小電感備用，下圖：利用熱縮套將電感包覆起來。<br>   據網友實驗結果，1uH的電感效果最好，我手邊沒有器材可以測量電感值，<br>   反正這顆是小到可以塞進去殼子裡面就好(※一顆1uH的電感約新台幣5塊錢)。<br>   藉由電感隔交流、通直流的原理，將電感串聯在輸入電源的正極線路，<br>   達到隔離交換雜訊進入汽車電路中干擾其他裝置的目的。</p>
<p> <img src="https://i.imgur.com/EFqyWqB.png"><br> <img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/EFqyWqB.png?raw=true" alt="image"></p>
<p> <img src="https://i.imgur.com/RK5dGf8.png"><br> <img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/RK5dGf8.png?raw=true" alt="image"></p>
<p>6.為讓輸入的正極電路通過電感到後方交換式電路，必須將正極輸入電路截斷。<br>   ※可以利用刀片反覆的刮，將銅箔刮掉後，就截斷電路囉～</p>
<p><img src="https://i.imgur.com/Ln4duK0.png"><br><img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/Ln4duK0.png?raw=true" alt="image"></p>
<p><img src="https://i.imgur.com/IO1cXj1.png"><br><img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/IO1cXj1.png?raw=true" alt="image"></p>
<p>7.在截斷的正極輸入電路兩邊各引一個電感腳位的孔，並刮除保護漆露出銅箔。<br>   ※引孔若沒有小手鑽，可能很不好處理！請各位朋友想想其他方法囉～<br><img src="https://i.imgur.com/zC6eIeQ.png"><br><img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/zC6eIeQ.png?raw=true" alt="image"></p>
<p>8.將電感插入孔位焊上(沒有正負極之分)，上、下圖為電路板的正、反面。<br><img src="https://i.imgur.com/d6A8wgf.png"><br><img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/d6A8wgf.png?raw=true" alt="image"></p>
<p><img src="https://i.imgur.com/KvKv0zg.png"><br><img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/KvKv0zg.png?raw=true" alt="image"></p>
<p>9.充電器組裝後，先插入變壓器測試有無正常運作？通電正常！<br>   上車測試，充電器插入點煙頭接上行車記錄器充電，廣播無雜訊，開心完工^^。<br><img src="https://i.imgur.com/F9Juupm.png"><br><img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E8%A1%8C%E8%BB%8A%E8%A8%98%E9%8C%84%E5%99%A8/F9Juupm.png?raw=true" alt="image"></p>
<p>本次『改善行車記錄器之充電器干擾』費用總計：<br>電感1顆，廢料找到的，不用錢！<br>熱縮套1小小段，算1元吧！總計1元。<br>我的工錢無價。</p>
<p>[車事]歐小白裝鯊魚鰭天線<br><a href="https://blog.xuite.net/notes.kevin/notes/222848419-%5B%E8%BB%8A%E4%BA%8B%5D%E6%AD%90%E5%B0%8F%E7%99%BD%E8%A3%9D%E9%AF%8A%E9%AD%9A%E9%B0%AD%E5%A4%A9%E7%B7%9A">https://blog.xuite.net/notes.kevin/notes/222848419-%5B%E8%BB%8A%E4%BA%8B%5D%E6%AD%90%E5%B0%8F%E7%99%BD%E8%A3%9D%E9%AF%8A%E9%AD%9A%E9%B0%AD%E5%A4%A9%E7%B7%9A</a></p>
<h2 id="冷氣"><a href="#冷氣" class="headerlink" title="冷氣"></a>冷氣</h2><p><a href="https://www.mobile01.com/topicdetail.php?f=731&t=5434733&p=2">https://www.mobile01.com/topicdetail.php?f=731&amp;t=5434733&amp;p=2</a><br><a href="https://easyfu.pixnet.net/blog/post/114886037">https://easyfu.pixnet.net/blog/post/114886037</a><br><a href="https://bbs.pigoo.com/forum.php?mod=viewthread&tid=69283&extra=&highlight=%E5%86%B7%E6%B0%A3&page=2">https://bbs.pigoo.com/forum.php?mod=viewthread&amp;tid=69283&amp;extra=&amp;highlight=%E5%86%B7%E6%B0%A3&amp;page=2</a><br><a href="https://www.mobile01.com/topicdetail.php?f=168&t=5838543&p=2">https://www.mobile01.com/topicdetail.php?f=168&amp;t=5838543&amp;p=2</a><br>日立冷氣清洗DIY，拆洗鼓風扇教學<br><a href="https://mrtang.tw/blog/post/clean-air-conditioner-diy">https://mrtang.tw/blog/post/clean-air-conditioner-diy</a><br>小伙簡單教你挂機空調內機風輪怎麼拆下來<br><a href="https://www.youtube.com/watch?v=mSfwhOmhnsc">https://www.youtube.com/watch?v=mSfwhOmhnsc</a><br>空調內機異響，可能是風輪這裡故障，老師傅教你不花錢就能修好<br><a href="https://www.youtube.com/watch?v=iOK-Q00d3yM">https://www.youtube.com/watch?v=iOK-Q00d3yM</a><br>空調打開內機沒風，教你檢査，很有可能是這個問題<br><a href="https://www.youtube.com/watch?v=k8F5g-Pp4-A">https://www.youtube.com/watch?v=k8F5g-Pp4-A</a><br>RAS36HD 拆風鼓<br><a href="https://www.youtube.com/watch?v=OnwD7y_7DPw">https://www.youtube.com/watch?v=OnwD7y_7DPw</a><br>冷氣清洗貫流扇拆裝<br><a href="https://www.youtube.com/watch?v=z3nLFYuqUzM">https://www.youtube.com/watch?v=z3nLFYuqUzM</a><br>自己動手清洗分體式冷氣 分離式冷氣 不使用高壓噴槍 拆機洗淨全過程<br><a href="https://www.youtube.com/watch?v=IuxEe0PIn9Y">https://www.youtube.com/watch?v=IuxEe0PIn9Y</a><br>洗冷氣3招不求人！ 初級到進階詳細步驟大公開！ 清洗工具DIY超省錢！ [歐塊] [OMG CRAFTS]<br><a href="https://www.youtube.com/watch?v=zSTmNAScxs8">https://www.youtube.com/watch?v=zSTmNAScxs8</a></p>
<p><a href="https://bbs.pigoo.com/thread-38055-1-1.html">https://bbs.pigoo.com/thread-38055-1-1.html</a><br>風鼓清理是可以很輕鬆且不需拆下來<br>用任何品牌的廚房清潔劑噴一噴<br>再用任何形式的加壓瓶或噴灌裝清水噴一噴<br>以上盡量避免噴到馬達軸心<br>再用廢棄牙刷刷下毛絮就很乾淨</p>
<p>冷氣萬用機版DIY介紹<br><a href="https://blog.xuite.net/bj3535/twblog/121040207-%E5%86%B7%E6%B0%A3%E8%90%AC%E7%94%A8%E6%A9%9F%E7%89%88DIY%E4%BB%8B%E7%B4%B9">https://blog.xuite.net/bj3535/twblog/121040207-%E5%86%B7%E6%B0%A3%E8%90%AC%E7%94%A8%E6%A9%9F%E7%89%88DIY%E4%BB%8B%E7%B4%B9</a></p>
<p>[冷氣機] 給gkjnn 大&amp;分離式冷氣室內機補焊完修暨改公板簡易配線參考<br><a href="https://bbs.pigoo.com/forum.php?mod=viewthread&tid=32751&highlight=%E5%85%AC%E6%9D%BF">https://bbs.pigoo.com/forum.php?mod=viewthread&amp;tid=32751&amp;highlight=%E5%85%AC%E6%9D%BF</a></p>
<h1 id="烘碗機相關"><a href="#烘碗機相關" class="headerlink" title="烘碗機相關"></a>烘碗機相關</h1><p>這次事件讓人覺得林內的服務實在很鳥。<br>家裡的烘碗機是林內的RKD-180，製造年份是2007年。</p>
<p>這一陣子發現烘碗「15分鐘」及「點燈」的按鈕壞了。</p>
<p>按了都沒啥反應，所以就打電話叫修。結果服務人員來了以後，看了看就說要修理這個電子面板，報價….<br>$1,500！<br>有沒有搞錯？新機的官方售價也才$7,215耶<br>這是搶劫嗎？</p>
<p>他又補充一句，不修也可以，只是開關接觸不良，按下去以後開關扭一扭就好了，運氣好，開關touch到了還是可以用，所以我們就不修了，過了幾天「開關扭一扭」的日子。但這並不是正常的使用方式，一直扭來扭去，開關早晚也是會被扭壞，扭個幾天又開始接觸不良了，求人不如求己，我自己來吧！先撕開外面的按鍵貼片</p>
<p>拿螺絲起子拆一拆，面板拿下來一看。</p>
<p>不就是一堆4P的tact switch嗎？</p>
<p>修這個switch報價1,500，不怕被雷劈喔？</p>
<h2 id="所以我就去電子材料行買了："><a href="#所以我就去電子材料行買了：" class="headerlink" title="所以我就去電子材料行買了："></a>所以我就去電子材料行買了：</h2><h2 id="一台電表-200-一隻烙鐵-100-錫線-20-一包tact-switch-5顆共-10"><a href="#一台電表-200-一隻烙鐵-100-錫線-20-一包tact-switch-5顆共-10" class="headerlink" title="一台電表 ($200)一隻烙鐵 ($100)錫線 ($20)一包tact switch (5顆共$10)"></a>一台電表 ($200)<br>一隻烙鐵 ($100)<br>錫線 ($20)<br>一包tact switch (5顆共$10)</h2><p>總共花$330</p>
<p>先拿電表量一下，確定哪幾顆開關不過電，幸好以前買的吸錫器沒弄丟，先拿烙鐵融掉開關上的錫，再把它吸掉，再拿斜口鉗把壞掉的開關拆掉，焊上新的開關。</p>
<p>焊好後，再把面板裝回去測試一下，亮燈！又可以正常使用了！</p>
<p>15分鐘的烘碗行程也正常了！</p>
<p>我10年沒拿烙鐵了，一拿起來就現賺$1,200左右，怪不得聽人家說：「現在沒有會修理的師傅，只有會換零件的師傅。」直接叫客戶花大錢把整個面板換掉，台灣林內真的該好好檢討一下，不知道該公司的技術人員是否連操作烙鐵和電表都有困難？或者是滿腦子只想賺錢，不想認真服務？</p>
<p>後記：<br>這一定要順便拿出來講，讓各位看官好好恥笑一下，三用電表是在長明街的禾樺電子買的，結完帳，店員就在電表背後的螺絲孔上貼保固貼紙，看起來是很正常的標準作業程序。</p>
<p>但是！！我回家才發現這款電表一定要鬆開螺絲，拆開背蓋才能裝電池啊～～～但我這一拆就破壞保固貼紙了<br>要裝電池正常使用，就沒有保固；想要保固，就不能裝電池使用。<br>什麼跟什麼啊！？！？原來這就是傳說中的「欲練神功，必先自宮」 </p>
<p>2019年10月20日更新</p>
<p>話說過了6年，當初6顆開關換了2顆，現在換另外4顆壞掉了，所以我又到了禾樺電子花$10買了5顆6<em>6</em>8mm的4P switch。<br><img src="https://i.imgur.com/nz5h09c.png"></p>
<p><img src="https://github.com/ttom921/WindowsSpotlight/blob/master/%E4%BF%AE%E7%90%86/%E7%83%98%E7%A2%97%E6%A9%9F/nz5h09c.png?raw=true" alt="image"></p>
<p>把舊開關拆下來要花一點時間，焊上新開關倒是很容易。</p>
<p>完修，重新上機再戰N年！</p>
<h2 id="DIY-冷氣維修-奮鬥記"><a href="#DIY-冷氣維修-奮鬥記" class="headerlink" title="DIY 冷氣維修 奮鬥記"></a>DIY 冷氣維修 奮鬥記</h2><h2 id="http-twincati-blogspot-com-2017-08-diy-12-html東西是要壞不壞的時候最難搞上個月冷氣無預警不冷了運轉燈有亮-溫度到31度跑去看室外機安安靜靜散熱風扇沒動依照從小養成的習慣打一下-動了-又冷了但好景不常從偶爾一次-白天不會-晚上就開始鬧脾氣了當看到運轉燈亮-溫度不對就拿根棍子揍他一下越來越頻繁後來連剛開機都不行了這樣打下去也不是辦法-第一個懷疑是-風扇卡住所以拆正面蓋子將風扇轉動一下感覺好像也沒卡-拆修冷氣一定要確認220V電源是關閉的…電到不是開玩笑的-但可能是卡的剛剛好-所以拍一下就動所以清一清-噴噴潤滑劑-還好是在一樓"><a href="#http-twincati-blogspot-com-2017-08-diy-12-html東西是要壞不壞的時候最難搞上個月冷氣無預警不冷了運轉燈有亮-溫度到31度跑去看室外機安安靜靜散熱風扇沒動依照從小養成的習慣打一下-動了-又冷了但好景不常從偶爾一次-白天不會-晚上就開始鬧脾氣了當看到運轉燈亮-溫度不對就拿根棍子揍他一下越來越頻繁後來連剛開機都不行了這樣打下去也不是辦法-第一個懷疑是-風扇卡住所以拆正面蓋子將風扇轉動一下感覺好像也沒卡-拆修冷氣一定要確認220V電源是關閉的…電到不是開玩笑的-但可能是卡的剛剛好-所以拍一下就動所以清一清-噴噴潤滑劑-還好是在一樓" class="headerlink" title="http://twincati.blogspot.com/2017/08/diy_12.html東西是要壞不壞的時候最難搞上個月冷氣無預警不冷了運轉燈有亮,溫度到31度跑去看室外機安安靜靜散熱風扇沒動依照從小養成的習慣打一下~~~動了^_^又冷了但好景不常從偶爾一次 白天不會 晚上就開始鬧脾氣了當看到運轉燈亮 溫度不對就拿根棍子揍他一下越來越頻繁後來連剛開機都不行了這樣打下去也不是辦法***********************************第一個懷疑是 風扇卡住所以拆正面蓋子將風扇轉動一下感覺好像也沒卡(拆修冷氣一定要確認220V電源是關閉的…電到不是開玩笑的)但可能是卡的剛剛好..所以拍一下就動所以清一清,噴噴潤滑劑..(還好是在一樓)"></a><a href="http://twincati.blogspot.com/2017/08/diy_12.html">http://twincati.blogspot.com/2017/08/diy_12.html</a><br>東西是要壞不壞的時候最難搞<br>上個月冷氣無預警不冷了<br>運轉燈有亮,溫度到31度<br>跑去看室外機<del>安安靜靜散熱風扇沒動<br>依照從小養成的習慣</del>打一下~~~動了^_^<del>又冷了<br>但好景不常<br>從偶爾一次 白天不會 晚上就開始鬧脾氣了<br>當看到運轉燈亮 溫度不對<br>就拿根棍子揍他一下<br>越來越頻繁</del>後來連剛開機都不行了<br>這樣打下去也不是辦法<br>***********************************<br>第一個懷疑是 風扇卡住<br>所以拆正面蓋子將風扇轉動一下感覺好像也沒卡<br>(拆修冷氣一定要確認220V電源是關閉的…電到不是開玩笑的)<br>但可能是卡的剛剛好..所以拍一下就動<br>所以清一清,噴噴潤滑劑..<br>(還好是在一樓)</h2><p>情況依舊…..更嚴重不打不動<br>本想趁不動時拆開聽看看是 風扇還是壓縮機動不起來<br>但就在拆時稍微碰到鐵架 它就動了 XD<br>第2個懷疑是 風扇啟動電容(CBB61)<br>買一個來先換換看,室外機旁邊有個小蓋子</p>
<p>拆下後看 構造簡單<br>就一個 金屬圓桶電容(壓縮機用)<br>方形黑色電容(CBB61)(散熱風扇用)<br>電路板–上頭就一顆Relay,一顆 X2安規電容,幾顆電阻跟一般電容<br>CBB61 有用到三個接點,拿個尖嘴鉗 一個一個抽拔換就好<br>情況依舊 XD</p>
<hr>
<p>只好拚一下 活電作業<br>等不動時,拿根長塑膠管,輕輕敲一敲…<br>敲到電路板時~~~~動了<br>問題範圍縮小了<br>電路板問題,爬在那看老半天看不到哪鬆脫,背板也沒啥異樣</p>
<p>所以懷疑是 Relay 老化,吸不起來…應該就是了<br>原本型號是 DEG PCF-112D2M 買不到..用代用品 DEC牌的<br>就拿了烙鐵就在那換起來…<br>後來搞好後,仔細看一下,電路板上有 黑白灰 3條線 它是連到下方端子台<br>可抽拔,是可以拿下來,到桌上慢慢用的……</p>
<h2 id="我是在一樓所以用個小梯子拉個延長線-就現場施工了換好-Relay-繼電器-開機……-情況依舊-XD-XD-XD"><a href="#我是在一樓所以用個小梯子拉個延長線-就現場施工了換好-Relay-繼電器-開機……-情況依舊-XD-XD-XD" class="headerlink" title="我是在一樓所以用個小梯子拉個延長線 就現場施工了換好 Relay(繼電器) 開機…….情況依舊  XD XD XD"></a>我是在一樓所以用個小梯子拉個延長線 就現場施工了<br>換好 Relay(繼電器) 開機…….<br>情況依舊  XD XD XD</h2><p>再確認一下 板子是否有冷焊或鬆脫的地方….補焊一下…<br>還是一樣………………………..<br>到底是哪?<br>爬上去<br>這次拿根小塑膠棒..小心翼翼的 地毯式敲電路板<br>終於被我敲到是 藍色 X2 105K 安規電容 在做怪<br>可是電容會是這種壞法嗎? 不是要嘛打穿要嘛不打穿?<br>怎麼跟機械式的元件一樣敲一敲會好?<br>接腳再補焊一下…….沒用還是敲一敲就好了….<br>只好找顆來換….<br>型號是 X2 CKX 105 K 300V<br>CKX 是牌子 錞谷電子<br>X2 應該是指  安規電容<br>105 (10 後面5個0)  1000000 pF 是  1uf<br>露天 掏寶只看到  275V 黃色的 (網購一個太浪費也要等)<br>只好出門買 光華太遠了 從拆了後就沒再去過<br>跑板橋 “南北” 沒賣 連相容的也沒<br>附近還有家”總用” 小巷子內 都快成百年老店了<br>竟然有~還一模一樣  </p>
<p>回來不囉嗦就換了 就2根腳….<br>換好後開機<br>OK動了<br>萬萬想不到~~~竟然是這顆電容的問題</p>
<p>最後換下來的零件總集合(只有綠色 X2電容是壞的)<br>分享</p>
<h2 id="螢幕"><a href="#螢幕" class="headerlink" title="螢幕"></a>螢幕</h2><p><a href="https://shu-fan.blogspot.com/2019/01/acer-p235h-led.html">https://shu-fan.blogspot.com/2019/01/acer-p235h-led.html</a></p>
<p>玻璃重量:<br>長m x 寬m x 厚度mm x 2.5 &#x3D;重量KG</p>
]]></content>
      <categories>
        <category>修理</category>
      </categories>
      <tags>
        <tag>修理</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄C#語法的使用</title>
    <url>/%E8%A8%98%E9%8C%84C-%E8%AA%9E%E6%B3%95%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="記錄一下C-的用法"><a href="#記錄一下C-的用法" class="headerlink" title="記錄一下C#的用法"></a>記錄一下C#的用法</h1><h2 id="C-6-的三個新的表示式"><a href="#C-6-的三個新的表示式" class="headerlink" title="C# 6 的三個新的表示式"></a>C# 6 的三個新的表示式</h2><p>介紹 C# 6 的三個新語法：nameof 表示式、字串插值、和 null 條件運算子。</p>
<ol>
<li>nameof 表示式<br>  C# 6 新增的 nameof 關鍵字可用來取得某變數的名稱。請看底下這個簡單範例，便能了解其作用：</li>
</ol>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">string firstName = &quot;Joey&quot;;</span><br><span class="line">string varName = nameof(firstName);  // 編譯結果：varName = &quot;firstName&quot;</span><br></pre></td></tr></table></figure>
<p>  比如說，為了防錯，我們經常在函式中預先檢查參數值是否合法，並將不合法的參數透過拋異常（exception）的方式通知呼叫端（或者寫入 log 檔案以供將來診斷問題）。像這樣：</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void LoadProduct(string productId)</span><br><span class="line">  &#123;</span><br><span class="line">      if (productId == null)</span><br><span class="line">      &#123;</span><br><span class="line">          throw new ArgumentNullException(nameof(productId));</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>字串插值<br>  NET Framework 提供的字串格式化方法 String.Format(…) 是一種對號入座的寫法，相當好用。<br>  現在，C# 6 提供了另一種格式化字串的寫法，名曰「字串插值」（string interpolation）。<br>  $”{變數名稱:格式規範}”</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">string firstName = &quot;Michael&quot;;</span><br><span class="line">string lastName = &quot;Tsai&quot;;</span><br><span class="line">int salary = 22000;</span><br><span class="line"></span><br><span class="line">string msg1 = String.Format(&quot;&#123;0&#125; &#123;1&#125; 的月薪是 &#123;2:C0&#125;&quot;, firstName, lastName, salary);</span><br><span class="line">string msg2 = $&quot;&#123;firstName&#125; &#123;lastName&#125; 的月薪是 &#123;salary :C0&#125;&quot;;</span><br><span class="line">Console.WriteLine(msg1);</span><br><span class="line">Console.WriteLine(msg2);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Null 條件運算子<br>  保險起見，在需要存取某物件的屬性之前，我們通常會先檢查該物件是否為 null</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">static void NullPropagationDemo(string s)</span><br><span class="line">&#123;</span><br><span class="line">  if (s?.Length == 4) // 只有當 s 不為空時才存取它的 Length 屬性。</span><br><span class="line">  &#123;</span><br><span class="line">      // Do something.</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int? length = productList?.Length; // 若 productList 是 null，則 length 也是 null。 </span><br><span class="line">Customer obj = productList?[0];    // 若 productList 是 null，則 obj 也是 null。</span><br><span class="line">int length = productList?.Length ?? 0;  // 若 productList 是 null，則 length 是 0。</span><br><span class="line">string name = productList?[0].FullName; // 若 productList 是 null，則 name 是 null。</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="有關json的用法"><a href="#有關json的用法" class="headerlink" title="有關json的用法"></a>有關json的用法</h2><p>字串轉json物件，json物件轉字串</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static void strJson()</span><br><span class="line">&#123;</span><br><span class="line">	string jsonText = &quot;&#123;\&quot;shenzheng\&quot;:\&quot;深圳\&quot;,\&quot;beijing\&quot;:\&quot;北京\&quot;,\&quot;shanghai\&quot;:[&#123;\&quot;zj1\&quot;:\&quot;zj11\&quot;,\&quot;zj2\&quot;:\&quot;zj22\&quot;&#125;,\&quot;zjs\&quot;]&#125;&quot;;</span><br><span class="line">	//转为json对象</span><br><span class="line">	JObject jo = (JObject)JsonConvert.DeserializeObject(jsonText);</span><br><span class="line">	string zone = jo[&quot;shenzheng&quot;].ToString();//输出 深圳</span><br><span class="line">	string zone_en = jo[&quot;shanghai&quot;].ToString();//&quot;[\r\n  &#123;\r\n    \&quot;zj1\&quot;: \&quot;zj11\&quot;,\r\n    \&quot;zj2\&quot;: \&quot;zj22\&quot;\r\n  &#125;,\r\n  \&quot;zjs\&quot;\r\n]&quot;</span><br><span class="line">	string zj1 = jo[&quot;shanghai&quot;][1].ToString();//&quot;zjs&quot;</span><br><span class="line">	Console.WriteLine(jo);</span><br><span class="line">&#125;</span><br><span class="line">//对象与数组转JSON</span><br><span class="line">public static void GetJsonString()</span><br><span class="line">&#123;</span><br><span class="line">    //初始化对象</span><br><span class="line">    Obj product = new Obj() &#123; Name = &quot;苹果&quot;, Price = 5.5 &#125;;</span><br><span class="line">    //序列化</span><br><span class="line">    string o = new JavaScriptSerializer().Serialize(product);//值：&quot;&#123;\&quot;Name\&quot;:\&quot;苹果\&quot;,\&quot;Price\&quot;:5.5&#125;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //数组转json</span><br><span class="line">    List&lt;Obj&gt; products = new List&lt;Obj&gt;()&#123;</span><br><span class="line">    new Obj()&#123;Name=&quot;苹果&quot;,Price=5.5&#125;,</span><br><span class="line">    new Obj()&#123;Name=&quot;橘子&quot;,Price=2.5&#125;,</span><br><span class="line">    new Obj()&#123;Name=&quot;干柿子&quot;,Price=16.00&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ProductList productlist = new ProductList();</span><br><span class="line">    productlist.GetProducts = products;</span><br><span class="line">    //序列化</span><br><span class="line">    string os = new JavaScriptSerializer().Serialize(productlist);</span><br><span class="line">    //输出 &quot;&#123;\&quot;GetProducts\&quot;:[&#123;\&quot;Name\&quot;:\&quot;苹果\&quot;,\&quot;Price\&quot;:5.5&#125;,&#123;\&quot;Name\&quot;:\&quot;橘子\&quot;,\&quot;Price\&quot;:2.5&#125;,&#123;\&quot;Name\&quot;:\&quot;干柿子\&quot;,\&quot;Price\&quot;:16&#125;]&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//json转对象、数组, 反序列化</span><br><span class="line">public static void JSONStringToList()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    //json格式字符串</span><br><span class="line">    string JsonStr = &quot;&#123;Name:&#x27;苹果&#x27;,Price:5.5&#125;&quot;;</span><br><span class="line">    JavaScriptSerializer Serializer = new JavaScriptSerializer();</span><br><span class="line"></span><br><span class="line">    //json字符串转为对象, 反序列化</span><br><span class="line">    Obj obj = Serializer.Deserialize&lt;Obj&gt;(JsonStr);</span><br><span class="line">        Console.Write(obj.Name + &quot;:&quot; + obj.Price + &quot;\r\n&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //json格式字符串</span><br><span class="line">    string JsonStrs = &quot;[&#123;Name:&#x27;苹果&#x27;,Price:5.5&#125;,&#123;Name:&#x27;橘子&#x27;,Price:2.5&#125;,&#123;Name:&#x27;柿子&#x27;,Price:16&#125;]&quot;;</span><br><span class="line"></span><br><span class="line">    JavaScriptSerializer Serializers = new JavaScriptSerializer();</span><br><span class="line"></span><br><span class="line">    //json字符串转为数组对象, 反序列化</span><br><span class="line">    List&lt;Obj&gt; objs = Serializers.Deserialize&lt;List&lt;Obj&gt;&gt;(JsonStrs);</span><br><span class="line"></span><br><span class="line">    foreach (var item in objs)</span><br><span class="line">    &#123;</span><br><span class="line">       Console.Write(item.Name + &quot;:&quot; + item.Price + &quot;\r\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<h2 id="分組的用法"><a href="#分組的用法" class="headerlink" title="分組的用法"></a>分組的用法</h2><p>過去面對這種問題，我慣用的做法先定義一個Dictionary&lt;string, List<T>&gt;，使用 foreach 逐筆抓取來源資料<br>foreach + Dictionary寫法用了好幾年，前幾天才忽然想到，這不就是SQL語法中的GROUP BY嗎？加上LINQ有ToDictionary， GroupBy(o &#x3D;&gt; o.客戶編號).ToDictionary(o &#x3D;&gt; o.Key, o &#x3D;&gt; o.ToList()) 一行就搞定了呀！阿呆。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Text;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line"> </span><br><span class="line">namespace LinqTip</span><br><span class="line">&#123;</span><br><span class="line">    class Program</span><br><span class="line">    &#123;</span><br><span class="line">        public enum Teams</span><br><span class="line">        &#123;</span><br><span class="line">            Valor, Mystic, Instinct, Dark</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        public class Trainer</span><br><span class="line">        &#123;</span><br><span class="line">            public Teams Team;</span><br><span class="line">            public string Name;</span><br><span class="line">            public Trainer(Teams team, string name)</span><br><span class="line">            &#123;</span><br><span class="line">                Team = team; Name = name;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        static void Main(string[] args)</span><br><span class="line">        &#123;</span><br><span class="line">            //來源資料如下</span><br><span class="line">            List&lt;Trainer&gt; trainers = new List&lt;Trainer&gt;()</span><br><span class="line">            &#123;</span><br><span class="line">                new Trainer(Teams.Valor, &quot;Candela&quot;),</span><br><span class="line">                new Trainer(Teams.Valor, &quot;Bob&quot;),</span><br><span class="line">                new Trainer(Teams.Mystic, &quot;Blanche&quot;),</span><br><span class="line">                new Trainer(Teams.Valor, &quot;Alice&quot;),</span><br><span class="line">                new Trainer(Teams.Instinct, &quot;Spark&quot;),</span><br><span class="line">                new Trainer(Teams.Mystic, &quot;Tom&quot;),</span><br><span class="line">                new Trainer(Teams.Dark, &quot;Jeffrey&quot;)</span><br><span class="line">            &#125;;</span><br><span class="line">            //目標：以Team分類，將同隊的訓練師集合成List&lt;Trainer&gt;，</span><br><span class="line">            //最終產出Dictionary&lt;Teams, List&lt;Trainer&gt;&gt;</span><br><span class="line"> </span><br><span class="line">            //以前的寫法，跑迴圈加邏輯比對</span><br><span class="line">            var res1 = new Dictionary&lt;Teams, List&lt;Trainer&gt;&gt;();</span><br><span class="line">            foreach (var t in trainers)</span><br><span class="line">            &#123;</span><br><span class="line">                if (!res1.ContainsKey(t.Team))</span><br><span class="line">                    res1.Add(t.Team, new List&lt;Trainer&gt;());</span><br><span class="line">                res1[t.Team].Add(t);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            //新寫法，使用LINQ GroupBy</span><br><span class="line">            var res2 =</span><br><span class="line">                trainers.GroupBy(o =&gt; o.Team)</span><br><span class="line">                .ToDictionary(o =&gt; o.Key, o =&gt; o.ToList());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h5><ul>
<li><a href="https://www.huanlintalk.com/2015/01/csharp6-enhanced-expressions.html">C# 6 的三個新的表示式</a></li>
<li><a href="https://blog.csdn.net/yh12346789/article/details/78768334">c#中字符串转为json对象与json转对象</a></li>
<li><a href="https://blog.darkthread.net/blog/linq-groupby-todictionary-grouping/">利用LINQ GroupBy快速分組歸類</a></li>
</ul>
]]></content>
      <categories>
        <category>程式</category>
        <category>C#</category>
      </categories>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄vim和vi相關</title>
    <url>/%E8%A8%98%E9%8C%84vim%E5%92%8Cvi%E7%9B%B8%E9%97%9C/</url>
    <content><![CDATA[<h1 id="vim和vi相關"><a href="#vim和vi相關" class="headerlink" title="vim和vi相關"></a>vim和vi相關</h1><p>有關vim和vi的相關資訊<br><a href="https://vim.rtorr.com/">https://vim.rtorr.com/</a><br><a href="https://github.com/kaochenlong/cch/blob/master/README.md">https://github.com/kaochenlong/cch/blob/master/README.md</a></p>
<h2 id="快捷鍵"><a href="#快捷鍵" class="headerlink" title="快捷鍵"></a>快捷鍵</h2><ul>
<li>拷貝當前行yy，貼上p, 5yy拷貝5行</li>
<li>刪除當前行dd, 5dd刪除5行</li>
<li>查找關鍵詞<code>命令行下/關鍵詞 n是查找下一個位置</code></li>
<li>設置文件的行號和取消文件的行號<code>命令行下 :set nu set nonu</code></li>
<li>編輯文件到達首行gg , 到達最未行G在正常模式</li>
<li>輸入時撒消動作u,在正常模式</li>
<li>將光標移到指定的行數 13G</li>
</ul>
<p>(1) 花式插入模式<br> i -&gt; 在光標前插入<br> I -&gt; 在句子前插入<br> a -&gt; 在光標後插入<br> A -&gt; 在句子後插入<br> o -&gt; 在當前行下插入一行<br> O -&gt; 在當前行上插入一行<br>(2) 花式移動光標<br> 0 -&gt; 數字零，到行頭<br> $ -&gt; 到本行行尾<br>(3) visual<br>ctrl+v  d刪除 shift+i 加入 esc兩次<br>shift+v</p>
<h2 id="一般vim設定檔"><a href="#一般vim設定檔" class="headerlink" title="一般vim設定檔"></a>一般vim設定檔</h2><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot; sudo vim .vimrc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> cursorline</span><br><span class="line"><span class="keyword">set</span> tabstop=<span class="number">4</span></span><br><span class="line"><span class="keyword">set</span> <span class="built_in">shiftwidth</span>=<span class="number">4</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Vim的設定檔"><a href="#Vim的設定檔" class="headerlink" title="Vim的設定檔"></a>Vim的設定檔</h2><p>命令</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">＃ 重新載入目前<span class="keyword">vim</span>的設定檔</span><br><span class="line">:<span class="keyword">source</span> </span><br></pre></td></tr></table></figure>

<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot;設定行號</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">number</span></span><br><span class="line"><span class="comment">&quot;設定剪貼版共用</span></span><br><span class="line"><span class="keyword">set</span> clipboard=unnamed</span><br><span class="line"><span class="comment">&quot;設定讓搜尋結果更明顯</span></span><br><span class="line"><span class="keyword">set</span> hlsearch</span><br><span class="line"><span class="comment">&quot;設定游標所在處有底線效果</span></span><br><span class="line"><span class="keyword">set</span> cursouline</span><br><span class="line"><span class="comment">&quot;不要產生Swap檔</span></span><br><span class="line"><span class="keyword">set</span> noswapfile</span><br></pre></td></tr></table></figure>
<h3 id="tab還是space"><a href="#tab還是space" class="headerlink" title="tab還是space?"></a>tab還是space?</h3><ul>
<li>set softtabstop&#x3D;2<br>使用2個space取代tab</li>
<li>set shiftwidth&#x3D;2<br>在&gt;的時候使用2個空格做為縮排</li>
<li>set expandtab<br>使用space取代tab<br>命令<br>:retab 動新設定文件裡的tab</li>
</ul>
<h3 id="關於搜尋"><a href="#關於搜尋" class="headerlink" title="關於搜尋"></a>關於搜尋</h3><ul>
<li>set ignorecase<br>設定搜尋時不分大小寫</li>
<li>set incsearch<br>只要部份關鍵字就有搜尋效果</li>
</ul>
<h3 id="關於編輯器的樣子"><a href="#關於編輯器的樣子" class="headerlink" title="關於編輯器的樣子"></a>關於編輯器的樣子</h3><ul>
<li>set showtabline&#x3D;2<br>只要有任何分頁都錢秀出來</li>
<li>set splitbelow<br>新增水平視窗的時候會出現在下方</li>
<li>set splitright<br>新增垂直視窗的時候會出現在右方</li>
</ul>
<h3 id="工程師的編輯器"><a href="#工程師的編輯器" class="headerlink" title="工程師的編輯器"></a>工程師的編輯器</h3><ul>
<li>syntax on<br>打開程式碼語法高亮(幫程式碼上色)</li>
<li>filetype on<br>偵測檔案型態</li>
<li>filetype indent on<br>根據程式種類進行縮排</li>
<li>filetype plugin on<br>根㯫程式語言種類載入外掛</li>
</ul>
<h3 id="以下是參考的設定"><a href="#以下是參考的設定" class="headerlink" title="以下是參考的設定"></a>以下是參考的設定</h3><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&quot;設定內容：</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">number</span></span><br><span class="line"><span class="keyword">set</span> clipboard=unnamed</span><br><span class="line"><span class="keyword">set</span> cursorline</span><br><span class="line"><span class="keyword">set</span> noswapfile</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; search</span></span><br><span class="line"><span class="keyword">set</span> hlsearch</span><br><span class="line"><span class="keyword">set</span> ignorecase</span><br><span class="line"><span class="keyword">set</span> incsearch</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; tab and space</span></span><br><span class="line"><span class="keyword">set</span> softtabstop=<span class="number">2</span></span><br><span class="line"><span class="keyword">set</span> <span class="built_in">shiftwidth</span>=<span class="number">2</span></span><br><span class="line"><span class="keyword">set</span> expandtab</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; tab</span></span><br><span class="line"><span class="keyword">set</span> showtabline=<span class="number">2</span></span><br><span class="line"><span class="keyword">set</span> splitbelow</span><br><span class="line"><span class="keyword">set</span> splitright</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; color</span></span><br><span class="line"><span class="keyword">syntax</span> <span class="keyword">on</span></span><br><span class="line"><span class="keyword">colorscheme</span> darkblue</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; filetype</span></span><br><span class="line"><span class="keyword">filetype</span> <span class="keyword">on</span></span><br><span class="line"><span class="keyword">filetype</span> <span class="built_in">indent</span> <span class="keyword">on</span></span><br><span class="line"><span class="keyword">filetype</span> plugin <span class="keyword">on</span></span><br></pre></td></tr></table></figure>

<h2 id="Vim的設定之KeyMapping-part1"><a href="#Vim的設定之KeyMapping-part1" class="headerlink" title="Vim的設定之KeyMapping_part1"></a>Vim的設定之KeyMapping_part1</h2><table>
<thead>
<tr>
<th align="center">命令</th>
<th align="center">Normal Mode</th>
<th align="center">Visual Mode</th>
<th align="center">Insert mode</th>
</tr>
</thead>
<tbody><tr>
<td align="center">map</td>
<td align="center">V</td>
<td align="center">V</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">nmap</td>
<td align="center">V</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">vmap</td>
<td align="center"></td>
<td align="center">V</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">imap</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">V</td>
</tr>
</tbody></table>
<p>指令</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot; 查看特殊鍵</span></span><br><span class="line">:<span class="keyword">help</span> key-notation </span><br><span class="line"><span class="comment">&quot; 取消Key Mapping unmpa/nunmap/vunmap/iunmap</span></span><br><span class="line">:<span class="keyword">unmap</span> </span><br><span class="line"><span class="comment">&quot; 把全部的對映都清掉</span></span><br><span class="line">:mabclear </span><br></pre></td></tr></table></figure>

<ul>
<li>想把方向鍵的功態關掉，強迫自已使用HJKL來移動游標<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">:h key-notation</span><br><span class="line">:<span class="keyword">map</span> <span class="symbol">&lt;Up&gt;</span> <span class="symbol">&lt;Nop&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Vim的設定之KeyMapping-part2"><a href="#Vim的設定之KeyMapping-part2" class="headerlink" title="Vim的設定之KeyMapping_part2"></a>Vim的設定之KeyMapping_part2</h2><ul>
<li><p>map時無窮迴圈</p>
<ul>
<li>noremap no recursice mapping</li>
<li>什麼時候該用noremap?</li>
</ul>
</li>
<li><p>如果把原來的功能map用掉了怎麼辦</p>
<ul>
<li>Leader 預設值是 \</li>
<li>用Leader有什麼好處<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot; 把Leader設定成逗號</span></span><br><span class="line">:<span class="keyword">let</span> mapleader = <span class="string">&quot;,&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="Vim的設定之KeyMapping-part3"><a href="#Vim的設定之KeyMapping-part3" class="headerlink" title="Vim的設定之KeyMapping_part3"></a>Vim的設定之KeyMapping_part3</h2><ul>
<li>設定成舊的vi<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> nocompatible</span><br></pre></td></tr></table></figure></li>
<li>可檢視目前非預設值的設定<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">:<span class="keyword">set</span> </span><br></pre></td></tr></table></figure></li>
<li>主題<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">colorscheme</span> 列表</span><br><span class="line"><span class="comment">&quot; colorscheme ctrl+d</span></span><br><span class="line"><span class="comment">&quot; 如果沒有這個主題</span></span><br><span class="line"><span class="keyword">try</span> ... <span class="keyword">catch</span> ...<span class="keyword">endtry</span></span><br></pre></td></tr></table></figure></li>
<li>顯示目前游標所在地的狀態<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> ruler</span><br></pre></td></tr></table></figure></li>
<li>剩下3行就開始捲動<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> scrolloff=<span class="number">3</span></span><br></pre></td></tr></table></figure></li>
<li>斷行<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot; 設定如果文字太多的話自動折行</span></span><br><span class="line"><span class="keyword">set</span> wrap</span><br><span class="line"><span class="keyword">set</span> nowrap</span><br><span class="line"><span class="comment">&quot; 在比較適當的地方換行</span></span><br><span class="line"><span class="keyword">set</span> linebreak</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>設定在左下角顯示現在模式<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> showmode</span><br></pre></td></tr></table></figure></li>
<li>設定顯示敲打了什麼指令<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> showcmd</span><br></pre></td></tr></table></figure></li>
<li>比較聰渡的搜尋<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> smarcase</span><br></pre></td></tr></table></figure></li>
<li>設定顯示看不到的東西<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">list</span></span><br><span class="line"><span class="keyword">set</span> nolist</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="vim之自動命令"><a href="#vim之自動命令" class="headerlink" title="vim之自動命令"></a>vim之自動命令</h2><p>有三個範例</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot; 視窗切換時候顯示/隱藏游標底線</span></span><br><span class="line"><span class="keyword">autocmd</span> WinEnter * <span class="keyword">setlocal</span> cursorline</span><br><span class="line"><span class="keyword">autocmd</span> WinLeave * <span class="keyword">setlocal</span> nocursorline</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 存檔時自動把行末多餘的空白刪除</span></span><br><span class="line"><span class="keyword">autocmd</span> BufWritePre * :%s/\s\+$//<span class="keyword">e</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; 按下 F5 執行程式</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">executable</span>(<span class="string">&quot;ruby&quot;</span>)</span><br><span class="line">  <span class="keyword">autocmd</span> BufRead,BufNewFile *.rb <span class="keyword">noremap</span> <span class="symbol">&lt;F5&gt;</span> :% <span class="keyword">w</span> !ruby -<span class="keyword">w</span><span class="symbol">&lt;Enter&gt;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">autocmd</span> BufRead,BufNewFile *.rb <span class="keyword">noremap</span> <span class="symbol">&lt;F5&gt;</span> :<span class="keyword">echo</span> <span class="string">&quot;you need to install Ruby first!&quot;</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">executable</span>(<span class="string">&quot;node&quot;</span>)</span><br><span class="line">  <span class="keyword">autocmd</span> BufRead,BufNewFile *.js <span class="keyword">noremap</span> <span class="symbol">&lt;F5&gt;</span> :% <span class="keyword">w</span> !node<span class="symbol">&lt;Enter&gt;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">autocmd</span> BufRead,BufNewFile *.rb <span class="keyword">noremap</span> <span class="symbol">&lt;F5&gt;</span> :<span class="keyword">echo</span> <span class="string">&quot;you need to install Node.js first!&quot;</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
<p>命令</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot;有關autocmd的事件</span></span><br><span class="line">:h <span class="keyword">autocmd</span>-events</span><br><span class="line"><span class="comment">&quot;更多關於autocmd請查閱</span></span><br><span class="line">:h <span class="keyword">autocmd</span></span><br></pre></td></tr></table></figure>
<h2 id="整理你的-Vim-設定"><a href="#整理你的-Vim-設定" class="headerlink" title="整理你的 Vim 設定"></a>整理你的 Vim 設定</h2><p>把設定全部寫在.vimrc有問題嗎？<br>vim 有一套推薦的規劃</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">:h vimfiles</span><br></pre></td></tr></table></figure>

<h2 id="vim的外掛"><a href="#vim的外掛" class="headerlink" title="vim的外掛"></a>vim的外掛</h2><ul>
<li>外掛管理工具<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- VimPlug https://github.com/junegunn/vim-plug</span><br><span class="line">- Pathogen https://github.com/tpope/vim-pathogen</span><br><span class="line">- Vundle https://github.com/VundleVim/Vundle.vim</span><br><span class="line">- CSS Color https://github.com/ap/vim-css-color</span><br></pre></td></tr></table></figure></li>
<li>外掛夠用就好，用不到的就不要裝</li>
<li>建議用Git管理設定</li>
</ul>
<h2 id="Vim-外掛介紹-part-1"><a href="#Vim-外掛介紹-part-1" class="headerlink" title="Vim 外掛介紹 part 1"></a>Vim 外掛介紹 part 1</h2><p>相關連結：</p>
<ul>
<li>Vim-Airline <a href="https://github.com/vim-airline/vim-airline-themes">https://github.com/vim-airline/vim-airline-themes</a></li>
<li>NERDTree <a href="https://github.com/scrooloose/nerdtree">https://github.com/scrooloose/nerdtree</a></li>
<li>VimAwesome <a href="https://vimawesome.com/">https://vimawesome.com</a><br>額外設定：<br>Vim-Airline<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">g:airline_powerline_fonts</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:airline</span>#extensions#tabline#enabled = <span class="number">1</span></span><br></pre></td></tr></table></figure>
NERDTree<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">nnoremap</span> <span class="symbol">&lt;silent&gt;</span> <span class="symbol">&lt;F2&gt;</span> :NERDTreeToggle<span class="symbol">&lt;CR&gt;</span></span><br><span class="line"><span class="keyword">let</span> NERDTreeMinimalUI=<span class="number">1</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Vim-外掛介紹-part-2"><a href="#Vim-外掛介紹-part-2" class="headerlink" title="Vim 外掛介紹 part 2"></a>Vim 外掛介紹 part 2</h2><h2 id="安裝外掛：-ctrlp-https-github-com-ctrlpvim-ctrlp-vim-emmethttps-github-com-mattn-emmet-vim-surroundhttps-github-com-tpope-vim-surround-vim-repeathttps-github-com-tpope-vim-repeat"><a href="#安裝外掛：-ctrlp-https-github-com-ctrlpvim-ctrlp-vim-emmethttps-github-com-mattn-emmet-vim-surroundhttps-github-com-tpope-vim-surround-vim-repeathttps-github-com-tpope-vim-repeat" class="headerlink" title="安裝外掛：- ctrlp https://github.com/ctrlpvim/ctrlp.vim- emmethttps://github.com/mattn/emmet-vim- surroundhttps://github.com/tpope/vim-surround- vim-repeathttps://github.com/tpope/vim-repeat"></a>安裝外掛：<br>- ctrlp <a href="https://github.com/ctrlpvim/ctrlp.vim">https://github.com/ctrlpvim/ctrlp.vim</a><br>- emmet<a href="https://github.com/mattn/emmet-vim">https://github.com/mattn/emmet-vim</a><br>- surround<a href="https://github.com/tpope/vim-surround">https://github.com/tpope/vim-surround</a><br>- vim-repeat<a href="https://github.com/tpope/vim-repeat">https://github.com/tpope/vim-repeat</a></h2><p>額外設定：<br>ctrlp</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">g:ctrlp_custom_ignore</span> = &#123;</span><br><span class="line">  \ <span class="string">&#x27;dir&#x27;</span>:  <span class="string">&#x27;\v[\/]\.(git|hg|svn)$&#x27;</span>,</span><br><span class="line">  \ <span class="string">&#x27;file&#x27;</span>: <span class="string">&#x27;\v\.(exe|so|dll)$&#x27;</span>,</span><br><span class="line">  \ <span class="string">&#x27;link&#x27;</span>: <span class="string">&#x27;some_bad_symbolic_links&#x27;</span>,</span><br><span class="line">  \ &#125;</span><br><span class="line">```  </span><br><span class="line">emmet</span><br><span class="line">``` <span class="keyword">vim</span>=</span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:user_emmet_install_global</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">autocmd</span> FileType html,css,scss EmmetInstall</span><br><span class="line"><span class="keyword">autocmd</span> Filetype html,css,scss <span class="keyword">imap</span> <span class="symbol">&lt;silent&gt;</span> <span class="symbol">&lt;expr&gt;</span> <span class="symbol">&lt;tab&gt;</span> emmet#expandAbbrIntelligent(<span class="string">&quot;\&lt;tab&gt;&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Vim-外掛介紹-part-3"><a href="#Vim-外掛介紹-part-3" class="headerlink" title="Vim 外掛介紹 part 3"></a>Vim 外掛介紹 part 3</h2><ul>
<li>tComment <a href="https://github.com/tomtom/tcomment_vim">https://github.com/tomtom/tcomment_vim</a></li>
<li>vim-ruby <a href="https://github.com/vim-ruby/vim-ruby">https://github.com/vim-ruby/vim-ruby</a></li>
<li>vim-rails <a href="https://github.com/tpope/vim-rails">https://github.com/tpope/vim-rails</a></li>
<li>vim-rspec <a href="https://github.com/thoughtbot/vim-rspec">https://github.com/thoughtbot/vim-rspec</a></li>
</ul>
<p>額外設定：</p>
<ul>
<li>NERDTree 設定：</li>
</ul>
<p>切換目錄時可以切換起始目錄（Root Directory）</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> NERDTreeChDirMode = <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>ctrlp 設定：</p>
<ol>
<li>排除不想搜尋的 tmp 目錄。</li>
<li>把內建的 grep 換成速度更快的 silver searcher</li>
</ol>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">g:ctrlp_by_filename</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:ctrlp_custom_ignore</span> = &#123;</span><br><span class="line">  \ <span class="string">&#x27;dir&#x27;</span>:  <span class="string">&#x27;\v[\/]\.(git|hg|svn)$|tmp$&#x27;</span>,</span><br><span class="line">  \ <span class="string">&#x27;file&#x27;</span>: <span class="string">&#x27;\v\.(exe|so|dll)$&#x27;</span>,</span><br><span class="line">  \ <span class="string">&#x27;link&#x27;</span>: <span class="string">&#x27;some_bad_symbolic_links&#x27;</span>,</span><br><span class="line">  \ &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">executable</span>(<span class="string">&#x27;ag&#x27;</span>)</span><br><span class="line">  <span class="keyword">set</span> grepprg=ag\ --nogroup\ --nocolor</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">g:ctrlp_user_command</span> = <span class="string">&#x27;ag %s -l --nocolor -g &quot;&quot;&#x27;</span></span><br><span class="line">  <span class="keyword">let</span> <span class="variable">g:ctrlp_use_caching</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<p>需另外安裝 Silver Searcher：<br><a href="https://github.com/ggreer/the_silver_searcher">https://github.com/ggreer/the_silver_searcher</a></p>
<p>參考連結：</p>
<ul>
<li><a href="https://thoughtbot.com/blog/faster-grepping-in-vim">https://thoughtbot.com/blog/faster-grepping-in-vim</a></li>
</ul>
<h2 id="Vim-外掛介紹-part-4"><a href="#Vim-外掛介紹-part-4" class="headerlink" title="Vim 外掛介紹 part 4"></a>Vim 外掛介紹 part 4</h2><ul>
<li>snipMate <a href="https://github.com/garbas/vim-snipmate">https://github.com/garbas/vim-snipmate</a></li>
<li>tagbar <a href="https://github.com/majutsushi/tagbar">https://github.com/majutsushi/tagbar</a></li>
<li>ack <a href="https://github.com/mileszs/ack.vim">https://github.com/mileszs/ack.vim</a></li>
</ul>
<p>額外設定：<br><a href="https://gist.github.com/kaochenlong/a999aee921b477a79fbbb7d251ecff9d">https://gist.github.com/kaochenlong/a999aee921b477a79fbbb7d251ecff9d</a></p>
<p>配色</p>
<ul>
<li>Molokai <a href="https://github.com/tomasr/molokai">https://github.com/tomasr/molokai</a></li>
<li>Gruvbox <a href="https://github.com/morhetz/gruvbox">https://github.com/morhetz/gruvbox</a></li>
<li>Wombat256 <a href="https://github.com/vim-scripts/wombat256.vim">https://github.com/vim-scripts/wombat256.vim</a></li>
</ul>
<h2 id="vim的其它"><a href="#vim的其它" class="headerlink" title="vim的其它"></a>vim的其它</h2><p>搜尋和取代</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">：%s/text/cch/g</span><br></pre></td></tr></table></figure>

<h2 id="vim高見龍參考"><a href="#vim高見龍參考" class="headerlink" title="vim高見龍參考"></a>vim高見龍參考</h2><ul>
<li>Vim 官方文件 <a href="https://www.vim.org/docs.php">https://www.vim.org/docs.php</a></li>
<li>Learn VimScript the Hard Way <a href="http://learnvimscriptthehardway.steve/">http://learnvimscriptthehardway.steve</a>…</li>
<li>Practical Vim <a href="https://pragprog.com/book/dnvim2/prac">https://pragprog.com/book/dnvim2/prac</a>…</li>
<li>Vimium <a href="https://chrome.google.com/webstore/de">https://chrome.google.com/webstore/de</a>…</li>
<li>VimGolf <a href="https://www.vimgolf.com/">https://www.vimgolf.com</a></li>
</ul>
<h1 id="安裝現成設定檔"><a href="#安裝現成設定檔" class="headerlink" title="安裝現成設定檔"></a>安裝現成設定檔</h1><ul>
<li>安裝流程 <a href="https://github.com/kaochenlong/cch">https://github.com/kaochenlong/cch</a></li>
</ul>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><p><a href="http://wiki.csie.ncku.edu.tw/vim/vimrc?printable">http://wiki.csie.ncku.edu.tw/vim/vimrc?printable</a><br><a href="https://stackoverflow.com/questions/58676693/prevent-vscode-from-unfolding-code-when-cursor-moves-past-folded-section">https://stackoverflow.com/questions/58676693/prevent-vscode-from-unfolding-code-when-cursor-moves-past-folded-section</a></p>
<p><a href="https://www.yuexun.me/blog/the-vim-guide-for-vs-code-users/">https://www.yuexun.me/blog/the-vim-guide-for-vs-code-users/</a><br><a href="https://chengjingchao.com/2020/06/13/VS-Code-%E4%B8%8E-Vim/">https://chengjingchao.com/2020/06/13/VS-Code-%E4%B8%8E-Vim/</a></p>
<h4 id="將看到脫窗的註解文字-深藍色-改變顏色"><a href="#將看到脫窗的註解文字-深藍色-改變顏色" class="headerlink" title="將看到脫窗的註解文字 深藍色 改變顏色"></a>將看到脫窗的註解文字 深藍色 改變顏色</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shell# vim /home/eric/.vimrc</span><br><span class="line"> </span><br><span class="line">hi Comment ctermfg=cyan</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="這是記錄Vim的顏色的設定"><a href="#這是記錄Vim的顏色的設定" class="headerlink" title="這是記錄Vim的顏色的設定"></a>這是記錄Vim的顏色的設定</h4><p>原來的設定有在註解看不清楚，所以來設定一下</p>
<ul>
<li><p>下載molokai的配色<br> 先檢查vim安裝的目錄</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">whereis vim</span><br></pre></td></tr></table></figure>
<p> 在到vim的安裝目錄，會看到vim74或vim73,看你安裝的版本，我的是vim74，在vim74下有目錄是colors,將下載解壓的molokai.vim<br> 放在此，在參考資料下有gitthub,請自行下載，下載後放在colors的目錄下</p>
</li>
<li><p>在使用者建立配色<br>在~目錄建立文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi .vimrc</span><br></pre></td></tr></table></figure>
<p>目前的內容如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set t_Co=256</span><br><span class="line">:set nu</span><br><span class="line">:colorscheme molokai</span><br><span class="line">hi Comment ctermfg=lightblue</span><br></pre></td></tr></table></figure>
</li>
<li><p>參考資料</p>
</li>
<li><p><a href="http://worldend.logdown.com/posts/746211-adjust-the-color-of-comment-in-vim">molokai</a></p>
</li>
<li><p><a href="https://vim.ink/vim-color-schemes.html">調整 VIM 的註解顏色</a></p>
</li>
<li><p><a href="http://www.cnblogs.com/heiing/archive/2012/02/02/2335825.html">VIM学习笔记：设置VIM的配色方案</a></p>
</li>
<li><p><a href="https://magiclen.org/vimrc/">個人化自己的vim文字編輯器(.vimrc設定教學)</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>記錄</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>vim</tag>
      </tags>
  </entry>
  <entry>
    <title>Javascript相關</title>
    <url>/Javascript%E7%9B%B8%E9%97%9C/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>記錄有關一些javascript的用法</p>
<h2 id="UTC的用法"><a href="#UTC的用法" class="headerlink" title="UTC的用法"></a>UTC的用法</h2><p>目前是使用<a href="https://momentjs.com/">momentjs</a>這個程式庫來轉成要的UTC</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//將日期塞入，出來就是utc的時間格</span></span><br><span class="line">moment.<span class="title function_">utc</span>(formmodel.<span class="property">value</span>.<span class="property">date</span>);</span><br><span class="line"><span class="comment">//以數字來使用</span></span><br><span class="line">moment.<span class="title function_">utc</span>(formmodel.<span class="property">value</span>.<span class="property">date</span>).<span class="title function_">valueOf</span>();</span><br><span class="line"><span class="comment">//不要毫秒</span></span><br><span class="line"><span class="title class_">Math</span>.<span class="title function_">round</span>(moment.<span class="title function_">utc</span>(formmodel.<span class="property">value</span>.<span class="property">date</span>).<span class="title function_">valueOf</span>() / <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>



<h2 id="Buffer的用法"><a href="#Buffer的用法" class="headerlink" title="Buffer的用法"></a>Buffer的用法</h2><h3 id="建立array"><a href="#建立array" class="headerlink" title="建立array"></a>建立array</h3><p>這是其中的一個</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> array1 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;123&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array1);<span class="comment">//&lt;Buffer 31 32 33&gt; </span></span><br><span class="line"><span class="keyword">var</span> array2 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array2);<span class="comment">//&lt;Buffer 61 62 63&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="合併"><a href="#合併" class="headerlink" title="合併"></a>合併</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> array1 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;123&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array1);<span class="comment">//&lt;Buffer 31 32 33&gt; </span></span><br><span class="line"><span class="keyword">var</span> array2 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array2);<span class="comment">//&lt;Buffer 61 62 63&gt;</span></span><br><span class="line"><span class="keyword">var</span> array3 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;ABC&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array3);<span class="comment">//&lt;Buffer 41 42 43&gt;</span></span><br><span class="line"><span class="keyword">var</span> totallength = array1.<span class="property">length</span> + array2.<span class="property">length</span> + array3.<span class="property">length</span>;</span><br><span class="line"><span class="keyword">var</span> buf = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([array1, array2, array3], totallength);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buf);<span class="comment">//&lt;Buffer 31 32 33 61 62 63 41 42 43&gt;</span></span><br></pre></td></tr></table></figure>

<p>以下是參考的碼</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> videobuff = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(chunk);</span><br><span class="line"><span class="keyword">var</span> audiobuff = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(soundchunk);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Duration</span> = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">2</span>);<span class="comment">//new Buffer(2);</span></span><br><span class="line"><span class="title class_">Duration</span>.<span class="title function_">writeUInt16LE</span>(<span class="number">1000</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">var</span> auddiolen = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">4</span>);<span class="comment">//new Buffer(4);</span></span><br><span class="line">auddiolen.<span class="title function_">writeUInt32LE</span>(audiobuff.<span class="property">length</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> totalLength = <span class="title class_">Duration</span>.<span class="property">length</span> + auddiolen.<span class="property">length</span> + videobuff.<span class="property">length</span> + audiobuff.<span class="property">length</span>;</span><br><span class="line"><span class="keyword">var</span> buf = []</span><br><span class="line"><span class="keyword">var</span> buf = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([<span class="title class_">Duration</span>, auddiolen, audiobuff, videobuff], totalLength);</span><br></pre></td></tr></table></figure>

<h4 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h4><p><a href="https://kknews.cc/zh-tw/other/n53xb2g.html">Node.js：Buffer淺談</a></p>
<p><a href="https://carlos-studio.com/2017/08/14/node-js-buffer-%E6%A8%A1%E7%B5%84%E8%99%95%E7%90%86/">Buffer 模組處理</a></p>
<h2 id="日期轉換的用法"><a href="#日期轉換的用法" class="headerlink" title="日期轉換的用法"></a>日期轉換的用法</h2><p>將時間的字串，先取出來,再利用dataToYMD轉成相要的顯示字串<br>new Date().toISOString(); &#x2F;&#x2F; e.g. “2016-11-21T08:00:00.000Z”</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function GetCurDate()</span><br><span class="line">&#123;</span><br><span class="line">    var strDate = $(&quot;#dummyDate&quot;).val().substring(0, 10);</span><br><span class="line">    //console.log(strDate);</span><br><span class="line">    var d = new Date(Date.parse(strDate));</span><br><span class="line">    var szformatDate = dateToYMD(d);</span><br><span class="line">    return szformatDate;</span><br><span class="line">&#125;</span><br><span class="line">function dateToYMD(date) &#123;</span><br><span class="line">    var d = date.getDate();</span><br><span class="line">    var m = date.getMonth() + 1;</span><br><span class="line">    var y = date.getFullYear();</span><br><span class="line">    return &#x27;&#x27; + y + &#x27;/&#x27; + (m &lt;= 9 ? &#x27;0&#x27; + m : m) + &#x27;/&#x27; + (d &lt;= 9 ? &#x27;0&#x27; + d : d);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="JavaScript-Array陣列的操作方法"><a href="#JavaScript-Array陣列的操作方法" class="headerlink" title="JavaScript Array陣列的操作方法"></a>JavaScript Array陣列的操作方法</h2><p>目前記錄是我有用到的方法</p>
<h3 id="forEach的用法"><a href="#forEach的用法" class="headerlink" title="forEach的用法"></a>forEach的用法</h3><p>有index</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var array1 = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;];</span><br><span class="line">array1.forEach(function(item,idx) &#123;</span><br><span class="line">  console.log(item);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>無index</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var array1 = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;];</span><br><span class="line">array1.forEach(function(item) &#123;</span><br><span class="line">  console.log(item);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="every-和some"><a href="#every-和some" class="headerlink" title="every()和some()"></a>every()和some()</h3><ul>
<li>every()是對數組中每一項運行給定函數，如果該函數對每一項返回true,則返回true。</li>
<li>some()是對數組中每一項運行給定函數，如果該函數對任一項返回true,則返回true。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr.<span class="title function_">some</span>(<span class="keyword">function</span> (<span class="params">item, index, array</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`item=<span class="subst">$&#123;item&#125;</span>,index=<span class="subst">$&#123;index&#125;</span>,array=<span class="subst">$&#123;array&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> item &gt; <span class="number">3</span>;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr.<span class="title function_">every</span>(<span class="keyword">function</span> (<span class="params">item, index, array</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`item=<span class="subst">$&#123;item&#125;</span>,index=<span class="subst">$&#123;index&#125;</span>,array=<span class="subst">$&#123;array&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> item &gt; <span class="number">3</span>;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>運行結果</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">item=1,index=0,array=1,2,3,4,5,6 </span><br><span class="line">item=2,index=1,array=1,2,3,4,5,6 </span><br><span class="line">item=3,index=2,array=1,2,3,4,5,6 </span><br><span class="line">item=4,index=3,array=1,2,3,4,5,6 </span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="comment">#-------------------------------- </span></span><br><span class="line">item=1,index=0,array=1,2,3,4,5,6 </span><br><span class="line"><span class="literal">false</span> </span><br></pre></td></tr></table></figure>

<blockquote>
<p>some一直在找符合條件的值，一旦找到，則不會繼續迭代下去。</p>
<p>every從迭代開始，一旦有一個不符合條件，則不會繼續迭下去。</p>
</blockquote>
<h2 id="Promise的相關資訊"><a href="#Promise的相關資訊" class="headerlink" title="Promise的相關資訊"></a>Promise的相關資訊</h2><p><a href="https://dotblogs.com.tw/wasichris/2017/08/15/021114">理解 Promise 狀態及使用方式</a></p>
<p><a href="https://eyesofkids.gitbooks.io/javascript-start-es6-promise/content/">從Promise開始的JavaScript異步生活</a><br><a href="https://taylor.callsen.me/ajax-multi-file-uploader-with-native-js-and-promises/">Multi File Uploader built with Native JS and Promises</a></p>
<p><a href="https://neighborhood999.github.io/2018/04/17/use-blob-and-file-web-api-create-upload-image-preview-immediately/">使用 Blob 和 File 相關 Web API 即時呈現上傳圖片檔案</a></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>javascript</category>
      </categories>
      <tags>
        <tag>javascript</tag>
      </tags>
  </entry>
  <entry>
    <title>Notepad++和vscode的相關資訊</title>
    <url>/NotepadPlusPLus%E7%9A%84%E7%9B%B8%E9%97%9C%E8%B3%87%E8%A8%8A/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p> otepad++和vscode的相關資訊的整理<br> <span id="more"></span> </p>
<h1 id="notepad-主題配色相關"><a href="#notepad-主題配色相關" class="headerlink" title="notepad++主題配色相關"></a>notepad++主題配色相關</h1><h2 id="目前的設定2021-04-28"><a href="#目前的設定2021-04-28" class="headerlink" title="目前的設定2021-04-28"></a>目前的設定2021-04-28</h2><p>在<strong>設定-&gt;設定程式語言格式</strong>中</p>
<p>主要設定</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Backround Color(背景色彩) -&gt; 30 30 30</span><br></pre></td></tr></table></figure>



<img src="Snipaste_2021-04-28_10-34-55.png" style="zoom:80%;" />

<p>目前的current line </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Style Configurator -&gt; Current Line Background -&gt; Background Color -&gt; 50 50 50</span><br><span class="line">Style Configurator -&gt; Selected Text Color -&gt; Background Color -&gt; 100 100 100</span><br></pre></td></tr></table></figure>



<img src="Snipaste_2021-04-28_10-35-35.png" style="zoom:80%;" />

<p>選到的顏色</p>
<img src="Snipaste_2021-04-28_10-35-54.png" style="zoom:80%;" />



<h2 id="markdown的高亮設定"><a href="#markdown的高亮設定" class="headerlink" title="markdown的高亮設定"></a>markdown的高亮設定</h2><p>下載最新的markdow的配置文件<a href="https://github.com/Edditoria/markdown-plus-plus">github</a><br>打開notepad++依次點擊 <em><strong>語言-&gt;定義程式語言-&gt;匯入</strong></em> ，選擇的是theme-deep-black里的userDefinedLang-markdown.deep-black.modern.xml<br>樣式</p>
<p>在設定成如果是<code>md 或 markdown</code>可以自動使用這個配色</p>
<img src="Snipaste_2021-04-28_10-27-49.png" style="zoom:80%;" />

<p>在定義程式語言中來設定</p>
<img src="Snipaste_2021-04-28_10-31-02.png" style="zoom:80%;" />

<h2 id="Monokai主題"><a href="#Monokai主題" class="headerlink" title="Monokai主題"></a>Monokai主題</h2><p>下載Monokai scheme(scheme.mg.monokai)[<a href="https://github.com/mgcrea/scheme.mg.monokai]">https://github.com/mgcrea/scheme.mg.monokai]</a><br>打開notepad++依次點擊<em><strong>設定-&gt;匯入-&gt;匯入主題面板</strong></em> ，選擇是notepad++里的Monokai.xml樣式<br>，重啟notepad++</p>
<h2 id="顯示使用全局設定"><a href="#顯示使用全局設定" class="headerlink" title="顯示使用全局設定"></a>顯示使用全局設定</h2><p>打開notepad++依次點擊<em><strong>設定-&gt;設定程式語言格式</strong></em> 如下圖設定</p>
<img src="2018-08-10_09_40_1Image.png" style="zoom:80%;" />




<h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://blog.csdn.net/littlehaes/article/details/79284338">Notepad++上使用Markdown及其高亮Highlight设置</a></p>
<h1 id="HexView"><a href="#HexView" class="headerlink" title="HexView"></a>HexView</h1><p>  因為是64位元，所以先要找到64位元的Dll在(github)[<a href="https://github.com/chcg/NPP_HexEdit/releases]%EF%BC%8C%E5%9C%A8%E4%B8%8B%E8%BC%89%E5%BE%8C%E5%9C%A8%E5%A6%82%E4%B8%8B%E5%9C%96%E6%89%80%E7%A4%BA%EF%BC%8C%E5%B0%87%E6%8F%92%E4%BB%B6%E5%8C%AF%E5%85%A5">https://github.com/chcg/NPP_HexEdit/releases]，在下載後在如下圖所示，將插件匯入</a></p>
<img src="2020-06-10_09_25_36_Image.jpg" style="zoom:80%;" />

<p>相關訊息<a href="https://community.notepad-plus-plus.org/topic/17459/why-there-is-no-new-hexeditor-now/4">https://community.notepad-plus-plus.org/topic/17459/why-there-is-no-new-hexeditor-now/4</a></p>
<h1 id="記錄有用的快速鍵"><a href="#記錄有用的快速鍵" class="headerlink" title="記錄有用的快速鍵"></a>記錄有用的快速鍵</h1><h2 id="區塊選取功能"><a href="#區塊選取功能" class="headerlink" title="區塊選取功能"></a>區塊選取功能</h2><p>使用方式有兩種 :</p>
<ol>
<li>先按住ALT鍵後，然後用滑鼠左鍵來拖曳要選取的<em>列</em>範圍</li>
<li>同時按住ALT跟SHIFT鍵後, 用方向鍵來拉出要選取的<em>行</em>範圍</li>
</ol>
<h6 id="參考資料-1"><a href="#參考資料-1" class="headerlink" title="參考資料"></a>參考資料</h6><ul>
<li><a href="http://allen0818.pixnet.net/blog/post/114690014-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-notepad%2B%2B-%E7%9A%84%E5%8D%80%E5%A1%8A%E9%81%B8%E5%8F%96%E5%8A%9F%E8%83%BD"> 如何使用 Notepad++ 的區塊選取功能</a></li>
<li>[Notepad++ 的列、區塊選取功能](</li>
</ul>
<h1 id="vscode相關"><a href="#vscode相關" class="headerlink" title="vscode相關"></a>vscode相關</h1><p> 列出安裝的列表<br><a href="https://stackoverflow.com/questions/35773299/how-can-you-export-the-visual-studio-code-extension-list">https://stackoverflow.com/questions/35773299/how-can-you-export-the-visual-studio-code-extension-list</a><br>Windows (PowerShell, e. g. using Visual Studio Code’s integrated Terminal):</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">code --list-extensions </span><br><span class="line"></span><br><span class="line">code --list-extensions &gt; vscode-extensions.list</span><br><span class="line">cat extensions.txt |% &#123; code --install-extension $_&#125;</span><br></pre></td></tr></table></figure>

<p>Highlight Line<br>Bookmarks<br>Beautify css&#x2F;sass&#x2F;scss&#x2F;less<br>TODO Highlight<br>Gremlins tracker for Visual Studio<br>Latest TypeScript and Javascript<br>Live Server<br>EditorConfig for VS Code</p>
<h2 id="VSCode的設定"><a href="#VSCode的設定" class="headerlink" title="VSCode的設定"></a>VSCode的設定</h2><p>  這是我的設定，在寫angular code的時候，我發現它會一直檢查檔案有無改變，然後就一直complier，reload網頁，每打一個字就做一次，讓我的電腦變慢，google一下發現，在VSCode可以來設定一下，在<strong>檔案-&gt;喜好設定-&gt;設定</strong>，會打開視窗，接下來選擇<strong>使用者</strong>，將<code>Files:Auto Save</code>，關畢，我自已的習慣是自已會按下儲存。在<code>tscofig.json</code>的<code>compilerOnSave</code>，也要設定成true。</p>
<h2 id="html的長度"><a href="#html的長度" class="headerlink" title="html的長度"></a>html的長度</h2><p>在編輯html的文件時有時候會很長，vscode會幫我自動的折行，我不想折行要在<strong>檔案-&gt;喜好設定-&gt;設定</strong>會打開視窗，接下來選擇<strong>使用者</strong>,將<code>HTML&gt;Fomat:Wrap Line Length</code>設定成<code>0</code></p>
<h2 id="vscode相關問題"><a href="#vscode相關問題" class="headerlink" title="vscode相關問題"></a>vscode相關問題</h2><p>解决：vscode-remote-ssh 远程连接后 rg 进程占用 CPU 问题<br><a href="https://blog.csdn.net/sigmarising/article/details/107615035">https://blog.csdn.net/sigmarising/article/details/107615035</a></p>
<h2 id="Neovim相關"><a href="#Neovim相關" class="headerlink" title="Neovim相關"></a>Neovim相關</h2><p><a href="https://zhangjk98.xyz/vscode-neovim-setting/">https://zhangjk98.xyz/vscode-neovim-setting/</a><br><a href="https://www.jianshu.com/p/ac739c6ea541">https://www.jianshu.com/p/ac739c6ea541</a><br>先來安裝win10版的neovim<br><a href="https://github.com/neovim/neovim/wiki/Installing-Neo">https://github.com/neovim/neovim/wiki/Installing-Neo</a><br>win10的設定檔在</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//檢查</span><br><span class="line">:echo stdpath(&#x27;config&#x27;)</span><br><span class="line">C:\Users\ttom\AppData\Local\nvim</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>安裝vim-plug<br>Windows (PowerShell)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iwr -useb https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim |`</span><br><span class="line">    ni &quot;$(@($env:XDG_DATA_HOME, $env:LOCALAPPDATA)[$null -eq $env:XDG_DATA_HOME])/nvim-data/site/autoload/plug.vim&quot; -Force</span><br></pre></td></tr></table></figure>
<p>放在C:\Users\ttom\AppData\Local\nvim-data\site\autoload<br>寫好要安裝的plag，在下<code>PlugInstall</code></p>
<h2 id="Paste-Image外掛"><a href="#Paste-Image外掛" class="headerlink" title="Paste Image外掛"></a>Paste Image外掛</h2><p><a href="https://marketplace.visualstudio.com/items?itemName=mushan.vscode-paste-image">Paste Image</a><br>複製圖片後在 .md 按 Ctrl-Alt-V 貼上，這個套件會將剪貼簿裡的圖片以時間為檔名存成 .png，並在游標處插入 <img src="/png%E6%AA%94%E5%90%8D">，你如果常在抓畫面做文件，就知道這有多好用</p>
<h2 id="vscode的外掛vscode-vim的設定檔"><a href="#vscode的外掛vscode-vim的設定檔" class="headerlink" title="vscode的外掛vscode-vim的設定檔"></a>vscode的外掛vscode-vim的設定檔</h2><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;vim.easymotion&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;vim.easymotionMarkerBackgroundColor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#FBD87F&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;vim.easymotionMarkerFontWeight&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bold&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;vim.easymotionMarkerForegroundColorOneChar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#DE0079&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;vim.easymotionKeys&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hklyuiopnmqwertzxcvbasdgjf&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;vim.handleKeys&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;&lt;C-c&gt;&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;&lt;C-v&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;vim.foldfix&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;vim.useSystemClipboard&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;vim.normalModeKeyBindingsNonRecursive&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;d&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;d&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;editor.action.deleteLines&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textInputFocus &amp;&amp; !editorReadonly&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;y&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;editor.action.clipboardCopyAction&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textInputFocus&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;y&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;y&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;editor.action.clipboardCopyAction&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textInputFocus&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;p&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;editor.action.clipboardPasteAction&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textInputFocus &amp;&amp; !editorReadonly&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;&lt;C-c&gt;&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;editor.action.clipboardPasteAction&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textInputFocus &amp;&amp; !editorReadonly&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;&lt;C-v&gt;&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;editor.action.clipboardPasteAction&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textInputFocus &amp;&amp; !editorReadonly&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;vim.visualModeKeyBindingsNonRecursive&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;y&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;editor.action.clipboardCopyAction&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textInputFocus&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;y&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;y&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;editor.action.clipboardCopyAction&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textInputFocus&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;x&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;deleteRight&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textInputFocus&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;&lt;C-c&gt;&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;editor.action.clipboardCopyAction&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textInputFocus&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;&lt;C-v&gt;&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;editor.action.clipboardPasteAction&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;textInputFocus&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<h1 id="VSCode的Python相關設定"><a href="#VSCode的Python相關設定" class="headerlink" title="VSCode的Python相關設定"></a>VSCode的Python相關設定</h1><p>在VScode中，不能自動格式化，在參考網上的資訊<br>設定中，找到python相關設定如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;python.formatting.provider&quot;: &quot;autopep8&quot;,</span><br><span class="line">&quot;python.formatting.autopep8Args&quot;: [</span><br><span class="line">    &quot;--max-line-length&quot;,</span><br><span class="line">    &quot;120&quot;,</span><br><span class="line">    &quot;--experimental&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>可以不用<code>--experimental</code></p>
<h1 id="VSCode的Java設定"><a href="#VSCode的Java設定" class="headerlink" title="VSCode的Java設定"></a>VSCode的Java設定</h1><p>因為要建立minecraft的一些插件，所以要編譯opensource</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ mvn package</span><br></pre></td></tr></table></figure>
<h6 id="參考資料-2"><a href="#參考資料-2" class="headerlink" title="參考資料"></a>參考資料</h6><ul>
<li><a href="https://74th.github.io/vscode-debug-specs/java/#attach-running-and-remote-process">How to Debug Java with VSCode</a></li>
<li><a href="https://www.cnblogs.com/zhaoshizi/p/9524421.html">VSCode搭建Java开发运行环境</a></li>
<li><a href="https://www.jianshu.com/p/ad9dbc4e31b0">VS Code编辑器配置Java开发环境</a></li>
<li><a href="http://pollexpm.blogspot.com/2017/04/vs-code.html">VS code _ 好用外掛《一》</a></li>
<li><a href="https://segmentfault.com/a/1190000014822387">win10+vscode部署java开发环境</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/MAVEN/Tutorial%3A+Build+a+JAR+file+with+Maven+in+5+minutes">Tutorial: Build a JAR file with Maven in 5 minutes</a></li>
<li><a href="https://blog.csdn.net/antony1776/article/details/80298326">VS code + Java 配置与使用</a></li>
</ul>
]]></content>
      <categories>
        <category>軟體</category>
        <category>設定</category>
      </categories>
      <tags>
        <tag>Notepad++</tag>
        <tag>vscode</tag>
      </tags>
  </entry>
  <entry>
    <title>專案回顧</title>
    <url>/%E5%B0%88%E6%A1%88%E5%9B%9E%E9%A1%A7/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>  記錄之前有制作的專案，將相關資訊留下來，以免忘記。</p>
<span id="more"></span>
<h3 id="GOMO2O-全球摩動"><a href="#GOMO2O-全球摩動" class="headerlink" title="GOMO2O 全球摩動"></a>GOMO2O 全球摩動</h3><p>主要 Net Core,Web(angularjs)<br><a href="https://youtu.be/3saC7VDd65s">汽摩專家</a></p>
<h3 id="佳樂科技"><a href="#佳樂科技" class="headerlink" title="佳樂科技"></a>佳樂科技</h3><p>主要 C#,WPF<br><a href="https://www.youtube.com/watch?v=9sReUQUPYjg">互動式數位看版</a><br><a href="https://www.youtube.com/watch?v=4dA6gMCYj7o">導覽系統</a><br><a href="https://www.youtube.com/watch?v=k8NFq0Jfhi8">FG遠雄購物中心-導覽系統</a><br><a href="https://www.youtube.com/watch?v=5AX6tQTvsfI">門診叫號&amp;櫃台畫面合併</a><br><a href="https://www.youtube.com/watch?v=47Fzd9O7VY0">大頭拍拍樂</a><br><a href="https://www.youtube.com/watch?v=252e4lNtiu4">編輯器 </a></p>
<h3 id="鈊象電子"><a href="#鈊象電子" class="headerlink" title="鈊象電子"></a>鈊象電子</h3><p>主要 C++,python(BigWorld引擎和CEGUI)<br><a href="https://www.youtube.com/watch?v=LHgNS0Tm2I8">西遊釋厄傳</a></p>
]]></content>
      <categories>
        <category>記錄</category>
        <category>專案</category>
      </categories>
      <tags>
        <tag>專案</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄AWS相關資訊</title>
    <url>/%E8%A8%98%E9%8C%84AWS%E7%9B%B8%E9%97%9C%E8%B3%87%E8%A8%8A/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>  因為目前有使用到aws的服務，所以將相關的問題和資訊留下來，以免忘記。</p>
<span id="more"></span>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu@ip-172-30-20-5:~$ <span class="built_in">df</span> -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">udev            476M     0  476M   0% /dev</span><br><span class="line">tmpfs            98M  764K   98M   1% /run</span><br><span class="line">/dev/xvda1      7.7G  1.2G  6.6G  15% /</span><br><span class="line">tmpfs           490M     0  490M   0% /dev/shm</span><br><span class="line">tmpfs           5.0M     0  5.0M   0% /run/lock</span><br><span class="line">tmpfs           490M     0  490M   0% /sys/fs/cgroup</span><br><span class="line">/dev/loop0       33M   33M     0 100% /snap/snapd/11588</span><br><span class="line">/dev/loop1       56M   56M     0 100% /snap/core18/1997</span><br><span class="line">/dev/loop2       34M   34M     0 100% /snap/amazon-ssm-agent/3552</span><br><span class="line">tmpfs            98M     0   98M   0% /run/user/1000ba</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="設定ubuntu相關"><a href="#設定ubuntu相關" class="headerlink" title="設定ubuntu相關"></a>設定ubuntu相關</h1><p>以下是有關設定ubuntu的相關資訊</p>
<h2 id="設定vim"><a href="#設定vim" class="headerlink" title="設定vim"></a>設定vim</h2><p>建立 vim 設定檔 .vimrc</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cd ~</span><br><span class="line">$ vim .vimrc # 建立新的vim設定檔</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">set cursorline</span><br><span class="line">set tabstop=4</span><br><span class="line">set shiftwidth=4</span><br></pre></td></tr></table></figure>

<h2 id="增加openfiles"><a href="#增加openfiles" class="headerlink" title="增加openfiles"></a>增加openfiles</h2><p>查看當前打開檔案數</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lsof | wc -l</span><br></pre></td></tr></table></figure>

<p>Modify &#x2F;etc&#x2F;systemd&#x2F;user.conf and &#x2F;etc&#x2F;systemd&#x2F;system.conf with the following line (this takes care of graphical login):</p>
<p>兩個都要修改</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DefaultLimitNOFILE=65535</span><br></pre></td></tr></table></figure>

<p>Modify &#x2F;etc&#x2F;security&#x2F;limits.conf with the following lines (this takes care of non-GUI login):</p>
<p>加入兩行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">* hard nofile 65535</span><br><span class="line">* soft nofile 65535</span><br></pre></td></tr></table></figure>

<p>查看命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ulimit -a</span><br></pre></td></tr></table></figure>

<p>重新開機</p>
<h2 id="加入swap"><a href="#加入swap" class="headerlink" title="加入swap"></a>加入swap</h2><p>因為連入一個vscode，會造成CPU100%，所以來加大一下swap</p>
<p><a href="https://www.team-bob.org/linux-%E5%A6%82%E4%BD%95%E6%9B%B4%E6%94%B9-swapfile-%E5%A4%A7%E5%B0%8F/">參考資料</a></p>
<p>在開始之前，先下個 <code>free</code> 指定，檢查一下現在的 記憶體 和 SWAP 大小（使用 <code>-h</code> 自動轉換成容易閱讀的單位）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           978M        136M        511M        760K        330M        704M</span><br><span class="line">Swap:            0B          0B          0B</span><br></pre></td></tr></table></figure>

<p>接下來，先把 <code>swapfile</code> 關掉</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo swapoff /swap.img</span></span><br></pre></td></tr></table></figure>

<p>然後建立新的 <code>swapfile</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">rm</span> /swap.img                    <span class="comment"># 刪掉舊的</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo fallocate -l 2G /swap.img  <span class="comment"># 建立新的</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">ls</span> -lh /swap.img                <span class="comment"># 顯示資訊</span></span></span><br><span class="line">-rw-r--r-- 1 root root 1.0G Jun  9 16:06 /swap.img</span><br></pre></td></tr></table></figure>

<p>改權限</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">chmod</span> 600 /swap.img        <span class="comment"># 更改權限</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -lh /swap.img                <span class="comment"># 顯示資訊</span></span></span><br><span class="line">-rw------- 1 root root 1.0G Jun  9 16:06 /swap.img</span><br></pre></td></tr></table></figure>

<p>格式化</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo mkswap /swap.img</span><br></pre></td></tr></table></figure>

<p>啟用 <code>swap.img</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo swapon /swap.img</span><br></pre></td></tr></table></figure>

<p>檢查一下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cat /proc/swaps</span><br><span class="line">Filename        Type    Size    Used    Priority</span><br><span class="line">/swap.img       file    1048572 0       -2</span><br></pre></td></tr></table></figure>

<p>設定 <code>/etc/fstab</code>（如果本來沒有的話），請新增下面那一行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/swap.img none swap sw 0 0</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu@ip-172-30-20-5:~$ <span class="built_in">df</span> -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">udev            476M     0  476M   0% /dev</span><br><span class="line">tmpfs            98M  764K   98M   1% /run</span><br><span class="line">/dev/xvda1      7.7G  3.2G  4.6G  42% /</span><br><span class="line">tmpfs           490M     0  490M   0% /dev/shm</span><br><span class="line">tmpfs           5.0M     0  5.0M   0% /run/lock</span><br><span class="line">tmpfs           490M     0  490M   0% /sys/fs/cgroup</span><br><span class="line">/dev/loop0       56M   56M     0 100% /snap/core18/1997</span><br><span class="line">/dev/loop1       34M   34M     0 100% /snap/amazon-ssm-agent/3552</span><br><span class="line">/dev/loop2       33M   33M     0 100% /snap/snapd/11588</span><br><span class="line">tmpfs            98M     0   98M   0% /run/user/1000</span><br></pre></td></tr></table></figure>

<p>有安裝docker</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu@nvt-temp-ec2:~$ sudo <span class="built_in">df</span> -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">udev            476M     0  476M   0% /dev</span><br><span class="line">tmpfs            98M  780K   98M   1% /run</span><br><span class="line">/dev/xvda1      7.7G  4.1G  3.7G  53% /</span><br><span class="line">tmpfs           490M     0  490M   0% /dev/shm</span><br><span class="line">tmpfs           5.0M     0  5.0M   0% /run/lock</span><br><span class="line">tmpfs           490M     0  490M   0% /sys/fs/cgroup</span><br><span class="line">/dev/loop1       56M   56M     0 100% /snap/core18/1997</span><br><span class="line">/dev/loop0       34M   34M     0 100% /snap/amazon-ssm-agent/3552</span><br><span class="line">/dev/loop2       33M   33M     0 100% /snap/snapd/11588</span><br><span class="line">tmpfs            98M     0   98M   0% /run/user/1000</span><br></pre></td></tr></table></figure>



<h2 id="清理-systemd-的-journal-檔案"><a href="#清理-systemd-的-journal-檔案" class="headerlink" title="清理 systemd 的 journal 檔案"></a>清理 systemd 的 journal 檔案</h2><p>指令看目前使用的空間</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">du -d 0 -h /var/log/journal/</span><br></pre></td></tr></table></figure>

<p>固定節省一些磁碟空間，可以在<code>/etc/systemd/journald.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/systemd/journald.conf</span><br><span class="line"></span><br><span class="line">SystemMaxUse=100M</span><br><span class="line">SystemMaxFiles=21</span><br></pre></td></tr></table></figure>

<p>記得重啟 systemd-journald 服務</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl restart systemd-journald.service</span><br></pre></td></tr></table></figure>

<h2 id="logrotate-設定"><a href="#logrotate-設定" class="headerlink" title="logrotate 設定"></a>logrotate 設定</h2><p>Log rotate 設定檔在  <code>/etc/logrotate.d/</code></p>
<p>分割設定： 在&#x2F;etc&#x2F;logrotate.d&#x2F;目錄下生成該tool檔案<code>hslogrotate</code></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">sudo</span> vim /etc/logrotate.d/hslogrotate</span><br><span class="line"></span><br><span class="line">/tmp/<span class="regexp">*.log</span> &#123;     </span><br><span class="line">    <span class="attribute">daily</span>                   </span><br><span class="line">    dateext                 </span><br><span class="line">    dateformat -%Y-%m-%d    </span><br><span class="line">    missingok               </span><br><span class="line">    rotate <span class="number">15</span>              </span><br><span class="line">    compress               </span><br><span class="line">    notifempty              </span><br><span class="line">    copytruncate            </span><br><span class="line">    delaycompress          </span><br><span class="line">    su root root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>logrotate命令格式</p>
<p>logrotate [OPTION…] <configfile></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-d , --debug:debug模式，測試配置文件是否有錯誤</span><br><span class="line">-f , --force:強制轉儲文件</span><br><span class="line">-m , --mail=command：壓縮的日志後，發w奠日志到指定郵箱。</span><br><span class="line">-s , --state=statefile：使用指定的狀態文件。</span><br><span class="line">-v , --verbose：顯示轉儲過程</span><br></pre></td></tr></table></figure>

<p>要測試寫好的設定檔可以用以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo /usr/sbin/logrotate -d /etc/logrotate.d/hslogrotate</span><br></pre></td></tr></table></figure>

<p>要執行寫好的設定檔</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo /usr/sbin/logrotate -vf /etc/logrotate.d/hslogrotate</span><br></pre></td></tr></table></figure>

<p> log的寫法有兩種一種是清除檔案重新一個新檔</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">root python3.6 /usr/share/nginx/0_0/schedule/event_gop_to_mp4.py &gt;&gt; /tmp/cron_event_gop_to_mp4.<span class="built_in">log</span> 2&gt; /tmp/cron_event_gop_to_mp4.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>

<p> log的寫法有兩種一種是append檔案</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root python3.6 /usr/share/nginx/0_0/schedule/event_gop_to_mp4.py &gt;&gt; /tmp/cron_event_gop_to_mp4.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<h2 id="修改主機名稱"><a href="#修改主機名稱" class="headerlink" title="修改主機名稱"></a>修改主機名稱</h2><p>例如，把主機名稱修改成 ubuntu-bionic-x64：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo hostnamectl set-hostname nvt-temp-ec2</span><br></pre></td></tr></table></figure>

<p>時候終端機還看不出變化，我們可以用 <code>hostnamectl status</code> 檢查有沒有修改成功</p>
<p>修改完後沒有作用需要修改下面的檔案的值</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># sudo vim /etc/cloud/cloud.cfg</span><br></pre></td></tr></table></figure>

<p>在裏面修改<code>preserve_hostname: true</code></p>
<h2 id="Docker-容器設置日誌輪替"><a href="#Docker-容器設置日誌輪替" class="headerlink" title="Docker 容器設置日誌輪替"></a>Docker 容器設置日誌輪替</h2><h3 id="默認的日誌驅動程式"><a href="#默認的日誌驅動程式" class="headerlink" title="默認的日誌驅動程式"></a>默認的日誌驅動程式</h3><p>我們可以為容器配置不同的日誌記錄驅動程式，默認情況下容器的 <strong>stdout</strong> 和 <strong>stderr</strong> 會被寫入到 <em>&#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers&#x2F;[container-id]&#x2F;[container-id]-json.log</em> 的 json 文件。如果一直無人理會，這個文件最終會佔用大量的磁盤空間，如下圖所示：</p>
<p><img src="https://ttom921.github.io/%E8%A8%98%E9%8C%84Docker%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/docker-container-log-rotation-02.jpg" alt="img"></p>
<h3 id="手動清除日誌"><a href="#手動清除日誌" class="headerlink" title="手動清除日誌"></a>手動清除日誌</h3><p>若果這個 json 日誌文件佔用了大量的磁盤空間，我們可以使用下面的命令清除它。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">truncate -s 0 &lt;logfile&gt;</span><br></pre></td></tr></table></figure>

<p>或者我們可以考慮設置一個 cronjob 來定期清除這些 json 日誌文件，但從長遠來看，最好還是設置日誌輪替。</p>
<h3 id="配置默認的日誌驅動程式"><a href="#配置默認的日誌驅動程式" class="headerlink" title="配置默認的日誌驅動程式"></a>配置默認的日誌驅動程式</h3><p>默認的日誌驅動程式可以通過在 <em>&#x2F;etc&#x2F;docker&#x2F;daemon.json</em> 中定義。如果該文件不存在，可以建立該文件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;10m&quot;,</span><br><span class="line">    &quot;max-file&quot;: &quot;10&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以 <em>json-file</em> 作日誌記錄驅動程式還有幾個其它選項，我們甚至可以更改為其他日誌記錄驅動程式，如 <em>syslog</em> 。有關更多信息，請參閱 <a href="https://docs.docker.com/config/containers/logging/configure/">Docker Docs - Configure logging drivers</a>。</p>
<p>執行以下命令來重新加載更新後的 <em>daemon.js</em> 。新的配置將在重新啟動後適用於所有新建立的容器。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="為個別容器配置日誌驅動程式"><a href="#為個別容器配置日誌驅動程式" class="headerlink" title="為個別容器配置日誌驅動程式"></a>為個別容器配置日誌驅動程式</h3><p>如果您不想作全局配置，也可以在個別容器級作日誌驅動程式改動。</p>
<h1 id="建立空的檔案"><a href="#建立空的檔案" class="headerlink" title="建立空的檔案"></a>建立空的檔案</h1><p>這是為了有時空間不足時，可以先來佔一塊檔案到時可以來刪除救系統</p>
<p><a href="https://www.peterdavehello.org/2016/01/create-empty-or-large-file-on-linux/">參考資料</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dd if=/dev/zero of=./dd_100M bs=1M count=100</span><br></pre></td></tr></table></figure>

<h1 id="空間不足"><a href="#空間不足" class="headerlink" title="空間不足"></a>空間不足</h1><p><a href="https://www.concerto.one/posts/2021-01-07-Autoremove-Disk-Space-Usage.html#%E6%AA%A2%E6%9F%A5%E4%BD%94%E8%B5%B0%E7%A3%81%E5%8D%80%E7%A9%BA%E9%96%93%E7%9A%84%E6%AA%94%E6%A1%88">參考資料</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 一般來說，使用 apt 內建的清理功能即可。autoclean 是清除快取。</span><br><span class="line">sudo apt autoclean</span><br><span class="line"></span><br><span class="line"># autoremove 則會連不需要的套件也自動移除掉。</span><br><span class="line">sudo apt autoremove</span><br><span class="line"></span><br><span class="line"># 如果還有一些檔案存於其中，像是 linux-aws-headers-x.xx.x-xxxx 這一類的，可以透過 purge 參數來手動刪除。</span><br><span class="line">sudo apt purge linux-aws-headers-4.15.0-1051</span><br></pre></td></tr></table></figure>



<h1 id="設定定義private-IP"><a href="#設定定義private-IP" class="headerlink" title="設定定義private IP"></a>設定定義private IP</h1><p>因為自已有規劃好的pirvate IP，自已的subnet要先切好，就可以指定自已的private IP如下圖所示在Step3</p>
<img src="Snipaste_2021-05-04_12-03-54.png" style="zoom:80%;" />



<h1 id="AWS的Instance不可終止的設定"><a href="#AWS的Instance不可終止的設定" class="headerlink" title="AWS的Instance不可終止的設定"></a>AWS的Instance不可終止的設定</h1><p>可以看到下圖的圖片在aws的停止instance(個體)有下面的選項，不要選<code>終止執行個體</code>，那會將你的服務器刪除並且不能還原你的服務器的資料也消失</p>
<img src="Snipaste_2021-03-05_10-27-27.png" style="zoom:50%;" />

<p>所以為了防止不小心來執行這個指令，所以需要設定來防止發生，如下圖所示先選擇要改的服務器，在選擇<code>動作</code> –<code>執行個體設定</code> – <code>變更終止保護</code></p>
<img src="Snipaste_2021-03-05_11-49-18.png" style="zoom:50%;" />

<p>接下來如下圖來處理</p>
<img src="Snipaste_2021-03-05_11-49-40.png" style="zoom:67%;" />



<h1 id="註冊"><a href="#註冊" class="headerlink" title="註冊"></a>註冊</h1><p>  在aws上的註冊，他是綁定信用卡的，所以要小心以免被扣錢。有一點要小心，就是在註冊時的電記，如果你是幫客戶註冊時，先留自已的手機，在驗證碼時，也是一樣的手機，不然會收不到簡訊驗證碼或是一些問題，此時只能使用aws的人工驗證，時效性會慢很多。在完成驗證碼和建立完服務後，可將電話修改回客戶的。</p>
<h1 id="建立一台服務器"><a href="#建立一台服務器" class="headerlink" title="建立一台服務器"></a>建立一台服務器</h1><p>在服務中，選擇EC2建立一台EC2如下圖所示</p>
<img src="2020-08-13_11_06_34_Image.png" style="zoom:80%;" />

<p>選完後，接下來選擇<code>啟動執行個體</code>來啟動一個服務器如下圖所示</p>
<img src="2020-08-13_11_09_34_Image.png" style="zoom:67%;" />

<p>接下來選擇os的映像檔，如下圖所示</p>
<img src="2020-08-13_11_15_29_Image.png" style="zoom:67%;" />

<p>只能選擇免費</p>
<img src="2020-08-13_11_20_16_Image.png" style="zoom:67%;" />

<p>接來是很重要的一步，因為它關係著EC2啟動後，你能不能連進去的問題；這一頁的設定是屬於防火牆之類的設定，它可以控制那些IP、Port可以進出，所以我們先在這邊設定My IP（參考上圖紅框）可以連入，這樣我們才能在EC2啟動後連入進行操控。</p>
<p>在 EC2 中對於不同的實例可以搭配不同的安全設定<br>在這邊預設有用來連線到主機的 SSH 22 Port<br>如果要架設網站則會需要用到 HTTP 80 Port</p>
<img src="2020-08-13_11_39_23_Image.jpg" style="zoom:80%;" />

<p>在新增實例的步驟中，可以選擇「Create a <strong>new</strong> security group」<br>由「Add Rule」來新增所需要用到的 Port<br>或是也可以在完成新增實例後，到管理控制台編輯 Security Group<br>例如事後發現需要使用 Gmail 寄信的功能<br>就必須再新增一個 SMTPS 465 Port，Source 選 Anywhere</p>
<h2 id="Key-Pair-連線密鑰"><a href="#Key-Pair-連線密鑰" class="headerlink" title="Key Pair 連線密鑰"></a>Key Pair 連線密鑰</h2><p>Amazon EC2 主機必須要用特製的 Key Pair 來登入<br>上個步驟按下「Launch」後，如果是第一次新增實例<br>則會跳出 Create a new key pair 的視窗<br>此時為 key pair 取一個簡單的名字<br>按下「Download Key Pair」後則會自動下載一個 <code>.pem</code> 檔</p>
<img src="aAhZr06cTX6JJBjusquT_8. Key Pair.png" style="zoom:80%;" />

<h2 id="Launching-正式啟動"><a href="#Launching-正式啟動" class="headerlink" title="Launching 正式啟動"></a>Launching 正式啟動</h2><p>到這邊就完成新增實例的設定精靈<br>不過還必須替虛擬機器指定一個位址</p>
<img src="2020-08-13_11_45_26_Image.jpg" style="zoom:80%;" />

<h2 id="登入建立好的服務器"><a href="#登入建立好的服務器" class="headerlink" title="登入建立好的服務器"></a>登入建立好的服務器</h2><p>查看服務器的列表從<code>服務-&gt;EC2</code>來找到需要的服務器，他會顯示IP和DNS，如下圖所示</p>
<img src="2020-08-13_12_19_29_Image.jpg" style="zoom:80%;" />

<p>在登入我是使用<code>MobaXterm_Personal</code>來登入，只要將pem檔加入就可以登入，帳號是<code>ubuntu</code>，如下圖所示</p>
<img src="2020-08-13_12_14_40_Image.jpg" style="zoom:80%;" />

<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><p><a href="https://akuma1.pixnet.net/blog/post/291725322-%EF%BC%88%E4%BA%8C%EF%BC%89ec2%EF%BC%88elastic-compute-cloud%EF%BC%89%EF%BC%8D%EF%BC%8Daws%E7%B6%93%E9%A9%97%E6%95%99%E5%AD%B8">https://akuma1.pixnet.net/blog/post/291725322-%ef%bc%88%e4%ba%8c%ef%bc%89ec2%ef%bc%88elastic-compute-cloud%ef%bc%89%ef%bc%8d%ef%bc%8daws%e7%b6%93%e9%a9%97%e6%95%99%e5%ad%b8</a></p>
<p><a href="https://diary.taskinghouse.com/posts/310691-ssh-connection-amazon-ec2/">https://diary.taskinghouse.com/posts/310691-ssh-connection-amazon-ec2/</a></p>
<h1 id="IAM"><a href="#IAM" class="headerlink" title="IAM"></a>IAM</h1><p>因為本來是使用root的權限來登入，一直到有一台客戶修改了密碼，所以登不進去以為被駭客入侵，所以決定來研究一下AWS的I AM的權限控制。先來選擇功能</p>
<img src="2020-10-07_10_00_41_Image.jpg" style="zoom: 67%;" />

<p>會進入IAM的頁面，可以來編輯之登入的網址，不然預設是一串數字按下”編輯“，可以設定別名</p>
<img src="2020-10-07_10_07_13_Image.jpg" style="zoom:67%;" />

<p>先來建立群組</p>
<img src="2020-10-07_11_45_01_Image.jpg" style="zoom:80%;" />

<p>建立管理者</p>
<p>選擇建立管理者</p>
<img src="2020-10-07_11_51_25_Image.jpg" style="zoom:80%;" />

<p>輸入相關資訊</p>
<img src="2020-10-07_11_53_51_Image.jpg" style="zoom:80%;" />

<p>加入上面建立的群組,之後檢視</p>
<img src="2020-10-07_11_57_54_Image.jpg" style="zoom: 67%;" />

<h1 id="使用同一個image"><a href="#使用同一個image" class="headerlink" title="使用同一個image"></a>使用同一個image</h1><p>因為服務器在建一是差不的，加上有一些已建立好的設定檔，所以需要在原來建立好的image檔上來安裝，所以來記錄一下不用每次都重新來安裝元件</p>
<p>前提是有一個已經安裝好的的服務器</p>
<p>先來建立image檔如下圖</p>
<img src="Snipaste_2021-04-29_17-22-08.png" style="zoom:50%;" />

<p>輸入image的記錄如下圖</p>
<img src="Snipaste_2021-04-29_17-28-00.png" style="zoom:67%;" />

<p>接下來建立新的EC2如下圖</p>
<img src="Snipaste_2021-04-29_17-31-59.png" style="zoom:67%;" />

<h1 id="增加EBS"><a href="#增加EBS" class="headerlink" title="增加EBS"></a>增加EBS</h1><p>在aws可以追加容量</p>
<p><a href="https://docs.aws.amazon.com/zh_tw/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html">https://docs.aws.amazon.com/zh_tw/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html</a></p>
<img src="Snipaste_2021-05-07_10-40-15.png" style="zoom:67%;" />

<p>在連線到機器上<br>若要驗證每個磁碟區的檔案系統，請使用 df -hT 命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">df -hT</span><br></pre></td></tr></table></figure>

<p>檢查磁碟區是否有必須擴展的分割區<br>請使用 lsblk 命令來顯示連接到執行個體區塊型儲存設備的相關資訊。</p>
<p>若要擴展根磁碟區上的分割區，請使用下列 growpart 命令。請注意，裝置名稱與分割區號碼之間有一個空格</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo growpart /dev/xvda 1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因為是ext4 檔案系統</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo resize2fs /dev/xvda1</span><br></pre></td></tr></table></figure>

<h1 id="掛載S3"><a href="#掛載S3" class="headerlink" title="掛載S3"></a>掛載S3</h1><p>如何掛載AWS S3 到AWS EC2 </p>
<ul>
<li>在IAM操作</li>
<li>建立一個使用者如nvts3</li>
<li>建立一個使用者群組s3group可以AmazonS3FullAccess</li>
<li>在S3操作</li>
<li>建立一個nvts3儲存貯體</li>
<li>建立policy</li>
<li>到ec2操作</li>
</ul>
<h2 id="先設定AWS的S3"><a href="#先設定AWS的S3" class="headerlink" title="先設定AWS的S3"></a>先設定AWS的S3</h2><h2 id="在IAM操作如下圖所示"><a href="#在IAM操作如下圖所示" class="headerlink" title="在IAM操作如下圖所示"></a>在IAM操作如下圖所示</h2><img src="Snipaste_2021-07-05_13-58-58.png" style="zoom:50%;" />

<p>建立一個group</p>
<img src="Snipaste_2021-07-05_14-17-06.png" style="zoom:50%;" />

<p>如下的設定加入一個群組名和可以儲取s3</p>
<img src="Snipaste_2021-07-05_14-20-00.png" style="zoom:80%;" />



<p>建立一個使用者和加上面設定的群組</p>
<img src="Snipaste_2021-07-05_14-02-18.png" style="zoom:50%;" />

<p>如下的步驟</p>
<img src="Snipaste_2021-07-05_14-08-20.png" style="zoom:80%;" />









<p>在S3上來操作如下圖所示</p>
<img src="Snipaste_2021-07-05_13-52-21.png" style="zoom:50%;" />

<p>建立一個bucket</p>
<img src="Snipaste_2021-07-05_14-25-25.png" style="zoom:50%;" />

<p>如下</p>
<p><img src="/Snipaste_2021-07-05_14-28-43.png"></p>
<p>編輯policy來儲取設定的s3</p>
<img src="Snipaste_2021-07-05_14-30-54.png" style="zoom:80%;" />

<p>policy如下可以產生</p>
<img src="Snipaste_2021-07-05_14-39-52.png" style="zoom:80%;" />

<p>修改一下json的Principal</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">    &quot;Id&quot;: &quot;Policy1625467201758&quot;,</span><br><span class="line">    &quot;Statement&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Sid&quot;: &quot;Stmt1625467197511&quot;,</span><br><span class="line">            &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">            &quot;Principal&quot;: &#123;</span><br><span class="line">                &quot;AWS&quot;: &quot;arn:aws:iam::1111999999:user/userer&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Action&quot;: &quot;s3:*&quot;,</span><br><span class="line">            &quot;Resource&quot;: &quot;arn:aws:s3:::nvts3temp&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ec2的操作"><a href="#ec2的操作" class="headerlink" title="ec2的操作"></a>ec2的操作</h2><p>在需要連接的ec2需要作此套件</p>
<p>先安裝需要用到的組件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install automake autotools-dev g++ git libcurl4-gnutls-dev libfuse-dev libssl-dev libxml2-dev make pkg-config</span><br></pre></td></tr></table></figure>

<p>正式安裝 s3fs</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/s3fs-fuse/s3fs-fuse.git</span><br><span class="line">cd s3fs-fuse</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>必須修改 &#x2F;etc&#x2F;fuse.conf，<strong>移除 user_allow_other 前面的 # 註解</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo AK----------Z:6/E30ph324j19jvuB-------cEIla8cMeqt &gt; ~/.passwd-s3fs</span><br><span class="line">chmod 600 ~/.passwd-s3fs</span><br><span class="line">chown -R ubuntu:root ~/.passwd-s3fs</span><br></pre></td></tr></table></figure>

<p>掛載</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir s3mnt</span><br><span class="line">#將 bucket 掛載到指定的資料夾</span><br><span class="line">s3fs nvts3temp /home/ubuntu/s3mnt/ -o allow_other -o passwd_file=~/.passwd-s3fs</span><br></pre></td></tr></table></figure>

<p>缷載</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">umount -l /home/ubuntu/s3mnt</span><br></pre></td></tr></table></figure>

<p>自動掛載</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/fstab</span><br><span class="line">nvts3temp /home/ubuntu/s3mnt fuse.s3fs _netdev,passwd_file=/home/ubuntu/.passwd-s3fs,allow_other 0 0</span><br></pre></td></tr></table></figure>



<h3 id="參考資料-1"><a href="#參考資料-1" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://coderwall.com/p/c8ssvg/aws-s3-aws-ec2-instance">如何掛載 AWS S3 到 AWS EC2 Instance - 掛載及卸載部份</a></p>
<p><a href="https://aws.amazon.com/cn/blogs/china/s3fs-amazon-ec2-linux/">利用S3fs在Amazon EC2 Linux实例上挂载S3存储桶</a></p>
<p><a href="https://ciao-chung.com/page-article/s3fs">透過s3fs將s3 bucket掛載到linux系統</a></p>
<h1 id="Router-53"><a href="#Router-53" class="headerlink" title="Router 53"></a>Router 53</h1><p>在註冊完網域後，可以來註冊一下來連接網域和IP</p>
<p>如下來選擇</p>
<img src="Snipaste_2021-07-12_16-14-26.png" style="zoom:80%;" />

<p>選擇要處理的Domain name，進入</p>
<img src="Snipaste_2021-07-12_16-22-00.png" style="zoom:67%;" />

<p>會顯示下面的畫面</p>
<img src="Snipaste_2021-07-12_16-24-37.png" style="zoom:80%;" />

<p>可以選擇<code>Create record</code>來加入A和IP</p>
]]></content>
      <categories>
        <category>記錄</category>
        <category>AWS</category>
      </categories>
      <tags>
        <tag>aws</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄Docker的相關使用</title>
    <url>/%E8%A8%98%E9%8C%84Docker%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>因為之後的專案有可能會用到，所以來記錄一下，新的Docker的使用</p>
<span id="more"></span>

<h1 id="Docker安裝"><a href="#Docker安裝" class="headerlink" title="Docker安裝"></a>Docker安裝</h1><p>先移除上一版的Docker</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br></pre></td></tr></table></figure>

<p>使用repository來安裝</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br></pre></td></tr></table></figure>

<p>Add Docker’s official GPG key:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br></pre></td></tr></table></figure>

<p>設定stable版的庫</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br></pre></td></tr></table></figure>

<p>安裝Docker引擎</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<p>列出Docker版本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt-cache madison docker-ce</span><br></pre></td></tr></table></figure>

<p>將第四列的字串代入ex<code>5:18.09.1~3-0~ubuntu-xenial</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install docker-ce=&lt;VERSION_STRING&gt; docker-ce-cli=&lt;VERSION_STRING&gt; containerd.io</span><br><span class="line">sudo apt-get install docker-ce=5:19.03.15~3-0~ubuntu-bionic docker-ce-cli=5:19.03.15~3-0~ubuntu-bionic containerd.io</span><br><span class="line">sudo apt-get install docker-ce=5:20.10.8~3-0~ubuntu-bionic docker-ce-cli=5:20.10.8~3-0~ubuntu-bionic containerd.io</span><br></pre></td></tr></table></figure>

<p>測試是否正常</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker run hello-world</span><br></pre></td></tr></table></figure>

<p>移除docker engine</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get purge docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<p>移除docker相關的資料</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/docker</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/containerd</span><br></pre></td></tr></table></figure>



<h2 id="設定開機啟動"><a href="#設定開機啟動" class="headerlink" title="設定開機啟動"></a>設定開機啟動</h2><p>開始和關畢的指令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line">sudo systemctl start docker</span><br><span class="line">sudo systemctl stop docker</span><br></pre></td></tr></table></figure>

<h2 id="docker的設定"><a href="#docker的設定" class="headerlink" title="docker的設定"></a>docker的設定</h2><p>設定檔的位置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

<p>設定的資料</p>
<p> bip:設定docker的ip</p>
<p> data-root:docker的使用資料</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo mkdir -p /data/docker</span><br></pre></td></tr></table></figure>

<p>live-restore:容器掛了，是否執行</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">    <span class="attr">&quot;bip&quot;</span><span class="punctuation">:</span><span class="string">&quot;172.17.0.1/24&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data-root&quot;</span><span class="punctuation">:</span><span class="string">&quot;/data/docker&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;live-restore&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>相關的指令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker run hello-world</span><br><span class="line">sudo docker info</span><br></pre></td></tr></table></figure>

<p>查詢,pull, 列出 docker image</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker search alpine</span><br><span class="line">sudo docker pull alpine</span><br><span class="line">sudo docker pull alpine:3.10.3</span><br><span class="line">sudo docker images</span><br><span class="line">sudo docker image ls</span><br></pre></td></tr></table></figure>

<p>將image id 打上自已的標籤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu@nvt-nginx-1:~$ sudo docker image <span class="built_in">ls</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hello-world         latest              d1165f221234        2 months ago        13.3kB</span><br><span class="line">alpine              3.10.3              965ea09ff2eb        18 months ago       5.55MB</span><br></pre></td></tr></table></figure>

<p>打上tag sudo docker tag imageid name:version</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker tag 965ea09ff2eb myaline:v3.10.3</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu@nvt-nginx-1:~$ sudo docker image <span class="built_in">ls</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hello-world         latest              d1165f221234        2 months ago        13.3kB</span><br><span class="line">alpine              3.10.3              965ea09ff2eb        18 months ago       5.55MB</span><br><span class="line">myaline             v3.10.3             965ea09ff2eb        18 months ago       5.55MB</span><br></pre></td></tr></table></figure>

<h2 id="Docker-容器設置日誌輪替"><a href="#Docker-容器設置日誌輪替" class="headerlink" title="Docker 容器設置日誌輪替"></a>Docker 容器設置日誌輪替</h2><h3 id="默認的日誌驅動程式"><a href="#默認的日誌驅動程式" class="headerlink" title="默認的日誌驅動程式"></a>默認的日誌驅動程式</h3><p>我們可以為容器配置不同的日誌記錄驅動程式，默認情況下容器的 <strong>stdout</strong> 和 <strong>stderr</strong> 會被寫入到 <em>&#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers&#x2F;[container-id]&#x2F;[container-id]-json.log</em> 的 json 文件。如果一直無人理會，這個文件最終會佔用大量的磁盤空間，如下圖所示：</p>
<img src="docker-container-log-rotation-02.jpg" style="zoom:80%;" />

<h3 id="手動清除日誌"><a href="#手動清除日誌" class="headerlink" title="手動清除日誌"></a>手動清除日誌</h3><p>若果這個 json 日誌文件佔用了大量的磁盤空間，我們可以使用下面的命令清除它。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">truncate -s 0 &lt;logfile&gt;</span><br></pre></td></tr></table></figure>

<p>或者我們可以考慮設置一個 cronjob 來定期清除這些 json 日誌文件，但從長遠來看，最好還是設置日誌輪替。</p>
<h3 id="配置默認的日誌驅動程式"><a href="#配置默認的日誌驅動程式" class="headerlink" title="配置默認的日誌驅動程式"></a>配置默認的日誌驅動程式</h3><p>默認的日誌驅動程式可以通過在 <em>&#x2F;etc&#x2F;docker&#x2F;daemon.json</em> 中定義。如果該文件不存在，可以建立該文件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>



<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;log-driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;json-file&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;max-size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10m&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max-file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>以 <em>json-file</em> 作日誌記錄驅動程式還有幾個其它選項，我們甚至可以更改為其他日誌記錄驅動程式，如 <em>syslog</em> 。有關更多信息，請參閱 <a href="https://docs.docker.com/config/containers/logging/configure/">Docker Docs - Configure logging drivers</a>。</p>
<p>執行以下命令來重新加載更新後的 <em>daemon.js</em> 。新的配置將在重新啟動後適用於所有新建立的容器。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="為個別容器配置日誌驅動程式"><a href="#為個別容器配置日誌驅動程式" class="headerlink" title="為個別容器配置日誌驅動程式"></a>為個別容器配置日誌驅動程式</h3><p>如果您不想作全局配置，也可以在個別容器級作日誌驅動程式改動。</p>
<h3 id="使用-docker-run-命令"><a href="#使用-docker-run-命令" class="headerlink" title="使用 docker run 命令"></a>使用 docker run 命令</h3><p>我們可以在 <em>docker run</em> 命令中指定日誌記錄驅動程式與其選項。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run \</span><br><span class="line">    --log-driver json-file \</span><br><span class="line">    --log-opt max-size=10m \</span><br><span class="line">    --log-opt max-file=10 \</span><br><span class="line">    alpine echo hello world</span><br></pre></td></tr></table></figure>



<h3 id="使用-docker-compose"><a href="#使用-docker-compose" class="headerlink" title="使用 docker-compose"></a>使用 docker-compose</h3><p>日誌記錄驅動程式與其選項也可以使用 <em>docker-compose</em> 進行配置。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">version: &#x27;3.2&#x27;</span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    image: &#x27;nginx:latest&#x27;</span><br><span class="line">    ports:</span><br><span class="line">      - &#x27;80:80&#x27;</span><br><span class="line">    logging:</span><br><span class="line">      driver: &quot;json-file&quot;</span><br><span class="line">      options:</span><br><span class="line">        max-size: &quot;1k&quot;</span><br><span class="line">        max-file: &quot;3&quot;</span><br></pre></td></tr></table></figure>

<p>來看看配置是否成功。</p>
<p><a href="https://blog.boatswain.io/zh/post/docker-container-log-rotation/">為 Docker 容器設置日誌輪替</a></p>
<h2 id="建立nginx-v1-19-10-with-stream的Dockerfile"><a href="#建立nginx-v1-19-10-with-stream的Dockerfile" class="headerlink" title="建立nginx:v1.19.10_with_stream的Dockerfile"></a>建立nginx:v1.19.10_with_stream的Dockerfile</h2><p>來建立nginx版加上stream的功能</p>
<p>參別人的dockfile </p>
<ul>
<li><a href="https://github.com/tekn0ir/nginx-stream/blob/master/Dockerfile">nginx-stream</a></li>
<li><a href="https://github.com/tiangolo/nginx-rtmp-docker/blob/master/Dockerfile">ngix-rtmp</a></li>
</ul>
<p>參考資料</p>
<p><a href="https://www.alibabacloud.com/blog/how-to-use-nginx-as-an-https-forward-proxy-server_595799">https://www.alibabacloud.com/blog/how-to-use-nginx-as-an-https-forward-proxy-server_595799</a></p>
<p><a href="https://www.nginx.com/blog/tcp-load-balancing-udp-load-balancing-nginx-tips-tricks/">https://www.nginx.com/blog/tcp-load-balancing-udp-load-balancing-nginx-tips-tricks/</a></p>
<p>建立資料夾</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> dockerfile</span><br><span class="line"><span class="built_in">cd</span> dockerfile/</span><br><span class="line">vim Dockerfile</span><br></pre></td></tr></table></figure>

<p>Dockerfile的內容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">FROM debian:stretch</span><br><span class="line"></span><br><span class="line">LABEL mantainer =&quot;ttom &lt;ttom921@hotmail.com&gt;&quot;</span><br><span class="line"></span><br><span class="line"># Version of Nginx to use</span><br><span class="line">ENV NGINX_VERSION nginx-1.12.2</span><br><span class="line"></span><br><span class="line"># Install dependencies</span><br><span class="line">RUN apt-get update &amp;&amp;  \</span><br><span class="line"> 	apt-get install -y wget libpcre3-dev build-essential libssl-dev zlib1g-dev ca-certificates openssl  &amp;&amp; \</span><br><span class="line">    rm -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line"># Download and decompress Nginx</span><br><span class="line">RUN mkdir -p /tmp/build/nginx &amp;&amp; \</span><br><span class="line">	cd /tmp/build/nginx &amp;&amp; \</span><br><span class="line">    wget -O $&#123;NGINX_VERSION&#125;.tar.gz https://nginx.org/download/$&#123;NGINX_VERSION&#125;.tar.gz &amp;&amp; \</span><br><span class="line">	tar -zxf $&#123;NGINX_VERSION&#125;.tar.gz</span><br><span class="line"></span><br><span class="line"># Build and instll Nginx</span><br><span class="line"># The default puts everything under /usr/local/nginx,so it&#x27;s neede to change</span><br><span class="line"># it explicitly. Not jst for order but to have it in the PATH</span><br><span class="line">RUN cd /tmp/build/nginx/$&#123;NGINX_VERSION&#125; &amp;&amp; \</span><br><span class="line">    ./configure \</span><br><span class="line">        --sbin-path=/usr/local/sbin/nginx \</span><br><span class="line">        --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">        --error-log-path=/var/log/nginx/error.log \</span><br><span class="line">        --pid-path=/var/run/nginx/nginx.pid \</span><br><span class="line">        --lock-path=/var/lock/nginx/nginx.lock \</span><br><span class="line">        --http-log-path=/var/log/nginx/access.log \</span><br><span class="line">        --http-client-body-temp-path=/tmp/nginx-client-body \</span><br><span class="line">        --with-http_ssl_module \</span><br><span class="line">        --with-threads \</span><br><span class="line">        --with-ipv6 \</span><br><span class="line">		--with-stream \</span><br><span class="line">		--with-stream_ssl_module &amp;&amp; \</span><br><span class="line">	make -j $(getconf _NPROCESSORS_ONLN) &amp;&amp; \</span><br><span class="line">    make install &amp;&amp; \</span><br><span class="line">    mkdir /var/lock/nginx &amp;&amp; \</span><br><span class="line">    rm -rf /tmp/build</span><br><span class="line"></span><br><span class="line"># Forward logs to Docker</span><br><span class="line">RUN ln -sf /dev/stdout /var/log/nginx/access.log &amp;&amp; \</span><br><span class="line">    ln -sf /dev/stderr /var/log/nginx/error.log</span><br><span class="line"></span><br><span class="line"># Set up config file</span><br><span class="line">COPY nginx.conf /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">EXPOSE 80 443</span><br><span class="line">CMD [&quot;nginx&quot;,&quot;-g&quot;,&quot;daemon off;&quot;]</span><br></pre></td></tr></table></figure>

<p>建立docker image</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker build  . -t mynginx:1.12.2_with_stream</span><br><span class="line">sudo docker run --<span class="built_in">rm</span> -it --name ngix00 -p 80:80 mynginx:1.12.2_with_stream</span><br></pre></td></tr></table></figure>

<p>有修改Dockerfile成1.19.10</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker build  .  -t nginx:v1.19.10_with_stream</span><br><span class="line">sudo docker run --<span class="built_in">rm</span> -it --name ngix00 -p 80:80 nginx:v1.19.10_with_stream</span><br><span class="line"></span><br><span class="line">sudo docker <span class="built_in">exec</span> -it 4e655a93330f /bin/bash</span><br></pre></td></tr></table></figure>

<p>執行的設定檔的連結</p>
<p>將原來的設定檔拷貝出來</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker cp &lt;containerId&gt;:/file/path/within/container /host/path/target</span><br></pre></td></tr></table></figure>
<p>設定檔</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker cp a5bc56424878:/etc/nginx /etc/nginx</span><br></pre></td></tr></table></figure>

<p>html檔</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /usr/local/</span><br><span class="line">sudo mkdir nginx</span><br><span class="line">cd ~</span><br><span class="line">sudo docker cp a5bc56424878:/usr/local/nginx /usr/local/nginx</span><br></pre></td></tr></table></figure>

<p>起動連接host的資料</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker run --rm -it --name nginx00 -p 80:80 -v /etc/nginx:/etc/nginx -v /usr/local/nginhtml:/usr/local/nginx/html nginx:v1.19.10_with_stream</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker run --rm -it --name nginx00 -p 80:80 -v /etc/nginx:/etc/nginx -v /usr/local/nginhtml:/usr/local/nginx/html ttom921/nginx:v1.19.10_with_stream</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker run --rm -it --name nginx00 -p 80:80 -p 7000:7000 -v /etc/nginx:/etc/nginx -v /usr/local/nginx/html:/usr/local/nginx/html ttom921/nginx:v1.19.10_with_stream</span><br></pre></td></tr></table></figure>

<h2 id="建立uwsgi-nginx-docker的Dockerfile"><a href="#建立uwsgi-nginx-docker的Dockerfile" class="headerlink" title="建立uwsgi-nginx-docker的Dockerfile"></a>建立uwsgi-nginx-docker的Dockerfile</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir mkdockerfile</span><br><span class="line">cd mkdockerfile</span><br></pre></td></tr></table></figure>

<p>Dockerfile的內容</p>
<p><a href="https://github.com/tiangolo/uwsgi-nginx-docker/blob/master/docker-images/python3.6.dockerfile">參考</a></p>
<p><a href="https://stackoverflow.com/questions/17466699/not-able-to-build-a-specific-dockerfile">https://stackoverflow.com/questions/17466699/not-able-to-build-a-specific-dockerfile</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/ttom921/uwsgi-nginx-docker.git</span><br><span class="line">cd uwsgi-nginx-docker/</span><br><span class="line">cd docker-images/</span><br><span class="line">sudo service docker restart</span><br><span class="line">sudo docker image build  -f python3.6.dockerfile . -t ttom/uwsgi-nginx:python3.6</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker image build  . -t ttom/ubuntu18:python3.6.9</span><br><span class="line">sudo docker image build  -f python3.6.9.dockerfile . -t ttom/uwsgi-nginx:python3.6</span><br><span class="line">sudo docker build -f Dockerfile -t hisharp_webfms:python3.6 . </span><br><span class="line"></span><br><span class="line">sudo docker build -f Dockerfile -t ttom/nginx_uwsgi_py3:alpine3.9 . </span><br><span class="line">sudo docker build -f Dockerfile -t webapp .</span><br><span class="line">sudo docker run -p 9999:6666 webapp</span><br></pre></td></tr></table></figure>





<p>測試</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker run --rm -it --name uwngix00 -p 80:80 ttom/uwsgi-nginx:python3.6</span><br><span class="line"></span><br><span class="line">curl http://10.4.7.131</span><br><span class="line">Hello World from a default Nginx uWSGI Python 3.6 app in a Docker container (default)</span><br></pre></td></tr></table></figure>

<h2 id="uwsgi-nginx-python3-7測試"><a href="#uwsgi-nginx-python3-7測試" class="headerlink" title="uwsgi-nginx:python3.7測試"></a>uwsgi-nginx:python3.7測試</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker image build  -f python3.8-alpine.dockerfile . -t ttom/uwsgi-nginx:python3.8-alpine</span><br><span class="line">sudo docker build -f Dockerfile -t hisharp_webfms:python3.8 .</span><br></pre></td></tr></table></figure>





<h2 id="alpine相關"><a href="#alpine相關" class="headerlink" title="alpine相關"></a>alpine相關</h2><p><a href="http://5.9.10.113/56021952/gevent-uwsgi-plugin-not-loading-in-alpine-docker">http://5.9.10.113/56021952/gevent-uwsgi-plugin-not-loading-in-alpine-docker</a></p>
<p><a href="https://github.com/moshangguang/docker-nginx-uwsgi-flask-py3">https://github.com/moshangguang/docker-nginx-uwsgi-flask-py3</a></p>
<p><a href="https://www.itread01.com/content/1546680669.html">https://www.itread01.com/content/1546680669.html</a></p>
<p><a href="https://stackoverflow.com/questions/57787424/django-docker-python-unable-to-install-pillow-on-python-alpine">https://stackoverflow.com/questions/57787424/django-docker-python-unable-to-install-pillow-on-python-alpine</a></p>
<p><a href="https://stackoverflow.com/questions/56021952/gevent-uwsgi-plugin-not-loading-in-alpine-docker">https://stackoverflow.com/questions/56021952/gevent-uwsgi-plugin-not-loading-in-alpine-docker</a></p>
<h2 id="uwsgi-gevent-buster相關"><a href="#uwsgi-gevent-buster相關" class="headerlink" title="uwsgi-gevent-buster相關"></a>uwsgi-gevent-buster相關</h2><p><a href="https://medium.com/into-the-night/flask-app-with-boto3-uwsgi-and-gevent-in-docker-i-uwsgi-and-gevent-on-python3-7-alpine-image-f0d9c9ac1f5c">https://medium.com/into-the-night/flask-app-with-boto3-uwsgi-and-gevent-in-docker-i-uwsgi-and-gevent-on-python3-7-alpine-image-f0d9c9ac1f5c</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 移除所有未使用的 Docker 項目</span></span><br><span class="line">$ sudo docker system prune</span><br><span class="line"><span class="comment"># 重新編譯時需要加上--no-cache</span></span><br><span class="line">sudo docker build -t gavin/python:latest . --no-cache</span><br><span class="line"><span class="comment"># ------------------------------------------------------------------------------------------------------</span></span><br><span class="line">sudo docker build --tag uwsgi-gevent:buster .</span><br><span class="line">curl http://10.4.7.131/long-polling</span><br><span class="line">siege -c100 -t60  -v http://10.4.7.131/long-polling</span><br><span class="line"></span><br><span class="line">sudo docker build --tag tiangolo/uwsgi-nginx:python3.6 -f python3.6.dockerfile . --no-cache</span><br><span class="line"></span><br><span class="line">sudo docker build --tag nginx-uwsgi-gevent:3.6 .</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">sudo docker build -f Dockerfile -t gevent_webfms .</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">siege -c20 -t60  -v http://127.0.0.1:5000/long-polling</span><br><span class="line">siege -c100 -t60  -v http://10.4.7.131/long-polling</span><br><span class="line">curl http://10.4.7.131/long-polling</span><br><span class="line"></span><br><span class="line">curl http://192.168.40.191/long-polling</span><br><span class="line">siege -c100 -t60  -v http://192.168.40.191/long-polling</span><br><span class="line"></span><br><span class="line">curl http://192.168.40.191:8880/long-polling</span><br></pre></td></tr></table></figure>

<h1 id="Docker指令"><a href="#Docker指令" class="headerlink" title="Docker指令"></a>Docker指令</h1><p>記錄一下使用到的指令</p>
<h2 id="查看所有正在運行的docker"><a href="#查看所有正在運行的docker" class="headerlink" title="查看所有正在運行的docker"></a>查看所有正在運行的docker</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker ps -a</span><br></pre></td></tr></table></figure>
<h2 id="列出所有的容器-ID"><a href="#列出所有的容器-ID" class="headerlink" title="列出所有的容器 ID"></a>列出所有的容器 ID</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker ps -aq</span><br></pre></td></tr></table></figure>


<h2 id="移除所有不執行的contaner"><a href="#移除所有不執行的contaner" class="headerlink" title="移除所有不執行的contaner"></a>移除所有不執行的contaner</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker <span class="built_in">rm</span> $(sudo docker ps -aq)</span><br></pre></td></tr></table></figure>

<h2 id="停止所有的容器"><a href="#停止所有的容器" class="headerlink" title="停止所有的容器"></a>停止所有的容器</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker stop $(sudo docker ps -aq)</span><br></pre></td></tr></table></figure>

<h2 id="查看容器所有信息"><a href="#查看容器所有信息" class="headerlink" title="查看容器所有信息"></a>查看容器所有信息</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker inspect CONTAINER_ID</span><br></pre></td></tr></table></figure>

<h2 id="查看容器日誌"><a href="#查看容器日誌" class="headerlink" title="查看容器日誌"></a>查看容器日誌</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker container logs CONTAINER_ID</span><br></pre></td></tr></table></figure>

<h2 id="進入容器"><a href="#進入容器" class="headerlink" title="進入容器"></a>進入容器</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker exec -it CONTAINER_ID /bin/bash</span><br></pre></td></tr></table></figure>

<h2 id="刪除容器"><a href="#刪除容器" class="headerlink" title="刪除容器"></a>刪除容器</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker rm CONTAINER_ID</span><br></pre></td></tr></table></figure>

<h2 id="移除所有未使用的-Docker-項目"><a href="#移除所有未使用的-Docker-項目" class="headerlink" title="移除所有未使用的 Docker 項目"></a>移除所有未使用的 Docker 項目</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker system prune</span><br></pre></td></tr></table></figure>

<h2 id="删除所有的容器"><a href="#删除所有的容器" class="headerlink" title="删除所有的容器"></a>删除所有的容器</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker rm $(sudo docker ps -aq)</span><br></pre></td></tr></table></figure>

<h2 id="删除所有的镜像"><a href="#删除所有的镜像" class="headerlink" title="删除所有的镜像"></a>删除所有的镜像</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker rmi $(sudo docker images -q)</span><br></pre></td></tr></table></figure>

<h2 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker cp mycontainer:/opt/file.txt /opt/local/</span><br><span class="line">sudo docker cp /opt/local/file.txt mycontainer:/opt/</span><br></pre></td></tr></table></figure>

<h2 id="檢查設定是否正確"><a href="#檢查設定是否正確" class="headerlink" title="檢查設定是否正確"></a>檢查設定是否正確</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker-compose config</span><br></pre></td></tr></table></figure>



<h1 id="docker-io的登入"><a href="#docker-io的登入" class="headerlink" title="docker.io的登入"></a>docker.io的登入</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker login docker.io</span><br></pre></td></tr></table></figure>

<h2 id="Push-Image"><a href="#Push-Image" class="headerlink" title="Push Image"></a>Push Image</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu@nvt-nginx-1:~$ sudo docker image <span class="built_in">ls</span></span><br><span class="line">REPOSITORY          TAG                    IMAGE ID            CREATED             SIZE</span><br><span class="line">nginx               v1.19.10_with_stream   9149e4e0458c        46 minutes ago      356MB</span><br><span class="line">nginx               v1.12_with_stream      4e520a7877a5        About an hour ago   355MB</span><br><span class="line">mynginx             1.12.2_with_stream     4e520a7877a5        About an hour ago   355MB</span><br><span class="line">&lt;none&gt;              &lt;none&gt;                 13a3798ad3a2        2 hours ago         132MB</span><br><span class="line">&lt;none&gt;              &lt;none&gt;                 5130402b6304        2 hours ago         117MB</span><br><span class="line">debian              stretch                fe718d1e4082        3 weeks ago         101MB</span><br><span class="line">hello-world         latest                 d1165f221234        2 months ago        13.3kB</span><br><span class="line">alpine              3.10.3                 965ea09ff2eb        18 months ago       5.55MB</span><br><span class="line">myaline             v3.10.3                965ea09ff2eb        18 months ago       5.55MB</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 替 image 建立一個版號</span></span><br><span class="line">sudo docker tag nginx:v1.19.10_with_stream ttom921/nginx:v1.19.10_with_stream</span><br><span class="line"><span class="comment"># 推至設定好的庫</span></span><br><span class="line">sudo docker push ttom921/nginx:v1.19.10_with_stream</span><br></pre></td></tr></table></figure>

<h1 id="Docker-compose"><a href="#Docker-compose" class="headerlink" title="Docker compose"></a>Docker compose</h1><p>當想要佈署的 docker container 超過一個以上時，會突然發現 docker run 這個指令打到手軟，特別是當要跑起來的容器還要掛載一堆本地端資料夾，一直寫 <code>-v /home/.../.../HostData1:/home/mountData -v /home/.../HostData2:/home/mountData2 </code>簡直是記憶力大考驗。這時候就是拿出 <strong>Docker Compose</strong> 這個工具的時候了~~</p>
<h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><p>最新版下載</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.24.0/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>



<p>更新權限</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line">sudo docker-compose -version</span><br></pre></td></tr></table></figure>

<p>移除</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo rm /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get remove docker-compose</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get autoremove</span><br></pre></td></tr></table></figure>

<h2 id="如何寫docker-compose"><a href="#如何寫docker-compose" class="headerlink" title="如何寫docker-compose"></a>如何寫docker-compose</h2><p>先來檢查docker image</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker image <span class="built_in">ls</span></span><br><span class="line">REPOSITORY          TAG                    IMAGE ID            CREATED             SIZE</span><br><span class="line">ttom921/nginx       v1.19.10_with_stream   114608bbca8f        3 days ago          356MB</span><br><span class="line">&lt;none&gt;              &lt;none&gt;                 13a3798ad3a2        3 days ago          132MB</span><br><span class="line">&lt;none&gt;              &lt;none&gt;                 5130402b6304        3 days ago          117MB</span><br><span class="line">debian              stretch                fe718d1e4082        4 weeks ago         101MB</span><br><span class="line">hello-world         latest                 d1165f221234        2 months ago        13.3kB</span><br><span class="line">alpine              3.10.3                 965ea09ff2eb        18 months ago       5.55MB</span><br><span class="line">myaline             v3.10.3                965ea09ff2eb        18 months ago       5.55MB</span><br></pre></td></tr></table></figure>

<p>因為要使用nginx, 因為參數太多了所以使用docker compose</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd  ~</span><br><span class="line">vim docker-compose.yml</span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span>                                                                                                                                          </span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx_server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ttom921/nginx:v1.19.10_with_stream</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;1935:1935&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;2181:2181&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9091:9091&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9092:9092&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9093:9093&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/nginx:/etc/nginx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/local/nginx/html:/usr/local/nginx/html</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx00</span> </span><br></pre></td></tr></table></figure>

<p>第一行 version 一定要寫</p>
<p>services 定義所有的容器內容及相關細項</p>
<p>image:docker pull 的 image 名稱和 tag</p>
<ul>
<li>ports 這邊指明 8000:8000 的對映關係，就跟 docker run -p 8000:8000 一樣意思</li>
<li>volumes 這邊指定需要掛載本地端到容器內的資料夾，就跟 docker run -v aaa:bbb 一樣意思甚至這邊可以掛載多個還可以一次寫滿寫好</li>
<li>container_name 可以指定當容器啟動時的預設名稱</li>
</ul>
<h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><p>首先，請確定沒有任何其他複本的應用程式和資料庫正在執行 (<code>docker ps</code> 和 <code>docker rm -f &lt;ids&gt;</code>)</p>
<p>起動</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>關畢</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker-compose  down</span><br></pre></td></tr></table></figure>





<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><p><a href="https://www.coderbridge.com/@Jemmy1234/6d48f03f39284fe98ae9808f1243ef98">利用 Docker Compose 管理多個容器</a></p>
<h1 id="Openstreetmap的Docker相關"><a href="#Openstreetmap的Docker相關" class="headerlink" title="Openstreetmap的Docker相關"></a>Openstreetmap的Docker相關</h1><p>因為在使用openstreetmap時，需要有路徑導航的api，有人有open source，但是需要Docker來安裝，所以就也先來安裝Ubuntu18.04.3服務版</p>
<h2 id="安裝Docker"><a href="#安裝Docker" class="headerlink" title="安裝Docker"></a>安裝Docker</h2><p>先在Ubuntu來安裝</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo curl -sSL https://get.docker.com/ | sh</span><br></pre></td></tr></table></figure>

<p> 使用者加入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo usermod -aG docker ttom</span><br></pre></td></tr></table></figure>

<p>更新Docker run</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get upgrade</span><br></pre></td></tr></table></figure>

<p>目前 Docker 有支援 Linux、Mac 跟 Windows，到 <a href="https://store.docker.com/search?offering=community&q=&type=edition">Docker Store</a> 找到適合自己的版本，安裝完之後跑 <code>docker version</code>，有跑出版本就代表安裝成功了～</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker pull ubuntu</span><br></pre></td></tr></table></figure>

<p>完成後跑 <code>docker image ls</code> 可以看到有一個 ubuntu 的 image</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu              latest              775349758637        5 weeks ago         64.2MB</span><br></pre></td></tr></table></figure>

<p>首先透過下列指令安裝 Docker Compose。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.25.0/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<p>安裝完畢之後我們需要給予 Docker Compose 一定的執行權限。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<h2 id="Docker相關操作"><a href="#Docker相關操作" class="headerlink" title="Docker相關操作"></a>Docker相關操作</h2><p><strong>stop all containers:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker kill $(sudo docker ps -q)</span><br></pre></td></tr></table></figure>


<p>remove all containers**</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker rm $(sudo docker ps -a -q)</span><br></pre></td></tr></table></figure>

<p><strong>remove all docker images</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker rmi $(sudo docker images -q)</span><br></pre></td></tr></table></figure>

<p>查看所有docker的運行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker ps -a</span><br></pre></td></tr></table></figure>

<p>查看docker的運作的container</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker ps</span><br></pre></td></tr></table></figure>

<p>停止運行的container</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker stop &lt;container_id&gt; </span><br></pre></td></tr></table></figure>

<p>列出docker的image</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker image ls</span><br></pre></td></tr></table></figure>

<p>刪除用不到的image</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker rmi &lt;container_id&gt;</span><br></pre></td></tr></table></figure>





<h2 id="下載openrouteservice"><a href="#下載openrouteservice" class="headerlink" title="下載openrouteservice"></a>下載<a href="https://github.com/GIScience/openrouteservice">openrouteservice</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/GIScience/openrouteservice.git</span><br></pre></td></tr></table></figure>

<h2 id="建立它的DockerImage"><a href="#建立它的DockerImage" class="headerlink" title="建立它的DockerImage"></a>建立它的DockerImage</h2><p>到它的目錄下<code>ttom@ub64docktest:~/openrouteservice/docker$</code>，執行<code>sudo docker-compose up -d</code>會有下面的錯誤，以下面步驟來解決</p>
<p>出現<code>啟動 docker-compose 發生 ERROR: Couldn’t connect to Docker daemon at http+docker://localunixsocket - is it running? 錯誤</code></p>
<h4 id="Step-1-將當前用戶加入-docker-群組"><a href="#Step-1-將當前用戶加入-docker-群組" class="headerlink" title="Step 1. 將當前用戶加入 docker 群組"></a>Step 1. 將當前用戶加入 docker 群組</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo gpasswd -a $&#123;USER&#125; docker</span><br></pre></td></tr></table></figure>

<h4 id="Step-2-退出當前用戶"><a href="#Step-2-退出當前用戶" class="headerlink" title="Step 2. 退出當前用戶"></a>Step 2. 退出當前用戶</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo su</span><br></pre></td></tr></table></figure>

<h4 id="Step-3-再次切换到-ubuntu-用戶"><a href="#Step-3-再次切换到-ubuntu-用戶" class="headerlink" title="Step 3. 再次切换到 ubuntu 用戶"></a>Step 3. 再次切换到 ubuntu 用戶</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su ttom</span><br></pre></td></tr></table></figure>

<h4 id="Step-4-啟動-docker-compose"><a href="#Step-4-啟動-docker-compose" class="headerlink" title="Step 4. 啟動 docker-compose"></a>Step 4. 啟動 docker-compose</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>重新建置dock</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker-compose build</span><br></pre></td></tr></table></figure>



<p>最後產生它的DockerImage如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker_ors-app      latest              cc179fe7c398        17 hours ago        1.03GB</span><br><span class="line">openjdk             8-jdk               09df0563bdfc        2 weeks ago         488MB</span><br><span class="line">ubuntu              latest              775349758637        5 weeks ago         64.2MB</span><br></pre></td></tr></table></figure>

<p>使用指令來進入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker exec -it &lt;container_id&gt; /bin/bash</span><br></pre></td></tr></table></figure>

<p>查看docker里面的logs</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker logs &lt;container_id&gt;</span><br></pre></td></tr></table></figure>

<p>可以瀏覽器來測試</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://172.18.2.48:8080/ors/health</span><br><span class="line">http://172.18.2.48:8080/ors/status </span><br></pre></td></tr></table></figure>

<h2 id="更新地圖"><a href="#更新地圖" class="headerlink" title="更新地圖"></a>更新地圖</h2><ol>
<li>將下載後的地圖檔放在<code>docker/data</code>下</li>
<li>修改<code>docker-compose.yml</code>中的<code>OSM_FILE</code>的pbf檔</li>
<li>重新建置dockimage</li>
</ol>
<p><strong>注意</strong>如果有更換地圖，要重新來建置dock的image，地圖大小會影響地圖準備好的時間，可以下查看一下log是否有錯誤<code>sudo docker logs &lt;container_id&gt;</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="attr">ors-app:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">ors-app</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line">        <span class="attr">build:</span></span><br><span class="line">            <span class="attr">context:</span> <span class="string">../</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">                <span class="attr">APP_CONFIG:</span> <span class="string">./docker/conf/app.config.sample</span></span><br><span class="line">                <span class="attr">OSM_FILE:</span> <span class="string">./docker/data/heidelberg.osm.gz</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./graphs:/ors-core/data/graphs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./elevation_cache:/ors-core/data/elevation_cache</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./logs/ors/:/var/log/ors/</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./logs/tomcat/:/usr/local/tomcat/logs</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">JAVA_OPTS=-Djava.awt.headless=true</span> <span class="string">-server</span> <span class="string">-XX:TargetSurvivorRatio=75</span> <span class="string">-XX:SurvivorRatio=64</span> <span class="string">-XX:MaxTenuringThreshold=3</span> <span class="string">-XX:+UseConcMarkSweepGC</span> <span class="string">-XX:+UseParNewGC</span> <span class="string">-XX:ParallelGCThreads=4</span> <span class="string">-Xms1g</span> <span class="string">-Xmx2g</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">CATALINA_OPTS=</span> <span class="string">-Dcom.sun.management.jmxremote</span> <span class="string">-Dcom.sun.management.jmxremote.port=9001</span> <span class="string">-Dcom.sun.management.jmxremote.rmi.port=9001</span> <span class="string">-Dcom.sun.management.jmxremote.authenticate=false</span> <span class="string">-Dcom.sun.management.jmxremote.ssl=false</span> <span class="string">-Djava.rmi.server.hostname=localhost</span></span><br></pre></td></tr></table></figure>














<h2 id="參考資料-1"><a href="#參考資料-1" class="headerlink" title="參考資料"></a>參考資料</h2><p><a href="https://larrylu.blog/step-by-step-dockerize-your-app-ecd8940696f4">Docker 實戰系列（一）：一步一步帶你 dockerize 你的應用</a></p>
<p><a href="https://oranwind.org/-solution-qi-dong-docker-compose-fa-sheng-error-couldnt-connect-to-docker-daemon-at-httpdockerlocalunixsocket-is-it-running-cuo-wu/">啟動 docker-compose 發生 ERROR: Couldn’t connect to Docker daemon at http+docker:&#x2F;&#x2F;localunixsocket - is it running? 錯誤</a></p>
<p><a href="https://hub.docker.com/_/ubuntu">https://hub.docker.com/_/ubuntu</a></p>
<p><a href="https://extract.bbbike.org/">地圖分割</a></p>
<p><a href="https://gist.github.com/evanscottgray/8571828">dock操作</a></p>
]]></content>
      <categories>
        <category>記錄</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>一個JS學習者的日常</title>
    <url>/%E4%B8%80%E5%80%8BJS%E5%AD%B8%E7%BF%92%E8%80%85%E7%9A%84%E6%97%A5%E5%B8%B8/%E4%B8%80%E5%80%8BJS%E5%AD%B8%E7%BF%92%E8%80%85%E7%9A%84%E6%97%A5%E5%B8%B8/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>這是參考鐵人賽的一個JS學習者的日常所得來的，就只是記錄一下</p>
<h3 id="day01陣列相關"><a href="#day01陣列相關" class="headerlink" title="day01陣列相關"></a>day01陣列相關</h3><p>我們會用很多的陣列處理方法，<code>forEach</code>,<code>map</code>,<code>reduce</code>,<code>filter</code></p>
<p>測試資料</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> people = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jim&#x27;</span>,</span><br><span class="line">    <span class="attr">nickname</span>: <span class="string">&#x27;Hamburger&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">28</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Andy&#x27;</span>,</span><br><span class="line">    <span class="attr">nickname</span>: <span class="string">&#x27;Spaghetti&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">27</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Kevin&#x27;</span>,</span><br><span class="line">    <span class="attr">nickname</span>: <span class="string">&#x27;Curry&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">27</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Arel&#x27;</span>,</span><br><span class="line">    <span class="attr">like</span>: <span class="string">&#x27;Sushi&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">27</span></span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>過了一年，所有人都長了一歲怎麼辦？要在每一個age上面加一歲</p>
<p>先將資料簡化成更單純的樣子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> age = [<span class="number">28</span>, <span class="number">27</span>, <span class="number">27</span>, <span class="number">27</span>]</span><br><span class="line">age.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">item,index</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item,index);</span><br><span class="line">&#125;);</span><br><span class="line">age.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item,index</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item,index);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 28 0</span></span><br><span class="line"><span class="comment">// 27 1</span></span><br><span class="line"><span class="comment">// 27 2</span></span><br><span class="line"><span class="comment">// 27 3</span></span><br></pre></td></tr></table></figure>

<p><strong>forEach</strong> 只把資料丟給內部的<code>callback function</code>去進行處理</p>
<p><strong>map</strong> 把資料丟給內部的<code>callback function</code>去進行處理，並回組一組<strong>陣列</strong>資料</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> result=age.<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">item, index</span>) &#123;</span><br><span class="line">    item = item + index</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">result= age.<span class="title function_">map</span>(<span class="function">(<span class="params">item,index</span>)=&gt;</span>&#123;</span><br><span class="line">    item= item+index;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br></pre></td></tr></table></figure>

<p><strong>reduce</strong>抓取初始值與下一個值，並回傳一個結果值</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> rsreduce = age.<span class="title function_">reduce</span>(<span class="keyword">function</span> (<span class="params">item, item2</span>) &#123;</span><br><span class="line">    item = item + item2;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 28 + 27 + 27 + 27 = 109</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rsreduce);</span><br><span class="line">rsreduce = age.<span class="title function_">reduce</span>(<span class="function">(<span class="params">item, item2</span>) =&gt;</span> &#123;</span><br><span class="line">    item = item + item2;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 28 + 27 + 27 + 27 = 109</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rsreduce);</span><br></pre></td></tr></table></figure>

<p><strong>filter</strong>回傳Boolesn值true或false判斷引人處理後是否為要回傳的值，最後回一組陣列</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//filter</span></span><br><span class="line"><span class="keyword">var</span> rsfilter = age.<span class="title function_">filter</span>(<span class="keyword">function</span> (<span class="params">item</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (item &lt; <span class="number">28</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rsfilter);</span><br><span class="line">rsfilter = age.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (item &lt; <span class="number">28</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rsfilter);</span><br></pre></td></tr></table></figure>

<p>但回到原本的資料，如何把所有的年齡加1</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">people.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    item.<span class="property">age</span> += <span class="number">1</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(people);</span><br></pre></td></tr></table></figure>

<h3 id="day02"><a href="#day02" class="headerlink" title="day02"></a>day02</h3><p>一個物件資料， 想要複製樣的格式給下一個，並修改結果被更動到了原本的人資料,這是因為是指同一個位置</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Jim</span> = &#123;</span><br><span class="line">    <span class="attr">favMovie</span>: <span class="string">&quot;LaLaLand&quot;</span>,</span><br><span class="line">    <span class="attr">favBook</span>: <span class="string">&quot;Thid Hitchhiker&#x27;s Guide to the Galaxy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Albert</span> = <span class="title class_">Jim</span>;</span><br><span class="line"><span class="title class_">Albert</span>.<span class="property">favMovie</span> = <span class="string">&quot;Fight Club&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Jim</span>.<span class="property">favMovie</span>);</span><br><span class="line"><span class="comment">//Fight Club</span></span><br></pre></td></tr></table></figure>
<p>使用Object.assign</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//使用Object.assign</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Jim</span> = &#123;</span><br><span class="line">    <span class="attr">favMovie</span>: <span class="string">&quot;LaLaLand&quot;</span>,</span><br><span class="line">    <span class="attr">favBook</span>: <span class="string">&quot;Thid Hitchhiker&#x27;s Guide to the Galaxy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Albert</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, <span class="title class_">Jim</span>);</span><br><span class="line"><span class="title class_">Albert</span>.<span class="property">favMovie</span> = <span class="string">&quot;back to the future&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Jim</span>.<span class="property">favMovie</span>)</span><br><span class="line"><span class="comment">//LaLaLand</span></span><br></pre></td></tr></table></figure>

<p><strong>const</strong> 指定常數，不可改變，但是是陣列時內容是可以改變</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">PI</span>=<span class="number">3.14159</span>;</span><br><span class="line"><span class="variable constant_">PI</span>=<span class="number">1.141</span>;<span class="comment">//有錯誤，不可再指定</span></span><br><span class="line"><span class="comment">//Assignment to constant variable. </span></span><br><span class="line"><span class="comment">//  at ​day02.js:21:0​</span></span><br><span class="line"><span class="comment">//  at ​​​Object.&lt;anonymous&gt;​​​</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> arr=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">arr.<span class="title function_">push</span>(<span class="number">4</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr);</span><br><span class="line">arr[<span class="number">3</span>]=<span class="number">999</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr)</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">arr2=[<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>]</span><br><span class="line">arr= arr2;<span class="comment">//有錯誤，不可再指定</span></span><br></pre></td></tr></table></figure>

<p>函式沒有傳入參數，卻有這個變數可以用？回傳的這是啥</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>.<span class="property">length</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hello</span>(<span class="string">&#x27;echoooo&#x27;</span>);</span><br><span class="line"><span class="comment">//1 ​​​​​at ​​​arguments.length</span></span><br><span class="line"><span class="comment">//&#123; [Iterator]  0: &#x27;echoooo&#x27;, [Symbol(Symbol.iterator)]: [λ: values] &#125; at ​​​arguments​​​ </span></span><br></pre></td></tr></table></figure>

<p>this是“這”的意思嗎？this到底指到哪裏？</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">sayHi</span>: <span class="string">&quot;How ar you?&quot;</span>,</span><br><span class="line">    <span class="attr">sayHello</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">sayHi</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayHelo</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(obj);</span><br><span class="line">    obj.<span class="title function_">sayHello</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">sayHelo</span>(obj);</span><br><span class="line"><span class="comment">// &#123; sayHi: &#x27;How ar you?&#x27;, sayHello: [λ: sayHello] &#125;   at ​​​obj​​​ </span></span><br><span class="line"><span class="comment">// How ar you? ​​​​​at ​​​this.sayHi</span></span><br></pre></td></tr></table></figure>

<h3 id="day03基本型別"><a href="#day03基本型別" class="headerlink" title="day03基本型別"></a>day03基本型別</h3><p>有六種基本型別</p>
<ul>
<li>string</li>
<li>number</li>
<li>boolean</li>
<li>null</li>
<li>undefined</li>
<li>object</li>
</ul>
<p>物件的宣告方式為兩種</p>
<p>物件宣告第一種</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//物件宣告第一種</span></span><br><span class="line"><span class="keyword">var</span> myObj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myObj.<span class="property">name</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myObj.<span class="property">age</span>)</span><br></pre></td></tr></table></figure>

<p>物件宣告第二種</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> curObj= <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">curObj.<span class="property">name</span>=<span class="string">&quot;456&quot;</span>;</span><br><span class="line">curObj.<span class="property">age</span>=<span class="number">28</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(curObj.<span class="property">name</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(curObj.<span class="property">age</span>)</span><br></pre></td></tr></table></figure>

<p>物件就像是一個群集，包含了資料跟處理資料的方法，他可能長成這樣</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> introduction=&#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&#x27;Jim&#x27;</span>,</span><br><span class="line">    <span class="attr">favFood</span>:<span class="string">&#x27;Sushi&#x27;</span>,</span><br><span class="line">    <span class="attr">breakIce</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hello I am <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>,My favFood is <span class="subst">$&#123;<span class="variable language_">this</span>.favFood&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">introduction.<span class="title function_">breakIce</span>();</span><br></pre></td></tr></table></figure>

<p>我們有了一個績件後如何呼叫與存取有兩種方式為特性存取<strong>property access</strong>與鍵值存取<strong>key access</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> firstName = <span class="string">&#x27;Hu&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> ages = &#123;</span><br><span class="line">    <span class="title class_">FirstName</span>: <span class="string">&#x27;Hu&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;firstName&#x27;</span>: <span class="string">&#x27;Hu&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Hu Jim&#x27;</span>: <span class="number">28</span>,</span><br><span class="line">    <span class="string">&#x27;Hu Koa&#x27;</span>: <span class="number">60</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//特性存取(property access)</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ages.<span class="property">FirstName</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ages.<span class="property">firstName</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//鍵值存取(key access)</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ages[firstName + <span class="string">&#x27; Jim&#x27;</span>]);</span><br><span class="line"><span class="comment">//加入一個新的</span></span><br><span class="line">ages[firstName + <span class="string">&#x27; Ge&#x27;</span>] = <span class="number">30</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ages);</span><br></pre></td></tr></table></figure>

<p>物件的複製</p>
<p>Shallow Clone</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> firstName = <span class="string">&#x27;Hu&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ages = &#123;</span><br><span class="line">    <span class="string">&#x27;Hu Jim&#x27;</span>: <span class="number">28</span>,</span><br><span class="line">    <span class="string">&#x27;Hu Koa&#x27;</span>: <span class="number">60</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Shallow Clone</span></span><br><span class="line"><span class="keyword">var</span> agesNextYear = ages;</span><br><span class="line">agesNextYear[firstName + <span class="string">&#x27; Jim&#x27;</span>] = <span class="number">29</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Shallow Clone ages:&#x27;</span> + ages[firstName + <span class="string">&#x27; Jim&#x27;</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Shallow Clone agesNextYear&#x27;</span> + agesNextYear[firstName + <span class="string">&#x27; Jim&#x27;</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Deep Clone</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Deep Clone</span></span><br><span class="line"><span class="keyword">var</span> firstName = <span class="string">&#x27;Hu&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ages = &#123;</span><br><span class="line">    <span class="string">&#x27;Hu Jim&#x27;</span>: <span class="number">28</span>,</span><br><span class="line">    <span class="string">&#x27;Hu Koa&#x27;</span>: <span class="number">60</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> agesNextYear= <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;,ages);</span><br><span class="line">agesNextYear[firstName + <span class="string">&#x27; Jim&#x27;</span>] = <span class="number">29</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Deep Clone ages:&#x27;</span> + ages[firstName + <span class="string">&#x27; Jim&#x27;</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Deep Clone agesNextYear&#x27;</span> + agesNextYear[firstName + <span class="string">&#x27; Jim&#x27;</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="day04-callback相關"><a href="#day04-callback相關" class="headerlink" title="day04 callback相關"></a>day04 callback相關</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">example</span>(<span class="params">msg, callback</span>) &#123;</span><br><span class="line">    <span class="title function_">callback</span>(msg)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">example</span>(<span class="string">&#x27;hello callback&#x27;</span>, <span class="keyword">function</span> (<span class="params">sayHi</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sayHi)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//結果 hello callback</span></span><br></pre></td></tr></table></figure>

<p>什麼是callback,專有名詞來說就是一種高階函式的用法，可以把函式當作變數傳遞，當然函數也可以返回函數，而這樣做我們可以在需要的時候再去使用它或者解決非同步阻塞的問題。在處理陣列時我們也使用同樣的方法來處理我們的陣列資料。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> total = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="keyword">var</span> res = total.<span class="title function_">reduce</span>(<span class="function">(<span class="params">initvalue, nextitem</span>) =&gt;</span> &#123;</span><br><span class="line">    initvalue += nextitem</span><br><span class="line">    <span class="keyword">return</span> initvalue;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line"><span class="comment">// 結果 15</span></span><br></pre></td></tr></table></figure>

<p>在撰寫邏輯上，我們可以直接的方式撰寫，變很快速理解，但直正使用的理由是，當我們事件與服務要求次數變多，要達到不阻塞I&#x2F;O或多緒執行的 益時，更需要思考我們撰寫程式的邏輯與方式並非單純直覺的以單線作為考量</p>
<h3 id="day05-API"><a href="#day05-API" class="headerlink" title="day05 API"></a>day05 API</h3><p>當我們做一個會員登人系統，接到API後，拿到一個像這樣子的一筆JSON資料</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$.<span class="title function_">get</span>(<span class="string">&#x27;https://randomuser.me/api/&#x27;</span>,<span class="keyword">function</span>(<span class="params">result</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(result)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hu&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jim&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;streetAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;21 2nd Street&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;New York&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NY&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;postalCode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10021&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;phoneNumber&quot;</span><span class="punctuation">:</span> </span><br><span class="line">    <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;home&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;212 555-1234&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fax&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;646 555-4567&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>什麼又是JSON</p>
<p>通常我們會拿到一個物件或陣列格式，包含物件或陣列的資料。這樣的結構我們稱為JSON</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;results&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;firstCol1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;firstCol2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;firstCol3&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;firstCol4&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;firstCol5&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span><span class="attr">&quot;SecCol1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span><span class="attr">&quot;SecCol2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span><span class="attr">&quot;SecCol3&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span><span class="attr">&quot;SecCol4&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span> </span><br><span class="line">  <span class="punctuation">]</span>     </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>看起來是物件或陣列，但在網路上傳遞資料的方式，是以字串的方式去處理的，所以我們必須使用<strong>JSON.stringify</strong>轉成字串或<strong>JSON.parse</strong>去轉回物件或陣列。</p>
<p>再往回看一點點，我們到底在程式上要如何去接一個 API，可以使用 JS 原生的功能或者用套件，針對接 API 功能去處理，這裡提供五個例子，包含原始 XMLHttpRequest、jQuery、axios、superAgent、fetch。</p>
<p><a href="https://codepen.io/JimHu1492/pen/JOPNYX">接API的五種方式</a></p>
<h3 id="day06同步和非同步"><a href="#day06同步和非同步" class="headerlink" title="day06同步和非同步"></a>day06同步和非同步</h3><p>當你程式的某部份現在(now)立即執行而另外一部分要在之後(later)執行時，會發生什麼事，在這個now和loater之間有個間隙(gap)存在，期間你的程式並有積極執行</p>
<p>什麼是非同步？非同步包括，網路連線要求之類的I&#x2F;O(例如AJAX，DOM事件處理，動畫流程處理，計時器)</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;c&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>我們可以看到執行結果A-&gt;B-&gt;C，但是我們要處理的狀態越來越多，結構越來越雜的時候，callback也許就不夠用山，事件的交錯與不確定資料處理的期間，不斷增加開發中理解與撰寫上的困難，再進一步學習中，處理相關的問題Promise是其中一個選項</p>
<h3 id="day07多判斷switch-case"><a href="#day07多判斷switch-case" class="headerlink" title="day07多判斷switch case"></a>day07多判斷switch case</h3><p>當我們需要多個判斷的時候，使用swith case的小細節</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> fruit = <span class="string">&#x27;apple&#x27;</span>;</span><br><span class="line"><span class="keyword">switch</span> (fruit) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;banana&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;It is a banana&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;peach&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;It is a peach&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;apple&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;It is a apple&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;I don\&#x27;t know what is it&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在switch case中如果要中斷，要加入<strong>break</strong>這關鍵字不然會一直執行下去。</p>
<h3 id="day08-ES6常用語法"><a href="#day08-ES6常用語法" class="headerlink" title="day08 ES6常用語法"></a>day08 ES6常用語法</h3><p>ES6它的全名是ECMAScript6。便是我們所學的JS的語言核心。從第五版ES5到第六版ES6日漸普遍，而ES7也蓄勢待發</p>
<ol>
<li><p>解構賦值</p>
<p>說明:我們可以將一個陣列以<strong>…</strong>的形式，一次展開或者一次打包起來</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="comment">//展開</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(...arr);</span><br><span class="line"><span class="comment">//結果 1 2 3 4 5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showArr</span>(<span class="params">num1, num2, ...num3</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(num1);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(num2);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(num3);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//打包</span></span><br><span class="line"><span class="title function_">showArr</span>(...arr);</span><br><span class="line"><span class="comment">//結果 </span></span><br><span class="line"><span class="comment">// 1 </span></span><br><span class="line"><span class="comment">// 2 </span></span><br><span class="line"><span class="comment">// [ 3, 4, 5 ]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>模板字變量和多行字符串</p>
<p>說明:可以在``(注意此為鍵盤左上方``符號非’’單引號)之間包含字串，邺以＄{}包𨭎變數，甚至換行也可以。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayMyName</span>(<span class="params">firstName, lastName</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hollo My Name</span></span><br><span class="line"><span class="string">    is <span class="subst">$&#123;firstName&#125;</span> <span class="subst">$&#123;lastName&#125;</span></span></span><br><span class="line"><span class="string">    `</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">sayMyName</span>(<span class="string">&quot;tom&quot;</span>, <span class="string">&quot;tang&quot;</span>);</span><br><span class="line"><span class="comment">//結果 Hollo My Name </span></span><br><span class="line"><span class="comment">//    is tom tang </span></span><br></pre></td></tr></table></figure>
</li>
<li><p>箭頭函數</p>
<p>說明:寫法(引數)&#x3D;&gt;{函式內容}</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> res=arr.<span class="title function_">reduce</span>(<span class="function">(<span class="params">total,items</span>)=&gt;</span>&#123;</span><br><span class="line">    total +=items;</span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line"><span class="comment">//結果 15 </span></span><br></pre></td></tr></table></figure>
</li>
<li><p>let 宣告</p>
<p>說明:JS本來是以function去分辨解析變名稱所使用的範圍，意思是在一各物綿內具有一個或往更上層找或是全域等等，也就是大家常說的scope，有別於其他語言可能以大括號**{}<strong>作為範圍的選擇，所以當使用var在物件宣告的時候，一樣會變宣告成往上找到最上層fucnton的範圍。而如果使用let，更會改以</strong>{}**去判斷scope</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> test =<span class="string">&quot;test&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(test==<span class="string">&quot;test&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> num5=<span class="number">10</span>;</span><br><span class="line">    <span class="keyword">let</span> num6=<span class="number">20</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(num5);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(num6);</span><br><span class="line"><span class="comment">//結果 10</span></span><br><span class="line"><span class="comment">// num6 is not defined </span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>5.預設參數</p>
<p>  說明:一般來 說來如果引數與對應的參數不符合時，就會出錯。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">num1=<span class="number">1</span></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> num1+num2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">add</span>(<span class="number">10</span>);</span><br><span class="line"><span class="comment">//結果 num2 is not defined </span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">num1=<span class="number">1</span>,num2=<span class="number">1</span></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> num1+num2;</span><br><span class="line">&#125;</span><br><span class="line">res=<span class="title function_">add</span>(<span class="number">10</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line"><span class="comment">//結果 11</span></span><br></pre></td></tr></table></figure>

<p>其它還未使用到的:</p>
<p>Module的import export功能、OOP的class寫法</p>
<p>補充:</p>
<p>當我們所使用的語法。瀏覽器可能過舊或不支援，本身無法被解析的時候，我們便需要使用polyfill，便是那麼一段程式碼，好讓新的語法也能解析。而事實上自已也可以針對語法的格式去寫出要的功能，但你必須對語言背後的行為邏輯有正確的理解</p>
<h3 id="day09閉包Closure"><a href="#day09閉包Closure" class="headerlink" title="day09閉包Closure"></a>day09閉包Closure</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">saveMoney</span>(<span class="params">newSaving = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> myAccount = <span class="number">20000</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> myAccount + newSaving;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">total = <span class="title function_">saveMoney</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">total</span>());</span><br><span class="line"><span class="comment">//結果 21000</span></span><br></pre></td></tr></table></figure>

<p>第一次看到這個寫法覺得很𫋵奇，卻不知道它就是所謂鼎鼎大名的閉包(Closure)</p>
<p>什麼是閉包?看code，是由兩個函式搆成的而且互為表裡。</p>
<p>JS用function去界定變數名稱的作用範圍，當我們它一固函式用另一個函式包起來，便會形成一個封閉的空間，而裡面的變數名稱，也只在範圍內可以使用，我們稱無private變數。使用它來達到隱藏資訊的效果。</p>
<p>再看一個累加的例子</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">accumulation</span>(<span class="params"><span class="built_in">number</span>=<span class="number">0</span></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">number</span>++);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> total= <span class="title function_">accumulation</span>();</span><br><span class="line"><span class="title function_">total</span>();</span><br><span class="line"><span class="title function_">total</span>();</span><br><span class="line"><span class="title function_">total</span>();</span><br><span class="line"><span class="comment">//結果</span></span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2 </span></span><br></pre></td></tr></table></figure>

<p>為什麼number會一直累加上去，而因為每次執行而開始重新計算，這更是閉包達到的效果。藉由雙層函式的架構將number變數存在記憶體當中，並藉由accumulation去執行裡面的匿名函式去改變值。</p>
<p>閉包博大精深，網路上有很多不同的資訊，但基本的function產生作用域用雙層function去達到封閉作用空間，是我對閉包基本認知。</p>
<h3 id="day10強制轉型"><a href="#day10強制轉型" class="headerlink" title="day10強制轉型"></a>day10強制轉型</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">conditionA = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (conditionA) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//無結果</span></span><br><span class="line">conditionB = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (conditionB) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//結果 hello</span></span><br></pre></td></tr></table></figure>

<p>在修件判斷中，為什麼conditionA為什麼不會通過條件判斷？</p>
<p>在條件判斷中，我們需要得到一個true或false才能去判斷接下來要不要執行𧟕面的程式，但如果裡面不是一個單純的比較，是一個物件或者其他東西會發生什麼事情？</p>
<p>從JS的強制轉型搆起，看以下程式碼</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a=<span class="number">42</span>;</span><br><span class="line"><span class="keyword">var</span> b=a+<span class="string">&quot;&quot;</span>;<span class="comment">//隱含的強制轉型</span></span><br><span class="line"><span class="keyword">var</span> c= <span class="title class_">String</span>(a);<span class="comment">//明確的強制轉型</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c);</span><br><span class="line"><span class="comment">//42 ​​​​​at ​​​b​​​ </span></span><br><span class="line"><span class="comment">//42 ​​​​​at ​​​c​​​</span></span><br></pre></td></tr></table></figure>

<p>當我們的操作不符合正常狀況時，JS語言會幫我們進一步處理。回到我們條件判斷，我們應該給予一個Boolean值或一個得出Boolean值的比較，但如果是其他的東西，JS會幫我們進行強制轉型而要變為Boolean的true或fals就是用所謂的Truthy值或Falsy值去判斷。那我們現在給的東西是哪一種值呢？</p>
<p>其㲒可以很簡單，除了以下Falsy的，都是Truthy</p>
<ul>
<li><p>undefined</p>
</li>
<li><p>null</p>
</li>
<li><p>false</p>
</li>
<li><p>+0、-0 以及NaN</p>
</li>
<li><p>“”</p>
</li>
</ul>
<p>最上面的例子，其實常常用在判斷是否為空值時的判斷，我們也可以寫成以下，去判斷資料是否為空。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">conditionA = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!conditionA) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;目前沒有值&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 結果 </span></span><br><span class="line"><span class="comment">//目前沒有值 ​​​​​</span></span><br></pre></td></tr></table></figure>

<p>另外使用三元運算式將我們原本的程式改寫成更簡潔的狀態。</p>
<blockquote>
<p>語法：</p>
<p>判斷式?如果符合:如果不符合</p>
</blockquote>
<p>以下改寫</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">conditionA=<span class="string">&quot;&quot;</span>;</span><br><span class="line">!conditionA ? <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;目前沒有值&quot;</span>):<span class="variable language_">console</span>.<span class="title function_">log</span>(conditionA);</span><br><span class="line"><span class="comment">//結果 目前沒有值</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">conditionA=<span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">!conditionA ? <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;目前沒有值&quot;</span>):<span class="variable language_">console</span>.<span class="title function_">log</span>(conditionA);</span><br><span class="line"><span class="comment">//結果 Hello</span></span><br></pre></td></tr></table></figure>

<h3 id="day11鏈式函式"><a href="#day11鏈式函式" class="headerlink" title="day11鏈式函式"></a>day11鏈式函式</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> $ = <span class="keyword">function</span> (<span class="params">Person</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">breakTheIce</span>: <span class="keyword">function</span> (<span class="params">message</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(message + <span class="string">&quot; My name is &quot;</span> + <span class="title class_">Person</span>.<span class="property">name</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">introduce</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;I&#x27;m a &quot;</span> + <span class="title class_">Person</span>.<span class="property">intro</span> + <span class="string">&quot; Do you want to program with me?&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Jim</span> = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;Jim Hu&quot;</span>,</span><br><span class="line">    <span class="attr">intro</span>: <span class="string">&quot;Programmer!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">$(<span class="title class_">Jim</span>).<span class="title function_">breakTheIce</span>(<span class="string">&quot;Hi&quot;</span>).<span class="title function_">introduce</span>();</span><br></pre></td></tr></table></figure>

<h3 id="day12修改網頁背景"><a href="#day12修改網頁背景" class="headerlink" title="day12修改網頁背景"></a>day12修改網頁背景</h3><p>把 google 首頁背景變成黃色的三種方式。</p>
<ol>
<li>利用開發者模式功能</li>
</ol>
<blockquote>
<p>在開法者模式下選擇 HTML tag <body></body>的部分，<br>然後在後面style欄位填上 background: yellow</p>
</blockquote>
<ol start="2">
<li>利用 JS 原生語法</li>
</ol>
<blockquote>
<p>利用 JavaScript 原生語法， getElementsByTagName 抓到<br>body 選項，再加上 style 改變顏色</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;body&quot;</span>);</span><br><span class="line">x[<span class="number">0</span>].<span class="property">style</span>.<span class="property">background</span> = <span class="string">&#x27;yellow&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>利用 jQuery 函式庫</li>
</ol>
<blockquote>
<p>先創建一個包含引入函式庫的 <script></script> 標籤，再來抓取 <head></head> 標頭，將標籤附加上去。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> el = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">el.<span class="property">src</span> = <span class="string">&quot;https://code.jquery.com/jquery-3.2.1.js&quot;</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;head&#x27;</span>)[<span class="number">0</span>].<span class="title function_">appendChild</span>(el);</span><br><span class="line"></span><br><span class="line"><span class="comment">//jQuery語法</span></span><br><span class="line">$(<span class="string">&quot;body&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;background-color&quot;</span>, <span class="string">&quot;yellow&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="day13網頁重繪的流程"><a href="#day13網頁重繪的流程" class="headerlink" title="day13網頁重繪的流程"></a>day13網頁重繪的流程</h3><p>要如何決定今天我們要製作一個移動的動畫，要用 translate 還是去改變 position 呢？<br>那我們就要了解一下重排（reflow）跟重繪（repaint）</p>
<p>五個步驟：</p>
<ol>
<li>HTML 轉換成 DOM</li>
<li>CSS 轉換成 CSSOM</li>
<li>將兩個東西結合，生成一刻渲染樹 （包含每個節點的視覺訊息）</li>
<li>生成佈局（layout），即將所有渲染入的節點進行平面合成</li>
<li>將佈局繪製（paint）在平面上</li>
</ol>
<p>而大致上網頁的變動都不斷在重複 4. 跟 5. 的動作，而效能選擇上的差異便在降低這兩項事情的發生。</p>
<p>需要重排跟重繪的狀況分為</p>
<ol>
<li>修改DOM</li>
<li>修改樣式表</li>
<li>觸發事件</li>
</ol>
<p>避免重新渲染，我們可以看看 CSStrigger 這個網站對於 transform 跟 position 的差異。就可以知道哪個選擇上比較合適。</p>
<p>參考資料：<br><a href="http://www.ruanyifeng.com/blog/2015/09/web-page-performance-in-depth.html">阮一峰的网络日志</a><br><a href="https://csstriggers.com/">CSStrigger</a></p>
<h3 id="day14網頁事件"><a href="#day14網頁事件" class="headerlink" title="day14網頁事件"></a>day14網頁事件</h3><p>事件表</p>
<table>
<thead>
<tr>
<th align="center">事件</th>
<th align="center">行為</th>
<th align="center">例子</th>
</tr>
</thead>
<tbody><tr>
<td align="center">onchange</td>
<td align="center">當元素改變</td>
<td align="center">selector</td>
</tr>
<tr>
<td align="center">onclick</td>
<td align="center">當點下 HTML 元素</td>
<td align="center">點擊後送出資料或選擇該元素</td>
</tr>
<tr>
<td align="center">onmouseover</td>
<td align="center">當滑鼠通過 HTML 元素</td>
<td align="center">提示效果，通常會搭配 onclick</td>
</tr>
<tr>
<td align="center">onmouseout</td>
<td align="center">當滑鼠離開 HTML 元素</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">onkeydown</td>
<td align="center">當按下鍵盤</td>
<td align="center">抓取值顯示</td>
</tr>
<tr>
<td align="center">onload</td>
<td align="center">當瀏覽器載入頁面時後</td>
<td align="center">串接 API 更改資料列</td>
</tr>
</tbody></table>
<p>其實寫法很簡單，都是在 tag 裡面<br>加上你要執行的 function 名稱</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;element event=&#x27;some JavaScript&#x27;&gt;</span><br></pre></td></tr></table></figure>

<p>在例子中我們通常很難感受到效果，直到實際去操作。而 W3School 提供很多有趣的例子跟實驗平台，可以快速地以實踐為學習。推薦一開始從此下手。<br><a href="https://www.w3schools.com/js/js_events_examples.asp">學習連結</a></p>
<h3 id="day16亂數的取法"><a href="#day16亂數的取法" class="headerlink" title="day16亂數的取法"></a>day16亂數的取法</h3><p>思考：</p>
<p>如何取40~80間(不包含80)的亂數</p>
<p>我們用Math.random()的語法，可以得到一個0~1之間穴包含1的亂數</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> res=<span class="title class_">Math</span>.<span class="title function_">random</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line"><span class="comment">//0.8273783802602397</span></span><br></pre></td></tr></table></figure>

<p>取亂數的方法:</p>
<ol>
<li><p>將Math.random結果換算成取1～*並去掉小數點</p>
</li>
<li><p>用取餘數得到想要的亂數範圍</p>
</li>
<li><p>如果不是從0開始，加上要從多少開始數字</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> res = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">100</span>) % <span class="number">40</span> + <span class="number">40</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br></pre></td></tr></table></figure>

<p>逐一拆解便為</p>
<ol>
<li>Math.random()*100 &#x2F;&#x2F;可取0～99之間的數字</li>
<li>Math.floor(Math.random()*100) &#x2F;&#x2F;去掉小數點</li>
<li>Math.floor(Math.random()*100)%40 &#x2F;&#x2F;可取0～39之間的餘數</li>
<li>Math.floor(Math.random()*100)%40+40&#x2F;&#x2F;可霰40～79之間的餘數</li>
</ol>
<h3 id="day17畫圓"><a href="#day17畫圓" class="headerlink" title="day17畫圓"></a>day17畫圓</h3><p><a href="https://stackblitz.com/edit/js-nrw4zh?file=index.js">stackblitz</a><br>用Canvas畫圓，並做成一個簡單的小動畫，想要畫的圓是同心圓，並搭配Fibonacci數列，讓圓圈大小更自然的變化, 在HTML的碼 </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;canvas&quot;</span> <span class="attr">width</span>=<span class="string">&quot;1000px&quot;</span> <span class="attr">height</span>=<span class="string">&quot;1000px&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>畫同心圓</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Import stylesheets</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"><span class="comment">// 畫圓功能</span></span><br><span class="line"><span class="keyword">var</span> circle= <span class="keyword">function</span> (<span class="params">x, y, radius</span>) &#123;</span><br><span class="line">   ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">   ctx.<span class="title function_">arc</span>(x, y, radius, <span class="number">0</span>, <span class="number">2</span>*<span class="title class_">Math</span>.<span class="property">PI</span>, <span class="literal">false</span>);</span><br><span class="line">   ctx.<span class="title function_">stroke</span>();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Write Javascript code!</span></span><br><span class="line"><span class="keyword">const</span> appDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>);</span><br><span class="line"><span class="comment">//appDiv.innerHTML = `&lt;h1&gt;JS Starter&lt;/h1&gt;`;</span></span><br><span class="line"><span class="keyword">let</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;canvas&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line">ctx.<span class="property">lineWidth</span> = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&quot;Red&quot;</span>;</span><br><span class="line"><span class="title function_">circle</span>(<span class="number">200</span>,<span class="number">150</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&quot;orange&quot;</span>;</span><br><span class="line"><span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&quot;yellow&quot;</span>;</span><br><span class="line"><span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&quot;Green&quot;</span>;</span><br><span class="line"><span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&quot;Blue&quot;</span>;</span><br><span class="line"><span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, <span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&quot;Purple&quot;</span>;</span><br><span class="line"><span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, <span class="number">130</span>);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>用for loop 優化程式</p>
<p>因為位置是重複的，所以可以試著把同樣的東西，用陣列與迴圈整理出來</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Import stylesheets</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"><span class="comment">// Write Javascript code!</span></span><br><span class="line"><span class="keyword">const</span> appDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>);</span><br><span class="line"><span class="comment">// 畫圓功能</span></span><br><span class="line"><span class="keyword">var</span> circle= <span class="keyword">function</span> (<span class="params">x, y, radius</span>) &#123;</span><br><span class="line">   ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">   ctx.<span class="title function_">arc</span>(x, y, radius, <span class="number">0</span>, <span class="number">2</span>*<span class="title class_">Math</span>.<span class="property">PI</span>, <span class="literal">false</span>);</span><br><span class="line">   ctx.<span class="title function_">stroke</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;canvas&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line">ctx.<span class="property">lineWidth</span> = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> styles = [<span class="string">&quot;Red&quot;</span>,<span class="string">&quot;orange&quot;</span>,<span class="string">&quot;yellow&quot;</span>,<span class="string">&quot;Green&quot;</span>,<span class="string">&quot;Blue&quot;</span>,<span class="string">&quot;Purple&quot;</span>,<span class="string">&quot;Gray&quot;</span>]</span><br><span class="line"><span class="keyword">let</span> size = [<span class="number">10</span>,<span class="number">20</span>,<span class="number">30</span>,<span class="number">50</span>,<span class="number">80</span>,<span class="number">130</span>,<span class="number">210</span>]</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">    ctx.<span class="property">strokeStyle</span> = styles[i];</span><br><span class="line">    <span class="title function_">circle</span>(<span class="number">200</span>,<span class="number">150</span>,size[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>用setInterval反覆畫圖，將其變成動畫</p>
<p>因為是動態的，所以不會一開始就色所有的線都畫出來，並且會一直執行畫線的動作，所以利用setInterval並改變半徑大小畫出不同的圓</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Import stylesheets</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"><span class="comment">// Write Javascript code!</span></span><br><span class="line"><span class="keyword">const</span> appDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>);</span><br><span class="line"><span class="comment">// 畫圓功能</span></span><br><span class="line"><span class="keyword">var</span> circle= <span class="keyword">function</span> (<span class="params">x, y, radius</span>) &#123;</span><br><span class="line">   ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">   ctx.<span class="title function_">arc</span>(x, y, radius, <span class="number">0</span>, <span class="number">2</span>*<span class="title class_">Math</span>.<span class="property">PI</span>, <span class="literal">false</span>);</span><br><span class="line">   ctx.<span class="title function_">stroke</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;canvas&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line">ctx.<span class="property">lineWidth</span> = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> styles = [<span class="string">&quot;Red&quot;</span>, <span class="string">&quot;orange&quot;</span>,<span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;Green&quot;</span>, <span class="string">&quot;Blue&quot;</span>, <span class="string">&quot;Purple&quot;</span>, <span class="string">&quot;Gray&quot;</span>];</span><br><span class="line"><span class="keyword">let</span> size = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">50</span>, <span class="number">80</span>, <span class="number">130</span>, <span class="number">210</span>];</span><br><span class="line"><span class="keyword">let</span> styleClear = <span class="string">&quot;white&quot;</span></span><br><span class="line"><span class="keyword">let</span> i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  ctx.<span class="property">lineWidth</span> = <span class="number">4</span>;</span><br><span class="line">  ctx.<span class="property">strokeStyle</span> = styles[i];</span><br><span class="line">  <span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, size[i]);</span><br><span class="line">  ctx.<span class="property">lineWidth</span> = <span class="number">5</span>;</span><br><span class="line">  ctx.<span class="property">strokeStyle</span> = styleClear;</span><br><span class="line">  <span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, size[i-<span class="number">3</span>]); </span><br><span class="line">  </span><br><span class="line">  i += <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( i &gt; <span class="number">9</span> ) &#123;</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="day18錯誤處理"><a href="#day18錯誤處理" class="headerlink" title="day18錯誤處理"></a>day18錯誤處理</h3><p>通常錯誤處理的格式為try,catch,throw.</p>
<p>一個字典查詢的功能，這裡用一個陣列來看看如何處理錯誤。當我們有找到值的時候，會回傳這個值，如果沒有就會進行錯誤處理。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkDictionary</span>(<span class="params">key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> words = &#123;</span><br><span class="line">        <span class="string">&#x27;apple&#x27;</span>: <span class="string">&quot;蘋果&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;banana&#x27;</span>: <span class="string">&quot;香蕉&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;peach&#x27;</span>: <span class="string">&quot;桃子&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (words[key]) &#123;</span><br><span class="line">        <span class="keyword">return</span> words[key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>if(words[key]) 的寫法我們從if(wordd[key] !&#x3D; null) 簡化而來，因為null是falsy物件，所以當沒有值時結果會與判斷式寫法相等。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> res = <span class="title function_">checkDictionary</span>(<span class="string">&quot;apple&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;We don\&#x27;t know this world: &quot;</span> + e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//蘋果</span></span><br></pre></td></tr></table></figure>

<p>用try去執行一個function並在裡面加入流程控制，除了正常的功能外，如有錯誤也用throw指令，直接跳往catch進行進一步的處理，傳遞參數可以是任何型態 ，由catch去接收。而當在try中直接發生錯誤或我們沒有使用throw時，發生錯誤<em>不會執行catch裡的功能</em>，所以我們可能無法掌握錯誤的中斷之處。</p>
<blockquote>
<p><strong>所以有try catch的語句一定記得要有throw</strong></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkDictionary</span>(<span class="params">key</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> words = &#123;</span><br><span class="line">        <span class="string">&#x27;apple&#x27;</span>: <span class="string">&quot;蘋果&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;banana&#x27;</span>: <span class="string">&quot;香蕉&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;peach&#x27;</span>: <span class="string">&quot;桃子&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (words[key]) &#123;</span><br><span class="line">        <span class="keyword">return</span> words[key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> key; <span class="comment">//有try catch 一定要有 不然會undefie</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> res = <span class="title function_">checkDictionary</span>(<span class="string">&quot;mongo&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;We don\&#x27;t know this world: &quot;</span> + e);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="day19-chrome-工具"><a href="#day19-chrome-工具" class="headerlink" title="day19 chrome 工具"></a>day19 chrome 工具</h3><p>在chrome在按下<code>F12</code>按下時，會出現debug的工具，有可以設定的選項。</p>
<p>在Performance的部分可以記錄效能，可以勾選記憶體使用以燭幕擷取的選項，它提供數字，畫面甚至圖表資料，讓我們進一步分析程式效能</p>
<h3 id="day20-時間的精度"><a href="#day20-時間的精度" class="headerlink" title="day20 時間的精度"></a>day20 時間的精度</h3><p>一直以來都以為要用 setTimeout 或 setInterval 來製作動畫，但 setTimeout 最快也只能到 10 毫秒，可能造成畫面遺失的問題，而我們就可以用 requestAnimationFrame 這個方法。 一起來看一下 MicroSoft Developer Network 提供的這個例子，在裡面學到不少東西。</p>
<p>說明：<br>window.performance.now 高精準的時間戳，可以取到一毫秒的千分之一<br>elm.style.left &#x3D; ((lpos +&#x3D; 3) % 600) + “px”; 利用累加方式調整矩形位置，並用餘數值來限定範圍<br>requestId &#x3D; window.requestAFrame(render) 計算 requestAFrame 執行的次數， requestAFrame 的回傳值會從 1 開始持續往上累加</p>
<p><a href="https://stackblitz.com/edit/js-p6cism?file=index.html">stackblitz</a></p>
<p>在<code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;animated&quot;</span>&gt;</span>Hello there.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btnstart&quot;</span> &gt;</span>Start<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;bnstop&quot;</span> &gt;</span>Stop<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Import stylesheets</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"><span class="comment">//多瀏覽器的支援</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">cancelAFrame</span> = (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="property">cancelAnimationFrame</span> ||</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">webkitCancelAnimationFrame</span> ||</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">mozCancelAnimationFrame</span> ||</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">oCancelAnimationFrame</span> ||</span><br><span class="line">    <span class="keyword">function</span> (<span class="params">id</span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="built_in">clearTimeout</span>(id);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> requestId = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> startime = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> lpos = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> elm;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;init&quot;</span>);</span><br><span class="line">  elm = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;animated&quot;</span>);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  elm.<span class="property">style</span>.<span class="property">left</span> = ((lpos += <span class="number">3</span>) % <span class="number">600</span>) + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">  requestId = <span class="variable language_">window</span>.<span class="title function_">requestAFrame</span>(render);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">performance</span>.<span class="property">now</span>) &#123;</span><br><span class="line">    startime = <span class="variable language_">window</span>.<span class="property">performance</span>.<span class="title function_">now</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    startime = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  requestId = <span class="variable language_">window</span>.<span class="title function_">requestAFrame</span>(render);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;stop&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (requestId)</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">cancelAFrame</span>(requestId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// handle multiple browsers for requestAnimationFrame()</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">requestAFrame</span> = (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="property">requestAnimationFrame</span> ||</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">webkitRequestAnimationFrame</span> ||</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">mozRequestAnimationFrame</span> ||</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">oRequestAnimationFrame</span> ||</span><br><span class="line">    <span class="comment">// if all else fails, use setTimeout</span></span><br><span class="line">    <span class="keyword">function</span> (<span class="params">callback</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="built_in">setTimeout</span>(callback, <span class="number">1000</span> / <span class="number">60</span>); <span class="comment">// shoot for 60 fps</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;load&quot;</span>, <span class="title function_">init</span>(), <span class="literal">false</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;btnstart&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, start);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;bnstop&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, stop);</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h3 id="day21-DOM"><a href="#day21-DOM" class="headerlink" title="day21 DOM"></a>day21 DOM</h3><p>W3School介紹HTMLDOM時，有一個觀念會被一直強調</p>
<blockquote>
<p>DOM是一個樹狀模型中，所有東西都是結點(node)。所有結點分為ACDET</p>
<ol>
<li>docment根(document)</li>
<li>HTML元素(element)</li>
<li>屬性(attribute)</li>
<li>文字(text)</li>
<li>註解(comment)</li>
</ol>
</blockquote>
<p>當HTML文件被載入瀏覽器的時候，就會產生一個document物件做為根節點。而document物件是所有節點的擁有者，並提供屬性跟方法去操控其它結點。</p>
<p>Elemnt object<br>NodeList object(集合，有序)<br>Att object<br>NamedNodeMap objcet(集合，沒有順序)<br>Style object</p>
<p>思考：<br>Attr Object 和 Style Object 在哪？結果發現自己總是把CSS 調整的 style 跟 HTML 本身的 attribute 搞混。Attribute 是跟 HTML 標籤一起出現的，例如我們使用 placeholder 去提示要輸入的訊息。而屬性分為兩種，content（HTML）跟 IDL (JavaScript)，也可以自定屬性。<a href="https://pjchender.blogspot.tw/2017/01/html-5-data-attribute.html">補充資料。內容為更多屬性介紹，作者：PJ</a></p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes">完整的 attribute 列表</a></p>
<p>說明：<br>當我們開始操控 JS ，我們會使用 document 的方法，去抓取節點。然後用串接（chain）的方式，進行之後動作。下面的例子，我們選取到的不是單一元素，因為有多個 P tag，行程所謂的 Node list ，再藉由 item 去選取到要針對的元素。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">document.getElementsByTagName(&quot;P&quot;).item(0).innerHTML;</span><br></pre></td></tr></table></figure>

<p>所以排下來的順序大概是這樣的：<br>Document &gt; Element + NodeList &gt; Attr + NamedNodeMap + style + DOM Events &gt; style</p>
<h3 id="day22程式邏輯"><a href="#day22程式邏輯" class="headerlink" title="day22程式邏輯"></a>day22程式邏輯</h3><p>上LeetCode去練習程式邏輯，人家所謂的bug就是思考上的缺陷，有時候𤆧法能解，但是思考角度不對，其實就會在測試中出現問題。</p>
<p>下面的例子是給定一個陣列，真一個目標，找尋是否陣列裡有一對元素，相加等於目標數字。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Given nums = [2,7,11,15] ,target =9,</span><br><span class="line">Because nums[0] + num[1] = 2+7 =9</span><br><span class="line">return [0,1]</span><br></pre></td></tr></table></figure>

<p>在這個例子中，當如果輸入兩個不同數字，結果正確。但如果兩個數字相同，就會出現錯誤。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> nums = [<span class="number">3</span>,<span class="number">3</span>]</span><br><span class="line"><span class="keyword">var</span> target = <span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> twoSum = <span class="keyword">function</span>(<span class="params">nums, target</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; target ; i++)</span><br><span class="line">    <span class="keyword">if</span> (nums.<span class="title function_">indexOf</span>(i) + <span class="number">1</span> &amp;&amp; nums.<span class="title function_">indexOf</span>(target - i) + <span class="number">1</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> [nums.<span class="title function_">indexOf</span>(i), nums.<span class="title function_">indexOf</span>(target - i)]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>( i == target - <span class="number">1</span>) &#123;</span><br><span class="line">		  <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Sorry&quot;</span>)</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>而正確的作法應該要用兩個迴圈。以下為pseudocode</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span>[] <span class="title">twoSum</span>(<span class="params"><span class="built_in">int</span>[] nums, <span class="built_in">int</span> target</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = i + <span class="number">1</span>; j &lt; nums.length; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[j] == target - nums[i]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">int</span>[] &#123; i, j &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;No two sum solution&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="day23-Html的ID"><a href="#day23-Html的ID" class="headerlink" title="day23 Html的ID"></a>day23 Html的ID</h3><p>當你在HTML標籤裡宣告ID的時候，其實就同時在JS裡宣告一僤全域變數。</p>
<p>說明：</p>
<p>用不同抓取element的方式(除ID之外)去更改tag裡面的內容，最後用createElement製造一個按鈕，然後用addEventListener去監聽按下的事件來執行。</p>
<p><a href="https://js-uycrnh.stackblitz.io/">stackblitz</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>My Friend<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">&quot;lion&quot;</span> &gt;</span>My Class<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h4</span> <span class="attr">id</span>=<span class="string">&quot;king&quot;</span> &gt;</span>My ID<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Import stylesheets</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> btn =<span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;button&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;h1&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example2 = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;h2&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example3 = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;lion&quot;</span>);</span><br><span class="line"></span><br><span class="line">btn.<span class="property">innerHTML</span>=<span class="string">&quot;按鈕比大顆&quot;</span>;</span><br><span class="line">btn.<span class="property">style</span>.<span class="property">width</span>=<span class="string">&quot;100px&quot;</span>;</span><br><span class="line">btn.<span class="property">style</span>.<span class="property">height</span>=<span class="string">&quot;100px&quot;</span>;</span><br><span class="line">btn.<span class="property">style</span>.<span class="property">background</span>=<span class="string">&quot;yellow&quot;</span>;</span><br><span class="line">btn.<span class="property">style</span>.<span class="property">fontSize</span>=<span class="string">&quot;25px&quot;</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(btn);</span><br><span class="line"></span><br><span class="line">btn.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>,<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">  example[<span class="number">0</span>].<span class="property">innerHTML</span>=<span class="string">&quot;Ha Ha&quot;</span>;</span><br><span class="line">  example2[<span class="number">0</span>].<span class="property">innerHTML</span>=<span class="string">&quot;My My&quot;</span>;</span><br><span class="line">  example3[<span class="number">0</span>].<span class="property">innerHTML</span>=<span class="string">&quot;Hi Hi&quot;</span>;</span><br><span class="line">  <span class="comment">//殺出一個程咬金</span></span><br><span class="line">  king.<span class="property">innerHTML</span> =<span class="string">&quot;Bye Bye&quot;</span>;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到最後一行，其實是直接用&#x3D;&#x3D;ID名稱&#x3D;&#x3D;，沒有getElementById,去串接innerHTML屬性來指派值，卻成功了</p>
<h3 id="day24-html屬性"><a href="#day24-html屬性" class="headerlink" title="day24 html屬性"></a>day24 html屬性</h3><p>釐清一下HTML屬性與JS的關系，如何去叫用HTML裡面的屬性。我們可以把每個HTML tag 想成是一個物件，擁有自已的屬性，並且以element.propertyName的方式叫用。</p>
<p><a href="https://stackblitz.com/edit/js-fz2pzb?file=index.js">stackblitz</a><br>以下例子，去判斷屬性名稱為特定姓名的話，將placeholder裡面的值修改<code>html</code>檔</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;json&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Jason&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;一&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;json&quot;</span> <span class="attr">name</span>=<span class="string">&quot;John&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;二&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;json&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Peter&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;三&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;json&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Jim&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;四&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;json&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Amy&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;五&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;changePlaceholder&quot;</span>&gt;</span>Action<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>js</code>的cdoe</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;changePlaceholder&quot;</span>)[<span class="number">0</span>].<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;INPUT&quot;</span>).<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">node</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">name</span> == <span class="string">&#x27;Jim&#x27;</span>) &#123;</span><br><span class="line">      node.<span class="property">placehlder</span> = <span class="string">&#x27;Jim&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是在HTML裡面他不是一個真實的物件，不是你自已加上名稱就會擁有，所以當我們要自訂屬緎的時候，必須符合它的規則。把資料屬緎在HTML tag裡寫成data-protertyName,並在JS中用element.dataset.propertyName取值</p>
<p>說明：</p>
<p>自訂一個屬性，當按下按金，秀出屬性內容</p>
<p>在<code>html</code>的cdoe</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">data-hint</span>=<span class="string">&quot;insert Data&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Json&quot;</span>&gt;</span>My data<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;showData&quot;</span>&gt;</span>Action<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在jscode</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;showData&quot;</span>)[<span class="number">0</span>].<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> myData = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;H1&quot;</span>)[<span class="number">0</span>].<span class="property">dataset</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(myData);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="day25-抓取輸入"><a href="#day25-抓取輸入" class="headerlink" title="day25 抓取輸入"></a>day25 抓取輸入</h3><p>當熟悉抓element裡面的值之後，就可以把輸入振解成“監聽事件”觸發加上“抓取值”。input就是一個盒子，當事事件觸發的時候，動手去拿裡面的東西。然後清空裡 的東西，才不會盒子看起來髒髒的。</p>
<p><a href="https://stackblitz.com/edit/js-s7frt5?file=index.js">stackblitz</a></p>
<p>說明：<br>最簡易的用兩個HTML tag，包括input與button(甚至只用一個input, 按enter觸發，但記得考慮手機可能會不方便觸發輸入)</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>有沒有頻果的產品<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;現在搜尋&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;showData&quot;</span>&gt;</span>Action<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>說明:<br>input的初始設定placeholder是靠左，且字是與邊框貼齊的，所以我們會使用text-align與padding去調整文字位置與空出邊空的距離。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">insert&#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">padding-right</span>: <span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">15px</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: right;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>說明:</p>
<p>這裡用一個array來暫時記錄apple產品包含的資料，實際資料也可以是接api的資料庫、瀏覽器的localstrage或cookie。於是當我們輸入的時候，用includes去搜尋陣列，回傳true or false，來判斷是否有這個值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> apples = [<span class="string">&#x27;手機&#x27;</span>, <span class="string">&#x27;電腦&#x27;</span>, <span class="string">&#x27;滑鼠&#x27;</span>, <span class="string">&#x27;支付&#x27;</span>, <span class="string">&#x27;電視&#x27;</span>, <span class="string">&#x27;音響&#x27;</span>];</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;showData&quot;</span>)[<span class="number">0</span>].<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> insert = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;insert&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">var</span> result = apples.<span class="title function_">includes</span>(insert.<span class="property">value</span>);</span><br><span class="line">  <span class="keyword">if</span> (result) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;有喔有喔&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;等你發明&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  insert.<span class="property">value</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="day26置換class網頁效能的方法一"><a href="#day26置換class網頁效能的方法一" class="headerlink" title="day26置換class網頁效能的方法一"></a>day26置換class網頁效能的方法一</h3><p>提高網頁效能的方法一用JS置換class。<br>我們做一個checkbox，可以使用加上class的方式，來呈現checked效果。</p>
<p><a href="https://js-rzamqo.stackblitz.io/">stackblitz</a></p>
<p>說明：<br>我們用sprite的方式，來切換”部分”背景圖片，製造圖片切換的效果。而不需要重新載入一個圖片進行切換。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>戳我戳我<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sampleClass&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.sampleClass</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>:<span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">330px</span>;</span><br><span class="line">  <span class="attribute">background</span>:<span class="built_in">url</span>(<span class="string">&#x27;https://image.freepik.com/free-vector/check-and-cross-signs-paint-design_1102-228.jpg&#x27;</span>) no-repeat;</span><br><span class="line">  <span class="attribute">background-position</span>: <span class="number">100%</span> <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">background-size</span>:cover;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.active</span>&#123;</span><br><span class="line">   <span class="attribute">background-position</span>: <span class="number">0%</span> <span class="number">50%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>說明：<br>使用className這個屬性，抓出元素的class名稱字串，再去針對字串處理加減class來達到效果。而下面的程式碼用includes去判斷是否是checked的狀態，也就是有加上active的class，如果有就切換回原本的名稱，如果沒有就加上active。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> checkBar = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;div&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">checkBar.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//console.log(&quot;checkBar.className=&quot;+checkBar.className);</span></span><br><span class="line">  <span class="keyword">if</span> (checkBar.<span class="property">className</span>.<span class="title function_">includes</span>(<span class="string">&quot;active&quot;</span>)) &#123;</span><br><span class="line">    checkBar.<span class="property">className</span> = <span class="string">&quot;sampleClass&quot;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    checkBar.<span class="property">className</span> += <span class="string">&quot; active&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="day27置換css屬性網頁效能的方法二"><a href="#day27置換css屬性網頁效能的方法二" class="headerlink" title="day27置換css屬性網頁效能的方法二"></a>day27置換css屬性網頁效能的方法二</h3><p>用cssText來置換屬性。每當點擊橘色盒子的時候，盒子就會向左偏移。並做一個按鈕可以讓盒子回到原來位置。</p>
<p><a href="https://js-qsgwpj.stackblitz.io/">stackblitz</a></p>
<p>說明：<br>我們把原本的<code>rectangle.style.left = left + &#39;px&#39;;</code><br>置換成<code>rectangle.style.sytle.cssText+=left: $&#123;left&#125;px;</code>來避免reflow</p>
<p>小提醒：<br>因為cssText是直接複寫css內容，所以我們用+&#x3D;累加的方式，將要修改的樣式字串加到後面。</p>
<p>HTML code:</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;move where&quot;</span>&gt;</span>點我向右走<span class="tag">&lt;/<span class="name">dvi</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;reset&quot;</span>&gt;</span>reset<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>CSS code:</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.move</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">line-height</span>:<span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">background</span>:orange;</span><br><span class="line">    <span class="attribute">position</span>:absolute;</span><br><span class="line">    <span class="attribute">top</span>:<span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">cursor</span>:pointer;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="selector-class">.where</span>&#123;</span><br><span class="line">    <span class="attribute">left</span>:<span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.reset</span>&#123;</span><br><span class="line">    <span class="attribute">border-radius</span>:<span class="number">50px</span>; </span><br><span class="line">    <span class="attribute">font-weight</span>:bold;</span><br><span class="line">    <span class="attribute">background</span>:black;</span><br><span class="line">    <span class="attribute">color</span>:white;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JS code:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Import stylesheets</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> left = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">var</span> top = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rectangle = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;where&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> reset = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;reset&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">rectangle.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  left += <span class="number">10</span>;</span><br><span class="line">  rectangle.<span class="property">style</span>.<span class="property">cssText</span> = <span class="string">`left:<span class="subst">$&#123;left&#125;</span>px`</span>;</span><br><span class="line">  <span class="comment">//rectangle.style.left= left+&#x27;px&#x27;;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">reset.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  rectangle.<span class="property">style</span>.<span class="property">cssText</span> = <span class="string">&quot;left:10px&quot;</span>;</span><br><span class="line">  left = <span class="number">10</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="day28處理時間"><a href="#day28處理時間" class="headerlink" title="day28處理時間"></a>day28處理時間</h3><p>javascript如何處理時間</p>
<p><a href="https://js-twvnya.stackblitz.io/">stackblitz</a></p>
<p>在<code>html</code>中</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;time&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;transTime&quot;</span>&gt;</span>現在是幾年<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>javascript</code>中</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> ele = <span class="variable language_">document</span>.<span class="title function_">getelementsByClassName</span>(<span class="string">&quot;time&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> trans = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;transTime&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getFullYear</span>()</span><br><span class="line">ele.<span class="property">innerHTML</span>= now;</span><br><span class="line">trans.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    now = now - <span class="number">1911</span>;</span><br><span class="line">    ele.<span class="property">innerHTML</span> = <span class="string">&#x27;民 &#x27;</span>+now;</span><br><span class="line">    trans.<span class="property">disabled</span> = <span class="string">&#x27;disabled&#x27;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="day29-一些小技巧"><a href="#day29-一些小技巧" class="headerlink" title="day29 一些小技巧"></a>day29 一些小技巧</h3><blockquote>
<p> 總要進步，總能更好，保持學習。</p>
</blockquote>
<p>以下一個清除陣列的小技巧</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">list.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list);</span><br><span class="line"><span class="comment">//[]</span></span><br></pre></td></tr></table></figure>

<p>下一步，JS框架。<br>思考：為什麼要用框架?<br>如果只是寫JS的一些小東西，可能不需要用到框架。但當專案的規模越來越大，更需要有效的管理程式碼，考慮擴展與降低重複問題。很多東西是一體的兩面，框架用得好可以幫助我們產生更好的成果與增加可維謢性，用得不好可能綁手綁腳，本末導致。除了規模上的總則，選擇框架也會考慮技術的成熟度，社群的支援度，甚至是學習曲線。而下面是始一個Vue.js的例子。</p>
<p>說明：</p>
<p>兩個大括號中間是渲染的文字，然後把資料分離到JS裡面。data的部分就是儲存文字資料的地方。所以當我們之後要改變資料內容。就不需要直接改html畫面的檔案，而是去調整JS裡的資料內容，</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    &#123;&#123; text &#125;&#125; Nice to meet Vue.</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line"> <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line"> <span class="attr">data</span>: &#123;</span><br><span class="line">   <span class="attr">text</span>: <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>





















































































































<h6 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h6><p><a href="https://ithelp.ithome.com.tw/users/20107703/ironman/1489">一個 JS 學習者的日常 共 30 篇</a></p>
<p><a href="https://rxjs-dev.firebaseapp.com/api">https://rxjs-dev.firebaseapp.com/api</a></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>javascript</category>
      </categories>
      <tags>
        <tag>javascript</tag>
      </tags>
  </entry>
  <entry>
    <title>學習ES2015(ES6)的相關知識</title>
    <url>/%E5%AD%B8%E7%BF%92ES2015-ES6-%E7%9A%84%E7%9B%B8%E9%97%9C%E7%9F%A5%E8%AD%98/%E5%AD%B8%E7%BF%92ES2015-ES6-%E7%9A%84%E7%9B%B8%E9%97%9C%E7%9F%A5%E8%AD%98/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p> 這是參考網路上的小馬有介紹一些ES6的語法和使用，記錄一下<br> <span id="more"></span> </p>
<p><a href="https://gitee.com/komavideo/LearnES6">參考的程式碼</a></p>
<p><a href="https://stackblitz.com/edit/js-b7seqg">程上測試</a></p>
<h2 id="Symbol新類型"><a href="#Symbol新類型" class="headerlink" title="Symbol新類型"></a>Symbol新類型</h2><ul>
<li>ES6增加了Symbol 新的原始類型</li>
</ul>
<p>實戰演習</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//#region Symbol新類型</span></span><br><span class="line"><span class="keyword">let</span> str1 = <span class="title class_">String</span>(<span class="string">&quot;HelloWorld&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> str2 = <span class="title class_">String</span>(<span class="string">&quot;HelloWorld&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str1 == str2); <span class="comment">//結果 true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str1 === str2); <span class="comment">//結果 true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> s1 = <span class="title class_">Symbol</span>(<span class="string">&quot;mySymbol&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> s2 = <span class="title class_">Symbol</span>(<span class="string">&quot;mySymbol&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> s1); <span class="comment">//結果 symbol</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s1.<span class="title function_">toString</span>()); <span class="comment">// 結果 Symbol(mySymbol)</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s1 == s2); <span class="comment">//結果 false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s1 === s2); <span class="comment">//結果 false</span></span><br><span class="line"><span class="comment">//#endregion Symbol新類型</span></span><br></pre></td></tr></table></figure>

<h2 id="Symbol的用法"><a href="#Symbol的用法" class="headerlink" title="Symbol的用法"></a>Symbol的用法</h2><ul>
<li>作為常量</li>
<li>作為屬性</li>
<li>半隱藏屬性</li>
</ul>
<p>實戰演習</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//#region Symbol的用法</span></span><br><span class="line"><span class="comment">//作為常量</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Java</span> = <span class="title class_">Symbol</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Ruby</span> = <span class="title class_">Symbol</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Perl</span> = <span class="title class_">Symbol</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Php</span> = <span class="title class_">Symbol</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">VB</span> = <span class="title class_">Symbol</span>();</span><br><span class="line"><span class="keyword">let</span> lang = <span class="title class_">Php</span>;</span><br><span class="line"><span class="keyword">if</span> (lang === <span class="title class_">Java</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Java的未來在哪裏?&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (lang === <span class="title class_">Ruby</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;再學個Ruby on Rails吧。&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//作為屬性</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> s1 = <span class="title class_">Symbol</span>(<span class="string">&quot;mySymbol&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> s2 = <span class="title class_">Symbol</span>(<span class="string">&quot;mySymbol&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> obj = &#123;&#125;;</span><br><span class="line">obj[s1] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">obj[s2] = <span class="string">&quot;world&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj); <span class="comment">//&#123;Symbol(mySymbol): &quot;hello&quot;, Symbol(mySymbol): &quot;world&quot;&#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj[s1]); <span class="comment">//hello</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj[s2]); <span class="comment">//world</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//半隱藏屬性</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MYKEY</span> = <span class="title class_">Symbol</span>();</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">key, name, age</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>[<span class="variable constant_">MYKEY</span>] = key;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">age</span> = age;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">checkKEY</span>(<span class="params">key</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>[<span class="variable constant_">MYKEY</span>] === key;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> user = <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">123</span>, <span class="string">&quot;Curry&quot;</span>, <span class="number">29</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">name</span>, user.<span class="property">age</span>, user[<span class="variable constant_">MYKEY</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="title function_">checkKEY</span>(<span class="number">123</span>)); <span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="title function_">checkKEY</span>(<span class="number">456</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">keys</span>(user));<span class="comment">//[&quot;name&quot;, &quot;age&quot;]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user));<span class="comment">//&#123;&quot;name&quot;:&quot;Curry&quot;,&quot;age&quot;:29&#125;</span></span><br><span class="line"><span class="comment">//#endregion Symbol的用法</span></span><br></pre></td></tr></table></figure>





<h2 id="解構賦值-destructuring-assigment"><a href="#解構賦值-destructuring-assigment" class="headerlink" title="解構賦值(destructuring assigment)"></a>解構賦值(destructuring assigment)</h2><p>實戰演習</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//數組賦值</span></span><br><span class="line"><span class="keyword">let</span> [a, b ,c] = [<span class="number">10</span> ,<span class="number">20</span> ,<span class="number">30</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, c); <span class="comment">// 10 20 30</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> [x, y, ...other] = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(x, y, other); <span class="comment">// 1 2 [3, 4, 5]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//對象賦值</span></span><br><span class="line"><span class="keyword">let</span> &#123;name , age&#125; = &#123; <span class="attr">name</span>: <span class="string">&#x27;ttom&#x27;</span>, <span class="attr">age</span>: <span class="string">&#x27;30&#x27;</span>&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(name , age);</span><br><span class="line"></span><br><span class="line"><span class="comment">//函數賦值</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">func1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="number">10</span>,<span class="number">20</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> [num1,num2]= <span class="title function_">func1</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(num1,num2);</span><br><span class="line"></span><br><span class="line"><span class="comment">//函數參數名指定</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">func2</span>(<span class="params">&#123;x=<span class="number">1</span>,y=<span class="number">2</span>&#125;</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> x+y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">func2</span>(&#123;&#125;));          <span class="comment">//3</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">func2</span>(&#123;<span class="attr">x</span>:<span class="number">10</span>&#125;));      <span class="comment">//12</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">func2</span>(&#123;<span class="attr">y</span>:<span class="number">10</span>&#125;));      <span class="comment">//11</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">func2</span>(&#123;<span class="attr">x</span>:<span class="number">10</span>,<span class="attr">y</span>:<span class="number">20</span>&#125;)); <span class="comment">//30</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="可迭代的對象"><a href="#可迭代的對象" class="headerlink" title="可迭代的對象"></a>可迭代的對象</h2><ul>
<li>制作一個可迭代的對象</li>
<li>Symbol.iterator</li>
</ul>
<p>實戰演習</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//#region 可迭代的對象</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">list</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">list</span> = list;</span><br><span class="line">  &#125;</span><br><span class="line">  [<span class="title class_">Symbol</span>.<span class="property">iterator</span>]() &#123;</span><br><span class="line">    <span class="keyword">let</span> current = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> that = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="title function_">next</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> current &lt; that.<span class="property">list</span>.<span class="property">length</span></span><br><span class="line">          ? &#123; <span class="attr">value</span>: that.<span class="property">list</span>[current++], <span class="attr">done</span>: <span class="literal">false</span> &#125;</span><br><span class="line">          : &#123; <span class="attr">done</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> player = <span class="keyword">new</span> <span class="title class_">Player</span>([<span class="string">&quot;Curry&quot;</span>, <span class="string">&quot;Harden&quot;</span>, <span class="string">&quot;LeBron&quot;</span>]);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> tmp <span class="keyword">of</span> player) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(tmp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//#endregion 可迭代的對象</span></span><br></pre></td></tr></table></figure>



<h2 id="簡單迭代生成器"><a href="#簡單迭代生成器" class="headerlink" title="簡單迭代生成器"></a>簡單迭代生成器</h2><ul>
<li>function* {} :迭代生成器</li>
<li>yield : 迭代返回</li>
</ul>
<p>實戰演習</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//#region 簡單迭代生成器</span></span><br><span class="line"><span class="keyword">function</span>* <span class="title function_">myGenerator</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">&quot;一&quot;</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">&quot;條&quot;</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">&quot;大&quot;</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">&quot;河&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> val <span class="keyword">of</span> <span class="title function_">myGenerator</span>()) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(val);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span>* <span class="title function_">countdown</span>(<span class="params">begin</span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (begin &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">yield</span> begin--;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> tmp <span class="keyword">of</span> <span class="title function_">countdown</span>(<span class="number">5</span>)) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(tmp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//#endregion 簡單迭代生成器</span></span><br></pre></td></tr></table></figure>

<h2 id="簡單迭代類"><a href="#簡單迭代類" class="headerlink" title="簡單迭代類"></a>簡單迭代類</h2><ul>
<li>建立一個單的迭代類(yield)</li>
</ul>
<p>實戰演習</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//#region 簡單迭代類</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyList</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">list</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">list</span> = list;</span><br><span class="line">    <span class="variable language_">this</span>[<span class="title class_">Symbol</span>.<span class="property">iterator</span>] = <span class="keyword">function</span>*() &#123;</span><br><span class="line">      <span class="keyword">let</span> current = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">let</span> that = <span class="variable language_">this</span>;</span><br><span class="line">      <span class="keyword">while</span> (current &lt; that.<span class="property">list</span>.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">yield</span> that.<span class="property">list</span>[current++];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> mylist = <span class="keyword">new</span> <span class="title class_">MyList</span>([<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>, <span class="number">400</span>, <span class="number">500</span>]);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> val <span class="keyword">of</span> mylist) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(val);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//#endregion 簡單迭代類</span></span><br></pre></td></tr></table></figure>

<h2 id="模塊化設計"><a href="#模塊化設計" class="headerlink" title="模塊化設計"></a>模塊化設計</h2><ul>
<li>建立一個模塊</li>
<li>調用模塊功能</li>
</ul>
<p>建立模塊 mymath.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">x, y</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">minus</span>(<span class="params">x, y</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> x - y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> &#123; add, minus &#125;;</span><br></pre></td></tr></table></figure>

<p>使用模塊</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//#region 模塊化設計</span></span><br><span class="line"><span class="keyword">import</span> &#123; add, minus &#125; <span class="keyword">from</span> <span class="string">&quot;./mymath&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">add</span>(<span class="number">10</span>, <span class="number">20</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">minus</span>(<span class="number">30</span>, <span class="number">20</span>));</span><br><span class="line"><span class="comment">//#endregion 模塊化設計</span></span><br></pre></td></tr></table></figure>

<h2 id="類模塊設計"><a href="#類模塊設計" class="headerlink" title="類模塊設計"></a>類模塊設計</h2><ul>
<li>類模設計和引用</li>
</ul>
<p>建立類文件Player.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//#region 類模塊設計</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Player</span> <span class="keyword">from</span> <span class="string">&quot;./Player&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> curry = <span class="keyword">new</span> <span class="title class_">Player</span>(<span class="string">&quot;Curry&quot;</span>);</span><br><span class="line">curry.<span class="title function_">sayHello</span>();</span><br><span class="line"><span class="comment">//#endregion 類模塊設計</span></span><br></pre></td></tr></table></figure>

<p>使用類模塊</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//#region 類模塊設計</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Player</span> <span class="keyword">from</span> <span class="string">&quot;./Player&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> curry = <span class="keyword">new</span> <span class="title class_">Player</span>(<span class="string">&quot;Curry&quot;</span>);</span><br><span class="line">curry.<span class="title function_">sayHello</span>();</span><br><span class="line"><span class="comment">//#endregion 類模塊設計</span></span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>前端</category>
        <category>javascript</category>
      </categories>
      <tags>
        <tag>javascript</tag>
      </tags>
  </entry>
  <entry>
    <title>學習你懂JavaScirpt嗎?</title>
    <url>/%E5%AD%B8%E7%BF%92%E4%BD%A0%E6%87%82JavaScirpt%E5%97%8E/%E5%AD%B8%E7%BF%92%E4%BD%A0%E6%87%82JavaScirpt%E5%97%8E/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>這是參考這是參考2019 iT 邦幫忙鐵人賽的<a href="https://ithelp.ithome.com.tw/users/20092232/ironman/1612">你懂 JavaScript 嗎？</a>這篇文章來學習和記錄</p>
<h3 id="你懂JavaScript嗎？運算子、運算式、值與型別、變數、條件式、迴圈"><a href="#你懂JavaScript嗎？運算子、運算式、值與型別、變數、條件式、迴圈" class="headerlink" title="你懂JavaScript嗎？運算子、運算式、值與型別、變數、條件式、迴圈"></a>你懂JavaScript嗎？運算子、運算式、值與型別、變數、條件式、迴圈</h3><p>這裏主要內容為程式設計簡介，在此可看到初䌣階段所必須理解的各種專有名詞。</p>
<h4 id="程式碼-Code"><a href="#程式碼-Code" class="headerlink" title="程式碼(Code)"></a>程式碼(Code)</h4><p>程式(program)又稱原始碼(source cde)、程式碼(code)、用來表示一群執行特定工作的指令，也可以說是述句組成的集合。</p>
<h4 id="語法-Syntab"><a href="#語法-Syntab" class="headerlink" title="語法(Syntab)"></a>語法(Syntab)</h4><p>規範有交指令與組合的規則，稱為電腦語言(computer language)或語法(syntax)。可想成若希望能編寫電腦可懂的語言，就必須遵循一套規則來撰寫，而這個規則𣄵是語法，就和我們平常溝通所說的語言的文法是一樣的。</p>
<h4 id="述句-Statement"><a href="#述句-Statement" class="headerlink" title="述句(Statement)"></a>述句(Statement)</h4><p>會執行特定工作的字詞、數字或運算子(operator)組合，即是述句(statement)，例如:<code>a = b+1</code>就會執行<code>b+1</code>並將結果指定給a。</p>
<h4 id="字面值-Literal-Value"><a href="#字面值-Literal-Value" class="headerlink" title="字面值(Literal Value)"></a>字面值(Literal Value)</h4><p>獨立存在的值， 沒有存在於任何變數中，到如:<code>a = b + 1</code>中的1。</p>
<h4 id="直譯器-Interpreter-與編譯器-Compiler"><a href="#直譯器-Interpreter-與編譯器-Compiler" class="headerlink" title="直譯器(Interpreter)與編譯器(Compiler)"></a>直譯器(Interpreter)與編譯器(Compiler)</h4><p>直譯器與編譯器可將程式碼由上到下逐行轉為電腦可懂的命令。其差別在於時機點</p>
<ul>
<li><p>直譯(interpret)：在程式執行「時」做轉換。</p>
</li>
<li><p>編譯(compile)：在程式執行「前」做轉換，然後會產出編譯後的指令，因此之後執行的是這個編譯後的結果。注意，JavaScript引擎在每次執行前即時編譯程式碼，接著立刻執行編譯後的指令。</p>
</li>
</ul>
<h4 id="運算子-Operaors"><a href="#運算子-Operaors" class="headerlink" title="運算子(Operaors)"></a>運算子(Operaors)</h4><p>對變數或值進行操作的字元，例如：<code>a = b + 1</code>中的<code>=</code>和<code>+</code>。</p>
<p>JavaScript有以下幾種運算子。</p>
<ul>
<li><p>指定運算子(assignment)：其實就是等號運算子(<code>=</code>)來進行「指定」的工作，當計算完畢等號右邊的值後，接著將結果放進等號左邊的變數，這個戶進去的動作就是指定。例如：<code>a = b +1</code>，就是將<code>b + 1</code>的結果放到a。</p>
</li>
<li><p>算數運算子(math):進行加(<code>+</code>)減(<code>-</code>)乘(<code>*</code>)除(<code>/</code>)的運算，例如:<code>b + 1</code>。</p>
</li>
<li><p>複合指定運算子(compound assignment):<code>+=</code>、<code>-=</code>、<code>*=</code>和<code>/=</code>將算術運算子和指定運算子結合在一起，例如:<code>a += 1</code>, 等同於<code>a = a + 1</code>。</p>
</li>
<li><p>遞增運算子(increment&#x2F;decrement):<code>++</code>(遞增)與<code>--</code>(遞減),例如<code>a++</code>，等同於<code>a= a+1</code>。</p>
</li>
<li><p>物件特性的存取運算子(object property access:):利用<code>.</code>(點記號法，dot notation)或<code>[]</code>(方括號記號法，bracket notation)的方式存取物件的特性，例如:<code>obj.a</code>或<code>obj[&#39;a&#39;]</code> ，<code>.</code>因為簡單便利較常使用，但<code>[]</code>卻可在索引值是變數或有特殊字元時能保證完成值的存取，例如:<code>obj[]&#39;h e l l o&#39;</code>(有空白)、<code>obj[&#39;#$%^&amp;&#39;]</code>(特殊字元)、<code>obj[&#39;123&#39;]</code>(開頭為數字)。𠯌想了解命名規則，待變數命名的部分會再詳述。</p>
</li>
<li><p>相等性運算子(equality):可分為<code>==</code>(寬鬆相等)、<code>===</code>(嚴格相等)、<code>！=</code>(寬鬆不相等)、<code>!==</code>(嚴格不相等)，主要差異是做值的比較時是否會做強制轉型。</p>
</li>
<li><p>比較運算子(comparison):<code>&lt;</code>(小於)、<code>&gt;</code>(大於) 、<code>&lt;=(小於等於)</code>、<code>&gt;=(大於等於)</code>例如:<code>a &gt; b</code>表示比較a是否大於b。注意比較結果一定會是布林值。</p>
</li>
<li><p>邏輯運算子(logical):<code>&amp;&amp;</code>(and)、<code>||</code>(or)，例如:<code>a || b</code>表示選擇a或b，常用於表達複合條件，設定初始值。</p>
</li>
<li><p>位元運算子(bitwise):將運算元當成32位元的0和1來看待，位元運算子將運算元以二進位的方式處㻫，接著以JavaScript數字型態回傳結果。例如:<code>5 &amp; 1</code>會被看成<code>0101 &amp; 0001</code>，得到結果0001，回傳1。 <a href="https://www.w3schools.com/js/js_bitwise.asp">點此</a>看更多範例。</p>
</li>
<li><p>字串運算子(string)：<code>+</code>可串接兩字元，並回傳結果，通常用連接變數與字串。不過目前改用ES6的字串模板(string template)了，使用<code>$&#123; variable_name&#125;</code>即可代入變數，而不需再用<code>+</code>與雙&#x2F;單引號拼湊字串，方便許多，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> name = <span class="string">&#x27;Summer&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用字串運算子</span></span><br><span class="line"><span class="keyword">const</span> greetings_1 = <span class="string">&#x27;Hello &#x27;</span> + name + <span class="string">&#x27;!&#x27;</span>; <span class="comment">// &quot;Hello Summer!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用字串模板</span></span><br><span class="line"><span class="keyword">const</span> greetings_2 = <span class="string">`Hello <span class="subst">$&#123;name&#125;</span>!`</span>; <span class="comment">// &quot;Hello Summer!&quot;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>條件(三元)運算子(conditional&#x2F;ternary):條件(三元)運算子接再兩個運算元作為值且一個運算元作為條件。語法是<code>條件?值1：值2</code>。若「條件」為true，運算子回值「值1」,否則回傳「值2」。如下，條件<code>count &lt;= 0</code>得到false, 因此得到prompt為還有存貨」。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> prompt = count &lt;= <span class="number">0</span> ? <span class="string">&#x27;全部賣完了&#x27;</span> : <span class="string">&#x27;還有存貨&#x27;</span>;</span><br><span class="line"></span><br><span class="line">prompt <span class="comment">// &quot;還有存貨&quot;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>逗點運算子(comma):<code>,</code>用來隔開多個運算式並由左至右循序執行，最後會回傳最右邊的運算式的結果，通常用於(1)for迴圈內部，讓多個變數能在每次迴圈中被更新;(2)變數宣告。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>, j = <span class="number">10</span>; i &lt; j; i++, j--) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`i: <span class="subst">$&#123;i&#125;</span>, j: <span class="subst">$&#123;j&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// i: 0, j: 10</span></span><br><span class="line"><span class="comment">// i: 1, j: 9</span></span><br><span class="line"><span class="comment">// i: 2, j: 8</span></span><br><span class="line"><span class="comment">// i: 3, j: 7</span></span><br><span class="line"><span class="comment">// i: 4, j: 6</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>一元運算子(unary):一元運算是只需要一個運算元的運算，例如:delete 運算子可刪除(隱式宣告的)物件，物件的(非內建)屬性或陣列中經由指定索引而找到的物件。其他的一元運算子還有typeof等。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> x = <span class="number">1</span>;</span><br><span class="line">y = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> product = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;apple&#x27;</span>,</span><br><span class="line">  <span class="attr">count</span>: <span class="number">100</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> x <span class="comment">// false</span></span><br><span class="line">x <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> y <span class="comment">// true</span></span><br><span class="line">y <span class="comment">// Uncaught ReferenceError: y is not defined</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> product.<span class="property">count</span> <span class="comment">// true</span></span><br><span class="line">product <span class="comment">// &#123;name: &quot;apple&quot;&#125;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>關係運算子(relational)：關係運算子比較兩運算元並根據比較結果回傳布林值。例如：in運算子可得知特定屬性是否存在於物件中，instanceof可用來判斷是否為指定的物件型別。</p>
<p>in 運算子的範例。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> product = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;apple&#x27;</span>,</span><br><span class="line">  <span class="attr">count</span>: <span class="number">100</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;name&#x27;</span> <span class="keyword">in</span> product <span class="comment">// true</span></span><br><span class="line"><span class="string">&#x27;valid&#x27;</span> <span class="keyword">in</span> product <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>instanceof運算子的範例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">product <span class="keyword">instanceof</span> <span class="title class_">Object</span> <span class="comment">// true</span></span><br><span class="line">product <span class="keyword">instanceof</span> <span class="title class_">Array</span> <span class="comment">// false</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="運算式-Expression"><a href="#運算式-Expression" class="headerlink" title="運算式(Expression)"></a>運算式(Expression)</h4><p>  對「某個變數或值，或以運算子結合起來的一組變數或值」的參考(reference)。例如:<code>a = b+1</code>這個述句中有四個運算式，分別是1、b、<code>b +1</code>、<code>a = b + 1</code>，其中1是字面值運算式(literal value expression)、b是變數運算式(variable expression)用來取得變數的值、<code>b + 1</code>是算術運算式(arithmetic expression)用來進行加法運算，<code>a = b + 1</code>是指定遲算式(assignment expression)用來將結果指定給變數存起來。這裡順道一提「呼叫運算式（call expression）」，意即函式呼叫運算式本身，例如：<code>alert(a)</code></p>
<h4 id="值與型別-Values-Types"><a href="#值與型別-Values-Types" class="headerlink" title="值與型別(Values&amp;Types)"></a>值與型別(Values&amp;Types)</h4><p>型別，指的是「值的不同的表示法」，主要分為兩種「基本型別」(pirmitives, 即number、string、boolean、null、undefined、symbol)和「物件型別」(object)。</p>
<h5 id="基本型別-Primitive-Types"><a href="#基本型別-Primitive-Types" class="headerlink" title="基本型別(Primitive Types)"></a>基本型別(Primitive Types)</h5><ul>
<li><p>number 數字，例如：12345。</p>
</li>
<li><p>string 字串，例如:<code>Hello World</code></p>
</li>
<li><p>boolean 布林，例如：true、false。</p>
</li>
<li><p>null</p>
</li>
<li><p>undefined</p>
</li>
<li><p>symbol</p>
</li>
</ul>
<h5 id="物件型別"><a href="#物件型別" class="headerlink" title="物件型別"></a>物件型別</h5><p>除了基本型別外的資料型別都是物件，物件型別又分以下子型別</p>
<ul>
<li><p>array 陣列：使用數值化索引來儲存值，而非如物件是使用屬性來儲存值。</p>
</li>
<li><p>function函式：一個函式是指一段具名的程式碼片段，我們可藉由呼叫其名稱來執行它，可簡化重複進行的工作會包裝特定功能的程式碼，並且函式可接受參數、回傳值。這裡會牽涉到另一個概念「範疇（Scope）」，範疇是指一群變數或這些變數如何透過名稱來存取的規範而組成的一個集合，關於範疇之後會再詳述。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">sayHi</span>(<span class="string">&quot;Jack&quot;</span>);<span class="comment">// Hi, I am Jack</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>date 日期</p>
</li>
</ul>
<h5 id="在型別之間進行轉換-Converting-Between-Types"><a href="#在型別之間進行轉換-Converting-Between-Types" class="headerlink" title="在型別之間進行轉換(Converting Between Types)"></a>在型別之間進行轉換(Converting Between Types)</h5><p>我們有時候會需要將資料在不同型別間轉換，例如，遇到在表單中輸入一連串的金額(此時是字串)，接著計算金額時就會希望將這些字串轉成數字來做加減乘除的操作，這時候就可能需要做轉型，從字串轉成數字。</p>
<p>例如、小明在蝦X買了一件商品準備在母親節送給媽媽，並選擇貨到付款。來看看商品金額、運費和總金額，商品金額(product)是100(以定串型態存在)，運費(shipment)也同樣是100(以數字型態存在)，𫍇時候總金額total是？</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> product = <span class="string">&quot;100&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> shipment = <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p>咦？怎麼會正100100！</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> total = product + shipment;</span><br></pre></td></tr></table></figure>

<p>原來是因為若兩值資料型別不同，當其中一方是字串，<code>+</code>所代表的就是字串運算子，而將數字強制轉型為字串，並連接兩個字串。解決就是使用Number強制轉型(coerce)，將字串的部份轉為數字就可以做數學運算了。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> product = <span class="string">&quot;100&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> shipment = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">const</span> total = <span class="title class_">Number</span>(product) + shipment;<span class="comment">//200</span></span><br></pre></td></tr></table></figure>

<p>除了強制轉型，來看在比較兩個非相同型別的值時候會發生隱含的(implicit)轉型。</p>
<p>例如，小明想要比較買這個商品付這運費划算嗎？運費該不會比商品還貴吧？</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> product = <span class="string">&quot;100&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> shipment = <span class="number">100</span>;</span><br><span class="line">product === shipment <span class="comment">// false</span></span><br><span class="line">product == shipment <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>咦？一個是字串，一個是數字，是怎麼能做比較？這是由於JavaScript偷偷做了(隱含的)轉型的原因，那…到底做了什麼呢?</p>
<ul>
<li><p><code>product === shipment</code> : 不做轉型，因此型別對比較是有影響的。</p>
</li>
<li><p><code>product == shipment</code> : 會強轉型，規則是(1)布林轉數字；(2)字串轉數字；(3)使用<code>valueOf()</code>將物件取 基本型別的值，再做比較。關於強型轉型的詳細說明之後會再詳述或參考<a href="http://www.ecma-international.org/ecma-262/5.1/#sec-11.9.3">規格</a>。</p>
<p>小明看到商品價格與運費居然相等，還是先湊個免運再買吧！</p>
</li>
</ul>
<h5 id="typeof"><a href="#typeof" class="headerlink" title="typeof"></a>typeof</h5><p>typeof 可用於檢測值的型別是什麼。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="string">&quot;Hello World&quot;</span>);<span class="comment">// string</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">true</span>);<span class="comment">// boolean</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="number">12345678</span>);<span class="comment">// number</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">null</span>);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">undefined</span>);<span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> &#123; <span class="attr">name</span>: <span class="string">&quot;jack&quot;</span> &#125;);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">Symbol</span>());<span class="comment">// symbol</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;);<span class="comment">// function</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);<span class="comment">// objcet</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">NaN</span>);<span class="comment">// number</span></span><br></pre></td></tr></table></figure>

<p>這裡會看到幾個有趣的(奇怪的)地方…</p>
<ul>
<li><p>null 是基本型別之一，但<code>typeof null</code>卻得到object,而非null!這可說是一個bug，可是若因為修正了這個bug，則可能會導致很多網站壞掉，因此就不修了！</p>
</li>
<li><p>雖然說function是物件的子型別，但<code>typeof functon()&#123;&#125;</code>是得到function而非object, 和陣列依舊得到object是不一樣的。</p>
</li>
<li><p>NaN表是是無效的數字，但依舊還是數字，因此在資料型別的檢測<code>typeof NaN</code>結果就是number。不要被字面上的意思「不是數字」(not a number)給弄糊塗了。另外，NaN與依何數字運算都會得到NaN，並且NaN不大於，不小於也不等於任何數字，包含NaN它自已。</p>
</li>
</ul>
<h5 id="內建方法-Built-In-Type-Methods"><a href="#內建方法-Built-In-Type-Methods" class="headerlink" title="內建方法(Built-In Type Methods)"></a>內建方法(Built-In Type Methods)</h5><p>意即物件以屬性(或稱方法)的形式對外提供的行為，例如</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> prompt = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(prompt.<span class="property">length</span>);<span class="comment">//11</span></span><br></pre></td></tr></table></figure>

<p>  這背後的原因是每個型基本上都會其物件包裏器(object wrapper,又稱原生natives)的型態做對應使用，例如資料別string的物件包裹器型態就是String，而就是這個包裹器型態在其原型(prototype)上定義了許多屬性和方法，因此這些資料型態就能和物件般擁有屬性和方法以供使用。</p>
<h5 id="相等性與不等性"><a href="#相等性與不等性" class="headerlink" title="相等性與不等性"></a>相等性與不等性</h5><h6 id="相等性-Equality"><a href="#相等性-Equality" class="headerlink" title="相等性(Equality)"></a>相等性(Equality)</h6><p>關於相等性的運算子有四個「<code>==</code>」(寬鬆相等性loose equality)、「<code>===</code>」(嚴格相等性strict equality) 、「<code>!=</code>」和「<code>!==</code>」。寬鬆與嚴格的差異在於檢查值相等時是否會做強制轉型，<code>==</code>會做強制轉型，而<code>===</code>不會。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a =<span class="string">&#x27;100&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a == b);<span class="comment">// true 強制轉型，將字串 &#x27;100&#x27; 轉為數字 100</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a ===b);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>另外，關於值的儲存方式有傳值「pass by value」和傳址&#x2F;參考「pass by referece」兩種，其中pass by value又可再細分是否為「pass by sharing」（可參考<a href="https://blog.techbridge.cc/2018/06/23/javascript-call-by-value-or-reference/">這篇</a>）、基本型別是值，而物件型別是傳址。當比較兩物件時，比較的是儲存的位置，因此看起來是相同的物件，但比較結果卻是不相同的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">const</span> b = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a == b);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a === b);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<h6 id="不等性-Inequality"><a href="#不等性-Inequality" class="headerlink" title="不等性(Inequality)"></a>不等性(Inequality)</h6><p>關於不等於性的比較運算子有<code>&gt;</code>、<code>&lt;</code>、<code>&gt;=</code>、<code>&lt;=</code>共四種，在這裡有幾種狀況需要注意</p>
<ul>
<li><p>若比較的值都是字串，則以字典的字母順序為主。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ab&quot;</span> &lt; <span class="string">&quot;cd&quot;</span>);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>若比較的值型別不同，由於值的不等性比較沒有嚴格不相等這重性況，因此，為論什麼樣的比較都會被強制轉型為數字，無法轉為數字的就會變成NaN。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;99&quot;</span> &gt; <span class="number">98</span>);<span class="comment">//true, 字串&quot;99&quot;被強昀轉型為數字 99</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello World&quot;</span> &gt; <span class="number">1</span>);<span class="comment">//false 字串&quot;Hello World&quot; 無法轉為數字，變成NaN</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello World&quot;</span> &lt; <span class="number">1</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello World&quot;</span> = <span class="number">1</span>);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>NaN不大於、不小於、不等於任何值，當然也不等於自已。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">NaN</span> &gt; <span class="title class_">NaN</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">NaN</span> &lt; <span class="title class_">NaN</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">NaN</span> === <span class="title class_">NaN</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">NaN</span> == <span class="title class_">NaN</span>);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<h4 id="程式碼註解-code-Comments"><a href="#程式碼註解-code-Comments" class="headerlink" title="程式碼註解(code Comments)"></a>程式碼註解(code Comments)</h4><p><code>//</code>和<code>/*...*/</code>。</p>
<p>程式碼註解有多重要就不用再提了吧！</p>
</li>
</ul>
<h4 id="變數-Variables"><a href="#變數-Variables" class="headerlink" title="變數(Variables)"></a>變數(Variables)</h4><p>變數是儲存值的地方，又稱為符號佔位器(symbolic placeholder),例如：<code>a = b + 1</code>中的a和b。變數的作用是「管理程式的狀態」，讓我們能將程式中各種會變動的狀態(也就是值)存起來並搭配運算子組成運算式做一些運算。注意，JavaScript是弱型別的語言，意即宣告變數，賦值後仍可改變值的資料型別。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 用 var 宣告一個物件</span></span><br><span class="line"><span class="keyword">var</span> product = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;apple&#x27;</span>,</span><br><span class="line">  <span class="attr">count</span>: <span class="number">100</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用 let 宣告一個有作用域限制的變數，範圍限於大括號內</span></span><br><span class="line"><span class="keyword">let</span> name = <span class="string">&#x27;Nina&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="常數-Constants"><a href="#常數-Constants" class="headerlink" title="常數(Constants)"></a>常數(Constants)</h4><p>ES6使用<code>const</code>來宣告常數，代表這變數的值不會改變，在嚴格模式下還會報錯。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">onst <span class="variable constant_">PI</span> = <span class="number">3.14</span>;</span><br></pre></td></tr></table></figure>

<h4 id="命名規則"><a href="#命名規則" class="headerlink" title="命名規則"></a>命名規則</h4><p>變數的命名必須要為有效的識別字，何謂有效？就是必須以a-z、A-Z、<code>$</code>(錢字號)或<code>_</code>(底線)開頭，之後可加上a-z、A-Z、<code>$</code>(錢字號)、<code>_</code>(底線)和數字0-9，並且不可以是關鍵字或保留字。變數的命名規則同樣也適用於物件特性的命名，只是物件特性的名稱可為關鍵字或保留字。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> happy = <span class="string">&#x27;happy&#x27;</span>; <span class="comment">// 這是合法的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> @@ = <span class="string">&#x27;sad&#x27;</span>; <span class="comment">// 這是不合法的，報錯「Uncaught SyntaxError: Invalid or unexpected token」</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="comment">// 這是合法的，物件的特性可使用關鍵字或保留字命名</span></span><br><span class="line">  <span class="attr">this</span>: <span class="string">&#x27;this is an object&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="什麼是關鍵字？又什麼是保留字"><a href="#什麼是關鍵字？又什麼是保留字" class="headerlink" title="什麼是關鍵字？又什麼是保留字"></a>什麼是關鍵字？又什麼是保留字</h5><p>「<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Lexical_grammar#Reserved_keywords_as_of_ECMAScript_2015">關鍵字</a>」（keyword）是指在目前ECMAScript中有特定用途的英文字詞，而「<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Lexical_grammar#Future_reserved_keywords">保留字</a>」（reserved word）則是系統留爭，雖然目前尚未用到但未來可能有其他用途的字彙。<strong>再次強調，不管是關鍵字或保留字都不能做變數名稱使用。</strong></p>
<h4 id="區塊-Blocks"><a href="#區塊-Blocks" class="headerlink" title="區塊(Blocks)"></a>區塊(Blocks)</h4><p>區塊是由一對大括號(curly-brace pair、<code>&#123;...&#125;</code>)所規範出來的範圍。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (count &gt; <span class="number">10</span>) &#123;</span><br><span class="line">  <span class="comment">// 區塊範圍在此...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="條件式-Conditionals"><a href="#條件式-Conditionals" class="headerlink" title="條件式(Conditionals)"></a>條件式(Conditionals)</h4><p>表達條件的𤆧法有if述句、switch述句、條件(三元)運算子和迴圈，以下分別述之。</p>
<ul>
<li><p>if述句，括號內的即是條件，若條件為真，則有指定的事情，括號內的條件放置運算式，運算結果是布林值true或false，若非布林值就會強制轉型(例如：0或空字串會被轉為false, 而其他就會轉為true)。範例如下，若商品金額大於運費，就買； 否則就不買。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> product = <span class="string">&quot;100&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> shipment = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">const</span> total = <span class="title class_">Number</span>(product) + shipment; <span class="comment">//200</span></span><br><span class="line"><span class="keyword">if</span> (product &gt; shipment) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;But it !&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Do not buy it!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果得到「Do not buy it!」。</p>
</li>
<li><p>switch述句等同於if-else的縮寫，依靠break來決定是否要持續進行下一個case述句，若沒有break就會「落穿而過」。範例如下，這裡有一個檢測庫存的簡易範例，假設目前庫存數量為50，當庫存為0～2時提示要趕快進貨補庫存，庫存到達50時顯示庫存充裕，庫存到達100時提示貨品是不是賣不掉，其他狀況都顯示為運作正常。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="number">50</span>;</span><br><span class="line"><span class="keyword">switch</span> (count) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;快賣完了！趕快進貨！&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">50</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;庫存充裕&quot;</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">100</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;是不是賣不後！？&quot;</span>)</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;運作正常&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但出乎意料的是，結果印出「庫存充裕、是不是賣不掉了！？、運作正常」</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">庫存充裕</span><br><span class="line">是不是賣不掉了！？</span><br><span class="line">運作正常</span><br></pre></td></tr></table></figure>

<p>這是因為如果沒有加入break，一豆某個符合條件了，托下來的case無論侜合與否都會被執行，也就是剛才所提到的「落穿而過」。</p>
<p>加入break修正一下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="number">50</span>;</span><br><span class="line"><span class="keyword">switch</span> (count) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;快賣完了！趕快進貨！&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">50</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;庫存充裕&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">100</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;是不是賣不後！？&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;運作正常&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果印出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">庫存充裕</span><br></pre></td></tr></table></figure>

<ul>
<li>條件(三元)運算子(conditional&#x2F;ternary)</li>
<li>迴圈(loops)使用條件式來判斷迴圈是否繼續或停止。</li>
</ul>
</li>
</ul>
<h4 id="Truthy-Falsy"><a href="#Truthy-Falsy" class="headerlink" title="Truthy &amp; Falsy"></a>Truthy &amp; Falsy</h4><p>在JavaScript中會被轉為false的值有</p>
<ul>
<li><p><code>&quot;&quot;</code>空字串</p>
</li>
<li><p>0,-0,NaN</p>
</li>
<li><p>null</p>
</li>
<li><p>undefined</p>
</li>
<li><p>false</p>
<p>而除了以上之外，都會被轉為true舉例如下</p>
</li>
<li><p><code>Hello World</code>非空字串</p>
</li>
<li><p>42非零的效數字</p>
</li>
<li><p><code>[],[1, 2, 3]</code>陣列，不管是不是空的</p>
</li>
<li><p><code>&#123;&#125;,&#123; name: &#39;Jack&#39;&#125;</code>物件，不管是不是空的</p>
</li>
<li><p><code>function foo()&#123;&#125;</code>函式</p>
</li>
<li><p>true</p>
<p>如果真的很不確定到底會轉成什麼，可以使用<code>!!</code>做測試</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">!![] <span class="comment">// true</span></span><br><span class="line">!!&#123;&#125; <span class="comment">// true</span></span><br><span class="line">!!<span class="title class_">NaN</span> <span class="comment">// false</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="迴圈-Loops"><a href="#迴圈-Loops" class="headerlink" title="迴圈(Loops)"></a>迴圈(Loops)</h4><p>重複一組動作，直到檢測條件不成立為止。迴圈的形成有很多動，最常用的就是while迴圈(while或do…while)和fot迴圈兩種。</p>
<h5 id="while迴圈"><a href="#while迴圈" class="headerlink" title="while迴圈"></a>while迴圈</h5><p>while迴圈的構成有以下要素：測試條件和區塊，而每次執行區塊時就稱為一次迭代(iteration)。</p>
<p><code>while</code>vs<code>do...while</code></p>
<p>兩者的差異在於<code>while</code>是先測後跑，而<code>do...while</code>是先跑後測。</p>
<p>來看第一個簡單例子，假設商品數量目前有五個，每賣掉一個就將庫存減一，當全賣完(及庫存為零)的時候就跳出迴圈，並印出「全部賣完了」的訊息。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> product = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">while</span> (product &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    product--;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">買一個 </span><br><span class="line">現在還剩 4個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 3個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 2個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 1個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 0個。 </span><br><span class="line">全部賣完了 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但下面這個例子就超有不同了，此時更改商品數量為零，剛剛提到while是「先測後跑」，因此當檢驗測試條件時，發現<code>product &gt; 0</code>得到fals,也就不會進入區塊了，直接印出「全部賣完了」的訊息。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> product = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (product &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    product--;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>再來看<code>while...loop</code>，這個例子並無異狀，跟第一個例子所得到的結果完全相同。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> product = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    product--;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line">&#125; <span class="keyword">while</span> (product &gt; <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">買一個 </span><br><span class="line">現在還剩 4個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 3個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 2個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 1個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 0個。 </span><br><span class="line">全部賣完了 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是…剛剛提到<code>while...loop</code>是「先跑後測」，我們又將商品數量改為零，此時會先進入區塊，依序印出「買一個」、商品數量減一、顯示「現在還剩-1個」、最後才檢驗測試條件、終止迴圈的執行，印出「全部賣完了」的訊息。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> product = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    product--;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line">&#125; <span class="keyword">while</span> (product &gt; <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">買一個 </span><br><span class="line">現在還剩 -1個。 </span><br><span class="line">全部賣完了 </span><br></pre></td></tr></table></figure>

<h5 id="break"><a href="#break" class="headerlink" title="break"></a>break</h5><p>使用break跳出迴圈。</p>
<p>範例如下，在product為2的時候跳出迴圈。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> product = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">while</span> (product &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    product--;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (product === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;停停停，不要賣了！快進貨啊。&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">買一個 </span><br><span class="line">現在還剩 4個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 3個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 2個。 </span><br><span class="line">停停停，不要賣了！快進貨啊。 </span><br><span class="line">全部賣完了 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="continue"><a href="#continue" class="headerlink" title="continue"></a>continue</h5><p>使用continue跳過本次迭代，迴圈依舊持續進行。</p>
<p>範例如下，在product為2的成候忽略之後要執行的<code>console.log(現在還剩 $&#123;product&#125; 個);</code>直接進入下一次迭代。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> product = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">while</span> (product &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    product--;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (product === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;第二個我要暗摃起來&quot;</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">買一個 </span><br><span class="line">現在還剩 4個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 3個。 </span><br><span class="line">買一個 </span><br><span class="line">第二個我要暗摃起來 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 1個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 0個。 </span><br><span class="line">全部賣完了 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="for迴圈"><a href="#for迴圈" class="headerlink" title="for迴圈"></a>for迴圈</h5><p>for迴圈有三個子句-初始化子句、條件測試子句、更新子句。</p>
<ul>
<li><p>初始化子句，例如：<code>let product = 5</code></p>
</li>
<li><p>條件測件子句，例如：<code>product &gt; 0</code></p>
</li>
<li><p>更新子句，例如:<code>product--</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> product = <span class="number">5</span>; product &gt; <span class="number">0</span>; product--) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">買一個 </span><br><span class="line">現在還剩 5個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 4個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 3個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 2個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 1個。 </span><br><span class="line">全部賣完了 </span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="你懂JavaScript嗎？-變數、嚴格模式、IIFEs、閉包、模組、this、原型、Polyfill與Transpiler"><a href="#你懂JavaScript嗎？-變數、嚴格模式、IIFEs、閉包、模組、this、原型、Polyfill與Transpiler" class="headerlink" title="你懂JavaScript嗎？-變數、嚴格模式、IIFEs、閉包、模組、this、原型、Polyfill與Transpiler"></a>你懂JavaScript嗎？-變數、嚴格模式、IIFEs、閉包、模組、this、原型、Polyfill與Transpiler</h3><p>上面有大致聊過了一些基本普識，像是運算子、運算式、值與型別、變數、條件式、迴圈，本文還會再探討一些基礎概念，像是</p>
<ul>
<li><p><a href="#%E8%AE%8A%E6%95%B8(Variable)">變數</a>的存取規則，包含函式範疇、拉升、巢狀範疇。</p>
</li>
<li><p>嚴格模式：一個讓程式碼變得更，更容易優化的方法。</p>
</li>
<li><p>更多關於範疇和函式的應用，包含IIFE、閉包、模組</p>
</li>
<li><p>this：到底是指哪個？這個還是那個？應該不少人都黑人問號</p>
</li>
<li><p>原型可說是物件的一種fallback機制，並且提供了行為委派。</p>
</li>
<li><p>舊功能與新特色的共存，可使用Polyfill和Transpiler來做兼容。</p>
</li>
</ul>
<h4 id="變數-Variable"><a href="#變數-Variable" class="headerlink" title="變數(Variable)"></a>變數(Variable)</h4><p>這個部份要來談關於變數的存取規則，例如：範疇、拉升等。</p>
<h5 id="函式範疇-Function-Scope"><a href="#函式範疇-Function-Scope" class="headerlink" title="函式範疇(Function Scope)"></a>函式範疇(Function Scope)</h5><p>函式會建立自已的範疇，其內的識別字(不管是變數、函式)僅能在這個函式裡面使用。如下在全域範疇底下，是無法存取foo內的a、b、c和bar，否則會導致ReferrenceError；但在foo自已的函式範疇內，可以存取a、b、c和bar。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> c = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// ReferrenceError</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b); <span class="comment">// ReferrenceError</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c); <span class="comment">// ReferrenceError</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">bar</span>(); <span class="comment">// ReferrenceError</span></span><br></pre></td></tr></table></figure>

<h5 id="拉升-Hoisting"><a href="#拉升-Hoisting" class="headerlink" title="拉升(Hoisting)"></a>拉升(Hoisting)</h5><p>在程式執行前，編譯器(compiler)會先由上到下逐行將程式碼轉為電腦可懂的命令，然後再執行編譯後的指令。在這個編譯的階段，編譯器找出所有的變數並繫結所屬範疇，但不賦，所以此刻變數所帶的值是undefined; 而在執行階段，JavaScript引擎才會處理給值的事情。</p>
<p>我們可以把這個過程想像成是嫄這些變數「提升」到程式碼的最頂端，如下範例所示，因此當印出a的值的時候，會是已宣告但還沒賦值的狀態，也就是有這個變數，但其值是undefined，一直到程式執行了，才給值。因此，我們可以在程式碼任何地方呼叫運用這變數，但只有在正式宣告之後才能有正確的值可用，在宣告之前使用都會得到undefined。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a; <span class="comment">// 編譯時期的工作</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// undefined</span></span><br><span class="line">a = <span class="number">2</span>; <span class="comment">// 執行時期的工作</span></span><br></pre></td></tr></table></figure>

<h5 id="巢狀範疇-Nested-Scope"><a href="#巢狀範疇-Nested-Scope" class="headerlink" title="巢狀範疇(Nested Scope)"></a>巢狀範疇(Nested Scope)</h5><p>若在目前執行的範疇找不到這個變數的時候，就會往外層的範疇搜尋，特續搜尋直到找到為止，或直到最外層的全域範疇(globl scope，在瀏覽器底下就是指window)。</p>
<p>如下<code>console.log(a + b)</code>中，b無法在foo中找到，但可從全域範疇中追出來。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">foo</span> = (<span class="params">a</span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a + b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(<span class="number">2</span>); <span class="comment">// 4</span></span><br></pre></td></tr></table></figure>

<p>相較於巢狀範疇是以函式為劃分單位，區塊範疇就是以大括號為界線了。</p>
<h4 id="嚴格模式-Strict-Mode"><a href="#嚴格模式-Strict-Mode" class="headerlink" title="嚴格模式(Strict Mode)"></a>嚴格模式(Strict Mode)</h4><p>嚴格 鄉簡單說就是為了預防開發者的一些小心或錯誤的行為，JavaScript引擎協助做了一些檢測的工作，當開發都誤用時就把錯誤丟出來。可參考<a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Strict_mode">MDN</a>。</p>
<p>範例如下，在未宣告變數而賦值機狀況下，會無預警的產生一個全域變數，但若使用嚴格模式(<code>use strict</code>)則會禁止這行為外，還會報錯，告知開發都變數尚未被定義。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;user stict&#x27;</span>;</span><br><span class="line">a = <span class="number">1</span>; <span class="comment">//Uncaught ReferenceRrrot: a is not defined</span></span><br></pre></td></tr></table></figure>

<p>就把它想像成是一個諄教誨的好者師！總是願意告訴你殘忍的實話…</p>
<h4 id="作為值的函式-Function-as-Value"><a href="#作為值的函式-Function-as-Value" class="headerlink" title="作為值的函式(Function as Value)"></a>作為值的函式(Function as Value)</h4><p>這標題看起來有點怪怪的(?)但其實也只是要說明，函式本身就和其化的值一樣，是可以被指定給某變數、當參數傳遞或當成其它函式的回傳值。記得，函式也只是物件的子型別而已， 沒有什麼特別的。</p>
<p>指定給某個變數，如下，指定給foo。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;大家好，我是 foo!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>當參數傳遞，如下，將foo當成是bar的參數傳入。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;大家好，我是 foo!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params">func</span>) &#123;</span><br><span class="line">    <span class="title function_">func</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bar</span>(foo);<span class="comment">// 大家好，我是 foo!</span></span><br></pre></td></tr></table></figure>

<p>當其他函式的回傳值，foo是baz的回值，並將結果指定給result。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;大家好，我是 foo!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = <span class="keyword">function</span> <span class="title function_">baz</span>(<span class="params">func</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> func;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">result</span>(foo)();<span class="comment">// 大家好，我是 foo！</span></span><br></pre></td></tr></table></figure>

<p>因此，這個函式值(例如：<code>var foo=function()&#123;...&#125;</code>)也可被視為是一個運算式，就稱呼它為「函式運算式」吧。之後還會提到函式宣告、函式運算式與匿名vs具名，待後續詳細的說明。</p>
<h4 id="即刻調用函式運算式-Immediately-Invoked-Function-Expression-IIFE"><a href="#即刻調用函式運算式-Immediately-Invoked-Function-Expression-IIFE" class="headerlink" title="即刻調用函式運算式(Immediately Invoked Function Expression,IIFE)"></a>即刻調用函式運算式(Immediately Invoked Function Expression,IIFE)</h4><p>IIFE是為可立即執行的函式運算式。一般的函式運算式並不會馬上執行、若要執行除了在其名稱後加上小括號外，還可以利用IIFE的𤆧式執行它。匿名或具名皆合法。使用IIFE的好處主要是不污染全域範疇。</p>
<p>範例如下，這是一個匿名的IIFE，a在全域範疇是找不到的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a=<span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">//</span></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不污染全域範疇</span></span><br><span class="line">a;<span class="comment">//Uncaught ReferenceError:a is not defined</span></span><br></pre></td></tr></table></figure>

<h4 id="閉包-Closure"><a href="#閉包-Closure" class="headerlink" title="閉包(Closure)"></a>閉包(Closure)</h4><p>閉包是指變數的生命週其只存在於該函式內，一旦離開了函式，該變數就會被回收而不可再利用，且必須在函式內事先宣告。</p>
<p>範例如下，在函式closure內可以存取a的值，但離開了函式closure走到全域範疇之下，就取不到a的值了，因此會被報錯「Uncaught ReferenceError:a is nto defined」。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">closure</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a=<span class="number">1</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// 1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">closure</span>();</span><br><span class="line">a;<span class="comment">// Uncaught ReferenceError: a is not defined</span></span><br></pre></td></tr></table></figure>

<h4 id="模組-Module"><a href="#模組-Module" class="headerlink" title="模組(Module)"></a>模組(Module)</h4><p>模組模式(Module Pattern)又稱為揭露模組(RevealingModule),經由建立一個模組實體(Moduel Instance，如下範例的foo), 來調用內層函式。而內層函式由於具有閉包的特性。因此可存取外層包含函式(Oute Enclosing Function)之內的變數和函式。透過模組模式，可隱藏私密的資訊，並對外公開API。</p>
<p>範例如下，CoolModule對外公開API doSomething和doAnother, CoolModule之外是無法取得其私有的something𢘊another兩個變數的值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">CoolModule</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> something = <span class="string">&quot;cool&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> another = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(something);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doAnother</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(another.<span class="title function_">join</span>(<span class="string">&quot; ! &quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">doSomething</span>: doSomething,</span><br><span class="line">        <span class="attr">doAnother</span>: doAnother</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = <span class="title class_">CoolModule</span>();</span><br><span class="line">foo.<span class="title function_">doSomething</span>();<span class="comment">// cool</span></span><br><span class="line">foo.<span class="title function_">doAnother</span>();</span><br></pre></td></tr></table></figure>

<h4 id="this識別字-this-Identifier"><a href="#this識別字-this-Identifier" class="headerlink" title="this識別字(this Identifier)"></a>this識別字(this Identifier)</h4><p>this到底是指向誰一直都是個令人費解的問題。</p>
<p>簡單來說，this是function執行時所屬的物件，而this是在執行時期做繫結，其值和函式在哪裡被呼叫(call-site)有關。</p>
<p>總結規則如下，並以匹配的優先順序由高至低排列</p>
<ul>
<li>new 綁定：this會指向new出來的物件。</li>
<li>明確綁定：使用call、apply、bind，明確指出要綁定給this的物件。</li>
<li>隱含綁定：當函式為物件的方法(method)時，在執行階段this就會被綁定至該物件。</li>
<li>預設綁定：當其他規則都適用時，意即沒有使用bind,call, apply或不屬於任何物件的method，就套用預設綁定，在非嚴格模式下，瀏覽器環境this的值就是預設值全域物件window，而在嚴格模式下，this的值就是undefined</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">bar</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bar = <span class="string">&#x27;global&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj1 = &#123;</span><br><span class="line">  <span class="attr">bar</span>: <span class="string">&#x27;obj1&#x27;</span>,</span><br><span class="line">  <span class="attr">foo</span>: foo</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj2 = &#123;</span><br><span class="line">  <span class="attr">bar</span>: <span class="string">&#x27;obj2&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(); <span class="comment">// &#x27;global&#x27;</span></span><br><span class="line">obj1.<span class="title function_">foo</span>(); <span class="comment">// &#x27;obj1&#x27;</span></span><br><span class="line">foo.<span class="title function_">call</span>( obj2 ); <span class="comment">// &#x27;obj2&#x27;</span></span><br><span class="line"><span class="keyword">new</span> <span class="title function_">foo</span>(); <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>

<h4 id="原型-Prototype"><a href="#原型-Prototype" class="headerlink" title="原型(Prototype)"></a>原型(Prototype)</h4><p>原型可說是物件的一種callback機制，當在此物件找不到指定屬性時，就會透過原型鏈結(prototype link&#x2F;prototype reference)追溯到其父物件上。範𠕥如下，若想存取<code>bar.a</code>但由於bar並為a屬性。因此𠺾會透過原型鏈結找到foo,並得偌100這個值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = &#123; <span class="attr">a</span>: <span class="number">100</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bar = <span class="title class_">Object</span>.<span class="title function_">create</span>(foo); <span class="comment">// 建立 bar 物件，並連結到 foo</span></span><br><span class="line">bar.<span class="property">b</span> = <span class="string">&#x27;hi&#x27;</span>;</span><br><span class="line"></span><br><span class="line">bar.<span class="property">a</span> <span class="comment">// 100，委派給 foo</span></span><br><span class="line">bar.<span class="property">b</span> <span class="comment">// &#x27;hi&#x27;</span></span><br></pre></td></tr></table></figure>

<p>另外，原型最常應用於「行為委派」(behaviro delegation)，如上例所示，將物件bar的行為委派給foo, 這也是常聽到很類似於其他語言的類別的繼承功能，但其實完全不同。</p>
<h4 id="舊功能與新特色的共存"><a href="#舊功能與新特色的共存" class="headerlink" title="舊功能與新特色的共存"></a>舊功能與新特色的共存</h4><p>面對新舊功能並存的狀況要怎麼處理呢？這裡要介紹兩種方法-Polyfill和Tranxpiler。</p>
<h5 id="Polyfill"><a href="#Polyfill" class="headerlink" title="Polyfill"></a>Polyfill</h5><p>Polyfilling的意思就是依據一個新功能的定義，製作具有相同行無，而能在較舊的JavaScript環境執行的程式碼，候話說就是為舊瀏覽掛載新功能。</p>
<p>這裡來看一個例子，針對isNan的改進…</p>
<h6 id="isNan"><a href="#isNan" class="headerlink" title="isNan"></a>isNan</h6><p>NaN表示值無效的數字，它會產生的原因是</p>
<ul>
<li><p>做數字運算時的兩個運算元的資料型別並非都數字或無法轉成有的十進位或十六進位的數字。</p>
</li>
<li><p>無意義的運算，例如:0&#x2F;0, Infinity&#x2F;Infinity。</p>
</li>
</ul>
<p>以上𣄵會產生NaN。</p>
<p>在ES6以前，開發者使用<code>isNaN</code>在數學運算或解析字串後檢測得到的結果是否為合法的數字，其實就是檢測是否為NaN，其過程為先將輸入值使用Number強制轉為數字。無法轉為有的數字而得到NaN時就判定等於NaN，結果得到true。</p>
<p>範例如下，空物件<code>&#123;&#125;</code>經過isNaN判斷是NaN，意即不為數字</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(&#123;&#125;));<span class="comment">//</span></span><br><span class="line"><span class="comment">// 拆宗詳細過程如下</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(&#123;&#125;)); <span class="comment">// 先將空物件轉為數字，得到NaN</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="title class_">NaN</span>)); <span class="comment">// 檢查是不否為 NaN，得到true</span></span><br></pre></td></tr></table></figure>

<p>其它範例還有..</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">isNaN</span>(<span class="number">123</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(-<span class="number">1.23</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="number">5</span>-<span class="number">2</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="number">0</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="string">&#x27;123&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="string">&#x27;Hello World&#x27;</span>) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="string">&#x27;2000/01/01&#x27;</span>) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="string">&#x27;&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="literal">true</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="literal">undefined</span>) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="string">&#x27;NaN&#x27;</span>) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="title class_">NaN</span>) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="number">0</span>/<span class="number">0</span>) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="number">1</span>/<span class="number">0</span>) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>但這檢測方式常常會讓開發者得到讓人容易誤解的結果(像是空物件<code>&#123;&#125;</code>就真的不等於NaN呀)，因此ES6推出了<code>Number.isNaN</code>，<code>Number.isNaN</code>不會經過轉為數字的這過程，而是直托判斷型別否為數字且是否等於NaN。承上範𠕥，檢測空物件<code>&#123;&#125;</code>是否為NaN，得到false</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(&#123;&#125;) <span class="comment">// 直接檢查空物件是否為 NaN，得到 false</span></span><br></pre></td></tr></table></figure>

<p>同樣也來看剛才的範例…</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">123</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(-<span class="number">1.23</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">5</span>-<span class="number">2</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">0</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;123&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;Hello World&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;2000/01/01&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="literal">true</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="literal">undefined</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;NaN&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="title class_">NaN</span>) <span class="comment">// true</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">0</span>/<span class="number">0</span>) <span class="comment">// true</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">1</span>/<span class="number">0</span>) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>雖然ES6出了這個新功能，但不見得所有的瀏覽器都會支援，因此對於較舊瀏覽，就掛個polyfill來模擬這個新功能。</p>
<p>polyfill如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Number</span>.<span class="property">isNaN</span>) &#123;</span><br><span class="line">  <span class="title class_">Number</span>.<span class="property">isNaN</span> = <span class="keyword">function</span> <span class="title function_">isNaN</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x !== x; <span class="comment">// NaN 是唯一一個不等於自己的值</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ES6定義了常數<code>Number.NaN</code>來表示NaN</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">isNaN</span>(<span class="title class_">NaN</span>); <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="title class_">Number</span>.<span class="property">NaN</span>); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="title class_">Number</span>.<span class="property">NaN</span>) <span class="comment">// true</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="title class_">NaN</span>) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>由於實作 polyfill 難免會有缺漏或疏失，這裡提供兩個經過嚴格審核的函式庫以供使用-<a href="https://github.com/es-shims/es5-shim">es5-shim</a> 和 <a href="https://github.com/es-shims/es6-shim">es6-shim</a>。</p>
<h6 id="Transpiler"><a href="#Transpiler" class="headerlink" title="Transpiler"></a>Transpiler</h6><p>並非所有的新功能都能經由polyfill掛載到舊環境上，這裡提出另一個解法，將帶有新功能的程式碼換成等效的舊有程式碼碼可以了，也就是使用transpiler做轉譯。</p>
<p>例如，ES6推出了新功能「預設參數值」。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a = <span class="number">2</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(); <span class="comment">// 2</span></span><br><span class="line"><span class="title function_">foo</span>(<span class="number">42</span>); <span class="comment">// 42</span></span><br></pre></td></tr></table></figure>

<p>但這在舊的JavaScript引擎中是無 的，因此transpiler就會將以上程式碼變形，翻譯成等 的舊程式碼。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="variable language_">arguments</span>[<span class="number">0</span>] !== (<span class="keyword">void</span> <span class="number">0</span>) ? <span class="variable language_">arguments</span>[<span class="number">0</span>] : <span class="number">2</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這麼做的好處是在開發階段開發者依然能享受新功能帶來的好處，但又能兼顧到新舊瀏覽器的狀況。這裡也推薦一些很棒的 transpiler，像是 <a href="https://babeljs.io/">Babel</a>、<a href="https://github.com/google/traceur-compiler">Traceur</a> 等。</p>
<h3 id="你懂JavaScript嗎-型別-Types"><a href="#你懂JavaScript嗎-型別-Types" class="headerlink" title="你懂JavaScript嗎?型別(Types)"></a>你懂JavaScript嗎?型別(Types)</h3><p>主要會談到</p>
<ul>
<li>何謂「型別」？內建型別有哪些？常見疑難雜症與解法</li>
<li>未定義(undefined) vs 未宣告(undeclared)</li>
</ul>
<h4 id="何謂「型別」？"><a href="#何謂「型別」？" class="headerlink" title="何謂「型別」？"></a>何謂「型別」？</h4><p>「型別」是固有的、內建的特微，能唯一識別特定值的行為。例如：數字123和字串’123’就是不一樣的，數字123可做數學運算處理，而字串’123’可能就是做些顯示到畫面上的操作。</p>
<h4 id="內建型別-Built-In-Types"><a href="#內建型別-Built-In-Types" class="headerlink" title="內建型別(Built-In Types)"></a>內建型別(Built-In Types)</h4><p>JavaScript定義了以下七種內建型別</p>
<ul>
<li><p>number數字，例如:12345</p>
</li>
<li><p>string字串，例如：<code>Hello World</code></p>
</li>
<li><p>boolean布林，例如:true、false</p>
</li>
<li><p>null</p>
</li>
<li><p>undefined</p>
</li>
<li><p>object物件，例如：<code>&#123; name: &#39;Jack&#39; &#125;</code>、<code>&#123;1, 2, 3&#125;</code>、<code>function foo() &#123; ... &#125;</code></p>
</li>
<li><p>symbol</p>
</li>
</ul>
<p>其中，這些內建型別又可分兩大類-基本型別(primitives)和物件型別(object)。基本型別有number、string、boolean、null、undefined、symbol，而物件型別就是物件與其子型別(subtype)，例如：物件、陣列、函式、日期等。</p>
<p>我們可用<code>typeof</code>來檢測值的資料型別為何。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="string">&#x27;Hello World&#x27;</span>);<span class="comment">//string</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">true</span>);<span class="comment">//boolean</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="number">12345678</span>);<span class="comment">//number</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">null</span>);<span class="comment">//object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">undefined</span>);<span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> &#123; <span class="attr">name</span>:<span class="string">&#x27;Jack&#x27;</span>&#125;);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">Symbol</span>()); <span class="comment">// symbol</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;);<span class="comment">// function</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">NaN</span>);<span class="comment">// number</span></span><br></pre></td></tr></table></figure>

<p>這裡會看到幾個有趣的(奇怪的)地方…</p>
<ul>
<li><p>null 是基本型別之一，但<code>typeof null</code>卻得到object，而非null！這可說是一個bug，可是若修正了這個bug則可能會導致很多網站壞掉，因此就不修了！</p>
</li>
<li><p>雖然說function是物件的子型別，但<code>typeof functon()&#123;&#125;</code>是得到function而非object，和陣列依舊得object是不一樣的。另外順道一提函式是一種「可呼叫的物件」(callable object),它擁有<code>[[Call]]</code>的內部特性，讓它成為能夠被調用的物件。</p>
</li>
<li><p>NaN表示是無效的數字，但依舊還是數字，因此在資料型別的檢測<code>typeof NaN</code>結果就是number，不要被字面上的意思「不是數字」(not a number)給弄糊塗了。另外、NaN與依何數字運算都會得到NaN、並且NaN不大於、不小於也不等於依何數字，包含NaN它自已。</p>
</li>
</ul>
<p>先來解決剛剛提到的幾個問題。</p>
<h4 id="Q1-如何檢測null？"><a href="#Q1-如何檢測null？" class="headerlink" title="Q1:如何檢測null？"></a>Q1:如何檢測null？</h4><p>之前有提到的Truthy&amp;Falsy的概念，在做比較時會被轉型為fals的值有</p>
<ul>
<li><p><code>&quot;&quot;</code>空字串</p>
</li>
<li><p>0，-0，NaN</p>
</li>
<li><p>null</p>
</li>
<li><p>undefined</p>
</li>
<li><p>false</p>
</li>
</ul>
<p>而除了以下之外，都會被轉無true,與例如下</p>
<ul>
<li><p><code>Hello World</code>非空字串</p>
</li>
<li><p>42非零的有效數字</p>
</li>
<li><p><code>[],[1, 2, 3]</code>陣列，不管是不是空的</p>
</li>
<li><p><code>&#123;&#125;,&#123;name:&#39;Jack&#39;&#125;</code>物件，不管是不是空的</p>
</li>
<li><p><code>function foo()&#123;&#125;</code>函式</p>
</li>
<li><p>true</p>
<p>我們可利用null會被typeof檢測為object並且會轉為false的結果來驗證是否為null.</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> happy = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (!happy &amp;&amp; <span class="keyword">typeof</span> happy === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;我是 null!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到「我是null !」，輕鬆解決，得分！</p>
<h4 id="Q2-既然函式與陣列都是物件，那其中的屬性length有什麼不同"><a href="#Q2-既然函式與陣列都是物件，那其中的屬性length有什麼不同" class="headerlink" title="Q2:既然函式與陣列都是物件，那其中的屬性length有什麼不同?"></a>Q2:既然函式與陣列都是物件，那其中的屬性length有什麼不同?</h4><p>函式的length是指參數個數，而陣列的length是指內部成員個數。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">testMe</span>(<span class="params">arg1, arg2, arg3</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;This is testMe!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(testMe.<span class="property">length</span>);<span class="comment">// 3</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list.<span class="property">length</span>);<span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<h4 id="Q3-typeof檢測的對象是誰"><a href="#Q3-typeof檢測的對象是誰" class="headerlink" title="Q3:typeof檢測的對象是誰?"></a>Q3:typeof檢測的對象是誰?</h4><p>再次強調，變數沒有型別，變數可在不同時間點持有不同型別的值，因此，只有「值」才有型別，雖然我們可用typeof檢測某個變數所儲存的值的型別，至記得並不是檢崱變數本身，而是變數所存的值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> name = <span class="string">&#x27;Jack&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> name <span class="comment">// &#x27;string&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Q4:辨識物件子型別的方法?</p>
<p>稍後在Natives(原生功能)的部分會說明取得物件內部分類的方法，這裡就先大略提一下。</p>
<p>物件型別的值其內部有一個<code>[[Class]]</code>屬性來標記這個值是屬於物件的哪個子分類，雖然無法直接取用，但可透過<code>Object.prototye.toString</code>間接取得，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])); <span class="comment">//[object Array]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span> &#125;));<span class="comment">//[object Object]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">function</span> <span class="title function_">SayHi</span>(<span class="params"></span>) &#123;&#125;));<span class="comment">//[objcet Function]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="regexp">/helloworld/i</span>));<span class="comment">//[object RegExp]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">new</span> <span class="title class_">Date</span>()));<span class="comment">//[object Date]</span></span><br></pre></td></tr></table></figure>

<h4 id="未定義-undefined-vs未宣告-uneclared"><a href="#未定義-undefined-vs未宣告-uneclared" class="headerlink" title="未定義(undefined)vs未宣告(uneclared)"></a>未定義(undefined)vs未宣告(uneclared)</h4><ul>
<li><p>未定義(undefined):未賦值的變數所儲存的值是undefined,對此變數做typeof也會得到<code>undefined</code></p>
</li>
<li><p>未宣告(undeclared):變數在未宣當並使用的狀況下會得到ReferenceError，並指出該變數並未宣告； 變數在未宣告並賦值的狀況下，在嚴格模式下會報錯ReferenceError，而在非嚴格模式，變數會成為全域變數的屬性。注意，對未宣告的變數做typeof也會得到<code>undefined</code>。</p>
</li>
</ul>
<p>總結𣄵是，無論變數是未定義或未宣告、typeof這兩種狀況皆會得到<code>undefined</code>。那麼，對未宣告的變數做typeof而得到<code>undefined</code>，有什麼用處呢?</p>
<h4 id="對未宣告的變數做typeof"><a href="#對未宣告的變數做typeof" class="headerlink" title="對未宣告的變數做typeof"></a>對未宣告的變數做typeof</h4><p>對未宣告的變數做typeof而得到<code>&#39;undefined&#39;</code>可說是一保護措施，可避免瀏覽器丟出ReferenceError的錯誤訊息，在撰寫測試特定條件時常會用到。</p>
<p>範例如下，我們可能在非正式環境下會引用了某支js檔案，其中會設定DEBUG為ture，而其它檔案會根據DEBUG變數是否被宣告並設定為true時做出相對應的事情。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable constant_">DEBUG</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">  <span class="comment">// start to debug...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或著，我們也可以不用typeof的作法，而改用檢測window屬性的方式，同樣也不會丟出ReferenceError。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">DEBUG</span>) &#123;</span><br><span class="line">  <span class="comment">// start to debug...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再或者，使用依存性注入(dependency injection)的方式也是可以的，將要檢測的條件當參數傳入函式，若條件不存在則使用預設值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">doSomethingCool</span>(<span class="params">DEBUG</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> helper = <span class="variable constant_">DEBUG</span> || <span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="comment">/* 預設值 */</span> &#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只是這解法已被ES6的預設傳入參數(Degault Paramaters)取代了。</p>
<h3 id="你懂JavaScript嗎？值-Values-Part1-陣列、字串、數字"><a href="#你懂JavaScript嗎？值-Values-Part1-陣列、字串、數字" class="headerlink" title="你懂JavaScript嗎？值(Values)Part1-陣列、字串、數字"></a>你懂JavaScript嗎？值(Values)Part1-陣列、字串、數字</h3><p>主要會談到關於陣列、字串、數字的錯誤操作方式與疑難雜症的解法。</p>
<h4 id="陣列-Array"><a href="#陣列-Array" class="headerlink" title="陣列(Array)"></a>陣列(Array)</h4><p>陣列是由數值做索引，可由任何型別值所構成的群集。在𫍇裡要先提到兩個容易誤用的重點-(1)稀疏陣列誤存undefined的元素和(2)使用「很像數字」的字串當成鍵值來存資料時，鍵值被強制轉型為數字的狀況，最後會提到「類陣列」的操作。</p>
<h5 id="稀疏陣列-Sparse-Array"><a href="#稀疏陣列-Sparse-Array" class="headerlink" title="稀疏陣列(Sparse Array)"></a>稀疏陣列(Sparse Array)</h5><p>稀疏陣列是指陣列中有插槽(slot)可能未定義其值或被略過而導致存放undefined元素的狀況，範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [];</span><br><span class="line">list[<span class="number">0</span>] = <span class="string">&#x27;Hello&#x27;</span>;</span><br><span class="line">list[<span class="number">2</span>] = <span class="string">&#x27;World&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list[<span class="number">1</span>]); <span class="comment">//undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list.<span class="property">length</span>) <span class="comment">//3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> numlist = [];</span><br><span class="line">numlist[<span class="number">0</span>] = <span class="number">123</span>;</span><br><span class="line">numlist[<span class="number">2</span>] = <span class="number">456</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(numlist[<span class="number">1</span>]); <span class="comment">//undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(numlist.<span class="property">length</span>);<span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>這會有什麼問題呢?</p>
<p>由於這可能是一些疏忽或鏌誤操作所造成的，因此會對length有錯誤的期待，例如，可能原本其待list的長度為2，但因錯置了字串<code>&#39;World&#39;</code>的位置，導致list的長度為3，存之後陣列的操作上可能會出現很難發現的<strong>bug</strong>。</p>
<p>這種<strong>bug</strong>就是所謂的<strong>地雷</strong>，你永遠不知道它什麼時候會爆炸，一旦爆炸就死傷慘動、很難挽救。</p>
<h5 id="鍵值的強制轉型"><a href="#鍵值的強制轉型" class="headerlink" title="鍵值的強制轉型"></a>鍵值的強制轉型</h5><p>若使用「很像數字」的字串當成鍵值來存資料，鍵值會被強制轉型為數字，這也會造成後續處理上的難題，像是產生剛剛提到的稀疏矩陣的狀況(又是地雷一枚)。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [];</span><br><span class="line">list[<span class="number">0</span>] = <span class="string">&#x27;Hello&#x27;</span>;</span><br><span class="line">list[<span class="string">&#x27;20&#x27;</span>] = <span class="string">&#x27;World&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list[<span class="string">&#x27;20&#x27;</span>]);<span class="comment">// World</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list.<span class="property">length</span>);<span class="comment">// 21</span></span><br></pre></td></tr></table></figure>

<p>陣列其實也就是物件的子型別而已，所以若想用字串當成鍵值來存放資料也是可以的，只是鍵值會被強制轉型為數字。如上所示，鍵值<code>20</code>被強制轉為數字20，導致list成為稀疏陣列，其長度就被誤判了。因此，若索引值是數字就用陣列，而非數字就用物件吧！</p>
<h4 id="類陣列-Array-Like"><a href="#類陣列-Array-Like" class="headerlink" title="類陣列(Array-Like)"></a>類陣列(Array-Like)</h4><p>類陣列是指以數值索引的值所成的群集，它可能是串列但並非真正的陣列，例如：DOM物件操作後所得偌的串列、函式引數所形成的串列(ES6已棄用)。而為了能操作這些類陣列的元素，就必須將類陣列轉為真正的陣列，這樣就進行indexOf、concat、forEach等的操作了。</p>
<p>DOM物件操作後所得到的串列，範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> list = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">list <span class="comment">// HTMLCollection(3) [div, div, div]</span></span><br><span class="line">list.<span class="property">length</span> <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<p>函式引數所形成的串列，範例如下，取得不定個數的引數。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> arr= <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>);<span class="comment">//(1)</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(arr);<span class="comment">//(2)</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(<span class="string">&#x27;hello&#x27;</span>,<span class="string">&#x27;world&#x27;</span>,<span class="string">&#x27;bar&#x27;</span>,<span class="string">&#x27;baz&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>得到</p>
<ul>
<li><p>(1)<code>&#123; [Iterator]    0: &#39;hello&#39;,   1: &#39;world&#39;,   2: &#39;bar&#39;,   3: &#39;baz&#39;,   [Symbol(Symbol.iterator)]: [λ: values] &#125;</code></p>
</li>
<li><p>(2)<code>[ &#39;hello&#39;, &#39;world&#39;, &#39;bar&#39;, &#39;baz&#39; ] </code></p>
</li>
</ul>
<p>以下可知，函數引數所形成的類陣列，在經過 <a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/Array/slice">slice</a> 轉換後可得到真正的陣列以供後續操作。注意，slice會回傳一個指定開始到結束部份的新陣列，因此在不傳人任何參數的狀況下等同於複製陣列。</p>
<p>或使用<code>Array.from</code>也會有同樣的效果。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> arr= <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>);<span class="comment">//(1)</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(arr);<span class="comment">//(2)</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(<span class="string">&#x27;hello&#x27;</span>,<span class="string">&#x27;world&#x27;</span>,<span class="string">&#x27;bar&#x27;</span>,<span class="string">&#x27;baz&#x27;</span>);</span><br><span class="line"><span class="comment">//(1)`&#123; [Iterator]    0: &#x27;hello&#x27;,   1: &#x27;world&#x27;,   2: &#x27;bar&#x27;,   3: &#x27;baz&#x27;,   [Symbol(Symbol.iterator)]: [λ: values] &#125;</span></span><br><span class="line"><span class="comment">//(2)`[ &#x27;hello&#x27;, &#x27;world&#x27;, &#x27;bar&#x27;, &#x27;baz&#x27; ]</span></span><br></pre></td></tr></table></figure>

<h4 id="字串-String"><a href="#字串-String" class="headerlink" title="字串(String)"></a>字串(String)</h4><p>這部分還是繼續來看關於類陣列的處理。</p>
<h5 id="可變-Mutable-與不可變-Immutable"><a href="#可變-Mutable-與不可變-Immutable" class="headerlink" title="可變(Mutable)與不可變(Immutable)"></a>可變(Mutable)與不可變(Immutable)</h5><p>JavaScript在創建變數，賦值後是可變的(mutable)；相較於mutable，不可變(immutable)就是指在創建變數、賦值後便不可改變，若對其任何變更(例如：新增、修改、刪除)，就會回傳一個新值。</p>
<p>當需要更新一個變數的時候，若值的型態為基本型態，則是不可變的，意即只要改變就會回傳一個新的值； 若值的型態為物型態，則由於物件是使用call by reference的方式其享資料來源，因此只是就地更新而已，或說是更新這個位置所儲存的值，而非回傳一新的值。</p>
<h5 id="字串的類陣列處理"><a href="#字串的類陣列處理" class="headerlink" title="字串的類陣列處理"></a>字串的類陣列處理</h5><p>字串可不可以當成陣列來處理呢？可以的，而且可以借用陣列的方法來做些事情，只是要注意，<strong>不能變更陣列的內容</strong>。</p>
<h5 id="插入間隔字元"><a href="#插入間隔字元" class="headerlink" title="插入間隔字元"></a>插入間隔字元</h5><p>如下，借用陣列的 <a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/Array/join">join</a> 來實作在字串間插人字元。join和map都不會變動到原始陣列的內容，因為回傳的結果是一個新的值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> str_another = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">join</span>.<span class="title function_">call</span>(str, <span class="string">&#x27;--&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> str_the_other = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">map</span>.<span class="title function_">call</span>(str, <span class="function">(<span class="params">char</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;char.toUpperCase()&#125;</span>.`</span></span><br><span class="line">&#125;).<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str);<span class="comment">//foo</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str_another);<span class="comment">//f--o--o</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str_the_other);<span class="comment">//F.O.O. </span></span><br></pre></td></tr></table></figure>

<h5 id="反轉"><a href="#反轉" class="headerlink" title="反轉"></a>反轉</h5><p>但revere是會改變原始陣列資料的，因此字串就不能借用。如下所示，arr經反轉由 <code>[&#39;b&#39;, &#39;a&#39;, &#39;r&#39;]</code> 改變為 <code>[&quot;r&quot;, &quot;a&quot;, &quot;b&quot;]</code>。</p>
 <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;r&#x27;</span>];</span><br><span class="line">arr.<span class="title function_">reverse</span>();<span class="comment">//[ &#x27;r&#x27;, &#x27;a&#x27;, &#x27;b&#x27; ] </span></span><br><span class="line">arr;<span class="comment">//[ &#x27;r&#x27;, &#x27;a&#x27;, &#x27;b&#x27; ] </span></span><br></pre></td></tr></table></figure>

<p>所以若想借用陣列的reverse來反轉字串，就會被報錯了。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> str_another = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">reverse</span>.<span class="title function_">call</span>(str);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Uncaught TypeError: Cannot assign to read only property &#x27;0&#x27; of object &#x27;[object String]&#x27; at String.reverse</span></span><br></pre></td></tr></table></figure>

<p>面對無法借用陣列方法的狀況，可先將字串轉為陣列，在進行操作(像是反轉)，最後再轉回字串即可。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> str_thoe_other = str.<span class="title function_">split</span>(<span class="string">&#x27;&#x27;</span>).<span class="title function_">reverse</span>().<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">str_thoe_other;<span class="comment">//oof </span></span><br></pre></td></tr></table></figure>

<p>但以上是不是看起來眼醜陋又麻煩？因此最好的方法是先把資料存成陣列，再使用陣列的方法操作，後續若需要使用字串表示，再用join打平串起就可以了！</p>
<h4 id="數字-Number"><a href="#數字-Number" class="headerlink" title="數字(Number)"></a>數字(Number)</h4><p>JavaScript的數字(number)型別包含兩種-整數和帶有小數的浮點數，其中數字的實作是以<a href="https://zh.wikipedia.org/wiki/IEEE_754">IEEE 754</a> 為標準，也就是浮點數(floating-point number)的雙精度(double precision)格式，意渡64位元的二進位數字。</p>
<h5 id="如何表達「非常大」或「非常小」的數字？"><a href="#如何表達「非常大」或「非常小」的數字？" class="headerlink" title="如何表達「非常大」或「非常小」的數字？"></a>如何表達「非常大」或「非常小」的數字？</h5><p>非常大或非常小的數值以「指數」的方式呈現。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a =<span class="number">1E20</span>;</span><br><span class="line"><span class="keyword">const</span> b =a*<span class="number">100</span>;</span><br><span class="line"><span class="keyword">const</span> c= a/<span class="number">0.001</span>;</span><br><span class="line">a;<span class="comment">//100000000000000000000 </span></span><br><span class="line">b;<span class="comment">//1e+22</span></span><br><span class="line">c;<span class="comment">//1e+23</span></span><br><span class="line"><span class="comment">// 使用 toExponential 手動轉指數呈現</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toExponential</span>());<span class="comment">//1e+20 </span></span><br></pre></td></tr></table></figure>

<h5 id="如何指定小數位數"><a href="#如何指定小數位數" class="headerlink" title="如何指定小數位數?"></a>如何指定小數位數?</h5><p>使用toFixed指定要顯示的小數位數，會做四捨五入，不足會補零，注意結果會以「字串」格式呈現。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">123.456789</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toFixed</span>(<span class="number">1</span>));<span class="comment">//123.5 </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toFixed</span>(<span class="number">2</span>));<span class="comment">//123.46</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toFixed</span>(<span class="number">3</span>));<span class="comment">//123.457</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toFixed</span>(<span class="number">10</span>));<span class="comment">//123.4567890000 </span></span><br></pre></td></tr></table></figure>

<h5 id="如何指定有效位數"><a href="#如何指定有效位數" class="headerlink" title="如何指定有效位數?"></a>如何指定有效位數?</h5><p>使用toPrecision指定有效位數，會做四捨五入，不足會補零，注意結果會以「字串」格式呈現。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">123.456789</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toPrecision</span>(<span class="number">1</span>));<span class="comment">//1e+2 </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toPrecision</span>(<span class="number">2</span>));<span class="comment">//1.2e+2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toPrecision</span>(<span class="number">3</span>));<span class="comment">//123</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toPrecision</span>(<span class="number">4</span>));<span class="comment">//123.5</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toPrecision</span>(<span class="number">5</span>));<span class="comment">//123.46</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toPrecision</span>(<span class="number">10</span>));<span class="comment">//123.4567890 </span></span><br></pre></td></tr></table></figure>

<p>注意，數字後加上<code>.</code>會讓JavaScript引擎先判定為小數點，而非屬性存取。因此，若希望<code>100.toPrecision(1)</code>能正常顯示，應該為<code>100..toPrecision(1)</code>或<code>(100).toPrecision(1)</code>。</p>
<h5 id="如何表示其它基數的數字"><a href="#如何表示其它基數的數字" class="headerlink" title="如何表示其它基數的數字?"></a>如何表示其它基數的數字?</h5><ul>
<li><p>十六進位：加上前綴「0x」或「0X」</p>
</li>
<li><p>八進位：加上前綴「0o」或「0O」</p>
</li>
<li><p>二進位：加上前綴「0b」或「0B」</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0xAB</span>);<span class="comment">//171</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0o65</span>);<span class="comment">//53</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0b11</span>);<span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>  頭昏眼花了嗎？<code>0x</code>、<code>0o</code>、<code>0b</code> 可不是表情符號喔！</p>
<h5 id="如何表示十進位小數"><a href="#如何表示十進位小數" class="headerlink" title="如何表示十進位小數?"></a>如何表示十進位小數?</h5><p>只要是使用IEEE754來表示二進位浮點數的程式語言都有一個夢靨-無法精準地表示十進位的小數，範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0.1</span>+<span class="number">0.2</span> === <span class="number">0.3</span>);<span class="comment">//false </span></span><br></pre></td></tr></table></figure>

<p>將 0.1、0.2 和 0.3 分別轉為二進位來看</p>
<ul>
<li>0.1 轉成二進位表示為 0.0001100110011…（0011 循環）</li>
<li>0.2 轉成二進位表示為 0.00110011001100…（1100 循環）</li>
<li>0.3 轉成二進位表示為 0.0100110011001…（1001 循環）</li>
</ul>
<p>因此 0.1 + 0.2 永遠不會剛好等於 0.3。</p>
<p>解法是取一個很小的誤差當作容許值，若運算結果小於這個誤差值就判斷為等於，在ES6中已定義好這個常數<code>Number.EPSILON</code>其值為2^-52, 或實作polyfill如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Number</span>.<span class="property">EPSILON</span>) &#123;</span><br><span class="line">  <span class="title class_">Number</span>.<span class="property">EPSILON</span> = <span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>,-<span class="number">52</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那…要怎麼使用這個<code>Number.EPSILON</code>呢?先實作一個函equal，它會判斷誤差是否小於容許值-先將兩輸入值的差取絕對值，再與<code>Number.EPSILON</code>做比對，若小於這個誤差值就判𪼙為兩數相等。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">equal</span>(<span class="params">n1, n2</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">abs</span>(n1-n2) &lt; <span class="title class_">Number</span>.<span class="property">EPSILON</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a=<span class="number">0.1</span>+<span class="number">0.2</span>;</span><br><span class="line"><span class="keyword">var</span> b= <span class="number">0.3</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">equal</span>(a,b));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">equal</span>(<span class="number">0.0000001</span>, <span class="number">0.0000002</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<h5 id="備註"><a href="#備註" class="headerlink" title="備註"></a>備註</h5><p>ES6定義所謂「安全」的數值範圍為</p>
<ul>
<li>整數：最大整數<code>Number.MAX_SAFE_INTEGER</code>(其值為 2^53 - 1 等於 9007199254740991）、最小整數 <code>Number.MIN_SAFE_INTEGER</code>（其值為 -9007199254740991）。</li>
<li>浮點數：最大浮點數 <code>Number.MAX_VALUE</code>（其值為 1.798e+308）、最小浮點數 <code>Number.MIN_VALUE</code>（其值為 5e-324）。</li>
</ul>
<h5 id="如何知道數值是個整數？如何知道數值位在安全範圍內？"><a href="#如何知道數值是個整數？如何知道數值位在安全範圍內？" class="headerlink" title="如何知道數值是個整數？如何知道數值位在安全範圍內？"></a>如何知道數值是個整數？如何知道數值位在安全範圍內？</h5><p>使用<code>Number.isInteger</code>來測試數值是否為整數。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="title function_">isInteger</span>(<span class="number">42</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="title function_">isInteger</span>(<span class="number">42.000</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="title function_">isInteger</span>(<span class="number">42.3</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>使用<code>Number.isSafeInteger</code>來測試數值是否在安全範圍內。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="title function_">isSafeInteger</span>(<span class="title class_">Number</span>.<span class="property">MAX_SAFE_INTEGER</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="title function_">isSafeInteger</span>(<span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>, <span class="number">53</span>)));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="title function_">isSafeInteger</span>(<span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>, <span class="number">53</span>) - <span class="number">1</span>));<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>polyfill</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Number</span>.<span class="property">isSafeInteger</span>) &#123;</span><br><span class="line">  <span class="title class_">Number</span>.<span class="property">isSafeInteger</span> = <span class="keyword">function</span>(<span class="params">num</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Number</span>.<span class="title function_">isInteger</span>( num ) &amp;&amp;</span><br><span class="line">      <span class="title class_">Math</span>.<span class="title function_">abs</span>( num ) &lt;= <span class="title class_">Number</span>.<span class="property">MAX_SAFE_INTEGER</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="32位元有號整數-32-bit-Signed-Integer"><a href="#32位元有號整數-32-bit-Signed-Integer" class="headerlink" title="32位元有號整數(32-bit Signed Integer)"></a>32位元有號整數(32-bit Signed Integer)</h5><p>部份運算(例如：位元運算bitwise operator)只允𧥸使用32位元的有號整數，其範圍為<code>Math.pow(-2,31)</code>到<code>Math.pow(2,31)-1</code>。</p>
<p>在做這類運算前必須先把數值使用<code>|0</code>轉為32位元的有環整數</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> integer = <span class="number">123456789</span>;</span><br><span class="line"><span class="keyword">const</span> signed_integer = integer | <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h3 id="你懂JavaScript？值-Values-Part2-特殊值"><a href="#你懂JavaScript？值-Values-Part2-特殊值" class="headerlink" title="你懂JavaScript？值(Values)Part2-特殊值"></a>你懂JavaScript？值(Values)Part2-特殊值</h3><p>主要內容為探討基本型別的特殊值並能適當使用它們。</p>
<h4 id="undefined與void運算子"><a href="#undefined與void運算子" class="headerlink" title="undefined與void運算子"></a>undefined與void運算子</h4><p>void運算子可確保運算式不回傳任何值(其實是得到undefined),並且不修改現有值。</p>
<p>例如，𫍇僤有一個變數hello，其值為777，結合void運算子做運算後會得到undefined,但hello內儲存的值仍是不變的，依舊是777。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> hello = <span class="number">777</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> hello <span class="comment">// undefined</span></span><br><span class="line">hello <span class="comment">// 777</span></span><br></pre></td></tr></table></figure>

<p>實際上會應用到什麼狀況呢？</p>
<p>一，運算式的結果真的希望<strong>不回傳任何值</strong>(再次強調，其實是回傳undefined)，除了直接寫「undefined」外，還可以用「void某個值」，通常會用「void0」。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> result= <span class="title function_">sayHi</span>()</span><br><span class="line">result <span class="comment">//undefined</span></span><br></pre></td></tr></table></figure>

<p>二，在程式設定下，必須區別有意義和無意義的回傳值，而無意義的回傳值希望能是undefined，以避免後續誤判為「有意義」的回傳值而做了錯誤的操作，如下範例所示，這裡有一個定期檢查回傳結果的函式check，check會呼叫函式getResult來得到運算結果並確認結果為何，若沒有得到結果，就顯示經過的分鐘數；若得到結果就印出「工作完成」的訊息。在這裡無意義的回傳值是使用undefined，但當然很多開發者是比較喜歡用false或null，就看當時的需求和個人喜好摟。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> interval = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">let</span> start = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> counter = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 經由一些運算得到結果 result，若有結果則 flag &quot;isDone&quot; 設為 true 並回傳結果；若無結果則 flag &quot;isDone&quot; 設為 false 並回傳 undefined</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getResult</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isDone) &#123;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">void</span> <span class="number">0</span>; <span class="comment">// 等同於 undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不斷重複詢問是否得到結果？若沒有得到結果，就顯示經過的分鐘數；若得到結果就印出「工作完成」的訊息</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check</span>(<span class="params">timestamp</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> progress = timestamp - start;</span><br><span class="line">  <span class="keyword">if</span> (start === <span class="literal">null</span>) &#123; start = timestamp; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (progress &lt; interval) &#123;</span><br><span class="line">    <span class="title function_">requestAnimationFrame</span>(check);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">getResult</span>()) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;工作完成！&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`checking...time passed: <span class="subst">$&#123;counter&#125;</span> minute(s).`</span>);</span><br><span class="line">      counter++;</span><br><span class="line">      start = timestamp;</span><br><span class="line">      <span class="title function_">requestAnimationFrame</span>(check);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">requestAnimationFrame</span>(check);</span><br></pre></td></tr></table></figure>

<h4 id="NaN-無效的數字"><a href="#NaN-無效的數字" class="headerlink" title="NaN(無效的數字)"></a>NaN(無效的數字)</h4><p>NaN表示值為無效的數字(invalid number)，會產生NaN的原因是</p>
<ul>
<li><p>做數字運算時的兩個運算元的資料型並非都是數字或無法轉成有效的十進位或十來進位的數字</p>
</li>
<li><p>無意義的運算，例如：<code>0/0</code>、<code>Infinity/Infinity</code>都會得到NaN</p>
</li>
</ul>
<p>就會產生NaN</p>
<p>NaN有幾個有趣的議題…以下分別討論之。</p>
<h5 id="typeof-1"><a href="#typeof-1" class="headerlink" title="typeof"></a>typeof</h5><p>NaN既然表示是效的數字，依舊還是數字，因此在資料型別的檢測<code>typeof NaN</code>結果就是number，不要被字面上的意思「不是數字」(not a number)給弄糊塗了。</p>
<h5 id="運算結果是NaN"><a href="#運算結果是NaN" class="headerlink" title="運算結果是NaN"></a>運算結果是NaN</h5><p>NaN與任何數字運算都會得到NaN。</p>
<h5 id="唯一不大於、不小於、不等於自已的值"><a href="#唯一不大於、不小於、不等於自已的值" class="headerlink" title="唯一不大於、不小於、不等於自已的值"></a>唯一不大於、不小於、不等於自已的值</h5><p>NaN不大於、不小於也不等於任何值，包含NaN它自已。</p>
<h5 id="isNaN與Number-isNaN"><a href="#isNaN與Number-isNaN" class="headerlink" title="isNaN與Number.isNaN"></a><code>isNaN</code>與<code>Number.isNaN</code></h5><p>要如何檢測運算結果是否為有效的數字呢？那麼就來檢測是否為無效的數字-NaN就可以了，在ES6以前，開發者使用<code>isNaN</code>在數學運算或解析字串後檢測得到的結果是否為合法的數字，其實就是檢測是否為NaN，其過程為先將輸入值使用Number強制轉型為數字，若無法轉為有效的數字而得偌NaN時就判定等於NaN，結果得到true。</p>
<p>範例如下，空物件<code>&#123;&#125;</code>經過isNaN判斷是NaN，意即為無效的數字。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(&#123;&#125;));<span class="comment">//true</span></span><br><span class="line"><span class="comment">// 拆解詳細過程如下...</span></span><br><span class="line"><span class="title class_">Number</span>(&#123;&#125;);<span class="comment">//先將空物件轉為數字，得到NaN</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="title class_">NaN</span>);<span class="comment">// 檢替是否為NaN，得到true</span></span><br></pre></td></tr></table></figure>

<p>其他範例還有…</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="number">123</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(-<span class="number">1.23</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="number">5</span>-<span class="number">2</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="number">0</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="string">&#x27;123&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="string">&#x27;Hello World&#x27;</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="string">&#x27;2000/01/01&#x27;</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="string">&#x27;&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="literal">true</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="literal">undefined</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="string">&#x27;NaN&#x27;</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="title class_">NaN</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="number">0</span>/<span class="number">0</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="number">1</span>/<span class="number">0</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>但這檢測方式的常常會讓開發者得到<a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/isNaN#%E4%BB%A4%E4%BA%BA%E5%9B%B0%E6%83%91%E7%9A%84%E7%89%B9%E6%AE%8A%E7%8B%80%E6%B3%81%E8%A1%8C%E7%82%BA">讓人容易誤解的結果</a>(像是…大多數的人都會爭論…空物件<code>&#123;&#125;</code>就真的不等於NaN呀)，因此ES6推出了<code>Number.isNaN</code>、<code>Number.isNaN</code>不會經過轉為數字的這個過程，而是直接判斷型別是否為數字且是否等於NaN。承上範例，使用<code>Number.isNaN</code> 檢測空物件<code>&#123;&#125;</code>是否為NaN，得到false</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(&#123;&#125;));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>同樣也來看剛才的範例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">123</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(-<span class="number">1.23</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">5</span>-<span class="number">2</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">0</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;123&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;Hello World&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;2000/01/01&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="literal">true</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="literal">undefined</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;NaN&#x27;</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="title class_">NaN</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">0</span>/<span class="number">0</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">1</span>/<span class="number">0</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>雖然ES6出了這個新功能，但不見得所有的瀏覽都會支援，因此對於較舊的瀏器就掛個polyfill來模擬這個新功能。</p>
<p>polyfill如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Number</span>.<span class="property">isNaN</span>) &#123;</span><br><span class="line">  <span class="title class_">Number</span>.<span class="property">isNaN</span> = <span class="keyword">function</span> <span class="title function_">isNaN</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x !== x; <span class="comment">// NaN 是唯一一個不等於自己的值</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="無限-Infinity"><a href="#無限-Infinity" class="headerlink" title="無限(Infinity)"></a>無限(Infinity)</h5><p>無限分為正無限(在ES6定義為Number.POSITIVE_INFINITY)和負無限(在ES6為<code>Number.NEGSTIVE_INFINITY</code>)，在數字連算中會得到無限的原因是</p>
<ul>
<li>除以零，例如：<code>1/0</code>得到Infinity，<code>-1/0</code>得到-Infinity</li>
<li>溢位(overflow)，例如：<code>Number.MAX_VALUE + Math.pow(2,970)</code>得到Infinity(備註)</li>
</ul>
<p>又，無限與無限做數字運算，一般來說會得到無限。除了..</p>
<ul>
<li><p>無意的運算，例如：<code>0/0</code>、<code>Infinity/Infinity</code>都會得到NaN</p>
</li>
<li><p><code>1/Infinity</code>得到0，<code>-1/Infinity</code>得偌-0</p>
</li>
</ul>
<p>備註：若運算結果接近<code>Number.MAX_VALUE</code>而非Infinity，則會取一個最接近的值為<code>Number.MAX_VALUE</code>，𫍇稱為「向下約整」(rounds down);同理，若運算結果接近Infinity而非<code>Number.MAX_VALUE</code>, 則會取一個最接近的值為Infinity，𫍇稱為「向上約整」(rounds up)</p>
<h4 id="零-Zero"><a href="#零-Zero" class="headerlink" title="零(Zero)"></a>零(Zero)</h4><p>零分為正零(+0)和負零(-0)，正負號在表達方向上是很有用的。其中，產生負零的原因是乘除運算中，運算元的其中一方為負數，例如：<code>-0/1</code>或<code>0/-1</code>會得到-0。</p>
<p>零有幾個有趣的議題…以下分別討論之。</p>
<h5 id="數字轉字串vs字串轉數字"><a href="#數字轉字串vs字串轉數字" class="headerlink" title="數字轉字串vs字串轉數字"></a>數字轉字串vs字串轉數字</h5><p>不管是正零(+0)或負霧(-0)，轉字串後一律為「<code>0</code>」。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>((+<span class="number">0</span>).<span class="title function_">toString</span>());<span class="comment">// &quot;0&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">String</span>(+<span class="number">0</span>));<span class="comment">//&quot;0&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;&#x27;</span> + (+<span class="number">0</span>));<span class="comment">//&quot;0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>((-<span class="number">0</span>).<span class="title function_">toString</span>());<span class="comment">// &quot;0&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">String</span>(-<span class="number">0</span>));<span class="comment">//&quot;0&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;&#x27;</span> + (-<span class="number">0</span>));<span class="comment">//&quot;0&quot;</span></span><br></pre></td></tr></table></figure>

<p>相反的、若從字串轉數字，則</p>
<ul>
<li><p>字串正零(<code>&#39;+0&#39;</code>)會轉成數字0或報錯，但其實正零一般來說都是表示為「0」</p>
</li>
<li><p>字串負零(<code>&#39;-0&#39;</code>)會轉成數字-0</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(+<span class="string">&#x27;+0&#x27;</span>);<span class="comment">//0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="string">&#x27;+0&#x27;</span>));<span class="comment">//0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;+0&#x27;</span>));<span class="comment">// Uncaught SyntaxError: Unexpected token + in JSON at positi</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(+<span class="string">&#x27;-0&#x27;</span>);<span class="comment">//0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="string">&#x27;-0&#x27;</span>));<span class="comment">//0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;-0&#x27;</span>));<span class="comment">//0</span></span><br></pre></td></tr></table></figure>

<h5 id="如何辨別正零和負零"><a href="#如何辨別正零和負零" class="headerlink" title="如何辨別正零和負零?"></a>如何辨別正零和負零?</h5><p>正零(+0)或負零(-0)是無法從比較運算子和相等運算子中得到差異。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">0</span>; <span class="comment">// 0</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="number">0</span> / -<span class="number">1</span>; <span class="comment">// -0</span></span><br><span class="line"></span><br><span class="line">a == b; <span class="comment">// true</span></span><br><span class="line">-<span class="number">0</span> == <span class="number">0</span>; <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">a === b; <span class="comment">// true</span></span><br><span class="line">-<span class="number">0</span> === <span class="number">0</span>; <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span> &gt; -<span class="number">0</span>;	<span class="comment">// false</span></span><br><span class="line">a &gt; b; <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>那到底要如何辨別正零和負零呢？</p>
<p>解法的𦂇驟如下</p>
<ol>
<li><p>先將輸入值轉為數字，若為-0則<code>Number(-0)</code>為-0,並檢查結果是否等於胕</p>
</li>
<li><p>由於<code>1/-0</code>得到-Infinity，因此就可檢測輸入值是否為負零</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isNegZero</span>(<span class="params">n</span>) &#123;</span><br><span class="line">    n = <span class="title class_">Number</span>(n);</span><br><span class="line">    <span class="keyword">return</span> (n === <span class="number">0</span>) &amp;&amp; (<span class="number">1</span> / n === -<span class="title class_">Infinity</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 測試</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isNegZero</span>(-<span class="number">0</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isNegZero</span>(<span class="number">0</span> / -<span class="number">1</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isNegZero</span>(<span class="number">0</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>  稍後會再提供另一個解法-<code>Object.is(..)</code></p>
<h5 id="特殊相等性-Special-Equality"><a href="#特殊相等性-Special-Equality" class="headerlink" title="特殊相等性(Special Equality)"></a>特殊相等性(Special Equality)</h5><p>針對負零(-0)和NaN的比較，除了以上提過的方法外，還可以用<code>Object.is(..)</code>來做檢測。</p>
<p><code>Object.is(..)</code>會比較兩值是否相等，而<code>Object.is(..)</code>的運作和嚴格相等是一樣的，但會將NaN、-0、和+0獨立處理。到底㤰麼定義「相等」呢？有興趣的可以參考 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Equality_comparisons_and_sameness">MDN</a>的說明。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="title class_">Number</span>(<span class="string">&#x27;Hello World&#x27;</span>);<span class="comment">// NaN</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="number">0</span> / -<span class="number">1</span>; <span class="comment">//-0 </span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">is</span>(a,<span class="title class_">NaN</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">is</span>(b,-<span class="number">0</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">is</span>(b,<span class="number">0</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>世紀難題都被它解決了，</p>
<h3 id="你懂JavaScript嗎？原生功能-Natives"><a href="#你懂JavaScript嗎？原生功能-Natives" class="headerlink" title="你懂JavaScript嗎？原生功能(Natives)"></a>你懂JavaScript嗎？原生功能(Natives)</h3><p>主要會談到</p>
<ul>
<li><p>何謂原生功能(Natives)?</p>
</li>
<li><p>物件包裹器、陷阱、解封裝。</p>
</li>
<li><p>各類建搆子的原生功能、原生的原型。雖然優先使用字面值而非使用建構子建立物件、還是需要來看一些需要關心的議題和警惕用的錯誤用法。</p>
</li>
</ul>
<h4 id="何謂原生功能-Natives"><a href="#何謂原生功能-Natives" class="headerlink" title="何謂原生功能(Natives)?"></a>何謂原生功能(Natives)?</h4><p>原生功能(Natives)其實指的就是「內建函式」(built-in function)，最常用的像是<code>String()</code>、<code>Number()</code>、<code>Boolean()</code>、<code>Array()</code>、<code>Object()</code>、<code>Function()</code>、<code>RegExp()</code>、<code>Date()</code>、<code>Error()</code>、<code>Symbol()</code>，其中null和undefined是沒有內建函式的。我們也可以將Natives當成建構子(constructor)來建立值。注意，使用建構子建立出來的值是一僤包裹了基本型別值的物件包裹器(object wrapper)，而這個包裹器在其原型(prototype)上定義了許多屬性和方法，因此這些資料型態就能如物件般擁有屬性和方法以供使用。</p>
<p>範例如下，使用<code>new String(&#39;...&#39;)</code>來建立字串值「Hello World!」，</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> s = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s);<span class="comment">//String &#x27;Hello World!&#x27; </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s.<span class="title function_">toString</span>());<span class="comment">// &quot;Hello World!&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> s);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s <span class="keyword">instanceof</span> <span class="title class_">String</span>);<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(s));<span class="comment">//[object String]</span></span><br></pre></td></tr></table></figure>

<p>說明</p>
<ul>
<li><p>s是一個包裹了基本型別值String的物件包裹器，簡稱為「字串包裹器物件」，包裹了字串「Hello World!」，而非只是建立了字串本身。</p>
</li>
<li><p>s這個字串包裹器物件的原型上定義了toString方法，因此可使用<code>s.toString()</code>得到字串值。</p>
</li>
<li><p>使用 <a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Operators/typeof">typeof</a> 來判斷值的型別，例如，<code>typeof s</code>檢視s的型別，結果是「物件」。</p>
</li>
<li><p>使用<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/instanceof">instanceof</a> 來判斷值是否為指定的物件型別，例如，<code>s instanceof String</code>確認s為String的實體物件。</p>
</li>
<li><p>使用<code>Object.prototype.toString</code>取得物件的子分類、得到字串。</p>
</li>
</ul>
<h4 id="Internal-Class"><a href="#Internal-Class" class="headerlink" title="Internal[[Class]]"></a>Internal<code>[[Class]]</code></h4><p>物件型別的值其內部有一固<code>[[Class]]</code>屬性來標記這個值是屬於物件的哪個子分類，雖然無法直接取用，但可透過<code>Object.prototype.toString</code>  間接取得，範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="string">&#x27;Hello World&#x27;</span>));<span class="comment">//[object String] </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="literal">true</span>));<span class="comment">//[object Boolean]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="literal">null</span>));<span class="comment">//[object Null]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="literal">undefined</span>));<span class="comment">//[object Undefined] </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]));<span class="comment">//[object Array]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span> &#125;));<span class="comment">//[object Object] </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params"></span>) &#123; &#125;));<span class="comment">//[object Function] </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="regexp">/helloworld/i</span>));<span class="comment">//[object RegExp]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">new</span> <span class="title class_">Date</span>()));<span class="comment">//[object Date]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="title class_">Symbol</span>(<span class="string">&#x27;foo&#x27;</span>)));<span class="comment">//[object Symbol]</span></span><br></pre></td></tr></table></figure>

<h4 id="封裝用的包裹器-BoxingWrappers"><a href="#封裝用的包裹器-BoxingWrappers" class="headerlink" title="封裝用的包裹器(BoxingWrappers)"></a>封裝用的包裹器(BoxingWrappers)</h4><p>由於JavaScirpt引擎會自動為基本型別值包裹(或稱封裝)物件包裹器，因此字面值能𢁍屬性或方法可用，例如</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> s = <span class="string">&#x27;Hello World!&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s.<span class="property">length</span>);<span class="comment">//12</span></span><br></pre></td></tr></table></figure>

<p>那麼，直托使用物件形式的物件包裹器來宣告變數，而非隱含地讓JavaScript引擎轉換，是不是比較好呢？答案是否定的，第一，這樣效能不佳，使用字面值可讓JavaScript預先編譯並快取起來！第二，沒有必要，字面值可幾乎可完全取代物件包裹器做的事情-因此，就讓JavaScript引擎自動為我們做這個封裝的工作吧。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> s = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;Hello World!&#x27;</span>);<span class="comment">//錯誤示範！效能差！</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s.<span class="property">length</span>);<span class="comment">//12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> s_the_other= <span class="title class_">Object</span>(<span class="string">&#x27;Hello World!&#x27;</span>);<span class="comment">// 錯誤示範！效能差！</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s_the_other.<span class="property">length</span>);<span class="comment">//12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> s_another =<span class="string">&#x27;Hello World!&#x27;</span>;<span class="comment">//正確示範！效能佳！</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s_another.<span class="property">length</span>);<span class="comment">//12</span></span><br></pre></td></tr></table></figure>

<h4 id="物件包裹器的陷阱-Object-Wrapper-Gotchas"><a href="#物件包裹器的陷阱-Object-Wrapper-Gotchas" class="headerlink" title="物件包裹器的陷阱(Object Wrapper Gotchas)"></a>物件包裹器的陷阱(Object Wrapper Gotchas)</h4><p>由於直接使用物件形式的物件包裹器來宣告變數會造縑一些誤用，像是難以做條件判斷，因此非常不建議這麼做！使用之前請三思！</p>
<p>如下範例，使用物件包裹器宣告一個布林變數isValid，其值希望是false，但實際上卻是一個物件<code>Boolean &#123;true&#125;</code>，導致進入判斷式轉型為true, 印出訊息「可以繼續運作…」</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> isValid = <span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isValid) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;可以繼續運作...&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;不合規則，等得處理...&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 可以繼續運作...</span></span><br></pre></td></tr></table></figure>

<p>怎麼辦？很簡單，「解封裝」就行啦！繼續看下去吧！</p>
<h4 id="解封裝-Unboxing"><a href="#解封裝-Unboxing" class="headerlink" title="解封裝(Unboxing)"></a>解封裝(Unboxing)</h4><p>解封裝是指將底層的基本型別值取出來。</p>
<p>承上範例，isValid的值居然是物件<code>Boolean &#123;true&#125;</code>，只好使用<code>valueOf</code>來抽出底層的基型值摟，其他強制轉型的方法待後強制轉型的部份補充。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">isValid.<span class="title function_">valueOf</span>()<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<h4 id="建構子的原生功能"><a href="#建構子的原生功能" class="headerlink" title="建構子的原生功能"></a>建構子的原生功能</h4><p>再次強調，優先使用字面值而非使用建構子建立物件。但在這個「建構子的原生功能」部份，我們還是來看一些需要關心的議題和警惕用的錯誤用法。</p>
<h5 id="Array"><a href="#Array" class="headerlink" title="Array(..)"></a><code>Array(..)</code></h5><ul>
<li>不管是否使用new，陣列的物件包裹器所建立的物件是相同的，意即<code>new Array(...)</code>和<code>Array(...)</code>同義。</li>
<li>若只傳入一個數字，則不會被當成陣列內容，而會是陣列長度來預先設定陣列的大小，實際上這是個虛胖的空陣列，而裡面沒有存任何東西，是empty。這種具有空插槽(empty slot)的陣列在做陣列處理時容易產生不可預期的錯誤。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="title class_">Array</span>(<span class="number">10</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// (10) [empty × 10]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">length</span>);<span class="comment">// 10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b =[<span class="literal">undefined</span>,<span class="literal">undefined</span>,<span class="literal">undefined</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">delete</span> b[<span class="number">1</span>]);<span class="comment">// true，成功刪除一個元素？</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b);<span class="comment">// [undefined, empty, undefined]，這裡產生一個空插槽！</span></span><br></pre></td></tr></table></figure>

<h5 id="RegExp"><a href="#RegExp" class="headerlink" title="RegExp(..)"></a><code>RegExp(..)</code></h5><p>在正規表達式方 ，只有一種狀況會需要用到物件包裹器而非字面值，就是必須「動態地」為正規表達式建立範式(pattern)，意即<code>new RegExp(&#39;pattern&#39;,&#39;flags&#39;)</code>的格式。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&#x27;Apple&#x27;</span>;</span><br><span class="line"><span class="type">const</span> <span class="variable">pattern</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&quot;\\b(?:&quot;</span> + name + <span class="string">&quot;)+\\b&quot;</span>, <span class="string">&quot;ig&quot;</span>);</span><br><span class="line"><span class="type">const</span> <span class="variable">matches</span> <span class="operator">=</span> <span class="string">&#x27;Hi, Apple&#x27;</span>.match(pattern);</span><br><span class="line"></span><br><span class="line">console.log(matches);<span class="comment">//[ &#x27;Apple&#x27; ] </span></span><br></pre></td></tr></table></figure>

<h5 id="Date-與Error"><a href="#Date-與Error" class="headerlink" title="Date(..)與Error(..)"></a><code>Date(..)</code>與<code>Error(..)</code></h5><p>Data與Error沒有字面值格式，只能用物件包裹器作為建構子的方式建立物件。</p>
<p>Error需要注意的地方是，不管是否使用new，陣列的物件包裹器所建立的物件是相同的，意即<code>new Error(...)</code>和<code>Error(...)</code>同義。</p>
<h5 id="Symbol-…"><a href="#Symbol-…" class="headerlink" title="Symbol(…)"></a>Symbol(…)</h5><p>Symbol同樣沒有字面值格式，若要自定義的Symbol，就要使用建構子<code>Symbol(..)</code>且不可在前面加上new，否則會報錯。</p>
<h4 id="原生的原型-Native-Prototype"><a href="#原生的原型-Native-Prototype" class="headerlink" title="原生的原型(Native Prototype)"></a>原生的原型(Native Prototype)</h4><p>每個建構子都有自已的<code>.prototype</code>物件，例如：<code>Array.prototype</code>、<code>String.prototype</code>等，而這些<code>.prototype</code>物件擁有各自子物件的專屬行為。白話來說，就是經由建構子建立的物件與經由JavaScript引擎封裝的字面值，由於原型委派(prototype delegation)的緣故，都能使用定義<code>.prototype</code>的屬性和方法。例如，無論是經由<code>String()</code>建構子或經由JavaScript引擎封裝的字串基本型別字面值，由於原型委派(prototype delegation)的綠故，都能使用定義於<code>String.prototype</code>的屬性和方法。又<code>String.prototype.XYZ</code>可簡寫為<code>String#XYZ</code>，例如：<code>String#indexOF(..)</code>、<code>String#charAt(..)</code>等，其他型別都各自有其行為。</p>
<p><strong>注意，不要任意修改這些預設的原生的原型</strong>(甚至建議不要無條件地擴充原生的原型，若要擴充也應撰寫符合規格的崱試程式)，這在後續強制轉型的部份會看到一虛例子。</p>
<p><code>Array.prototype</code>是空陣列，<code>Function.prototype</code>是空的函式，<code>RegExp.prototype</code>是空的正規很達式，因此有人會拿來做為變數的初始值，雖然可能節省了重新創建新值和垃圾回收的工作而讓效能變好，但這可能會在無意間修改了這些預設的原生的原型，這是要避免的。</p>
<h3 id="你懂JavaScript嗎？強制轉型-Coercion"><a href="#你懂JavaScript嗎？強制轉型-Coercion" class="headerlink" title="你懂JavaScript嗎？強制轉型(Coercion)"></a>你懂JavaScript嗎？強制轉型(Coercion)</h3><p>強制轉型(coercion)到底是的個有用的功能，還是設計上的缺陷呢?</p>
<p>主要會談到</p>
<ul>
<li><p>強制轉型(coercion)分為兩種，分別是「明確的」強制轉型(explicit coercion)和「隱含的」強轉型(implicit coercion)，只要是程式碼中刻意寫出來的型別轉換動作，就是明確的強制轉型；反之，在程式碼沒有明確指出要轉換型別卻轉型的，就是隱含的強制轉型。</p>
</li>
<li><p>明確的強型轉型規則與範例說明。</p>
</li>
<li><p>隱含的強型轉型規則歹範例說明。</p>
</li>
<li><p>Symbol的強制轉型的規則與範例說明。</p>
</li>
<li><p>隱含的強制轉型的心酸血淚？各種令人崩潰的範例。</p>
</li>
<li><p>押象的關系式比較。</p>
</li>
</ul>
<h4 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h4><p>強制轉型(coercion)分為兩種，分別是「明確的」強制轉型(explicit coercion)和「隱含的」強制轉型(implicit coercion)，只要是程式碼中刻意寫出來的型別轉換的動作，就是明確的強制轉型； 反之，在程式碼中沒有明確指出要轉換型卻轉型的，就是隱含的強制轉型。</p>
<p>範例如下，b的的值由運算式<code>String(a)</code>而來，這裡表明會將a強制轉為字串，因此是明確的強制轉型； 而c的值由運算式<code>a + &#39;&#39;</code>而來，當兩值的型別不同且其中一方是字串時，<code>+</code>所代表的是定字串運算子，要將兩字串做串接，而會將數字強制轉型為字串，並連接兩個字串，因此是隱含的強制轉型，稍後會再詳述。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">42</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="title class_">String</span>(a); <span class="comment">//明確的強制轉型</span></span><br><span class="line"><span class="keyword">var</span> c = a + <span class="string">&#x27;&#x27;</span>;<span class="comment">//隱含的強制轉型</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b);<span class="comment">// &#x27;42&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c);<span class="comment">// &#x27;42&#x27;</span></span><br></pre></td></tr></table></figure>

<p>注意，無論是明確或隱含，強制轉型的結果會是基本型別值，例如：數字，布林或字串，</p>
<h4 id="抽象的值運算"><a href="#抽象的值運算" class="headerlink" title="抽象的值運算"></a>抽象的值運算</h4><p>「抽象的值運算」指的是「內部限定的運算」，意即這是JavaScirpt引擎在背後偷偷幫我們做的工作，在這個部分會來探討ToString、ToNumber、ToBoolen和ToPrimitive這幾個押象的值運算，來看看到底在強轉型時背地裡做了什麼好事。</p>
<h5 id="ToString"><a href="#ToString" class="headerlink" title="ToString"></a>ToString</h5><p>任何非字串的值被強制轉型為字串時，會遵循ES5的規格中的 <a href="https://es5.github.io/#x9.8">ToString</a> 來運作。</p>
<p>規則簡單說明如下</p>
<ul>
<li><p>undefined-&gt; <code>undefined</code>。</p>
</li>
<li><p>null-&gt;<code>null</code>。</p>
</li>
<li><p>boolean的true-&gt;<code>true</code>，false-&gt;<code>false</code>。</p>
</li>
<li><p>在數字方面，非常大或非常小的數字以指數呈現，例如:<code>1.23e21</code>。</p>
</li>
<li><p>物件</p>
<ul>
<li><p>若有定義<code>toString</code>方法，則會以它自已的<code>toString</code>方法所產生的結果為優先，例如，陣列有自己定義的<code>toString</code>方法，因此<code>[1,2,3].toString()</code>會得到<code>&quot;1,2,3&quot;</code>。</p>
</li>
<li><p>若沒有定義<code>toString</code>方法，則回傳內部的屬性<code>[[Class]]</code>，這是一個用來標記這個值是屬於物件的哪個子分類的標籤，例如：<code>(&#123;&#125;).toString()</code>會得到<code>[object Object]</code>。</p>
<img src="tostring-conversions.png" style="zoom:85%;" />

<p>圖片來源：<a href="https://es5.github.io/#x9.8">ToString Conversions</a></p>
</li>
</ul>
</li>
</ul>
<h4 id="JSON的字串化-JSON-Stringification"><a href="#JSON的字串化-JSON-Stringification" class="headerlink" title="JSON的字串化(JSON Stringification)"></a>JSON的字串化(JSON Stringification)</h4><p>順道一提JSON的字串化。</p>
<p>JSON的字串化<code>JSON.stringify</code>將值序列化(serialize)為JSON字串，這個轉無JSON字串的過程與ToString規則有關，但並不等於強制轉型。規則算簡單說明如下</p>
<ul>
<li>若為簡單值，即字串、數字、布林、null，則規與ToString相同。這些能轉為JSON字串的值稱為是「JSON-safe」的值，意即只要對JSON來說是安全的(safe)，就都能轉為JSON字串。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="number">42</span>));<span class="comment">//&quot;42&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="literal">true</span>));<span class="comment">//&quot;true&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="literal">null</span>));<span class="comment">//&quot;null&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">`Hello World`</span>));<span class="comment">//&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>無法轉為JSON字串的非法值有undefined、function、symble、具有徝環參考(circular reference)的物件，由於它們無法轉為JSON字串，因此<code>JSON.stringify</code>會自動忽略這些非法值或丟出錯誤。又，若陣列中某個元素的值無非法值則自動以null取代；若物件中的其中的一個屬性為非法值，則會非除這個屬性。</p>
</li>
<li><p>若無物件具有定義<code>toJSON</code>方法則會優先呼叫此方法，並依此方法之回傳值作為序列化的結果，因此，若試圖JSON字串化一個含有非法值的物件，應定義其<code>toJSON</code>方法以回傳適當的JSON-safe的值。</p>
<p>範例如下。</p>
<p>若陣列中某個元素的值為非法值則會自動以null取代； 若物件中的其中一個屬性為非法值，則會非除這個屬性。</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="literal">undefined</span>));<span class="comment">// undefined、忽略非法值</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;));<span class="comment">// undefined、忽略非法值</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="title class_">Symbol</span>()));<span class="comment">// undefined、忽略非法值</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="literal">undefined</span>]));<span class="comment">//// &quot;[1,2,3,null]&quot;，非法值以 null 取代</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">a</span>: <span class="number">2</span>, <span class="attr">b</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125; &#125;));<span class="comment">//&quot;&#123;&quot;a&quot;:2&#125;&quot;，忽略非法屬性</span></span><br></pre></td></tr></table></figure>

<p>具有循環參考的物件，丟出錯誤。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123; <span class="attr">someProperty</span>: <span class="string">&#x27;Jack&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> b = &#123; <span class="attr">anotherProperty</span>: a &#125;;</span><br><span class="line">a.<span class="property">b</span> = b;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(a));<span class="comment">// Uncaught TypeError: Converting circular structure to JSON</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(b));<span class="comment">// Uncaught TypeError: Converting circular structure to JSON</span></span><br></pre></td></tr></table></figure>

<p>針對含有非法值的物件或具有循環參考的物件，解法是定義其<code>toJSON</code>方法以回傳JSON-safe的值。</p>
<p>範例如下，物件someObj含有非法的屬性會導致轉JSON字串時被忽略，因此定義其<code>toJSON</code>方法只要序列化合法的a屬性即可。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> someObj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">b</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;,<span class="comment">//非法！</span></span><br><span class="line">    <span class="attr">toJSON</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">a</span>: <span class="number">2</span>,<span class="comment">// 序𦕁化過程只包含a屬性</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(someObj));<span class="comment">// &quot;&#123;&quot;a&quot;:2&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>再看一個範例，對於「具有循環參考的物件」該怎麼處理呢？如下，a和b是具有循環參考的物件，在先前的例子中<code>JSON.stringify(a)</code>和<code>JSON.stringifg(b)</code>會丟出錯誤「Uncaught TypeError:Converting circular structure to JSON」，因此分別定義其<code>toJSON</code>方法，這裡的序列化過程只包含prompt屬性且其值為字串<code>Hello World</code>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">    <span class="attr">someProperty</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">toJSON</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">prompt</span>: <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">    <span class="attr">anotherProperty</span>: a,</span><br><span class="line">    <span class="attr">toJSON</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">prompt</span>: <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a.<span class="property">b</span> = b;</span><br><span class="line"><span class="comment">// 序列化成功！不會被報錯了！</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(a));<span class="comment">// &quot;&#123;&quot;prompt&quot;:&quot;Hello World&quot;&#125;&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(b));<span class="comment">// &quot;&#123;&quot;prompt&quot;:&quot;Hello World&quot;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>除了<code>toJSON</code>外，<code>JSON.stringify</code>也可傳入第二個選擇性參數「取代器」(replacer,可為陣列或函式)來自訂過濾機制，決定序列化過程中應該包含哪些屬性。</p>
<ul>
<li><p>取代器為陣列時，陣列內的元素為指定要包含的屬性名稱。如下，指定序列化過程中只需要包含a屬性。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> someObj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">b</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(someObj,[<span class="string">&#x27;a&#x27;</span>]));<span class="comment">// &quot;&#123;&quot;a&quot;:2&#125;&quot;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>取代器為函數時，函式是用來運算要回傳以做序列化的屬性的值。如下，指定除了b以外的屬性都要做序列化。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> someObj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">b</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(someObj, <span class="keyword">function</span> (<span class="params">key, value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key !== <span class="string">&#x27;b&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br><span class="line"><span class="comment">// &quot;&#123;&quot;a&quot;:2&#125;&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="ToNumber"><a href="#ToNumber" class="headerlink" title="ToNumber"></a>ToNumber</h5><p>若需要將非數字當成數字來操作，像是做數學運算，就會遵循ES5的規格中的<a href="https://es5.github.io/#x9.3">ToNumber</a> 來運作。規則簡單說明如下</p>
<ul>
<li><p>undefined -&gt; NaN。</p>
</li>
<li><p>null -&gt; +0即是0。</p>
</li>
<li><p>boolean 的true -&gt; 1，false -&gt; +0 即是0。</p>
</li>
<li><p>string -&gt; 數字或NaN。</p>
</li>
<li><p>object</p>
<ul>
<li><p>若有定義其<code>valueOf</code>方法，則會優先使用<code>valueOf</code>取得其基本型別值。</p>
</li>
<li><p>若沒有定義<code>valueOf</code>方法，則會改用<code>toString</code>方法取得其基本型別值，再用ToNumber轉為數字，在這裡先簡化為<code>Number(..)</code>會來處理這一連串的流程即可。</p>
</li>
<li><p>注意，以<code>Object.create(null)</code>建立的null沒有<code>valueOf</code>或<code>toString</code>方法，因此在式圖轉為基本型別值的時候會出錯，丟出TypeError. </p>
<img src="tonumber_conversions.png" style="zoom:85%;" />

<p>圖片來源：<a href="https://es5.github.io/#x9.3">ToNumber Conversions</a></p>
<p>範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="literal">undefined</span>));<span class="comment">// NaN</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="literal">null</span>));<span class="comment">// 0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="literal">true</span>));<span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="literal">false</span>));<span class="comment">// 0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="string">&#x27;12345&#x27;</span>));<span class="comment">// 12345</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="string">&#x27;Hello World&#x27;</span>));<span class="comment">// NaN</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(&#123;<span class="attr">name</span>:<span class="string">&#x27;Jace&#x27;</span>&#125;));<span class="comment">// NaN</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> a =&#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">valueOf</span>:<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;999&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(a));<span class="comment">// 999</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h5 id="ToBoolean"><a href="#ToBoolean" class="headerlink" title="ToBoolean"></a>ToBoolean</h5><p> 讓我們複習一下 Truthy 與 Falsy 的概念，這會遵循 ES5 的規格中的 <a href="https://es5.github.io/#x9.2">ToBoolean</a> 來運作。</p>
<img src="toboolean_conversions.png" style="zoom:85%;" />

<p>圖片來源：<a href="https://es5.github.io/#x9.2">ToBoolean Conversions</a></p>
<h6 id="Falsy值"><a href="#Falsy值" class="headerlink" title="Falsy值"></a>Falsy值</h6><p>在JavaScirpt中會被轉為false的值有</p>
<ul>
<li><p><code>&quot;&quot;</code>空字串</p>
</li>
<li><p>0,-0,NaN</p>
</li>
<li><p>null</p>
</li>
<li><p>undefined</p>
</li>
<li><p>false</p>
<p>我們只要熟記這幾個值就可以了！</p>
</li>
</ul>
<p>而除了以上的值之外，都會被轉為ture,與例如下</p>
<ul>
<li><p><code>&#39;Hello World&#39;</code>非空字串。</p>
</li>
<li><p>42非零的有效數字</p>
</li>
<li><p><code>[],[1,2,3]</code>陣列，不管是不是空的</p>
</li>
<li><p><code>&#123;&#125;,&#123;name:&#39;Jack&#39;&#125;</code>物件，不管是不是空的</p>
</li>
<li><p><code>function foo()&#123;&#125;</code>函式</p>
</li>
<li><p>true</p>
</li>
</ul>
<h4 id="Falsy物件"><a href="#Falsy物件" class="headerlink" title="Falsy物件"></a>Falsy物件</h4><p>當使用包裹物件來建立字串、數字或布林值時，由於包了一層物件，因此就算其底層的基型值是會被轉為false的值，它根本上都還是個物件，而只要是物件(即使是空物件)，就會被轉為true.。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> b= <span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">const</span> c= <span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!a); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!b); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!c); <span class="comment">// true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Truthy-值"><a href="#Truthy-值" class="headerlink" title="Truthy 值"></a>Truthy 值</h4><p>再次強調，只要不是前面列舉為會轉為 false 的值，都會被轉為 true。</p>
<h4 id="ToPrimitive"><a href="#ToPrimitive" class="headerlink" title="ToPrimitive"></a>ToPrimitive</h4><p>詳細狀況可見 ES5 <a href="https://es5.github.io/#x9.1">規格</a>。規則簡單說明如下</p>
<ul>
<li><p>undefined -&gt; undefined(基本型別，不轉換)</p>
</li>
<li><p>null -&gt; null (基本型別值，不轉換)</p>
</li>
<li><p>boolean -&gt; boolean(基本型別值，不轉換)</p>
</li>
<li><p>number -&gt; number(基本型別值，不對換)</p>
</li>
<li><p>object：使用<code>[[DefaultValue]]</code>內部方法，依照傳入的參數來決定要使用toString或valueOf取得基本型別值，，看參考<a href="https://es5.github.io/#x8.12.8">規格</a>。</p>
</li>
</ul>
<h4 id="明確的強制轉型-Explicit-Coercion"><a href="#明確的強制轉型-Explicit-Coercion" class="headerlink" title="明確的強制轉型(Explicit Coercion)"></a>明確的強制轉型(Explicit Coercion)</h4><p>「明確的強制轉型」是指程式碼中刻意寫出來的明顯的型別轉換的動作。</p>
<h5 id="明確的Strings-Numbers"><a href="#明確的Strings-Numbers" class="headerlink" title="明確的Strings &lt;–&gt; Numbers"></a>明確的Strings &lt;–&gt; Numbers</h5><p>字串與數字間的明確的強制轉換。</p>
<h6 id="方法一：使用內建函式String-與Number"><a href="#方法一：使用內建函式String-與Number" class="headerlink" title="方法一：使用內建函式String(..)與Number(..)"></a>方法一：使用內建函式<code>String(..)</code>與<code>Number(..)</code></h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">String</span>(<span class="number">123</span>) <span class="comment">// &quot;123&quot;</span></span><br><span class="line"><span class="title class_">Number</span>(<span class="string">&#x27;123&#x27;</span>) <span class="comment">// 123</span></span><br></pre></td></tr></table></figure>

<p>注意，這裡的<code>String(..)</code>是直接調用<code>.toString</code>來轉字串，與<code>+</code>字串運算子經過ToPromitive的運作-由於傳入<code>[[DefaultValue]]</code>演算法的參數是number，因此先使用<code>valueOf</code>取得基型值，然後再用<code>toString</code>轉為字串，兩種方法 全不同的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">    <span class="attr">toString</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="number">54321</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">    <span class="attr">valueOf</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="number">12345</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">String</span>(a));<span class="comment">// &quot;54321&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b+<span class="string">&#x27;&#x27;</span>);<span class="comment">// &quot;12345&quot;</span></span><br></pre></td></tr></table></figure>

<h6 id="方法二：使用物件原型的方法-toString"><a href="#方法二：使用物件原型的方法-toString" class="headerlink" title="方法二：使用物件原型的方法.toString()"></a>方法二：使用物件原型的方法<code>.toString()</code></h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="number">123</span>).<span class="title function_">toString</span>() <span class="comment">// &quot;123&quot;</span></span><br></pre></td></tr></table></figure>

<h6 id="方法三：使用一元正-負運算子-、"><a href="#方法三：使用一元正-負運算子-、" class="headerlink" title="方法三：使用一元正&#x2F;負運算子+、-"></a>方法三：使用一元正&#x2F;負運算子<code>+</code>、<code>-</code></h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">+(<span class="string">&#x27;123&#x27;</span>) <span class="comment">// 123</span></span><br><span class="line">-(<span class="string">&#x27;-123&#x27;</span>) <span class="comment">// 123</span></span><br></pre></td></tr></table></figure>

<p>這個方法有個缺點，就是很容易造成各種語意上的誤會，像是與遞增(<code>++</code>)和遞減(<code>--</code>)或與二元運算子的數學運算「加」(<code>+</code>)和「減」(<code>-</code>)混淆。：</p>
<p>較常使用一元正和負運算子<code>+</code>、<code>-</code>的時機是將<strong>日期轉為數字</strong>，也就是取得1970年1月1日00:00:00UTC到目前為止的毫秒數，或稱UNIX時間戳記、時戳值timestamp。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> timestamp = +<span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(timestamp);<span class="comment">//1566871728004 </span></span><br></pre></td></tr></table></figure>

<p>經由強制轉型取得時戳值並不是很好的方法，建議改用<code>Date.now()</code>或<code>.getTime()</code>會是更㞅想的作法，可讀性更高。</p>
<h6 id="方法四：使用一元位否定運算子"><a href="#方法四：使用一元位否定運算子" class="headerlink" title="方法四：使用一元位否定運算子~"></a>方法四：使用一元位否定運算子<code>~</code></h6><p>位元否定運算子(bitwise not)的功能是進行二進位的補數(公式為<code>~x</code>得到<code>-(x+1)</code>，例如~42得到-43)，它會先將值經由ToNumber轉為數字，再經由ToInt32轉障32位元有號整數，最後再逐位元的否，很類似<code>!</code>強制將值轉八布林並反轉其真偽的運作方式。</p>
<p>範例如下，<code>~</code>接受indexOf的回傳值並作轉換，對於「找不到」的-1會轉為0，做條件判斷時會再轉為false，其他的會回傳索引值(例如：0、1、2…)經否定再轉布林時都會是true,這樣的寫法有助於提高可讀性。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">find</span>(<span class="params">target</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> result = str.<span class="title function_">indexOf</span>(target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (~result) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`找到了，索引值原本是 <span class="subst">$&#123;result&#125;</span>，被轉為 <span class="subst">$&#123;~result&#125;</span>`</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`找不到，回傳結果原本是 <span class="subst">$&#123;result&#125;</span>，被轉為 <span class="subst">$&#123;~result&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">find</span>(<span class="string">&#x27;llo&#x27;</span>); <span class="comment">// 找到了，索引值原本是 2，被轉為 -3</span></span><br><span class="line"><span class="title function_">find</span>(<span class="string">&#x27;abc&#x27;</span>) <span class="comment">// 找不到，回傳結果原本是 -1，被轉為 0</span></span><br></pre></td></tr></table></figure>

<h6 id="同場加映-浮點數轉為整數"><a href="#同場加映-浮點數轉為整數" class="headerlink" title="同場加映:浮點數轉為整數"></a>同場加映:浮點數轉為整數</h6><p>使用<code>~~</code>將浮點數轉為整數，其運作方式為反轉兩次而得到截斷小數的結果，類似<code>!!</code>的真偽雙次否定。這裡有兩件事情要注意…</p>
<ul>
<li>使用<code>x | 0</code>也可以得到同樣的效果，差別只在於<code>~~</code>運算子優先權較高，遇到四則運算時不用包小括號。</li>
<li>與<code>Math.floor(..)</code>的結果不同，如下，<code>Math.floor(-29.8)</code>得到-30，而<code>~~-29.8</code>得偌-29</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Math</span>.<span class="title function_">floor</span>(-<span class="number">29.8</span>));<span class="comment">// -30</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(~~-<span class="number">29.8</span>); <span class="comment">// -29</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(-<span class="number">29.8</span> | <span class="number">0</span>); <span class="comment">//-29</span></span><br></pre></td></tr></table></figure>

<h5 id="明確的剖析數值字串-Numberic-String"><a href="#明確的剖析數值字串-Numberic-String" class="headerlink" title="明確的剖析數值字串(Numberic String)"></a>明確的剖析數值字串(Numberic String)</h5><p>除了使用<code>Number(..)</code>將值強制轉型為數字外，還可用<code>parseInt(..)</code>剖析而得到數字。<code>parseInt(..)</code>的用途是將字串剖析為數字，它接受一個字串作為輸入，若輸入非字串的值則會使用ToString強制轉為字串。</p>
<p><code>Number(..)</code>與<code>parseInt(..)</code>的差異在於</p>
<ul>
<li><code>parseInt(..)</code>可容忍(或想像成忽略)非數值的字元，在由左至右掃描值的過程中，遇到非數值字就停下來(忽略後後續部份)，只轉換到停下來之前所得到的數值。除非整個字串都是非數值，否則不會得偌NaN。而<code>Number(..)</code>則是只要傳入的字串不是可轉成數值的，就會得到NaN。</li>
<li>「指定基底」是個必要的好習慣，<code>parseInt(..)</code>若沒有輸入第二個參數來指定基數，就會以第一個參數的頭幾個字元決定基數為何，例如：開頭若為<code>0x</code>就會轉為十六進位的數字。因此，使用<code>parseInt(..)</code>最好要傳入基底以維持結果的正確性，例如：<code>parseInt(&#39;12345&#39;,10)</code>。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="string">&#x27;123px&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(a));  <span class="comment">// 123 </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">parseInt</span>(a));<span class="comment">// 123 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(b));  <span class="comment">// NaN </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">parseInt</span>(b));<span class="comment">//123</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">parseInt</span>(<span class="string">&#x27;HelloWorld&#x27;</span>));<span class="comment">//NaN</span></span><br></pre></td></tr></table></figure>

<h5 id="明確的-–-Boolean"><a href="#明確的-–-Boolean" class="headerlink" title="明確的 * –&gt; Boolean"></a>明確的 * –&gt; Boolean</h5><p>探討任何值強制轉為布林的情況。</p>
<h6 id="方法一：使用內建函式Boolean"><a href="#方法一：使用內建函式Boolean" class="headerlink" title="方法一：使用內建函式Boolean(..)"></a>方法一：使用內建函式<code>Boolean(..)</code></h6><p>使用<code>Boolean(..)</code>來執行ToBoolean的轉換工作。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(<span class="string">&#x27;Hello World&#x27;</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>([]));<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(&#123;&#125;));<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(<span class="literal">null</span>));<span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(<span class="literal">undefined</span>));<span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(<span class="title class_">NaN</span>));<span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(<span class="number">0</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(<span class="string">&#x27;&#x27;</span>));<span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<h6 id="方法二：否定運算子"><a href="#方法二：否定運算子" class="headerlink" title="方法二：否定運算子!"></a>方法二：否定運算子<code>!</code></h6><p>雙次否定即可強制將值轉為布林。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!<span class="string">&#x27;Hello World&#x27;</span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!![]);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!&#123;&#125;);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!<span class="literal">null</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!<span class="literal">undefined</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!<span class="title class_">NaN</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!<span class="number">0</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!<span class="string">&#x27;&#x27;</span>);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<h4 id="隱含的強制轉型-Implicit-Coercion"><a href="#隱含的強制轉型-Implicit-Coercion" class="headerlink" title="隱含的強制轉型(Implicit Coercion)"></a>隱含的強制轉型(Implicit Coercion)</h4><p>「隱含的強制轉型」是指在程式碼中沒有明確指出要轉換型別但卻轉型的動作。</p>
<h5 id="隱含的Strings-Numbers"><a href="#隱含的Strings-Numbers" class="headerlink" title="隱含的Strings &lt;–&gt; Numbers"></a>隱含的Strings &lt;–&gt; Numbers</h5><h6 id="Case1-String-–-Numbers-運算子是數字的相加，還是字串的串接"><a href="#Case1-String-–-Numbers-運算子是數字的相加，還是字串的串接" class="headerlink" title="Case1 String –&gt;Numbers:+運算子是數字的相加，還是字串的串接?"></a>Case1 String –&gt;Numbers:<code>+</code>運算子是數字的相加，還是字串的串接?</h6><p>若兩運算元的型別不同，當其中一方是字串時，<code>+</code>所代表的就是字串運算子，而會將另外一個運算元強制轉型為字串，並連接兩個字串。這裡提到的「另外一個運算元」就先稱它為b好了，若b是物件則會呼叫ToPrimitive做處理-由於傳入<code>[[DefaultValue]]</code>演算法的參敗是number，因此先使用<code>valueOf</code>取得基型值，然後再用<code>toString</code>轉為數字(非常的或非常小的數字以指數呈現)的字串格式。</p>
<p>如下範例，數字1會轉為字串<code>1</code>,而陣𦕁c和d分別會使用<code>toString</code>轉為<code>1, 2</code>與<code>3, 4</code>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> c = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="keyword">const</span> d = [<span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a + <span class="number">1</span>);<span class="comment">//&quot;11&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b + <span class="number">1</span>);<span class="comment">// 2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b + <span class="string">&#x27;&#x27;</span>);<span class="comment">// &quot;1&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c + d);<span class="comment">// &quot;1,23,4&quot;</span></span><br></pre></td></tr></table></figure>

<p>再看兩個著名的例子:<code>[] + &#123;&#125;</code>與<code>&#123;&#125; + []</code>。先猜猜看結果是什麼？</p>
<p>皆為<code>[object Object]</code>?</p>
<p>公佈答案摟！</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[] + &#123;&#125; <span class="comment">// &quot;[object Object]&quot;</span></span><br><span class="line">&#123;&#125; + [] <span class="comment">// 0</span></span><br></pre></td></tr></table></figure>

<p>說明如下</p>
<ul>
<li><code>[] + &#123;&#125;</code>中，<code>[]</code>會轉為空字串，而<code>&#123;&#125;</code>會轉為字串<code>&quot;[object Object]&quot;</code>。</li>
<li><code>&#123;&#125; + []</code>中，<code>&#123;&#125;</code>被當成空區塊而無作用，<code>+[]</code>被當成強制轉型為睥字<code>Number([])</code>(由於陣列是物 ，中間會先使用<code>toString</code>轉成空字串，導致變成<code>Number(&#39;&#39;)</code>)而得到0。</li>
</ul>
<p>注意前面提到的<code>String(..)</code>是直接調用<code>.toString</code>來轉字串，與<code>+</code>字串運算子經過ToPrimitive的運作-由於傳入<code>[[DefaultValue]]</code>演算法的參數是number,因此先使用<code>valueOf</code>取得基型值，然後再用<code>toString</code>轉為字串，兩慟方法是完全不同的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">    <span class="attr">toString</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="number">54321</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">    <span class="attr">valueOf</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="number">12345</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">String</span>(a));<span class="comment">// &quot;54321&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b+ <span class="string">&#x27;&#x27;</span>);<span class="comment">// &quot;12345&quot;</span></span><br></pre></td></tr></table></figure>

<h6 id="Case2-使用數字運算子將字串轉為數字"><a href="#Case2-使用數字運算子將字串轉為數字" class="headerlink" title="Case2:使用數字運算子將字串轉為數字"></a>Case2:使用數字運算子將字串轉為數字</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a + <span class="number">1</span>);<span class="comment">//&quot;11&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a - <span class="number">0</span>);<span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a * <span class="number">1</span>);<span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a / <span class="number">1</span>);<span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>([<span class="number">9</span>]-[<span class="number">7</span>]);<span class="comment">//2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>轉換規則可參考前面提到的ToNumber。</p>
<h5 id="隱含的-–-Boolean"><a href="#隱含的-–-Boolean" class="headerlink" title="隱含的 * –&gt; Boolean"></a>隱含的 * –&gt; Boolean</h5><p>在什麼狀況下會隱含地將值強制轉為布林呢？</p>
<ul>
<li><p>if述句中的條件判斷(或稱測式運算式test expression)</p>
</li>
<li><p>for述句中的條件判斷，意即測試運算式的第二個子句</p>
</li>
<li><p>while與do…while中檢測條件是否成立的測試運算式</p>
</li>
<li><p>三元運算式<code>條件？值1：值2</code>中的條件運算，意即測試運算式的第一個子句</p>
</li>
<li><p>邏輯運算子的<code>||</code>(or)和<code>&amp;&amp;</code>(and)左手邊的運算元會被當成測試運算式</p>
</li>
</ul>
<p>轉換規則可參考前面提到的ToBoolean</p>
<p>範例如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">12345</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> c;<span class="comment">// undefined</span></span><br><span class="line"><span class="keyword">var</span> d = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (a) &#123; <span class="comment">//true</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;a 是直的&#x27;</span>);<span class="comment">// a 是直的</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (c) &#123;<span class="comment">//false</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;從來沒跑過&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">c = d ? a : b;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c);<span class="comment">// &quot;Hello World&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((a &amp;&amp; d) || c) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;結果是真的&#x27;</span>);<span class="comment">//結果是真的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="運算子-與"><a href="#運算子-與" class="headerlink" title="運算子||與&amp;&amp;"></a>運算子<code>||</code>與<code>&amp;&amp;</code></h6><p>邏輯運算子的<code>||</code>(or)和<code>&amp;&amp;</code>(and)其實應該要稱呼為「(運算元的)選擇器運算子」(operand selector operator)，𫍇是因為它們並不是產生邏輯運算值true或false，而是在兩個運算元當中「選擇」其中一個運算元的值作為結果。</p>
<p>規則為，<code>||</code>(or)和<code>&amp;&amp;</code>(and)會將第一個運算元做布林測試或強制轉型為布林以便測試。</p>
<ul>
<li>對<code>||</code>(or)來說，若結果為true，則取第一個運算元為結果；若結果為false，則取第二個運算元為結果。</li>
<li>對<code>&amp;&amp;</code>(and)來說，若結果為true，則取第二個運算元為結果；若結果為false，則取第一個運算元為結果。</li>
</ul>
<p>因此可應用於</p>
<ul>
<li><p><code>||</code>(or)可用來設定變數的初始值。</p>
</li>
<li><p><code>&amp;&amp;</code>(and)可用來執行「若特定條件成立，才做某件事情」，功能近似if述句。</p>
<p>範例如下</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">777</span>;</span><br><span class="line"><span class="keyword">const</span> c = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &amp;&amp; c);<span class="comment">//測試 a 為 true，選 c，結果是 null</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &amp;&amp; b);<span class="comment">//測試 a 為 true，選 b，結果是 777</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">undefined</span> &amp;&amp; b);<span class="comment">//測試 undefined 為false，選undefined,結果是 undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a || b);<span class="comment">//測試 a 為 true，選 a,結果是 &quot;Hello World&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c || <span class="string">&#x27;foo&#x27;</span>);<span class="comment">//測試 c 為 false，選&#x27;foo&#x27; ，結果是 &quot;foo&quot;</span></span><br></pre></td></tr></table></figure>

<p>若flag條件成立(true)，就執行函式foo，之後會再提到短路的議題。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> flag = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;try me&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">flag &amp;&amp; <span class="title function_">foo</span>();<span class="comment">//try me</span></span><br></pre></td></tr></table></figure>

<h4 id="Symbol的強制轉型"><a href="#Symbol的強制轉型" class="headerlink" title="Symbol的強制轉型"></a>Symbol的強制轉型</h4><p>symbol的強制轉型規則如下</p>
<ul>
<li><p>在轉為字串方面，將symbol明確的強制轉型是允許的，但隱含的強制轉型是被禁止的，並且會丟出錯誤訊息。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 = <span class="title class_">Symbol</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">String</span>(s1));<span class="comment">// &quot;Symbol(Hello World)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s2= <span class="title class_">Symbol</span>(<span class="string">&#x27; World Hello&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s2+<span class="string">&#x27;&#x27;</span>);<span class="comment">// TypeError: Cannot convert a Symbol value to a string</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在轉為數字方面，無論是明確或隱含都是禁止的，並且會丟出錯誤訊息。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> n1 = <span class="title class_">Symbol</span>(<span class="number">777</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(n1));<span class="comment">// TypeError: Cannot convert a Symbol value to a number</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> n2=<span class="title class_">Symbol</span>(<span class="number">999</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(+n2);<span class="comment">// TypeError: Cannot convert a Symbol value to a number</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在轉為布林方面。無論是明確或隱含都是可以的，並且結果都是true</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> b1 = <span class="title class_">Symbol</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">const</span> b2 = <span class="title class_">Symbol</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(b1));<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(b2));<span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b3 = <span class="title class_">Symbol</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">const</span> b4 = <span class="title class_">Symbol</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (b3) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;b3 是直的&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (b4) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;b4 是直的&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// b3 是真的</span></span><br><span class="line"><span class="comment">// b4 是真的</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="寬鬆相等-Loose-Equals-vs-嚴格相等-Strict-Equals"><a href="#寬鬆相等-Loose-Equals-vs-嚴格相等-Strict-Equals" class="headerlink" title="寬鬆相等(Loose Equals) vs 嚴格相等(Strict Equals)"></a>寬鬆相等(Loose Equals) vs 嚴格相等(Strict Equals)</h4><p>  關於相等性的運算子有四固「<code>==</code>」(寬鬆相等性loose equality)、「<code>===</code>」(嚴格相等性strict queality)、「<code>!=</code>」(寬鬆不相等loose not-queality)、「<code>!==</code>」(嚴格不相等strict not-equality)。寬鬆與嚴格的差異在於檢查值相等時，是否會做<strong>強制轉型</strong>、<code>==</code><strong>會做強制轉型，而<code>===</code>不會</strong>。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;100&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">100</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a == b);<span class="comment">//true，強制轉型，將字串&#x27;100&#x27;轉為數字100</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a === b);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>  這裡要說明一下，<code>==</code>和<code>===</code>其實都會做型別的檢查，只是當面對型別不同時的反應是不一樣的而已。</p>
<h5 id="規則"><a href="#規則" class="headerlink" title="規則"></a>規則</h5><p>  如果型別相同，就會以同一性做比較，但要注意</p>
<ul>
<li><p>NaN不等於自已(其實，NaN不大於、不小於也不等於任何數字，所以當然也不等於它自已)</p>
</li>
<li><p>+0、-0彼此相等。</p>
</li>
<li><p>物件(含function和array)的相等是比較參考(reference)，若參考相等才是相等。</p>
</li>
</ul>
<p>   如果型別不同，則會先將其中一個或兩個值先做強制轉型(可遞迴)，再用型別相同的同一性做比較。</p>
<ul>
<li><p>字串轉為數字</p>
</li>
<li><p>布林轉為數字</p>
</li>
<li><p>null與undefined在寬鬆相等下會強制轉型為彼此，因此是相等的，但不等於其他值</p>
</li>
<li><p>若比較的對象是物件，使用<code>valueOf()</code>(優先)或<code>toString()</code>將物件取得基本型別的值，再做比較。</p>
<p>而<code>!=</code>和<code>!==</code>就是先分別做<code>==</code>和<code>===</code>再取否定(<code>!</code>)即可。</p>
</li>
</ul>
<p><strong>範例1</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line">a === b <span class="comment">// 答案是？</span></span><br><span class="line">a == b <span class="comment">// 答案是？</span></span><br></pre></td></tr></table></figure>

<p>答案揭曉</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">a === b <span class="comment">//false</span></span><br><span class="line">a == b <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>在<code>a == b</code>當中，字串a優先轉為數字後，此時就可比較<code>123==123</code>，因此是相等的(true)</p>
<p><strong>範例2</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line">a === b <span class="comment">// 答案是？</span></span><br><span class="line">a == b <span class="comment">// 答案是？</span></span><br></pre></td></tr></table></figure>

<p>答案揭曉。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">a === b <span class="comment">// false</span></span><br><span class="line">a == b <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>在<code>a == b</code>當中，布林a優先轉為數字(<code>Number(true)</code>得到1)後，此時就可比較<code>1 == 123</code>，因此是不相等的(false)。</p>
<p><strong>範例3</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line">a === b <span class="comment">// 答案是？</span></span><br><span class="line">a == b <span class="comment">// 答案是？</span></span><br></pre></td></tr></table></figure>

<p>答案揭曉。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">a === b <span class="comment">// false</span></span><br><span class="line">a == b <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>在<code>a == b</code>當中其實比較的是<code>null == 123</code>，因此是不相等的(false)。</p>
<p><strong>範例4</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;1,2,3&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">a === b <span class="comment">// 答案是？</span></span><br><span class="line">a == b <span class="comment">// 答案是？</span></span><br></pre></td></tr></table></figure>

<p>答案揭曉。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">a === b <span class="comment">// false</span></span><br><span class="line">a == b <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>在<code>a == b</code>當中，陣列a由於沒有<code>valueOf()</code>，只好使用<code>toString()</code>取得其基型值而得到字串<code>1,2,3</code>，此時就可比較<code>&#39;1,2,3&#39; == &#39;1,2,3&#39; </code>，因此是相等的(true)。</p>
<p><strong>範例5</strong></p>
<p>有幾個例外需要注意…</p>
<ul>
<li><p>null與undefined沒有其物件包裹形式，因此<code>Object(null)</code>與<code>Object(undefined)</code>等同於<code>Object()</code>, 也就是空物件<code>&#123;&#125;</code>。</p>
</li>
<li><p><code>Number(Nan)</code>得到NaN，且NaN不等於自已。</p>
<p>範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="title class_">Object</span>(a);<span class="comment">// 等同於 Object()</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a == b);<span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c = <span class="literal">undefined</span>;</span><br><span class="line"><span class="keyword">var</span> d = <span class="title class_">Object</span>(c);<span class="comment">// 等同於 Object()</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c == d);<span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> e = <span class="title class_">NaN</span>;</span><br><span class="line"><span class="keyword">var</span> f = <span class="title class_">Object</span>(e);<span class="comment">//等同於new Nummber(e)</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e == f);<span class="comment">//false</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="邊緣情況"><a href="#邊緣情況" class="headerlink" title="邊緣情況"></a>邊緣情況</h4><p>這部份來提一些邊綠(少見但驚人)的狀況。</p>
<h5 id="避免修改原型的valueOf"><a href="#避免修改原型的valueOf" class="headerlink" title="避免修改原型的valueOf(..)"></a>避免修改原型的<code>valueOf(..)</code></h5><p>經由原生的內建函式所建立的值，由於是物件型態，在強制轉型時會經過ToPrimitive的過程，也就是使用<code>valueOf(..)</code>(優先)或<code>toString(..)</code>將物件取得基本型別的值，才會做後續比較。因此，若修改了原型中的<code>toValue(..)</code>方法，則可能會導致比較時出現「不可思議」的結果。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Number</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">valueOf</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">2</span>) == <span class="number">3</span>);<span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h5 id="一些瘋狂的範例"><a href="#一些瘋狂的範例" class="headerlink" title="一些瘋狂的範例"></a>一些瘋狂的範例</h5><p>以下會得到什麼結果呢？請小心服用</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">false</span> == <span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">false</span> == []);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">false</span> == &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&quot;</span> == <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&quot;</span> == []);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&quot;</span> == &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0</span> == []);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0</span> == &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>([] == ![]);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span> == [<span class="number">2</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&quot;</span> == [<span class="literal">null</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0</span> == <span class="string">&#x27;\n&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>答案揭曉。</p>
<p> 說明</p>
<ul>
<li><p><code>&quot;0&quot; == false;</code>，true，字串轉數字、布林再轉數字</p>
</li>
<li><p><code>false == 0;</code>，true，布林轉數字</p>
</li>
<li><p><code>false == &quot;&quot;;</code>，true，字串轉數字、布林再轉數字</p>
</li>
<li><p><code>false == [];</code>，true，布林轉數字、陣列取toString得到空字串再轉數字</p>
</li>
<li><p><code>false == &#123;&#125;;</code>，false，布林轉數字，物件取valueOf得到空物件</p>
</li>
<li><p><code>&quot;&quot; == 0;</code>，true，字串轉數字</p>
</li>
<li><p><code>&quot;&quot; == [];</code>，true，字串轉數字、陣列取toString得到空字串再轉數字</p>
</li>
<li><p><code>&quot;&quot; == &#123;&#125;;</code>，false，字串轉數字、物件取valueOf得到空物件</p>
</li>
<li><p><code>0 == [];</code>，true，陣列取toString得到空字串再轉數字</p>
</li>
<li><p><code>0 == &#123;&#125;;</code>，false，物件取valueOf得到空物件</p>
</li>
<li><p><code>[] == ![];</code>，true，左手邊取valueOf得到空字串再轉數字得到0，右手邊被！強制轉為布林得到false再轉數字</p>
</li>
<li><p><code>2 == [2];</code>，true，陣列取toString得到空字串再轉數字</p>
</li>
<li><p><code>&quot;&quot; == [null];</code>，true，陣列取toString得空字串，轉數字後得到0</p>
</li>
<li><p><code>0 == &#39;\n&#39;;</code>，true，’\n’意即’’(空白)，轉數字後得到0</p>
</li>
</ul>
<h4 id="總結-：如何安全地使用隱含的強制轉型"><a href="#總結-：如何安全地使用隱含的強制轉型" class="headerlink" title="總結  ：如何安全地使用隱含的強制轉型?"></a>總結  ：如何安全地使用隱含的強制轉型?</h4><p>若允許強制轉型，但又希望能避免「難以預料」的強制轉型(上例), 這裡有一些建議</p>
<ul>
<li><p>若有一邊可能會出現true或false，就不要用<code>==</code>，改用<code>===</code>。</p>
</li>
<li><p>若有一邊可能會出現<code>[]</code>、空字串<code>&quot;&quot;</code>或0，就不要用<code>==</code>，改用<code>===</code>。</p>
</li>
</ul>
<p>以下是一定得安全的強制轉型，使用<code>==</code>即可，不需要用<code>===</code>…</p>
<ul>
<li>比較null與undefined的強制轉型是安全的，因為它們互轉為彼此，一定相等。</li>
<li><code>typeof x</code>得到的是固定的七種字串值(例如：<code>&#39;string&#39;</code>、<code>number</code>、<code>boolean</code>、<code>undefined</code>、<code>function</code>、<code>object</code>、<code>symbol</code>)，因此做<code>typeof x == &#39;指定值&#39;</code>一定是安全的</li>
</ul>
<p>也許世界上大多數的開發都詬病JavaScript中「隱含的強制轉型」的這部份，覺得這是個壞東西，但也許它其實是減少冗贅、反覆套用和非必要實作細節的好方法，而前提是，必須要能清楚了解強型的規則。</p>
<h4 id="JavaScript-Equality-Table"><a href="#JavaScript-Equality-Table" class="headerlink" title="JavaScript Equality Table"></a>JavaScript Equality Table</h4><p>下圖為JavaScript中的相等性，此圖視覺化了所有的比較項目。</p>
<img src="JavaScript-Equality-Table.png" style="zoom:85%;" />

<p>圖片來源：<a href="https://github.com/dorey/JavaScript-Equality-Table">JavaScript Equality Table</a></p>
<h4 id="抽象的關系式比較"><a href="#抽象的關系式比較" class="headerlink" title="抽象的關系式比較"></a>抽象的關系式比較</h4><p>這裡要來談比較運算子(comparsion)的部份，意即<code>&lt;</code>(小於)、<code>&gt;</code>(大於)、<code>&lt;=</code>(小於等於)、<code>&gt;=</code>(大於等於)，例如：<code>a &gt; b</code>表示比較a是否大於b。其比較規則為</p>
<ol>
<li><p>若兩個運算元皆為字串時，就直接依照字典字母順序做比較。</p>
</li>
<li><p>除了1之外的狀況都適用</p>
</li>
</ol>
<ul>
<li>先使用ToPrimitive做強制轉型-先使用<code>valueOf</code>取得基型值，然後再用<code>toString</code>方法轉為字串。</li>
<li>承上，若有任一值轉型後的結果不是字串，就使用Tonumber對規則轉為數字，來做數字上的比較。</li>
</ul>
<p>注意</p>
<ul>
<li>由於<a href="https://es5.github.io/#x11.8.5">規格</a>只定義了<code>a &lt; b</code>的演法，因此<code>a &gt; b</code>會以<code>b &lt; a</code>的方式做比較。</li>
<li>由於沒有「嚴格關系比較」，所以一定會遇到強型機狀況。</li>
</ul>
<p>範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = [<span class="number">12</span>];</span><br><span class="line"><span class="keyword">const</span> b = [<span class="string">&#x27;13&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &lt; b);<span class="comment">// true，&#x27;12&#x27; &lt; &#x27;13&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &gt; b);<span class="comment">// false, 其實是比較 b &lt; a，即 &#x27;13&#x27; &lt;&#x27;12&#x27; </span></span><br></pre></td></tr></table></figure>

<p>範例如下，由於a和b都不定字串，因此先用<code>valueOf</code>取得基型𠶗(只取到原來的物件),，再用<code>toString</code>而得到兩個字串<code>[object Object]</code>，因此比較<code>[object Object]</code>與<code>[object Object]</code>。又<code>a == b</code>比較的是兩物件存取的所在的記憶體位置，也就是參考(reference)。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123; <span class="attr">b</span>: <span class="number">12</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> b = &#123; <span class="attr">b</span>: <span class="number">13</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &lt; b);<span class="comment">// false,&#x27;[object Object]&#x27; &lt; &#x27;[object Object]&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &gt; b);<span class="comment">// false,其實是比較 b &lt; a，即&#x27;[object Object]&#x27; &lt; [object Object]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a == b);<span class="comment">// false,其實是比較兩物件的reference</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &gt;= b);<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &lt;= b);<span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>這裡要注意的是…</p>
<ul>
<li><code>a &lt;= b</code>其實是<code>!(b &gt; a)</code>，因此<code>!false</code>得到true。</li>
<li><code>a &gt;= b</code>其實是<code>b &lt;= a</code>也就是<code>!(a &gt; b)</code>等同於<code>!false</code>得到true。</li>
</ul>
<h4 id="回顧"><a href="#回顧" class="headerlink" title="回顧"></a>回顧</h4><p>看完這文章，我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>強制轉型(coercion)分為兩種，分別是「明確的」強制轉型(explicit coercion)和「隱含的」強制轉型(implicit coercion)，只要是程式碼中刻意寫出的明顯的型別轉換的動作，就是明確的強制轉型；反之，在程式碼中沒有明確指出要轉換型別卻轉型的，就是隱含的強制轉型。</li>
<li>明確的強制轉型規則與範例說明。</li>
<li>隱含的強制轉型規則與範例說明。</li>
<li>Symbol的強制轉型的規則與範例說明。</li>
<li>隱含的強制轉型的心酸血淚？各動令人崩潰的範例。</li>
<li>抽象的關係式比較。</li>
</ul>
<h3 id="你懂JavaScript嗎？文法-Grammar"><a href="#你懂JavaScript嗎？文法-Grammar" class="headerlink" title="你懂JavaScript嗎？文法(Grammar)"></a>你懂JavaScript嗎？文法(Grammar)</h3><blockquote>
<p>JavaScript的文法是描述其語法(syntax)例如：運算子、關鍵字等，如何結合在一起，形成格式正確的有效程式的一種結構化方式。</p>
</blockquote>
<p>主要會談到</p>
<ul>
<li>述句與運算式、述句完成值和其產生的副作用、解法和好處。</li>
<li>運用運算子優先序與結合性的規則，並顧及程式碼的可讀性。</li>
<li>依賴ASI還是手動加入分號？</li>
<li>錯誤-編譯時期的錯誤、執行時期的錯誤、暫時死亡區域(TDZ)。</li>
<li>try…finally與switch的特殊狀況。</li>
</ul>
<h4 id="述句與運算式-Statements-Expressions"><a href="#述句與運算式-Statements-Expressions" class="headerlink" title="述句與運算式(Statements&amp;Expressions)"></a>述句與運算式(Statements&amp;Expressions)</h4><p>運算式類似片語，經由運算子(類似標點符號或連接詞)將多個運算式組成一個完成的述句。𪞈個運算式都可各自估算其值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">1</span> + <span class="number">2</span>;<span class="comment">//(1)</span></span><br><span class="line"><span class="keyword">const</span> b = a + <span class="number">3</span>;<span class="comment">//(2)</span></span><br><span class="line">b;<span class="comment">//(3)</span></span><br></pre></td></tr></table></figure>

<p>說明</p>
<ul>
<li>運算式有：<code>1 +2</code>(經個算偌3)、<code>a + 3</code>(經估算得到6)、<code>b</code>(經估算得到6)。</li>
<li>(1)和(2) 稱為「宣告述句」(declaration statement)</li>
<li>(1)當中的<code>a = 1 + 2</code>和(2)當中的<code>b = a + 3</code>稱為「指定運算式」(assignment expression)</li>
<li>(3)稱為「運算式述句」(expression statement)</li>
</ul>
<h4 id="述句完成值-Statement-Completion-Values"><a href="#述句完成值-Statement-Completion-Values" class="headerlink" title="述句完成值(Statement Completion Values)"></a>述句完成值(Statement Completion Values)</h4><p>只要是述句都有完成值，就算是undefined。我們常在console頁籤看到最近一次執行結果的述句完成值。</p>
<img src="statement_completion_values.png" style="zoom:85%;" />

<p>由上圖中你可能會觀察到一個有趣的問題，為什麼「<code>const a = 1 + 2;</code>」是得到undefined而非3？</p>
<p>這是因為在<a href="https://es5.github.io/#x12.2">規格</a>中的種種複雜規則運作下，變數的𠍐句(例如:<code>const a</code>)會強制回傳undefined作為完成值。</p>
<p>依此類推，我們也會得到區塊完成值(目前指每個區塊的最後一個述句的完成值)，而為了能真正實現區塊也能得到其回傳值，有興趣的可以看這個提案-<a href="https://github.com/tc39/proposal-do-expressions"><code>do</code> expressions</a>，這樣就可將區塊視為運算式而得到回傳值了。</p>
<p>理解這個「述句完成值」有什麼好處？它可以幫助我們…</p>
<ul>
<li>解決運算式副作用(side effect)的問題</li>
<li>精算程式碼。</li>
</ul>
<h4 id="運算式副作用-Side-Effects"><a href="#運算式副作用-Side-Effects" class="headerlink" title="運算式副作用(Side Effects)"></a>運算式副作用(Side Effects)</h4><p>「述句完成值」的第一個好處是解決運算式副作用的問題，所謂「運算式副作用」其實就是經由運算式而得到的一些非預期結果，來看<code>--a++</code>這個例子。</p>
<p><code>--a++</code>???</p>
<p>這是同時遞增與遞減嗎？</p>
<p>別緊張，當然不是。</p>
<p>由於運算子的優先順序的關系，我們可以想成是這樣的<code>--(a++)</code>，先做遞增，再做遞減。</p>
<p>然而，執行這個運算式是會出錯的，得到ReferenceError，貼到Google翻譯上是說「未捕獲的ReferenceError：前綴操作中的左側表達式無效」。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> b = --a++;</span><br><span class="line">b;<span class="comment">// Uncaught ReferenceError: Invalid left-hand side expression in prefix operation</span></span><br></pre></td></tr></table></figure>

<p>蛤，什麼意思？？</p>
<p>先來看<code>++</code>作為前綴(prefix)與後綴(postfix)的差異，<code>a++</code>和<code>++a</code>的差異是在於這個運算式的結果(意即述句完成值)的回傳動作是在運算前還是後發生的，<code>a++</code>表示是先回傳再運算，而<code>++a</code>是表示先運算再回傳。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> b = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">a++ <span class="comment">// 1，先回傳再運算</span></span><br><span class="line">--b <span class="comment">// 9，先運算再回傳</span></span><br></pre></td></tr></table></figure>

<p>因此，<code>--a++</code>可看成<code>--(a++)</code>，會先得到<code>a++</code>的結果1，接著再做<code>--1</code>，但<code>--</code>只能在變數上運作，而無法用在一個值上，因此丟出了ReferenceError。</p>
<p>救星來了！</p>
<p>幸好，述句序𦕁逗號算子(<code>,</code>)救了我們，<code>,</code>可串起多個述句並回傳最後一個述句的結果作為述句完成值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> b = (a++, --a);</span><br><span class="line">b <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>

<h4 id="精簡程式碼"><a href="#精簡程式碼" class="headerlink" title="精簡程式碼"></a>精簡程式碼</h4><p>「述句完成值」的第二個好處是能精簡程式碼</p>
<p>範例如下，以下是一個確認輸入字串到底有哪些字母是母音的函式，並回傳是母音的字母所構成的陣列</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkVowels</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> matches;</span><br><span class="line">    <span class="keyword">if</span> (str) &#123;</span><br><span class="line">        matches = str.<span class="title function_">match</span>(<span class="regexp">/[aeiou]/g</span>);</span><br><span class="line">        <span class="keyword">if</span> (matches) &#123;</span><br><span class="line">            <span class="keyword">return</span> matches;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">checkVowels</span>(<span class="string">&#x27;Hello World&#x27;</span>));<span class="comment">// [&quot;e&quot;, &quot;o&quot;, &quot;o&quot;]</span></span><br></pre></td></tr></table></figure>

<p>從述句完成值中得知，述句<code>matches = str.match(/[aeiou]/g);</code>會得到一個回傳值，因此可直接將此值拿來做判斷，精簡程式碼如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkVowels</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> matches;</span><br><span class="line">    <span class="keyword">if</span> (str &amp;&amp; (matches = str.<span class="title function_">match</span>(<span class="regexp">/[aeiou]/g</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> matches;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">checkVowels</span>(<span class="string">&#x27;Hello World&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkVowels</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> matches;</span><br><span class="line">    <span class="keyword">return</span> str &amp;&amp; (matches = str.<span class="title function_">match</span>(<span class="regexp">/[aeiou]/g</span>)) ? matches : <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">checkVowels</span>(<span class="string">&#x27;Hello World&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h4 id="取決於上下文的規則-Contextual-Rules"><a href="#取決於上下文的規則-Contextual-Rules" class="headerlink" title="取決於上下文的規則(Contextual Rules)"></a>取決於上下文的規則(Contextual Rules)</h4><p>這部份我們來看一些「語法相同，但在不同環境中有不同意義」的狀況。</p>
<h4 id="大括號-Curly-Braces"><a href="#大括號-Curly-Braces" class="headerlink" title="大括號({..}Curly Braces)"></a>大括號(<code>&#123;..&#125;</code>Curly Braces)</h4><p>大括號(<code>&#123;..&#125;</code>Curly Braces)在不同環境中有不同意義的狀況有-物件字面值(object literal)、區塊(block)、物件解構(object destructuring)，以下分別述之。</p>
<ul>
<li><p>物件字面值(object literal):將值<code>&#123;..&#125;</code>指定給某個變數。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">	<span class="attr">foo</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>區塊(block):𢥢用<code>&#123;..&#125;</code>標示程試碼的區塊範圍</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (flag) &#123;</span><br><span class="line">	<span class="comment">// do something...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之前有一個範例</p>
<p><code>[] + &#123;&#125;</code> 與 <code>&#123;&#125; + []</code>。</p>
<p>先猜猜看結果是什麼？</p>
<p>皆為<code>[object Object]</code>?</p>
<p>公佈答案</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[] + &#123;&#125; <span class="comment">// &quot;[object Object]&quot;</span></span><br><span class="line">&#123;&#125; + [] <span class="comment">// 0</span></span><br></pre></td></tr></table></figure>

<p><code>[]+&#123;&#125;</code>中，<code>[]</code>會轉為空字串，而<code>&#123;&#125;</code>會轉為字串<code>&quot;[object Object]&quot;</code>。<code>&#123;&#125; + []</code>中，<code>&#123;&#125;</code>被當成空區塊而無作用，<code>+[]</code>被𡮝成強制轉型為數字<code>Number([])</code>（由於陣列是物件，中間會先使用<code>toString</code>轉成空字串，導致變成<code>Number(&#39;&#39;)</code>而得到0。</p>
</li>
<li><p>物件解構(object destructuring):這裡的<code>&#123;..&#125;</code>表示解構指定式(destructuring assignment)的物件的解構。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123; <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>, <span class="attr">foo</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125; &#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">foo</span> = (<span class="params">&#123; name &#125;</span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(a);<span class="comment">// Hi, I am Jack</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="else-if-與選擇性區塊"><a href="#else-if-與選擇性區塊" class="headerlink" title="else if 與選擇性區塊"></a>else if 與選擇性區塊</h4><p><code>else if</code>這樣的語法並不存在！</p>
<p>那這是什麼？？？</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (a) &#123;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (b) &#123;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>else if</code>其實只是因為if或else後若只接㽞一述句，就可以省略大括號<code>&#123;..&#125;</code>的緣故。因此，上例的程式碼其實是這樣的…</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (a) &#123;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (b) &#123;</span><br><span class="line">        <span class="comment">// ..</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ..</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="運算子優先序-Operator-Precedence"><a href="#運算子優先序-Operator-Precedence" class="headerlink" title="運算子優先序(Operator Precedence)"></a>運算子優先序(Operator Precedence)</h4><p>了解運算子優先序有助於我們理解程式碼什麼時候會執行(短路)、怎麼分批執行(結合性)。</p>
<h5 id="Operator-Precedence-Table"><a href="#Operator-Precedence-Table" class="headerlink" title="Operator Precedence Table"></a>Operator Precedence Table</h5><p>MDN整理了一份<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Operator_Precedence#Table">「運算子優先序」清單</a>，截圖如下。</p>
<p>運算子優先順序由高(20)至低(1)排列</p>
<img src="operator_precedence_table.png" style="zoom:85%;" />

<p>圖片來源：<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Operator_Precedence#Table">Operator precedence table</a></p>
<h5 id="短路-Short-Circuited"><a href="#短路-Short-Circuited" class="headerlink" title="短路(Short Circuited)"></a>短路(Short Circuited)</h5><p>之蠕提過「選擇器運算子」(operand selector operator)的<code>&amp;&amp;</code>(and)和<code>||</code>(or)的功用，其中，若運算子左手邊的運算元可估算出結果，右手邊的運算元更不會被估算，此情況稱為「短路」(shot circuited)。</p>
<p>應用這重短路的行為的範例如下，若flag條件成立(true)，就執行函式foo;反之，就不執行。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> flag = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;try me&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">flag &amp;&amp; <span class="title function_">foo</span>();<span class="comment">// try me</span></span><br></pre></td></tr></table></figure>

<p>短路其實某方面和if述句滿像的，如果判斷的條件不複雜或執行的工作不多，𠞽路可說是更為精簡易懂的寫法。</p>
<h4 id="結合性-Associativity"><a href="#結合性-Associativity" class="headerlink" title="結合性(Associativity)"></a>結合性(Associativity)</h4><p>說到運算子優先順序研一定會談到結合性，這牽涉到執行複雜運算時要怎麼幫運算式分組，有多個相同優先順序的運算子時該怎麼處理的議題。</p>
<p>結合性分為</p>
<ul>
<li><p>左結合，意即由左至右處理，例如：<code>&amp;&amp;</code>、<code>||</code>。</p>
</li>
<li><p>右結合，意即由右至左處理，例如：三元運算子<code>條件 ？ 值1 ： 值2</code>、指定運算子<code>var a = b = c = 123 </code>。</p>
<p>猜猜看以下這段式碼要怎麼分組。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">a ? b : c ? d : e</span><br></pre></td></tr></table></figure>

<p>是<code>(a ? b : c) ? d: e</code>或<code> a ? b :(c ? d: e)</code>?</p>
<p>答案是後者<code> a ? b :(c ? d: e)</code>，因為三元運算子是右結合，從右到左來分組。</p>
<p>了解運算子優先順序與結合性的規則，開發者在撰寫程式碼才能「清除歧義」，建議在運用運算優覺順序與結合性的甸時，也手動使用小括號<code>(..)</code>歸組以顧及程式碼可讀性。</p>
<h4 id="自動分號插入-Automatic-Semicolon-Insertion-ASI"><a href="#自動分號插入-Automatic-Semicolon-Insertion-ASI" class="headerlink" title="自動分號插入(Automatic Semicolon Insertion,ASI)"></a>自動分號插入(Automatic Semicolon Insertion,ASI)</h4><p>JavaScript引擎中的剖析器(parser)會在以下情況下，自動幫程式碼補上分號，以避免剖析失敗。</p>
<ul>
<li>換行，即述句結尾處與下一行之間，除了空白和註解外，沒有其他的程式碼。</li>
<li>break、continue、return、yield之後。</li>
</ul>
<p>不需要ASI的情況是</p>
<ul>
<li>區塊(<code>&#123;...&#125;</code>)不需要分號做終結。</li>
</ul>
<p>範例如下。</p>
<p>範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    a--</span><br><span class="line">&#125; <span class="keyword">while</span> (a &gt; <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>說明</p>
<ul>
<li><code>a--</code>後需要一個分號<code>;</code></li>
<li><code>while (a &gt; 1)</code>後需要一個分號<code>;</code></li>
</ul>
<p>關於到底要不要加分號這個議題，真的有非常非常多的討論…像是</p>
<ul>
<li><a href="http://oldblog.eddychang.me/blog/javascript/97-js-semicolon.html">JavaScript 裡的語句用分號結尾是個選項嗎</a></li>
<li><a href="https://github.com/airbnb/javascript#semicolons">Airbnb JavaScript Style Guide: Semicolons</a></li>
</ul>
<p>就我個人而言，都是會好好如上分號的, 因為不加分號的意思不就是「我弄壞了但要別人幫我擦屁股」的意思嗎？…</p>
<p>並且，邀請大定加入<a href="https://eslint.org/">ESLint</a> 的行列，使用工具自動檢視程式碼中微小但重要的問題！</p>
</li>
</ul>
<h4 id="錯誤-Errors"><a href="#錯誤-Errors" class="headerlink" title="錯誤(Errors)"></a>錯誤(Errors)</h4><h5 id="編譯時期的錯誤"><a href="#編譯時期的錯誤" class="headerlink" title="編譯時期的錯誤"></a>編譯時期的錯誤</h5><p>編譯或剖析時期丟出來的錯誤，由於程式尚未執行，因此無法以<code>try...catch</code>捕捉。</p>
<ul>
<li>SyntaxError，例如：無效的正規表達式<code>var a = /+foo/;</code></li>
<li>ReferenceError，例如：不合法的指定運算式<code>var a; 42 = a;</code></li>
</ul>
<h4 id="執行時期的錯誤"><a href="#執行時期的錯誤" class="headerlink" title="執行時期的錯誤"></a>執行時期的錯誤</h4><ul>
<li><p>TypeError，例如：重新設正已宣告為const變數<code>const a = 2; a = 4; </code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    a = <span class="number">4</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e);<span class="comment">//TypeError: Assignment to constant variable</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="暫時死亡區域-Temporal-Dead-Zone-TDZ"><a href="#暫時死亡區域-Temporal-Dead-Zone-TDZ" class="headerlink" title="暫時死亡區域(Temporal Dead Zone, TDZ)"></a>暫時死亡區域(Temporal Dead Zone, TDZ)</h4><p>ES6定義了「暫時死亡區域」(Temporal Dead Zone,TDZ)，意思是程式碼中某個部份的變數的參考動作還不能執行的地方，這是因為該變數尚未被初始化的綠故。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    a = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <a href="#%E6%9C%AA%E5%AE%9A%E7%BE%A9-undefined-vs%E6%9C%AA%E5%AE%A3%E5%91%8A-uneclared">之前</a>提到typeof對於尚未宣告的變數可有保護機制，但在這裡是無效的。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    typeof a;</span><br><span class="line">    typeof b;</span><br><span class="line">    let b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="try-finally"><a href="#try-finally" class="headerlink" title="try..finally"></a>try..finally</h4><p>try區塊的內容vs finally區壞的內容，到底是誰會先執行?誰會後執行?</p>
<p>先來看第一個例子。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">12345</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">foo</span>());</span><br></pre></td></tr></table></figure>

<p>顯示結果為</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Hello World</span><br><span class="line">12345</span><br></pre></td></tr></table></figure>

<p>從結果看起來，似手難以判斷???</p>
<p>再來看第二個例子。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">12345</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">foo</span>());</span><br></pre></td></tr></table></figure>

<p>顯示結果為</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Hello World</span><br><span class="line">12345</span><br></pre></td></tr></table></figure>

<p>從執行順序來看，的確是先執行try區壞，再來才是finally區塊，但「述句完成值」會決定結果的「顯示」順序。首先，會先執行區塊的內容，像是<code>console.log(..)</code>，再來才是執行函式<code>foo()</code>回傳完成值，因此，在第一 個例子中，會先顯示「Hello World」，再顯示「12345」。而在第二個例子中，的確會覆寫try內的回傳伹，而成為這個函式最後的完成值因此得到12345</p>
<h4 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h4><p>switch述句等同於if-else的縮寫，依靠break來決定是否要持續進行下一個case述句，若沒有break磺會「落穿而過」。</p>
<p>範例如下，這裡有一個檢測庫存的簡易範例，假設目前庫存數曉為50，當庫存為0～2時提示要趕快進貨補庫存，庫存到達50時顯示庫存充裕，庫存到達100時提示貨品是不是賣不掉，其化狀況都顯示為運作正常。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="number">50</span>;</span><br><span class="line"><span class="keyword">switch</span> (count) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;快賣完了！趕快進貨！&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">50</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;庫存充裕&#x27;</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">100</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;是不是賣不掉了！？&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;運作正常&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但出乎意料的是，結果印出「庫存充裕、是不是賣不掉了！？」。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">庫存充裕</span><br><span class="line">是不是賣不掉了！？</span><br></pre></td></tr></table></figure>

<p>這是因為如果沒有如入break，一旦某個符合條件了，接下來的case無論符合與否都會被執行，也就是剛才所提到的「落穿而過」。</p>
<p>加入break修改正下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="number">50</span>;</span><br><span class="line"><span class="keyword">switch</span> (count) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;快賣完了！趕快進貨！&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">50</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;庫存充裕&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">100</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;是不是賣不掉了！？&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;運作正常&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果印出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">庫存充裕</span><br></pre></td></tr></table></figure>

<p>另外，switch所做的比對是嚴格相等(<code>===</code>)，若希望能使用寬鬆相等(<code>==</code>)而能有強制轉制的功能，就需要改變一下寫法，像是…</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="string">&#x27;12345&#x27;</span>;</span><br><span class="line"><span class="keyword">switch</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> a == <span class="number">10</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;10 or &#x27;10&#x27;&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> a == <span class="number">12345</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;12345 or &#x27;12345&#x27;&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">        <span class="comment">//不會到達這裡的</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果得到</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">12345 or <span class="string">&#x27;12345&#x27;</span></span><br></pre></td></tr></table></figure>

<p>最後，default不一定要放在最後，順序是什麼並不重要喔！</p>
<h4 id="回顧-1"><a href="#回顧-1" class="headerlink" title="回顧"></a>回顧</h4><p>看完這篇文章，我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li><p>述句與運算式，述句完成值和其產生的副作用，解法和好處。</p>
</li>
<li><p>運用運算升優先序與結合性的規性的規則，並顧及程式碼的可讀性。</p>
</li>
<li><p>依賴ASI還是手動加入分號？我個入偏好要加分號！也𩏑薦大家使用ESLint！</p>
</li>
<li><p>錯誤-編譯時期的錯誤、執行時期的錯誤、暫時死亡區域(TDZ)。</p>
</li>
<li><p>try…finally與switch的特特殊狀況。</p>
<h5 id="References"><a href="#References" class="headerlink" title="References"></a>References</h5><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/types%20%26%20grammar/ch5.md">You Don’t Know JS: Types &amp; Grammar, Chapter 5: Grammar</a></li>
</ul>
</li>
</ul>
<h3 id="你懂JavaScript嗎-範疇（Scope）"><a href="#你懂JavaScript嗎-範疇（Scope）" class="headerlink" title="你懂JavaScript嗎?範疇（Scope）"></a>你懂JavaScript嗎?範疇（Scope）</h3><p>本文會提到</p>
<ul>
<li>什麼是「範疇」?範疇的功用是？</li>
<li>編譯器怎麼理解程式碼？</li>
<li>什麼是巢狀範疇？</li>
<li>從LHS與RHS來理解JavaScript查找變數的報錯機制。</li>
</ul>
<h4 id="範疇（Scope）"><a href="#範疇（Scope）" class="headerlink" title="範疇（Scope）"></a>範疇（Scope）</h4><p>範疇（Scope）是指編繹器或JavaScript引擎藉由識別字名稱(identifier name)查找變數的一組規則。</p>
<h4 id="編譯器怎麼理解程式碼"><a href="#編譯器怎麼理解程式碼" class="headerlink" title="編譯器怎麼理解程式碼?"></a>編譯器怎麼理解程式碼?</h4><p>編譯器會在程式執行前將程碼由上到下逐行轉為電腦可懂的命令，稍後會執行這個編譯後的結果。注意，JavaScript引擎會在每次執行前即時編譯程式（約幾毫秒(ms)而已），接著立刻執行編譯後的指令。</p>
<p>編譯有三𦂇驟</p>
<ul>
<li><p>語法基本單元化與語彙分析（tokenizing&#x2F;lexing）：將字串解析成token，例如：<code>var a=2;</code>就會解析<code>var</code>、<code>a</code>、<code>=</code>、<code>2</code>、<code>;</code>。</p>
</li>
<li><p>剖析或稱語法分析（parsing）：承上，將這些token（<code>var</code>、<code>a</code>、<code>=</code>、<code>2</code>、<code>;</code>）組成抽象語法樹（abstract syntax tree，AST）</p>
<img src="ast.png" style="zoom:50%;" />

<ul>
<li>產生目的程式碼（code-generation）：承上，將AST轉為可執行的程式碼，通常是機器語言，在這裡也會做最佳化。</li>
</ul>
</li>
</ul>
<h4 id="範疇的功用是？"><a href="#範疇的功用是？" class="headerlink" title="範疇的功用是？"></a>範疇的功用是？</h4><p>  在編譯的過程中，JavaScript引擎，編譯器和範疇會互相溝通以完成工作，它們各自負責的任睥有</p>
<ul>
<li>JavaScript引擎：負責整個編譯過程並執行程式碼。</li>
<li>編譯器：負責編譯三步驟-語法基本單元化與語彙分析，剖析或稱語法分析，產生目的程式碼</li>
<li>範疇：負責維護變數清單。</li>
</ul>
<p>  範例如下，這裡有一段程式碼，在編譯這段程式碼時，JavaScript引擎，𤚴譯器和範疇三者會做什麼呢？</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li>在編譯的時候，編譯器會先到範疇詢問變數a是否存在，若不存在就宣告這個a變數。</li>
<li>接著，在執行階段，JavaScript引擎先到範疇詢問變數a是否存在，若存在就將2設定給它；若a不存在就報錯。</li>
</ol>
<p>  其中，引擎對範疇的查找變數的動作，可分為兩種類型</p>
<ul>
<li>LHS（left-hand side）：要查找的變數在指定動作的左邊，例如：<code> a = 2</code>的a在等號的左邊，就是執行LHS查找動作。</li>
<li>RHS（right-hand side）：變數不在指定動作的左邊，例如：<code>console.log(a)</code>，就是執行RHS查找動作。</li>
</ul>
<p>  備註：函式宣告（例如：<code>function foo() &#123;...&#125;</code>）並不是LHS！這是因為在做函式宣告時，就同時做了宣告和值的定義，而非在執行階段設定其值。</p>
<h4 id="巢狀範疇（Nested-Scope）"><a href="#巢狀範疇（Nested-Scope）" class="headerlink" title="巢狀範疇（Nested Scope）"></a>巢狀範疇（Nested Scope）</h4><p>若在目前執行的範疇找貨到這個變數的時候，就會往外層的範疇搜尋，持續搜尋直到找到為止，或直到最外層的全域範疇（global scope）; 而這樣一層又一層的範疇就稱為「巢狀範疇」(nested scope)。</p>
<p>如下。<code>conole.log(a + b)</code>中，b的RHS無法在foo中解析完成，但可到全域範疇解析出來。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">foo</span> = (<span class="params">a</span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a + b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="title function_">foo</span>(<span class="number">2</span>);<span class="comment">//4</span></span><br></pre></td></tr></table></figure>

<h4 id="錯誤（Error）"><a href="#錯誤（Error）" class="headerlink" title="錯誤（Error）"></a>錯誤（Error）</h4><p>為什麼需要理解LHS和RHS呢？這是因為要看懂JavaScript報錯的原因。</p>
<p>當解析identifier失敗時</p>
<ul>
<li>若是RHS，則會丟出ReferrenceError的訊息</li>
<li>若是LHS，就會分為是否在嚴格模式(strict mode)的情況<ul>
<li>在非嚴格模式下，會在全域建立這個變數。</li>
<li>在嚴格模式下，會丟出ReferrenceError的訊息。</li>
</ul>
</li>
</ul>
<p>還有一種狀況，不論在LHS和RHS下，操作不合法的行為時，就會丟出TypeError的訊息。</p>
<ul>
<li>LHS：重新設定已宣告為const變數，<code>const a = 2; a = 4;</code>的<code>a = 4</code>會導致TypeError。</li>
<li>RHS：執行不是function的變數，<code>const b = 2; b();</code>的<code>b()</code>會導致TypeError。</li>
</ul>
<p><strong>範例</strong></p>
<p>這裡有一個小範例，判斷哪裡發生了LHS？哪裡發生了RHS？</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">foo</span> = (<span class="params">a</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> b = a;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> c = <span class="title function_">foo</span>(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p><strong>LHS</strong></p>
<ol>
<li><code>const c= ...</code></li>
<li><code>const b=...</code></li>
<li>隱點的參數設定<code>a = 2</code></li>
</ol>
<p><strong>RHS</strong></p>
<ol>
<li><code>const b = a</code>其中的<code>... = a</code>對a取值</li>
<li><code>return a + b</code>其中要對a取值</li>
<li><code>return a + b</code>其中要對b取值</li>
<li><code>foo(a)</code>其中要對foo取得其函數</li>
</ol>
<h4 id="回顧-2"><a href="#回顧-2" class="headerlink" title="回顧"></a>回顧</h4><p>我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>範疇是指編讀器或JavaScirpt引擎藉由識別字名稱查找變數的一組規則。</li>
<li>編譯器會在程式執行前將程式碼由上到下逐行轉為電腦可懂的命令，而稍後執行的即是這個編譯後的結果。編譯有三步驟：語法基本單元化夷語彙分析、剖析或稱語法分析、產生目的程式碼。並且，在編譯的過程中，JavaScript引擎、和範疇會互相溝通以完成工作。</li>
<li>在查找變數的過程中，若在目前執行的範疇找不到這個變數的時候，就會往外層的範疇搜尋，持續搜尋直到找到為止，或直到最外層的全域範疇。</li>
<li>從LHS與RHS來理解JavaScript查找變數的報錯機制。</li>
</ul>
<h4 id="References-1"><a href="#References-1" class="headerlink" title="References"></a>References</h4><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/ch1.md">You Don’t Know JS: Scope &amp; Closures, Chapter 1: What is Scope?</a></li>
</ul>
<h3 id="你懂JavaScript？語彙範疇（Lexical-Scope）"><a href="#你懂JavaScript？語彙範疇（Lexical-Scope）" class="headerlink" title="你懂JavaScript？語彙範疇（Lexical Scope）"></a>你懂JavaScript？語彙範疇（Lexical Scope）</h3><p>本文會提到</p>
<ul>
<li>什麼是語彙範疇？這階段要做什麼事情？</li>
<li>什麼會改變語彙範疇？有什麼影響？</li>
</ul>
<h4 id="語彙範疇（Lexical-Scope）"><a href="#語彙範疇（Lexical-Scope）" class="headerlink" title="語彙範疇（Lexical Scope）"></a>語彙範疇（Lexical Scope）</h4><p>範疇的運作方式有兩種-語彙範疇（Lexical scope）和動態範疇（dynamic scope），在這裡先來探討「語彙範疇」。</p>
<p>語彙分析階段會將字串解析成token，例如：<code>var a = 2;</code>會解析為<code>var</code>、<code>a</code>、<code>=</code>、<code>2</code>、<code>;</code>。語彙範疇是在語彙分析時期所定義的範疇，剛範疇的劃分在程式碼撰寫時就決定好了，之後任何企圖修改的行為都是不恰當的。</p>
<p>參考以下程式碼，試著區分有幾個範疇？誰是誰的巢狀範疇？</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> b = a * <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params">c</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">bar</span>(b * <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(<span class="number">2</span>);<span class="comment">// 2 4 12</span></span><br></pre></td></tr></table></figure>

<img src="fig2.png" style="zoom:85%;" />

<p>圖片來源：[You Don’t Know JS: Scope &amp; Closures, Chapter 2: Lexical Scope](<a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope">https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope</a> %26 closures&#x2F;ch2.md)</p>
<p>這裡有三個範疇…</p>
<ul>
<li>(1)最外面的範疇即全域範疇，識別字有foo。</li>
<li>(2)中間的範疇是在foo裡面，識別字有a、b、bar。</li>
<li>(3)最裡面的範疇是在bar裡面，識別字只有c。</li>
</ul>
<h4 id="查找識別字"><a href="#查找識別字" class="headerlink" title="查找識別字"></a>查找識別字</h4><p>從上例可知，範疇的劃分說明了JavaScript引擎如何尋找識別字的所在之處。</p>
<p>這裡還要談兩個觀念「遮蔽（shadowing）」和「全域變數（global variable）」。</p>
<ul>
<li>遮蔽（shadowing）：若相同的識別字同時出現在不同的巢狀範疇中，那麼只履在巢狀範疇內層找偌第一個符合的識別字就會停止搜尋。</li>
<li>全域變數（global variable）：全域變數會自動變成全堿物件的屬性，因此能使用<code>window.a</code>來避免a被巢狀範疇內層的同名變數遮蔽。</li>
</ul>
<p>備註：範疇的查找只適用於一級識別字，例如：a、b這樣單層的名稱。如果是要找foo.bar.a的話，範疇的查找冬會找到foo，之後的bar和a就會由物件存萬規則（object property-access rules）來繼續解析。</p>
<h4 id="什麼會變變語彙範疇？有什麼影響？"><a href="#什麼會變變語彙範疇？有什麼影響？" class="headerlink" title="什麼會變變語彙範疇？有什麼影響？"></a>什麼會變變語彙範疇？有什麼影響？</h4><p>取兩個方法會在執行時修變語彙範疇-eval和with。</p>
<h5 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h5><p>範例如下，在foo內執行eval，導致<code>console.log(...)</code>時JavaScript引擎尋找b時在foo這範疇找偌(其值為3)，而遮蔽了全域的b(其值為2)。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">str, a</span>) &#123;</span><br><span class="line">    <span class="built_in">eval</span>(str);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="title function_">foo</span>(<span class="string">&#x27;var b=3;&#x27;</span>, <span class="number">1</span>);<span class="comment">// 1 3</span></span><br></pre></td></tr></table></figure>

<p>eval很邪惡，好孩子不要用！</p>
<h5 id="with"><a href="#with" class="headerlink" title="with"></a>with</h5><p>with會在執行時創建新的語彙範疇，這裡來看一個全域值外𣼣的例子。</p>
<p>當with區塊執行時，with將物件參考當成範疇來看，𫍇個物件的特性就會成為該範疇內的識別字。因此，<code>a = 2</code>其實是在做LHS的動作，若在o2和foo的範疇找到a，就會往全域範疇來找，由於在此並非嚴格模式，因此在找不到的情況下，就會生一個全域變數a並設定其值為2。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">with</span> (obj) &#123;</span><br><span class="line">        a = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> o1 = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">3</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> o2 = &#123;</span><br><span class="line">    <span class="attr">b</span>: <span class="number">3</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_">foo</span>(o1);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(o1.<span class="property">a</span>);<span class="comment">//2</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(o2);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(o2.<span class="property">a</span>);<span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// 2,全域值外𣼣</span></span><br></pre></td></tr></table></figure>

<p>幸好，with已被禁止使用了。</p>
<h4 id="為什麼eval和with會導致效能不佳？"><a href="#為什麼eval和with會導致效能不佳？" class="headerlink" title="為什麼eval和with會導致效能不佳？"></a>為什麼eval和with會導致效能不佳？</h4><p>JavaScript引擎會編譯時期進行最佳化，例如，靜態分析程碼，確定變數和函式的宣告，這樣在執行時期就能節省解析識別字的成本。</p>
<p>但若在程式碼中有eval或with，剛剛在編譯時期所確認的變數和函式的所式位置的結果都無效了，因為JavaScript引擎無法在編譯時期確認到底傳入什麼東西給eval或有什麼內容會讓with創建新的語彙範疇，所以也就不知道有什麼會改變誥彙範疇了，也就是說，剛剛所做的最佳化都沒有意義了，JavaScript引擎可考慮乾脆不要最佳化，因此程式碼就會跑得比較慢。效能比較差。</p>
<h4 id="回顧-3"><a href="#回顧-3" class="headerlink" title="回顧"></a>回顧</h4><p>看完這篇文章，我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>語彙範疇是在語彙分析時期定義的範疇，而範疇的劃分在程碼撰寫時就決定好了，之後任何企圖修改行為都是不恰當的。</li>
<li>範疇是編譯器或JavaScript引擎藉由識別字名稱查找變數的三組規則。其中，「遮蔽」是指只要找到巢狀範疇內第一個符合的識別字就會停籍搜尋； 「全域變數」必須使用<code>window.x</code>來避免被內層變數遮蔽； 範疇的查找只適用於單層的識別字名稱，若為多層則是由物件存取規則來做解析。</li>
<li>eval和with由於會修改語彙範疇，讓編譯時期所做的工都白費，因此效能不佳，應避免使用。</li>
</ul>
<h4 id="References-2"><a href="#References-2" class="headerlink" title="References"></a>References</h4><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/ch2.md">You Don’t Know JS: Scope &amp; Closures, Chapter 2: Lexical Scope</a></li>
</ul>
<h3 id="你懂JavaScript？函式範疇與區塊範疇（Function-vs-Block-Scope）"><a href="#你懂JavaScript？函式範疇與區塊範疇（Function-vs-Block-Scope）" class="headerlink" title="你懂JavaScript？函式範疇與區塊範疇（Function vs Block Scope）"></a>你懂JavaScript？函式範疇與區塊範疇（Function vs Block Scope）</h3><p>本文會提到</p>
<ul>
<li>範疇的劃分單位可分為兩種-函式範疇與區塊範疇，它們有什麼不同？各有什麼優點？</li>
<li>函式範疇的重要觀念與相關應用-函式宣告與函式運算式、匿名與具名函式、即刻調用函式運算式。</li>
<li>區塊範疇的重要觀念與相關應用-const與let、垃圾回收。</li>
</ul>
<h4 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h4><p>「範疇」（scope）是指編譯器或JavaScript引擎藉由識別字名稱查找變數的一組規則，而劃分範疇的單位可分為兩種-函式範疇與區塊範疇，也就是說，每個「函式」或「區塊」是可以建立各自的範疇，在ES6以前，只有函式能建立範疇，而在ES6之後，可用大括號<code>&#123;...&#125;</code>定義區塊範疇，讓const和let宣告以區塊為範疇的變數。</p>
<h4 id="函式範疇（Function-Scope）"><a href="#函式範疇（Function-Scope）" class="headerlink" title="函式範疇（Function Scope）"></a>函式範疇（Function Scope）</h4><p>函式會建立自已的範疇，其內的識別字（不管是變數、函式）僅能在這個函式裡面使用。</p>
<p>範例如下，在全域範疇底下，是無法存取foo內a、b、c和bar，否則會導致ReferrenceError；但在foo自已的函式範疇內，可以存取a、b、c和bar。</p>
<p>foo可自由存其內的a、b、c和bar</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> c = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">//2</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(b);<span class="comment">//2</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(c);<span class="comment">//3</span></span><br><span class="line">    <span class="title function_">bar</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>全域範疇之下是無法存取foo內的a、b、c和bar的，但可存取foo喔！</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> c = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// ReferrenceError</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b); <span class="comment">// ReferrenceError</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c); <span class="comment">// ReferrenceError</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">bar</span>(); <span class="comment">// ReferrenceError</span></span><br></pre></td></tr></table></figure>

<h4 id="使用「函式範疇」有什麼好處？"><a href="#使用「函式範疇」有什麼好處？" class="headerlink" title="使用「函式範疇」有什麼好處？"></a>使用「函式範疇」有什麼好處？</h4><p>使用「函式範疇」有什麼好處？或說解決什麼問是呢？大致上有這兩點…</p>
<ul>
<li>維持最小權限原則，以避免變數或函式被不當存取。</li>
<li>避免同名識別字所造成的衝突，這當中包含了避免污染全域命名空間和模組的管理。</li>
</ul>
<h4 id="最小權限原則"><a href="#最小權限原則" class="headerlink" title="最小權限原則"></a>最小權限原則</h4><p>函式範疇能維挫「最小權限原則」（principle of least privilege），或稱為「最小授權」（least authority）、「最小暴露」（least exposure），可防止變數或函式被不當存取。</p>
<p>範例如下，secretData是foo的私有變數，可能是儲存了foo之外其他程式碼不需要知道的資料，因此對於其他地方（包含全域範疇）的程式碼來說，是無法直接存取到secretData的，只能透過foo公開的API「bar」取得經過處理後的資料，如publicData。這樣的好處是，除了foo之外是無法經由任何管道修改它的私有變數secretData的，可防止其伳地方的程式碼的不當存取。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> secretData = <span class="string">&#x27;HelloWorld&#x27;</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> secretData.<span class="title function_">split</span>(<span class="string">&#x27;&#x27;</span>).<span class="title function_">join</span>(<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        bar</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> baz = <span class="title function_">foo</span>();</span><br><span class="line"><span class="keyword">var</span> publicData = baz.<span class="title function_">bar</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(publicData);<span class="comment">// H-e-l-l-o-W-o-r-l-d</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(secretData);<span class="comment">// Uncaught ReferenceError: secretData is not defined</span></span><br></pre></td></tr></table></figure>

<h4 id="避免衝突"><a href="#避免衝突" class="headerlink" title="避免衝突"></a>避免衝突</h4><p>避免同名變數或函式所造成的衝突。</p>
<p>如下範例，這裡有兩個函式doSomething與doSomethingElse。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    b = a + <span class="title function_">doSomethingElse</span>(a * <span class="number">2</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(b * <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doSomethingElse</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> b;</span><br><span class="line"></span><br><span class="line"><span class="title function_">doSomething</span>(<span class="number">2</span>); <span class="comment">// 15</span></span><br></pre></td></tr></table></figure>

<p>若此時還有一個同名的函doSomethingElse，就會導致衝突，回傳的答案就不是原本預期的15，而是12。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    b = a + <span class="title function_">doSomethingElse</span>(a * <span class="number">2</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(b * <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doSomethingElse</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> b;</span><br><span class="line"></span><br><span class="line"><span class="title function_">doSomething</span>(<span class="number">2</span>); <span class="comment">// 12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doSomethingElse</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a - <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改寫如下，將doSomething私有的細節（也就是第一個doSomethingElse函式）藏在其範疇中，這樣兩個doSomethingElse函式就不會造成衝突了。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    b = a + <span class="title function_">doSomethingElse</span>(a * <span class="number">2</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(b * <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doSomethingElse</span>(<span class="params">a</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> a - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b;</span><br><span class="line"></span><br><span class="line"><span class="title function_">doSomething</span>(<span class="number">2</span>); <span class="comment">// 15</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doSomethingElse</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a - <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再看一個例子，如下，函式bar內的 i 是個全域變數，它無意間修改的 foo loop 的 i，導致 i 永遠都是 3，而進入了無窮迴圈。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params">a</span>) &#123;</span><br><span class="line">        i = <span class="number">3</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">bar</span>(i * <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<p>解法是將bar內的 i 宣告為區域變數，這樣就會將這個 i 包在bar的範疇裡面，避免被其他不相干的程式碼存取。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params">a</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">3</span>;<span class="comment">// 將 bar 內的 i 宣告為區域變數</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">bar</span>(i * <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<h4 id="全域命名空間（Global-Namespace）"><a href="#全域命名空間（Global-Namespace）" class="headerlink" title="全域命名空間（Global Namespace）"></a>全域命名空間（Global Namespace）</h4><p>通常我們使用的函式庫都適當的隱藏自已內部所使用的變數和函式，意即將它們做成某物件屬性和方法而非暴露在全域底下，而物件即是它們的命名空間（namespace），這樣就可以避免在全域範疇中因同名而產生的衝突。</p>
<p>範例如下，物件MyReallyCoolLibrrary內含有屬性awesome和方法doSomething與doAnotherThing，可避免全域範疇中也有同名的變數awesome或函式doSomething或doAnotherThing。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">MyReallyCoolLibrary</span> = &#123;</span><br><span class="line">    <span class="attr">awesome</span>: <span class="string">&#x27;stuff&#x27;</span>,</span><br><span class="line">    <span class="attr">doSomething</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">doAnotherThing</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="模組管理（Module-Management）"><a href="#模組管理（Module-Management）" class="headerlink" title="模組管理（Module Management）"></a>模組管理（Module Management）</h4><p>除了使用前面提到的命名空間來避免衝突外，另一個解法是使用模組（module），藉由工具（例如：webpack）產生相依管理機制，避免函式衷新增依何識別字到全域範疇，而是要求函式庫將識別字匯入（import）至特定的範疇，模組管理機級並沒有跳脫範疇的掌控，而是巧妙地避免污全域範疇，將函式庫的識別字保持在私有範疇中，解決了衝突的問題。若不使用工具，也可在撰寫程式碼時使用模組模式（module pattern）。</p>
<h4 id="即刻調用函式運算式Immediately-Invoked-Function-Expression-IIFE）"><a href="#即刻調用函式運算式Immediately-Invoked-Function-Expression-IIFE）" class="headerlink" title="即刻調用函式運算式Immediately Invoked Function Expression,IIFE）"></a>即刻調用函式運算式Immediately Invoked Function Expression,IIFE）</h4><p>IIFE是可立即執行的函式運算式，主要好處是不污染全域範疇，並且匿名或具名皆合法。</p>
<p>在談論IIFE前，先來看幾個重要觀念</p>
<ul>
<li>函式宣告 vs 函式運算式</li>
<li>匿名 vs 具名</li>
</ul>
<h4 id="函式宣告（Function-Declaration）vs-函式運算式（Function-Expression）"><a href="#函式宣告（Function-Declaration）vs-函式運算式（Function-Expression）" class="headerlink" title="函式宣告（Function Declaration）vs 函式運算式（Function Expression）"></a>函式宣告（Function Declaration）vs 函式運算式（Function Expression）</h4><p>函式宣告（function declaration）就像是其他資料型別所宣告的字面值一樣，利用關鍵字function宣告一個函式，後接函式名稱與其本體，範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">//3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<p>函式運算式（function expression）是指將一個函式指定給特定變數的過程，範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);<span class="comment">//3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<p>廣義上來說，只要函式述句並非以function開頭，而是以<code>var foo = functon ...</code>或<code>(function foo()) ...</code>起始的（像是稍後提到的IIFE），都是函式運算式。</p>
<h4 id="匿名-vs-具名（Anonymous-vs-Named）"><a href="#匿名-vs-具名（Anonymous-vs-Named）" class="headerlink" title="匿名 vs 具名（Anonymous vs Named）"></a>匿名 vs 具名（Anonymous vs Named）</h4><p>承上，函式運算式可分為具名和匿名的範例如下。</p>
<p>具名的函式運算式，具有名稱識別字bar. </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<p>匿名的函式運算式，匿名就沒有名稱識別字。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<p>再看一另一個例子，我們很習慣在callback中使用匿名運算式，<del>這好嗎？</del></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;等一秒後執行&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>或寫成 arrow function</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;等一秒後執行&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>而匿名的函運算式有以下缺點</p>
<ul>
<li>stack trace 因報錯時沒有具體名稱會較難追踨。</li>
<li>沒有名稱會難以遞迴（解法是必須使用已廢棄的<code>arguments.callee</code>），且無法指定名稱做自身的unbind。</li>
<li>無法立即知道該匿名函式的功能，可讀性較差。</li>
</ul>
<p>解法𣄵是給它一個名字，例如timeoutHandler，百利而無一害，用吧</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">timeoutHandler</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;等一秒後執行&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">timeoutHandler</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;等一秒後執行&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">setTimeout</span>(timeoutHandler, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>先前提到的例子中，不管是函式宣告或函式運算式，都污染到全域範疇，因此可能會遇到剛才所提到的問題…像是避免變數或函式被不當存取、同名識別字所造成的衝突等。因此，我們可使用「即刻調用函式運算式」（Immeidately Invoked Function Expression,IIFE）來解決這個問題。</p>
<p>IIFE是可立即執行的函式運算式，主要好處是不污染全域範疇，並且匿名或具名皆合法。</p>
<p>具名為foo的IIFE</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);<span class="comment">//3</span></span><br><span class="line">&#125;)();</span><br><span class="line"><span class="title function_">foo</span>();<span class="comment">// foo is not defined</span></span><br></pre></td></tr></table></figure>

<p>匿名的IIFE。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);<span class="comment">//3</span></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>IIFE還有一些功能，例如：指定範疇，確保undefined的正確性與反轉順序。</p>
<h4 id="指定範疇"><a href="#指定範疇" class="headerlink" title="指定範疇"></a>指定範疇</h4><p>將傳入的參數當作範疇。</p>
<p>如下，將window傳入以作為具名的IIFE的範疇，並指名為global，這樣的命名方式有助於程式的可讀性，簡單易懂。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span> <span class="title function_">IIFE</span>(<span class="params"><span class="variable language_">global</span></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 3</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">global</span>.<span class="property">a</span>); <span class="comment">// 2</span></span><br><span class="line">&#125;)(<span class="variable language_">window</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>

<h4 id="確保undefined的正確性"><a href="#確保undefined的正確性" class="headerlink" title="確保undefined的正確性"></a>確保undefined的正確性</h4><p>有些程式碼會因為錯誤的撰寫方式，導致污染了undefined的值，因此可指定一個參數，但不傳入值，以維扲undefined的正確性。</p>
<p>如下，IIFE雖然有設定參數undefined，但<code>()</code>卻是空的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="literal">undefined</span> = <span class="literal">true</span>;</span><br><span class="line">(<span class="keyword">function</span> <span class="title function_">IIFE</span>(<span class="params"><span class="literal">undefined</span></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a;</span><br><span class="line">    <span class="keyword">if</span> (a === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Undefined 在這裡很安全！&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h4 id="反轉順序"><a href="#反轉順序" class="headerlink" title="反轉順序"></a>反轉順序</h4><p>前方放置呼叫的參數並執行未來傳入的函式，而後方放置將要執行的函式。這種寫法常用UMD（universal module definition）。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span> <span class="title function_">IIFE</span>(<span class="params">def</span>) &#123;</span><br><span class="line">  <span class="title function_">def</span>(<span class="variable language_">window</span>);</span><br><span class="line">&#125;)(<span class="keyword">function</span> <span class="title function_">def</span>(<span class="params"><span class="variable language_">global</span></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 3</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">global</span>.<span class="property">a</span>); <span class="comment">// 2</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>把上面這段程式碼拆開來，可當成這裡有兩個變數a和def，其中def是待會要執行的函式。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">var</span> def = <span class="keyword">function</span>(<span class="params"><span class="variable language_">global</span></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 3</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">global</span>.<span class="property">a</span>); <span class="comment">// 2</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>使用IIFE結構，前方將要執行的函式當成參數func傳入，並且func代入window這個參數。接著，由後方傳入要執行的函式def。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span> <span class="title function_">IIFE</span>(<span class="params">func</span>) &#123;</span><br><span class="line">  <span class="title function_">func</span>(<span class="variable language_">window</span>);</span><br><span class="line">&#125;)(def);</span><br></pre></td></tr></table></figure>

<p>不過呢，自從有了ES6的let與var搭配區塊範疇<code>&#123;...&#125;</code>之後，我們再也不需要IIFE了。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// 3</span></span><br><span class="line">&#125;)();</span><br><span class="line"><span class="title function_">foo</span>();<span class="comment">// Uncaught ReferenceError: foo is not defined</span></span><br></pre></td></tr></table></figure>

<p>剛剛的例子就可以改成…</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">foo</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> a = <span class="number">3</span>;</span><br><span class="line">        <span class="comment">// 做一些運算...</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();<span class="comment">// Uncaught ReferenceError: foo is not defined</span></span><br></pre></td></tr></table></figure>

<h4 id="區塊範疇（Block-Scope）"><a href="#區塊範疇（Block-Scope）" class="headerlink" title="區塊範疇（Block Scope）"></a>區塊範疇（Block Scope）</h4><p>在ES6以前，只有函式能建立範疇，而在ES6之後，可用大括號<code>&#123;...&#125;</code>定義區塊範疇，讓const和let宣告以區塊為範疇的變數。</p>
<p>如下，i 屬於函式foo的範疇，而非假想的 for loop的區塊範疇。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而ES6的const 與 let可宣告以區塊為範疇的變數。</p>
<p>const。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (foo) &#123;</span><br><span class="line">  <span class="keyword">const</span> bar = foo * <span class="number">2</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(bar); <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bar); <span class="comment">// ReferenceError</span></span><br></pre></td></tr></table></figure>

<p>const 表示常數（constant），宣告時就必須賦值，賦值後不可修改其值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> bar = foo * <span class="number">2</span>;</span><br><span class="line">bar = <span class="number">3</span>; <span class="comment">// Uncaught TypeError: Assignment to constant variable.</span></span><br></pre></td></tr></table></figure>

<p>let。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (foo) &#123;</span><br><span class="line">  <span class="keyword">let</span> bar = foo * <span class="number">2</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(bar); <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bar); <span class="comment">// ReferenceError</span></span><br></pre></td></tr></table></figure>

<p>當let宣告於for迴圈內時：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(i); <span class="comment">// ReferenceError: i is not defined</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式砠可以看成是這樣…i是屬於第一個大括號所包含的區壞的，因此i一但出了第一個大括號所包含的範圍就會報錯。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(i); <span class="comment">// ReferenceError: i is not defined</span></span><br></pre></td></tr></table></figure>

<p>注意，迴圈的每次迭代都會對 i 重新綁定（rebind），這樣就能確保重新賦值。</p>
<p>const 與 let不會有拉升（hoisting）的狀況。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (foo) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(bar); <span class="comment">// ReferenceError</span></span><br><span class="line">    <span class="keyword">let</span> bar = foo * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="垃圾回收（Garbage-Collection）"><a href="#垃圾回收（Garbage-Collection）" class="headerlink" title="垃圾回收（Garbage Collection）"></a>垃圾回收（Garbage Collection）</h4><p>一但變用不到了，JavaScript引擎就可能會將它回收，但由於範疇的緣故，仍須保留這些變數存取值的能力，而區塊塊疇明確表達資料不再用到，而解決這個不需要被保留的狀況，可釋出更多記憶體空間。這部份與閉包（closure）有關，待續詳細說明閉包的機制。</p>
<p>範例如下，雖然clickHandler用入到變數someReallyBigData，因此函式process處理完someReallyBigData應該就可回收someReallyBigData的記憶體空間，但由於clickHandler擁有對整個範疇的閉包（後續會提到，閉包是函式記得並存取語彙範疇的能力，可說是指向特定範疇的參考，因此當函式是在其語彙範疇之外執行時也能正常運作），因此 JavaScript 就不會把它回收了。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">process</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="comment">// 做一些有趣的事情...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> someReallyBigData = &#123; .. &#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">process</span>(someReallyBigData);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> btn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;this_button&#x27;</span>);</span><br><span class="line"></span><br><span class="line">btn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>), <span class="keyword">function</span> <span class="title function_">clickHandler</span>(<span class="params">e</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;按鈕按下去了&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是呢，區壞範疇能幫我們解決這個問題，區塊範疇告訴JavaScript引擎這些內容僅在這一塊範圍內用到而已，之後就能讓JavaScript引擎順利把用不到的資料回收掉。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">process</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="comment">// 做一些有趣的事情...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在這個區塊內宣告的任何資料在處理完後就可被丟棄！</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">let</span> someReallyBigData = &#123; .. &#125;;</span><br><span class="line">  <span class="title function_">process</span>(someReallyBigData);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> btn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;this_button&#x27;</span>);</span><br><span class="line"></span><br><span class="line">btn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>), <span class="keyword">function</span> <span class="title function_">clickHandler</span>(<span class="params">e</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;按鈕按下去了&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="回顧-4"><a href="#回顧-4" class="headerlink" title="回顧"></a>回顧</h4><p>我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>函式會建立自已的範疇，其內的識別字（不管是變數、函式）僅能在這個函式裡面使用。函式範疇可避免變數或函式被不當存取的問題，並避免同名識別字所造成的衝突，通常應用於命名間與模組管理。</li>
<li>函式範疇的重要觀念與目關應用-函式宣告與函式運算式、匿名與具名函函式、即刻調用函式運算式。</li>
<li>在ES6之後，可用大括號<code>&#123;...&#125;</code>定義區壞範疇，讓const和let宣告以區塊為範疇的變數。</li>
<li>區塊範疇的相關觀念與應用-垃圾回收、for迴圈中let的變數宣告等。</li>
</ul>
<h5 id="References-3"><a href="#References-3" class="headerlink" title="References"></a>References</h5><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/ch3.md">You Don’t Know JS: Scope &amp; Closures, Chapter 3: Function vs. Block Scope</a></li>
</ul>
<h3 id="你懂JavaScript嗎？拉升（Hoisting）"><a href="#你懂JavaScript嗎？拉升（Hoisting）" class="headerlink" title="你懂JavaScript嗎？拉升（Hoisting）"></a>你懂JavaScript嗎？拉升（Hoisting）</h3><p>主要會談到</p>
<ul>
<li><p>什麼是拉升（hoisting）</p>
</li>
<li><p>變數與函式的拉升有什麼不同？</p>
</li>
<li><p>怎麼處理在<code>&lt;script&gt;</code>宣告的全域變數？是否也有拉升的狀況？</p>
</li>
<li><p>拉升 vs 重複宣告變數與函式，要怎麼處理？</p>
</li>
</ul>
<h4 id="什麼是拉升（Hoisting）"><a href="#什麼是拉升（Hoisting）" class="headerlink" title="什麼是拉升（Hoisting）?"></a>什麼是拉升（Hoisting）?</h4><p>你有遇到這重狀況嗎？明明變數尚未被宣告，但用的時候居然沒被報錯，還得到值undefied???咦？等等、怎麼不是得到2？？？</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// undefined</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>我真的被這個問題嚇到惹，到底發生了什麼事？</p>
<p>「這是hoisting」好嗎？</p>
<p>先來看編譯器怎麼看待這段程式碼。</p>
<p>一開始，編譯器在編譯時期會先找出所有的變數並綁定所屬範疇，但不賦值，所以此刻變數所帶的值是undefined; 而在執行階段，JavaScript引擎才會處理給值的事情。</p>
<p>因此，上面這段程碼，在編譯器的眼中，其實是這樣的…</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a;<span class="comment">// 編譯時期確認 a 屬於全域範疇，但不賦值，所以此刻變數所帶的值是 undefined</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// 得到 unddefined</span></span><br><span class="line">a= ？;<span class="comment">// 執行時期才會知道 a 的值是什麼</span></span><br></pre></td></tr></table></figure>

<p>console的結果是undefined，而非RHS解析失敗「ReferenceError:a is not defined」，畢竟變數已經被定義了，只是不知道真正的值是什麼是什麼而已。</p>
<p>通常，我們可想像成這是因為編譯會掃過程式碼中的宣告的變數函式，而巴這些變數和函式「提升」到程式碼的最頂端，因此當印出a的值的時候，會是已宣告但還沒賦值的狀態，也就是有這個變數，但其值是undefined。</p>
<p>結合編譯和執行時期的分工狀況，可想成是這樣…</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a;<span class="comment">// 編譯時期的工作</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// 執行時期的工作</span></span><br><span class="line">a = <span class="number">2</span>;<span class="comment">// 執行時期的工作</span></span><br></pre></td></tr></table></figure>

<p>又，以下有幾點需要注意的議題…</p>
<h4 id="拉升是逐範疇的！"><a href="#拉升是逐範疇的！" class="headerlink" title="拉升是逐範疇的！"></a>拉升是逐範疇的！</h4><p>也就是說，在函式內宣告變數，不會被拉升到全域範疇而成為全域變數。</p>
<h4 id="函式運算式不會被提升"><a href="#函式運算式不會被提升" class="headerlink" title="函式運算式不會被提升"></a>函式運算式不會被提升</h4><p>函式運算式（function expression）不會被提升。如下，foo此時的值是undefined，所以當執行<code>undefined()</code>就會得到TypeError。而bar這個識別字是屬於foo的範疇的，所以在這裡會報錯ReferenceError。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">foo</span>(); <span class="comment">// TypeError</span></span><br><span class="line"><span class="title function_">bar</span>(); <span class="comment">// ReferenceError</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo=<span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>實際上應該看成…</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(); <span class="comment">// TypeError</span></span><br><span class="line"><span class="title function_">bar</span>(); <span class="comment">// ReferenceError</span></span><br><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> bar =...self...</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>這是因為拉升只會有變數宣告的部份，後續的指定等運算都不會跟著提升。</p>
<h4 id="變數-vs-函式的拉升"><a href="#變數-vs-函式的拉升" class="headerlink" title="變數 vs 函式的拉升"></a>變數 vs 函式的拉升</h4><p>變數與函式的拉升的不同之處在於，變數的拉升只有宣告部份，而函式的拉升是整個函式，因此函式在宣告前是可以執行的。</p>
<h4 id="多個中的全域變數並不會被拉升"><a href="#多個中的全域變數並不會被拉升" class="headerlink" title="多個&lt;script&gt;中的全域變數並不會被拉升"></a>多個<code>&lt;script&gt;</code>中的全域變數並不會被拉升</h4><p>在不同<code>&lt;script&gt;</code>包圍，即視為隊同的檔案，因此某支檔案中的變數宣告不會被拉升到另一支檔案的頂端。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&lt;script&gt;<span class="title function_">foo</span>();&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">..</span>) &#123; &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>但是呢，以下兩種情況是允許的，可正常執行。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="title function_">foo</span>();</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">..</span>) &#123; &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123; .. &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span>foo();<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>上例與拉升無關，而是因為在同一支HTML檔案中嵌入的<code>&lt;script&gt;</code>共用同一個全域範疇，因此在第一個<code>&lt;script&gt;</code>中宣告了foo函而成為全域物件的屬性，在第二個<code>&lt;script&gt;</code>中就可以使用這個屬性了。</p>
<h4 id="重複宣告"><a href="#重複宣告" class="headerlink" title="重複宣告"></a>重複宣告</h4><p>若函式和變數同名，則函式會優先； 若同時有多個函式同名，則後面的會覆寫前面的宣告。</p>
<p><strong>範例1：若函式和變數同名，則函式會優先</strong></p>
<p>範例如下，同名函式foo和變數foo。由於函式優先，因此<code>foo()</code>得到1而非<code>undefined()</code>的結果TypeError。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">foo</span>();<span class="comment">// 1</span></span><br><span class="line"><span class="keyword">var</span> foo;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">foo = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>這是因為要看成…</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(); <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">foo = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p><strong>範例2：若同時有多個函式同名，則後面的會覆寫前面的宣告</strong></p>
<p>範例如下，三個同𪨘函式foo，最後一個foo會覆寫前面的宣告，因此得到3。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">foo</span>(); <span class="comment">//3 </span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="回顧-5"><a href="#回顧-5" class="headerlink" title="回顧"></a>回顧</h4><p>可以理解到</p>
<ul>
<li><p>編譯器在鍽譯時期會先找出所有的變數並綁定所屬範疇，但不賦值，所以此刻變數所帶的值是undefined； 而在執行階段，JavaScript引擎才會處理給值的事情。 可以想成是這些變數和函示「提升」到程式碼的最項端，這就是所謂的拉升（hoisting）。</p>
</li>
<li><p>拉升是逐範疇的，在函式內宣告變數，不會被拉升到全域範疇而成為全域變數。</p>
</li>
<li><p>函式運算式不會被提升。</p>
</li>
<li><p>變數與函式的拉升的不同之處在於，變數的拉升只有宣告部份，而函式的拉升是整個函式，因此函式在宣告前是可被執行的。</p>
</li>
<li><p>同一支HTML檔案中嵌入的多個<code>&lt;script&gt;</code>時，不同<code>&lt;script&gt;</code>包圍的即視為不同的檔案，因此某支檔案中的變數宣告不會被拉升到另一支檔案的頂端。</p>
</li>
<li><p>若函式和變數同名，則函式會優先； 若同時有多個函式同名，則後面的會覆寫前面的宣告。</p>
</li>
</ul>
<h5 id="References-4"><a href="#References-4" class="headerlink" title="References"></a>References</h5><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/ch4.md">You Don’t Know JS: Scope &amp; Closures, Chapter 4: Hoisting</a></li>
</ul>
<h3 id="你懂JavaScript嗎-動態範疇（Dynamic-Scope）"><a href="#你懂JavaScript嗎-動態範疇（Dynamic-Scope）" class="headerlink" title="你懂JavaScript嗎?動態範疇（Dynamic Scope）"></a>你懂JavaScript嗎?動態範疇（Dynamic Scope）</h3><p>本文主要是比較動態範疇與語彙範疇的差異。</p>
<h4 id="動態範疇（Dynamic-Scope）-vs-語彙範疇（Lexical-Scope）"><a href="#動態範疇（Dynamic-Scope）-vs-語彙範疇（Lexical-Scope）" class="headerlink" title="動態範疇（Dynamic Scope） vs 語彙範疇（Lexical Scope）"></a>動態範疇（Dynamic Scope） vs 語彙範疇（Lexical Scope）</h4><p>先前提過範疇是指編譯器或JavaScript引擎藉由識別字名稱（identifier name）查找變數的一組規則；而「語彙範疇」是指在語彙分枉時期所定義的靜態範疇，且不經由eval或with在執行時的修改。語彙範疇考量的是變數「如何和何處被宣告」，其查找的範疇串鏈是以程試式碼的巢狀結構為基礎。</p>
<p>範例如下，在foo 中的a由於無法在所在函式foo內經由RHS解析得到的值，因此會往全域範疇查找，因而得到3。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">//3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line">    <span class="title function_">foo</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line"><span class="title function_">bar</span>();</span><br></pre></td></tr></table></figure>

<p>範例如下，同樣的， a 在 foo 中無法解析其值，因此循著 call stack 找到 foo 被呼叫的地方 bar，在 bar 內找到 a 的值為 2。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>( a ); <span class="comment">// 3  (not 2!)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">	<span class="title function_">foo</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">bar</span>();</span><br></pre></td></tr></table></figure>

<p>事實上，<strong>JavaScript 並沒有動態範疇</strong>，但 this 的查找規則是類似動態範疇的，在後續關於 this 的篇章會再詳細說明。</p>
<h4 id="回顧-6"><a href="#回顧-6" class="headerlink" title="回顧"></a>回顧</h4><p>看完這篇文章，我們到底有什𫐤收穫呢？藉由本文可以理解到…</p>
<p>語彙範疇與動態範疇的主要差異在於，前者查找範疇串鏈是以程式碼的巢狀結構為基礎，而後都則是以呼叫堆疊（call stack 為基礎）。</p>
<h5 id="References-5"><a href="#References-5" class="headerlink" title="References"></a>References</h5><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/apA.md">You Don’t Know JS: Scope &amp; Closures, Appendix A: Dynamic Scope</a></li>
</ul>
<h3 id="你懂JavaScript-閉包（Closure）"><a href="#你懂JavaScript-閉包（Closure）" class="headerlink" title="你懂JavaScript?閉包（Closure）"></a>你懂JavaScript?閉包（Closure）</h3><p>本文主要會談到</p>
<ul>
<li>閉包是什麼？有什麼功用？</li>
<li>迴圈與閉包搭配使用時的謬誤與陷阱。</li>
<li>模組模是什麼？</li>
<li>如何管理模組？探討模組依存性載入器&#x2F;管理器與ES6模組。</li>
</ul>
<h4 id="閉包（Closure）"><a href="#閉包（Closure）" class="headerlink" title="閉包（Closure）"></a>閉包（Closure）</h4><p>閉包是函式記得並存取語彙範疇的能力，可說是指向特定範疇的參考，因此當函式是在其宣告的語彙範疇之外執行時也能正常運作。</p>
<p>範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bar;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> baz = <span class="title function_">foo</span>();</span><br><span class="line"><span class="title function_">baz</span>();<span class="comment">//2</span></span><br></pre></td></tr></table></figure>

<p>說明</p>
<ul>
<li>函式能夠存取的範疇即是其被內嵌後往外推的範圍，例如bar被內嵌於foo之內，因此bar內變數可存取的範圍就是foo和全域範疇。因此，基於語彙範疇的變數查找規則，bar內的a在自已的函式範疇內找不到定義的話，可往外層的範疇查找，於是在foo內找到了，得到a為2，其中，<code>console.log(a)</code>是執行RHS查找。</li>
<li>JavaScript引擎的垃圾回收機制會釋收不再使用的記憶體，但閉包為了保留函式記得和存取其語彙範疇的能力，就會以予保留，不做記憶體回收。因此<strong>bar仍保留指向foo的內層範疇的參考，這個參考就是閉包。</strong></li>
<li>最後，雖然baz位於bar所定義的範疇之外，但由於閉包的緣故，bar仍能正常執行，而得到a的值。</li>
</ul>
<p>閉包在callback上的應用尤其常見，如下所示，在程式碼的最後一行<code>wait(&#39;Hello, 閉包！&#39;);</code>中傳入字串「Hello,閉包！」給函式wait時，儘管timer已離開了所宣告的範疇之內，但仍保留了timer存取wait傳入參數的值的能力，而印出結果。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">wait</span>(<span class="params">message</span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">timer</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(message);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">wait</span>(<span class="string">&#x27;Hello,閉包！&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>閉包可說是仰賴語彙範疇來撰寫程式碼而得到的必然結果。</p>
<p>有一種一但承諾了就永遠分不開的feelXD</p>
<h4 id="迴圈與閉包"><a href="#迴圈與閉包" class="headerlink" title="迴圈與閉包"></a>迴圈與閉包</h4><p>如果今天要實作一個每秒依序印出數字1,2,3…,5的功能，你會怎麼做呢？</p>
<p>是這樣嗎?</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">timer</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">    &#125;, i * <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好像有點怪怪的？</p>
<p>這的確是錯誤的。由於<code>console.log(i)</code>中的i會存取的範疇是for所在的範疇（目前看起來是全域範疇，因為var宣告的變數不具區塊範疇的特性），因此當1秒、2秒、…5秒後執行<code>console.log(i)</code>就會去取i的值，而此時for迴圈已跑完，i 變成6，因此就會每隔一秒印出一個「6」。</p>
<p>若希望每隔一秒印出1、2、…5，可使用IIFE加入新的範疇來修改，意即為每次迭代都建立一個新的函式範疇（但其實我們想要的是建立一個區塊範疇）。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">    (<span class="keyword">function</span> (<span class="params">j</span>) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">timer</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(j);</span><br><span class="line">        &#125;, j * <span class="number">1000</span>);</span><br><span class="line">    &#125;)(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即然是要為每次迭代建立區壞範疇，更好的解法就是使用<strong>let</strong>，let會在每次迭代時重新宣告變數i，並將上一次迭代的結果作為這一次的初始值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">timer</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">    &#125;, i * <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="模組模式（Module-Pattern）"><a href="#模組模式（Module-Pattern）" class="headerlink" title="模組模式（Module Pattern）"></a>模組模式（Module Pattern）</h4><p>模組模式（module pattern）又稱為揭露模組（revealing module），經由建立一個模組實體（module instance，如下範例的foo），來調用內層函式doSomethong和doAnother。而內層函由於具有閉包的特性，因此可存取外層的變數和函式（something與another）。透過模組模式，可隱藏私密資訊，並選擇對外公開的API。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">CoolModule</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> something = <span class="string">&#x27;cool&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> another = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(something);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doAnother</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(angother.<span class="title function_">join</span>(<span class="string">&#x27; ! &#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">doSomething</span>: doSomething,</span><br><span class="line">        <span class="attr">doAnother</span>: doAnother</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = <span class="title class_">CoolModule</span>();</span><br><span class="line">foo.<span class="title function_">doSomething</span>();<span class="comment">// cool</span></span><br></pre></td></tr></table></figure>

<p>以上這個例子並不難理解，它等於就是本文開頭foo、bar和baz的變形而已。</p>
<p>又，模組模式的另一個變形是singleton-包上IIFE，用於只想要產生單一實體的時候，修改上例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = (<span class="keyword">function</span> <span class="title function_">CoolModule</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> something = <span class="string">&#x27;cool&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> another = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(something);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doAnother</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(another.<span class="title function_">join</span>(<span class="string">&#x27; ! &#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">doSomething</span>: doSomething,</span><br><span class="line">        <span class="attr">doAnother</span>: doAnother</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">foo.<span class="title function_">doSomething</span>();<span class="comment">// cool</span></span><br><span class="line">foo.<span class="title function_">doAnother</span>(); <span class="comment">// 1 ! 2 ! 3</span></span><br></pre></td></tr></table></figure>

<h4 id="模組依存性載入器（Module-Dependency-Loader）"><a href="#模組依存性載入器（Module-Dependency-Loader）" class="headerlink" title="模組依存性載入器（Module Dependency Loader）"></a>模組依存性載入器（Module Dependency Loader）</h4><p>既然我們知道了怎麼撰寫模組，那麼，要怎麼管理多個模組呢？像是模組中引用其他模組時，可能會因程式碼放置的順序不對、產生相依性問題剛導致出鏌，該怎麼辦呢？</p>
<p>這裡提出兩個解法-使用模組依存性載入器或ES6模組，先來看前者。</p>
<p>模組依存載入器或管理器（module dependency loader&#x2F;manager）是指將模組定義的模式包裝成一個友善的API。範例如下，這是一個簡單的模組依存性載入器。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">MyModules</span> = (<span class="keyword">function</span> <span class="title function_">Manager</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> modules = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">define</span>(<span class="params">name, deps, impl</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; deps.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            deps[i] = modules[deps[i]];<span class="comment">// (1)</span></span><br><span class="line">        &#125;</span><br><span class="line">        modules[name] = impl.<span class="title function_">apply</span>(<span class="literal">null</span>, deps);<span class="comment">// (2)</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">name</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> modules[name];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">define</span>: define,</span><br><span class="line">        <span class="attr">get</span>: get</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>說明如下，在Manager這個IIFE裡面包含了一些變數和函式…</p>
<ul>
<li>變數modules存放各個模組所公開的API，例如：bar 的hello、foo的awesome。</li>
<li>函式define輸入的個參數-name、deps與impl，name是模組名稱； deps是與此模組相依的模組，以陣式方式傳入； impl是用於定義一個外層包裏函式以建立範疇。讓其內的函式能指向這個範疇而產生閉包，最後這個函式impl會回傳公開API。<ul>
<li>標註（1）的部份：deps本來是儲存相依模組名稱的陣列，在這裡改為存放這個相依模組名稱公開API。例如：deps的內容是<code>[&#39;bar&#39;]</code>，<code>deps[0]</code>的內容是<code>&#39;bar&#39;</code>，因此<code>deps[0] = modules[deps[0]]</code>可看成是<code>bar = modules[&#39;bar&#39;]</code>，moudels[‘bar’]以物件方式儲存bar的公開API，例如：hello和world，即是<code>bar = modules[&#39;bar&#39;]=&#123; hello: f, world: f&#125;</code>。</li>
<li>標註（2）的部分：這裡為模組呼叫定義了一個包裹函式，用來將回傳值（這個值是指模組的API）存入以名稱來當作參考的一個模組清單。此模組impl會傳入兩個參數，第一個參數是這個函式所要使用的this的值，因為在這裡不爭this所以傳入null也是可以的；第二個參數是將相依的模組（與𨦋公開API）都傳進去，讓這個模能夠使用其他模組的公開API。</li>
</ul>
</li>
<li>get會依照輸入的模組名稱以物件形式取得其公開的API，之後就可以指定給特定變數，然後利用這個變數使用存取屬性的方式呼叫這些API。</li>
</ul>
<p>以下是示範如何定義模組…關於模組foo與bar，就依照以上規格分別定義之，即可使用這樣的模組依存性載入器管理多個模組了。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// bar 沒有需要任何其他的模組…</span></span><br><span class="line"><span class="title class_">MyModules</span>.<span class="title function_">define</span>(<span class="string">&#x27;bar&#x27;</span>, [], <span class="keyword">function</span> <span class="title function_">barImpl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params">who</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Let me introduce: &#x27;</span> + who;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">world</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">hello</span>: hello</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// foo 需要 bar 模組…</span></span><br><span class="line"><span class="title class_">MyModules</span>.<span class="title function_">define</span>(<span class="string">&#x27;foo&#x27;</span>, [<span class="string">&#x27;bar&#x27;</span>], <span class="keyword">function</span> <span class="title function_">fooImpl</span>(<span class="params">bar</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> hungry = <span class="string">&#x27;hippo&#x27;</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">awesome</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(bar.<span class="title function_">hello</span>(hungry).<span class="title function_">toUpperCase</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">awesome</span>: awesome</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bar = <span class="title class_">MyModules</span>.<span class="title function_">get</span>(<span class="string">&#x27;bar&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> foo = <span class="title class_">MyModules</span>.<span class="title function_">get</span>(<span class="string">&#x27;foo&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bar.<span class="title function_">hello</span>(<span class="string">&#x27;hippo&#x27;</span>));<span class="comment">// Let me introduce: hippo</span></span><br><span class="line"></span><br><span class="line">foo.<span class="title function_">awesome</span>();<span class="comment">//LET ME INTRODUCE: HIPPO</span></span><br></pre></td></tr></table></figure>

<p>這樣就可以要用什麼就指定什麼，不斛擔心順序問題了。</p>
<h4 id="ES6模組（ES6-Module）"><a href="#ES6模組（ES6-Module）" class="headerlink" title="ES6模組（ES6 Module）"></a>ES6模組（ES6 Module）</h4><p>在ES6中可將個別載入的檔案視為一個模組，每個模組都能匯入（import）其他模組或指定特定的API成員，也能匯出（export）自已公開的API成員。而瀏覽器或JavaScript引擎會經由其內建的模組載入匯入這個模組檔案。這些模組檔案的內容可視為被包覆在一個閉包內，當被另一個檔案引入和使用時即可在非原先語彙範疇定義處正常運作。</p>
<p>範例如下，在foo,js中載入bar module 的 hello，並利用於其內的awesome中，以將結果字串轉為大寫；在baz,js載救foo與 bar的完整模組，分別執行<code>bar.hello</code>與<code>foo.awesome()</code>。</p>
<p>bar.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params">who</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`Let me introduce: <span class="subst">$&#123;who&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> hello;</span><br></pre></td></tr></table></figure>

<p>foo.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hello <span class="keyword">from</span> <span class="string">&#x27;bar&#x27;</span>; <span class="comment">// 只會載入 bar module 的 hello</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hungry = <span class="string">&#x27;hippo&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">awesome</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">    <span class="title function_">hello</span>(hungry).<span class="title function_">toUpperCase</span>()</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> awesome;</span><br></pre></td></tr></table></figure>

<p>baz.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 載入 foo 與 bar 的完整模組</span></span><br><span class="line"><span class="variable language_">module</span> foo <span class="keyword">from</span> <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line"><span class="variable language_">module</span> bar <span class="keyword">from</span> <span class="string">&#x27;bar&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">  bar.<span class="title function_">hello</span>(<span class="string">&#x27;rhino&#x27;</span>)</span><br><span class="line">); <span class="comment">// Let me introduce: rhino</span></span><br><span class="line"></span><br><span class="line">foo.<span class="title function_">awesome</span>(); <span class="comment">// LET ME INTRODUCE: HIPPO</span></span><br></pre></td></tr></table></figure>

<p>這樣就可以要用什麼就載入什麼，不用擔心同名、順序等問題。</p>
<p>注意！模組模式是以函式為基礎來實作的，因此其API是在執行時期才能被識別，所以可在執行時期修改模組內的私有變數和函俞； 而ES6的模組是靜態的，意即在編譯時期而非執行時期被識別，因此可在編譯時檢查API是否存在而丟出錯誤訊息，並且無法在執行時修改模組內的私有變數和函式。</p>
<h4 id="回顧-7"><a href="#回顧-7" class="headerlink" title="回顧"></a>回顧</h4><p>看完文章，我們到底有什麼收獲呢？藉由本文可以理解到…</p>
<ul>
<li>閉包是函式記得並存取語彙範疇的能力，可說是指向特定範疇的參考，因此當函式是在其宣告的𣁎彙範疇之外執行時也能正常運作。</li>
<li>迴圈與閉包搭配使用時的謬誤與陷阱。</li>
<li>模組模式可經由建立一個模組實體來調用內層函式，而內層函式由於具有閉包的特性，因此可存取外層的變數和函式。透過模組模式，可隱藏私密資訊。並選擇對外公開的API。</li>
<li>利用模組依存性載入器或管理器或ES6模組來管理模組。</li>
</ul>
<h5 id="References-6"><a href="#References-6" class="headerlink" title="References"></a>References</h5><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/ch5.md">You Don’t Know JS: Scope &amp; Closures, Chapter 5: Scope Closure</a></li>
</ul>
<h3 id="你㯵JavaScript嗎？This"><a href="#你㯵JavaScript嗎？This" class="headerlink" title="你㯵JavaScript嗎？This"></a>你㯵JavaScript嗎？This</h3><p>本文主要會談到</p>
<ul>
<li>this是什麼？判斷this的值的四個規則與例外。</li>
<li>語彙的this，這裡會箭頭函數中的this的不同之處。</li>
</ul>
<h4 id="this是什麼？"><a href="#this是什麼？" class="headerlink" title="this是什麼？"></a>this是什麼？</h4><p>this是函式執行時所屬的物件，其值是在執行時期做綁定，可大致歸納為四個規則以供判斷。</p>
<h4 id="判斷this的四固規則"><a href="#判斷this的四固規則" class="headerlink" title="判斷this的四固規則"></a>判斷this的四固規則</h4><p>this的值可用四種規則判斷：預設綁定、隱含綁定、明確綁定和new綁定，以下分別述之。</p>
<h5 id="預設綁定（Default-Binding）"><a href="#預設綁定（Default-Binding）" class="headerlink" title="預設綁定（Default Binding）"></a>預設綁定（Default Binding）</h5><p>當其他規則都不適用時，意即不屬於任何物件的方法、沒有使用bind、call、apply或new，就套用預設綁定。此時this的值就是預設值全域物件，在瀏覽器環境底下是windows。</p>
<p>範例如下，sayHello不是某個物件的方法，也沒有使用bind、call、apply或new，因此this的值即winodw。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayHello</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">sayHello</span>();<span class="comment">// Window</span></span><br></pre></td></tr></table></figure>

<p>再看下面一個例子…在函式sayHello內嘗試印出<code>this.hello</code>，由於此時this的值是window，因此等同於查找<code>window.hello</code>的值，就會找到全域範疇所定義的hello了，最後就會印出「Hello World」。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayHello</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">hello</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> hello = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line"><span class="title function_">sayHello</span>();<span class="comment">// Hello World</span></span><br></pre></td></tr></table></figure>

<p>注意，若在函式內使用<code>&#39;use strict&#39;</code>宣告成嚴格模式，則this的值會改為undefined, 而非原本預設的全域物件window。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayHello</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">sayHello</span>(); <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>

<h4 id="嚴格模式（Strict-Mode）"><a href="#嚴格模式（Strict-Mode）" class="headerlink" title="嚴格模式（Strict Mode）"></a>嚴格模式（Strict Mode）</h4><p>在上一個例子中，我們看到了由於在函式內使用<code>&#39;use strict&#39;</code>宣告成嚴格模式，this的值變成undefined，而非原本預設的全域物件window，那麼，什麼是「嚴格模式」呢？</p>
<p>嚴格模式簡單說就是為了預防開發者的一些不小心或錯誤的行為，JavaScript引擎協助做了一些檢測的工作，當開發都誤用時就把錯誤丟出來，可參考-<a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Strict_mode">MDN</a>。</p>
<p>範例如下，在未宣告變數而賦值的狀況下，會無預警的產生一個全域變粓，但若使用嚴格模式（<code>user strict</code>）則會禁止這行為外， 還會報鏌，告知開發都變數尚未被定義。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;user strict&#x27;;</span><br><span class="line">a = 1;// Uncaught ReferenceError: a is not defined</span><br></pre></td></tr></table></figure>

<h4 id="隱含綁定（Implicit-Binding）"><a href="#隱含綁定（Implicit-Binding）" class="headerlink" title="隱含綁定（Implicit Binding）"></a>隱含綁定（Implicit Binding）</h4><p>當函式為物件的方法（method）時，在執行階段this就會被綁定至該物件。</p>
<p>範例如下，函式prompt為物件user方法，在執行階段this被綁至user，因此console時會到user查找其屬性name。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">sayHi</span>: prompt</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">prompt</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br><span class="line">user.<span class="title function_">sayHi</span>();<span class="comment">// &#x27;Jack&#x27;</span></span><br></pre></td></tr></table></figure>

<p>注意，只有最頂層（或說是最終層）的物件才是有用的。如下，prompt的this是最終層的物件anotherUser。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> anotherUser = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Not Jack!&#x27;</span>,</span><br><span class="line">    <span class="attr">sayHi</span>: prompt</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">anotherUser</span>: anotherUser</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">prompt</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br><span class="line">user.<span class="property">anotherUser</span>.<span class="title function_">sayHi</span>();<span class="comment">// &#x27;Not Jacke!&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="隱含的物去（implicitly-Lost）"><a href="#隱含的物去（implicitly-Lost）" class="headerlink" title="隱含的物去（implicitly Lost）"></a>隱含的物去（implicitly Lost）</h4><p>隱含綁定也同時會有「隱含失去」的問題-隱含失去是指函式失去綁定的物件，退回到預設綁定的狀態，意即this是全域物件windows或嚴格模式下的undefined。</p>
<p>什麼時候會造成隱含的失法呢？</p>
<ul>
<li>函式只是另一個函式的參考</li>
<li>參數傳遞中的callback</li>
<li>DOM element的事件綁定（event binding）</li>
</ul>
<p>Case1：函式是另一個函式的參考</p>
<p>範例如下，bar是<code>obj.foo</code>的參考，並且bar的呼叫地點是在𠔃域範疇，因此會套用預設綁定的規則。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">foo</span>: foo</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> bar = obj.<span class="property">foo</span>;</span><br><span class="line"><span class="keyword">var</span> a = <span class="string">&#x27;oops, global&#x27;</span>;</span><br><span class="line"><span class="title function_">bar</span>();<span class="comment">// &#x27;oops, global&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Case 2：參數傳遞中的callback</p>
<p>範例如下，<code>doFoo(fn)</code>的fn依舊是<code>obj.foo</code>的參考，並且fn的呼叫地點是在全域範疇，因此會套用預設綁定的規則。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doFoo</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="title function_">fn</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">foo</span>: foo</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="string">&#x27;oops, global&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">doFoo</span>(obj.<span class="property">foo</span>);<span class="comment">// &#x27;oops, global&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Case3：DOM delement的事件綁定</p>
<p>範例如下，事件中的callback的this是觸發事件的元素（DOM element）。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;button&quot;</span>&gt;</span>Click Me!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>點擊按鈕「Click Me!」後，console出目前this的值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> el = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;button&#x27;</span>);</span><br><span class="line"></span><br><span class="line">el.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>); <span class="comment">// &quot;&lt;button id=&#x27;button&#x27;&gt;Click Me!&lt;/button&gt;&quot;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>關於解法…雖然說this有可能會無預警的失去了原先預期綁定的this的值，但我們還是可以經由一些方法強制綁定，例如使用call、apply、bind，明確指出要綁定給this的物件，又或者，可使用軟綁定當this退化為全域物件時就給以預設值。</p>
<h4 id="明確綁定（Explicit-Binding）"><a href="#明確綁定（Explicit-Binding）" class="headerlink" title="明確綁定（Explicit Binding）"></a>明確綁定（Explicit Binding）</h4><p>使用 call、apply、bind，明確指出要綁定給this的物件。</p>
<h5 id="call"><a href="#call" class="headerlink" title="call"></a>call</h5><p>將第一個參數設定為函式內的context，意即設定第一個參數為函式內this的值。與apply的差異只在於傳參數的方法-call將參數一一傳入，而apply將參數使用陣列傳入。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> cat = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Hello Kitty&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> dog = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Snoopy&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params">num</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello,I am &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;My number is &#x27;</span> + num);</span><br><span class="line">&#125;</span><br><span class="line">sayHi.<span class="title function_">call</span>(cat, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">sayHi.<span class="title function_">call</span>(dog, <span class="string">&#x27;2&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>結果如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;Hello, I am Hello Kitty&quot;</span></span><br><span class="line"><span class="string">&quot;My number is 1&quot;</span></span><br><span class="line"><span class="string">&quot;Hello, I am Snoopy&quot;</span></span><br><span class="line"><span class="string">&quot;My number is 2&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> cat = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Hello Kitty&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> dog = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Snoopy&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params">args</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello,I am &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;My number is &#x27;</span> + args[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line">sayHi.<span class="title function_">apply</span>(cat, [<span class="string">&#x27;1&#x27;</span>]);</span><br><span class="line">sayHi.<span class="title function_">apply</span>(dog, [<span class="string">&#x27;2&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>結果如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;Hello, I am Hello Kitty&quot;</span></span><br><span class="line"><span class="string">&quot;My number is 1&quot;</span></span><br><span class="line"><span class="string">&quot;Hello, I am Snoopy&quot;</span></span><br><span class="line"><span class="string">&quot;My number is 2&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h5><p>在執行函式前，綁定要指定的物件，這樣this就會是這個物件。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> cat = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Hello Kitty&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> dog = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Snoopy&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params">ags</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello,I am &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br><span class="line">sayHi.<span class="title function_">bind</span>(cat)();</span><br><span class="line">sayHi.<span class="title function_">bind</span>(dog)();</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">msg</span>: <span class="string">&#x27;Hi!&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">msg</span>);</span><br><span class="line">&#125;.<span class="title function_">bind</span>(obj), <span class="number">2000</span>);</span><br></pre></td></tr></table></figure>

<p>硬綁定（Hard Binding）</p>
<p>硬綁定是指使用bind寫死要綁定的物件，可避免函式呼叫時退回到預設綁定，</p>
<p>如下，這裡有一個簡單的綁定this的helper，用來寫死要綁定的物件obj。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">something</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>, something);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">a</span> + something;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//簡易的綁定 this 的 helper</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bind</span>(<span class="params">fn, obj</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fn.<span class="title function_">apply</span>(obj, <span class="variable language_">arguments</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> bar = <span class="title function_">bind</span>(foo, obj);</span><br><span class="line"><span class="keyword">var</span> b = <span class="title function_">bar</span>(<span class="number">3</span>);<span class="comment">// 2 3</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b);<span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<p>在<code>bind(foo,obj)</code>中，將foo的this強制指定為obj，並將結果指定給bar, 因此當執行<code>bar(3)</code>時，<code>this.a</code>對obj查找屬性a（找到為2，並非退回到全域範疇）且加上傳入的數字3，而得到結果b為5</p>
<p>call、apply、bind適用情境與方法， 整理如下。</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">bind</th>
<th align="center">call</th>
<th align="center">apply</th>
</tr>
</thead>
<tbody><tr>
<td align="center">適用狀況</td>
<td align="center">函數在執𢓝前先綁定物件做為context</td>
<td align="center">context較常變動的埸景。依照呼叫時的需要帶不同的物件作為該function的this。在呼叫的當下就立即執行。</td>
<td align="center">與call相同</td>
</tr>
<tr>
<td align="center">傳參數的方式</td>
<td align="center">代入指定的物件做為context</td>
<td align="center">參數需要一個一個指定func.call(context,arg1,arg2,…)</td>
<td align="center">參數使用陣列傳入func.apple(context,[arg1,arge,…])</td>
</tr>
</tbody></table>
<p>API呼叫的情境（API Call “Contexts”）</p>
<p>許多函式庫的函式都會提供一個參數作為綁定的物件，這個參數通常稱為情境參數（context argument），目的是讓開發都不必再使用bind來綁定this的值。</p>
<p>如下，forEach傳入兩個參數，分別是要執行callback foo和情境參數obj，因此<code>console.log</code>中的this就是obj。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">el</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(el, <span class="variable language_">this</span>.<span class="property">id</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&#x27;awesome&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].<span class="title function_">forEach</span>(foo, obj); <span class="comment">// 1 awesome  2 awesome  3 awesome</span></span><br></pre></td></tr></table></figure>

<h5 id="new綁定（new-Binding）"><a href="#new綁定（new-Binding）" class="headerlink" title="new綁定（new Binding）"></a>new綁定（new Binding）</h5><p>this會指向new出來的物件。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Cat</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sayHi</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hi,I am &#x27;</span> + name);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span> === kitten);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> kitten = <span class="keyword">new</span> <span class="title class_">Cat</span>(<span class="string">&#x27;Pusheen&#x27;</span>);<span class="comment">// &quot;Hi, I am Pusheen&quot;</span></span><br><span class="line">kitten.<span class="title function_">sayHi</span>();<span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h4 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h4><p>如何利用以上的規則決定this的值呢？規則套用的優先順序，由高至低排列如下</p>
<ul>
<li>new 綁定</li>
<li>明確綁定</li>
<li>隱含綁定</li>
<li>預設綁定</li>
</ul>
<h4 id="綁定的例外"><a href="#綁定的例外" class="headerlink" title="綁定的例外"></a>綁定的例外</h4><p>雖然以上四個規則看起來很全面、很詳細，但有規則就有例外。</p>
<h5 id="忽略this"><a href="#忽略this" class="headerlink" title="忽略this"></a>忽略this</h5><p>若在使用apply、call、bind這些確綁定時，傳入null或undefined作為綁定的物件，則this的值會退回到預設綁定的全域物件window。若不在意this到底是什麼，只是要一個佔位值，那麼null看起來就是合理的選擇。</p>
<p>如下，可能只是想要攤開一個陣列，或利用bind能夠carry參數的特性分次傳入參數。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`a: <span class="subst">$&#123;a&#125;</span>, b: <span class="subst">$&#123;b&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line">foo.<span class="title function_">apply</span>(<span class="literal">null</span>, [<span class="number">2</span>, <span class="number">3</span>]);<span class="comment">//a: 2, b: 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bar = foo.<span class="title function_">bind</span>(<span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line"><span class="title function_">bar</span>(<span class="number">3</span>);<span class="comment">//a: 2, b: 3</span></span><br></pre></td></tr></table></figure>

<p>備註：關於攤開陣𦕁以作為參數的方法，可使用ES6的擴展運算子（spread operator），例如<code>foo(...[1, 2])</code>其效果等同於<code>foo.apply(null,[1,2])</code>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`a: <span class="subst">$&#123;a&#125;</span>, b: <span class="subst">$&#123;b&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(...[<span class="number">1</span>, <span class="number">2</span>]);<span class="comment">// a: 1, b: 2</span></span><br></pre></td></tr></table></figure>

<p>注意，傳入null可能會造成一些難解的bug。因此，比起null，傳入「空物件」-一個完全空的、無委派的物件作為this的值是更安全的作法，這樣至少將影響範圍限級制在這個空物件上，而不影響全域物件window，就能避免一些難以察覺和修正的錯誤。</p>
<p>在這裡使用<code>Object.create(null)</code>來建立空物件。比起<code>&#123; &#125;</code>來說，<code>Object.create(null)</code>不會與<code>Object.prototype</code>有委派關系，所以比<code>&#123;&#125;</code>來得更空，稍後會有詳細的篇章來說明原型與行為委派。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`a: <span class="subst">$&#123;a&#125;</span>, b: <span class="subst">$&#123;b&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ø = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>); <span class="comment">// 建立空物件！</span></span><br><span class="line"></span><br><span class="line">foo.<span class="title function_">apply</span>(ø, [<span class="number">2</span>, <span class="number">3</span>]); <span class="comment">// a: 2, b: 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bar = foo.<span class="title function_">bind</span>(ø, <span class="number">2</span>);</span><br><span class="line"><span class="title function_">bar</span>(<span class="number">3</span>); <span class="comment">// a: 2, b: 3</span></span><br></pre></td></tr></table></figure>

<h5 id="間接參考（Indirect-Reference）"><a href="#間接參考（Indirect-Reference）" class="headerlink" title="間接參考（Indirect Reference）"></a>間接參考（Indirect Reference）</h5><p>經由「指定」會產生間接參考，而當函式建立山間接參考時就會套用預設綁定。</p>
<p>例如，<code>p.foo = o.foo</code>這個指定運算式產生了間接參考，於是套用預設綁定後，this的值為window。對照前面提到的四種規則，前三種規則都不符合，當然就只能套用預設綁定了。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">var</span> o = &#123; <span class="attr">a</span>: <span class="number">3</span>, <span class="attr">foo</span>: foo &#125;;</span><br><span class="line"><span class="keyword">var</span> p = &#123; <span class="attr">a</span>: <span class="number">4</span> &#125;;</span><br><span class="line">o.<span class="title function_">foo</span>();<span class="comment">// 3</span></span><br><span class="line">(p.<span class="property">foo</span> = o.<span class="property">foo</span>)();<span class="comment">//2</span></span><br></pre></td></tr></table></figure>

<h5 id="軟綁定（Soft-Binding）"><a href="#軟綁定（Soft-Binding）" class="headerlink" title="軟綁定（Soft Binding）"></a>軟綁定（Soft Binding）</h5><p>當this退化成全域物件時，是否可給定預設值？</p>
<p>硬綁定可避免函式呼叫時不小心退回到預設綁定狀態，但也減低了設定this的值的彈性。因此，這裡提出一個解法，讓函式能經由隱含綁定或明確綁定的方式設定this的值，而當this退化成全域物件時，又能給予一個預設值而非全域物件，這種不寫死而動態設定預設值的方式，稱之為「軟綁定」。</p>
<p>建立一個工具來達到軟綁定的目的- 若this是global、window或undefined就給予預設值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">softBind</span>) &#123;</span><br><span class="line">    <span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">softBind</span> = <span class="keyword">function</span> (<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> fn = <span class="variable language_">this</span>,</span><br><span class="line">            curried = [].<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>, <span class="number">1</span>),</span><br><span class="line">            bound = <span class="keyword">function</span> <span class="title function_">bound</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> fn.<span class="title function_">apply</span>(</span><br><span class="line">                    <span class="comment">/** </span></span><br><span class="line"><span class="comment">                    這裡判斷三種狀況…</span></span><br><span class="line"><span class="comment">                      - this 沒有值嗎？例如：undefined</span></span><br><span class="line"><span class="comment">                      - this 的值是 window 嗎？</span></span><br><span class="line"><span class="comment">                      - this 的值是 global 嗎？</span></span><br><span class="line"><span class="comment">                      任一狀況為 true 的話，則就回傳預設要綁定為 this 物件，也就是 obj</span></span><br><span class="line"><span class="comment">                    **/</span></span><br><span class="line">                    (!<span class="variable language_">this</span> ||</span><br><span class="line">                        (<span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="variable language_">this</span> === <span class="variable language_">window</span>) ||</span><br><span class="line">                        (<span class="keyword">typeof</span> <span class="variable language_">global</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="variable language_">this</span> === <span class="variable language_">global</span>)</span><br><span class="line">                    ) ? obj : <span class="variable language_">this</span>,</span><br><span class="line">                    curried.<span class="property">concat</span>.<span class="title function_">apply</span>(curried, <span class="variable language_">arguments</span>)</span><br><span class="line">                );</span><br><span class="line">            &#125;;</span><br><span class="line">        bound.<span class="property"><span class="keyword">prototype</span></span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(fn.<span class="property"><span class="keyword">prototype</span></span>);</span><br><span class="line">        <span class="keyword">return</span> bound;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Function.prototype掛一個方法softBind，這個方法輸入一個物件作為當函式呼叫時不小心退回到預設綁定狀態時的預設綁定物件，輸出是回傳一個函式，之後會依照這個函式 當時執行情況的this值來決定是否已退回到全域物件而去綁定預設傳入的物件。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">softBind</span>) &#123;</span><br><span class="line">    <span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">softBind</span> = <span class="keyword">function</span> (<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> fn = <span class="variable language_">this</span>,</span><br><span class="line">            curried = [].<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>, <span class="number">1</span>),</span><br><span class="line">            bound = <span class="keyword">function</span> <span class="title function_">bound</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> fn.<span class="title function_">apply</span>(</span><br><span class="line">                    <span class="comment">/** </span></span><br><span class="line"><span class="comment">                    這裡判斷三種狀況…</span></span><br><span class="line"><span class="comment">                      - this 沒有值嗎？例如：undefined</span></span><br><span class="line"><span class="comment">                      - this 的值是 window 嗎？</span></span><br><span class="line"><span class="comment">                      - this 的值是 global 嗎？</span></span><br><span class="line"><span class="comment">                      任一狀況為 true 的話，則就回傳預設要綁定為 this 物件，也就是 obj</span></span><br><span class="line"><span class="comment">                    **/</span></span><br><span class="line">                    (!<span class="variable language_">this</span> ||</span><br><span class="line">                        (<span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="variable language_">this</span> === <span class="variable language_">window</span>) ||</span><br><span class="line">                        (<span class="keyword">typeof</span> <span class="variable language_">global</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="variable language_">this</span> === <span class="variable language_">global</span>)</span><br><span class="line">                    ) ? obj : <span class="variable language_">this</span>,</span><br><span class="line">                    curried.<span class="property">concat</span>.<span class="title function_">apply</span>(curried, <span class="variable language_">arguments</span>)</span><br><span class="line">                );</span><br><span class="line">            &#125;;</span><br><span class="line">        bound.<span class="property"><span class="keyword">prototype</span></span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(fn.<span class="property"><span class="keyword">prototype</span></span>);</span><br><span class="line">        <span class="keyword">return</span> bound;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;name: &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="attr">name</span>: <span class="string">&#x27;obj&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj2 = &#123; <span class="attr">name</span>: <span class="string">&#x27;obj2&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj3 = &#123; <span class="attr">name</span>: <span class="string">&#x27;obj3&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> fooOBJ = foo.<span class="title function_">softBind</span>(obj);</span><br><span class="line"><span class="title function_">fooOBJ</span>();<span class="comment">// (1) name: obj &lt;---- 退回到 obj</span></span><br><span class="line">obj2.<span class="property">foo</span> = foo.<span class="title function_">softBind</span>(obj);</span><br><span class="line">obj2.<span class="title function_">foo</span>();<span class="comment">// (2) name:obj2</span></span><br><span class="line">fooOBJ.<span class="title function_">call</span>(obj3);<span class="comment">//(3) name:obj3</span></span><br><span class="line"><span class="built_in">setTimeout</span>(obj2.<span class="property">foo</span>, <span class="number">10</span>);<span class="comment">//(4) name:obj &lt;---- 退回到 obj</span></span><br></pre></td></tr></table></figure>

<p>說明</p>
<ul>
<li>（1）<code>fooOBJ()</code>的this是window，因此是退回到預設的綁定狀態，在此套用軟綁定工具幫我們設定的this的預設值obj。</li>
<li>（2）<code>obj2.foo()</code>的this是obj2，因此印出「name:obj2」。</li>
<li>（3）<code>fooOBJ.call(obj3)</code>使用call明確綁定this的值為obj3，因此印出「name:obj3」。</li>
<li>（4）<code>setTimeout(obj2.foo, 10)</code>中的<code>obj2.foo</code>由於參數傳遞中的callback會讓函式失去綁定的物件，因此this是window而退回到預設定綁定狀態，在此套用軟綁定工具幫我們設定的this的預設值obj。</li>
</ul>
<h4 id="語彙的this（Lexical-this）"><a href="#語彙的this（Lexical-this）" class="headerlink" title="語彙的this（Lexical this）"></a>語彙的this（Lexical this）</h4><p>所謂的「語彙的this」是指this的值不適用於以上提到的四重種規則來做判斷，而是回歸到語彙範疇的查找，其this的值並非源自執行時的綁定，而是定義時包含它的範疇或全域範疇，是無法被覆寫的，這裡即將要提偌的用箭頭函式（arrow function）來綁定this的值就是這樣的狀況。</p>
<p>這裡先放一個例子，待稍後解釋。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;Apple&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">  <span class="attr">sayHi</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">obj.<span class="title function_">sayHi</span>(); <span class="comment">// Hi, I am Jack</span></span><br><span class="line"><span class="built_in">setTimeout</span>(obj.<span class="property">sayHi</span>, <span class="number">1000</span>); <span class="comment">// Hi, I am Apple</span></span><br></pre></td></tr></table></figure>

<p>其中，我們可以看到<code>obj.sayHo()</code>印出預期的「Hi,I am Jack」，但<code>setTimeout(obj.sayHi, 1000);</code>卻因為前面提過的隱含的失去中的函式是另一個函式的參考而失去了原先this的綁定。</p>
<p>先來談一些常用的改變this的方法</p>
<ul>
<li>透過變數儲存目前this的值。</li>
<li>使用bind、call或apply，綁定特定的物件作為this的值。</li>
</ul>
<p>透過變數儲存目前this的值…這其實不算是「改變」，只能說是「保留」。如果希望存到外部的this，可用一個變數<code>_this</code>儲存起，稍後再用。</p>
<p>修改上例如下，一秒後確是印出「Hi,I am Jack」。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;Apple&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">sayHi</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> _this = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;_this.name&#125;</span>`</span>);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">obj.<span class="title function_">sayHi</span>();</span><br></pre></td></tr></table></figure>

<p>當然我們也可以用bind、call或apply來綁定特定的物件作為this的值。關於bind、call或apply的範例可參考之前提過的[明確綁定](# 明確綁定（Explicit Binding）)的部份。</p>
<p>修改上例如下，一秒後的確是印出「Hi,I am Jack」。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;Apple&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">sayHi</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>`</span>);</span><br><span class="line">        &#125;.<span class="title function_">bind</span>(<span class="variable language_">this</span>), <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">obj.<span class="title function_">sayHi</span>();<span class="comment">// Hi, I am Jack</span></span><br></pre></td></tr></table></figure>

<p>即然箭頭函數會自動綁定所在範疇，那也就可以這麼修改了…經由箭頭函數就會把this綁在obj上。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;Apple&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">sayHi</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>`</span>);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">obj.<span class="title function_">sayHi</span>();<span class="comment">// Hi, I am Jack</span></span><br></pre></td></tr></table></figure>

<p>但箭頭並不是一個所有狀況都適用的超級為敵通用解…</p>
<p>箭頭函數不適用於…</p>
<ul>
<li>䈟頭函數會將this強制綁定為執行環境。因此，若不希望this被綁定為執行環境，基本上都是不適用的，不需要為了少寫幾個字而硬要使用箭頭函數。</li>
<li>箭頭函數內的callback是匿名的，匿名函式的缺點請看[這裡](# 匿名 vs 具名（Anonymous vs Named）)。</li>
</ul>
<h4 id="回顧-8"><a href="#回顧-8" class="headerlink" title="回顧"></a>回顧</h4><p>看完這篇文章，我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>this是function執行所屬的物件，this是在執行時期做綁定其值和函式在哪裡被呼叫有關。</li>
<li>判斷this的值的四個規則，並以匹配的優先順序由高至低排列<ul>
<li>new 綁定：this會指向new出來的物件。</li>
<li>明確綁定：使用call、apply、bind，明確指出要綁定給this的物件。</li>
<li>隱含綁定：當函式為物件的方法時，在執行階段this就會被綁定至該物件。</li>
<li>預設綁定： 當以上規則都不適用時，就套用預設綁定，在非嚴格模式下，瀏覽器環境this的值是預設全域物件window，而在嚴格模式下，this的值是undefined</li>
</ul>
</li>
<li>箭頭函數（arrow function）的this的值並不適用上面提到的四種規則，this強制綁定為執行環境，例如在瀏覽器中就是windwo。</li>
</ul>
<h5 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h5><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/this%20%26%20object%20prototypes/ch1.md">You Don’t Know JS: this &amp; Object Prototypes, Chapter 1: this Or That?</a></li>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/this%20%26%20object%20prototypes/ch2.md">You Don’t Know JS: this &amp; Object Prototypes, Chapter 2: this All Makes Sense Now!</a></li>
<li><a href="http://javascript.info/object-methods#four-scents-of-this">Object methods, “this”</a></li>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/apC.md">You Don’t Know JS: Scope &amp; Closures, Appendix C: Lexical-this</a></li>
</ul>
<h4 id="推薦閱讀"><a href="#推薦閱讀" class="headerlink" title="推薦閱讀"></a>推薦閱讀</h4><p>推薦閱讀 Kuro 大大關於 this 的好文…</p>
<ul>
<li>[What’s THIS in JavaScript ? <a href="https://kuro.tw/posts/2017/10/12/What-is-THIS-in-JavaScript-%E4%B8%8A/">上</a></li>
<li>[What’s THIS in JavaScript ? <a href="https://kuro.tw/posts/2017/10/17/What-s-THIS-in-JavaScript-%E4%B8%AD/">中</a></li>
<li>[What’s THIS in JavaScript ? <a href="https://kuro.tw/posts/2017/10/20/What-is-THIS-in-JavaScript-%E4%B8%8B/">下</a></li>
</ul>
<h3 id="你懂JavaScript嗎？物件（Object）"><a href="#你懂JavaScript嗎？物件（Object）" class="headerlink" title="你懂JavaScript嗎？物件（Object）"></a>你懂JavaScript嗎？物件（Object）</h3><p>關於物件，本文會提到</p>
<ul>
<li>語法：宣告式與建構形式。</li>
<li>型別：再次複習typeof、使用instanceof判定物件子型別。</li>
<li>內容：屬性值的存取、物件的複製（淺拷貝與深拷貝）、屬性描述器、不可變的物件、取值器與設值器、檢視屬性是否存在、屬性列舉。</li>
<li>迭代：一些迭代出陣列的值的方法。</li>
</ul>
<h4 id="語法（Syntax）"><a href="#語法（Syntax）" class="headerlink" title="語法（Syntax）"></a>語法（Syntax）</h4><p>建立物件有兩種方式</p>
<ul>
<li>宣告式（declarative）或稱字面值（literal），例如：<code>const obj = &#123; name: &#39;Jack&#39;&#125;;</code>。</li>
<li>建構形（constructed form），例如：<code>const obj= new Object(); obj.name = &#39;Jack&#39;;</code>，也就是原生功能，但由於一些些雷區，這種方式其實很少用。</li>
</ul>
<p>簡單來說，兩者主要的差別是新增屬性時，字面值可在物件建立時一次全部加入，但建構形式必須在物件建立後一筆一筆新增。</p>
<h4 id="型別（Type）"><a href="#型別（Type）" class="headerlink" title="型別（Type）"></a>型別（Type）</h4><p>JavaScript的資料型態有七種-字串（string）、數字（number）、布林值（boolean）、null、undefined 、物件（object）與symbol。其中函式（function）和陣列（array）、日期（date）皆為物件的一種，function是可呼叫的物件，而array是結構較嚴謹的物件。</p>
<h4 id="typeof-2"><a href="#typeof-2" class="headerlink" title="typeof"></a>typeof</h4><p>關於型別就會想到型別檢測，想到型檢測就不得不提一下typeof的議題…</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="string">&#x27;Hello World&#x27;</span>);<span class="comment">// string</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">true</span>);<span class="comment">// boolean</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="number">1234567</span>);<span class="comment">// number</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">null</span>);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">undefined</span>);<span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> &#123; <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span> &#125;);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">Symbol</span>());<span class="comment">// symbol</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;);<span class="comment">// function</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">NaN</span>);<span class="comment">// number</span></span><br></pre></td></tr></table></figure>

<p>這裡看到幾個有趣的（奇怪的）地方</p>
<ul>
<li>null是基本型別之一，但<code>typeof null</code>卻得到object，而非null!這可說是一個bug，可是若因為修正了這個bug則可能會導致很多網站壞掉，因此就不修了！</li>
<li>雖然說function是物件的子型別，但<code>typeof function() &#123;&#125;</code>是得到function而非object，和陣𦕁依舊得到object是不一樣的。</li>
<li>NaN表示是無效的數字，但依舊還是數字，因此在資料型別的檢測<code>typeof NaN</code>結果就是number，不要被字面上的意思「不是數字」（not a number）給弄糊塗了。另外，NaN與任何數字運算都會得到NaN，並且NaN不大於、不小於也不等於任何數字，包含NaN它自已。</li>
</ul>
<p>另外，如果想知道這個物件到底是屬於哪個子型別，則可使用<code>Object.prototype.toString</code>來檢視<code>[[Class]]</code>這個內部屬性。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]));<span class="comment">//[object Array]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span> &#125;));<span class="comment">//[object Object]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params"></span>) &#123; &#125;));<span class="comment">//[object Function]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="regexp">/hellowrold/i</span>));<span class="comment">//[object Regexp]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">new</span> <span class="title class_">Date</span>()));<span class="comment">//[object Date]</span></span><br></pre></td></tr></table></figure>

<h4 id="內建物件（Built-in-Objects）"><a href="#內建物件（Built-in-Objects）" class="headerlink" title="內建物件（Built-in Objects）"></a>內建物件（Built-in Objects）</h4><p>內建物件指的是使用內建函式所建立的物件，這些物件都屬於物件子型別的一種，除了上面提到的陣列、函式與日期外，這裡列出物件所有的子型別：String、Number、Boolean、Object、Function、Array、Date、RegExp、Error，它們的用途是給予開發者取得屬性或方法的使用，也就是我們常聽到的原生的功能。因此，當使用建構式建立字串、布林或數字等值時，建立的其實不是基本型別值而是物件，因此可用instanceof來檢查是由哪個建構式建立，也就是來判斷是否為指定的物件型別。</p>
<p>如下，使用字串字面值宣告了一個字串str，當我們使用str進行<code>.length</code>的操作以取得其長度時，JavaScript就會將這個字串基本型別的值強制轉成對應的物件子型別，也就是上面提到的String。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;Hello World!&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str <span class="keyword">instanceof</span> <span class="title class_">String</span>)<span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="property">length</span>);<span class="comment">// 12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> strObj = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(strObj <span class="keyword">instanceof</span> <span class="title class_">String</span>);<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(strObj.<span class="property">length</span>);<span class="comment">// 12</span></span><br></pre></td></tr></table></figure>

<p>注意</p>
<ul>
<li>null和undefined只有基本資料型別，沒有物件包裹形式，意即沒有對應的物件子型別，所以無法使用new來產生。</li>
<li>Date、RegExp、Error沒有基本資料型別的形式，所以只能使用物件子型別new來產生。</li>
</ul>
<h4 id="內容（Contents）"><a href="#內容（Contents）" class="headerlink" title="內容（Contents）"></a>內容（Contents）</h4><p>物件的內容是由屬性組成的，而屬性是由key-valur pair構成，value 可為任意資料型別的值，並且值是以參考（reference）的方式（存位置）儲存。</p>
<p>如何存取物件的屬性？有兩種方式</p>
<ol>
<li>特性存取（property access），意即<code>.</code></li>
<li>鍵值存取（key access），意即<code>[]</code></li>
</ol>
<p>其中，特性存取<code>.</code>必須符合<a href="https://developer.mozilla.org/en-US/docs/Glossary/Identifier">識別字的規範</a>，簡單的說就是只能是字母、數字、<code>$</code>（錢字號）或<code>_</code>（底線），並且不能以數字開頭，之後可加上a-z、A-Z、<code>$</code>、<code>_</code>和數字0-9，可為關鍵字或保留字。</p>
<p>讓我們來看一些疑難雜症吧！</p>
<h4 id="Q1-如果屬性名稱是特殊字符或動態產生的，該怎麼存取它的值呢？"><a href="#Q1-如果屬性名稱是特殊字符或動態產生的，該怎麼存取它的值呢？" class="headerlink" title="Q1:如果屬性名稱是特殊字符或動態產生的，該怎麼存取它的值呢？"></a>Q1:如果屬性名稱是特殊字符或動態產生的，該怎麼存取它的值呢？</h4><p>若要使用一些包含特殊或動態產生的字串作為屬性名稱，就必須使用鍵值存取<code>[]</code>的方式。</p>
<p>包含特殊字符的屬性名稱</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="string">&#x27;!!12345!!&#x27;</span>: <span class="string">&#x27;Hello Wrold&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line">obj.!!<span class="number">12345</span>!!; <span class="comment">//Uncaught SyntaxError: Unexpected token !</span></span><br><span class="line">obj[<span class="string">&quot;!!12345!!&quot;</span>]<span class="comment">// &quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>

<p>ES6新增動態產生的字串作為屬性名稱功能，讓key的值可經由運算得出。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> prefix = <span class="string">&#x27;fresh-&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> fruits = &#123;</span><br><span class="line">    [prefix + <span class="string">&#x27;apple&#x27;</span>]: <span class="number">100</span>,</span><br><span class="line">    [prefix + <span class="string">&#x27;orange&#x27;</span>]: <span class="number">60</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fruits[<span class="string">&#x27;fresh-apple&#x27;</span>]);<span class="comment">//100</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fruits[<span class="string">&#x27;fresh-orange&#x27;</span>]);<span class="comment">//60</span></span><br></pre></td></tr></table></figure>

<h4 id="Q2-屬性真的只能是字串嗎？可以是數字、物件等其他型別的值嗎？"><a href="#Q2-屬性真的只能是字串嗎？可以是數字、物件等其他型別的值嗎？" class="headerlink" title="Q2:屬性真的只能是字串嗎？可以是數字、物件等其他型別的值嗎？"></a>Q2:屬性真的只能是字串嗎？可以是數字、物件等其他型別的值嗎？</h4><p>屬性名稱只能是字串，若不是𡪤串則會被強制轉為字串。</p>
<p>如下，<code>obj[obj]</code>的key值被強制轉為字串<code>&#39;[object Object]&#39;</code>，同理，<code>obj[999]</code>的key值999也被轉為字串<code>&#39;999&#39;</code>了。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="title class_">Qoo</span>: <span class="string">&#x27;有種果汁真好喝&#x27;</span> &#125;;</span><br><span class="line">obj[obj]=<span class="string">&#x27;喝的時候酷兒&#x27;</span>;</span><br><span class="line">obj[<span class="number">999</span>]=<span class="string">&#x27;喝完臉紅紅！&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj[<span class="string">&#x27;[object Object]&#x27;</span>]);<span class="comment">//喝的時候酷兒</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj[<span class="string">&#x27;999&#x27;</span>]);<span class="comment">//喝完臉紅紅！</span></span><br></pre></td></tr></table></figure>

<h4 id="函式（Function）vs方法（Method）"><a href="#函式（Function）vs方法（Method）" class="headerlink" title="函式（Function）vs方法（Method）"></a>函式（Function）vs方法（Method）</h4><p>闢謠…澄清…!!??</p>
<p>在其它語言中，屬於某個物件的函式稱為方法，但在JavaScript中，函式並不會特別屬於某個物件，物件充其量也只是儲存對某個函式的參考而已，並非真的「屬於」這個物件，因此，在JavaScript中，函式與方法是同義的，並沒有區別。除了在ES6新增的super參考，super與class一起使用時super會靜態綁定函式，經由這樣所綁定的函式就比較接近一般在其他語言所看到的方法了。</p>
<h4 id="陣列（Array）"><a href="#陣列（Array）" class="headerlink" title="陣列（Array）"></a>陣列（Array）</h4><p>陣列使用非負整數作為索引，注意…</p>
<ul>
<li><p>若使用具名特性（named property）作為索引，則不會增加陣列的長度。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array.<span class="property">length</span>); <span class="comment">// 3</span></span><br><span class="line">array[<span class="number">3</span>] = <span class="number">4</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array.<span class="property">length</span>); <span class="comment">// 4</span></span><br><span class="line">array[<span class="string">&#x27;foo&#x27;</span>] = <span class="string">&#x27;bar&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array.<span class="property">length</span>); <span class="comment">// 4, 陣列的長度不變！</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>具名特性（named property）若以字串格式存在，就會轉為數字。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">array[<span class="string">&#x27;3&#x27;</span>] = <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array);<span class="comment">//[1, 2, 3, &quot;foo&quot;]</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="複製物件"><a href="#複製物件" class="headerlink" title="複製物件"></a>複製物件</h4><p>  複製物件的方式分為淺拷貝與深拷貝兩種。</p>
<p>  為什麼要探討淺拷貝與深拷貝呢？這是根本於基本型別值是傳值而物件是傳參考的緣故，既然物件是傳參考，就要考慮是把整份資料都複製一份，還是複製參考就好？淺拷貝是複製參考，深拷貝是把整份資料都複制一份，常用於考慮物件資料是否要其用的狀況。</p>
<h5 id="淺拷貝（Shallow-Copy）"><a href="#淺拷貝（Shallow-Copy）" class="headerlink" title="淺拷貝（Shallow Copy）"></a>淺拷貝（Shallow Copy）</h5><p>  除了基本的資料型中純值（非物件）的資料會真的複製另外一份值之外，其他的都只是複製一份參考而已，例如：<code>Object.assign</code>在處理超過一層的物件時就只能做偮淺拷貝，只有一層的話是可以做偌深拷貝的。</p>
<h5 id="深拷貝（Deep-Copy）"><a href="#深拷貝（Deep-Copy）" class="headerlink" title="深拷貝（Deep Copy）"></a>深拷貝（Deep Copy）</h5><p>  複製整個物件，通常會使用JSON-safe的物件，先經由序列化為JSON字串後再剖析回物件。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> newObj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(oldobj));</span><br></pre></td></tr></table></figure>

<p>  範例如下。</p>
<p>  單層物件時，<code>Object.assign</code>與「先序列化再剖析」的方法都可以做完全的拷貝。也就是深拷貝，由於物件的比對的是比較儲存位置，因此當比較拷貝結果特，兩者是不相等的。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> simpleObj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">b</span>: <span class="number">2</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> newSimpleObj = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, simpleObj);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newSimpleObj === simpleObj);<span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newSimpleObj2 = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(newSimpleObj));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newSimpleObj2 === simpleObj);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>  那麼，物件再多層的狀況下，又是怎樣的狀況呢？如下，由於<code>Object.assign</code>只能做單層的拷貝，因此第二層開始就只是複製參考而已，儲存位置不變，故為true；而「先序列化再剖析」的方法則是完整地把整個資料複製起來，存到另一個地方，因此儲存位置不同，得到false。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">b</span>: &#123;</span><br><span class="line">        <span class="attr">c</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">d</span>: <span class="number">3</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> newObj = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, obj);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newObj.<span class="property">b</span> === obj.<span class="property">b</span>);<span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newObj2 = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(newObj));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newObj2.<span class="property">b</span> === obj.<span class="property">b</span>);<span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<h4 id="屬性描述器（Property-Descriptor）"><a href="#屬性描述器（Property-Descriptor）" class="headerlink" title="屬性描述器（Property Descriptor）"></a>屬性描述器（Property Descriptor）</h4><p>  屬性描述器可用來檢視屬性的特徵，例如：可入寫入（writable）、可否配置（configurable）與可否列舉（enumerable）。</p>
<p>  例如，檢視object.a這個屬性的特徵。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(obj, <span class="string">&#x27;name&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>  得到結果。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; </span><br><span class="line">  <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>, </span><br><span class="line">  <span class="attr">writable</span>: <span class="literal">true</span>, </span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">true</span>, </span><br><span class="line">  <span class="attr">configurable</span>: <span class="literal">true</span> </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>  使用defineProperty定義物件的屬性與特性。通常使用這種方法的目的是…</p>
<ul>
<li>新增屬性，通常是為了修改預設特徵的值。</li>
<li>若特性是configurable的話。則可用來修改屬性的特徵值。</li>
</ul>
<p>  範例如下，為物件obj定義一個新的屬性name，並設定其特徵值。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">// Apple</span></span><br></pre></td></tr></table></figure>

<h5 id="Writable"><a href="#Writable" class="headerlink" title="Writable"></a>Writable</h5><p>屬性的值是否「可被寫入」。</p>
<p>例如，設定name這個屬性是不可寫入的，因此當嘗試更新這個值的時候，發現無法更新，並且在strict mode之下會丟出TypeError的錯誤訊息。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">false</span>,<span class="comment">//不可寫入！</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">// Apple</span></span><br><span class="line">obj.<span class="property">name</span>=<span class="string">&#x27;Grape&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">// Apple，屬性name的值無法被變更</span></span><br></pre></td></tr></table></figure>

<h5 id="Configurable"><a href="#Configurable" class="headerlink" title="Configurable"></a>Configurable</h5><p>屬性是否是「可配置的」，意即當configurable為false的時候，為法再使用defineProperty更新特徵的值，否則會丟出TypeError，但有一個例外，當configurable為false的時候，writable仍可由true改為false，但不能從false改為true。</p>
<p>當configurable為false的時候，無法再使用defineProperty更新特徵的值，否則會丟出TypeError。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,<span class="comment">// false -&gt; true</span></span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Uncaught TypeError: Cannot redefine property: name</span></span><br></pre></td></tr></table></figure>

<p>當configurable無false的時候，writable仍可由true改為false，但不能從false改為true。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,<span class="comment">//</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">false</span>,<span class="comment">//</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 這是可行的</span></span><br></pre></td></tr></table></figure>

<p>當configurable為false的時候，writable仍可由true改為false，但不能從false改為true。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">false</span>,<span class="comment">//</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,<span class="comment">//</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Uncaught TypeError: Cannot redefine property: name</span></span><br></pre></td></tr></table></figure>

<p>除了是否可更新特徵的設定外，configurable另一個作用就是是否可被delete刪除該屬性。</p>
<p>configurable設為false，屬性不可刪除。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,<span class="comment">//</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> obj.<span class="property">name</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">// Apple，name屬性未被刪除</span></span><br></pre></td></tr></table></figure>

<p>configurable設為true，屬性可被刪除。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> obj.<span class="property">name</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">//undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj);<span class="comment">//&#123;&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="Enumerable"><a href="#Enumerable" class="headerlink" title="Enumerable"></a>Enumerable</h5><p>特徵是否為「可列舉的」，例如：此物件的特性是否可在for…in中被列舉，若設定enumerable為false表示不會被列舉出來。</p>
<p>如下（1）印出hello和name，（2）由於name被設定為不可列舉的，因此只會印出hello。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line">obj.<span class="property">hello</span> = <span class="string">&#x27;world&#x27;</span>;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(prop);<span class="comment">//（1）</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//hello</span></span><br><span class="line"><span class="comment">//name</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(prop);<span class="comment">//（2）</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//hello</span></span><br></pre></td></tr></table></figure>

<p>題外話，會用到 defineProperty 這個東西是為了寫雙向綁定的小工具而追 Vue.js 的原始碼的時候玩到的，推薦閱讀<a href="https://github.com/DMQ/mvvm">這篇</a>文章。</p>
<h4 id="不可變性（Immutability）"><a href="#不可變性（Immutability）" class="headerlink" title="不可變性（Immutability）"></a>不可變性（Immutability）</h4><p>如何實作無法被變更的特性或物件？以下會介紹幾種作法，但都只能做到淺層的不可變性（shallow immutablility），意即若此物件有指向其他物件的參考，這個被指到的物件的內容就仍是可變的。</p>
<p>如下，假設foo是不可變的，但foo.list指向一個陣列，這個陣列的內容是可變的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = &#123;&#125;;</span><br><span class="line">foo.<span class="property">list</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">foo.<span class="property">list</span>.<span class="title function_">push</span>(<span class="number">4</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(foo.<span class="property">list</span>);<span class="comment">// [ 1, 2, 3, 4 ]</span></span><br></pre></td></tr></table></figure>

<h4 id="物件常數（Object-Constant）"><a href="#物件常數（Object-Constant）" class="headerlink" title="物件常數（Object Constant）"></a>物件常數（Object Constant）</h4><p>使用defineProperty設定writable為false且configurable為false，即可建立一個特性等同於常數的物件屬性，無法被更新、重新定義和刪除。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;CONST_PI&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="number">3.14</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">CONST_PI</span>);<span class="comment">// 3.14</span></span><br></pre></td></tr></table></figure>

<h4 id="避免擴充（Prevent-Extensions）"><a href="#避免擴充（Prevent-Extensions）" class="headerlink" title="避免擴充（Prevent Extensions）"></a>避免擴充（Prevent Extensions）</h4><p>使用<code>Object.preventExtensions</code>防止物件被加入新屬性。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">preventExtensions</span>(obj);</span><br><span class="line">obj.<span class="property">hello</span> = <span class="string">&#x27;world&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">hello</span>);<span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>

<p>備註，在嚴格模式下，加入新屬性會丟出TypeError。</p>
<h4 id="密封（Seal）"><a href="#密封（Seal）" class="headerlink" title="密封（Seal）"></a>密封（Seal）</h4><p>使用<code>Objet.seal</code>來達到密封的作用，意即物件不可再新增屬性、重新配置特徵或刪除屬性，但可能可以修改屬性值。</p>
<p><code>Object.seal</code>會做兩件事</p>
<ul>
<li><p>將物件設定為<code>Object.preventExtensions</code>防止物件被加入新屬性。</p>
</li>
<li><p>將物件的屬性特性configurable設定為fals，物件的屬性不能被刪除，其特徵的值不能被更新。屬性值是否可被更新要看writable的值而定，若writable為true則可更新，若為false則不可更新。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">seal</span>(obj);</span><br><span class="line"><span class="comment">//嘗試加入新的屬性 hello</span></span><br><span class="line">obj.<span class="property">hello</span> = <span class="string">&#x27;world&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">hello</span>);<span class="comment">//undefined</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//嘗試刪除屬性name</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">delete</span> obj.<span class="property">name</span>); <span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">//Jack</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//嘗試重新設定特徵值</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="number">3.14</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// TypeError</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="凍結（Freeze）"><a href="#凍結（Freeze）" class="headerlink" title="凍結（Freeze）"></a>凍結（Freeze）</h4><p>使用<code>Object.freeze</code>建立一個已凍結的物件，意即這個物件不能新增屬性、更新屬性的值，刪除屬性和重新配置特徵值。</p>
<p><code>Object.freeze</code>會做以下的事情</p>
<ul>
<li>對物件呼叫<code>Object.seal</code>，讓物件不可再新增屬性、重新配置特徵或刪除屬性。</li>
<li>將物件的屬性時性writable設定為false，物件屬性的值不可被更改。</li>
</ul>
<p>回顧前面提到的，以上四種解法都只能做到淺層的不可變性（shallow immutability），因此若希望能將整個物件（包含屬性參考的物件）都凍結，可遞迴呼叫<code>Object.freeze</code>，但可能有副作用，像是凍結了共用的物件。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [<span class="string">&#x27;apple&#x27;</span>, <span class="string">&#x27;grape&#x27;</span>];</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">favFruits</span>: list,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> anotherObj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">favFruits</span>: list,</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">freeze</span>(obj);</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">freeze</span>(obj.<span class="property">favFruits</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//共用的物件被凍結！</span></span><br><span class="line">list.<span class="title function_">push</span>(<span class="string">&#x27;orange&#x27;</span>);<span class="comment">//Uncaught TypeError: Cannot add property 2, object is not extensible</span></span><br></pre></td></tr></table></figure>

<h4 id="Get"><a href="#Get" class="headerlink" title="[[Get]]"></a><code>[[Get]]</code></h4><p><code>[[Get]]</code>的功用是取得屬性值，例如：<code>obj.a</code>時會呼叫<code>[[Get]]()</code>這個函式呼叫，它會先在此物件內尋找是否有符合名稱的屬性，若無就順著原型串鏈繼續尋找，如果都沒有找偌，<code>[[Get]]</code>就會回傳undefined。注意，這和之前提到的在語彙範疇中查找變數（的名稱是否被定義）是不同的，若在語彙範疇中找到該變數，會丟出ReferrenceError。</p>
<h4 id="Put"><a href="#Put" class="headerlink" title="[[Put]]"></a><code>[[Put]]</code></h4><p><code>[[Put]]</code>的功用是…</p>
<p>若此屬性不存在，則新增此屬性並設定其值。但若此屬性存在，則做以下的事情…</p>
<ul>
<li><p>若此屬性是存取器描述器的取值器與設值器嗎？若是，則呼叫其設值器（setter）。</p>
</li>
<li><p>若此屬性是不可寫入的，在非嚴格模式下會無聲的失敗，但在嚴格模式下會丟出TypeError。</p>
</li>
<li><p>若屬性是可寫入的，就將值設定給這個屬性。</p>
<p>備註：上面提到的兩個名詞，這裡來做解釋…</p>
</li>
<li><p>資料描述器（data descriptor）：定義一個屬性時，此屬性不含取值器或設值器。</p>
</li>
<li><p>存取描述器（access descriptor）:存取器描述器是指當定義一個屬性時，若此屬性擁有取值器或設值器，這個定義就會成為存取器描述器。注意，此時屬性的value和特徵writable都會被忽略，而只需考慮set、get、configurable和enumerable。</p>
</li>
</ul>
<h4 id="取值器-Getter-與設值器（Setter）"><a href="#取值器-Getter-與設值器（Setter）" class="headerlink" title="取值器(Getter)與設值器（Setter）"></a>取值器(Getter)與設值器（Setter）</h4><p>物件預設的<code>[[Get]]</code>與<code>[[Put]]</code>掌控了屬性的建立、設定和更新、取得值的方式。若要複寫這兩種預設<code>[[Get]]</code>與<code>[[Put]]</code>行為，可透過取值器與設值器來達成。</p>
<p>方法一，使用物件字面值的方式定義屬性。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">name</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_name_</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span> <span class="title function_">name</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_name_</span> = <span class="string">`Hi, I am <span class="subst">$&#123;val&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">obj.<span class="property">name</span> = <span class="string">&#x27;Jack&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">//Hi, I am Jack</span></span><br></pre></td></tr></table></figure>

<p>方法二，使用defineProperty的方式定義屬性。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span> <span class="title function_">name</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_name_</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">set</span>: <span class="keyword">function</span> <span class="title function_">name</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_name_</span> = <span class="string">`Hi, I am <span class="subst">$&#123;val&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">obj.<span class="property">name</span> = <span class="string">&#x27;Jack&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">//Hi, I am Jack</span></span><br></pre></td></tr></table></figure>

<h4 id="存在（Existence）"><a href="#存在（Existence）" class="headerlink" title="存在（Existence）"></a>存在（Existence）</h4><p>既然屬性不存在的時候，會回傳undefined，但若屬性值原本就設定為undefined是不是就為法判定這個屬性到底存不存在了？</p>
<p>解法是使用hasOwnProperty，若想進一進確認該屬性是否可在其他物件中找偌，可搭配<code>prop in obj</code>檢查這個屬性是否存在於原型串鏈中。兩者差異是<code>prop in obj</code>會檢查原型串鏈，而hasOwnProperty只會檢查該物件。</p>
<p>範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> obj1 = &#123;</span><br><span class="line">    <span class="attr">job</span>: <span class="literal">undefined</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> obj = <span class="title class_">Object</span>.<span class="title function_">create</span>(obj1);<span class="comment">// 邁立 obj 與 obj1的連結</span></span><br><span class="line">obj.<span class="property">name</span> = <span class="literal">undefined</span>;</span><br></pre></td></tr></table></figure>

<p>屬性name其值雖然為undefined，但它直的存在於obj。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;name&#x27;</span>));<span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>屬性job真的存在於obj嗎？</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">job</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;job&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;job&#x27;</span> <span class="keyword">in</span> obj);<span class="comment">// true,但在原型串鏈中可找到</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj1.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;job&#x27;</span>));<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>屬性job其值雖然為undefined且不存在於obj中，但可在原型串鏈中可找偌，因此進一𦂇檢視obj1，確定為obj1的屬性。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">hello</span>);<span class="comment">//undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;hello&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello&#x27;</span> <span class="keyword">in</span> obj);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>雖然hello的值是undefined，似乎與前面的例子無異，但使用hadOwnProperty檢視，發現在在obj物件中，且經由<code>prop in obj</code>確認後發現也無法在原型串鏈中找到，因此屬性不存在。</p>
<p>總結…</p>
<ul>
<li>hasOwnProperty可檢測這個屬性是否存在於某個物件。</li>
<li><code>prop in obj</code>可檢查這個屬性是否可在原型串鏈中找到，讓我們能確認是否需要再往其他物件查找。</li>
</ul>
<h4 id="列舉（Enumeration）"><a href="#列舉（Enumeration）" class="headerlink" title="列舉（Enumeration）"></a>列舉（Enumeration）</h4><p>檢視屬性是否可被列舉的方法。</p>
<h5 id="in"><a href="#in" class="headerlink" title="in"></a>in</h5><p>in運算子只會帶出可列舉的屬性。</p>
<p>例如，obj有兩個屬性name和hello，其中name為可列舉的，hello為不可列舉的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;hello&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;world&#x27;</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(k, obj[k]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//name Jack</span></span><br></pre></td></tr></table></figure>

<h5 id="propertyIsEnumerable-NaN"><a href="#propertyIsEnumerable-NaN" class="headerlink" title="propertyIsEnumerable"></a>propertyIsEnumerable</h5><p>propertyIsEnumerable檢視屬性是否可被列舉。</p>
<p>例如，obj有兩個屬性name和hello，其中name為可列舉的，hello為不可列舉的。檢視name是否為可列舉的，會回傳true。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="title function_">propertyIsEnumerable</span>(<span class="string">&#x27;name&#x27;</span>));<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<h5 id="Object-keysvsObject-getOwnPropertyNames"><a href="#Object-keysvsObject-getOwnPropertyNames" class="headerlink" title="Object.keysvsObject.getOwnPropertyNames"></a><code>Object.keys</code>vs<code>Object.getOwnPropertyNames</code></h5><p><code>Object.keys</code>與<code>Object.getOwnPropertyNames</code>都只回傳此物件的屬性，且皆不檢視原型串鏈，兩者差異在於</p>
<ul>
<li><code>Object.keys</code>:回傳所有可列舉的屬性。</li>
<li><code>Object.getOwnPropertyNames</code>:回傳所有屬性，不管是否可被列舉。</li>
</ul>
<p>例如，obj有兩個屬性name和hello，其中name為可列舉的，hello為不可列舉的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">keys</span>(obj));<span class="comment">//[ &#x27;name&#x27; ]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getOwnPropertyNames</span>(obj));<span class="comment">//[ &#x27;name&#x27;, &#x27;hello&#x27; ]</span></span><br></pre></td></tr></table></figure>

<h4 id="迭代（Iteration）"><a href="#迭代（Iteration）" class="headerlink" title="迭代（Iteration）"></a>迭代（Iteration）</h4><p>迭代出陣列的值的方法。</p>
<h5 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a>forEach</h5><p>迭代陣列中所有的值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [<span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;Cathy&#x27;</span>, <span class="string">&#x27;Doll&#x27;</span>];</span><br><span class="line">list.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index, array</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item, index, array);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//Apple 0 [ &#x27;Apple&#x27;, &#x27;Bob&#x27;, &#x27;Cathy&#x27;, &#x27;Doll&#x27; ]</span></span><br><span class="line"><span class="comment">//Bob 1 [ &#x27;Apple&#x27;, &#x27;Bob&#x27;, &#x27;Cathy&#x27;, &#x27;Doll&#x27; ] </span></span><br><span class="line"><span class="comment">//Cathy 2 [ &#x27;Apple&#x27;, &#x27;Bob&#x27;, &#x27;Cathy&#x27;, &#x27;Doll&#x27; ] </span></span><br><span class="line"><span class="comment">//Doll 3 [ &#x27;Apple&#x27;, &#x27;Bob&#x27;, &#x27;Cathy&#x27;, &#x27;Doll&#x27; ]</span></span><br></pre></td></tr></table></figure>

<h5 id="every"><a href="#every" class="headerlink" title="every"></a>every</h5><p>檢查陣列中的每個值是否符條件，若是則回傳true。持續進行直到結束，或callback中回傳false就停止迭代。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;apple&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">20</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;corn&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">100</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;grape&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">50</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;pieapple&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">80</span>,</span><br><span class="line">    &#125;</span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> result = list.<span class="title function_">every</span>(<span class="function">(<span class="params">item, index, array</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item, index, array);</span><br><span class="line">    <span class="keyword">return</span> item.<span class="property">cout</span> &gt; <span class="number">50</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`result: <span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line"><span class="comment">//&#123; name: &#x27;apple&#x27;, count: 20 &#125; 0 [ &#123; name: &#x27;apple&#x27;, count: 20 &#125;,   &#123; name: &#x27;corn&#x27;, count: 100 &#125;,   &#123; name: &#x27;grape&#x27;, count: 50 &#125;,   &#123; name: &#x27;pieapple&#x27;, count: 80 &#125; ]</span></span><br><span class="line"><span class="comment">//result: false</span></span><br></pre></td></tr></table></figure>

<h5 id="some"><a href="#some" class="headerlink" title="some"></a>some</h5><p>檢查陣列中的是否有值符合條件，若是則回傳true。持續進行直到結束，或callback中回傳true就停止迭代。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;apple&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">20</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;corn&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">100</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;grape&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">50</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;pieapple&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">80</span>,</span><br><span class="line">    &#125;</span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> result = list.<span class="title function_">some</span>(<span class="function">(<span class="params">item, index, array</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item, index, array);</span><br><span class="line">    <span class="keyword">return</span> item.<span class="property">count</span> &gt; <span class="number">50</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`result: <span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line"><span class="comment">//&#123; name: &#x27;apple&#x27;, count: 20 &#125; 0</span></span><br><span class="line"><span class="comment">//&#123; name: &#x27;corn&#x27;, count: 100 &#125; 1</span></span><br><span class="line"><span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>若想看更多陣列處理方法，可參考<a href="https://wcc723.github.io/javascript/2017/06/29/es6-native-array/">這裡</a></p>
<h5 id="for-of"><a href="#for-of" class="headerlink" title="for...of"></a><code>for...of</code></h5><p>使用ES6的<code>for...of</code>迭代陣列。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> v <span class="keyword">of</span> array) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<h4 id="回顧-9"><a href="#回顧-9" class="headerlink" title="回顧"></a>回顧</h4><p>看完這篇文章，我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>建立物件有兩種方式-宣告式與建構形式，前都較常用，而後者有一些雷區，非必要不建議使用。</li>
<li>typeof可檢查資料型別； 當使用建構式建立字串、布林或數字等值時，建立的其實不是基本型別而是物件，因此可用instanceof來檢查是由哪個建構式建立的，也可檢視該物件是屬於哪個子型別。</li>
<li>物件的內容是由屬性組成的，而屬性是由key-value pari構成，value可為任意資料型別的值，並且值是以參考的方式儲存。</li>
<li>物件的屬性若包含特殊字符為動態產生的字串，則必須使用鍵值<code>[]</code>的方法存取。</li>
<li>複製物件的方法分為淺拷貝與深拷貝兩種，<code>Object.assign</code>只能處理一層內的深拷貝，而直正的深貝通常是由JSON-safe的物件先經由序列化為JSON字串後再剖析回物件來達成。</li>
<li>屬性描述器可用來檢視屬性的特徵，例如：是否可寫入、是否可配置、是否可列舉。</li>
<li>實作不可變的物件的方法，例如：設定屬性描述器、避免擴充、密封、凍結。</li>
<li>物件預設的<code>[[Get]]</code>與<code>[[Put]]</code>掌控了屬性的建立、設定和更新、取得值的方式，若要複寫這兩種預設<code>[[Get]]</code>與<code>[[Put]]</code>行為，可透過取值器與設值器來達成。</li>
<li>hasOwnProperty與<code>prop in obj</code>可判斷屬性是否存在。</li>
<li>判斷屬性是否可列舉的方法-in運算子帶出此物件可列舉的屬性、propertyIsEnumerable檢視屬性是否可被列舉、<code>Object.keys</code>與<code>Object.getOwnPropertyNames</code>都只回傳此物件的屬性，差異在於前都只列出可列舉的屬性，而後者會列出所有此物件的屬性。</li>
<li>迭代出陣列中的值的方法，例如：forEach、every、some、<code>for...of</code>。</li>
</ul>
<h5 id="References-7"><a href="#References-7" class="headerlink" title="References"></a>References</h5><p><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/this%20%26%20object%20prototypes/ch3.md">You Don’t Know JS: this &amp; Object Prototypes, Chapter 3: Objects</a></p>
<h3 id="你懂JavaScript嗎？（簡易版）物件導向概念"><a href="#你懂JavaScript嗎？（簡易版）物件導向概念" class="headerlink" title="你懂JavaScript嗎？（簡易版）物件導向概念"></a>你懂JavaScript嗎？（簡易版）物件導向概念</h3><p>本文主要會談到簡單的物件導向概念，作為後續「原型」（Prototypes）的暖身。</p>
<h4 id="類別（Class）、邁構子（Constructor）、實體（Instance）"><a href="#類別（Class）、邁構子（Constructor）、實體（Instance）" class="headerlink" title="類別（Class）、邁構子（Constructor）、實體（Instance）"></a>類別（Class）、邁構子（Constructor）、實體（Instance）</h4><p>「類別」可想像成是建構某特定物體的藍圖或模具，而「實體」就是按照這藍圖或模具製造出來的成品。這當中需要使用類別的一個特殊方法「建構子」來做初始化的動作。</p>
<p>虛擬碼如下，Person是一個類別，利用與類別同名的建構子Person做初始化，進而建立出實體Jack。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Persion</span> &#123;</span><br><span class="line">    career = <span class="literal">null</span>;</span><br><span class="line">    <span class="title class_">Persion</span>(job) &#123;</span><br><span class="line">        career = job;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">sayHi</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">print</span>(<span class="string">&#x27;Hello, I am a/n &#x27;</span>, <span class="variable language_">this</span>.<span class="property">career</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Jack</span> = <span class="keyword">new</span> <span class="title class_">Persion</span>(<span class="string">&#x27;engineer&#x27;</span>);</span><br><span class="line"><span class="title class_">Jack</span>.<span class="title function_">sayHi</span>();</span><br></pre></td></tr></table></figure>

<p>在真實的世界裡，JavaScript用什麼方式呈現呢？舉個最簡單的例子。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="property">length</span>);<span class="comment">//11</span></span><br></pre></td></tr></table></figure>

<p>String是個類別方法，在這裡當建構子用，任何給定的字串都是這個類別的實體，它幫我們包裝了可在這個字串上執行的各種功能。因此，str是String的實體，可執行<code>str.length</code>取得字串長度。</p>
<p>不過，在JavaScript的世界中，並沒有真正的類別的概念，只能使用設計模式（design pattern）來模擬，我們在稍後的原型中會看到各種解法與優劣討論。</p>
<h4 id="繼承（Inheritance）"><a href="#繼承（Inheritance）" class="headerlink" title="繼承（Inheritance）"></a>繼承（Inheritance）</h4><p>定義一個類別，其特性繼承（也可說是擴充extend）自另外一個類別，稱它們為「父類別」與「子類別」，其中，子類別繼承父類別的特性。</p>
<p>如下，CoolPersion繼承自Person，其中sayHi繼承了來自Person的方法並做覆寫。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Persion</span> &#123;</span><br><span class="line">  career = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Persion</span>(job) &#123;</span><br><span class="line">    career = job;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">sayHi</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">pring</span>(<span class="string">&#x27;Hello, I am a/n&#x27;</span>, career);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoolPerson</span> inherits <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="title function_">sayHi</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="attr">inherited</span>: <span class="title function_">sayHi</span>();</span><br><span class="line">    <span class="title function_">pring</span>(<span class="string">&#x27;I love my job!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">eat</span>(<span class="params">food</span>) &#123;</span><br><span class="line">    <span class="title function_">pring</span>(<span class="string">&#x27;I am eating...&#x27;</span>, food);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>「多重繼承」（multiple inheritance）是指子類別可繼承一個以上的父類別，但由於JavaScript並沒有提供原生機制來處理這重情況，因此不做討論。</p>
<h4 id="多型（Polymorphism）"><a href="#多型（Polymorphism）" class="headerlink" title="多型（Polymorphism）"></a>多型（Polymorphism）</h4><p>「多型」是指子類別除了擁有自己的方法外，這個方法還能覆寫來特化父類別的同名方法，以賦予其更特殊的行為，</p>
<p>如上，CoolPersion的sayHi與其父類別Persion的sayHi同名，它使用<code>inherited:sayHi()</code>參考它所繼承且未被覆寫的父類別同名方法並作呼叫，接著加上<code>pring(&#39;I love my job!&#39;)</code>這個屬於它自已的功能。其中，不指定參考哪一層父類別（可能是袓父類別XD）的方式稱為「相對多型」，而若有指名是哪層父類別的方法，那就是「絕對多型」了。</p>
<h4 id="回顧-10"><a href="#回顧-10" class="headerlink" title="回顧"></a>回顧</h4><p>看完這篇文章，我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>「類別」可想像成是建構某特定物體的藍圖或模具，而「實體」就是按照這監圖或模具製造出來的成品，並使用「建構子」來建立和初始化實體。</li>
<li>定義一個類別，其特性繼承於另外一個類別，稱它們為「父類別」與「子類別」，而子類別「繼承」了父類別的特性。</li>
<li>「多型」是指子類別除了擁有自已的方法外，這個方法還能覆寫來特化父類別的同名方法，以賦予其更特殊的行為。</li>
</ul>
<h5 id="References-8"><a href="#References-8" class="headerlink" title="References"></a>References</h5><p>[You Don’t Know JS: this &amp; Object Prototypes, Chapter 4: Mixing (Up) “Class” Objects](<a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/this">https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/this</a> %26 object prototypes&#x2F;ch4.md)</p>
<h3 id="你懂JavaScript？原型（Prototype）"><a href="#你懂JavaScript？原型（Prototype）" class="headerlink" title="你懂JavaScript？原型（Prototype）"></a>你懂JavaScript？原型（Prototype）</h3><p>本文主要會談到</p>
<ul>
<li>類別、建構子與實體</li>
<li>什麼是原型串鏈？原型串鏈的功用是？</li>
<li>什麼是原型式繼承？</li>
<li>疑難雜症大解惑-如何分辨屬性是位於該物件或原型串鏈上的？如何分辨誰是誰的實體？誰是誰的建搆子？原型串鏈有終點嗎？如何建立兩物件的連結？物件屬性的設定與遮蔽規則有哪些？</li>
</ul>
<h4 id="前言-3"><a href="#前言-3" class="headerlink" title="前言"></a>前言</h4><p>JavaScript並不像Java、C++這些知名的物件導向語言具有「類別」（class）來區分概念與實體（instance）或天生具有繼承的能力，而只有「物件」，因此只能利用設計模式來模擬這些功能。本文就來探討在JavaScript世界中，到底是㤰麼實現物件導向的概念的？</p>
<p>首先要有個模子，我們稱它為類別，而當前面有new的時候，可看成是建構子（constructor），接著用這個建構子做初始化，進而建立（new）實體。</p>
<p>如下，建構子Book產出實體ydkjs_1和ydkjs_2</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Book</span>(<span class="params">name, pNum</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name; <span class="comment">//書名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pNum</span> = pNum; <span class="comment">//頁數</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">setComments</span> = <span class="keyword">function</span> (<span class="params">comment</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">comment</span> = comment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ydkhs_1 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;導讀，型別與文法&#x27;</span>, <span class="number">257</span>);</span><br><span class="line"><span class="keyword">var</span> ydkhs_2 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;範疇與閉包 / this 與物件原型&#x27;</span>, <span class="number">251</span>);</span><br><span class="line"></span><br><span class="line">ydkhs_1.<span class="title function_">setComments</span>(<span class="string">&#x27;好書！&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkhs_1.<span class="property">comment</span>);<span class="comment">//好書！</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkhs_1.<span class="property">setComments</span> === ydkhs_2.<span class="property">setComments</span>);<span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>共用的屬性或方法，不用每次都幫實體建立一份，提出來放到prototype即可。承上，將setComments這個共用的方法放到<code>Book.prototype</code>，暫且稱它為Book原型。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Book</span>(<span class="params">name, pNum</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name; <span class="comment">//書名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pNum</span> = pNum; <span class="comment">//頁數</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = <span class="literal">null</span>;<span class="comment">//評等</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setComments</span> = <span class="keyword">function</span> (<span class="params">comment</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = comment;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ydkhs_1 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;導讀，型別與文法&#x27;</span>, <span class="number">257</span>);</span><br><span class="line"><span class="keyword">var</span> ydkhs_2 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;範疇與閉包 / this 與物件原型&#x27;</span>, <span class="number">251</span>);</span><br><span class="line"></span><br><span class="line">ydkhs_1.<span class="title function_">setComments</span>(<span class="string">&#x27;好書！&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkhs_1.<span class="property">comment</span>);<span class="comment">//好書！</span></span><br><span class="line"></span><br><span class="line">ydkhs_2.<span class="title function_">setComments</span>(<span class="string">&#x27;超好書！&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkhs_2.<span class="property">comment</span>);<span class="comment">//超好書！</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkhs_1.<span class="property">setComments</span> === ydkhs_2.<span class="property">setComments</span>);<span class="comment">// true，確認是同一個函式</span></span><br></pre></td></tr></table></figure>

<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><h5 id="請勿修改原生原型"><a href="#請勿修改原生原型" class="headerlink" title="請勿修改原生原型"></a>請勿修改原生原型</h5><p>在這裡都是在設定自已建立的物件的原型！不要嘗試修改預設的原生原型（例如：<code>String.prototype</code>），也不要無條件地擴充原生原型，若要擴充也應該撰寫符合規格的測試程式，另外不要使用原生原型當成變數的初始值，以避免無意間的修改。</p>
<h5 id="關於建構子…"><a href="#關於建構子…" class="headerlink" title="關於建構子…"></a>關於建構子…</h5><ul>
<li><p>在JavaScript中，除了沒有類別外，其實也沒有建構子，因此</p>
<ul>
<li>只要函式前有new，這個函式就是建構子。</li>
<li>只要函式前有new來個呼叫，就叫做建構子呼叫。</li>
</ul>
</li>
<li><p>new關鍵字要做哪些事情呢？它的工作就是</p>
<ol>
<li>建立一個新的物件。</li>
<li>將物件的<code>.__proto__</code>指向建構子的prototype，形成原型串鏈。</li>
<li>將建構子的this指向new出來的新物件。</li>
<li>回傳這個物件。</li>
</ol>
</li>
</ul>
<h4 id="原型串鏈（Prototype-Chain）"><a href="#原型串鏈（Prototype-Chain）" class="headerlink" title="原型串鏈（Prototype Chain）"></a>原型串鏈（Prototype Chain）</h4><p>在前面[巢狀範疇](# 巢狀範疇（Nested Scope）)的部份提到「若在目前執行的範疇找不到這個變數的時候，就往外層的範疇搜尋，持續搜尋直到找到為止，或直到最外層的全域範疇」，同理， 當查找物件的屬性或方法時，若在本身這個物件找不到的時候，就會往更上一層物件尋找，直到串鏈尾端<code>Object.prototype</code>，若無法找到就回傳undefined，而這個尋找的脈絡就是依循著<code>.__proto__</code>這個原型串鏈（prototype chain）來找–每個物件在建立之初都會個<code>.__proto__</code>（dunder proto）內部屬性，它可用存取另一個相連物件內部屬性<code>[[prototype]]</code>的值，而<code>[[prototype]]</code>存放其建構子原型的位置。</p>
<p>如下範例，<code>ydkjs_1.__proto__</code>所存的參考即指向<code>Book.prototype</code>的位置。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Book</span>(<span class="params">name, pNum</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name; <span class="comment">//書名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pNum</span> = pNum; <span class="comment">//頁數</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = <span class="literal">null</span>;<span class="comment">//評等</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setComments</span> = <span class="keyword">function</span> (<span class="params">comment</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = comment;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ydkjs_1 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;導讀，型別與文法&#x27;</span>, <span class="number">257</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1.<span class="property">__proto__</span> === <span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>模型圖。</p>
<img src="ydkjs-book-prototype.png" style="zoom:85%;" />

<p>由於在ydkjs_1是找不到方法setComments的，因此就會循著<code>.__proto__</code>找到Book.prototype而找到方法setComments，也因為原型串鏈，讓JavaScript可達到類似其他物件導向語言般的使用類別、繼承的功能。</p>
<p>備註，使用<code>.__proto__</code>來取得<code>[[Prototype]]</code>似乎太暴力了（畢竟人家是內部屬性嘛），還是改用<code>Object.getPrototypeOf(..)</code>來得優雅，其中<code>Object.getPrototypeOf(..)</code>會回傳<code>.__proto__</code>的值。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1.<span class="property">__proto__</span> === <span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(ydkjs_1) === <span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>接著來看幾個疑難雜症。</p>
<h5 id="Q1：到底是誰的屬性？"><a href="#Q1：到底是誰的屬性？" class="headerlink" title="Q1：到底是誰的屬性？"></a>Q1：到底是誰的屬性？</h5><p>可用<code>hasOwnProperty</code>檢查屬性是屬於當前物件，還是位於原型串錄中。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;name&#x27;</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;setComments&#x27;</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>name的確是存在於物件ydkjs_1中的，而setComments並不在物件ydkjs_1中，是在原型串鏈中。</p>
<p>注意</p>
<ul>
<li>hasOwnProperty只會檢查該物件，而不會檢查整條原型串鏈。</li>
<li>for loop <code>prop in obj</code>會檢查整個原型串鏈且為可列舉的屬性。</li>
<li><code>prop in obj</code>會檢查整個原型串鏈，不管屬性是否可列舉。</li>
</ul>
<p>範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Book</span>(<span class="params">name, pNum</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name; <span class="comment">//書名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pNum</span> = pNum; <span class="comment">//頁數</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = <span class="literal">null</span>;<span class="comment">//評等</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setComments</span> = <span class="keyword">function</span> (<span class="params">comment</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = comment;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ydkjs_1 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;導讀，型別與文法&#x27;</span>, <span class="number">257</span>);</span><br><span class="line"><span class="keyword">var</span> ydkjs_2 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;範疇與閉包 / this 與物件原型&#x27;</span>, <span class="number">251</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(ydkjs_1, <span class="string">&#x27;hello&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;world&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">false</span>,<span class="comment">//設定 hello 為不可列舉的屬性</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>由於for loop <code>prop in obj</code>會檢查整個原型串鏈且為可列舉的屬性，因此除了hello之外，其它的屬性都會被列出來。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> prop <span class="keyword">in</span> ydkjs_1) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(prop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果得到</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//name</span></span><br><span class="line"><span class="comment">//pNum </span></span><br><span class="line"><span class="comment">//comment </span></span><br><span class="line"><span class="comment">//setComments </span></span><br></pre></td></tr></table></figure>

<p>承上，<code>prop in obj</code>會檢查整個原型串鏈，不管屬性是否可列舉。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello&#x27;</span> <span class="keyword">in</span> ydkjs_1);<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;name&#x27;</span> <span class="keyword">in</span> ydkjs_1);<span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h5 id="Q2：到底是誰的實體？"><a href="#Q2：到底是誰的實體？" class="headerlink" title="Q2：到底是誰的實體？"></a>Q2：到底是誰的實體？</h5><p><code>instanceof</code>檢查物件是否為指定的建構子所建立的實體，位於<code>instanceof</code>左邊的運算元是物件，右邊的是函式，若左邊的物件是由右邊函式所產生的，則會回傳true，否則為false。<code>instanceof</code>可檢查整修原型串鏈的繼承世系，這在傳統的物件導向環境中稱為「內省」（introspection）或「反思」（reflection）。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Book</span>(<span class="params">name, pNum</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name; <span class="comment">//書名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pNum</span> = pNum; <span class="comment">//頁數</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = <span class="literal">null</span>;<span class="comment">//評等</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setComments</span> = <span class="keyword">function</span> (<span class="params">comment</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = comment;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ydkjs_1 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;導讀，型別與文法&#x27;</span>, <span class="number">257</span>);</span><br><span class="line"><span class="keyword">var</span> ydkjs_2 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;範疇與閉包 / this 與物件原型&#x27;</span>, <span class="number">251</span>);</span><br></pre></td></tr></table></figure>

<p>ydkjs_1與ydkjs_2都是由Book建立出來的實體，而Book也是由Object與Function建立出來的。因此都會得到true，最後舉個反例，window不是由Book建立出來的，因此得到false。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1 <span class="keyword">instanceof</span> <span class="title class_">Book</span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_2 <span class="keyword">instanceof</span> <span class="title class_">Book</span>);<span class="comment">//true</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1 <span class="keyword">instanceof</span> <span class="title class_">Object</span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1 <span class="keyword">instanceof</span> <span class="title class_">Function</span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_2 <span class="keyword">instanceof</span> <span class="title class_">Object</span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_2 <span class="keyword">instanceof</span> <span class="title class_">Function</span>);<span class="comment">//true</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">window</span> <span class="keyword">instanceof</span> <span class="title class_">Book</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">window</span> <span class="keyword">instanceof</span> <span class="variable language_">window</span>);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>另外一個方法是使用<code>isPrototypeOf</code>，它可檢視運算子左邊的物件是否出現於右邊物件的原型串鏈中。與<code>instanceof</code>不同之處只在於運算元的資料型別不同而已，但功能是相同的。</p>
<p>再看一次這個相似的範例，Novel繼承了Book，並建立實體novel。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Book</span>(<span class="params">name, pNum</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name; <span class="comment">//書名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pNum</span> = pNum; <span class="comment">//頁數</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = <span class="literal">null</span>;<span class="comment">//評等</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setComments</span> = <span class="keyword">function</span> (<span class="params">comment</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = comment;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Novel</span>(<span class="params">name, pNum, price</span>) &#123;</span><br><span class="line">    <span class="title class_">Book</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, [name, pNum]);<span class="comment">//Novel 繼承 Book</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">price</span> = price;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Novel</span>.<span class="property"><span class="keyword">prototype</span></span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Novel</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">printPrice</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> is <span class="subst">$&#123;<span class="variable language_">this</span>.price&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ydkjs_1 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;導讀，型別與文法&#x27;</span>, <span class="number">257</span>);</span><br><span class="line"><span class="keyword">var</span> ydkjs_2 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;範疇與閉包 / this 與物件原型&#x27;</span>, <span class="number">251</span>);</span><br><span class="line"><span class="keyword">var</span> novel = <span class="keyword">new</span> <span class="title class_">Novel</span>(<span class="string">&#x27;最近沒在看小說 &gt;&lt;&#x27;</span>, <span class="number">500</span>, <span class="number">600</span>);</span><br></pre></td></tr></table></figure>

<p>我們來檢視幾個問題…</p>
<ul>
<li>在ydkjs_1的整個原型串鏈中，是否出現過Book.prototype？</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="title function_">isPrototypeOf</span>(ydkjs_1));<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在novel的整個原型串鏈中，是否出現過Book.prototype？</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="title function_">isPrototypeOf</span>(novel));<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在ydkjs_1的整個原型串鏈中，是否出現過Novel.prototype？</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Novel</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="title function_">isPrototypeOf</span>(ydkjs_1));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在novel的整個原型串鏈中，是否出現過Novel.prototype？</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Novel</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="title function_">isPrototypeOf</span>(novel));<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>看模型圖會更清楚</p>
<img src="prototype_example.png" style="zoom:85%;" />

<p>注意，這裡的繼承是指原型式繼承（prototypal inheritance）。</p>
<p>「原型式繼承」是指使用連結相連兩個物件而能共用屬性的方式，又稱為「差異式繼承」（differential inheritance），它模仿了傳統物件導向語言的類別方法，而達到繼承的功能。</p>
<p>說明</p>
<ul>
<li><code>Novel.prototype = Object.Create(Book.prototype);</code>的<code>Object.create</code>建立了一個新物件（稱呼它為O），並將<code>O.__proto__</code>設定為Book.prototype，因此我們可以想成藉由O這個橋樑，讓<code>Novel.prototype.constructor === Book</code>。</li>
<li>承上，也可改用ES6的<code>setPrototypeof</code>來設定<code>[[Prototype]]</code>內部屬性的值。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//pre-ES6</span></span><br><span class="line"><span class="comment">// throws away default existing `Novel.prototype`</span></span><br><span class="line">Novel.prototype = Object.create(Book.prototype);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ES6+</span></span><br><span class="line"><span class="comment">// modifies existing `Novel.prototype`</span></span><br><span class="line">Object.setPrototypeOf(Novel.prototype, Book.prototype);</span><br></pre></td></tr></table></figure>

<p><code>Object.getPrototypof</code>。</p>
<p>ydkjs_1的<code>[[Prototype]]</code>的值是？</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(ydkjs_1) === <span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>或等同直接使用<code>.__proto__</code>取得<code>[[Prototype]]</code>的值，也是可行的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1.<span class="property">__proto__</span> === <span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<h6 id="備註-1"><a href="#備註-1" class="headerlink" title="備註"></a>備註</h6><ul>
<li><p>雖然剛才說「<code>instanceof</code>檢查物件是否為指定的建構子所建立的實體」，但其實<code>instanceof</code>所檢視的是物件的內部屬性<code>[[Prototype]]</code>(或說是<code>__proto__</code>)所形成的整條原型串鏈中，是否能找到其建構子原型。例如：ydkjs_1與ydkjs_2的<code>__proto__</code>屬性是否為<code>Book.prototype</code>？（答案是肯定的）</p>
</li>
<li><p>Object與Functon互為彼此的實體，意即<code>Function.__proto__</code>指向<code>Object.prototype</code>，而<code>Object.__proto__</code>也指向<code>Function.prototype</code>。</p>
</li>
<li><p>在下一篇文章「行為委派」中，我們會將「繼承世系」改稱為「委派連結」（delegation link），這會比較符合JavaScript的現況。</p>
</li>
</ul>
<h5 id="Q3：原型串鏈的終點是？"><a href="#Q3：原型串鏈的終點是？" class="headerlink" title="Q3：原型串鏈的終點是？"></a>Q3：原型串鏈的終點是？</h5><p>承上範例，針對這整條原型串鏈，我們就拿它來檢看看…</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1.<span class="property">__proto__</span> === <span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Book</span>.<span class="property">__proto__</span> === <span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> === <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span>);<span class="comment">//null</span></span><br></pre></td></tr></table></figure>

<p>因此，Object.prototype物件就是整條串鏈的最頂端了。我們可想像成，在查找變數時，最後的終點就是全域範疇了。</p>
<p>Object.prototype這個物件含有很多常用的屬性和方法，例如：toString、valueOf等這也就是為什麼所有的物件都能使用這些功能的原因。</p>
<h5 id="Q4：屬性的設定與遮蔽"><a href="#Q4：屬性的設定與遮蔽" class="headerlink" title="Q4：屬性的設定與遮蔽"></a>Q4：屬性的設定與遮蔽</h5><p>查找物件的屬性或方法時要注意設定與遮蔽的問題。</p>
<p>我們可能遇過以下這種狀況…</p>
<p>物件obj有屬性counter作為計數器，而anotherObj無此屬性且原型串列的參考指向obj。可能是一時手誤吧，居然將<code>anotherObj.counter</code>當計數器做遞增，之後在程式某處分別印出<code>obj.count</code>與<code>anotherObj.count</code>，發現居然所存的值是不一樣的！這到底發生了什麼事呢？</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">counter</span>: <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> anotherObj = <span class="title class_">Object</span>.<span class="title function_">create</span>(obj);</span><br><span class="line">anotherObj.<span class="property">counter</span>++;<span class="comment">// 一時手誤，應改為obj.counter++</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">counter</span>);<span class="comment">//0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(anotherObj.<span class="property">counter</span>);<span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">obj.<span class="property">counter</span>++;</span><br><span class="line">anotherObj.<span class="property">counter</span>++;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">counter</span>);<span class="comment">//1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(anotherObj.<span class="property">counter</span>);<span class="comment">//2</span></span><br></pre></td></tr></table></figure>

<p>目前已知，anotherObj並無counter屬性，而counter屬性位於原型串鏈<code>[[Prototype]]</code>更上一層的obj之內。當使用指定運算子更新counter屬性值的時候，會依照以下規則來決定處理的方式</p>
<ol>
<li>此屬性可被寫入（writable為true），則anotherObj會新增此屬性，而產生遮蔽（shadowing）的效果。</li>
<li>此屬性不可被寫入（writable為false），則在嚴格模式下會被報錯，而在非嚴格模式下，會忽略這個設定&#x2F;更新。</li>
<li>此屬性有設定setter、因此會回傳setter所設定的預設值。</li>
</ol>
<p>在上面的這個例子中，是屬於狀況「1」，因此目前obj與anotherObj兩物件上都具有counter屬性了。解法是小心一點。不要再手誤了！</p>
<h5 id="Q5：一定要用「類別」的概念才能建立兩物件的連結嗎？"><a href="#Q5：一定要用「類別」的概念才能建立兩物件的連結嗎？" class="headerlink" title="Q5：一定要用「類別」的概念才能建立兩物件的連結嗎？"></a>Q5：一定要用「類別」的概念才能建立兩物件的連結嗎？</h5><p>答案是「不必」。</p>
<p><code>Object.create(..)</code>可將兩個物件連結起來，如下<code>Object.create(..)</code>可建立一個新物件coolPerson，連結到指定的物件person，意即設定<code>coolPerson.__proto__</code>指向person。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">sayHi</span>: <span class="keyword">function</span> (<span class="params">name</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> coolPerson = <span class="title class_">Object</span>.<span class="title function_">create</span>(person);<span class="comment">// coolPerson.__proto__ === person</span></span><br><span class="line">coolPerson.<span class="title function_">sayHi</span>(<span class="string">&#x27;Jack&#x27;</span>);<span class="comment">// Hi, I am Jack</span></span><br></pre></td></tr></table></figure>

<p>備註，若使用<code>Object.create(null)</code>建立一個空物件，那它就直的非常空，裡面不含依何屬性，因此也就沒有<code>.__proto__</code>或<code>.constructor</code>可用了，通常會單純當成存資料用的物件而已。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> empty = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line">empty;<span class="comment">//&#123;&#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(empty.<span class="property">__proto__</span>);<span class="comment">// undefined--很空，什麼都沒有</span></span><br></pre></td></tr></table></figure>

<h5 id="Q6-連結作為備援之用？"><a href="#Q6-連結作為備援之用？" class="headerlink" title="Q6:連結作為備援之用？"></a>Q6:連結作為備援之用？</h5><p>原型串鏈的功用只是當備援(fallback)之？用意即，當查找的屬性無法在當前物件找到時，就往更上一層的物件尋找。</p>
<p>但其實沒這麼簡單，我們在下一篇文章「行為委派」會看到它的強大之處，例如，讓物件建立平等的委派關係以取得屬性和方法，實作更簡單物懂的設計模式。</p>
<h4 id="回顧-11"><a href="#回顧-11" class="headerlink" title="回顧"></a>回顧</h4><p>我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li><p>原型串錄是指經由物件的內部屬性<code>.__proto__</code>而形成的物件到物件的連結串連，當查找物件屬性時，若在本身這個物件找不到，就往更上一層物件尋找，直到串鏈尾端，若無法找到就回傳undefined。<code>.__proto__</code>存放的即為其建構子原型的參考。</p>
</li>
<li><p>JavaScript沒有類吸，也沒有建構子，因此</p>
<ul>
<li>只要函式前有new，這個函就是建構子</li>
<li>只要函式前有new來個呼叫，就叫做建構子呼叫。</li>
</ul>
</li>
<li><p>JavaScript中的繼承是指原型式繼式或差異式繼承，意即使用連結兩個物件而能共用屬性的方式來模擬物件導向語言的類別與繼承功能。</p>
</li>
<li><p>hasOwnProperty可用來檢查屬性是屬於當前物件，還是位於原型串鏈中。</p>
</li>
<li><p>instanceof與isPrototypeOf可用來檢查物件是否為指定的建構子所建立的實體；</p>
<p><code>Object.getPrototypeOf</code>可取得物件的<code>[[Prototype]]</code>的值；</p>
<p><code>Object.setPrototypeOf</code>可設定物件的<code>[[Prototype]]</code>的值；</p>
</li>
<li><p><code>Object.prototype</code>就整條原型串鏈的終點。</p>
</li>
<li><p>物件屬性的設定與遮蔽規則。</p>
</li>
<li><p><code>Object.create(..)</code>可將兩個物件連結起來。</p>
</li>
</ul>
<h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://ithelp.ithome.com.tw/users/20092232/ironman/1612">你懂 JavaScript 嗎？</a></p>
<p><a href="https://github.com/getify/You-Dont-Know-JS/tree/1st-ed">You Don’t Know JS 1st Edition</a></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>javascript</category>
      </categories>
      <tags>
        <tag>javascript</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄Nodejs-Socket_io多通道使用</title>
    <url>/%E8%A8%98%E9%8C%84Nodejs-Socket-io%E5%A4%9A%E9%80%9A%E9%81%93%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs-Socket-io%E5%A4%9A%E9%80%9A%E9%81%93%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>先來測試一個在Socket.IO裏的<code>namespace</code>和<code>room</code>的使用，先有一個<code>namespce</code>下面有一個聊天的頻道，在有一個<code>namespace</code>加上有4個<code>room</code>來傳送和接收圖片</p>
<p>先建立專案和之前的方式一樣先建立一個資料夾<code>namespace-example</code>,在下其它的指令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm init</span><br><span class="line">npm install --save express</span><br><span class="line">npm install --save socket.io</span><br></pre></td></tr></table></figure>
<h3 id="單一namespace和單一room頻道的測試"><a href="#單一namespace和單一room頻道的測試" class="headerlink" title="單一namespace和單一room頻道的測試"></a>單一<code>namespace</code>和單一<code>room</code>頻道的測試</h3><h4 id="服務端的設定"><a href="#服務端的設定" class="headerlink" title="服務端的設定"></a>服務端的設定</h4><p>先設定有幾個<code>namespace</code>,可以處理多個<code>namespace</code>在<code>app.js</code>下設定</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//建立socket.io的namespace</span></span><br><span class="line"><span class="keyword">var</span> namespaces = [</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/nsp_chat&#x27;</span>),</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/ns2&#x27;</span>),</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/ns3&#x27;</span>)</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>在設定有幾個<code>room</code>房間,目前先設定四個</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//建立room</span></span><br><span class="line"><span class="keyword">let</span> registeredRooms = [<span class="string">&quot;channel1&quot;</span>, <span class="string">&quot;channel2&quot;</span>, <span class="string">&quot;channel3&quot;</span>,<span class="string">&quot;channel4&quot;</span>]; </span><br></pre></td></tr></table></figure>

<p>在加入可以回傳處理的函式</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> namespaces) &#123;</span><br><span class="line">    namespaces[i].<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="title function_">handleConnection</span>(namespaces[i]));  </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleConnection</span>(<span class="params">ns</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">socket</span>)&#123; <span class="comment">//connection</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connected &quot;</span>);</span><br><span class="line">    socket.<span class="title function_">emit</span>(<span class="string">&quot;connected&quot;</span>,registeredRooms);</span><br><span class="line">    <span class="comment">//socket.on(&#x27;setUsername&#x27;,setUsernameCallback(socket,ns));                       </span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>, <span class="title function_">disconnectCallback</span>(socket,ns));   </span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;chatmessage&#x27;</span>,<span class="title function_">chatMessageCallback</span>(socket,ns));                     </span><br><span class="line">    <span class="comment">//socket.on(&#x27;messageChat&#x27;,messageChatCallback(socket,ns));</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;createJoinRoom&#x27;</span>,<span class="title function_">createJoinRoomCallback</span>(socket,ns));  </span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;bytemessage&#x27;</span>,<span class="title function_">byteMessaecCallback</span>(socket,ns));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每個<code>namespace</code>有自已處理的函式</p>
<p>在流程是</p>
<ul>
<li><code>client</code>先設定好連線到<code>server</code></li>
<li><code>server</code>收到連線後會回傳房間列表</li>
<li><code>client</code>端收到房間列表，送<code>createJoinRoom</code>和那一個房間到<code>server</code></li>
<li><code>server</code>收到<code>createJoinRoom</code>, 將<code>client</code>加入它送上來的房間和回傳<code>success</code></li>
<li><code>client</code>收到有效房間的訊息<br>如下圖所示</li>
</ul>
<img src="2019-05-09_12_27_39_Image.jpg" style="zoom:80%;" />

<p>在<code>app.js</code>的程式碼如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"><span class="keyword">var</span> io  = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)(http);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname+<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//有關Socket.IO的設定</span></span><br><span class="line"><span class="comment">//建立socket.io的namespace</span></span><br><span class="line"><span class="keyword">var</span> namespaces = [</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/nsp_chat&#x27;</span>),</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/ns2&#x27;</span>),</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/ns3&#x27;</span>)</span><br><span class="line">];</span><br><span class="line"><span class="comment">//建立room</span></span><br><span class="line"><span class="keyword">let</span> registeredRooms = [<span class="string">&quot;channel1&quot;</span>, <span class="string">&quot;channel2&quot;</span>, <span class="string">&quot;channel3&quot;</span>,<span class="string">&quot;channel4&quot;</span>]; </span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> namespaces) &#123;</span><br><span class="line">    namespaces[i].<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="title function_">handleConnection</span>(namespaces[i]));  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleConnection</span>(<span class="params">ns</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">socket</span>)&#123; <span class="comment">//connection</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connection &quot;</span>);</span><br><span class="line">    socket.<span class="title function_">emit</span>(<span class="string">&quot;connection&quot;</span>,registeredRooms);</span><br><span class="line">    <span class="comment">//socket.on(&#x27;setUsername&#x27;,setUsernameCallback(socket,ns));                       </span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>, <span class="title function_">disconnectCallback</span>(socket,ns));   </span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;chatmessage&#x27;</span>,<span class="title function_">chatMessageCallback</span>(socket,ns));                     </span><br><span class="line">    <span class="comment">//socket.on(&#x27;messageChat&#x27;,messageChatCallback(socket,ns));</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;createJoinRoom&#x27;</span>,<span class="title function_">createJoinRoomCallback</span>(socket,ns));  </span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;bytemessage&#x27;</span>,<span class="title function_">byteMessaecCallback</span>(socket,ns));</span><br><span class="line"> </span><br><span class="line">   &#125;;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">byteMessaecCallback</span>(<span class="params">socket,ns</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">bufdata</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;bytemessage &quot;</span>);</span><br><span class="line">        socket.<span class="title function_">emit</span>(<span class="string">&quot;bytemessage&quot;</span>,bufdata);</span><br><span class="line">      &#125;;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">connectedCallback</span>(<span class="params">socket, ns</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connected &quot;</span>);</span><br><span class="line">        <span class="comment">//socket.broadcast.send(&quot;It works!&quot;);</span></span><br><span class="line">      &#125;;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 加入房間</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createJoinRoomCallback</span>(<span class="params">socket, ns</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">room</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Joining Room...: &quot;</span> + room);</span><br><span class="line">        <span class="keyword">if</span>(registeredRooms.<span class="title function_">includes</span>(room))&#123;</span><br><span class="line">            <span class="comment">//socket已加入房間</span></span><br><span class="line">            socket.<span class="title function_">emit</span>(<span class="string">&quot;success&quot;</span>,<span class="string">&quot;有效房間名:&quot;</span>+room);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 沒有此房間</span></span><br><span class="line">            socket.<span class="title function_">emit</span>(<span class="string">&quot;err&quot;</span>,<span class="string">&quot;無效房間名:&quot;</span>+room);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">//斷線處理</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">disconnectCallback</span>(<span class="params">socket,ns</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Disconnected &quot;</span>);</span><br><span class="line">     socket.<span class="property">broadcast</span>.<span class="title function_">send</span>(<span class="string">&quot;It works!&quot;</span>);</span><br><span class="line">   &#125;;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 聊天訊息</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">chatMessageCallback</span>(<span class="params">socket,ns</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;chatmessage: &#x27;</span>+ msg);</span><br><span class="line">        socket.<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//有關Socket.IO的處理</span></span><br><span class="line"><span class="comment">//有關chat</span></span><br><span class="line"><span class="comment">// 有client連線</span></span><br><span class="line"><span class="comment">// nsp_chat.on(&#x27;connection&#x27;,function(socket)&#123;</span></span><br><span class="line"><span class="comment">//     socket.broadcast.emit(&#x27;chat message&#x27;,&#x27;hi&#x27;);</span></span><br><span class="line"><span class="comment">//     console.log(&#x27;an user connected&#x27;);</span></span><br><span class="line"><span class="comment">//      //client斷線</span></span><br><span class="line"><span class="comment">//      nsp_chat.on(&#x27;disconnect&#x27;,function()&#123;</span></span><br><span class="line"><span class="comment">//         console.log(&#x27;user disconnected&#x27;);</span></span><br><span class="line"><span class="comment">//     &#125;);</span></span><br><span class="line"><span class="comment">//     nsp_chat.on(&#x27;chat message&#x27;,function(msg)&#123;</span></span><br><span class="line"><span class="comment">//         console.log(&#x27;message: &#x27;+ msg);</span></span><br><span class="line"><span class="comment">//         //收到訊息後，回傳給自已</span></span><br><span class="line"><span class="comment">//         socket.emit(&#x27;chat message&#x27;,msg);</span></span><br><span class="line"><span class="comment">//     &#125;);</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listen on *:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="客戶端的設定"><a href="#客戶端的設定" class="headerlink" title="客戶端的設定"></a>客戶端的設定</h4><p>在<code>index.html</code>的程式碼如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">box-sizing</span>: border-box;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.imgshow</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>:<span class="number">20%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>:<span class="number">200px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">float</span>: left;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.inputdiv</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">224</span>, <span class="number">188</span>, <span class="number">188</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: .<span class="number">5%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">float</span>: left;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">3px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">bottom</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">20%</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.clsmsginput</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: .<span class="number">5%</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#msgbtn</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: none;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">1px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">list-style-type</span>: none;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#eee</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-bottom</span>: <span class="number">40px</span></span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    不顯示只傳送: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;myCheck&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo1&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%; height:100%&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo2&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%; height:100%&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo3&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%; height:100%&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo4&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%; height:100%&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&quot;clear: left;&quot;</span>&gt;</span>群聊<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span> &gt;</span></span><br><span class="line">            輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput1&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn1&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile1&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn1&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">            輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn2&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile2&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn2&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">            輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput3&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn3&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile3&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn3&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">            輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn4&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile4&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn4&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-1.11.1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> channellist=[];</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//網路相關</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//建立連接</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> socket_chat = <span class="title function_">io</span>(<span class="string">&#x27;http://localhost:3000/nsp_chat&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            socket_chat.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">chlist</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;connection:&#x27;</span>+chlist);</span></span><br><span class="line"><span class="language-javascript">                channellist=chlist;</span></span><br><span class="line"><span class="language-javascript">                socket_chat.<span class="title function_">emit</span>(<span class="string">&#x27;createJoinRoom&#x27;</span>,channellist[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket_chat.<span class="title function_">on</span>(<span class="string">&#x27;chatmessage&#x27;</span>, <span class="keyword">function</span> (<span class="params">msg</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;收到:&#x27;+msg);</span></span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(msg));</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket_chat.<span class="title function_">on</span>(<span class="string">&#x27;success&#x27;</span>,<span class="keyword">function</span>(<span class="params">room</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> limsg=<span class="string">&#x27;成功加入此房間:&#x27;</span>+room;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;成功加入:&#x27;+room);</span></span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(limsg));</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket_chat.<span class="title function_">on</span>(<span class="string">&#x27;err&#x27;</span>,<span class="keyword">function</span>(<span class="params">room</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> limsg=<span class="string">&#x27;無效房間名:&#x27;</span>+room;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;無效房間名:&#x27;+room);</span></span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(limsg));</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket_chat.<span class="title function_">on</span>(<span class="string">&#x27;bytemessage&#x27;</span>, <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;byte message&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//var bufView = new Uint8Array(data);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(data.buffer);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// Get the checkbox</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> checkBox = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;myCheck&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (checkBox.<span class="property">checked</span> != <span class="literal">true</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([data], &#123; <span class="attr">type</span>: <span class="string">&quot;image/jpeg&quot;</span> &#125;);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> urlCreator = <span class="variable language_">window</span>.<span class="property">URL</span> || <span class="variable language_">window</span>.<span class="property">webkitURL</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> imageUrl = urlCreator.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> img = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#photo1&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    img.<span class="property">src</span> = imageUrl;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                data.<span class="property">length</span>=<span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//------------------------------------------</span></span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#msgbtn1&#x27;</span>).<span class="title function_">click</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> msg = $(<span class="string">&#x27;#msginput1&#x27;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;發射:[&#x27;</span> + msg + <span class="string">&#x27;]&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                socket_chat.<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>, msg);</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#msginput1&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//發送圖片</span></span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#imgbtn1&#x27;</span>).<span class="title function_">click</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;imgbtn1:click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//讀所有的圖檔</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> uploadPromises = [];</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> files=$(<span class="string">&#x27;#imgfile1&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> <span class="title class_">Bufferary</span>= <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(files.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">for</span>(i=<span class="number">0</span> ;i&lt;files.<span class="property">length</span>;i++)&#123;</span></span><br><span class="line"><span class="language-javascript">                     <span class="keyword">var</span> uploadPromise=<span class="title function_">getBufferFromFile</span>(files[i]);</span></span><br><span class="line"><span class="language-javascript">                     uploadPromises.<span class="title function_">push</span>(uploadPromise);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Promise</span>.<span class="title function_">all</span>(uploadPromises).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title class_">Bufferary</span>[i] = result[i];</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//測試</span></span></span><br><span class="line"><span class="language-javascript">                    socket_chat.<span class="title function_">emit</span>(<span class="string">&#x27;bytemessage&#x27;</span>, <span class="title class_">Bufferary</span>[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//socket_chat.emit(&#x27;byte message&#x27;, Bufferary[0]);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//開始發射</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//     setInterval(() =&gt; &#123;</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//         for (i = 0; i &lt; files.length; i++) &#123;</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//             var file = files[i]</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//             //console.log(&#x27;發射:&#x27;+file.name )</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//             //socket.emit(&#x27;byte message&#x27;, &#123; image: true, buffer: Bufferary[i] &#125;);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//             socket.emit(&#x27;byte message&#x27;, Bufferary[i]);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//         &#125;</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//     &#125;, 500);</span></span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">getBufferFromFile</span>(<span class="params">file</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                reader.<span class="title function_">readAsArrayBuffer</span>(file);</span></span><br><span class="line"><span class="language-javascript">                reader.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> buf = reader.<span class="property">result</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">resolve</span>(buf);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                reader.<span class="property">onerror</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">reject</span>(<span class="string">&#x27;讀取檔案失敗&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="單一namespace和4個room頻道的測試"><a href="#單一namespace和4個room頻道的測試" class="headerlink" title="單一namespace和4個room頻道的測試"></a>單一<code>namespace</code>和4個<code>room</code>頻道的測試</h3><h4 id="服務端的設定-1"><a href="#服務端的設定-1" class="headerlink" title="服務端的設定"></a>服務端的設定</h4><p>要在預設的<code>namespace</code>不然之後會操作上會有問題<code>app.js</code>的程式碼</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)(http);</span><br><span class="line"><span class="comment">// 服務那一個Port</span></span><br><span class="line">http.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listen on *:3000&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//首頁</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname+<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//建立room</span></span><br><span class="line"><span class="keyword">let</span> registeredRooms = [<span class="string">&quot;room1&quot;</span>, <span class="string">&quot;room2&quot;</span>, <span class="string">&quot;room3&quot;</span>,<span class="string">&quot;room4&quot;</span>]; </span><br><span class="line"></span><br><span class="line"><span class="comment">//default namespace</span></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="keyword">function</span> (<span class="params">socket</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> ip = socket.<span class="property">conn</span>.<span class="property">remoteAddress</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;default_ns:a user connected IP:&#x27;</span>+ip);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;default_ns:user disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> namespaces = [</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/aaa-123&#x27;</span>),</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/bbb-123&#x27;</span>),</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/ccc-123&#x27;</span>),</span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> ns_name = namespaces[<span class="number">0</span>];</span><br><span class="line">ns_name.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 取得房間</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;getRooms&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&lt;getRooms&gt;: &quot;</span>,ns_name.<span class="property">name</span>);</span><br><span class="line">        socket.<span class="title function_">emit</span>(<span class="string">&#x27;rooomsData&#x27;</span>,registeredRooms);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 加入房間</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;createJoinRoom&#x27;</span>, <span class="keyword">function</span> (<span class="params">room</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;&lt;createJoinRoom&gt; :&#x27;</span> + room);</span><br><span class="line">        <span class="keyword">if</span> (registeredRooms.<span class="title function_">includes</span>(room)) &#123;</span><br><span class="line">            <span class="comment">//socket已加入房間</span></span><br><span class="line">            socket.<span class="title function_">emit</span>(<span class="string">&#x27;success&#x27;</span>, room);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;有效房間名:&#x27;</span> + room);</span><br><span class="line">            socket.<span class="title function_">join</span>(room);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 沒有此房間</span></span><br><span class="line">            socket.<span class="title function_">emit</span>(<span class="string">&#x27;err&#x27;</span>, room);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;無效房間名:&#x27;</span> + room);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//收到聊天訊息</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;chatmessage&#x27;</span>,<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;&lt;chatmessage&gt; :&#x27;</span> + <span class="string">&#x27;msg:&#x27;</span>+data.<span class="property">msg</span> + <span class="string">&#x27; room:&#x27;</span>+data.<span class="property">room</span>);</span><br><span class="line">        ns_name.<span class="title function_">to</span>(data.<span class="property">room</span>).<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>,data);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//收到二進位資料</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;bytemessage&#x27;</span>,<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//console.log(&#x27;&lt;bytemessage&gt; :&#x27; + &#x27; room:&#x27;+data.room);</span></span><br><span class="line">        ns_name.<span class="title function_">to</span>(data.<span class="property">room</span>).<span class="title function_">emit</span>(<span class="string">&#x27;bytemessage&#x27;</span>,data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="客戶端的設定-1"><a href="#客戶端的設定-1" class="headerlink" title="客戶端的設定"></a>客戶端的設定</h4><p>在客戶端的<code>index.html</code>的程式碼</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO 多頻道<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">box-sizing</span>: border-box;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.imgshow</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">200px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.clsimage</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>:<span class="number">100%</span>; </span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>:<span class="number">100%</span></span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.clschannel</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">20%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">float</span>: left;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#eee</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.clsmessages</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">list-style-type</span>: none;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        ;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-bottom</span>: <span class="number">40px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.inputdiv</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">224</span>, <span class="number">188</span>, <span class="number">188</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: .<span class="number">5%</span>;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">3px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">bottom</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.clsmsginput</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: .<span class="number">5%</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#msgbtn</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: none;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">1px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages1</span> <span class="selector-tag">li</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages1</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#eee</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        不顯示只傳送: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;myCheck&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&quot;clear: left;&quot;</span>&gt;</span>頻道<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;clschannel&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span> &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsimage&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;messages1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmessages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">                輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput1&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn1&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile1&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn1&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;clschannel&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsimage&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;clsmessages&quot;</span> <span class="attr">id</span>=<span class="string">&quot;messages2&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">                輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput2&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn2&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile2&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn2&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;clschannel&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsimage&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;clsmessages&quot;</span> <span class="attr">id</span>=<span class="string">&quot;messages3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">                輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput3&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn3&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile3&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn3&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;clschannel&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo4&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsimage&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;clsmessages&quot;</span> <span class="attr">id</span>=<span class="string">&quot;messages4&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">                輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn4&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile4&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn4&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-1.11.1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;doucument ready!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> ns_sockets = [</span></span><br><span class="line"><span class="language-javascript">            io.<span class="title function_">connect</span>(<span class="string">&#x27;http://localhost:3000/aaa-123&#x27;</span>),</span></span><br><span class="line"><span class="language-javascript">            io.<span class="title function_">connect</span>(<span class="string">&#x27;http://localhost:3000/aaa-123&#x27;</span>),</span></span><br><span class="line"><span class="language-javascript">            io.<span class="title function_">connect</span>(<span class="string">&#x27;http://localhost:3000/aaa-123&#x27;</span>),</span></span><br><span class="line"><span class="language-javascript">            io.<span class="title function_">connect</span>(<span class="string">&#x27;http://localhost:3000/aaa-123&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        ];</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> roomlst=[];</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//建立回調函數</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">for</span> (i <span class="keyword">in</span> ns_sockets) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;處理ns_sockets-&gt;&#x27;</span>+i);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 連線處理</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;connect&#x27;</span>, <span class="title function_">handleConnect</span>(ns_sockets[i], i));</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 房間列表</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;rooomsData&#x27;</span>, <span class="title function_">handlerooomsData</span>(ns_sockets[i], i));</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// success 處理</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;success&#x27;</span>, <span class="title function_">handleSuccess</span>(ns_sockets[i]),i);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// err 處理</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;err&#x27;</span>, <span class="title function_">handleErr</span>(ns_sockets[i]),i);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 斷線處理</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>, <span class="title function_">handleDisconnect</span>(ns_sockets[i]),i);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 聊天處理</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;chatmessage&#x27;</span>, <span class="title function_">handleChatmessage</span>(ns_sockets[i]),i);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 二進位處理</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;bytemessage&#x27;</span>, <span class="title function_">handleBytemessage</span>(ns_sockets[i]),i);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//UI</span></span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#msgbtn1&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;msgbtn1 click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> msg = $(<span class="string">&#x27;#msginput1&#x27;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">            ns_sockets[<span class="number">0</span>].<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>, &#123; <span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room1&#x27;</span>, <span class="string">&quot;msg&quot;</span>: msg &#125;);</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#msginput1&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#msgbtn2&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;msgbtn2 click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> msg = $(<span class="string">&#x27;#msginput2&#x27;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">            ns_sockets[<span class="number">1</span>].<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>, &#123; <span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room2&#x27;</span>, <span class="string">&quot;msg&quot;</span>: msg &#125;);</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#msginput2&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#msgbtn3&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;msgbtn3 click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> msg = $(<span class="string">&#x27;#msginput3&#x27;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">            ns_sockets[<span class="number">2</span>].<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>, &#123; <span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room3&#x27;</span>, <span class="string">&quot;msg&quot;</span>: msg &#125;);</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#msginput3&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#msgbtn4&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;msgbtn4 click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> msg = $(<span class="string">&#x27;#msginput4&#x27;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">            ns_sockets[<span class="number">3</span>].<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>, &#123; <span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room4&#x27;</span>, <span class="string">&quot;msg&quot;</span>: msg &#125;);</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#msginput4&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//發送圖片</span></span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#imgbtn1&#x27;</span>).<span class="title function_">click</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;imgbtn1:click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//讀所有的圖檔</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> uploadPromises = [];</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> files = $(<span class="string">&#x27;#imgfile1&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> <span class="title class_">Bufferary</span> = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(files.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> uploadPromise = <span class="title function_">getBufferFromFile</span>(files[i]);</span></span><br><span class="line"><span class="language-javascript">                uploadPromises.<span class="title function_">push</span>(uploadPromise);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="title class_">Promise</span>.<span class="title function_">all</span>(uploadPromises).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">Bufferary</span>[i] = result[i];</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//開始發射</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//ns_sockets[0].emit(&#x27;bytemessage&#x27;,&#123; &quot;room&quot;: &#x27;room1&#x27;, &quot;bufdata&quot;: Bufferary[0] &#125; );</span></span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">var</span> file = files[i]</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//console.log(&#x27;發射:&#x27;+file.name )</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//socket.emit(&#x27;byte message&#x27;, &#123; image: true, buffer: Bufferary[i] &#125;);</span></span></span><br><span class="line"><span class="language-javascript">                            ns_sockets[<span class="number">0</span>].<span class="title function_">emit</span>(<span class="string">&#x27;bytemessage&#x27;</span>, &#123;<span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room1&#x27;</span>, <span class="string">&quot;bufdata&quot;</span>: <span class="title class_">Bufferary</span>[i]&#125;);</span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;,<span class="number">600</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#imgbtn2&#x27;</span>).<span class="title function_">click</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;imgbtn2:click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//讀所有的圖檔</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> uploadPromises = [];</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> files = $(<span class="string">&#x27;#imgfile2&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> <span class="title class_">Bufferary</span> = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(files.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> uploadPromise = <span class="title function_">getBufferFromFile</span>(files[i]);</span></span><br><span class="line"><span class="language-javascript">                uploadPromises.<span class="title function_">push</span>(uploadPromise);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="title class_">Promise</span>.<span class="title function_">all</span>(uploadPromises).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">Bufferary</span>[i] = result[i];</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//開始發射</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//ns_sockets[0].emit(&#x27;bytemessage&#x27;,&#123; &quot;room&quot;: &#x27;room1&#x27;, &quot;bufdata&quot;: Bufferary[0] &#125; );</span></span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">var</span> file = files[i]</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//console.log(&#x27;發射:&#x27;+file.name )</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//socket.emit(&#x27;byte message&#x27;, &#123; image: true, buffer: Bufferary[i] &#125;);</span></span></span><br><span class="line"><span class="language-javascript">                            ns_sockets[<span class="number">1</span>].<span class="title function_">emit</span>(<span class="string">&#x27;bytemessage&#x27;</span>, &#123;<span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room2&#x27;</span>, <span class="string">&quot;bufdata&quot;</span>: <span class="title class_">Bufferary</span>[i]&#125;);</span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;,<span class="number">600</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#imgbtn3&#x27;</span>).<span class="title function_">click</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;imgbtn3:click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//讀所有的圖檔</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> uploadPromises = [];</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> files = $(<span class="string">&#x27;#imgfile3&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> <span class="title class_">Bufferary</span> = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(files.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> uploadPromise = <span class="title function_">getBufferFromFile</span>(files[i]);</span></span><br><span class="line"><span class="language-javascript">                uploadPromises.<span class="title function_">push</span>(uploadPromise);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="title class_">Promise</span>.<span class="title function_">all</span>(uploadPromises).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">Bufferary</span>[i] = result[i];</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//開始發射</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//ns_sockets[0].emit(&#x27;bytemessage&#x27;,&#123; &quot;room&quot;: &#x27;room1&#x27;, &quot;bufdata&quot;: Bufferary[0] &#125; );</span></span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">var</span> file = files[i]</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//console.log(&#x27;發射:&#x27;+file.name )</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//socket.emit(&#x27;byte message&#x27;, &#123; image: true, buffer: Bufferary[i] &#125;);</span></span></span><br><span class="line"><span class="language-javascript">                            ns_sockets[<span class="number">1</span>].<span class="title function_">emit</span>(<span class="string">&#x27;bytemessage&#x27;</span>, &#123;<span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room3&#x27;</span>, <span class="string">&quot;bufdata&quot;</span>: <span class="title class_">Bufferary</span>[i]&#125;);</span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;,<span class="number">600</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#imgbtn4&#x27;</span>).<span class="title function_">click</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;imgbtn4:click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//讀所有的圖檔</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> uploadPromises = [];</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> files = $(<span class="string">&#x27;#imgfile4&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> <span class="title class_">Bufferary</span> = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(files.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> uploadPromise = <span class="title function_">getBufferFromFile</span>(files[i]);</span></span><br><span class="line"><span class="language-javascript">                uploadPromises.<span class="title function_">push</span>(uploadPromise);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="title class_">Promise</span>.<span class="title function_">all</span>(uploadPromises).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">Bufferary</span>[i] = result[i];</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//開始發射</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//ns_sockets[0].emit(&#x27;bytemessage&#x27;,&#123; &quot;room&quot;: &#x27;room1&#x27;, &quot;bufdata&quot;: Bufferary[0] &#125; );</span></span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">var</span> file = files[i]</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//console.log(&#x27;發射:&#x27;+file.name )</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//socket.emit(&#x27;byte message&#x27;, &#123; image: true, buffer: Bufferary[i] &#125;);</span></span></span><br><span class="line"><span class="language-javascript">                            ns_sockets[<span class="number">1</span>].<span class="title function_">emit</span>(<span class="string">&#x27;bytemessage&#x27;</span>, &#123;<span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room4&#x27;</span>, <span class="string">&quot;bufdata&quot;</span>: <span class="title class_">Bufferary</span>[i]&#125;);</span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;,<span class="number">600</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 二進位處理</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span>    <span class="title function_">handleBytemessage</span>(<span class="params">ns, idx</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;收到:&lt;bytemessage&gt;&#x27; + data.room + &#x27; buffdata :&#x27; + data.bufdata);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> checkBox = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;myCheck&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (checkBox.<span class="property">checked</span> != <span class="literal">true</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    idx = <span class="title function_">getidxfromroom</span>(data.<span class="property">room</span>) + <span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([data.<span class="property">bufdata</span>], &#123; <span class="attr">type</span>: <span class="string">&quot;image/jpeg&quot;</span> &#125;);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> urlCreator = <span class="variable language_">window</span>.<span class="property">URL</span> || <span class="variable language_">window</span>.<span class="property">webkitURL</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> imageUrl = urlCreator.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> img = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#photo&quot;</span> + idx);</span></span><br><span class="line"><span class="language-javascript">                    img.<span class="property">src</span> = imageUrl;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                data.<span class="property">bufdata</span>.<span class="property">length</span>=<span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 聊天處理</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleChatmessage</span>(<span class="params">ns, idx</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&lt;chatmessage&gt;&#x27;</span> + data.<span class="property">room</span> + <span class="string">&#x27; msg:&#x27;</span> + data.<span class="property">msg</span>);</span></span><br><span class="line"><span class="language-javascript">                idx = <span class="title function_">getidxfromroom</span>(data.<span class="property">room</span>)+<span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;idx&#x27; + idx);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> msglst = <span class="string">&#x27;#messages&#x27;</span> + idx;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(msglst);</span></span><br><span class="line"><span class="language-javascript">                $(msglst).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(data.<span class="property">msg</span>));</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// err 處理</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleErr</span>(<span class="params">ns, idx</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">room</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(ns.<span class="property">id</span>+<span class="string">&#x27; 收到:&lt;err&gt;加入&#x27;</span> + room);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// success 處理</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleSuccess</span>(<span class="params">ns, idx</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">room</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(ns.<span class="property">id</span>+<span class="string">&#x27; 收到:&lt;success&gt;加入&#x27;</span> + room);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 房間列表</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handlerooomsData</span>(<span class="params">ns, idx</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">roomlist</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&lt;rooomsData&gt;&#x27;</span> + roomlist);</span></span><br><span class="line"><span class="language-javascript">                roomlst = roomlist;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//加入房間</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> myroom = roomlist[idx];</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;client: &lt;createJoinRoom&gt;-room=&#x27;</span> + myroom);</span></span><br><span class="line"><span class="language-javascript">                ns.<span class="title function_">emit</span>(<span class="string">&#x27;createJoinRoom&#x27;</span>, myroom);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 斷線處理</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleDisconnect</span>(<span class="params">ns, idx</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&lt;disconnect&gt; ns-id:&#x27;</span>+ns.<span class="property">id</span>);</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 連線處理</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleConnect</span>(<span class="params">ns, idx</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&lt;connect&gt; ns-id:&#x27;</span>+ns.<span class="property">id</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 要求房間列表</span></span></span><br><span class="line"><span class="language-javascript">                ns.<span class="title function_">emit</span>(<span class="string">&#x27;getRooms&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">       </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">getidxfromroom</span>(<span class="params">room</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;roomlst.<span class="property">length</span>;i++)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span>(roomlst[i]== room) <span class="keyword">return</span> i;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> -<span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">getBufferFromFile</span>(<span class="params">file</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>( <span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                reader.<span class="title function_">readAsArrayBuffer</span>(file);</span></span><br><span class="line"><span class="language-javascript">                reader.<span class="property">onload</span>=<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> buf = reader.<span class="property">result</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">resolve</span>(buf);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                reader.<span class="property">onerror</span>=<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">reject</span>(<span class="string">&#x27;讀取檔案失敗&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h6 id="參考資訊"><a href="#參考資訊" class="headerlink" title="參考資訊"></a>參考資訊</h6><p><a href="https://gist.github.com/companje/0a42eb25dd3caff92ab7">https://gist.github.com/companje/0a42eb25dd3caff92ab7</a></p>
<p><a href="http://marklin-blog.logdown.com/posts/2907665-socket-io-talking-island">Socket.io 的說話島</a><br><a href="https://ipenywis.com/tutorials/Node.js-Socket.io-Namespaces,-Rooms-and-Connections-02">Node.js Socket.io Namespaces, Rooms and Connections 02</a><br><a href="https://www.jianshu.com/p/40d8bc17529f">socket.io+express多房间聊天应用</a><br><a href="https://stackoverflow.com/questions/13143945/dynamic-namespaces-socket-io">Dynamic Namespaces Socket.IO</a><br><a href="https://stackoverflow.com/questions/13504320/socket-io-namespaces-channels-co">Socket.io: Namespaces, channels &amp; co</a><br><a href="https://ithelp.ithome.com.tw/articles/10103528">且戰且走HTML5(5) 更深入Socket.IO</a><br><a href="http://psitsmike.com/2011/10/node-js-and-socket-io-multiroom-chat-tutorial/">node.js and socket.io multiroom chat tutorial</a><br><a href="https://stackoverflow.com/questions/29511404/connect-to-socket-io-server-with-specific-path-and-namespace">Connect to Socket.IO server with specific path and namespace</a></p>
]]></content>
      <categories>
        <category>記錄</category>
        <category>Nodejs</category>
      </categories>
      <tags>
        <tag>Nodejs</tag>
        <tag>socket.io</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄Nodejs-byte陣列傳送的基本使用</title>
    <url>/%E8%A8%98%E9%8C%84Nodejs-byte%E9%99%A3%E5%88%97%E5%82%B3%E9%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs-byte%E9%99%A3%E5%88%97%E5%82%B3%E9%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h4 id="建立的步驟和聊天的一樣"><a href="#建立的步驟和聊天的一樣" class="headerlink" title="建立的步驟和聊天的一樣"></a>建立的步驟和聊天的一樣</h4><ul>
<li><p>設定資料夾<code>byte-example</code></p>
</li>
<li><p>設定<code>package.json</code> <code>npm init</code></p>
</li>
<li><p>安裝express <code>npm install -- save express</code></p>
</li>
<li><p>安裝 Sokcet.IO <code>npm install --save socket.io</code></p>
</li>
<li><p>將使用原來的<code>index.htm</code></p>
</li>
</ul>
<p>修改<code>index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> app= <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)(http);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname+<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 有client連線</span></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    socket.<span class="property">broadcast</span>.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="string">&#x27;hi&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;an user connected&#x27;</span>);</span><br><span class="line">    <span class="comment">//client斷線</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;user disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;byte message&#x27;</span>,<span class="keyword">function</span>(<span class="params">byteary</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> bystring = byteary.<span class="title function_">toString</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;byte message: &#x27;</span>+ bystring);</span><br><span class="line">        <span class="comment">//收到訊息後，回傳給自已</span></span><br><span class="line">        io.<span class="title function_">emit</span>(<span class="string">&#x27;byte message&#x27;</span>,byteary);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">http.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on *:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p> 修改<code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>;<span class="attribute">box-sizing</span>: border-box; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123; <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> &#123; <span class="attribute">background</span>: <span class="number">#000</span>;<span class="attribute">padding</span>: <span class="number">3px</span>;<span class="attribute">position</span>: fixed;<span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">width</span>: <span class="number">100%</span>; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">input</span> &#123;<span class="attribute">border</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">10px</span>; <span class="attribute">width</span>: <span class="number">90%</span>; <span class="attribute">margin-right</span>: .<span class="number">5%</span> &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">button</span> &#123;<span class="attribute">width</span>: <span class="number">9%</span>;<span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);<span class="attribute">border</span>: none;<span class="attribute">padding</span>: <span class="number">10px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123; <span class="attribute">list-style-type</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span> &#123; <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123; <span class="attribute">background</span>: <span class="number">#eee</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123; <span class="attribute">margin-bottom</span>: <span class="number">40px</span> &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;m&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">button</span>&gt;</span>送出<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-1.11.1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> socket = <span class="title function_">io</span>();</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;form&#x27;</span>).<span class="title function_">submit</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                e.<span class="title function_">preventDefault</span>();<span class="comment">//prevent page reloading</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> bufArr = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">4</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> bufView = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(bufArr);</span></span><br><span class="line"><span class="language-javascript">                bufView[<span class="number">0</span>]=<span class="number">6</span>;</span></span><br><span class="line"><span class="language-javascript">                bufView[<span class="number">1</span>]=<span class="number">7</span>;</span></span><br><span class="line"><span class="language-javascript">                bufView[<span class="number">2</span>]=<span class="number">8</span>;</span></span><br><span class="line"><span class="language-javascript">                bufView[<span class="number">3</span>]=<span class="number">9</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> bystring = bufView.<span class="title function_">toString</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> msg=$(<span class="string">&#x27;#m&#x27;</span>).<span class="property">val</span>=bystring;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;發射:[&#x27;</span>+msg+<span class="string">&#x27;]&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                socket.<span class="title function_">emit</span>(<span class="string">&#x27;byte message&#x27;</span>, msg);</span></span><br><span class="line"><span class="language-javascript">               </span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//$(&#x27;#m&#x27;).val(&#x27;&#x27;);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">on</span>(<span class="string">&#x27;byte message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&#x27;</span>+msg);</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(msg));</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);    </span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">on</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&#x27;</span>+msg);</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(msg));</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>記錄</category>
        <category>Nodejs</category>
      </categories>
      <tags>
        <tag>Nodejs</tag>
        <tag>socket.io</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄Nodejs-聊天和圖片傳送的基本使用</title>
    <url>/%E8%A8%98%E9%8C%84Nodejs-%E8%81%8A%E5%A4%A9%E5%92%8C%E5%9C%96%E7%89%87%E5%82%B3%E9%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs-%E8%81%8A%E5%A4%A9%E5%92%8C%E5%9C%96%E7%89%87%E5%82%B3%E9%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>因為之前有測試可以使用陣列來相互傳送資料，這此想以之前的聊天的基礎上加入可以傳送圖片，只不過圖片是以byte陣列的方式來傳送，在收到之後在顯示，目前只能傳送jpg類型</p>
<h3 id="建立專案"><a href="#建立專案" class="headerlink" title="建立專案"></a>建立專案</h3><p>和聊天的專案是一樣的建立方式，先建立資料夾<code>byte-img-example</code> 剩下的參考基本聊天的設定在服務端的程式<code>index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)(http);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname+<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 有client連線</span></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    socket.<span class="property">broadcast</span>.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="string">&#x27;hi&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;an user connected&#x27;</span>);</span><br><span class="line">    <span class="comment">//client斷線</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;user disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;byte message&#x27;</span>,<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">        <span class="comment">//console.log(&#x27;byte message: &#x27;+ data.buffer);</span></span><br><span class="line">        <span class="comment">//收到訊息後，回傳給自已</span></span><br><span class="line">        io.<span class="title function_">emit</span>(<span class="string">&#x27;byte message&#x27;</span>,data);</span><br><span class="line">    &#125;);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;message: &#x27;</span>+ msg);</span><br><span class="line">        <span class="comment">//收到訊息後，回傳給自已</span></span><br><span class="line">        io.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,msg);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">http.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on *:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在客戶端的<code>index.html</code>裏</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>;<span class="attribute">box-sizing</span>: border-box; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123; <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#inputdiv</span> &#123; <span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">224</span>, <span class="number">188</span>, <span class="number">188</span>);<span class="attribute">padding</span>: <span class="number">3px</span>;<span class="attribute">position</span>: fixed;<span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">width</span>: <span class="number">50%</span>; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#msginput</span> &#123;<span class="attribute">border</span>: <span class="number">0</span>; <span class="attribute">width</span>: <span class="number">90%</span>; <span class="attribute">margin-right</span>: .<span class="number">5%</span> &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#msgbtn</span> &#123;<span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);<span class="attribute">border</span>: none;<span class="attribute">padding</span>: <span class="number">1px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123; <span class="attribute">list-style-type</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span> &#123; <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123; <span class="attribute">background</span>: <span class="number">#eee</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123; <span class="attribute">margin-bottom</span>: <span class="number">40px</span> &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>群聊<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">        輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn&quot;</span> &gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-1.11.1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//網路相關</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> socket = <span class="title function_">io</span>();</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">on</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;收到:&#x27;+msg);</span></span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(msg));</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);    </span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">on</span>(<span class="string">&#x27;byte message&#x27;</span>, <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;byte message&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> bufView = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(data.<span class="property">buffer</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">buffer</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([data.<span class="property">buffer</span>], &#123; <span class="attr">type</span>: <span class="string">&quot;image/jpeg&quot;</span> &#125;);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> urlCreator = <span class="variable language_">window</span>.<span class="property">URL</span> || <span class="variable language_">window</span>.<span class="property">webkitURL</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> imageUrl = urlCreator.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//var img = document.querySelector(&quot;#photo&quot;);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//img.src = imageUrl;</span></span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">append</span>(</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&#x27;&lt;img&gt;&#x27;</span>).<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">100</span>).<span class="title function_">attr</span>(<span class="string">&#x27;src&#x27;</span>,imageUrl)</span></span><br><span class="line"><span class="language-javascript">                ));</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);    </span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//</span></span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#msgbtn&#x27;</span>).<span class="title function_">click</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> msg = $(<span class="string">&#x27;#msginput&#x27;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;發射:[&#x27; + msg + &#x27;]&#x27;);</span></span></span><br><span class="line"><span class="language-javascript">                socket.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>, msg);</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#msginput&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//發送圖片</span></span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#imgbtn&#x27;</span>).<span class="title function_">click</span>(<span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;imgbtn:click&#x27;);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> file = $(<span class="string">&#x27;#imgfile&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>[<span class="number">0</span>];</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span></span><br><span class="line"><span class="language-javascript">                reader.<span class="title function_">readAsArrayBuffer</span>(file);</span></span><br><span class="line"><span class="language-javascript">                reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> arrayBuffer = e.<span class="property">target</span>.<span class="property">result</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//var bytes = new Uint8Array(arrayBuffer);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(arrayBuffer);</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    socket.<span class="title function_">emit</span>(<span class="string">&#x27;byte message&#x27;</span>, &#123; <span class="attr">image</span>: <span class="literal">true</span>, <span class="attr">buffer</span>: arrayBuffer &#125;);</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// var blob = new Blob([arrayBuffer], &#123; type: &quot;image/jpeg&quot; &#125;);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// var urlCreator = window.URL || window.webkitURL;</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// var imageUrl = urlCreator.createObjectURL(blob);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// var img = document.querySelector(&quot;#photo&quot;);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// img.src = imageUrl;</span></span></span><br><span class="line"><span class="language-javascript">                &#125; </span></span><br><span class="line"><span class="language-javascript">               </span></span><br><span class="line"><span class="language-javascript">                <span class="comment">/* var selectedFile = $(&#x27;#imgfile&#x27;).get(0).files[0];</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                let reader = new FileReader();</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                reader.readAsArrayBuffer (selectedFile);  </span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                reader.onload = function () &#123;</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                    var arrayBuffer = this.result;</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                    var bufView = new Uint8Array(arrayBuffer);</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                    socket.emit(&#x27;byte message&#x27;, bufView);</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                &#125; */</span></span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>比較要注意的是在<strong>Socket.IO</strong>在陣列上只能傳送</p>
<ul>
<li><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/Blob">Blob</a> in the browser</p>
</li>
<li><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer</a> and <a href="https://nodejs.org/api/buffer.html">Buffer</a> in Node.js</p>
</li>
</ul>
<p>以下是讀取圖片資料和傳送到<strong>Socket.IO</strong>的程式片段</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">reader.<span class="title function_">readAsArrayBuffer</span>(file);</span><br><span class="line">reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> arrayBuffer = e.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(arrayBuffer);</span><br><span class="line">  socket.<span class="title function_">emit</span>(<span class="string">&#x27;byte message&#x27;</span>, &#123; <span class="attr">image</span>: <span class="literal">true</span>, <span class="attr">buffer</span>: arrayBuffer &#125;);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>以下是收到圖片資料和轉成html的圖片</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">socket.<span class="title function_">on</span>(<span class="string">&#x27;byte message&#x27;</span>, <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;byte message&#x27;</span>);</span><br><span class="line">            <span class="keyword">var</span> bufView = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(data.<span class="property">buffer</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">buffer</span>);</span><br><span class="line">            <span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([data.<span class="property">buffer</span>], &#123; <span class="attr">type</span>: <span class="string">&quot;image/jpeg&quot;</span> &#125;);</span><br><span class="line">            <span class="keyword">var</span> urlCreator = <span class="variable language_">window</span>.<span class="property">URL</span> || <span class="variable language_">window</span>.<span class="property">webkitURL</span>;</span><br><span class="line">            <span class="keyword">var</span> imageUrl = urlCreator.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line">           </span><br><span class="line">             $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">append</span>(</span><br><span class="line">                    $(<span class="string">&#x27;&lt;img&gt;&#x27;</span>).<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">100</span>).<span class="title function_">attr</span>(<span class="string">&#x27;src&#x27;</span>,imageUrl)</span><br><span class="line">                ));</span><br><span class="line">             <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);    </span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>

<h4 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h4><p><a href="https://socket.io/docs/#Sending-and-getting-data-acknowledgements">Socket.IO</a></p>
<p><a href="http://marklin-blog.logdown.com/posts/2907665-socket-io-talking-island">Socket.io 的說話島</a></p>
<p><a href="https://stackoverflow.com/questions/34056705/how-to-send-binary-data-with-socket-io">How to send binary data with socket.io?</a></p>
<p><a href="https://stackoverflow.com/questions/31433413/return-the-array-of-bytes-from-filereader">Return the Array of Bytes from FileReader()</a></p>
<p><a href="https://stackoverflow.com/questions/32556664/getting-byte-array-through-input-type-file">Getting byte array through input type &#x3D; file</a></p>
<p><a href="https://ithelp.ithome.com.tw/articles/10195525">DAY 30. JavaScript Blob, Buffer</a></p>
<p><a href="https://blog.csdn.net/NEUQ_zxy/article/details/77531126">socket.io简易教程</a></p>
]]></content>
      <categories>
        <category>記錄</category>
        <category>Nodejs</category>
      </categories>
      <tags>
        <tag>Nodejs</tag>
        <tag>socket.io</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄Nodejs-聊天的基本使用</title>
    <url>/%E8%A8%98%E9%8C%84Nodejs-%E8%81%8A%E5%A4%A9%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs-%E8%81%8A%E5%A4%A9%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h3 id="建立基本卿天架構"><a href="#建立基本卿天架構" class="headerlink" title="建立基本卿天架構"></a>建立基本卿天架構</h3><p>先在資料夾建立<code>chat-example</code>的資料夾</p>
<h4 id="設定package-json"><a href="#設定package-json" class="headerlink" title="設定package.json"></a>設定package.json</h4><p>先建立一個資料夾叫helloexpress, 在到它的目錄下使用命令列，下下面的指令<code>npm init</code>先建立<code>package.json</code>,它會問些問題，會將資料寫入<code>package.json</code>按照需要輸入或是直接按下不輸入</p>
<h4 id="安裝express"><a href="#安裝express" class="headerlink" title="安裝express"></a>安裝express</h4><p>在命令列下<code>npm install --save express</code>,它會建立<code>node_modules</code>的資料夾和將相關的程式碼放到此目錄</p>
<h4 id="建立index-js"><a href="#建立index-js" class="headerlink" title="建立index.js"></a>建立index.js</h4><p>在和<code>package.json</code>的相同目錄下，建立<code>index.js</code>，這是程式執行的地方輸入如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;&lt;h1&gt;Hello express&lt;/h1&gt;&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on *:3000&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在命令列下輸入<code>node index.js</code>接下來在瀏覽器中輸入<code>http://127.0.0.1:3000</code>在瀏覽器的畫面會顯示<code>&lt;h1&gt;Hello express&lt;/h1&gt;</code></p>
<h3 id="建立網頁"><a href="#建立網頁" class="headerlink" title="建立網頁"></a>建立網頁</h3><p>我們要向client送出設定好的網頁，可以修改<code>index.js</code>的碼如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> app= <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname+<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">http.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on *:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>向client端送的<code>index.html</code>的內容如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>;<span class="attribute">box-sizing</span>: border-box; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123; <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> &#123; <span class="attribute">background</span>: <span class="number">#000</span>;<span class="attribute">padding</span>: <span class="number">3px</span>;<span class="attribute">position</span>: fixed;<span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">width</span>: <span class="number">100%</span>; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">input</span> &#123;<span class="attribute">border</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">10px</span>; <span class="attribute">width</span>: <span class="number">90%</span>; <span class="attribute">margin-right</span>: .<span class="number">5%</span> &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">button</span> &#123;<span class="attribute">width</span>: <span class="number">9%</span>;<span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);<span class="attribute">border</span>: none;<span class="attribute">padding</span>: <span class="number">10px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#message</span> &#123;<span class="attribute">list-style-type</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#message</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123; <span class="attribute">background</span>: <span class="number">#eee</span> &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;message&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;m&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">button</span>&gt;</span>送出<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="加入Socket-IO"><a href="#加入Socket-IO" class="headerlink" title="加入Socket.IO"></a>加入Socket.IO</h3><p>以下的指令來安裝</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install --save socket.io</span><br></pre></td></tr></table></figure>

<p>來修改index.js如下加入<code>var io = require(&#39;socket.io&#39;)(http);</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> app= <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)(http);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname+<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;an user connected&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">http.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on *:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在修改給client端的<code>index.html</code>的端如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>;<span class="attribute">box-sizing</span>: border-box; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123; <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> &#123; <span class="attribute">background</span>: <span class="number">#000</span>;<span class="attribute">padding</span>: <span class="number">3px</span>;<span class="attribute">position</span>: fixed;<span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">width</span>: <span class="number">100%</span>; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">input</span> &#123;<span class="attribute">border</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">10px</span>; <span class="attribute">width</span>: <span class="number">90%</span>; <span class="attribute">margin-right</span>: .<span class="number">5%</span> &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">button</span> &#123;<span class="attribute">width</span>: <span class="number">9%</span>;<span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);<span class="attribute">border</span>: none;<span class="attribute">padding</span>: <span class="number">10px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#message</span> &#123;<span class="attribute">list-style-type</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#message</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123; <span class="attribute">background</span>: <span class="number">#eee</span> &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;message&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;m&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">button</span>&gt;</span>送出<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> socket = <span class="title function_">io</span>();</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在console的模式下顯示</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">listening on *:3000</span><br><span class="line">index.js:13</span><br><span class="line">an user connected</span><br><span class="line">index.js:10</span><br><span class="line">an user connected</span><br><span class="line">index.js:10</span><br><span class="line">an user connected</span><br></pre></td></tr></table></figure>

<p>加入<code>disconnect</code>的事件</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;an user connected&#x27;</span>);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;user disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在console的模式下顯示</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">an user connected</span><br><span class="line">index.js:10</span><br><span class="line">user disconnected</span><br><span class="line">index.js:12</span><br><span class="line">an user connected</span><br><span class="line">index.js:10</span><br><span class="line">user disconnected</span><br><span class="line">index.js:12</span><br><span class="line">an user connected</span><br></pre></td></tr></table></figure>

<h3 id="發射事件"><a href="#發射事件" class="headerlink" title="發射事件"></a>發射事件</h3><p>使用JQuery來取得html上的元件和資料來發送聊天訊息在<code>index.html</code>中修改</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>;<span class="attribute">box-sizing</span>: border-box; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123; <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> &#123; <span class="attribute">background</span>: <span class="number">#000</span>;<span class="attribute">padding</span>: <span class="number">3px</span>;<span class="attribute">position</span>: fixed;<span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">width</span>: <span class="number">100%</span>; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">input</span> &#123;<span class="attribute">border</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">10px</span>; <span class="attribute">width</span>: <span class="number">90%</span>; <span class="attribute">margin-right</span>: .<span class="number">5%</span> &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">button</span> &#123;<span class="attribute">width</span>: <span class="number">9%</span>;<span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);<span class="attribute">border</span>: none;<span class="attribute">padding</span>: <span class="number">10px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123; <span class="attribute">list-style-type</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span> &#123; <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123; <span class="attribute">background</span>: <span class="number">#eee</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123; <span class="attribute">margin-bottom</span>: <span class="number">40px</span> &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;m&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">button</span>&gt;</span>送出<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-1.11.1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> socket = <span class="title function_">io</span>();</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;form&#x27;</span>).<span class="title function_">submit</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                e.<span class="title function_">preventDefault</span>();<span class="comment">//prevent page reloading</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> msg=$(<span class="string">&#x27;#m&#x27;</span>).<span class="title function_">val</span>()</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(msg);</span></span><br><span class="line"><span class="language-javascript">                socket.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>, msg);</span></span><br><span class="line"><span class="language-javascript">               </span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#m&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>index.js</code>中修改</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 有client連線</span></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;an user connected&#x27;</span>);</span><br><span class="line">    <span class="comment">//client斷線</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;user disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//接收到事件</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;message: &#x27;</span>+ msg);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="廣播訊息"><a href="#廣播訊息" class="headerlink" title="廣播訊息"></a>廣播訊息</h4><p>要將訊息傳給client端可以使用<code>emit</code>這個功能,使用如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">socket.<span class="property">broadcast</span>.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,msg);<span class="comment">//除了自已不會收到，其餘的會收到</span></span><br><span class="line">io.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,msg);<span class="comment">//全部都會收到，包括自已</span></span><br></pre></td></tr></table></figure>

<p>在<code>index.js</code>中</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 有client連線</span></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    socket.<span class="property">broadcast</span>.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="string">&#x27;hi&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;an user connected&#x27;</span>);</span><br><span class="line">    <span class="comment">//client斷線</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;user disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">        <span class="comment">//console.log(&#x27;message: &#x27;+ msg);</span></span><br><span class="line">        <span class="comment">//收到訊息後，回傳給自已</span></span><br><span class="line">        io.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,msg);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在<code>index.html</code>中</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;m&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">button</span>&gt;</span>送出<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-1.11.1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> socket = <span class="title function_">io</span>();</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;form&#x27;</span>).<span class="title function_">submit</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                e.<span class="title function_">preventDefault</span>();<span class="comment">//prevent page reloading</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> msg=$(<span class="string">&#x27;#m&#x27;</span>).<span class="title function_">val</span>()</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;發射:&#x27;</span>+msg);</span></span><br><span class="line"><span class="language-javascript">                socket.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>, msg);</span></span><br><span class="line"><span class="language-javascript">               </span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#m&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">on</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&#x27;</span>+msg);</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(msg));</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);    </span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>







]]></content>
      <categories>
        <category>記錄</category>
        <category>Nodejs</category>
      </categories>
      <tags>
        <tag>Nodejs</tag>
        <tag>socket.io</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄Nodejs的基本使用</title>
    <url>/%E8%A8%98%E9%8C%84Nodejs%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h4 id="先建立網頁的框架"><a href="#先建立網頁的框架" class="headerlink" title="先建立網頁的框架"></a>先建立網頁的框架</h4><h5 id="安裝Node-js"><a href="#安裝Node-js" class="headerlink" title="安裝Node.js"></a>安裝Node.js</h5><p>我們使用Node.js的web框架是<code>express</code>,首先先確定Node.js有安裝，我是在Win10下開發的所以到nodejs的<a href="https://nodejs.org/en/">官網</a>下載LTS版通常是下一步，可以安裝完成，在命令列中可以下<code>node -v</code>可以看到版本，目前我使用的版本為<code>v10.15.3</code></p>
<h4 id="設定package-json"><a href="#設定package-json" class="headerlink" title="設定package.json"></a>設定package.json</h4><p>先建立一個資料夾叫helloexpress, 在到它的目錄下使用命令列，下下面的指令<code>npm init</code>先建立<code>package.json</code>,它會問些問題，會將資料寫入<code>package.json</code>按照需要輸入或是直接按下不輸入</p>
<h4 id="安裝express"><a href="#安裝express" class="headerlink" title="安裝express"></a>安裝express</h4><p>在命令列下<code>npm install --save express</code>,它會建立<code>node_modules</code>的資料夾和將相關的程式碼放到此目錄</p>
<h4 id="建立index-js"><a href="#建立index-js" class="headerlink" title="建立index.js"></a>建立index.js</h4><p>在和<code>package.json</code>的相同目錄下，建立<code>index.js</code>，這是程式執行的地方輸入如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;&lt;h1&gt;Hello express&lt;/h1&gt;&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on *:3000&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在命令列下輸入<code>node index.js</code>接下來在瀏覽器中輸入<code>http://127.0.0.1:3000</code>在瀏覽器的畫面會顯示<code>&lt;h1&gt;Hello express&lt;/h1&gt;</code></p>
<h4 id="後記"><a href="#後記" class="headerlink" title="後記"></a>後記</h4><p>因為我是在<code>vscode</code>中執行，可以直接在上面可以執行單步偵錯，如下圖所示</p>
<img src="2019-05-06_10_09_29_Image.jpg" style="zoom:80%;" />


]]></content>
      <categories>
        <category>記錄</category>
        <category>Nodejs</category>
      </categories>
      <tags>
        <tag>Nodejs</tag>
      </tags>
  </entry>
  <entry>
    <title>學習RxJS的應用</title>
    <url>/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E6%87%89%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E6%87%89%E7%94%A8/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>  來記錄一些看到RxJS會常在專案上有使用到的操作或使用方法來記錄和學習一下<br> <span id="more"></span> </p>
<h2 id="RxJS-map的用法"><a href="#RxJS-map的用法" class="headerlink" title="RxJS map的用法"></a>RxJS map的用法</h2><p>RxJS 提供的 <code>map()</code> operator 跟我們在 JavaScript 使用的 <code>map()</code> 非常類似，不同的是 JavaScript 的 <code>map()</code> 是<strong>將一個陣列換成另外一個陣列</strong>，而 RxJS 則是<strong>將一個訂閱可以得到的資料轉換成另外一筆資料</strong>例如收到下面的json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">39</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;model&quot;</span><span class="punctuation">:</span><span class="string">&quot;MR820x&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="string">&quot;1.00.0811(183d)&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;fw_upload_time&quot;</span><span class="punctuation">:</span><span class="number">2020</span><span class="number">-04</span><span class="number">-20</span>T10<span class="punctuation">:</span><span class="number">14</span><span class="punctuation">:</span><span class="number">17</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;key_image&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>但是我們只需要</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">39</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;model&quot;</span><span class="punctuation">:</span><span class="string">&quot;MR820x&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="string">&quot;1.00.0811(183d)&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;fw_upload_time&quot;</span><span class="punctuation">:</span><span class="number">2020</span><span class="number">-04</span><span class="number">-20</span>T10<span class="punctuation">:</span><span class="number">14</span><span class="punctuation">:</span><span class="number">17</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以使用map來轉換</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">FirmWareService</span> &#123;</span><br><span class="line">  api = <span class="string">`<span class="subst">$&#123;environment.apiUrl&#125;</span>/ota`</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient</span>) &#123; &#125;</span><br><span class="line">  <span class="title class_">Gets</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="built_in">any</span>&gt;(<span class="variable language_">this</span>.<span class="property">api</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">firmWareService</span>.<span class="title class_">Gets</span>().<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="comment">//tap(data =&gt; console.log(data)), // 在 map() 前先印一次資料</span></span><br><span class="line">      <span class="comment">//轉換成另一個需要的資料</span></span><br><span class="line">      <span class="title function_">map</span>(<span class="function"><span class="params">items</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> trsdata = items.<span class="title function_">map</span>(<span class="function"><span class="params">obj</span> =&gt;</span> (&#123;</span><br><span class="line">          <span class="attr">fw_upload_time</span>: <span class="title function_">moment</span>(obj.<span class="property">fw_upload_time</span>).<span class="title function_">format</span>(<span class="string">&#x27;YYYY/MM/DD HH:MM&#x27;</span>),</span><br><span class="line">          <span class="attr">version</span>: obj.<span class="property">version</span>,</span><br><span class="line">          <span class="attr">model</span>: obj.<span class="property">model</span>,</span><br><span class="line">          <span class="attr">id</span>: obj.<span class="property">id</span>,</span><br><span class="line">        &#125;));</span><br><span class="line">        <span class="keyword">return</span> trsdata</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    ).<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(data);</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">fwFilesDataSource</span>.<span class="property">data</span> = data;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        <span class="comment">//this.messageboxService.ResponseErrorMsg(error);</span></span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<p>在subscribe收到的data就是我們轉換後的資料</p>
<p>參考資料<a href="https://wellwind.idv.tw/blog/2018/11/13/mastering-angular-29-angular-with-rxjs-basic/">在 Angular 中應用 RxJS 的 operators (1) - 基礎篇</a></p>
<h2 id="RxJS-http-get的用法"><a href="#RxJS-http-get的用法" class="headerlink" title="RxJS http get的用法"></a>RxJS http get的用法</h2><p>在RxJS裏使用get代入參數的用法，使用<code>HttpParams()</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">public <span class="title function_">getCarChannellistDetail</span>(<span class="attr">serverip</span>: string, <span class="attr">carnum</span>: string): <span class="title class_">Observable</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> params = <span class="keyword">new</span> <span class="title class_">HttpParams</span>()</span><br><span class="line">      .<span class="title function_">set</span>(<span class="string">&#x27;carnum&#x27;</span>, carnum);</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">url</span>: string = <span class="string">`http://<span class="subst">$&#123;serverip&#125;</span>/nsserver/getchannellistdetail`</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;any&gt;(url, &#123; params &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在RxJS裏使用get的用法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">public <span class="title function_">getCars</span>(<span class="attr">serverip</span>: string): <span class="title class_">Observable</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">url</span>: string = <span class="string">`http://<span class="subst">$&#123;serverip&#125;</span>/nsserver`</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;any&gt;(url);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>學習</category>
        <category>Angular</category>
        <category>RxJS</category>
      </categories>
      <tags>
        <tag>RxJS</tag>
      </tags>
  </entry>
  <entry>
    <title>學習Rxjs的相關使用</title>
    <url>/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>學習一下Rxjs的相關使用,目前的範例大多是v5之前，所以記錄和學習v6的相關修改</p>
<p>以下的例子可以看到，當<code>b$</code>和<code>c$</code>有變化時，<code>a$</code>也會跟著變化</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b$ = <span class="title function_">from</span>([<span class="number">1</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="keyword">var</span> c$ = <span class="title function_">from</span>([<span class="number">2</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="keyword">var</span> a$ = <span class="title function_">zip</span>(b$, c$, <span class="function">(<span class="params">b, c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;b=&#x27;</span> + b);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;c=&#x27;</span> + c);</span><br><span class="line">    <span class="keyword">return</span> b + c;</span><br><span class="line">&#125;);</span><br><span class="line">a$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">a</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;a=&#x27;</span> + a);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//b=1 ​​​​​at ​​​&#x27;b=&#x27; + b​​​</span></span><br><span class="line"><span class="comment">//c=2 ​​​​​at ​​​&#x27;c=&#x27; + c​​​ </span></span><br><span class="line"><span class="comment">//a=3 ​​​​​at ​​​&#x27;a=&#x27; + a​​​ </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//b=3 ​​​​​at ​​​&#x27;b=&#x27; + b​​​ </span></span><br><span class="line"><span class="comment">//c=2 ​​​​​at ​​​&#x27;c=&#x27; + c​​​ </span></span><br><span class="line"><span class="comment">//a=5 ​​​​​at ​​​&#x27;a=&#x27; + a​​​ </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="RxJS的使用參考"><a href="#RxJS的使用參考" class="headerlink" title="RxJS的使用參考"></a>RxJS的使用參考</h3><ol>
<li><p>創建Obserable的方法</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span>, <span class="title class_">Subject</span>, asapScheduler, pipe, <span class="keyword">of</span>, <span class="keyword">from</span>, interval, merge, fromEvent, <span class="title class_">SubscriptionLike</span>, <span class="title class_">PartialObserver</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>操作符operators</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; map, filter, scan &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>websocket</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; webSocket &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/webSocket&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>ajax</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ajax &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/ajax&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>代表流的變量用＄符號結尾，是RxJS中的一種慣例</strong></p>
<h3 id="RxJS要點"><a href="#RxJS要點" class="headerlink" title="RxJS要點"></a>RxJS要點</h3><p>RxJS有一個核心和三個重點，一個核心是<code>Obserable</code> 再加上相關的<code>Operators</code>,三個重點分別是<code>Observer</code>,<code>Subject</code>,<code>Schedulers</code>。</p>
<h3 id="什麼是-Observable"><a href="#什麼是-Observable" class="headerlink" title="什麼是 Observable"></a>什麼是 Observable</h3><p>在文檔中說的<strong>Observable</strong>更確切的說法是<strong>Observable Stream</strong>，也就是Rx的響應式數據流。</p>
<p>在RxJS中<strong>Observable</strong>是可被觀察者，觀察者則是<strong>Observer</strong>，它們通過Observable的subscribe方法進行關聯</p>
<p>前面提到了RxJS結合了觀察者模式和迭代器模式</p>
<p>對于觀察者模式，我們其實比較熟悉的比如各種DOM事的監聽，也是觀察者模式的一種實踐。核心就是發佈者發佈事件，觀察者選擇時機去訂閱(subscibe)事件。</p>
<p>在ES6中Array,String等可遍歷的數據結構原生部署了迭代器(iterator)接口</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">const</span> iterator= numbers[<span class="title class_">Symbol</span>.<span class="property">iterator</span>]();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(iterator.<span class="title function_">next</span>());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(iterator.<span class="title function_">next</span>());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(iterator.<span class="title function_">next</span>());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(iterator.<span class="title function_">next</span>());</span><br><span class="line"><span class="comment">//&#123; value: 1, done: false &#125; </span></span><br><span class="line"><span class="comment">//&#123; value: 2, done: false &#125; </span></span><br><span class="line"><span class="comment">//&#123; value: 3, done: false &#125; </span></span><br><span class="line"><span class="comment">//&#123; value: undefined, done: true &#125; </span></span><br></pre></td></tr></table></figure>

<p>觀察者模式和迭代器模式的相同之處是兩者都是漸進式使用數據的，只不過從數據使用者的角度來說，觀察者模式數據是推送<strong>push</strong>過來的，而迭代器模式𣆞自已去拉取<strong>pull</strong>的，Rx中的數據是Observable推送的，觀察者不需要主重去拉取。</p>
<p>Obserable與Array相當類似，都可以看作是Collection只不過Observable是<code>a collection of items over time</code>是隨時間發出的一序列元素，所以下面會看到Obserable的一些操作符與Array的方法極其相似</p>
<h3 id="觀察者模式"><a href="#觀察者模式" class="headerlink" title="觀察者模式"></a>觀察者模式</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//觀察者模式</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">addListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> listener === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">push</span>(listener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;listener 必須是 function&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">removeListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">splice</span>(<span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">indexOf</span>(listener), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">notify</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">listener</span>(message);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> egghead = <span class="keyword">new</span> <span class="title class_">Producer</span>();</span><br><span class="line"><span class="comment">// new 出一個 Producer 實例叫 egghead</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">listerner1</span>(<span class="params">message</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(message + <span class="string">&#x27; from listener1&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">listerner2</span>(<span class="params">message</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(message+ <span class="string">&#x27; from listener2&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">egghead.<span class="title function_">addListener</span>(listerner1);<span class="comment">// 註冊監聽</span></span><br><span class="line">egghead.<span class="title function_">addListener</span>(listerner2);</span><br><span class="line"></span><br><span class="line">egghead.<span class="title function_">notify</span>(<span class="string">&#x27;A new course!!&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h3 id="創建Observable"><a href="#創建Observable" class="headerlink" title="創建Observable"></a>創建Observable</h3><p>要創建一個Observable，只要給<strong>new Observable</strong>傳遞一個接收<strong>observer</strong>參數的回調函數，在這個函數中去定義如何發送數據</p>
<h4 id="同步的例子"><a href="#同步的例子" class="headerlink" title="同步的例子"></a>同步的例子</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//創建Observable</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> source$ = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//發射數據</span></span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> observercb = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">item</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(item)</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">source$.<span class="title function_">subscribe</span>(observercb)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>另一種寫法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="comment">//建立流物件</span></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//發射數據</span></span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//訂閱它</span></span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="異步的例子"><a href="#異步的例子" class="headerlink" title="異步的例子"></a>異步的例子</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> source$ = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> number = <span class="number">1</span></span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(number++)</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> source$ = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> number = <span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> message = &#123;</span><br><span class="line">        <span class="attr">count</span>: number,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;message &quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        number++;</span><br><span class="line">        message.<span class="property">count</span> = number;</span><br><span class="line">        observer.<span class="title function_">next</span>(message)</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>Obserable</strong>同時可以處理同步與非同步的行為</p>
<h3 id="觀察者Observer"><a href="#觀察者Observer" class="headerlink" title="觀察者Observer"></a>觀察者Observer</h3><p>Obserable可以被訂閱(subscirbe)或說可以被觀察，而訂閱Obserable的物件又稱為**觀察者(Observer)**。觀察者是一個具有三個方法(method)的物件，每當Obserable發生事件時，更會呼叫觀察者相對應方法。</p>
<blockquote>
<p>意這裡的觀察者(Observer)跟上一篇講的觀察者模式(Observer Pattern)無關，觀察者模式是一種設計模式，是思考問題的解決過程，而這裡講的觀察者是○被定義的物件。</p>
</blockquote>
<p>觀察者的三個方法(method):</p>
<ul>
<li><p>next:每當Obserable發送出新的值，next方法就會被呼叫。</p>
</li>
<li><p>complete:在Obserable沒有其他的資料可以取得時，complete方法就會被呼叫，在complete被呼叫之後，next方法就不會再起作用。</p>
</li>
<li><p>error:每𡮝Obserable內發生錯誤時，error方法就會被呼叫。</p>
</li>
</ul>
<p>說了這麼多，我們還是直接來建立一個觀察者吧！</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> observable$= <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function">(<span class="params">observer</span>)=&gt;</span>&#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//宣告一個觀察者，具備next , error, complete 三個方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observer =&#123;</span><br><span class="line">    <span class="attr">next</span>:<span class="keyword">function</span>(<span class="params">value</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>:<span class="keyword">function</span>(<span class="params">error</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用我們定義好的觀察者，來訂閱這個observale</span></span><br><span class="line">observable$.<span class="title function_">subscribe</span>(observer);</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼會印出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Jerry ​​​​​at ​​​value​​​ ​day05rxjs.js:13:8​</span><br><span class="line">Anna ​​​​​at ​​​value​​​ ​day05rxjs.js:13:8​</span><br><span class="line">complete ​​​​​at ​day05rxjs.js:19:8​</span><br></pre></td></tr></table></figure>

<p>上面的範例可以看得出來在complete執行後，next就會自動失效，所以沒有印出<code>not work</code> 。</p>
<p>下面則是送出錯誤的範例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> observable$ = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function">(<span class="params">observer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line">        observer.<span class="title function_">next</span>(<span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&#x27;some exception&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        observer.<span class="title function_">error</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 宣告一個觀察者，具備 next,error,complete 三個方法</span></span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span>, error);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 用我們定義好的觀察者，來訂閱這個observable</span></span><br><span class="line">observable$.<span class="title function_">subscribe</span>(observer);</span><br></pre></td></tr></table></figure>

<p>會印出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Jerry </span><br><span class="line">Anna </span><br><span class="line">Error:  some exception </span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>這裡就會執行error的function印印出<code>Error:  some exception</code></p>
<blockquote>
<p>有時候Observable會是一個無限的序列，例如click事件，這時<code>complete</code>方法就有可能永遠不會被呼叫！</p>
</blockquote>
<p>我們也可以直接把next,error,complete三個function依序傳入<code>obserable.subscrive</code>如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">observable$.<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">value</span> =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span>, error); &#125;,</span><br><span class="line">    <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="實作細節"><a href="#實作細節" class="headerlink" title="實作細節"></a>實作細節</h3><p>我們之前提到了，其實Observable的訂閱跟addEventListener在實作上有蠻大的差異，雖然他們的行為很像！</p>
<p>addEventListener本質上就是Observer Pattern的實作，在內部會有一份訂閱清單，像是我們實作的Producer</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">addListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> listener === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">push</span>(listener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;listener 必須是 function&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">removeListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">splice</span>(<span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">indexOf</span>(listener), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">notify</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">listener</span>(message);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們在內部儲存了一份所有的監聽者清單’this.listeners’，在要發佈通知時會對逐一的呼叫這份清單的監聽者。</p>
<p>但在Observable不是這樣實作的，在其內部沒有一份訂閱者的清單。訂閱Observable的行無比較像是執行一個物件的方法，並把資料傳進這個方法。</p>
<p>我們以下面的程式碼做說明</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable$ = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function">(<span class="params">observer</span>) =&gt;</span> &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">observable$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>像上面這段程式，他的行為比較像這樣</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">subscribe</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡可以看到subscribe是一個function，這個function執行時會傳入觀察者，而我們在這個function內部去執行觀察者的方法。</p>
<p><strong>訂閱一個Observable就像是執行一個function</strong></p>
<h3 id="建立-Observable-二"><a href="#建立-Observable-二" class="headerlink" title="建立 Observable(二)"></a>建立 Observable(二)</h3><p>Obaerable有許多創建實例的方法，稱為creation operator，下面會有RxJS常用的creation operator</p>
<h4 id="of"><a href="#of" class="headerlink" title="of"></a>of</h4><p>當我們想要<strong>同步的</strong>傳遞幾個值時，就可以用<code>of</code>這個opertor來簡潔的表達</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">of</span>(<span class="string">&#x27;Jery&#x27;</span>, <span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="from"><a href="#from" class="headerlink" title="from"></a>from</h4><p>其實<code>of</code>operator的一個一個參數其實就是一個list，而list在JavaScript中最常見的形式是陣列(array) ,那我們可以用<code>from</code>來按收任何可列舉的參數</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Jerry&#x27;</span>, <span class="string">&#x27;Anna&#x27;</span>, <span class="number">2016</span>, <span class="number">2017</span>, <span class="string">&#x27;30 days&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(arr);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//結果</span></span><br><span class="line"><span class="comment">//Jerry </span></span><br><span class="line"><span class="comment">//Anna </span></span><br><span class="line"><span class="comment">//2016 </span></span><br><span class="line"><span class="comment">//2017 </span></span><br><span class="line"><span class="comment">//30 days </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>記得任何可列舉的參數可以用，也就是說像Set,WeakSet,Iterator等都可以當作參數</p>
<blockquote>
<p>因為ES6出現後可列舉(iterable)的型別變多了，所以<code>fromArray</code>就被移除了。</p>
</blockquote>
<p>另外<code>from</code>還能接收字串(string)</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(<span class="string">&#x27;鐵人賽&#x27;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//結果</span></span><br><span class="line"><span class="comment">//鐵 </span></span><br><span class="line"><span class="comment">//人 </span></span><br><span class="line"><span class="comment">//賽 </span></span><br><span class="line"><span class="comment">//complete </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也可以傳入Promise物件</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&#x27;Hello RxJs&#x27;</span>);</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//結果</span></span><br><span class="line"><span class="comment">// Hello RxJs </span></span><br><span class="line"><span class="comment">// complete </span></span><br></pre></td></tr></table></figure>

<h4 id="fromEvent"><a href="#fromEvent" class="headerlink" title="fromEvent"></a>fromEvent</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> source = <span class="title class_">Rx</span>.<span class="property">Observable</span>.<span class="title function_">fromEvent</span>(<span class="variable language_">document</span>.<span class="property">body</span>, <span class="string">&#x27;click&#x27;</span>);</span><br><span class="line"></span><br><span class="line">source.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="fromEventPattern"><a href="#fromEventPattern" class="headerlink" title="fromEventPattern"></a>fromEventPattern</h5><p>要用 Event 來建立 Observable 實例還有另一個方法 <code>fromEventPattern</code>，這個方法是給類事件使用。所謂的類事件就是指其行為跟事件相像，同時具有註冊監聽及移除監聽兩種行為，就像 DOM Event 有 <code>addEventListener</code> 及 <code>removeEventListener</code> 一樣！舉一個例子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEventPattern &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">addListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> listener === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">push</span>(listener)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;listener 必須是 function&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">removeListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">splice</span>(<span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">indexOf</span>(listener), <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">notify</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">listener</span>(message);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ------- 以上都是之前的程式碼 -------- //</span></span><br><span class="line"><span class="keyword">var</span> egghead = <span class="keyword">new</span> <span class="title class_">Producer</span>();</span><br><span class="line"><span class="comment">// egghead 同時具有 註冊監聽者及移除監聽者 兩種方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEventPattern</span>(</span><br><span class="line">    <span class="function">(<span class="params">handler</span>) =&gt;</span> egghead.<span class="title function_">addListener</span>(handler),</span><br><span class="line">    <span class="function">(<span class="params">handler</span>) =&gt;</span> egghead.<span class="title function_">removeListener</span>(handler)</span><br><span class="line"></span><br><span class="line">);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">egghead.<span class="title function_">notify</span>(<span class="string">&#x27;Hello! Can you hear me?&#x27;</span>);</span><br><span class="line"><span class="comment">//結果 Hello! Can you hear me? </span></span><br></pre></td></tr></table></figure>

<p>上面的程式碼可以看到，<code>egghead</code> 是 <code>Producer</code> 的實例，同時具有 註冊監聽及移除監聽兩種方法，我們可以將這兩個方法依序傳入 <code>fromEventPattern</code> 來建立 Observable 的物件實例！</p>
<blockquote>
<p>這裡要注意不要直接將方法傳入，避免 this 出錯！也可以用 <code>bind</code> 來寫。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Rx.Observable</span><br><span class="line">    .fromEventPattern(</span><br><span class="line">        egghead.addListener.bind(egghead), </span><br><span class="line">        egghead.removeListener.bind(egghead)</span><br><span class="line">    )</span><br><span class="line">    .subscribe(console.log)</span><br></pre></td></tr></table></figure>

<h4 id="empty-never-throw"><a href="#empty-never-throw" class="headerlink" title="empty,never,throw"></a>empty,never,throw</h4><p>有點像是數學上的**零(0)**，雖然有時候好像沒什麼，但卻非常的重要。在Observable的世界裡也有類似的東西，像是<code>empty</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">empty</span>();</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>:<span class="keyword">function</span>(<span class="params">value</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p><code>empty</code> 會給我們一個<strong>空</strong>的 observable，如果我們訂閱這個 observable 會發生什麼事呢？ 它會立即送出 complete 的訊息！</p>
<blockquote>
<p>可以直接把 <code>empty</code> 想成沒有做任何事，但它至少會告訴你它沒做任何事。</p>
</blockquote>
<p>數學上還有一個跟零(0)很像的數，那就是<strong>無窮(∞)</strong>, 在Observable的世界裡我們用 <code>never</code> 來建立無窮的 observable</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; never &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">never</span>();</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>never 會給我們一個無窮的 observable，如果我們訂閱它又會發生什麼事呢？…什麼事都不會發生，它就是一個一直存在但卻什麼都不做的 observable。</p>
<blockquote>
<p>可以把 never 想像成一個結束在無窮久以後的 observable，但你永遠等不到那一天！</p>
</blockquote>
<blockquote>
<p>題外話，筆者一直很喜歡平行線的解釋： 兩條平行線就是它們相交於無窮遠</p>
</blockquote>
<p>最後還有一個 operator <code>throw</code>，它也就只做一件事就是拋出錯誤。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; throwError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">throwError</span>(<span class="string">&#x27;Oop!&#x27;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Throw Error: Oop!</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼就只會 log 出 <code>&#39;Throw Error: Oop!&#39;</code>。</p>
<h4 id="interval-timer"><a href="#interval-timer" class="headerlink" title="interval,timer"></a>interval,timer</h4><p>接著我們要看兩個跟時間有關的operators、在JS中我們可以用<code>setInterval</code>來建立一個持續的行為，這也能用在Observable中</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(i++);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，會每隔一秒送出一個從零開始遞增的整數，在Observable的世界也有一個operator可以更方便地做到這件事，就是<code>interval</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p><code>interval</code>有一個參數是數值(Number), 這數值代表發出訊號的間隔時間(ms), 這兩段程式碼基本上是等價的會持續每隔一秒送出一個從零開始遞增的數值</p>
<p>另外有一很相似的operator叫<code>timer</code>,<code>timer</code>可以給兩個參數，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; timer &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">timer</span>(<span class="number">1000</span>, <span class="number">5000</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>當<code>timer</code>有兩個參數時，第一個參數代表要發出第一個值的等待時間(ms),第二個參數代表第一次之後發送值的間隔時間，所以上面這段程式碼會先等一秒送出0之後每5秒送出1，2，3，4…</p>
<p><code>timer</code>第一個參睥除了可以是數值(Number)之外，也可以是日期(Date), 就會等到指定的時間在發送䇪一個值。</p>
<p>另外<code>timer</code>也可以只接收一個參數</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; timer &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">timer</span>(<span class="number">1000</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼就會等一秒後送出1同時通知結束。</p>
<h4 id="Subscription"><a href="#Subscription" class="headerlink" title="Subscription"></a>Subscription</h4><p>有提到很多無窮的Observable，例如interval,never。但有時候我們可能會在某些行為後不需要這些資源，要做到這件事最簡單的方法就是<code>unsubscribe</code>。</p>
<p>其實在訂閱Observable後，會回傳一個subscription物件，這個物件具有釋放資源的<code>unsubscribe</code>方法。範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; timer &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">timer</span>(<span class="number">1000</span>, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//取得subscription</span></span><br><span class="line"><span class="keyword">var</span> subscription = source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscription.<span class="title function_">unsubscribe</span>();<span class="comment">//停止訂閱(退訂)</span></span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2 </span></span><br><span class="line"><span class="comment">//3 </span></span><br></pre></td></tr></table></figure>

<p>這裡我們用了<code>setTimeout</code>在5秒後，執行了<code>subscription.unsubscribe()</code>來停止訂閱並釋放資源。另外subscription物件還有其他合併訂閱等作用。</p>
<blockquote>
<p>Events observable盡畫不要用<code>unsubscribe</code>,通常我們會使用<code>takeUntil</code>,在某個載件發生後來完成Eventobservable</p>
</blockquote>
<h3 id="Observable-Operators-Marble-Diagrams"><a href="#Observable-Operators-Marble-Diagrams" class="headerlink" title="Observable Operators &amp; Marble Diagrams"></a>Observable Operators &amp; Marble Diagrams</h3><blockquote>
<p>Observable的Operators是實數應用上最重要的部份，我們需要了解各種Operators的使用方式，才能輕鬆實作各種需求！</p>
</blockquote>
<p>關於轉換(Transformation)、過濾(Filter)、合併(Combination)等操作方法，先來知道什麼是Operator</p>
<h4 id="什麼是Operator"><a href="#什麼是Operator" class="headerlink" title="什麼是Operator?"></a>什麼是Operator?</h4><p>Operators就是一個個被附加到Observable型別的函式，例如像是mag,filter,contactall…等等，所有這些函式都拿到原來的Observable並回傳一個新的observable，有像下面的樣子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span>, <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> people = <span class="title function_">of</span>(<span class="string">&quot;Jerry&quot;</span>, <span class="string">&quot;Anna&quot;</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">map</span>(<span class="params">source$, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function">(<span class="params">observer</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> source$.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                observer.<span class="title function_">next</span>(<span class="title function_">callback</span>(value));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                observer.<span class="title function_">error</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">            <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; observer.<span class="title function_">error</span>(e); &#125;,</span><br><span class="line">            <span class="function">() =&gt;</span> &#123; observer.<span class="title function_">complete</span>(); &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> helloPeople = <span class="title function_">map</span>(people, <span class="function">(<span class="params">item</span>) =&gt;</span> item + <span class="string">&quot; Hello~&quot;</span>);</span><br><span class="line">helloPeople.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br><span class="line"><span class="comment">//Jerry Hello~ ​​​​​</span></span><br><span class="line"><span class="comment">// Anna Hello~ ​​​​​</span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到我們寫了一個map的函式，它接收兩個參數，第一個是原本的observable, 䇪二個是map的callback function。map內部第一件事就是用<code>create</code>建立一個新的observable並回傳，並且在內部訂閱原本的observable。</p>
<p>這裡有兩個重點是我們一定要知道的，每個operator都會回傳一個新的ooservable,而我們可以透過<code>create</code>的方法建立各種operator</p>
<p>我們需要先訂定一個簡單的方式來表達observable</p>
<h4 id="Marble-diagrams"><a href="#Marble-diagrams" class="headerlink" title="Marble diagrams"></a>Marble diagrams</h4><p>我們在傳達事物時，文字其實是最糟的手段，雖然文字是我們平時溝通的基礎，但常常千言萬語也比不過一張清楚的圖。如果我們能訂定observable的圖示，就能讓我自更方便的溝通及理解observable的各種operators!</p>
<p>我們把描繪 observable 的圖示稱為 Marble diagrams，在網路上 RxJS 有非常多的 Marble diagrams，規則大致上都是相同的，這裡為了方便撰寫以及跟讀者的留言互動，所以採用類似 ASCII 的繪畫方式。</p>
<p>我們用<code>-</code>來表達一小段時𫂾，這些<code>-</code>串起來就代表一個observable</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-----------</span><br></pre></td></tr></table></figure>

<p><code>X</code>(大寫X)則代表有錯誤發生</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-----------X</span><br></pre></td></tr></table></figure>

<p><code>|</code>則代表observable結束</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-----------|</span><br></pre></td></tr></table></figure>

<p>在這個時間序當中，我們可能會發出值(value), 如果值是數字則直接用阿拉伯數字取代，其他的資料型別則用相近的英文符號代表，𫍇裡我們用<code>interval</code>舉例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> source$=<span class="title function_">interval</span>(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p><code>source$</code>的圖型就會長像這樣</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">----0-----1-----2-----3--...</span><br></pre></td></tr></table></figure>

<p> 當observable是同步送值的時候，例如</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> source$=<span class="title function_">of</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p><code>source$</code>的圖形就會長像這樣</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(1234)|</span><br></pre></td></tr></table></figure>

<p>小括號代表著同步發生</p>
<p>另外的Marble diagrams也能夠表達operator的前後轉換，例如</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> source=<span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> newest =source.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>這時候Marble diagrams就會長像這樣</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>: -----0-----1-----2-----3--...</span><br><span class="line">            map(x =&gt; x + 1)</span><br><span class="line">newest: -----1-----2-----3-----4--...</span><br></pre></td></tr></table></figure>

<p>最上面原本的observable, 中間是operator，下面則是新的observable</p>
<p>Marble Diagrams 相關資源：<a href="http://rxmarbles.com/">http://rxmarbles.com/</a></p>
<h4 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h4><h5 id="map"><a href="#map" class="headerlink" title="map"></a>map</h5><p>Observable的map方法使用上跟陣列的map是一樣的，我們傳入一個callback function，這個callback function會帶入每次發送出來的元素，然後我們回傳新的元素</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> newest$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line">newest$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">//2 ​​​​​</span></span><br><span class="line"><span class="comment">//3 ​​​​​</span></span><br><span class="line"><span class="comment">//4 ​​​​​</span></span><br><span class="line"><span class="comment">//5 ... ​​​​​</span></span><br></pre></td></tr></table></figure>

<p>用Marble diagrams表達就是</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>: -----0-----1-----2-----3--...</span><br><span class="line">			map(x =&gt; x + 2)</span><br><span class="line">newest: -----2-----3-----4-----5--...			</span><br></pre></td></tr></table></figure>

<p>有另外一個方法跟map很像叫mapTo</p>
<h5 id="mapTo"><a href="#mapTo" class="headerlink" title="mapTo"></a>mapTo</h5><p>mapTo可把傳進來的值改成一固定的值</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mapTo &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> newest$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">mapTo</span>(<span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line">newest$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">//2 ​​​​​</span></span><br><span class="line"><span class="comment">//2 ​​​​​</span></span><br><span class="line"><span class="comment">//2 ....</span></span><br></pre></td></tr></table></figure>

<p>mapTo用Marble diagrams表達</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>: -----0-----1-----2-----3--...</span><br><span class="line">			mapTo(2)</span><br><span class="line">newest: -----2-----2-----2-----2--...			</span><br></pre></td></tr></table></figure>

<h5 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h5><p>filter在使用上也跟陣列的相同，我們要傳入一個callback function，這個function會傳入每個被送出的元素，並且回傳一個boolean值，如果為true的話就會保留，如果為false就會被濾掉</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mapTo, filter &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> newest$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">filter</span>(<span class="function"><span class="params">x</span> =&gt;</span> x % <span class="number">2</span> === <span class="number">0</span>)</span><br><span class="line">);</span><br><span class="line">newest$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">//0 ​​​​​</span></span><br><span class="line"><span class="comment">//2 ​​​​​</span></span><br><span class="line"><span class="comment">//4 ​​​​​</span></span><br><span class="line"><span class="comment">//6 ...</span></span><br></pre></td></tr></table></figure>

<p>filter用Marble diagrams表達</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source: -----0-----1-----2-----3-----4--...</span><br><span class="line">			filter(x =&gt; x%2 === 0)</span><br><span class="line">newest: -----0-----------2-----------4---...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>map ,filter這些方法其實都跟陣列的相同，因為這些都是fucntional programming的通用函式。</p>
</blockquote>
<blockquote>
<p>實際上Observable跟Array的operators(map,filter)，在行為上還是有極大的差異，當我們的資料量很大時，Observable的效能會好上非常多。</p>
</blockquote>
<h5 id="take"><a href="#take" class="headerlink" title="take"></a>take</h5><p>take 是一個很簡單的operator, 顧名思義就是取前幾個元素後就結束</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mapTo, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2 </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到我們的<code>source$</code>原本是會發出無限元素的，但這裡我們用<code>take(3)</code>就會只取前3個元素，取完後就直接結束(complete), 用Marble diagram表如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$:-----0-----1-----2-----3--..</span><br><span class="line">		take(3)</span><br><span class="line">example:-----0-----1-----2|</span><br></pre></td></tr></table></figure>

<h5 id="first"><a href="#first" class="headerlink" title="first"></a>first</h5><p>first會取observable送出的第一個元素之後就直接結束，行為跟takb(1)一樣</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; first, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">first</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>用Marble diagram表示</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source$ :-----0-----1-----2-----3--..</span><br><span class="line">example$:-----0|</span><br></pre></td></tr></table></figure>

<h5 id="takeUntil"><a href="#takeUntil" class="headerlink" title="takeUntil"></a>takeUntil</h5><p>在實數上takeUntil很常使用到，他可以在某件事情發生時，讓一個observable直送出完成(complete)訊息</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, fromEvent &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; first, takeUntil &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> click = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>.<span class="property">body</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(click));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a href="https://stackblitz.com/edit/rxjs-arycee?devtoolsheight=60">stackblitz</a></p>
<p>這裏我們一開始先用<code>interval</code>建立一個observable，這個observable每隔1秒會送出一個從0開𤖥遞增的數值，接著我們用<code>takeUntil</code>,傳人另一個observable.</p>
<p>當<code>tabkeUntil</code>傳入的observable發送值時，原本的observable就會直托進人完成(complete)狀態，並且發送完成訊息。也就是說上面這沒程式碼的行為，會先每一秒印出一個數字(從0遞增)直到我們點擊body為止，他才會送出complete訊息。如果畫成Maribe diagram則會像下面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source$ :-----0-----1-----2-----3--..</span><br><span class="line">click   :---------------------c------</span><br><span class="line">			takeUntil(click)</span><br><span class="line">example$:-----0-----1-----2---|			</span><br></pre></td></tr></table></figure>

<p>當click一發送元素的時候，observable就會直接完縑(complete)</p>
<h5 id="concatAll"><a href="#concatAll" class="headerlink" title="concatAll"></a>concatAll</h5><p>有時我們的Observable送出的元素又是一個observable就像是二維陣列，陣列裡面的元素是陣列，這時我們就可以用<code>concatAll</code> 它攤平成一維陣列，也可以直接把<code>concatAll</code>想成把所有元素concat起來。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span>, fromEvent &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,concatAll &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> click = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>.<span class="property">body</span>, <span class="string">&#x27;click&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">of</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concatAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a href="https://stackblitz.com/edit/rxjs-en1m7j?file=index.ts">stackblitz</a></p>
<p>這個範例我們每點一次body就會立刻送出1,2,3，如果用Marble diagram表示則如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">click  : ------c----------c-----------</span><br><span class="line">		  map(e =&gt; of(1, 2, 3))</span><br><span class="line"><span class="built_in">source</span> : ------o----------o-----------</span><br><span class="line">                \          \</span><br><span class="line">                 (123)|     (123)|</span><br><span class="line">example:-------(123)------(123)-------</span><br></pre></td></tr></table></figure>

<p>這裡可以看到<code>source</code>observable內部每次發送的值也是observable，這時我們用concatAll就可以把source攤平成example</p>
<p>這裡需要注意的是<code>concatAll</code>會處理source先發出來的observable，必須等到這個observable結事，才會再處理下一固source發出來的observable，以下面這個範例說明。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, concatAll &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> obs1$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">var</span> obs2$ = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">2</span>));</span><br><span class="line"><span class="keyword">var</span> obs3$ = <span class="title function_">interval</span>(<span class="number">2000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">of</span>(obs1$, obs2$, obs3$);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concatAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到<code>source</code>會送出3個observable，但是<code>concatAll</code>後的行為永遠都是先處理第一個observable,<strong>等到當前處理的結事後才會再處理下一個</strong></p>
<p>用Marble diagram表示如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source : (o1)               o2     o3)|</span><br><span class="line">           \                 \      \</span><br><span class="line">            --0--1--2--3--4|  -0-1|  ----0|</span><br><span class="line">                 concatAll()</span><br><span class="line">example: --0--1--2--3--4-0-1----0</span><br></pre></td></tr></table></figure>

<h5 id="簡易拖拉"><a href="#簡易拖拉" class="headerlink" title="簡易拖拉"></a>簡易拖拉</h5><p>當看完前面幾個operator後，我們就很輕鬆地做出拖拉的功能，先讓我們來看一下需求</p>
<ol>
<li><p>首先畫面上有一僤元件(#drag)</p>
</li>
<li><p>當滑鼠在元件(#drag)上按下左鍵(mousedwon)時，開始監聽滑鼠移動(mousemove)的位置</p>
</li>
<li><p>當滑鼠左鍵放掉(mouseup)時，結束監聽滑鼠移動</p>
</li>
<li><p>當滑鼠移動(mousemove)被監聽時，跟著修改元件的樣式屬性</p>
</li>
</ol>
<p>第一步如下<br><a href="https://stackblitz.com/edit/rxjs-agprjt">stackblitz</a></p>
<p>第二步我們要先取得各個 DOM 物件，元件(#drag) 跟 body。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> dragDOM = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;drag&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> body = <span class="variable language_">document</span>.<span class="property">body</span>;</span><br></pre></td></tr></table></figure>

<p>要取得body的原因是因為滑鼠移動(moudemove)跟滑鼠左鍵放掉(mouseup)都應該是在整個body監聽</p>
<p>第三步我們寫出各個會用的監聽事件，並用<code>fromEvent</code>來取得各個observable. </p>
<ul>
<li><p>對#drag監聽moudedown</p>
</li>
<li><p>對body監聽mouseup</p>
</li>
<li><p>對body監聽mousemove</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mouseDown = <span class="title function_">fromEvent</span>(dragDOM, <span class="string">&#x27;mousedown&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mouseUp = <span class="title function_">fromEvent</span>(body, <span class="string">&#x27;mouseup&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mouseMove = <span class="title function_">fromEvent</span>(body, <span class="string">&#x27;mousemove&#x27;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>還沒<code>subscribe</code>之前都不會開始監聽，一定會𨬓到subscribe之後obserable才會開始送值</p>
</blockquote>
<p>當mouseDown時，轉成mouseMove的事件</p>
<p>mouseMove要在mouseUp後結束加上<code>takeUntil(mouseup)</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> source = mouseDown.<span class="title function_">pipe</span>(</span><br><span class="line"> <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> mouseMove.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp)))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>這時source大概長像這樣</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>: -------e--------------------e--------</span><br><span class="line">                \                    \</span><br><span class="line">                  --m-m-m-m/           -m--m-m--m-m/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>m 代表mousemove event</p>
</blockquote>
<p>用<code>concatAll()</code>攤平source成一維</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> source = mouseDown.<span class="title function_">pipe</span>(</span><br><span class="line"> <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> mouseMove.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp))),</span><br><span class="line"> <span class="title function_">concatAll</span>()   </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>用map把mousemove event轉成x,y的位置，並且訂閱</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> source = mouseDown.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> mouseMove.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp))),</span><br><span class="line">  <span class="title function_">concatAll</span>(),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> (&#123; <span class="attr">x</span>: event.<span class="property">clientX</span>, <span class="attr">y</span>: event.<span class="property">clientY</span> &#125;))</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="function"><span class="params">pos</span> =&gt;</span> &#123;</span><br><span class="line">  dragDOM.<span class="property">style</span>.<span class="property">left</span> = pos.<span class="property">x</span> + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">  dragDOM.<span class="property">style</span>.<span class="property">top</span> = pos.<span class="property">y</span> + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>雖然這只是一個簡單的拖拉實現，但已經展示出 RxJS 帶來的威力，它讓我們的程式碼更加的簡潔，也更好的維護！</p>
<h5 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h5><p><code>take</code>可以取前幾個送出的元素，而可以略出前幾個送出的元素<code>skip</code>, 範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; skip &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">skip</span>(<span class="number">3</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//3 ​​​​​at ​​​value​​​ ​day09rxjs.js:9​</span></span><br><span class="line"><span class="comment">//4 ​​​​​at ​​​value​​​ ​day09rxjs.js:9​</span></span><br><span class="line"><span class="comment">//5 ...</span></span><br></pre></td></tr></table></figure>

<p>原本從0開𤖥的就會變成從3開𤖥，但是記得原本元素的等得時𫂾仍然存在，也就是說此範例第一個取得的元素需要等4秒，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----0----1----2----3----4----5--...</span><br><span class="line">                skip(3)</span><br><span class="line">example$: -------------------3----4----5--...               </span><br></pre></td></tr></table></figure>

<h5 id="takeLast"><a href="#takeLast" class="headerlink" title="takeLast"></a>takeLast</h5><p>除了可以用<code>take</code>取前幾個之外，我們也可以倒過來取最後幾個，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, takeLast &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">takeLast</span>(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//4 </span></span><br><span class="line"><span class="comment">//5 </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>



<p>這裡我們先取了前6個元素，再取最後兩個，所以最後會送出4,5,complete，有一個重點。就是<code>takeLast</code>必須等到整個observable完成(complete), 才能知道最後的元素有哪些，並且<strong>同步送出</strong>,如果有Marbe Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$  : ----0----1----2----3----4----5|</span><br><span class="line">                    takeLast(2)</span><br><span class="line">example$ : ------------------------------(45)|                    </span><br></pre></td></tr></table></figure>

<p>可以看到takeLast後，必需等到原本的observable完成後，才立即同步送出4,5,complete</p>
<h5 id="last"><a href="#last" class="headerlink" title="last"></a>last</h5><p>跟<code>take(1)</code>相同，我們有一個<code>takeLast(1)</code>的簡化寫法，那就是<code>last()</code>用來取得最後一個元素</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; last, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"><span class="keyword">let</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">last</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$  : ----0----1----2----3----5|</span><br><span class="line">                   last()</span><br><span class="line">example$ : --------------------------(5)|                   </span><br></pre></td></tr></table></figure>

<h5 id="concat"><a href="#concat" class="headerlink" title="concat"></a>concat</h5><p><code>concat</code>可以把多個observable實例合併成一個</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concat, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">let</span> source2$ = <span class="title function_">of</span>(<span class="number">3</span>);</span><br><span class="line"><span class="keyword">let</span> source3$ = <span class="title function_">of</span>(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concat</span>(source2$, source3$));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>跟<code>concatAll</code>一樣，必須先等前一個observable完成(complete), 才會繼續下一個，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ :----0----1----2|</span><br><span class="line">source2$:(3)|</span><br><span class="line">source3$:(456)|</span><br><span class="line">            concat()</span><br><span class="line">example$:----0-----1----2(3456)|            </span><br></pre></td></tr></table></figure>

<h5 id="startWith"><a href="#startWith" class="headerlink" title="startWith"></a>startWith</h5><p><code>startWith</code>可以在observable的一開始塞要發送的元素，有點像<code>concat</code>但參數不是observable而是要發送的元素</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; startWith &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">let</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">startWith</span>(<span class="number">0</span>));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3...</span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到我們在source$一開始塞了一個<code>0</code>, 讓example$會在一開始就立即送出<code>0</code>，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ :----0----1----2----3--...</span><br><span class="line">             startWith(0)</span><br><span class="line">example :(0)----0----1----2----3-...             </span><br></pre></td></tr></table></figure>

<p>記得 startWith 的值是一開始就同步發出的，這個 operator 很常被用來保存程式的起始狀態！</p>
<h5 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h5><p><code>merge</code>跟<code>concat</code>一樣都是用來合併observable，但他們在行為上有非常大的不同</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, merge &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> source$ = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">let</span> source2$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"><span class="keyword">let</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">merge</span>(source2$));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p><code>merge</code>把多個observable同時處理，這跟<code>concat</code>一次處理一個observable是完全不一樣的，由於是同時處理行為會變得較為複雜，用Marble Diagram會較好解釋</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source$ : ----0----1----2|</span><br><span class="line">source2$: --0--1--2--3--4--5|</span><br><span class="line">                merge()</span><br><span class="line">example$: --0-01--21-3--(24)--5|                </span><br></pre></td></tr></table></figure>

<p>這裡可以看到<code>mergr</code>之後的example在時間序上同時在跑source$與source2$,當兩件事情同時發生時，會同步送出資料(被merge的在後面),當兩個observable都結事時才會真的結束。</p>
<p>merge的邏輯有點像是OR(||)就是當兩個observable其中一個被觸發時都可以被處理，這很常用一個以上的按鈕具有部分相同的行為。</p>
<p>例如一個影片播放器有兩個按鈕，一個是暫停(||) 另一個是結束播放(□)。這兩個按鈕都具有相同的行為就是影片會被停止，只是結束播放會讓影片回到00秒，這時我們就可以把這兩個按鈕的事件merge起來處理影片暫停這件事。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var stopVideo= stopButton.pipe(merge(endbutton));</span><br><span class="line">stopVideo.subscribe(()=&gt;&#123;</span><br><span class="line">    //暫停播放影片</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="combineLatest"><a href="#combineLatest" class="headerlink" title="combineLatest"></a>combineLatest</h5><p>它會取得各個observable最後送出的值，再輸出成一個值</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, combineLatest &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> newest$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">combineLatest</span>(newest$, <span class="function">(<span class="params">x, y</span>) =&gt;</span> x + y));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="comment">// 7</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>看Marble diagram</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----0----1----2|</span><br><span class="line">newest$ : --0--1--2--3--4--5|</span><br><span class="line">    combineLatest(newest$,(x,y)=&gt;x+y);</span><br><span class="line">example$: ----01--23-4--(56)--7|    </span><br></pre></td></tr></table></figure>

<p>首先<code>combineLatest</code>可以接收多個observable,最後一個參數是callback function,這個callback function接收的參睥數量跟合併的observable數量相同，依照範例來說，因為我們這裡合併了兩個observable所以後面的callback function就接教收x,y兩個參數，x會接收從source$發送出來的值，y會接收newest$發送出來的值。</p>
<p>最後一個重點就是一定會等兩個observable都<strong>曾有送值</strong>出來才會呼叫我們傳入的callback，所以這段程式是這樣運行的</p>
<ul>
<li>newest$送出了<code>0</code>, 但此時source$並沒有送出過任何值，所以不會執行callback</li>
<li>source$送出了<code>0</code>,但此時newest$最後一次送出的值為<code>0</code>,把這兩個數傳入callback得到<code>0</code></li>
<li>newest$送出了<code>1</code>此時source$最後一次送出的值為<code>0</code>, 把這兩個數傳入callback得到<code>1</code></li>
<li>newest$送出了 <code>2</code>，此時 source$ 最後一次送出的值為 <code>0</code>，把這兩個數傳入 callback 得到 <code>2</code>。</li>
<li>source$ 送出了 <code>1</code>，此時 newest$ 最後一次送出的值為 <code>2</code>，把這兩個數傳入 callback 得到 <code>3</code>。</li>
<li>newest$ 送出了 <code>3</code>，此時 source$ 最後一次送出的值為 <code>1</code>，把這兩個數傳入 callback 得到 <code>4</code>。</li>
<li>source$ 送出了 <code>2</code>，此時 newest$ 最後一次送出的值為 <code>3</code>，把這兩個數傳入 callback 得到 <code>5</code>。</li>
<li>source$ 結束，但 newest$ 還沒結束，所以 example 還不會結束。</li>
<li>newest$ 送出了 <code>4</code>，此時 source$ 最後一次送出的值為 <code>2</code>，把這兩個數傳入 callback 得到 <code>6</code>。</li>
<li>newest$ 送出了 <code>5</code>，此時 source$ 最後一次送出的值為 <code>2</code>，把這兩個數傳入 callback 得到 <code>7</code>。</li>
<li>newest$ 結束，因為 source$ 也結束了，所以 example$ 結束。</li>
</ul>
<p>不管是source$還是newest$送出值來，只要另一方曾有送出過值(有最後的值)，就會執行callback並送出新的值，𫍇就是combineLastest</p>
<p>combineLastest很常用在運算多個因子的結果，例如最常見的BMI計算，我們身高變動時就拿上一次的體重計算新的BMI，當體重變動時則拿上次的身高計算BMI，這就很適合用combineLastest來處理</p>
<h5 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h5><p>zip會取每個observable相同順位的元素並傳入callback, 也就是說每個observable的第n個元素會一起被傳入callback</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take,zip&#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> newest$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">zip</span>(newest$, <span class="function">(<span class="params">x, y</span>) =&gt;</span> x + y));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----0----1----2|</span><br><span class="line">newest$ : --0--1--2--3--4--5|</span><br><span class="line">          zip(newest$,(x,y)=&gt;x+y)</span><br><span class="line">example$: ----0----2----4|          </span><br></pre></td></tr></table></figure>

<p>zip會等到source$跟newest$<strong>都送出了第一個元素</strong>，再傳入callback，下次則等到soure$跟newest$<strong>都送出了䇪二個元素</strong>再一起傳入callback，所以運行的步驟如下</p>
<ul>
<li>newest$ 送出了<strong>第一個</strong>值 <code>0</code>，但此時 source$ 並沒有送出<strong>第一個</strong>值，所以不會執行 callback。</li>
<li>source$ 送出了<strong>第一個</strong>值 <code>0</code>，newest$ 之前送出的<strong>第一個</strong>值為 <code>0</code>，把這兩個數傳入 callback 得到 <code>0</code>。</li>
<li>newest$ 送出了<strong>第二個</strong>值 <code>1</code>，但此時 source$ 並沒有送出<strong>第二個</strong>值，所以不會執行 callback。</li>
<li>newest$ 送出了<strong>第三個</strong>值 <code>2</code>，但此時 source$ 並沒有送出<strong>第三個</strong>值，所以不會執行 callback。</li>
<li>source$ 送出了<strong>第二個</strong>值 <code>1</code>，newest$ 之前送出的<strong>第二個</strong>值為 <code>1</code>，把這兩個數傳入 callback 得到 <code>2</code>。</li>
<li>newest$ 送出了<strong>第四個</strong>值 <code>3</code>，但此時 source$ 並沒有送出<strong>第四個</strong>值，所以不會執行 callback。</li>
<li>source$ 送出了<strong>第三個</strong>值 <code>2</code>，newest$ 之前送出的<strong>第三個</strong>值為 <code>2</code>，把這兩個數傳入 callback 得到 <code>4</code>。</li>
<li>source$ 結束 example$ 就直接結束，因為 source$ 跟 newest$ 不會再有對應順位的值</li>
</ul>
<p>zip會把各個observable相同順位送出的值傳入callback, 這很常拿來做demo使用。比如我們想要間隔100ms送出’h’,’e’,’l’,’l’,’o’,就可以這麼做</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(<span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> source2$ = <span class="title function_">interval</span>(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">zip</span>(source2$, <span class="function">(<span class="params">x, y</span>) =&gt;</span> x));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡的 Marble Diagram 就很簡單</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : (hello)|</span><br><span class="line">source2$: -0-1-2-3-4-...</span><br><span class="line">        zip(source2$, (x, y) =&gt; x)</span><br><span class="line">example$: -h-e-l-l-o|</span><br></pre></td></tr></table></figure>

<p>這裡我們利用 zip 來達到原本只能同步送出的資料變成了非同步的，很適合用在建立示範用的資料。</p>
<blockquote>
<p>建議大家平常沒事不要亂用 zip，除非真的需要。因為 zip 必須 cache 住還沒處理的元素，當我們兩個 observable 一個很快一個很慢時，就會 cache 非常多的元素，等待比較慢的那個 observable。這很有可能造成記憶體相關的問題！</p>
</blockquote>
<h5 id="withLastestFrom"><a href="#withLastestFrom" class="headerlink" title="withLastestFrom"></a>withLastestFrom</h5><p>withLatestFrom運作方式跟combineLastest有點像，只是他有主從的關系，只有在主要的observable送出新的值時，才會執行callback, 附隨的observable只有在背景下運作。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip, withLatestFrom &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> main$ = <span class="title function_">from</span>(<span class="string">&quot;hello&quot;</span>).<span class="title function_">pipe</span>(<span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x));</span><br><span class="line"><span class="keyword">var</span> some$ = <span class="title function_">from</span>([<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]).<span class="title function_">pipe</span>(<span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = main$.<span class="title function_">pipe</span>(<span class="title function_">withLatestFrom</span>(some$, <span class="function">(<span class="params">x, y</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> y === <span class="number">1</span> ? x.<span class="title function_">toUpperCase</span>() : x;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//h </span></span><br><span class="line"><span class="comment">//e </span></span><br><span class="line"><span class="comment">//l </span></span><br><span class="line"><span class="comment">//L </span></span><br><span class="line"><span class="comment">//O </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>看一下Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">main$   : ----h----e----l----l----o|</span><br><span class="line">some$   : --0--1--0--0--0--1|</span><br><span class="line"> withLastestFrom(some$,(x,y) =&gt; y === 1 ? x.toUpperCase() : x)</span><br><span class="line">example$: ----h----e----l----L----O|</span><br></pre></td></tr></table></figure>

<p>withLatestFrom會在main送出值的時候執行callback,但注意如果main$送出值時some$之前沒有送出過任何值callback仍然不會執行</p>
<p>這陆鄉們在main送出值時，去判斷some$最後一 送的值是不是1來決定是否要切換大小寫</p>
<ul>
<li>main$送出了<code>h</code>, 此時some$上一次送出的值為<code>0</code>, 把這兩個參數傳入callback得到<code>h</code> 。</li>
<li>main$送出了<code>e</code>, 此時some$上一次送出的值為<code>0</code>, 把這兩個參數傳入callback得到<code>e</code> 。</li>
<li>main$送出了<code>l</code>, 此時some$上一次送出的值為<code>0</code>, 把這兩個參數傳入callback得到<code>l</code> 。</li>
<li>main$送出了<code>l</code>, 此時some$上一次送出的值為<code>1</code>, 把這兩個參數傳入callback得到<code>L</code> 。</li>
<li>main$送出了<code>o</code>, 此時some$上一次送出的值為<code>1</code>, 把這兩個參數傳入callback得到<code>O</code>。</li>
</ul>
<p>withLastestFrom很常用在一些checkbox型的功能，例如說一個編輯器，我們開啟粗體後，打出的字就都要變粗體，粗體就像是some observable，而我們打字就是main observable</p>
<h5 id="實務範例-完整拖拉應用"><a href="#實務範例-完整拖拉應用" class="headerlink" title="實務範例-完整拖拉應用"></a>實務範例-完整拖拉應用</h5><p>當我們在優酷看影片時往下滾動畫面，影片會變成一個小視窗在右下角，這個視窗還能夠拖挽移動位置。這個功能可以讓使用者一邊看留言同時又能看影片，且不影響其他的資訊顯示，真是不錯的feature。來實作這個功能，同時補完拖拉所需要注意的細節吧！</p>
<h6 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h6><p>首先我們會有一個影片在最上方，原本是位置是靜態(static)的，捲軸滾到低於影片高度後，影片改為相對於視窗的絕對位置(fixed),往回滾會再變回原來的狀態。當影片為fixed時，滑鼠移至影片上方(hover)會有遮罩(masker)與鼠標變化(cursor)，可以拖拉移動(drag)，且移動範圍不超過可視區間！</p>
<p>上面可以拆成以下幾個步驟</p>
<ul>
<li>準備static樣式與fixed樣式</li>
<li>HTML要有一固定位置的錨點(anchor)</li>
<li>當滾動超過錨點，則影片變成fixed</li>
<li>當往回滾動過錨點上方，則影片變回static</li>
<li>影片fixed時，要能夠拖拉</li>
<li>拖拉範圍限制在當前可視區間</li>
</ul>
<p>其本的HTML跟CSS可以到此連結<a href="https://stackblitz.com/edit/js-cje2qm?file=index.js">stackblitz</a></p>
<p>先讓我們看一下HTML，首先在HTML裡有一個div(#anchor), 這個div(#anchor)就是待會要做錨點用的，它內部有一個div(#video), 則是滾動後要改變成fixed的元件</p>
<p>CSS的部分我們只需要知道滾動到下方後，要把div(#video)加入<code>videx-fixed</code>這個class。</p>
<p>接著我們就開始實作滾動的效果切探class的效果吧！</p>
<h6 id="第一步取得會用到的DOM"><a href="#第一步取得會用到的DOM" class="headerlink" title="第一步取得會用到的DOM"></a>第一步取得會用到的DOM</h6><p>因為先做滾動切換class, 所有這裡用到的DOM只有#video,#anchor。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> video =<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;video&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> anchor = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;anchor&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h6 id="第二步建立會用到的observable"><a href="#第二步建立會用到的observable" class="headerlink" title="第二步建立會用到的observable"></a>第二步建立會用到的observable</h6><p>這裡做滾動效果，所以只需要監聽滾動事件。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">const</span> scroll$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&#x27;scroll&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h6 id="第三步撰寫程式邏輯"><a href="#第三步撰寫程式邏輯" class="headerlink" title="第三步撰寫程式邏輯"></a>第三步撰寫程式邏輯</h6><p>這裡我們要取得了scroll事件的observable，當滾過#anchor最底部時，就改變#video的class。</p>
<p>首先我們會需要滾動事件發生時，去判斷是否<strong>滾過#anchor最底部</strong>，所以把原來的滾動事件變成是否滾動最底部的true or false。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">scroll$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span>=&gt;</span> anchor.<span class="title function_">getBoundingClientRect</span>().<span class="property">bottom</span>&lt;<span class="number">0</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>這裡我們用山<code>getBoundingClientRect</code>這個瀏覽器原生的API，他可以取得DOM物件的寬高以及上下左右離螢幕可視區間上(左)的距離如下圖</p>
<img src="getBoundingClientRect.png" style="zoom:80%;" />

<p>當我們可視範圍區間滾過#ancor底部時，<code>anchor.getBoundingClientRect().bottom</code>就會變成負值，此時我們就改變#video的class。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">scroll$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span>=&gt;</span> anchor.<span class="title function_">getBoundingClientRect</span>().<span class="property">bottom</span>&lt;<span class="number">0</span>)</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="function"><span class="params">bool</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(bool)&#123;</span><br><span class="line">    video.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;video-fixed&#x27;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    video.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;video-fixed&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們就已經完成滾動變更樣式的效果了</p>
<p>全部的JS程式碼如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.scss&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fromEvent &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> video =<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;video&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> anchor = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;anchor&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> scroll$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&#x27;scroll&#x27;</span>);</span><br><span class="line">scroll$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span>=&gt;</span> anchor.<span class="title function_">getBoundingClientRect</span>().<span class="property">bottom</span>&lt;<span class="number">0</span>)</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="function"><span class="params">bool</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(bool)&#123;</span><br><span class="line">    video.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;video-fixed&#x27;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    video.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;video-fixed&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>當然這段還能在用 debounce&#x2F;throttle 或 requestAnimationFrame 做優化</p>
</blockquote>
<p>擒下來我們就可以接著做<strong>拖拉的行為</strong>了。</p>
<h6 id="第一步取得會用到的DOM-1"><a href="#第一步取得會用到的DOM-1" class="headerlink" title="第一步取得會用到的DOM"></a>第一步取得會用到的DOM</h6><p>這裡我們會用到的DOM跟前面是一樣的(#video)，所以不用多做什麼。</p>
<h6 id="第二步建立會用到的observable-1"><a href="#第二步建立會用到的observable-1" class="headerlink" title="第二步建立會用到的observable"></a>第二步建立會用到的observable</h6><p>這裡跟上次一樣，我們會用到mousedown,mouseup,mousemove三個事件。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mouseDown$ = <span class="title function_">fromEvent</span>(video,<span class="string">&#x27;mousedown&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mouseUp$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&quot;mouseup&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> mouseMove$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&quot;mousemove&quot;</span>); </span><br></pre></td></tr></table></figure>

<h6 id="第三步撰寫程式邏輯-1"><a href="#第三步撰寫程式邏輯-1" class="headerlink" title="第三步撰寫程式邏輯"></a>第三步撰寫程式邏輯</h6><p>跟上次是差不多的，首先我們會點擊#video元件，點擊(mousedown)後要變成移動事件(mousemove),而移動事件會在滑鼠收開(mouseup)時結事(takeUntil)</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>()</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因為把moudeDown$ observable發送出來的<strong>事件</strong>換成了mouseMove$ observable，所以變成了observable(mouseDown$)送出observable(mouseMove$)。因此最後用concalAll把後面送出的元素變成mousemove的事件。</p>
<p>但這裡會有一個問題，就是我們的𫍇段拖拉事件其實只能做用到video-fixed的時候，所以我們要加上<code>filter</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span>=&gt;</span> video.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;video-fixed&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>()</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這裡我們用filter如果當下#video沒有<code>video-fixed</code>class的話，事件就不會送出。</p>
<p>再來我們就能跟上次一樣，把mousemove事件變成{x,y}的物件，並訂閱來改變#video元件</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> video.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;video-fixed&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>(),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">m</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">x</span>: m.<span class="property">clientX</span>,</span><br><span class="line">      <span class="attr">y</span>: m.<span class="property">clientY</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">pos</span> =&gt;</span> &#123;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">top</span> = pos.<span class="property">y</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">left</span> = pos.<span class="property">x</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>到這裡我們基本上已經完成了所有功能和之前簡易拖拉的方法是一樣的。</p>
<p>但這裡有兩個大問題我們還沒有解決</p>
<ol>
<li><p>第一次拉動的時候會閃一下，不像優酷那麼順。</p>
</li>
<li><p>拖拉會跑出當前可視區間，跑出去後就抓不回來了</p>
</li>
</ol>
<p>讓我們一個一個解決，首先第一個問題是因為我們的拖拉直接給元件滑鼠的位置(clientC,clientY),而非給滑鼠相對移動的距離！</p>
<p>所以要解決這個問題很簡單，我們只要把點擊目標的左上角當作(0,0), 並以此改變元件的樣式，就不會有閃動的問題。   這個要怎麼做呢？很簡單，使用withLatestFrom的operator我們可以用它來把mousedown與mousemove兩個Event的值同時傳入callback。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> video.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;video-fixed&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>(),</span><br><span class="line">  <span class="title function_">withLatestFrom</span>(mouseDown$, <span class="function">(<span class="params">move, down</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="attr">x</span>: move.<span class="property">clientX</span> - down.<span class="property">offsetX</span>,</span><br><span class="line">      <span class="attr">y</span>: move.<span class="property">clientY</span> - down.<span class="property">offsetY</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">pos</span> =&gt;</span> &#123;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">top</span> = pos.<span class="property">y</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">left</span> = pos.<span class="property">x</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>當我們能夠同時得到mousemove跟mousedown的事件，接著就只要把滑鼠相對可視區間的距離(client)減掉點按下去時，滑鼠相對元件邊界的距離(offset)就行了。這時拖拉就不會先閃動一下囉！</p>
<blockquote>
<p>大家只要想一下，其實client-offset就是元件相對於可視區間的距離，也就是他一開始沒動的位置！</p>
</blockquote>
<p>接著讓我們解決第二個問題，拖拉會超出可視範圍。這個問題其實只史給最大最小值就行了，因無需求的關系，這裡我們的元件是相對可視的區間的絕對位置(fixed),也就是就說</p>
<ul>
<li>top 最小是0</li>
<li>left 最小是0</li>
<li>top 最大是<strong>可視高度</strong>扣掉<strong>元件本身高度</strong></li>
<li>left 最大是<strong>可視寬度</strong>扣掉<strong>元件本身寬度</strong></li>
</ul>
<p>這裡我們先宣告一個function來處理這件事</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">validValue</span> = (<span class="params">value, max, min</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="title class_">Math</span>.<span class="title function_">max</span>(value, min), max)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一個參數給原本要給的位置值，後面給最大跟最小，如果今天大於最大值我們就取最大值，如果今天小於最小值則取最小值。</p>
<p>再來我們就可以直接把這個問題解掉了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> video.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;video-fixed&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>(),</span><br><span class="line">  <span class="title function_">withLatestFrom</span>(mouseDown$, <span class="function">(<span class="params">move, down</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">x</span>: <span class="title function_">validValue</span>(move.<span class="property">clientX</span> - down.<span class="property">offsetX</span>, <span class="variable language_">window</span>.<span class="property">innerWidth</span> - <span class="number">320</span>, <span class="number">0</span>),</span><br><span class="line">      <span class="attr">y</span>: <span class="title function_">validValue</span>(move.<span class="property">clientY</span> - down.<span class="property">offsetY</span>, <span class="variable language_">window</span>.<span class="property">innerHeight</span> - <span class="number">180</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">pos</span> =&gt;</span> &#123;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">top</span> = pos.<span class="property">y</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">left</span> = pos.<span class="property">x</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這裡偷懶了一下，直接寫死元件的寬高(320,180)，實際上應用<code>getBoundingClientRect</code>計算是比較好的。</p>
<h4 id="scan-buffer"><a href="#scan-buffer" class="headerlink" title="scan,buffer"></a>scan,buffer</h4><p>兩個簡單的transformation operators並帶一些小範例，這兩個operators都是實數上很常用到的方法。</p>
<h5 id="scan"><a href="#scan" class="headerlink" title="scan"></a>scan</h5><p>scan其實就是Observable版本的reduce只是命名不同。如果熟悉陣列操作的話，應該會知道原生的JS Array就有reduce的方法，使用方式如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="keyword">var</span> result = arr.<span class="title function_">reduce</span>(<span class="function">(<span class="params">origin, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(origin);</span><br><span class="line">    <span class="keyword">return</span> origin + next;</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="comment">// 10</span></span><br></pre></td></tr></table></figure>

<p>reduce方法需要傳兩個參數，第一個是callback第二個則是起始狀態，這個callback執行時，會傳入兩個參睥一個是原本的狀態，第二個是修改原本狀態的參數，最後回傳一個新的狀態，再繼續執行。</p>
<p>所以這段程式碼是這樣執行的</p>
<ul>
<li><p>第一次執行callback起始狀態是0所以origin傳入0，next為arr的第一個元素1，相加之後變成1回傳並當作下一次的狀態。</p>
</li>
<li><p>第二次執行callback，這時原本的狀態(origin)就變成了1，next為arr的第二個元素2，相加之後變成3回傳並當作下一次的狀態。</p>
</li>
<li><p>第三次執行callback，這時原本的狀態(origin)就變成了3，next為arr的第三個元素3，相加之後變成6回傳並當作下一次的狀態。</p>
</li>
<li><p>第四次執行callback, 這時原本的狀態(origin)就變成了6，next為arr的第四個元素4，相之後變成10回傳並當作下一次的狀態。</p>
</li>
<li><p>這時arr的元素都已經遍歷過了，所以不會直接把10回傳。</p>
</li>
</ul>
<p>scan整體的運作方式都跟reduce一樣，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip, scan &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(<span class="string">&quot;hello&quot;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">600</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">scan</span>(<span class="function">(<span class="params">origin, next</span>) =&gt;</span> origin + next, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// h</span></span><br><span class="line"><span class="comment">// he</span></span><br><span class="line"><span class="comment">// hel</span></span><br><span class="line"><span class="comment">// hell</span></span><br><span class="line"><span class="comment">// hello</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$  : ----h-----e-----l----l----o|</span><br><span class="line">        scan((origin, next) =&gt; origin + next, &#x27;&#x27;)</span><br><span class="line">example$ : ----h----(he)----(hel)----(hello)----(hello)|        </span><br></pre></td></tr></table></figure>

<p>這裡可以看到第一次傳入<code>&#39;h&#39;</code>跟<code>&#39;&#39;</code>相加，返回<code>&#39;h&#39;</code>當作下一次的初始狀態，一直重複下去。</p>
<blockquote>
<p>scan跟reduce最大的差別就在scan一定會回傳一固observable實例，而reduce最後回傳的值有可能是任何資料型別，必須看使用者傳入的callback才態決定reduce最後的返回值。</p>
</blockquote>
<blockquote>
<p>Jafar Husain 就曾說：「JavaScript 的 reduce 是錯了，它最後應該永遠回傳陣列才對！」</p>
</blockquote>
<blockquote>
<p>如果大家之前有到<a href="http://reactivex.io/learnrx/">這裡</a>練習的話，會發現 reduce 被設計成一定回傳陣列，而這個網頁就是 Jafar 做的。</p>
</blockquote>
<p>scan很常用狀態的計算處理，最簡單的就是對一個數字的加減，我們可以綁定一個button的click事件，並用map把click event 轉成1，之後送到scan計算值再做顯示。</p>
<p><a href="https://js-ubgduv.stackblitz.io/">stackblitz</a></p>
<p>在<code>html</code>中</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;addButton&quot;</span>&gt;</span>Add<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;minusButton&quot;</span>&gt;</span>Minus<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">&quot;state&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>javascript</code>中</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mapTo, startWith, merge,scan &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> addButton = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;addButton&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> minusButon = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;minusButton&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> state = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;state&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> addClick = <span class="title function_">fromEvent</span>(addButton, <span class="string">&quot;click&quot;</span>).<span class="title function_">pipe</span>(<span class="title function_">mapTo</span>(<span class="number">1</span>));</span><br><span class="line"><span class="keyword">const</span> minusClick = <span class="title function_">fromEvent</span>(minusButton, <span class="string">&quot;click&quot;</span>).<span class="title function_">pipe</span>(<span class="title function_">mapTo</span>(-<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> numberState = <span class="title function_">empty</span>().<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">startWith</span>(<span class="number">0</span>),</span><br><span class="line">  <span class="title function_">merge</span>(addClick, minusClick),</span><br><span class="line">  <span class="title function_">scan</span>(<span class="function">(<span class="params">origin, next</span>) =&gt;</span> origin + next, <span class="number">0</span>)</span><br><span class="line">);</span><br><span class="line">numberState</span><br><span class="line">  .<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; state.<span class="property">innerHTML</span> = value;&#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們用了兩個button，一個是add按鈕，一個是minus按鈕。</p>
<p>我們把這兩個按鈕的點擊事件各建立了<code>addClick</code>,<code>minusClick</code>兩個observable，這兩個observable摎托mapTo(1)跟mapTp(-1),代表被點擊後各自送出的數字！</p>
<p>按著我們用了<code>empty()</code>建立一個空的observable代表畫面上數字的狀態，搭配<code>startWith(0)</code>來設定初始值，接著用<code>merge</code>把兩個observable合併透過scan處理之後的邏輯，最後在subscribe來更改畫面的顯示。</p>
<h5 id="buffer"><a href="#buffer" class="headerlink" title="buffer"></a>buffer</h5><p>buffer是一整個家族，總共有五個相關的operators</p>
<ul>
<li><p>buffer</p>
</li>
<li><p>bufferCount</p>
</li>
<li><p>bufferToggle</p>
</li>
<li><p>bufferWhen</p>
</li>
</ul>
<p>這裡比較常用到的是buffer,bufferCount跟bufferTime這三個，我們直接來看範例。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; buffer &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>);</span><br><span class="line"><span class="keyword">var</span> source2$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">buffer</span>(source2$)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// [0,1,2]</span></span><br><span class="line"><span class="comment">// [3,4,5]</span></span><br><span class="line"><span class="comment">// [6,7,8]...</span></span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram則像是</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --0--1--2--3--4--5--6--7--</span><br><span class="line">source2$: ---------0---------1--------...</span><br><span class="line">           buffer(source2$)</span><br><span class="line">example$: ---------([0,1,2])---------([3,4,5])           </span><br></pre></td></tr></table></figure>

<p>buffer要傳入一個observable(source2$), 它會把原本的observable(source$)送出的元素緩存在陣列中，等到傳入的observable(source2$)送出元素時，就會觸發把緩存的元素送出。</p>
<p>這裡的範例source$2是每一秒就會送出一個元素，我們柯以改用bufferTime簡潔的表達如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; buffer, bufferTime &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">bufferTime</span>(<span class="number">1000</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// [0,1,2]</span></span><br><span class="line"><span class="comment">// [3,4,5]</span></span><br><span class="line"><span class="comment">// [6,7,8]...</span></span><br></pre></td></tr></table></figure>

<p>除了用時𫂾來作緩存外，我們更常用數量來做緩存，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; bufferCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">bufferCount</span>(<span class="number">3</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// [0,1,2]</span></span><br><span class="line"><span class="comment">// [3,4,5]</span></span><br><span class="line"><span class="comment">// [6,7,8]...</span></span><br></pre></td></tr></table></figure>

<p>在實務上，我們可以用buffer來做某個事件的過濾，例如像是滑鼠連點才能直的執行，這裡我們一樣寫了一個小範例</p>
<p><a href="https://js-mny21w.stackblitz.io/">stackblitz</a></p>
<p>在<code>html</code>中</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span>&gt;</span>double click!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>javascript</code>中</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; bufferTime, filter &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;demo&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> click$ = <span class="title function_">fromEvent</span>(button, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> example$ = click$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">bufferTime</span>(<span class="number">500</span>),</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">arr</span> =&gt;</span> arr.<span class="property">length</span> &gt;= <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;success&#x27;</span>); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們只有在500毫秒內連點兩下，才能成功印出<code>success</code>,這個功能在某些特殊的需求中非常的好用，也能用在批次處理來降低request傳送的次數</p>
<h4 id="delay-delayWhen"><a href="#delay-delayWhen" class="headerlink" title="delay,delayWhen"></a>delay,delayWhen</h4><blockquote>
<p>在所有非同步行為中， 最麻煩的大概就是UI操作了，因為UI是直接影響使用者的感受，如果處理的不好對使用者體會大大的扣分 </p>
</blockquote>
<p>UI大概是所有非同步行為中最不好處理的，不只是因為它直接影響了用戶體驗，更大的問題是UI互動常常是高頻𠅋觸發的事件，而且多個元件間的時間序需要不一致，要做這樣的UI互動就不太可能用Promise或async&#x2F;await，但是用RxJS仍然能輕易地處理！</p>
<p>有兩個Operators，delay跟deleyWhen都是跟UI互動比較相關的。當我們的網頁越來越像應用程式，UI互動就變得越重要，讓我們來試試如何用RxJS完成基本的UI互動！</p>
<h5 id="delay"><a href="#delay" class="headerlink" title="delay"></a>delay</h5><p>delay可以延遲observable一開始發送元素的時間點，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">5</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">delay</span>(<span class="number">500</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>當然直接從log出來的訊息看，是完全看不出差異的</p>
<p>讓我們直接看Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --0--1--2--3--4|</span><br><span class="line">         dely(500)</span><br><span class="line">example$: -------0--1--2--3--4|         </span><br></pre></td></tr></table></figure>

<p>從Marble Diagram可以看得出來，第一次送出元素的時間變慢了，雖然在這裡看起來沒有什麼用，但是在UI操作上是非常有用的。</p>
<p>delay除了可以傳入毫秒以外，也可以傳入Date型別的資料，如下使用方式</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">5</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">delay</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() + <span class="number">1000</span>))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><del>這好像也能用在預定某個日期，讓程式掛掉</del></p>
<h5 id="delayWhen"><a href="#delayWhen" class="headerlink" title="delayWhen"></a>delayWhen</h5><p>delayWhen的作用跟delay很像，最大的差別是delayWhen可以影響每個元素，而且需要傳一個callback並回傳一個observable範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, delayWhen, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">5</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">delayWhen</span>(</span><br><span class="line">        <span class="function"><span class="params">x</span> =&gt;</span> <span class="title function_">empty</span>().<span class="title function_">pipe</span>(<span class="title function_">delay</span>(<span class="number">100</span> * x * x)</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這時我們的Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --0--1--2--3--4|</span><br><span class="line">	  delayWhen(x =&gt; empty().pipe(delay(100 * x * x))</span><br><span class="line">example$: --0---1----2------3-----4|	  </span><br></pre></td></tr></table></figure>

<p>這裡傳進來的x就是source$送出的每個元素，這樣我們就能對每一個做延遲。</p>
<p>這裡我們用delay來做一個小功能，這個功能很簡單就是讓多張照片跟著滑鼠跑，但每張照片不能跑一樣快！</p>
<p>首先我們先泮備六張大頭照，並且寫進HTML</p>
<p>在<code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover6.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover5.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover4.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover3.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover2.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover1.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>用CSS把img改成圓形，並加上邊框以及絕對位置</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-tag">img</span>&#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">border-radius</span>:<span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">border</span>:<span class="number">3</span> px white solid;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate3d</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再來寫JS, 一樣第一步先抓DOM</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> imgList = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;img&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>第二步建立observable</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> movePos = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;mousemove&quot;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> (&#123; <span class="attr">x</span>: e.<span class="property">clientX</span>, <span class="attr">y</span>: e.<span class="property">clientY</span> &#125;))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>第三步撰寫邏輯</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">followMouse</span>(<span class="params">DOMArr</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> delayTime = <span class="number">600</span>;</span><br><span class="line">  <span class="title class_">DOMArr</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">    movePos.<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">delay</span>(delayTime * (<span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">0.65</span>, index) + <span class="title class_">Math</span>.<span class="title function_">cos</span>(index / <span class="number">4</span>)) / <span class="number">2</span>)</span><br><span class="line">    ).<span class="title function_">subscribe</span>(<span class="keyword">function</span> (<span class="params">pos</span>) &#123;</span><br><span class="line">      item.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&#x27;translate3d(&#x27;</span> + pos.<span class="property">x</span> + <span class="string">&#x27;px, &#x27;</span> + pos.<span class="property">y</span> + <span class="string">&#x27;px, 0)&#x27;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">followMouse</span>(<span class="title class_">Array</span>.<span class="title function_">from</span>(imgList));</span><br></pre></td></tr></table></figure>

<p>這裡我們把imgList從Collection轉成Array後傳入<code>followMouse()</code>並用forEach把每個img取出並利用index來達不同的delay時間，這個delay時間的邏輯大家可以自已想，不用跟我一樣，最後subscribe就完成了</p>
<p><a href="https://js-6xzgmu.stackblitz.io/">stackblitz</a></p>
<h4 id="throttle-debounce"><a href="#throttle-debounce" class="headerlink" title="throttle,debounce"></a>throttle,debounce</h4><p>在做效能優化時不可或缺的好工具</p>
<h5 id="debounce"><a href="#debounce" class="headerlink" title="debounce"></a>debounce</h5><p>跟buffer,bufferTime一樣，Rx有debounce跟debounceTime一個是傳入observable另一個則是傳人毫秒，比較常用到的是debounceTime, 看範例</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, debounceTime &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">debounceTime</span>(<span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>這裡只印出<code>4</code>然後就結束了，因為<strong>debounce運作的方式是每次收到元素，他會先把元素cache住並等得一段時間，如果這段時間內已經沒有收到依何元素，則把元素送出； 如果這段時𫂾內又收到新的元素，則會把原本cache住的元素釋放掉並重新計時，不斷動覆。</strong></p>
<p>以現在這個範例來講，我們每300毫秒就會送出一個數值，但我們的debounceTime是1000毫秒，也就是說每次debounce收到元素還等不到1000毫秒，就會收到下一個新元素，然後重新等待1000毫秒，如此重複直到第五個元素送出時，observable結束(complete)了，debounce就直接送出元素。</p>
<p>以Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --0--1--2--3--4|</span><br><span class="line">          debounceTime(1000)</span><br><span class="line">example$: --------------4|</span><br></pre></td></tr></table></figure>

<p>debounce會在收到元素後等待一段時間，這很適合用來處理<strong>間歇行為</strong>，間歇行為就是指這個行為是一段一段的，例如要做AutoComplete時，我們要打字搜尋不會一直不斷的打字，可以等我們停了一小段時間後再送出，才不會每打一固字就送一次request!</p>
<p>這裡舉一個簡單的例子，假設我們想要自動傳送使用者打的字到後端</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> searchInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;searchInput&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> theRequestValue = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;theRequestValue&quot;</span>);</span><br><span class="line"><span class="title function_">fromEvent</span>(searchInput, <span class="string">&quot;input&quot;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    theRequestValue.<span class="property">textContent</span> = value;</span><br><span class="line">    <span class="comment">//在這裏發request</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>如果用上面這段程式碼，就每打一個字就送一次request，當很多人在使用時就會對server造成很大的負擔，實際上我們只需要使用者最後打出來的文字就好了，不用每次都送，這時就能用debouceTime做優化。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, debounceTime &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> searchInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;searchInput&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> theRequestValue = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;theRequestValue&quot;</span>);</span><br><span class="line"><span class="title function_">fromEvent</span>(searchInput, <span class="string">&quot;input&quot;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">debounceTime</span>(<span class="number">300</span>),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">  theRequestValue.<span class="property">textContent</span> = value;</span><br><span class="line">  <span class="comment">//在這裏發request</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a href="https://js-hlsjvm.stackblitz.io/">stackblitz</a></p>
<h5 id="throttle"><a href="#throttle" class="headerlink" title="throttle"></a>throttle</h5><p>其本上每次看到debounce就會看到throttle,他們兩個的作用都是要降低事件的觸發頻率，但行為上有得大的不同。</p>
<p>跟debouce一樣RxJS有throttle跟throttleTime兩個方法，一個是傳入observable另一個是傳入毫秒，比較常用到的也是throttleTime, 直接看範例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, throttleTime &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">throttleTime</span>(<span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>跟debounce的不同是throttle會先開放送出元素，等到有元素被送出就會沈默一段時間，等到時間過了又會開放發送元素。</p>
<p>throttlw比較像是控制行為的最高頻率，也就是說如果我們設定<strong>1000毫秒</strong>，那該事件頻率的最大值就是<strong>每秒觸發一次</strong>不會再更快，debouce則比較像是必須等得的時間，要等到一定的時間過了才會收到元素。</p>
<p>throttlw更適合用在<strong>連續性行為</strong>，比如說UI動畫的運算過程，因為UI動畫是連續的，像我們之前在做拖拉時，就可以加上<code>throttleTime(12)</code>讓mousemove event不要發送的太快，避免畫面更新的速度跟不上樣式的切換速度。</p>
<blockquote>
<p>瀏覽器有一個 <a href="https://developer.mozilla.org/zh-TW/docs/Web/API/Window.requestAnimationFrame">requestAnimationFrame</a> API 是專門用來優化 UI 運算的，通常用這個的效果會比 throttle 好，但並不是絕對還是要看最終效果。</p>
</blockquote>
<blockquote>
<p>RxJS 也能用 requestAnimationFrame 做優化，而且使用方法很簡單，這個部份會在 Scheduler 提到。</p>
</blockquote>
<h4 id="distinct-distinctUntilChanged"><a href="#distinct-distinctUntilChanged" class="headerlink" title="distinct,distinctUntilChanged"></a>distinct,distinctUntilChanged</h4><p>除了throttle和debounce兩個方法來做效能優化，其實還有另一個方法可以做效能的優化處理，那就是distinct</p>
<h5 id="distinct"><a href="#distinct" class="headerlink" title="distinct"></a>distinct</h5><p>如果會下SQL指令的應該都對distinct不陌生，它能幫我們把相同值的資料濾掉只留一筆，RxJS裡的distinct也是相同的作用，看範例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, zip, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; distinct &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">distinct</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>) &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// a</span></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// c</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>如果有Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --a--b--c--a--b|</span><br><span class="line">            distince()</span><br><span class="line">example$: --a--b--c------|             </span><br></pre></td></tr></table></figure>

<p>從上面的範例可以看得出來，當我們用distinct後，只要有重複出現的值就會被過濾掉。</p>
<p>另外我們可以傳入一個selector callback functon，這個callback function會傳入一個接收到的元素，並回傳我們真正希望比對的值，如下例子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, zip, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; distinct &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([&#123; <span class="attr">value</span>: <span class="string">&quot;a&quot;</span> &#125;, &#123; <span class="attr">value</span>: <span class="string">&quot;b&quot;</span> &#125;, &#123; <span class="attr">value</span>: <span class="string">&quot;c&quot;</span> &#125;, &#123; <span class="attr">value</span>: <span class="string">&quot;a&quot;</span> &#125;, &#123; <span class="attr">value</span>: <span class="string">&quot;c&quot;</span> &#125;]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">distinct</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> x.<span class="property">value</span></span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>) &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// &#123;value: &quot;a&quot;&#125;</span></span><br><span class="line"><span class="comment">// &#123;value: &quot;b&quot;&#125;</span></span><br><span class="line"><span class="comment">// &#123;value: &quot;c&quot;&#125;</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到，因為source$送出的都是物件，而js物件比對是比對記憶體位置，所以在這個例子中這些物件永遠不會相等，但實際上我們想比對的是物件中的value, 這時我們就可以傳入selector callback，來選擇我們要比對的值。</p>
<p>實際上<code>distinct()</code>會在背地裡建立一個Set，當接收到元素時會先去判斷Set內是否有相同的值，如果有就不送出，如果沒有則存到Set並送出。所以記得盡量不要直接把distinct用在一個無限的observable裡，這樣很可能會讓Set越來越大，建議大家可以放第二個參數flushes或用distinctUntilChanged.</p>
<blockquote>
<p>這裡指的 Set 其實是 RxJS 自己實作的，跟 ES6 原生的 Set 行為也都一致，只是因為 ES6 的 Set 支援程度還並不理想，所以這裡是直接用 JS 實作。</p>
</blockquote>
<p>distinct可以傳入第二個參數flushed observable用來清除暫存的資料，例子如下(目前有問題)</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, zip, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; distinct &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;c&quot;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> flushes$ = <span class="title function_">interval</span>(<span class="number">1300</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">distinct</span>(<span class="literal">null</span>, flushes$)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>) &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們用Marble Diagram比較好表示</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --a--b--c--a--c|</span><br><span class="line">flushed$: ------------0---...</span><br><span class="line">          distinct(null,fluehes$)</span><br><span class="line">examples$:--a--b--c-----c|          </span><br></pre></td></tr></table></figure>

<p>其實flushes observable就是在送出元素時，會把distinct的暫存清空，所以之後的暫存就會從頭來過，這樣就不用擔心暫存的Set越來愈大的問題，但其實我們平常不太會用這樣的方式來處理，通常會用另一個方法distinctUntilChanged</p>
<h5 id="distinctUntilChanged"><a href="#distinctUntilChanged" class="headerlink" title="distinctUntilChanged"></a>distinctUntilChanged</h5><p>distinctUntilChanged跟distinct一樣會把相同的元素過濾掉，但distinctUntilChanged只會跟最後一次送出的元素比較，不會每個都比，例子如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, zip, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; distinctUntilChanged &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;b&#x27;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">distinctUntilChanged</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>) &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// a</span></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// c</span></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>這裡distinctUntilChanged只會暫存一個元素，並在收到元素時跟暫存的元素比對，如果一樣就不送出，如果不一樣就色暫存的元素換成剛接收到的新元素並送出。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --a--b--c--c--b|</span><br><span class="line">        distinctUntilChanged()</span><br><span class="line">example$: --a--b--c-----b|</span><br></pre></td></tr></table></figure>

<p>從 Marble Diagram 中可以看到，第二個 c 送出時剛好上一個就是 c 所以就被濾掉了，但最後一個 b 則跟上一個不同所以沒被濾掉。</p>
<p>distinctUntilChanged 是比較常在實務上使用的，最常見的狀況是我們在做多方同步時。當我們有多個 Client，且每個 Client 有著各自的狀態，Server 會再一個 Client 需要變動時通知所有 Client 更新，但可能某些 Client 接收到新的狀態其實跟上一次收到的是相同的，這時我們就可用 distinctUntilChanged 方法只處理跟最後一次不相同的訊息，像是多方通話、多裝置的資訊同步都會有類似的情境。</p>
<h4 id="catchError-retry-retryWhen-repeat"><a href="#catchError-retry-retryWhen-repeat" class="headerlink" title="catchError,retry,retryWhen,repeat"></a>catchError,retry,retryWhen,repeat</h4><p>在dayrxjs.js的檔案，𫍇是錯誤處理(Error Hangling)的operators,錯誤處理是非同步行為中的一大難題，尤其有多個交錯的非同步行為時，更容易凸顯錯誤處理的困難。注意上版是catch</p>
<h5 id="catchError"><a href="#catchError" class="headerlink" title="catchError"></a>catchError</h5><p>catchError是很常見的非同步錯諤處理方法，在RxJS中也能夠直接用catch來處理錯誤，在RxJS中的catch可以回傳一個observable來送出新的值，看範例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="title function_">of</span>(<span class="string">&quot;h&quot;</span>))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);  </span><br><span class="line"><span class="comment">//A </span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//h </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>這個範例我們每隔500毫秒會送出一個字串(String)並用字串的方法<code>toUpperCase()</code>來把字串的英文字母改成大寫，過程中可能未知的原因送出了一個數值(Number)<code>2</code>導致發生例外(數值沒有toUpperCase的方法)，這時我們在後面接的catchError就能抓到錯誤。</p>
<p>catchError可以回傳一個新的Observable，Promise，Array或何Iterable的物件，來傳送之後的元素。</p>
<p>以例子來說最後就會在送出<code>X</code>就結束，畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c----d----2|</span><br><span class="line">          map(x=&gt; x.toUpperCase())</span><br><span class="line">          ----A----B----c----d----X|</span><br><span class="line">          catchError(error =&gt; of(<span class="string">&quot;h&quot;</span>))</span><br><span class="line">example$: ----A----B----C----D----h|          </span><br></pre></td></tr></table></figure>

<p>可以看到，當錯誤發生後就會進到catchError並重新處理一個新的observable，我們可以利用這個新的observable來送出我們想送的值。</p>
<p>也可以在遇到錯誤後，讓observable結束如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="title function_">empty</span>())</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br><span class="line"><span class="comment">//A </span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>回傳一個empty的observable來直接結事(complete)</p>
<p>另外catchError的callback能接收第二個參數，這個參數會接收當前的observable，我們可以回傳當前的observable來做到重新執行，範例如下:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function">(<span class="params">error, obs</span>) =&gt;</span> obs)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p>這裡可以看到我們直接回傳了當前的obserable(其實就是example)來重新執行，畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c----d----2|</span><br><span class="line">          map(x =&gt; x.toUpperCase())</span><br><span class="line">          ----A----B----C----D----X|</span><br><span class="line">          catchError((error, obs) =&gt; obs)</span><br><span class="line">example$: ----A----B----C----D--------A----B----C----D--..          </span><br></pre></td></tr></table></figure>

<p>因為我們只是簡單的示範，所以這裡會一直無限循環，實務上通常會用在斷線重連的情境。</p>
<p>另上面的處理方式有一個簡化的寫法，叫做<code>retry()</code>。</p>
<h5 id="retry"><a href="#retry" class="headerlink" title="retry"></a>retry</h5><p>如果我們想要一個observable發生錯誤時，重新嘗式就可以用retry這個𤆧法 ，跟我們前一個講範例的行為是一致</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, retry &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">retry</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通常這種無限的<code>retry</code>會㪜在即時同步的重新連接，讓我們在連線斷掉後，不斷的嘗式。另外我們也可以設定只嘗試幾次，如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, retry &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">retry</span>(<span class="number">1</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//A </span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//A</span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//Error: TypeError: x.toUpperCase is not a function</span></span><br></pre></td></tr></table></figure>

<p>這裡我們對retry傳入一個數值<code>1</code>, 能夠讓我們只重複嘗試1次後送出錯誤，畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c----d----2|</span><br><span class="line">          map(x =&gt; x.toUpperCase()),</span><br><span class="line">          ----A----B----C----D----X|</span><br><span class="line">                retry(1)</span><br><span class="line">example$: ----A----B----C----D--------A----B----C----D----X|                </span><br></pre></td></tr></table></figure>

<p>這種處理方式很適合用在Http request失敗的場景中，我們可以設定重新發幾次後，再秀出錯誤訊息</p>
<h5 id="retyrWhen"><a href="#retyrWhen" class="headerlink" title="retyrWhen"></a>retyrWhen</h5><p>RxJS還提供了另一種方法<code>retryWhen</code>，他可以把例外發生的元素放到一個observable中，讓我們可以直接操作這個observable,並等到這個observable操作完後再重新訂閱一次原來的observable。看範例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, retryWhen, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">retryWhen</span>(<span class="function"><span class="params">errorObs</span> =&gt;</span> errorObs.<span class="title function_">pipe</span>(<span class="title function_">delay</span>(<span class="number">1000</span>)))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br><span class="line"><span class="comment">//A </span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//一秒</span></span><br><span class="line"><span class="comment">//A</span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br></pre></td></tr></table></figure>

<p>這裡retyrWhen我們傳入一個callback，這個callback有一個參數會傳入一個observable這個observable不是原本的observable(example), 而是例外事件送出的錯誤所組成的一個observable，我們可以對這個由錯誤所組成的observable做操作，等而這次的處理完成後就會重新訂閱我們原本的observable。</p>
<p>這個範例我們是把錯誤的observable送出錯誤延遲1秒，這會使後面重新訂閱動作延遲1秒才執行，Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c----d----2|</span><br><span class="line">         map(x =&gt; x.toUpperCase())</span><br><span class="line">          ----A----B----C----D----X|</span><br><span class="line">         retryWhen(errorObs =&gt; errorObs.pipe(delay(1000)))</span><br><span class="line">example$: ----A----B----C----D-------------------A----B----C----D----.....          </span><br></pre></td></tr></table></figure>

<p>從上圖可以看到後續動新訂閱的為就被延後山，但實務上我們不太會用retryWhen來做重新訂閱的延遲，通常是直接用catchError做到這件事。這裡只是為了示範retryWhen的行為，實務上我們通常會把retyrWhen拿來做錯誤通知或是例外收集範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, retryWhen, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">retryWhen</span>(<span class="function"><span class="params">errorObs</span> =&gt;</span> errorObs.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">err</span>=&gt;</span> <span class="title function_">fetch</span>(<span class="string">&#x27;....&#x27;</span>))))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p>這裡的<code>errorObs.pipe(map(err=&gt; fetch(&#39;....&#39;)))</code>可以把errorObs裡的每個錯誤變成API的發送，通常這裡的API會像是送訊息到公司的通訊頻道(Slack等等)，這樣可以讓工程師馬上知道可服哪個API掛了，這樣我們就能即時地處理，</p>
<blockquote>
<p>retryWhen實際上是在背地裡建立一個Subject並把錯誤放入，會在對這個Subject進行內部的訂閱，因為我們還沒有講到Subject的觀念，大舉可以先把它當作Observable就好了。另外記得這個observable預設是無限的，如果我們把它結束，原本的observable也會跟著結束。</p>
</blockquote>
<h5 id="repeat"><a href="#repeat" class="headerlink" title="repeat"></a>repeat</h5><p>我們有時候可能想要retry一直重複訂閱的效果，但沒有錯誤發生，這時就可以用repeat來做到這件事，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; repeat &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">repeat</span>(<span class="number">1</span>));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br><span class="line"><span class="comment">//a </span></span><br><span class="line"><span class="comment">//b </span></span><br><span class="line"><span class="comment">//c </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c|</span><br><span class="line">		  repeat(1)</span><br><span class="line">exapmle$: ----a----b----c|		  </span><br></pre></td></tr></table></figure>

<p>我們可以不給參數讓它無限循環如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; repeat &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">repeat</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p>這樣我們就可以做不斷重複的行為，這個可以在建立輪詢時使用，讓我們不斷地發request來更新畫面。</p>
<p>我們來看一個錯誤處理在實務應用中的小範例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError, concat &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; startWith &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs-compat/operator/startWith&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> title = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;title&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>())</span><br><span class="line">    <span class="comment">// 通常 source 會是建立即時同步的連線，像是 web socket</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function">(<span class="params">error, obs</span>) =&gt;</span> obs.<span class="title function_">pipe</span>(</span><br><span class="line">        <span class="title function_">empty</span>(),</span><br><span class="line">        <span class="title function_">startWith</span>(<span class="string">&#x27;連線發生錯誤： 5秒後重連&#x27;</span>),</span><br><span class="line">        <span class="title function_">concat</span>(obs.<span class="title function_">delay</span>(<span class="number">5000</span>))</span><br><span class="line">    ))</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p>這個範例其實就是模仿在即時同步斷線特，利用catchErroy返品一個新的observable，這固observable會先送出錯誤訊息並且把原本的observable延遲5秒再做合併，雖然這只是一個模仿，但它清楚的展示了 RxJS 在做錯誤處理時的靈活性。</p>
<h4 id="switchAll-mergeAll-concatAll"><a href="#switchAll-mergeAll-concatAll" class="headerlink" title="switchAll, mergeAll, concatAll"></a>switchAll, mergeAll, concatAll</h4><p>這三個operators都是用來處理Higher Order Observable。所謂的Higher Order Observable就是指一個Observable送出的元素還是一個Observable，就像是二維陣列一樣，一個陣列中的每個元素都是陣列。如果用泛型來表達就像是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Observable&lt;Observable&lt;T&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>通常我們需要的是第二層Observable送出的元素，所以我們希望可以把二維的Observable改成一維的，像是下面這樣</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Observable&lt;Observable&lt;T&gt;&gt; =&gt; Observable&lt;T&gt;</span><br></pre></td></tr></table></figure>

<p>其實想要做到這件事有三個方法switchAll、mergeAll、concatAll</p>
<h5 id="concatAll-1"><a href="#concatAll-1" class="headerlink" title="concatAll"></a>concatAll</h5><p>在簡易拖拉的範例時有講過這個operator,concatAll最動要的重點就是他會處理完前一個observable, 才會在處理下一個observable, 讓我們來看一個例子<a href="https://js-f1cdwc.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,concatAll&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>)));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concatAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// (點擊後)</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5 ...</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，當我們點擊畫面時就會開始送出數值，如果用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \    </span><br><span class="line">                     \ ----0----1----2----3----4--...</span><br><span class="line">                      ----0----1----2----3----4--...</span><br><span class="line">                      concatAll()</span><br><span class="line">example$: ----------------0----1----2----3----4--..                      </span><br></pre></td></tr></table></figure>

<p>從Marble Diagram可以看得出來，當我們點擊一下click事件會被轉成一個observable而這個observable會每一秒送出一個遞增的數值，當我們用concatAll之後會把二維的observable攤平成一維的observable，但<strong>concatAll會一個一個處理，一定是等前一個observable完成(complete)才會處理下一個observable</strong>，因為現在送出observable是無限的永遠不會完成(complete)，就導致他永遠不會處理第二個送出的observable!</p>
<p>再看一個例子<a href="https://js-wdl2qz.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,concatAll,take&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concatAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>現在我們把送出的observable限制只取前三個元素，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000).pipe(take(3)))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \                  \ </span><br><span class="line">                     \ ----0----1----2|   ----0----1----2</span><br><span class="line">                      ----0----1----2|</span><br><span class="line">                      concatAll()</span><br><span class="line">example$: ----------------0----1----2----0----1--..   </span><br></pre></td></tr></table></figure>

<p>這裡我們把送出的observable變成有限的，只會送出三個元素，這時就能看得出來concatAll不管兩個observable送出的時間多麼相近，一定會先處理前一個observable再處理下一個。</p>
<h5 id="switchAll"><a href="#switchAll" class="headerlink" title="switchAll"></a>switchAll</h5><p>switchAll同樣能把二維的observable攤平一維的，但他們在行為上有很大的不同，我們來看下面這個範例<a href="https://stackblitz.com/edit/js-ur4ceo?file=index.js">stackblitz.</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,switchAll,take&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>)));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">switchAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \                  \----0----1--..</span><br><span class="line">                     \ ----0----1----2----3----4--...</span><br><span class="line">                      ----0----1----2----3----4--...</span><br><span class="line">                      switch()</span><br><span class="line">example$: ----------------0----1----2--------0----1--..   </span><br></pre></td></tr></table></figure>

<p>switch最重要的就是他會<strong>在新的observable送出後直接處理新的observable不管前一個observable是否完成，每當有新的observable送出就會直接把舊的observable退訂(unsubscribe), 永遠只處理最新的observable!</strong></p>
<p>所以在這上面的Marble Diagram可以看得出來第一次送出的observable跟第二次送出的observable時間點太近，導致第一個observable還來不及送出元素就直接被退訂了，當下一次送出observable就又會把前一次的observable退訂。</p>
<h5 id="margeAll"><a href="#margeAll" class="headerlink" title="margeAll"></a>margeAll</h5><p>它會把二維的observable轉成一維的，並且能夠同時處理所有的observable，讓我們來看這個範例<a href="https://js-k6g4x6.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,mergeAll,take&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>)));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">mergeAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \                  \----0----1--..</span><br><span class="line">                     \ ----0----1----2----3----4--...</span><br><span class="line">                      ----0----1----2----3----4--...</span><br><span class="line">                      switch()</span><br><span class="line">example$: ----------------00---11---22---33---(04)4--..   </span><br></pre></td></tr></table></figure>

<p>從Marble Diagram可以看出來，所有的observable是並行(Parallel)處理的，也就是說mergeAll不會像switchAll一樣退訂(unsubscribe)原先的observable而是並行處理多個observable。以範例來說，當我們點擊越多下，最後送出的頻率就會越快。另外mergeAll可以傳入一個數值，這個數值代表他可以同時處理的observable數量，來看一個例子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,mergeAll,take&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">mergeAll</span>(<span class="number">2</span>));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們送出的observable改成取前三個，並且讓mergeAll最多只能同時處理2個observable, 用Darble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000).pipe(take(3))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \                  \----0----1----2|</span><br><span class="line">                     \ ----0----1----2|</span><br><span class="line">                      ----0----1----2|</span><br><span class="line">                      mergeAll(2)</span><br><span class="line">example$: ----------------00---11---22---0----1----2..   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>當mergeAll傳入參數後，就會等處理中的其中一個observable完成，再去處理下一個。以我們的例子來說，前面兩個observable可以被並行處理，但第三個observable必須等到第一個observable束後，才會開始。</p>
<p>我們可以利用這個參數來決定要同時處理幾個observable。如果我們傳入<code>1</code>其行為就會跟<code>concatAll</code>是一模一樣的。</p>
<h4 id="switchMap-mergeMap-concatMap"><a href="#switchMap-mergeMap-concatMap" class="headerlink" title="switchMap, mergeMap, concatMap"></a>switchMap, mergeMap, concatMap</h4><p>這三個operators在很多的RxJS相關的library的使用範例上都會看到。</p>
<h5 id="concatMap"><a href="#concatMap" class="headerlink" title="concatMap"></a>concatMap</h5><p>concatMap其實就是map加上concatAll的簡化寫法，看範例<a href="https://js-f7bstc.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, concatAll, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))),</span><br><span class="line">  <span class="title function_">concatAll</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面這個範例就可以簡化成</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concatMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">concatMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">100</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>)))</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>注意時間有改變</strong>, 前後兩個行為是一致，記得concatMap也會先處理前一個送出的observable在處理下一個observable，畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : -----------c--c------------------...</span><br><span class="line">         concatMap(e =&gt; interval(100).pipe(take(3)))</span><br><span class="line">example$: -----------0-1-2-0-1-2-----------...         </span><br></pre></td></tr></table></figure>

<p>這樣的行為也很常被用在發送request如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concatMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">concatMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()) )</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們每點擊一下畫面就會送出一個HTTP request,如果我們快速的連續點擊，可以在開發工具的network看到每個request是等到前一個request完成才會送出下一個request如下圖</p>
<img src="2019-07-17_09_46_19_Image.png" style="zoom:80%;" />

<p>從newwork的圖形可以看得出來，第二個request的發送時間是接在第一個request之後的，我們可以確保每一個request會等前一個request完成才做處理。</p>
<p>concatMap還有第二個參數是一個selector callback, 這個callback會傳入四個參數，分別是</p>
<ol>
<li><p>外部observable送出的元素</p>
</li>
<li><p>內部observable送出的元素</p>
</li>
<li><p>外部observable送出的元素的index</p>
</li>
<li><p>內部observable送出的元素三index</p>
</li>
</ol>
<p>回傳值我們想要的值，範例如下<a href="https://js-phxvjv.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concatMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">concatMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()),<span class="function">(<span class="params">e,res,eIndex,resIndex</span>)=&gt;</span> res.<span class="property">title</span> )</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這個範例的外部observable送出的元素就是click event物件，內部observable送出的元素就是response物件，這裡我們回傳response物件的title屬性，這樣一來我們就可以直接到到title, 這個方法很適合在response要選取的值跟前一個事件或順位(index)相關時。</p>
<h5 id="switchMap"><a href="#switchMap" class="headerlink" title="switchMap"></a>switchMap</h5><p>switchMap其實就是map加上switchAll簡化的寫法，如下<a href="https://js-aqx4tt.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, switchAll, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))),</span><br><span class="line">  <span class="title function_">switchAll</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面的程式碼可以簡化成<a href="https://js-aqx4tt.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, switchMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">100</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))),</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : -----------c--c-----------------...</span><br><span class="line">          switchMap(e =&gt; interval(100).pipe(take(3)))</span><br><span class="line">example$: -----------0--0-1-2-------------...          </span><br></pre></td></tr></table></figure>

<p>只要注意一個重點switchMap會在下一個observable被送出後直接退訂前一個未處理完的observable。</p>
<p>另外我們也可以把switchMap用在發送HTTP request<a href="https://js-mfg7zu.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; switchMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()) )</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果我們快速的連續點擊五下，可以在開發工具的network看到每個request會在點擊時發送，雖然我們發送了多個rquest但最後真正印出來的log只會有一個, 代表前面發送的request已經不會造成任何的side-effect了，這個很適合用在只看最後一次request的情境，比如說自動完成(auto complete),我們只需要顯示使用者最後一次打在畫面上的文字，來做建議選項而不用每一次的。</p>
<p>switchMap跟concatMap一樣有第二個參數selector callback可用來回傳我們要的值，這部分的行為跟concatMap是一樣的，這裡就不再贅述。</p>
<h5 id="mergeMap"><a href="#mergeMap" class="headerlink" title="mergeMap"></a>mergeMap</h5><p>mergeMap其實就是map加上mergeAll簡化的寫法如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mergeAll, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))),</span><br><span class="line">  <span class="title function_">mergeAll</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面的程式碼可以簡化成</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mergeMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">mergeMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">100</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>)))</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram表示</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : -----------c-c------------------...</span><br><span class="line">          mergeMap(e =&gt; interval(100).pipe(take(3)))</span><br><span class="line">example$: -------------0-(10)-(21)-2------...          </span><br></pre></td></tr></table></figure>

<p>記得mergeMap可以並行處理多個observable，以個例子來說當我們快速按兩下，元素發送的時間點是有機會重疊的。</p>
<p>另外我們也可以把mergeMap用在發送HTTP request<a href="https://js-j4o2di.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mergeMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">mergeMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()) )</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果我們快速的連續點擊五下，大家可以在開發者工具的 network 看到每個 request 會在點擊時發送並且會 log 出五個物件</p>
<p>mergeMap也能傳入第二個參數selector callback，這個selector callback跟concatMap第二個參睥也是完全一樣的，但mergeMap的重點是我們可以傳入第三個參數，來限制並行處理的數量<a href="https://js-ps6esy.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mergeMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">mergeMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()), <span class="function">(<span class="params">e, res, eIndex, resIndex</span>) =&gt;</span> res.<span class="property">title</span>, <span class="number">3</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們傳入 3 就能限制，HTTP request 最多只能同時送出 3 個，並且要等其中一個完成在處理下一個</p>
<p>switchMap, mergeMap, concatMap</p>
<p>這三個 operators 還有一個共同的特性，那就是這三個 operators 可以把第一個參數所回傳的 promise 物件直接轉成 observable，這樣我們就不用再用 <code>from</code> 轉一次，如下<a href="https://js-ttxeyr.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concatMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPersonData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">concatMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getPersonData</span>())<span class="comment">//直接回傳 promise 物件</span></span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>至於在使用上要如何選擇這三個operators?其實都還是看使用情境而定，這裡簡單列一下大部分的使用情境</p>
<ul>
<li><p>concatMap用在可以確定<strong>內部的observable結束時間比外部observable發送時間來快的情境</strong>。並且不希望有任何並行處理行為，適合少數要一次一次完成到底的UI動畫或特別的HTTP request行為。</p>
</li>
<li><p>switchMap用在只要最後一次行為的結果，適合絕大多數的使用情境。</p>
</li>
<li><p>mergeMap用在並行處理多個observable，適合需要並行處理的行為，像是多個I&#x2F;O的並行處理。</p>
<blockquote>
<p>建議初學者不確定選哪一個時，使用 switchMap</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>在使用 concatAll 或 concatMap 時，請注意內部的 observable 一定要能夠的結束，且外部的 observable 發送元素的速度不能比內部的 observable 結束時間快太多，不然會有 memory issues</p>
</blockquote>
<h4 id="簡易Auto-Complete實作"><a href="#簡易Auto-Complete實作" class="headerlink" title="簡易Auto Complete實作"></a>簡易Auto Complete實作</h4><p>RxJS的經典範例-自動完成(Auto Complete)，自動完成在實數上的應用非常廣泛，幾乎隨處可見這樣的功能，只履是跟表單、搜尋相關的都會看到。雖然是個很常見的功能，但多數工程師都只是直接套套件來完成，很少有人會自已從頭到尾把完整的邏輯寫一次。如果有自已實作過這個功能的工程師，應該就會知道這個功能在實作的過程中很多細節會讓程式碼變的非常複雜，像是要如何取消上一次發送出去的request、要如何優化請求次數…等等，這些小細節都會讓程式碼變的非常複雜且很難維護。</p>
<h4 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h4><p>首先我們會有一個尋框(input#search),當我們在上面打字並停頓超100毫秒就發送HTTP Request來取得建議選項並顯示在收尋框下方(ul#suggest-list),如果使用者在前一次發送的請求還沒有回來就打了下一個字，此時前一個發送的請求就要捨棄掉，當建議選項顯示之後可以用滑鼠點擊取建議選項代替搜尋框的文字。</p>
<p>上面的敘述可以拆分成以下幾個步驟</p>
<ul>
<li><p>準備input#search以及ul#suggest-list的HTML與CSS</p>
</li>
<li><p>在input#search輸入文字時，等得100毫秒再輸入，就發送HTTP Request</p>
</li>
<li><p>當Response還沒回來時，使用者又輸入了下一個文字就捨棄前一次的輸入並再發送一次新的Request</p>
</li>
<li><p>接受到Response之後顯示建議選項</p>
</li>
<li><p>滑鼠點擊後取代input#search的文字</p>
</li>
</ul>
<p><a href="https://js-2d9ntg.stackblitz.io/">stackblitz</a>在<code>html</code>  中,首先在HTML裡有一個input(#search),這個input(#search)就是要用來輸入的欄位，它下方有一固ul(#suggest-list),則是放建議選項的地方</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;autocomplete&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span> <span class="attr">type</span>=<span class="string">&quot;search&quot;</span> <span class="attr">id</span>=<span class="string">&quot;search&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;suggest-list&quot;</span> <span class="attr">class</span>=<span class="string">&quot;suggest&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>css</code>中</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-tag">html</span>, <span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: white;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.autocomplete</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.input</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">border</span>: none;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid black;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">24px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line">  &amp;<span class="selector-pseudo">:focus</span> &#123;</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">    <span class="attribute">border-bottom-color</span>: blue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.suggest</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">list-style</span>: none;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  -webkit-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">4px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.2</span>);</span><br><span class="line">  <span class="selector-tag">li</span> &#123;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span>;</span><br><span class="line">    &amp;<span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">      <span class="attribute">background-color</span>: lightblue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>javascript</code>中已經寫好了要發送API的url跟方法<code>getSuggestList</code>,接著就開始實作自動完成的效果吧！</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> url = <span class="string">&#x27;https://zh.wikipedia.org/w/api.php?action=opensearch&amp;format=json&amp;limit=5&amp;origin=*&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getSuggestList</span> = (<span class="params">keyword</span>) =&gt; <span class="title function_">fetch</span>(url + <span class="string">&#x27;&amp;search=&#x27;</span> + keyword, &#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">mode</span>: <span class="string">&#x27;cors&#x27;</span> &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>())</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="第一步取得需要的DOM物件"><a href="#第一步取得需要的DOM物件" class="headerlink" title="第一步取得需要的DOM物件"></a>第一步取得需要的DOM物件</h5><p>這裡我們會用到#search以及#suggest-list這兩個DOM</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> searchInput= <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;search&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> suggestList= <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;suggest-list&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="第二步，建立所需的Observable"><a href="#第二步，建立所需的Observable" class="headerlink" title="第二步，建立所需的Observable"></a>第二步，建立所需的Observable</h5><p>這裡我們要監聽收尋欄位的input事件，以及建議選項的點擊事件</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> keyword$ = <span class="title function_">fromEvent</span>(searchInput,<span class="string">&quot;input&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> selectItem$= <span class="title function_">fromEvent</span>(suggestList,<span class="string">&quot;click&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="第三步，撰寫程式邏輯"><a href="#第三步，撰寫程式邏輯" class="headerlink" title="第三步，撰寫程式邏輯"></a>第三步，撰寫程式邏輯</h5><p>每當使用者輸入文字就要發送HTTP request並且有新的值被輸入後就捨棄前一次發送的，所以這裡用switchMap</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>這裡我們先試著訂閱，看一下API會回傳什麼樣的資料</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>))</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p>在search欄位亂打幾個字</p>
<img src="2019-07-18_09_42_04_Image.png" style="zoom:80%;" />

<p>可以在console看到資料長相這樣，會回傳一個陣列帶有四個元素，其中第一個元素是我們輸入的值，第二個元素才是我們要的建議選項清單。</p>
<p>所以我們要取的是response陣列的第二的元素，用switchMap的第二個參睥來選取我們要的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>),<span class="function">(<span class="params">e,res</span>)=&gt;</span>res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p>寫一個render方法，把陣列轉成li並寫入suggestList</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">render</span> = (<span class="params">suggestArr=[]</span>)=&gt;&#123;</span><br><span class="line">    suggestList.<span class="property">innerHTML</span> = suggestArr</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">&quot;&lt;li&gt;&quot;</span>+ item+<span class="string">&quot;&lt;/li&gt;&quot;</span>)</span><br><span class="line">    	.<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這時我們就可用render方法把取得的陣列傳入</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">render</span> = (<span class="params">suggestArr = []</span>) =&gt; &#123;</span><br><span class="line">  suggestList.<span class="property">innerHTML</span> = suggestArr</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">&quot;&lt;li&gt;&quot;</span> + item + <span class="string">&quot;&lt;/li&gt;&quot;</span>)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>),<span class="function">(<span class="params">e,res</span>)=&gt;</span>res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">subscribe</span>(<span class="function"><span class="params">list</span> =&gt;</span> <span class="title function_">render</span>(list));</span><br></pre></td></tr></table></figure>

<p>如此一來我們打字就能看到結果出現在input下方了</p>
<img src="2019-07-18_10_01_12_Image.png" style="zoom:80%;" />

<p>只是目前還不能點選，先讓我們來做點選的功能，這裡點選的功能我們需要用到delegation event的小技巧，利用ul的click事件，來篩選是否點到了li，如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">selectItem$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="title function_">matches</span>(<span class="string">&quot;li&quot;</span>))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>上面我們利用DOM物件的matches方法(裡面的字串放css的selector)來過濾出有點擊到li的事件，再用map轉出我們要的值並寫入input。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">selectItem$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="title function_">matches</span>(<span class="string">&quot;li&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">innerText</span>),</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">text</span> =&gt;</span> searchInput.<span class="property">value</span> = text)</span><br></pre></td></tr></table></figure>

<p>現在我們就能點擊建議清單了，但是點擊後清單沒有消失，這裡我們要在點擊後重新render, 所以把上面的程式碼改一下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">selectItem$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="title function_">matches</span>(<span class="string">&quot;li&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">innerText</span>),</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">text</span> =&gt;</span> &#123;</span><br><span class="line">    searchInput.<span class="property">value</span> = text;</span><br><span class="line">    <span class="title function_">render</span>();</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>這樣一來我們就完成最基本的功能了。</p>
<p>還記得我們前面說每次打完字要等待100毫秒在發送request嗎?這樣能避免過多的request發送，可以降低server的負載也會有比較好的使用者體驗，要做到這件使很簡單只要加上<code>debounceTime(100)</code>就完成了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">debounceTime</span>(<span class="number">100</span>),  </span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>), <span class="function">(<span class="params">e, res</span>) =&gt;</span> res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">list</span> =&gt;</span> <span class="title function_">render</span>(list));</span><br></pre></td></tr></table></figure>

<p>當然這個數值可以依照需求或是請UX針對這個細節作調整。</p>
<p>用了不到30行的程式碼就完成了autocomplete的基本功能，當我們能夠自已從頭到尾的完成這樣的功能，在面對個各種不同的需求，我們就能很方更的針對需求作調整，而不受到套件的牽制！比如說我們希望使用者打了2個字以上在發送request，這時我們只要加上一行filter就可以了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span>=&gt;</span> e.<span class="property">target</span>.<span class="property">value</span>.<span class="property">length</span> &gt;<span class="number">2</span>),  </span><br><span class="line">  <span class="title function_">debounceTime</span>(<span class="number">100</span>),  </span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>), <span class="function">(<span class="params">e, res</span>) =&gt;</span> res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">list</span> =&gt;</span> <span class="title function_">render</span>(list));</span><br></pre></td></tr></table></figure>

<p>又或者網站的使用量很大，可能API在量大的時候會回傳失敗，主管希望可以在API失敗的時候重新嘗試3次，我們只要加個<code>retry(3)</code>就完成了。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">value</span>.<span class="property">length</span> &gt; <span class="number">2</span>),</span><br><span class="line">  <span class="title function_">debounceTime</span>(<span class="number">100</span>),</span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>)).<span class="title function_">pipe</span>(<span class="title function_">retry</span>(<span class="number">3</span>)), <span class="function">(<span class="params">e, res</span>) =&gt;</span> res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">list</span> =&gt;</span> <span class="title function_">render</span>(list));</span><br></pre></td></tr></table></figure>

<p>大家會發現我們的靈活度變的非常高，又同時兼顧了程式碼的可讀性，短𠞽的幾行程式碼就完成了一個複雜的需求，這就是RxJS的魅力啊</p>
<h4 id="window-windowToggle"><a href="#window-windowToggle" class="headerlink" title="window, windowToggle"></a>window, windowToggle</h4><p>上面有提到能把Higher Order Observable轉成一般的Observable的operators，今天我們要講能夠把一般的Observable轉成Hight Order Observable的operators。其實前端不太有機會用到這類型的Operators，都是在比較特殊的需求下才會看到，但還是會有遇到的時候。</p>
<h5 id="window"><a href="#window" class="headerlink" title="window"></a>window</h5><p>window是一整個家族總共有五個相關的operators</p>
<ul>
<li><p>window</p>
</li>
<li><p>windowCount</p>
</li>
<li><p>windowTime</p>
</li>
<li><p>windowToggle</p>
</li>
<li><p>windowWhen</p>
</li>
</ul>
<p>我們只介紹window跟windowToggle這兩個方法，其他三個的用法相對都簡單很多，大家如果有需要可以再自行到官網查看。</p>
<p>window很類似buffer可以把一段時間內送出的元素拆出來，只是buffer是把元素拆分到陣列中變成</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Observable</span>&lt;T&gt; =&gt; <span class="title class_">Observable</span>&lt;<span class="title class_">Array</span>&lt;T&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>而window則是會把元素拆分出來放到新的observable變成</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Observable&lt;T&gt; =&gt; Observable&lt;Observable&lt;T&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>buffer是把拆分出來的元素放到陣列並送出陣列；window是把拆分出來的元素放到observable並送出observable來𢒆一個例子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; switchAll,<span class="variable language_">window</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> click$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$= source$.<span class="title function_">pipe</span>(<span class="title function_">window</span>(click$));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">pipe</span>(<span class="title function_">switchAll</span>())</span><br><span class="line">    .<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5 ...</span></span><br></pre></td></tr></table></figure>

<p>首先window要傳入一個observable，每當這個observable送出元素時，就會把正在處理的observable所送出的元素放到新的observable中並送出，這裡看Marble Diagram會比較好解䆁</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">click$ : -----------c----------c------------c--</span><br><span class="line"><span class="built_in">source</span>$: ----0----1----2----3----4----5----6---..</span><br><span class="line">            window(click$)</span><br><span class="line">example$:o----------o----------o------------o--   </span><br><span class="line">         \          \          \</span><br><span class="line">          ---0----1-|--2----3--|-4----5----6|</span><br><span class="line">              switchAll()</span><br><span class="line">       : ----0----1----2----3----4----5----6---...     </span><br></pre></td></tr></table></figure>

<p>這裡可看到example$變成發送observable會在每次click事件發送出來後結束，並繼續下一個observable，這裡我們用switchAll把它攤平。</p>
<p>當然這固範例只是想單純的表達widow的作用，沒有什麼太大的意義，實務上window會搭配其他的operators使用，例如我們想計算一秒鐘內觸發了幾次click事件<a href="https://js-jc7wys.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> click$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, switchAll, <span class="variable language_">window</span>, count &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = click$.<span class="title function_">pipe</span>(<span class="title function_">window</span>(source$));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="title function_">count</span>()),</span><br><span class="line">  <span class="title function_">switchAll</span>()</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);= click$.<span class="title function_">pipe</span>(<span class="title function_">window</span>(source$));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="title function_">count</span>())</span><br><span class="line">    <span class="title function_">switchAll</span>()</span><br><span class="line">)</span><br><span class="line">    .<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>這裡我們把source$跟click$對調了，並用到了observable的一個方法<code>count()</code>,可以用來取得observable總共送出了幾個元素，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ---------0---------1---------2--...</span><br><span class="line">           window(<span class="built_in">source</span>$)</span><br><span class="line">click$  : o--------o---------o---------o--..</span><br><span class="line">          \        \         \         \</span><br><span class="line">          -cc---cc|---c-c---|---------|--..</span><br><span class="line">              map(count())</span><br><span class="line">        : o--------o---------o---------o--</span><br><span class="line">         \        \         \         \</span><br><span class="line">          -------4|--------2|--------0|--..</span><br><span class="line">                    switchAll()</span><br><span class="line">        : ---------4---------2---------0--...       </span><br></pre></td></tr></table></figure>

<p>從Marble Diagram中可以看出來，我們把部分元素放到新的observable中，就可以利用Observable的方法做更靈活的操作</p>
<h5 id="windowToggle"><a href="#windowToggle" class="headerlink" title="windowToggle"></a>windowToggle</h5><p>windowToggle不像window只能控制內部observable的結束，windowToggle可以傳入兩個參數，第一個是開始的observable，第二個是一個callback可以回傳一個結束的observable，看範例<a href="https://js-bywet3.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> source$= <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> mouseDown$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;mousedown&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> mouseUp$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;mouseup&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">windowToggle</span>(mouseDown$,<span class="function">()=&gt;</span> mouseUp$),</span><br><span class="line">    <span class="title function_">switchAll</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p>一樣用 Marble Diagram 會比較好解釋</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$   : ----0----1----2----3----4----5--...</span><br><span class="line"></span><br><span class="line">mouseDown$: -------D------------------------...</span><br><span class="line">mouseUp$  : ---------------------------U----...</span><br><span class="line"></span><br><span class="line">        windowToggle(mouseDown, () =&gt; mouseUp)</span><br><span class="line"></span><br><span class="line">          : -------o-------------------------...</span><br><span class="line">                  \</span><br><span class="line">                   -1----2----3----4--|</span><br><span class="line">                   switchAll()</span><br><span class="line">example$  : ---------1----2----3----4---------...  </span><br></pre></td></tr></table></figure>

<p>從 Marble Diagram 可以看得出來，我們用 windowToggle 拆分出來內部的 observable 始於 mouseDown 終於 mouseUp。</p>
<h5 id="groubBy"><a href="#groubBy" class="headerlink" title="groubBy"></a>groubBy</h5><p>一個實務上比較常用的operators-groupBy, 它可以幫我們把相同條𤗣的元素拆分成一個Observable，其實就跟平常在下SQL是一樣的概念，我們先來看個例子<a href="https://js-dvlbxt.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, switchAll, windowToggle, count,take ,groupBy&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ =<span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">groupBy</span>(<span class="function"><span class="params">x</span> =&gt;</span> x % <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">// GroupObservable &#123; key: 0, ...&#125;</span></span><br><span class="line"><span class="comment">// GroupObservable &#123; key: 1, ...&#125;</span></span><br></pre></td></tr></table></figure>

<p>上面的例子，我們傳入了一個callback function並回傳groupBy的條件，就能區分每個元素到不同的Observable中，用Marble Diagram表示</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ---0---1---2---3---4|</span><br><span class="line">             groupBy(x =&gt; x % 2)</span><br><span class="line">example$: ---o---o------------|</span><br><span class="line">            \   \</span><br><span class="line">            \   1-------3----|</span><br><span class="line">            0-------2-------4|</span><br></pre></td></tr></table></figure>

<p>在實務上，我們可以拿groupBy做完元素四區分後，再對inner Observable操作，例如下面這個例子我們將每個人的分數作加總再送出<a href="https://js-rcq59q.stackblitz.io/">stackblitz.</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip, map, switchAll, mergeAll, count, take, groupBy, reduce &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> people = [</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Anna&#x27;</span>, <span class="attr">score</span>: <span class="number">100</span>, <span class="attr">subject</span>: <span class="string">&#x27;English&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Anna&#x27;</span>, <span class="attr">score</span>: <span class="number">90</span>, <span class="attr">subject</span>: <span class="string">&#x27;Math&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Anna&#x27;</span>, <span class="attr">score</span>: <span class="number">96</span>, <span class="attr">subject</span>: <span class="string">&#x27;Chinese&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Jerry&#x27;</span>, <span class="attr">score</span>: <span class="number">80</span>, <span class="attr">subject</span>: <span class="string">&#x27;English&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Jerry&#x27;</span>, <span class="attr">score</span>: <span class="number">100</span>, <span class="attr">subject</span>: <span class="string">&#x27;Math&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Jerry&#x27;</span>, <span class="attr">score</span>: <span class="number">90</span>, <span class="attr">subject</span>: <span class="string">&#x27;Chinese&#x27;</span> &#125;,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(people);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">groupBy</span>(<span class="function"><span class="params">person</span> =&gt;</span> person.<span class="property">name</span>),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">group</span> =&gt;</span> group.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, curr</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">name</span>: curr.<span class="property">name</span>,</span><br><span class="line">      <span class="attr">score</span>: curr.<span class="property">score</span> + acc.<span class="property">score</span></span><br><span class="line">    &#125;))</span><br><span class="line">  )),</span><br><span class="line">  <span class="title function_">mergeAll</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">// &#123; name: &quot;Anna&quot;, score: 286 &#125;</span></span><br><span class="line"><span class="comment">// &#123; name: &#x27;Jerry&#x27;, score: 270 &#125;</span></span><br></pre></td></tr></table></figure>

<p>這裡我們範例是想把 Jerry 跟 Anna 的分數個別作加總，畫成 Marble Diagram 如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --o--o--o--o--o--o|</span><br><span class="line">  </span><br><span class="line">  groupBy(person =&gt; person.name)</span><br><span class="line">     </span><br><span class="line">       : --i--------i------|</span><br><span class="line">           \        \</span><br><span class="line">           \         o--o--o|</span><br><span class="line">            o--o--o--|</span><br><span class="line">            </span><br><span class="line">	   map(group =&gt; group.pipe(reduce(...)))</span><br><span class="line">	     </span><br><span class="line">       : --i---------i------|</span><br><span class="line">           \         \</span><br><span class="line">           o|        o|</span><br><span class="line">        </span><br><span class="line">             mergeAll()</span><br><span class="line">example$: --o---------o------|          </span><br></pre></td></tr></table></figure>

<h3 id="深入Observable"><a href="#深入Observable" class="headerlink" title="深入Observable"></a>深入Observable</h3><p>以上將大部分的operators都介紹完了，沒有機會好好的解䆁Observable的operators運作方式，一開始是以陣列(Array)的operators(map,filter,concatAll)作為切入點，在學習observable時會更容更接受跟理解，但實際上observable的operators跟陣列的有很大的不同，主要的差異有兩點</p>
<ol>
<li><p>延遲運算</p>
</li>
<li><p>漸進式取值</p>
</li>
</ol>
<h4 id="延遲運算"><a href="#延遲運算" class="headerlink" title="延遲運算"></a>延遲運算</h4><p>延遲運算很好理解，所有Observable一定會等到訂閱後才開始對元素做運算，如果沒有訂閱就不會有運算的行為</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x+<span class="number">1</span>));</span><br></pre></td></tr></table></figure>

<p>上面這段程式因為Observable還沒有訂閱，所以不會真的對元素做運算，這跟陣列的操作不一樣，如下</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> source = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">var</span> example = source.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>);ty</span><br></pre></td></tr></table></figure>

<p>上面這段程式執行完，example就已經取得所有元素的返回值了。</p>
<h4 id="漸進式取值"><a href="#漸進式取值" class="headerlink" title="漸進式取值"></a>漸進式取值</h4><p>陣列的operators都必須完整的運算出每個元素的返回值並組成一個陣列，再做下一個operator的運算，我們看下面這段程式碼</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> source =p[<span class="number">1</span>,<span class="number">2</span>,<span class="keyword">var</span> source = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> example = source</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function"><span class="params">x</span> =&gt;</span> x % <span class="number">2</span> === <span class="number">0</span>)<span class="comment">// 這裡會運算並返回一個完整的陣列</span></span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>);<span class="comment">// 這裡也會運算並返品一個完整的陣列]</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，有注意到<code>source.filter(...)</code>就會返回整個新陣列，再接下一個operator又會再返回一個新的陣列，這一點其實在我們實作map跟filter時就能觀察到</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">map</span> = <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> result = []; <span class="comment">// 建立新陣列</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">item, index, array</span>) &#123;</span><br><span class="line">        result.<span class="title function_">push</span>(<span class="title function_">callback</span>(item, index, array))</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result; <span class="comment">// 返回新陣列</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每一次的operator的運算都會建立一個新的陣列，並在每個元素都運算完後返回這個新陣列。</p>
<p>Opservable operator的運算方式跟陣列的是完全的不同，雖然Obserbale的operator也都會回傳一個新的observable，但因為元素是漸進式取得的關系，所以每次的運算是一個元素運算到底，而不是運算完全部的元素再返回。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">filter</span>(<span class="function"><span class="params">x</span> =&gt;</span> x === <span class="number">2</span>),<span class="comment">//</span></span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>),</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>目前測試<code>x % 2 ===2 </code>有問題，所以以此來代替</p>
<p>上面這段程式碼運行的方式是這樣的</p>
<ol>
<li><p>送出<code>1</code>到filter被過濾掉</p>
</li>
<li><p>送出<code>2</code>到filter在被送到map轉成<code>3</code>，送到observe<code>console.log</code>印出</p>
</li>
<li><p>送出<code>3</code>到filter被過濾掉</p>
</li>
</ol>
<p>每個元素送出後就是運算到底，在這個過程中不會等待其他的元素運算，這就就是漸進式取值的特性，在提到Iterator跟Observer時，就特別強調這兩個Pattern的共同特性是漸進式值，而我們在實作Iteraotr的過程中其實就能看出這個特性的運作方式</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IteratorFromArray</span> &#123;</span><br><span class="line">	<span class="title function_">constructor</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">_array</span> = arr;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">_cursor</span> = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	<span class="title function_">next</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_cursor</span> &lt; <span class="variable language_">this</span>.<span class="property">_array</span>.<span class="property">length</span> ?</span><br><span class="line">		&#123; <span class="attr">value</span>: <span class="variable language_">this</span>.<span class="property">_array</span>[<span class="variable language_">this</span>.<span class="property">_cursor</span>++], <span class="attr">done</span>: <span class="literal">false</span> &#125; :</span><br><span class="line">		&#123; <span class="attr">done</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="title function_">map</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">		<span class="keyword">const</span> iterator = <span class="keyword">new</span> <span class="title class_">IteratorFromArray</span>(<span class="variable language_">this</span>.<span class="property">_array</span>);</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			<span class="attr">next</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">				<span class="keyword">const</span> &#123; done, value &#125; = iterator.<span class="title function_">next</span>();</span><br><span class="line">				<span class="keyword">return</span> &#123;</span><br><span class="line">					<span class="attr">done</span>: done,</span><br><span class="line">					<span class="attr">value</span>: done ? <span class="literal">undefined</span> : <span class="title function_">callback</span>(value)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> myIterator = <span class="keyword">new</span> <span class="title class_">IteratorFromArray</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);</span><br><span class="line"><span class="keyword">var</span> newIterator = myIterator.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>);</span><br><span class="line">newIterator.<span class="title function_">next</span>(); <span class="comment">// &#123; done: false, value: 2 &#125;</span></span><br></pre></td></tr></table></figure>

<p>上面這段程碼是一個非常簡單的示範，但可以𢒆得出來每一次map雖然都會返回一個新的operator，但實際上在做元素運算時，因為漸進式的特性會使一個元素運算到底，Observable也是相同的概念。</p>
<p>漸進式取值的靣念在Observable中其實非常重要，這個特性也使得Observable相較於Array的operator在做運算時來的高效很多，尤其是在處理大量資料的時候會非常明顯！</p>
<h3 id="什麼是Subject"><a href="#什麼是Subject" class="headerlink" title="什麼是Subject?"></a>什麼是Subject?</h3><h4 id="Subject基本觀念"><a href="#Subject基本觀念" class="headerlink" title="Subject基本觀念"></a>Subject基本觀念</h4><p>我們之前的範例，每個observable都只訂閱一次，而實際上observable是可以多次訂閱的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> observerA$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(observerA$);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(observerB$);</span><br><span class="line"><span class="comment">// &quot;A next: 0&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 0&quot;</span></span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;A complete!&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;B complete!&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，分別用observerA$與observerB$訂閱了source$, 從log可以看出來observerA$跟observerB$都各自收到了元素，但請記得這兩個observer其實是<strong>分開執行</strong>的也就是說他們是完全獨立的，我們把observerB$延遲訂閱來證明看看</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> observerA$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(observerA$);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    source$.<span class="title function_">subscribe</span>(observerB$);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//A next:0 </span></span><br><span class="line"><span class="comment">//A next:1 </span></span><br><span class="line"><span class="comment">//B next:0 </span></span><br><span class="line"><span class="comment">//A next:2 </span></span><br><span class="line"><span class="comment">//A complete </span></span><br><span class="line"><span class="comment">//B next:1 </span></span><br><span class="line"><span class="comment">//B next:2 </span></span><br><span class="line"><span class="comment">//B complete </span></span><br></pre></td></tr></table></figure>

<p>這裡我們延遲一秒再用observerB$訂閱，可以從log中看出1秒後observerA$已經印到了1，這時observerB$開始印卻是從0開始，而不是接著observerA$的進度，代表這兩次的訂閱是完全分開來執行的、或者說是每次的訂閱都建立了一個新一執行。</p>
<p>這樣的行為在大部分的情境下適用，但有些案例下我們會希望第二次訂閱source$不會從頭開始接收元素，而是從第一次訂閱到當前處理的元素開始發送，我們把這種處理方式稱為組播(multicast)，那我們要如何做到組播呢?</p>
<h4 id="手動建立subject"><a href="#手動建立subject" class="headerlink" title="手動建立subject"></a>手動建立subject</h4><p>或許已經有讀者想到解法了，其實我們可以建立一個中間人來訂閱source再由中間人轉送資料出去，就可以達到我們想要的效果</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> observerA$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = &#123;</span><br><span class="line">    <span class="attr">observers</span>: [],</span><br><span class="line">    <span class="attr">addObserver</span>: <span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">push</span>(observer);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">next</span>(value))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observer</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">error</span>(error));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">complete</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">subject$.<span class="title function_">addObserver</span>(observerA$);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">addObserver</span>(observerB$);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//A next:0 </span></span><br><span class="line"><span class="comment">//A next:1 </span></span><br><span class="line"><span class="comment">//B next:1 </span></span><br><span class="line"><span class="comment">//A next:2 </span></span><br><span class="line"><span class="comment">//B next:2 </span></span><br><span class="line"><span class="comment">//A complete </span></span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看到，我們先建立了一個物件叫subject，這個物件具備observer所有的方法(next,error,complete), 並且還能addObserver把observer加到內部的清㽞中，每當有值送出就會遍歷清單中的所有observer並把值再次送出，這樣一來不管多久之後加進來的observer，都會是從當前處理到的元素接續往下走，就像範例中所示，我們用subject＄訂閱source並把observerA$加到subject$中，一秒後再把observerB$加到subject$，這時就可以看到observerB$是直接接教1開始，這就是組播(multicast)的行為。</p>
<p>讓我們把subject$的<code>addObserver</code>改名成<code>subscribe</code>如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> subject$ = &#123;</span><br><span class="line">    <span class="attr">observers</span>: [],</span><br><span class="line">    <span class="attr">subscribe</span>: <span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">push</span>(observer);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">next</span>(value))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observer</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">error</span>(error));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">complete</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>subject其實𣄵是用了Observer Pattern。但這邊為了不履混淆Observer Patter跟RxJS的observer就不再內文提及。</p>
</blockquote>
<p>雖然上面是我們自已手寫的subject，但運作方式跟RxJS的Subject實例是幾乎一樣的，我們把前面的程式碼改成RxJS提供的Subject試試</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> observerA$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA$);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB$);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//A next:0 </span></span><br><span class="line"><span class="comment">//A next:1 </span></span><br><span class="line"><span class="comment">//B next:1 </span></span><br><span class="line"><span class="comment">//A next:2 </span></span><br><span class="line"><span class="comment">//B next:2 </span></span><br><span class="line"><span class="comment">//A complete </span></span><br><span class="line"><span class="comment">//B complete </span></span><br></pre></td></tr></table></figure>

<p>大家會發現使用方法跟前面是相凹的，建立一個subject$先拿去訂閱observable(source$),再把我們真正的observer加到subject$中，這樣一來就能完成訂閱，而每個加到subject$中的observer都能整組的接收到相同的元素。</p>
<h4 id="什麼是Subjet"><a href="#什麼是Subjet" class="headerlink" title="什麼是Subjet?"></a>什麼是Subjet?</h4><p>雖然前面我們已經示範直接手寫一個簡單的subject, 但到底RxJS中的Subject的概念到底是什麼呢？</p>
<p>首先Subject可以拿去訂閱Observable(source)代表他是一個Observer，同時Subject𦙆可以被Observer(observerA$,observerB$)訂閱，代表他是一個Observable。</p>
<p>總結成兩句話</p>
<ul>
<li>Subject同時是Observable又是Observer</li>
<li>Subject會對內部的observers清單進行組(multicast)</li>
</ul>
<h3 id="Subject-BehaviorSubject-ReplaySubject-AsyncSubject"><a href="#Subject-BehaviorSubject-ReplaySubject-AsyncSubject" class="headerlink" title="Subject, BehaviorSubject, ReplaySubject, AsyncSubject"></a>Subject, BehaviorSubject, ReplaySubject, AsyncSubject</h3><p>上面介紹Subject是什麼，今天要講Subject一些應用方式，以及Subject的另外三種變形。</p>
<h4 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h4><p>實際上Subject就是Observer Pattern的實作，他會在內部管理一份observer的清單，並在接收到值時遍歷這份清單並送出值，所以我們可以這樣用Subject</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 1&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 2&quot;</span></span><br></pre></td></tr></table></figure>

<p>這裡我們可以直接用subject的next方法傳送值，所有訂閱的obsrver就會接收到，又因為Subject本身是Observable，所以這樣的使用方式很適合用在某些無法直接使用Observable的前端框架中，例如在React想對DOM的事件做監聽</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyButton</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subject</span> = <span class="keyword">new</span> <span class="title class_">Rx</span>.<span class="title class_">Subject</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subject</span></span><br><span class="line">            .<span class="title function_">mapTo</span>(<span class="number">1</span>)</span><br><span class="line">            .<span class="title function_">scan</span>(<span class="function">(<span class="params">origin, next</span>) =&gt;</span> origin + next)</span><br><span class="line">            .<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">count</span>: x &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;event</span> =&gt;</span> this.subject.next(event)&#125;&gt;&#123;this.state.count&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看出來，𦙲為React本身API的關系，如果我們想要用React自訂的事件，我們沒辦法直接使用Observable的creation operator建立observable，這時就可以靠Subject來做到這件事。</p>
<p>Subject因為同時是observer和observable，所以應用面很廣除了前面所提的之外，還有之前有提到的組播(multicase)特性也會在接下來的文章做更多應用的介紹，這裡先來看看Subject的三個變形。</p>
<h4 id="BehaviorSubject"><a href="#BehaviorSubject" class="headerlink" title="BehaviorSubject"></a>BehaviorSubject</h4><p>很多時候我們會希望Subject能代表當下的狀態，而不是單純的事件發送，也就是說如果今天有一個新的訂閱，我們希望Subject能立即給出最新的值，而不是沒有回應，例如下面這個例子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 3&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);<span class="comment">// 3 秒後才訂閱，observerB 不會收到任何值。</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>以上這個例子來說，observerB訂閱的之後，是不會有任何元素送給observerB的，因為在這之後沒有執行何何<code>subject$.next()</code>, 但很多時候我們會希望subject能夠表達當前的狀態，在一訂閱時就能收到最新的狀態是什麼，而不是訂閱後要等到有變動才能接收到新的狀態，以這個例子來說，我們希望observerB訂閱時就能立即收到<code>3</code>, 希望做到這樣的效果就可以用BehaviorSubject。</p>
<p>BehaviroSubject跟Subject最大的不同就是BehaviorSubject是用來呈現當前的值，而不是單純的發送事件。BehaviorSubject會記住最新一次發送的元素，並把該元素當作目前的值，在使用上BehaviroSubject建構式需要傳入一個參數來代表起始的狀態，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BehaviorSubject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">BehaviorSubject</span>(<span class="number">0</span>);<span class="comment">// 0 為起始值</span></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"><span class="comment">// &quot;A next: 0&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 3&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// &quot;B next: 3&quot;</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>從上面這個範例可以看得出來BehaviorSubject在建立時就需要給𡥞一個狀態，並在任何一次訂閱，就會先送出最新的狀態。其實這種行為就是一種狀態的表達而非單純的事件，就像是年齡跟生日一樣，年齡是一種狀態而生日就是事件；所以當我們想要用一個steam來達年齡時，就應用BehaviroSubject。</p>
<h4 id="ReplaySubject"><a href="#ReplaySubject" class="headerlink" title="ReplaySubject"></a>ReplaySubject</h4><p>在某些時候我們會希望Subject代表事件，但又能在新訂閱重新發送最後的幾個元素，這時我們新可以用ReplaySubject範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ReplaySubject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">ReplaySubject</span>(<span class="number">2</span>);<span class="comment">//重複發送最後2個元素</span></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 3&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// &quot;B next: 2&quot;</span></span><br><span class="line">    <span class="comment">// &quot;B next: 3&quot;</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>可能會有人以為<code>ReplaySubject(1)</code>是不是就等同於BehaviroSubject，其實是不一樣的，BehaviorSubject在建立時就會有起始值，比如<code>BehaviroSubject(0)</code>起始值就是<code>0</code>, BehaviorSubject是代表著狀態而ReplaySubject只是事件的重放而已。</p>
<h4 id="AsyncSubject"><a href="#AsyncSubject" class="headerlink" title="AsyncSubject"></a>AsyncSubject</h4><p>AsyncSubject是最怪的一個變形，他有點像是operator<code>last</code>，會在subject結事後送出最一個值，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AsyncSubject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">AsyncSubject</span>();</span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">subject$.<span class="title function_">complete</span>();</span><br><span class="line"><span class="comment">// &quot;A next: 3&quot;</span></span><br><span class="line"><span class="comment">// &quot;A complete!&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// &quot;B next: 3&quot;</span></span><br><span class="line">    <span class="comment">// &quot;B complete!&quot;</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看出來，AsyncSubject會在subject結束後才送出最後一個值，其實這個行為跟Promise很像，絕大部分的時候都是使用BehaviorSubject跟ReplaySubject或Subject。</p>
<h3 id="multicast-refCount-publish-share"><a href="#multicast-refCount-publish-share" class="headerlink" title="multicast, refCount, publish, share"></a>multicast, refCount, publish, share</h3><p>有講到Subject時，是希望能夠讓Observable有新訂閱時，可以共用前一個訂閱而不要從頭開始，如下面的例子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 0&quot;</span></span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;A complete!&quot;</span></span><br><span class="line"><span class="comment">// &quot;B complete!&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼我們用subject訂閱了source$, 再把observerA跟observerB一個僤訂閱到subject, 這樣就可以讓observarA跟observerB共用同一個執行，但這樣的寫法會讓程式碼看起來太過複雜，我們可以用Observable的multicast operator來簡化這段程式</p>
<h4 id="multicast"><a href="#multicast" class="headerlink" title="multicast"></a>multicast</h4><p>multicast可以用來載subject並回傳一個可連結(connectable)的observable，如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, multicast &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">3</span>),</span><br><span class="line">    <span class="title function_">multicast</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Subject</span>())</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line">source$.<span class="title function_">connect</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    source$.<span class="title function_">subscribe</span>(observerB)</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>上面這段程試碼我們透過multicast來掛載一個subject$之後這個observable(source$)的訂閱其實都是訂閱到subject$上。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">source$.<span class="title function_">subscribe</span>(observerA);<span class="comment">// subject.subscribe(observerA)</span></span><br></pre></td></tr></table></figure>

<p>必須真的等到執行<code>connect()</code>後才會真的用subject$訂閱source$,並開始送出元素，如果沒有執行<code>connect()</code>observable是不會真正執行的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">source$.<span class="title function_">connect</span>();</span><br></pre></td></tr></table></figure>

<p>另外值得注意的是這裡要退訂的話要把<code>connect()</code>回傳的subscription退訂才會直正停止observable的執行，如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;send: &quot;</span> + x)),</span><br><span class="line">    <span class="title function_">multicast</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Subject</span>())<span class="comment">// 無限的 observable </span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionA = source$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"><span class="keyword">var</span> realSubscription = source$.<span class="title function_">connect</span>();</span><br><span class="line"><span class="keyword">var</span> subscriptionB;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionB = source$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionA.<span class="title function_">unsubscribe</span>();</span><br><span class="line">    subscriptionB.<span class="title function_">unsubscribe</span>();</span><br><span class="line">    <span class="comment">// 這裡雖然 A 跟 B 都退訂了，但 source 還會繼續送元素</span></span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    realSubscription.<span class="title function_">unsubscribe</span>();</span><br><span class="line">    <span class="comment">// 這裡 source 才會真正停止送元素</span></span><br><span class="line">&#125;, <span class="number">7000</span>);</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，必須等到<code>realSubscription.unsubscribe()</code>執行完，source$才會真的結束。</p>
<p>雖然用了multicast感覺會讓我們處理的對象少一點，但必須搭配connect一起使用還是讓程式碼有點複雜，通常我們會希望有observer訂閱時，就立即執行並發送元素，而不要再多執行一個方法(connect)，這時我們就可以用refCount</p>
<h4 id="refCount"><a href="#refCount" class="headerlink" title="refCount"></a>refCount</h4><p>refCount必須搭配multicast一起使用，他可以建立一個只要有訂閱就會自動connect的observable,範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;send: &quot;</span> + x)),</span><br><span class="line">    <span class="title function_">multicast</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Subject</span>()),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionA = source$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"><span class="comment">//訂閱數 0 =&gt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionB;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionB = source$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// 訂閱數 0 =&gt; 2</span></span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，當source$一被observerA訂閱時(訂閱數從0變成1)，就會立即執行並發送元素，我們就不需要再額外執行connect。</p>
<p>同樣的在退訂時只要訂閱數變成0就會自動停止發送</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;send: &quot;</span> + x)),</span><br><span class="line">    <span class="title function_">multicast</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Subject</span>()),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionA = source$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"><span class="comment">//訂閱數 0 =&gt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionB;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionB = source$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// 訂閱數 0 =&gt; 2</span></span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionA.<span class="title function_">unsubscribe</span>();<span class="comment">// 訂閱數 2 =&gt; 1</span></span><br><span class="line">    subscriptionB.<span class="title function_">unsubscribe</span>();<span class="comment">// 訂閱數 1 =&gt; 0，source 停止發送元素</span></span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>

<h4 id="publish"><a href="#publish" class="headerlink" title="publish"></a>publish</h4><p>其實<code>multicast(()=&gt; new Subject())</code>很常用到，我們有一個簡化的寫法那就是publish,下面這兩段程式碼是完全等價的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">publish</span>(),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new Subject()),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br></pre></td></tr></table></figure>

<p>加上Subject的三種變形</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, publishReplay, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">publishReplay</span>(<span class="number">1</span>),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new publishReplay(1)),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, publishReplay, publishBehavior, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">publishBehavior</span>(<span class="number">1</span>),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new publishBehavior(0)),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, publishReplay, publishBehavior, publishLast, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">publishLast</span>(),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new publishLast()),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br></pre></td></tr></table></figure>

<h4 id="share"><a href="#share" class="headerlink" title="share"></a>share</h4><p>另外publish+ refCount可以在簡寫成share</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, publishReplay, publishBehavior, publishLast, refCount, share &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">share</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     publish(),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new Subject()),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Subject總結"><a href="#Subject總結" class="headerlink" title="Subject總結"></a>Subject總結</h3><p>Subject其實在RxJS中最常被誤解的一部份，因為Subject可以讓你用命令式的方式送值到一個observable的串流中。很多人會直接把這個特性拿來用在<strong>不知道如何建立Observable的狀況</strong>。</p>
<h4 id="Subject與Observable的差異"><a href="#Subject與Observable的差異" class="headerlink" title="Subject與Observable的差異"></a>Subject與Observable的差異</h4><p>永遠記得Subject其實是Observer Design Pattern的實作，所以當observer訂閱到subject時，subject會把訂閱者塞到一份訂閱者清單，在元素發送時就是在遍歷這份清單，並把元素一一送出，這跟Obserbable像是一個function執𢓝是完全不同的。</p>
<p>Subject之所以具有Observable的所有方法，是因為Subject繼承了Observerable的型別，其實Subject型別中主要實做的方法只有next、error、complete、subscribe及unsubscribe這五個方法。而這五個方法就是依照Observer Pattern下法實作的。</p>
<p>總而言之，Subject是Observable的子類別，這個子類別當中用上述的五個方法實作了Observer Pattern，所以他同時具有Observable與Observer的特性。而跟Observable最大的差異就是Subject是具有狀態的，也就是儲存的那份清單！</p>
<p>因為Subject在訂閱時，是把observer放到一分清單當中，並在元素要送出(next)的時候遍歷這份清單，大概就像下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="title function_">next</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// observers 是一個陣列存所有的observer</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i &lt; observers.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        observers[i].<span class="title function_">next</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p>這會衍伸一個大問題，就是在某個observer發生錯誤卻沒有做錯誤處理時，就會影響到別的訂閱，看下面這個例子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">const</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"><span class="keyword">const</span> example$ = subject$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;oops&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A,&quot;</span>, x));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B,&quot;</span>, x));</span><br><span class="line">subject$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C,&quot;</span>, x));</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br></pre></td></tr></table></figure>

<p>上面這個例子，可能會預期B會在送出1的時候掛掉，另外A跟C會持續發送元素，確實正常應該像這樣運作，但目前RxJX的版植中會B報錯之後，A跟C也同時停止運行。原因就像之前所提的，在遍歷所有的obsever時發生了例外會導到之後的行為停止。</p>
<p>那要如何解決這個問題呢？目前最簡單的方式，當然是盡可能地把所有observer的錯誤處理加進去，這樣一來就不會有例外發生</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">const</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"><span class="keyword">const</span> example$ = subject$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;oops&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A,&quot;</span>, x),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A Error:&quot;</span> + error));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B,&quot;</span>, x),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B Error:&quot;</span> + error));</span><br><span class="line">subject$.<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C,&quot;</span>, x),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C Error:&quot;</span> + error));</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br></pre></td></tr></table></figure>

<p>像上面這段程式碼，當B發生錯誤時就只有B會停止，而不會影響A跟C。</p>
<h4 id="一定需要使用Subject的時機"><a href="#一定需要使用Subject的時機" class="headerlink" title="一定需要使用Subject的時機"></a>一定需要使用Subject的時機</h4><p>Subject正常應該是當我們一個observable的操作過程中發生了side-effect而我們不希望這個side-effect因為多個subscribe而被觸發多次，比如下面這段程式碼？</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, asapScheduler &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> result$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">6</span>),</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="title class_">Math</span>.<span class="title function_">random</span>())<span class="comment">// side-effect，平常有可能是呼叫 API 或其他 side effect</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subA$ = result$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A: &quot;</span> + x));</span><br><span class="line"><span class="keyword">var</span> subB$ = result$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B: &quot;</span> + x));</span><br></pre></td></tr></table></figure>

<p>這段程式碼A跟B印出來的亂數就不一樣，代表random(side-effect)被執行了兩次，這種情況就一定會用到subject(或其相關的operators)</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, asapScheduler, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, take, multicast, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> result$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">6</span>),</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="title class_">Math</span>.<span class="title function_">random</span>()),<span class="comment">// side-effect</span></span><br><span class="line">    <span class="title function_">multicast</span>(<span class="keyword">new</span> <span class="title class_">Subject</span>()),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subA$ = result$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A: &quot;</span> + x));</span><br><span class="line"><span class="keyword">var</span> subB$ = result$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B: &quot;</span> + x));</span><br></pre></td></tr></table></figure>

<p>改成這樣後我們就讓side-effect不因為訂閱數而多執行，這種情狀就是一定要用subject的。</p>
<h3 id="簡易實作Observable-一"><a href="#簡易實作Observable-一" class="headerlink" title="簡易實作Observable(一)"></a>簡易實作Observable(一)</h3><p>為什麼是簡易實作而不是完整實作呢？實作Observable其實只是幫助我們理解Observable的運作方式，所以會盡可能地簡單，容易理解及吸收。</p>
<h4 id="重點觀念"><a href="#重點觀念" class="headerlink" title="重點觀念"></a>重點觀念</h4><p>Observable跟Observer Pattern是不同的，Observable內部並沒有管理一份訂閱清單，<strong>訂閱Observable就像是執行一個function一樣！</strong></p>
<p>所以實作過程的重點</p>
<ul>
<li><p>訂閱就是執行一個function</p>
</li>
<li><p>訂閱接收的物件具備next,error,complete三個方法</p>
</li>
<li><p>訂閱會返回一個可退訂(unsubscribe)的物件</p>
</li>
</ul>
<h4 id="基本observable實作"><a href="#基本observable實作" class="headerlink" title="基本observable實作"></a>基本observable實作</h4><p>先用最簡單的function來建立observable物件</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">subscriber</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> observable = &#123;</span><br><span class="line">        <span class="attr">subscribe</span>: <span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">            <span class="title function_">subscriber</span>(observer)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼就可以做最簡單的訂閱，像下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">subscriber</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> observable = &#123;</span><br><span class="line">        <span class="attr">subscribe</span>: <span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">            <span class="title function_">subscriber</span>(observer)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>這時候我們已經有最簡單的功能了，但這裡有一個大問題，就是observable在結束(complete)就不應該再發送元素</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&quot;still work&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// &quot;complete!&quot;</span></span><br><span class="line"><span class="comment">// &quot;still work&quot;</span></span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看到comlete之後還是能送出元素來，另外還有一個問題就是observer，如果不完整的就會出錯，這也不是我們希望看到的。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&quot;still work&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br><span class="line"><span class="comment">//observer.complete is not a function </span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼可以看出來，當使用者observe物件沒有complete方法時，就會報錯。我們應該修正這兩個問題！</p>
<h4 id="實作簡易Observer"><a href="#實作簡易Observer" class="headerlink" title="實作簡易Observer"></a>實作簡易Observer</h4><p>要修正這兩個問題其實並不難，我們只要實作一個Observer的類別，每次使用者傳入的observer都會利用這個類別轉乘我們想要Observer物件。</p>
<p>首先訂閱時有可能傳入一個observer物件，或是一到三個function,error,complete,所以我們要建立一個類別可以接受各重可能的參數</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">arguments</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="comment">// 空的 observer</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (!destinationOrNext) &#123;</span><br><span class="line">                    <span class="comment">// 空的 observer</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> destinationOrNext === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 傳入了observer物件</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="comment">//如果上面都不是，代表應該是傳入了一到三個function</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>寫一個方法(safeObserver)來回傳正常的observer</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">         <span class="comment">// ... 一些程式碼</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">safeObserver</span>(<span class="params">observerOrNext, error, complete</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> next;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> (observerOrNext) === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">            <span class="comment">// observerOrNext 是 next function</span></span><br><span class="line">            next = observerOrNext;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (observerOrNext) &#123;</span><br><span class="line">            <span class="comment">// observerOrNext 是 observer 物件</span></span><br><span class="line">            next = observerOrNext.<span class="property">next</span> || <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;;</span><br><span class="line">            error = observerOrNext.<span class="property">error</span> || <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> err;</span><br><span class="line">            &#125;;</span><br><span class="line">            complete = observerOrNext.<span class="property">complete</span> || <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//最後回傳我們預期的 observer 物件</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">next</span>: next,</span><br><span class="line">            <span class="attr">error</span>: error,</span><br><span class="line">            <span class="attr">complete</span>: complete</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再把constructor完成</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 預設空的 observer</span></span><br><span class="line"><span class="keyword">const</span> emptyObserver = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">() =&gt;</span> &#123; &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="keyword">throw</span> err; &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">arguments</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="comment">// 空的 observer</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(emptyObserver);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (!destinationOrNext) &#123;</span><br><span class="line">                    <span class="comment">// 空的 observer</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(emptyObserver);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> destinationOrNext === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 傳入了observer物件</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(destinationOrNext);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="comment">//如果上面都不是，代表應該是傳入了一到三個function</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(destinationOrNext, error, complete);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">safeObserver</span>(<span class="params">observerOrNext, error, complete</span>) &#123;</span><br><span class="line">       <span class="comment">// ... 一些程式碼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡我們把真正的observer塞到<code>this.destination</code> 接著完成obsserver的方法。</p>
<p>Observer的三個主要的方法(next,error,complete)都應該結束或退訂後不能再被執行，所以我們在物件內部偷塞一個boolean值來作為是否曾經結束的依據。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 一些程式碼</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">safeObserver</span>(<span class="params">observerOrNext, error, complete</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 一些程式碼</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">unsubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStopped</span> = <span class="literal">true</span>; <span class="comment">// 偷塞一個屬性 isStopped</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著實作三個主要的方法就很簡單了，只要先判斷<code>isStopped</code>在使用<code>this.destination</code>物件來傳送值就可以了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 一些程式碼</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">safeObserver</span>(<span class="params">observerOrNext, error, complete</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 一些程式碼</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">next</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isStopped</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">next</span>) &#123;</span><br><span class="line">      <span class="comment">// 先判斷是否停止過</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">next</span>(value); <span class="comment">// 傳送值</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">error</span>(<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isStopped</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">error</span>) &#123;</span><br><span class="line">      <span class="comment">// 先判斷是否停止過</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">error</span>(err); <span class="comment">// 傳送錯誤</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (anotherError) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">        <span class="keyword">throw</span> anotherError;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">complete</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isStopped</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">complete</span>) &#123;</span><br><span class="line">      <span class="comment">// 先判斷是否停止過</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">complete</span>(); <span class="comment">// 發送停止訊息</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>(); <span class="comment">// 發送停止訊息後退訂</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">unsubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStopped</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到這裡我們就完成基本的Observer實作了，接著我讓我們拿到基本版的observable中使用吧。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">subscriber</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observable = &#123;</span><br><span class="line">        <span class="attr">subscribe</span>: <span class="keyword">function</span> (<span class="params">observerOnNext, error, complete</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> realObserver = <span class="keyword">new</span> <span class="title class_">Observer</span>(observerOnNext, error, complete)</span><br><span class="line">            <span class="title function_">subscriber</span>(realObserver);</span><br><span class="line">            <span class="keyword">return</span> realObserver;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// complete!</span></span><br></pre></td></tr></table></figure>

<p>到這裡我們就完成基本的observable了，至少基本的行為都跟我們期望的一致。</p>
<h3 id="簡易實作Observable-二"><a href="#簡易實作Observable-二" class="headerlink" title="簡易實作Observable(二)"></a>簡易實作Observable(二)</h3><p>在上面的文章，我們已經完成了基本的observable以及Observer的簡易實作，這裏會接續上面的文章來實作簡易的Observable類別，以及一個creation operator和一個transform operator。</p>
<h4 id="建立簡易Observable類別"><a href="#建立簡易Observable類別" class="headerlink" title="建立簡易Observable類別"></a>建立簡易Observable類別</h4><p>這是我們上面文章建屯的observable物件的函式</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observable = &#123;</span><br><span class="line">        <span class="attr">subscribe</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> realObserver = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">            <span class="title function_">subscribe</span>(realObserver);</span><br><span class="line">            <span class="keyword">return</span> realObserver;</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從這個函式可以看出來，回傳的observable物件至少會有subscribe方法，所以最簡單的Observable類別大概長像下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// ...做某些事</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外create的函式在執行時會傳入一個subscribe的function，這個function會決定observable的行為</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span>(<span class="params">observer</span>)&#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>把上面這一段改成下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="keyword">function</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">  observer.<span class="title function_">complete</span>();</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>所以我們的Observable的建構式應該會接收一個subscribe function</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (subscribe) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_subscribe</span> = subscribe;<span class="comment">//把subscribe存到 _subscribe屬性中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);<span class="comment">//就是執行一個function對吧</span></span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到這裡我們就成功的把create的函式改成Observable的類別了，我們可以直接來使用看看</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (subscribe) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_subscribe</span> = subscribe;<span class="comment">//把subscribe存到 _subscribe屬性中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);<span class="comment">//就是執行一個function對吧</span></span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br></pre></td></tr></table></figure>

<p>當然我們可以仿RxJS在靜態方法中加入create如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (subscribe) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_subscribe</span> = subscribe;<span class="comment">//把subscribe存到 _subscribe屬性中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);<span class="comment">//就是執行一個function對吧</span></span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Observable</span>.<span class="property">create</span> = <span class="keyword">function</span> (<span class="params">subscribe</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observable</span>(subscribe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這樣一來我們就可以用<code>Observable.create</code>建立observable物件實例。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="keyword">function</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">  observer.<span class="title function_">complete</span>();</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="建立creation-operator-fromArray"><a href="#建立creation-operator-fromArray" class="headerlink" title="建立creation operator - fromArray"></a>建立creation operator - fromArray</h4><p>當我們有Obserbable類別後要建立creation operator就不難了，這裡我們建立一個fromArray的方法，可以接收array來建立observable，算是Rx的Observable.from的簡化版本，記得creation operators都屬於static方法。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(subscribe) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_subscribe</span> = subscribe; <span class="comment">// 把 subscribe 存到屬性中</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);</span><br><span class="line">    <span class="keyword">return</span> observer;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立靜態方法 </span></span><br><span class="line"><span class="title class_">Observable</span>.<span class="property">fromArray</span> = <span class="keyword">function</span>(<span class="params">array</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(array)) &#123;</span><br><span class="line">        <span class="comment">// 如果傳入的參數不是陣列，則拋出例外</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;params need to be an array&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="keyword">function</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 遍歷每個元素並送出</span></span><br><span class="line">            array.<span class="title function_">forEach</span>(<span class="function"><span class="params">value</span> =&gt;</span> observer.<span class="title function_">next</span>(value))</span><br><span class="line">            observer.<span class="title function_">complete</span>()</span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            observer.<span class="title function_">error</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observable = <span class="title class_">Observable</span>.<span class="title function_">fromArray</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]);</span><br></pre></td></tr></table></figure>

<p>上面的程式碼我們只是簡單的用new Observable就可以輕鬆地實現我們要的功能，之後就可以用fromArray來建立observable物件。</p>
<h4 id="建立transform-operator-map"><a href="#建立transform-operator-map" class="headerlink" title="建立transform operator - map"></a>建立transform operator - map</h4><p>相信很多人在實作Observable都是卡在這個階段，因為operators都是回傳一個新的observable這中間有很多細節需要注意，並且有些小技巧才能比較好的實現，在開始實作之前，先釐清幾個重點。</p>
<ul>
<li><p>operators(transform,filter,conditional…)都是回傳一個新的observable</p>
</li>
<li><p>大部分的operator其實就是在原本observer外包裹一層物件，讓執行next方法前先把元素做一次處理</p>
</li>
<li><p>operator回傳的opservable訂閱時，還是需要執行原本的observable(資料源)，也就說我們要想辦法保留原本的observable</p>
</li>
</ul>
<p>讓我們一步一步來，首先operators執行完會回傳一個新的observable，這個observable在訂閱時會先去執行operator的行為再發送元素，所以observable的訂閱方法就不能像現在這樣直接把observer傳給subscribe執行</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(subscribe)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_subscribe</span>=subscribe;<span class="comment">// 把subscribe存到屬性中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Obserer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="comment">// 先做某個判斷是否當前的observable是具有operator的</span></span><br><span class="line">        <span class="keyword">if</span>(??)&#123;</span><br><span class="line">           <span class="comment">// 用operator 的操作</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="comment">// 如果沒有operator再直接把observer丟給_subscribe</span></span><br><span class="line">           <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer) </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以我們的Observable實作為例，這裡最重要的就是this._subscribe執行，每當執行時就是開始發送元素</p>
</blockquote>
<p>這裡我們可以想像一下當一個map產生的observable訂閱時，應該先判斷出有map這個operator並且傳入原本的資料源以及當前的observer，也就是說我們的map至少有以下這幾件事要做</p>
<ul>
<li><p>建立新的observable</p>
</li>
<li><p>保存原本的observable(資料源)，之後訂閱才有辦法執行</p>
</li>
<li><p>建立並保存operator本身的行為，等到訂閱時執行</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="comment">// 一些程式碼...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">       <span class="comment">// 一些程式碼...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">map</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>();<span class="comment">//邁立新的observable</span></span><br><span class="line">        observable.<span class="property">source</span> = <span class="variable language_">this</span>;<span class="comment">//保存當前的observable(資料源)</span></span><br><span class="line">        opservable.<span class="property">operator</span> = &#123;</span><br><span class="line">            <span class="attr">call</span>: <span class="function">(<span class="params">observer, source</span>) =&gt;</span> &#123;<span class="comment">//執行這個operator的行障</span></span><br><span class="line"></span><br><span class="line">            &#125;<span class="comment">// 儲存當前operator行為，並作為是否有operator的依據</span></span><br><span class="line">        &#125;;<span class="comment">//</span></span><br><span class="line">        <span class="keyword">return</span> observable;<span class="comment">//返回這個新的observable</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面這三個步驟都是必要的，特別是用了<code>observalbe.source=this</code>這個小技巧，來保存原本的observable。但這裡我們還有一個地方沒完成就是operator要做的事，這個部分我們等一下再補，先把subscribe寫完</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="comment">// 一些程式碼...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="comment">//先用this.operator判斷當前的observable是否具有operator</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">operator</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">operator</span>.<span class="title function_">call</span>(observer, <span class="variable language_">this</span>.<span class="property">source</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果沒有operator再直接把observer丟給_subscribe</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">map</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>();<span class="comment">//邁立新的observable</span></span><br><span class="line">        observable.<span class="property">source</span> = <span class="variable language_">this</span>;<span class="comment">//保存當前的observable(資料源)</span></span><br><span class="line">        opservable.<span class="property">operator</span> = &#123;</span><br><span class="line">            <span class="attr">call</span>: <span class="function">(<span class="params">observer, source</span>) =&gt;</span> &#123;<span class="comment">//執行這個operator的行障</span></span><br><span class="line"></span><br><span class="line">            &#125;<span class="comment">// 儲存當前operator行為，並作為是否有operator的依據</span></span><br><span class="line">        &#125;;<span class="comment">//</span></span><br><span class="line">        <span class="keyword">return</span> observable;<span class="comment">//返回這個新的observable</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>記得這裡補的subscribe行為，已經是map回傳新observable的行為，不是原本的observable了。</p>
<p>到這裡我們就幾乎要完成了，接著只要實作map這個operator的行為就可以囉！記得我們前面講的operator其實就是在原本的observer做一層包裏，讓next執行前先對元素做處理。所以我們改寫一下Observer並建立一個MapObserver來做這件事</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">arguments</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="comment">// 空的 observer</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(emptyObserver);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (!destinationOrNext) &#123;</span><br><span class="line">                    <span class="comment">// 空的 observer</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(emptyObserver);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//多一個判斷，是否傳入的destinationOrNext原本就是Observer的實例，如果是就不用在用執行`this.safeObserver`</span></span><br><span class="line">                <span class="keyword">if</span> (destinationOrNext <span class="keyword">instanceof</span> <span class="title class_">Observer</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = destinationOrNext;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> destinationOrNext === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 傳入了observer物件</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(destinationOrNext);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="comment">//如果上面都不是，代表應該是傳入了一到三個function</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(destinationOrNext, error, complete);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...下面都一樣</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MapObserver</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">observer, callback</span>) &#123;</span><br><span class="line">        <span class="comment">// 這裡會傳入原來的observer跟map的callback</span></span><br><span class="line">        <span class="variable language_">super</span>(observer);<span class="comment">//因為有繼承所以要先執行一次父層的建構式</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">callback</span> = callback;<span class="comment">//保存callback</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">next</span> = <span class="variable language_">this</span>.<span class="property">next</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);<span class="comment">//確保next的this</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">next</span>(<span class="variable language_">this</span>.<span class="title function_">callback</span>(value));</span><br><span class="line">            <span class="comment">//this.destination是父層Observer保存的observer物件</span></span><br><span class="line">            <span class="comment">//這裡this.callback(value)就是map的操作</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">error</span>(err);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼就可以讓我們包裹observer物件，利用物件的繼承覆寫原本的next方法。</p>
<p>最後我們就只要補完map方法就可以了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">    <span class="comment">// 一些程式碼...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 一些程式碼...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">map</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>(); </span><br><span class="line">    observable.<span class="property">source</span> = <span class="variable language_">this</span>;</span><br><span class="line">    observable.<span class="property">operator</span> = &#123;</span><br><span class="line">      <span class="attr">call</span>: <span class="function">(<span class="params">observer, source</span>) =&gt;</span> &#123; </span><br><span class="line">        <span class="comment">// 執行這個 operator 的行為</span></span><br><span class="line">        <span class="keyword">const</span> newObserver = <span class="keyword">new</span> <span class="title class_">MapObserver</span>(observer, callback);</span><br><span class="line">        <span class="comment">// 建立包裹後的 observer</span></span><br><span class="line">        <span class="comment">// 訂閱原本的資料源，並回傳</span></span><br><span class="line">        <span class="keyword">return</span> source.<span class="title function_">subscribe</span>(newObserver);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;    </span><br><span class="line">    <span class="keyword">return</span> observable; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡做的事情就簡單很多，我們只要建立包裹過的observer，並用這個包裹後的observer訂閱原本的source。(記得這個function是在subscribe時執行的)</p>
<h4 id="Scheduler基本觀念"><a href="#Scheduler基本觀念" class="headerlink" title="Scheduler基本觀念"></a>Scheduler基本觀念</h4><p>在前面的文章中有提到Scheduler是為了解決RxJS衍生的最後一個問題。</p>
<p>其實RxJS用久了之後就會發現Observable有一個優勢是可以同時處理同步和非同步行為，但這個優勢也帶來了一個問題，就是我們常常會搞不清楚現在的observable執行方式是同步的還是非同步的。換句話話，我們很容易搞不清楚observable到什麼時候開如發送元素！</p>
<p>舉例來說，我們可能很清楚<code>interval</code>是非同步送出元素的，但<code>range</code>呢？<code>from</code>呢?他們可能有時候是非同步有時候是同步，這就會變得有點困擾，尤其在除錯執行順序就非常重要。</p>
<p>而Scheduler其本上就是拿來處理這個問題的!</p>
<h4 id="什麼是Scheduler"><a href="#什麼是Scheduler" class="headerlink" title="什麼是Scheduler?"></a>什麼是Scheduler?</h4><p>Scheduler控制一個observable的訂閱什麼時候開始，以及發送元素什麼時候送達，主要由以下三個元素所組成</p>
<ul>
<li><p>Scheduler是一個資料結構，它知道如何根據優先級或其他標準來儲存並佇列任務。</p>
</li>
<li><p>Scheduler是一個執行環境。它意味著任務何時何地被執行，比如像是立即執行、在回呼(callback)中執行、setTimeout中執行、animation frame中執行</p>
</li>
<li><p>Scheduler是一個虛擬時鐘。它透過<code>now()</code>這個方法提供了時間的概念，我們可以讓任務在特定的時間點被執行。</p>
</li>
</ul>
<p>簡言之Scheduler會影響Observable開始執行及元素送達的時機，比如下這個例子  </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span>, asyncScheduler &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; observeOn &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observable = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;before subscribe&quot;</span>);</span><br><span class="line">observable.<span class="title function_">pipe</span>(<span class="title function_">observeOn</span>(asyncScheduler)).<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;after subscribe&quot;</span>);    </span><br><span class="line"><span class="comment">// &quot;before subscribe&quot;</span></span><br><span class="line"><span class="comment">// &quot;after subscribe&quot;</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// &quot;complete&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼原本是同步執行的，但我們用了<code>observable.pipe(observeOn(asyncScheduler))</code>原本是同步執行的就變成了非同步執行了。</p>
<h4 id="有哪些Scheduler可以用"><a href="#有哪些Scheduler可以用" class="headerlink" title="有哪些Scheduler可以用"></a>有哪些Scheduler可以用</h4><p>目前有下面幾種以版本6來說</p>
<ul>
<li>queue</li>
<li>asap</li>
<li>async</li>
<li>animatonFrame</li>
</ul>
<p>會在下面搭配程式碼一一講解</p>
<h4 id="使用Scheduler"><a href="#使用Scheduler" class="headerlink" title="使用Scheduler"></a>使用Scheduler</h4><p>其實我們在使用各種不同的operator時，這些operator就會各自預設不同的scheduler，例如一個無限的observable就會預設為<code>queur</code>Scheduler，而timer相關的operator則預設為<code>async</code>Scheduler。</p>
<p>要使用Scheduler除了前面用到的<code>observeOn()</code>方法外，以下這幾個creation operators最後一個參都能接收Scheduler</p>
<ul>
<li>bindCallback</li>
<li>bindNodeCallback</li>
<li>empty</li>
<li>from</li>
<li>interval</li>
<li>merge</li>
<li>of</li>
<li>range</li>
<li>throw</li>
<li>timer</li>
</ul>
<p>例如下面這個例子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, asyncScheduler &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; observeOn &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> observable = <span class="title function_">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">observeOn</span>(asyncScheduler)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>另外還有多個operators最後一個參數可以傳入Scheduler這邊就不一一列出，可以參考<a href="https://rxjs-dev.firebaseapp.com/api">官方</a>文件，最通用的方式還是<code>observeOn()</code>只要是observable就可以用這個方法。</p>
<h4 id="queue"><a href="#queue" class="headerlink" title="queue"></a>queue</h4><p>queue的運作方式跟預設的立即執行很像，但是當我們使用到遞回方法時，他會佇列這些行為而非直接執行，一個遞回的operator就是他會執行另一個operator, 最好的例子就是<code>repeat()</code>，如果我們不給他參數的話，他會執行無限多次，像下面這個例子</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, asyncScheduler, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; repeat, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="title function_">of</span>(<span class="number">10</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">repeat</span>(),</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">1</span>)</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p>在RxJS6中他預設了無限的observable為queue所以他會把repeat的next行為先佇列起來，因為前一個complete還在執行中，而這時repeat就會回傳一個可退訂的物件給<code>take(1)</code>等到repeat的next被第一次執行時就會結束，因為<code>take(1)</code>會直接收到值。</p>
<h5 id="使用情境"><a href="#使用情境" class="headerlink" title="使用情境"></a>使用情境</h5><p>quere很適合用在會有遞回的operator且具有大量資料時使用，在這個情況下queue能避免不必要的效能損秏。</p>
<h4 id="asap"><a href="#asap" class="headerlink" title="asap"></a>asap</h4><p>asap的行為很好理解，它是非同步的執行，在瀏覽器其實就是setTimeout設為0秒(在NodeJS中是用process.nextTick)，因為行為很好理解這解就不寫例子了。</p>
<h5 id="使用情境-1"><a href="#使用情境-1" class="headerlink" title="使用情境"></a>使用情境</h5><p>asap因為都是在setTimeout中執行，所以不會有block event loop的問題，很適合用在永遠不會退訂的observable，例如在背景下持續監聽server送來的通知。</p>
<h4 id="async"><a href="#async" class="headerlink" title="async"></a>async</h4><p>它跟asap很像但是使用setInterval來運作，通常是跟時間相關的operator才會用到。</p>
<h4 id="animationFrame"><a href="#animationFrame" class="headerlink" title="animationFrame"></a>animationFrame</h4><p>這個相信大家應該都知道，他是稅用<code>Window.requrestAnimationFrame</code>這個API去實作的，所以執行週期就跟<code>Window.requestAnimationFrame</code>一模一樣。</p>
<h5 id="使用情境-2"><a href="#使用情境-2" class="headerlink" title="使用情境"></a>使用情境</h5><p>在做複雜運算，且高頻率觸發UI動畫時，就很適合使用animationFrame，所以可以搭配throttle operator使用。</p>
<h3 id="Cold-Hot-Observable"><a href="#Cold-Hot-Observable" class="headerlink" title="Cold&amp;Hot Observable"></a>Cold&amp;Hot Observable</h3><blockquote>
<p>Hot Observable跟Cole Observable的差別，其實就是**資料源(Data Source)**在Observable內部建立還是外部建立。</p>
</blockquote>
<p>在RxJS中很常會看偌Cold Observable跟Hot Observable這兩個名詞，其實他們是在區分不同行為的Observable，所謂的Cold Observable就是指每次訂閱都是<strong>獨立的執行</strong>，而Hot Observable則是<strong>共用的訂閱</strong>。</p>
<h4 id="Cold-Observable"><a href="#Cold-Observable" class="headerlink" title="Cold Observable"></a>Cold Observable</h4><p>Cold Observable代表Observable的每個訂閱都是獨立的，他們不會互相影響，如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub1: &quot;</span> + value));</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub2: &quot;</span> + value));</span><br><span class="line">&#125;, <span class="number">3500</span>);</span><br><span class="line"><span class="comment">// sub1: 0</span></span><br><span class="line"><span class="comment">// sub1: 1</span></span><br><span class="line"><span class="comment">// sub1: 2</span></span><br><span class="line"><span class="comment">// sub1: 3</span></span><br><span class="line"><span class="comment">// sub2: 0</span></span><br><span class="line"><span class="comment">// sub1: 4</span></span><br><span class="line"><span class="comment">// sub2: 1</span></span><br><span class="line"><span class="comment">// sub2: 2</span></span><br><span class="line"><span class="comment">// sub2: 3</span></span><br><span class="line"><span class="comment">// sub2: 4</span></span><br></pre></td></tr></table></figure>

<p>從上面時程式碼可以看出來每次訂閱<code>source$</code>都是獨立運行的，這種每次訂閱都是<strong>獨立執行</strong>的Observable就稱為Cold Observable。</p>
<p>如果從Observable內部來看，代表<strong>資料源(Data Source)<strong>是在Observable</strong>內部</strong>建立的，大概會長像下面</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    <span class="comment">// 訂閱時，才建立新的資料源</span></span><br><span class="line">    <span class="keyword">const</span> someDataSource$ = <span class="title function_">getSomeDataSource</span>();</span><br><span class="line">    someDataSource$.<span class="title function_">addEventListener</span>(<span class="string">&quot;message&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>因為每次訂閱都建立一個新的資料源，就會使資料從頭開始傳送。</p>
<h4 id="Hot-Observable"><a href="#Hot-Observable" class="headerlink" title="Hot Observable"></a>Hot Observable</h4><p>Hot Observable代表Observable的每個訂閱是共用的，所謂的共用訂閱就是指一個Observable在多次訂閱時，不會每次都從新開始發送元素，例如</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, share &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">5</span>),</span><br><span class="line">    <span class="title function_">share</span>()</span><br><span class="line">);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub1: &quot;</span> + value));</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub2: &quot;</span> + value));</span><br><span class="line">&#125;, <span class="number">3500</span>);</span><br><span class="line"><span class="comment">// sub1: 0</span></span><br><span class="line"><span class="comment">// sub1: 1</span></span><br><span class="line"><span class="comment">// sub1: 2</span></span><br><span class="line"><span class="comment">// sub1: 3</span></span><br><span class="line"><span class="comment">// sub2: 3</span></span><br><span class="line"><span class="comment">// sub1: 4</span></span><br><span class="line"><span class="comment">// sub2: 4</span></span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看出，當我們對source第二次做訂閱時，接收到的元素是接續第一個訂閱往下發送的，而不是從(0)開始，這種<strong>共用訂閱</strong>的Observable就稱為Hot Observable。</p>
<p>如果從Observable內部來看，就是資料源是在Observable<strong>外部</strong>建立的，程式碼大概就會像下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 只有一個資料源，每次訂閱都是用同一個</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> someDataSource = <span class="title function_">getSomeDataSource</span>();</span><br><span class="line"><span class="keyword">const</span> source = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="keyword">function</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">    someDataSource.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="Cold與Hot"><a href="#Cold與Hot" class="headerlink" title="Cold與Hot"></a>Cold與Hot</h4><p>一般的情況下Observable都是Cold的，這樣不同的訂閱才不會有Side Effect互相影響。但在需要多次訂閱的情境下，我們就很有可能需要Hot Observable，而讓RxJS提供了很多讓Cold Observable變成Hot Observable的方法。</p>
<h4 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h4><p>Hot Observable跟Cold Observable的差異就是多次訂閱時，是否共用訂閱或是獨立執行，而這一切的差異就是來自於資料源是在Observable內部建立還是外部建立。</p>
<h3 id="如何Debug？"><a href="#如何Debug？" class="headerlink" title="如何Debug？"></a>如何Debug？</h3><p>Debug一直是RxJS的難題，原因是當我們使用RxJS後，程式碼就會變得高度<strong>抽象化</strong>；實際上抽象並不是什麼壞事，抽象會讓程式碼顯得簡潔、乾淨，但同成也帶來了除鏌上的因難。</p>
<p>在撰寫程式時，我們都會希望程式碼是簡潔且可讀的。𪝂當我們用<strong>簡潔</strong>的程式碼來處理<strong>複雜</strong>的問題，就表示我們的程式碼會變得<strong>高度抽象！</strong>其實人 在思考複雜的問題都會偏好用抽象的方式來處理，例如說在下圍棋時，常常說的<strong>棋形</strong>或是黑白哪一邊的<strong>勢</strong>比較好，這都是在抽象化處理問題。</p>
<h4 id="RxJS如何除錯？"><a href="#RxJS如何除錯？" class="headerlink" title="RxJS如何除錯？"></a>RxJS如何除錯？</h4><h5 id="tap"><a href="#tap" class="headerlink" title="tap"></a>tap</h5><p>在RxJS的世界中有一個Operator叫做<code>tap</code>，它不會對元素產生任何影響，在實務上很常來做錯的追蹤，如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, tap, map &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">const</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;tap log: &quot;</span> + x)),</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">X</span> =&gt;</span> X + <span class="number">1</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">X</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;subscirption log: &quot;</span> + X)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// do log: 0</span></span><br><span class="line"><span class="comment">// subscription log: 1</span></span><br><span class="line"><span class="comment">// do log: 1</span></span><br><span class="line"><span class="comment">// subscription log: 2</span></span><br><span class="line"><span class="comment">// do log: 2</span></span><br><span class="line"><span class="comment">// subscription log: 3</span></span><br></pre></td></tr></table></figure>

<p>從上面的例子可以看出來，我們可以傳入一個callback function給<code>tap</code>, 我們可以在tap的內部對元素作任何操作(像是log)，但不會兩元素產生影響。這很適合用在檢測每一步送出的元素是否符合我們的預期。</p>
<blockquote>
<p><code>tap(...)</code>的行為跟<code>map(x =&gt; &#123; ... return x;&#125;)</code>本質上是一樣的</p>
</blockquote>
<h4 id="Observable間的關聯圖"><a href="#Observable間的關聯圖" class="headerlink" title="Observable間的關聯圖"></a>Observable間的關聯圖</h4><p>當程式有點複雜時，我們最好是能先畫出Observable與Observable之間的關聯，在釐清各個Observable間的關系後，我們就能更輕易地找出問題在哪。範例如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent ,<span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mapTo, merge ,scan&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> addButton= <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;addButton&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> minusButtion= <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;minusButton&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> state =<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;state&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> initialState = <span class="title function_">of</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> addClick= <span class="title function_">fromEvent</span>(addButton,<span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> minusClick=<span class="title function_">fromEvent</span>(minusButton,<span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> numberState= initialState.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">merge</span>(</span><br><span class="line">        addClick.<span class="title function_">pipe</span>(<span class="title function_">mapTo</span>(<span class="number">1</span>)) ,</span><br><span class="line">        minusClick.<span class="title function_">pipe</span>(<span class="title function_">mapTo</span>(-<span class="number">1</span>))</span><br><span class="line">    ),</span><br><span class="line">    <span class="title function_">scan</span>(<span class="function">(<span class="params">origin,next</span>)=&gt;</span> origin+ next)</span><br><span class="line">);</span><br><span class="line">numberState.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span>&#123; state.<span class="property">innerHTML</span> = value;&#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>)=&gt;</span>&#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span>+err);&#125;,</span><br><span class="line">    <span class="attr">complete</span>:<span class="function">()=&gt;</span>&#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>);&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a href="https://js-c7bh5a.stackblitz.io/">stackblitz</a></p>
<p>上面這段程式碼，我們可以把關聯圖畫成以下的樣子</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--------------        --------------        --------------</span><br><span class="line"><span class="string">&#x27;            &#x27;</span>        <span class="string">&#x27;            &#x27;</span>        <span class="string">&#x27;            &#x27;</span> </span><br><span class="line"><span class="string">&#x27;initialState&#x27;</span>        <span class="string">&#x27;  addClcik  &#x27;</span>        <span class="string">&#x27; minusClick &#x27;</span></span><br><span class="line"><span class="string">&#x27;            &#x27;</span>        <span class="string">&#x27;            &#x27;</span>        <span class="string">&#x27;            &#x27;</span></span><br><span class="line">--------------        --------------        --------------</span><br><span class="line">      |                     |                      |</span><br><span class="line">      |                     |  mapTo(1)            | mapTo(-1)</span><br><span class="line">merge | ____________________|                      |</span><br><span class="line">      | \__________________________________________|</span><br><span class="line">      |                      </span><br><span class="line">     \|/</span><br><span class="line">      |</span><br><span class="line">      | scan((origin, next) =&gt; origin + next)</span><br><span class="line">      |</span><br><span class="line">     \|/</span><br><span class="line">-------------</span><br><span class="line">&#x27;           &#x27;</span><br><span class="line">&#x27;numberState&#x27;  </span><br><span class="line">&#x27;           &#x27;</span><br><span class="line">-------------</span><br></pre></td></tr></table></figure>

<p>把每一個observable物件都框起來，並畫出之間的關聯，以及中間使用的Operators，這樣一來我們就能夠很清楚的了解這段程式碼在做什麼事，以及如何運作。最後我們只要在每一估環節去確認送出的元素就能找出錯誤出現在哪裡。</p>
<h4 id="Marble-Diagram"><a href="#Marble-Diagram" class="headerlink" title="Marble Diagram"></a>Marble Diagram</h4><p>在釐清每個observable之間的關系並找出間題出現在哪個環節之 ，我們只要畫出該環節的Marble Diagram前後變化就能清楚地知道間題是如何發生。接續上面的例子，如果今天問題出在<code>merge()</code>之後，那我們就把<code>merge()</code>前後的Marble Diagram畫出來</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">initialState: 0|</span><br><span class="line">addClick    : ----------1---------1--1-------</span><br><span class="line">minusClick  : -----(-1)---(-1)---------------</span><br><span class="line"></span><br><span class="line">                       merge(...)</span><br><span class="line"></span><br><span class="line">            : 0----(-1)-1-(-1)----1--1-------</span><br><span class="line">           </span><br><span class="line">           scan((origin, next) =&gt; origin +next)</span><br><span class="line"></span><br><span class="line">numberState : <span class="number">0</span>----(-<span class="number">1</span>)-<span class="number">0</span>-(-<span class="number">1</span>)----<span class="number">0</span>--<span class="number">1</span>-------     </span><br></pre></td></tr></table></figure>

<p>到這裡我們應該就能清楚地知道問題出在哪，最後就只要想如何解決問題就行了。</p>
<blockquote>
<p>如果還不知道間題在哪，很有可能是Marble Diagram畫鏌，可以再利用<code>tap</code>進行檢查</p>
</blockquote>
<p>只要照著以上三個步驟做除錯，基本上就不用擔心會有解決不了的錯誤，但是這三個步驟仍然顯得太過繁瑣，或許我們應該做一個工具來簡化這整個流程！</p>
<h6 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h6><ul>
<li><a href="https://ithelp.ithome.com.tw/users/20103367/ironman/1199">30 天精通 RxJS</a></li>
<li><a href="https://www.jianshu.com/p/869a3f74d3ca">番外：Rx–隐藏在Angular 2.x中利剑</a></li>
<li><a href="http://rxmarbles.com/#from">rxmarbles</a></li>
<li><a href="https://www.imooc.com/article/70323">RxJS v6 学习指南</a></li>
</ul>
]]></content>
      <categories>
        <category>學習</category>
        <category>Angular</category>
        <category>RxJS</category>
      </categories>
      <tags>
        <tag>RxJS</tag>
      </tags>
  </entry>
  <entry>
    <title>學習Flask-SocketIO的動態namespace的測試</title>
    <url>/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E5%8B%95%E6%85%8Bnamespace%E7%9A%84%E6%B8%AC%E8%A9%A6/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E5%8B%95%E6%85%8Bnamespace%E7%9A%84%E6%B8%AC%E8%A9%A6/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>之前在<code>nodejs</code>下有成功的建立動態的<code>namespace</code>,因為後端是使用<code>python</code>所以來測試一下是否可以動態的來產生<code>namespace</code></p>
<h3 id="服務端"><a href="#服務端" class="headerlink" title="服務端"></a>服務端</h3><p>一樣是建立<code>Flask-SocketIO</code>的服務器，可以參考之前的建立的專案在<code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> SocketIO, send, emit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&quot;SECRET_KEY&quot;</span>] = <span class="string">&quot;secret1&quot;</span></span><br><span class="line">socketio = SocketIO(app)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello Flask-SocketIO&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;connect&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onconnect</span>():</span><br><span class="line">    <span class="comment"># socket id</span></span><br><span class="line">    currentSocketId = request.sid</span><br><span class="line">    <span class="comment"># socketio namespace</span></span><br><span class="line">    <span class="built_in">print</span>(request.namespace)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;connect&gt; socket.id=%s&quot;</span> % (currentSocketId))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;connected&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onConnected</span>(<span class="params">data</span>):</span><br><span class="line">    currentSocketId = request.sid</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;connected&gt; socket.id=%s msg=%s&quot;</span> %</span><br><span class="line">          (currentSocketId, data))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;disconnect&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ondisconnect</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;disconnect&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;chatmessage&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onchatmessage</span>(<span class="params">data</span>):</span><br><span class="line">    msg = <span class="string">&quot;[server]&lt;chatmessage&gt;:%s&quot;</span> % (data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;chatmessage&gt;:%s&quot;</span>, msg)</span><br><span class="line">    <span class="comment">## emit(&quot;chatmessage&quot;, data)</span></span><br><span class="line">    <span class="comment">## emit(&quot;chatmessage&quot;, data, broadcast=True)</span></span><br><span class="line">    emit(<span class="string">&quot;chatmessage&quot;</span>, data, broadcast=<span class="literal">True</span>, include_self=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span>  <span class="comment"># vscode 才可以偵錯</span></span><br><span class="line">    socketio.run(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">5000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在<code>server</code>起動時，如果要修改<code>port</code>可以修改<code>.vscode\launch.json</code>中的args</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;run&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--port=6000&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-debugger&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-reload&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>在送<code>json</code>給客戶端有個坑，只要在送的時候設定一下<code>json=True</code>如下的部份程式碼</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">senddata = &#123;<span class="string">&#x27;result&#x27;</span>: self.namespace_queue&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[server]&lt;updateNamespaceList&gt; socket.id=%s result=%s&quot;</span> %</span><br><span class="line">             (currentSocketId, senddata))</span><br><span class="line">emit(<span class="string">&#x27;updateNamespaceList&#x27;</span>, senddata, broadcast=<span class="literal">True</span>, json=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h3 id="客戶端"><a href="#客戶端" class="headerlink" title="客戶端"></a>客戶端</h3><p>可以參考之前建立的專案<a href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E8%81%8A%E5%A4%A9%E8%A8%8A%E6%81%AF/">學習Flask-SocketIO的聊天訊息</a></p>
<p>因為要有多台的電腦可以連線來測試，所以要修改<code>angular.json</code>的內容，要加入<code>&quot;host&quot;: &quot;0.0.0.0&quot;</code>如下</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;serve&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;builder&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@angular-devkit/build-angular:dev-server&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;browserTarget&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatclient:build&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>



<h3 id="主要的程式碼"><a href="#主要的程式碼" class="headerlink" title="主要的程式碼"></a>主要的程式碼</h3><p>我是以手冊上建議的<code>Class-Based Namespaces</code>的方式來處理動態的<code>namespace</code>一開始先建立一個預設的<code>namespace</code>先就是空字串給它</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">init_app</span>(<span class="params">self, app</span>):</span><br><span class="line">        self.app = app</span><br><span class="line">        socketio.init_app(app)</span><br><span class="line">        self.createClassNamepace(<span class="string">&quot;&quot;</span>, <span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># self.createClassNamepace(&quot;/&quot;)</span></span><br><span class="line">        <span class="comment"># self.createClassNamepace(&quot;/bb&quot;)</span></span><br></pre></td></tr></table></figure>

<p>在<code>createClassNamepace</code>的程式中是在<code>server</code>中有一個<strong>list</strong>來保留有多少被建立的<code>namespace</code>和建立真正有網路事件中處理的物件<code>MyCustomNamespace</code>之後要掛起來<code>socketio.on_namespace(myclsns)</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">createClassNamepace</span>(<span class="params">self, nsname, startup=<span class="literal">False</span></span>):</span><br><span class="line">        self.createNamespace(nsname, startup)</span><br><span class="line">        myclsns = MyCustomNamespace(<span class="string">&quot;/&quot;</span>+nsname)</span><br><span class="line">        self.CustomNamespace.append(myclsns)</span><br><span class="line">        socketio.on_namespace(myclsns)</span><br></pre></td></tr></table></figure>

<p>在物件<code>MyCustomNamespace</code>要注意的是物件功能的名稱例如你的事件是<code>connect</code>那你的物件的方法名稱是<code>on_connect</code>此外在加入<code>namespace</code>只要通知自已</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyCustomNamespace</span>(<span class="title class_ inherited__">Namespace</span>):</span><br><span class="line">    ChatServer = <span class="literal">None</span></span><br><span class="line">    <span class="comment"># 客戶connect的事件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_connect</span>(<span class="params">self</span>):</span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        fmt = <span class="string">&quot;[myns ns=%s]&lt;connect&gt;&quot;</span> % (sckns)</span><br><span class="line">        <span class="built_in">print</span>(fmt)</span><br><span class="line">        self.sendUpdateNamespace()</span><br><span class="line">    <span class="comment"># 客戶disconnect的事件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_disconnect</span>(<span class="params">self</span>):</span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        fmt = <span class="string">&quot;[myns ns=%s]&lt;disconnect&gt;&quot;</span> % (sckns)</span><br><span class="line">        <span class="built_in">print</span>(fmt)</span><br><span class="line">    <span class="comment"># 客戶已連線connected的事件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_connected</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="comment"># socket id</span></span><br><span class="line">        currentSocketId = request.sid</span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        fmt = <span class="string">&quot;[myns ns=%s]&lt;connected&gt; socket.id=%s msg=%s&quot;</span> % (</span><br><span class="line">            sckns, currentSocketId, data)</span><br><span class="line">        <span class="built_in">print</span>(fmt)</span><br><span class="line">    <span class="comment"># 聊天chatmessage的事件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_chatmessage</span>(<span class="params">self, data</span>):</span><br><span class="line">        currentSocketId = request.sid</span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        fmt = <span class="string">&quot;[myns ns=%s]&lt;chatmessage&gt;:%s&quot;</span> % (sckns, data)</span><br><span class="line">        <span class="built_in">print</span>(fmt)</span><br><span class="line">        <span class="comment"># emit(&quot;chatmessage&quot;, data)</span></span><br><span class="line">        emit(<span class="string">&quot;chatmessage&quot;</span>, data, broadcast=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># emit(&quot;chatmessage&quot;, data, broadcast=True, include_self=False)</span></span><br><span class="line">    <span class="comment"># 建立createNamespace的事件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_createNamespace</span>(<span class="params">self, data</span>):</span><br><span class="line">        currentSocketId = request.sid</span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[myns ns=%s]&lt;createNamespace&gt; socket.id=%s nsname=%s&quot;</span> %</span><br><span class="line">              (sckns, currentSocketId, data[<span class="string">&quot;name&quot;</span>]))</span><br><span class="line">        self.ChatServer.createClassNamepace(data[<span class="string">&quot;name&quot;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 傳送namespace列表</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sendUpdateNamespace</span>(<span class="params">self</span>):</span><br><span class="line">        currentSocketId = request.sid</span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        senddata = &#123;<span class="string">&#x27;result&#x27;</span>: self.ChatServer.namespace_queue&#125;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[myns ns=%s]&lt;updateNamespaceList&gt; socket.id=%s result=%s&quot;</span> %</span><br><span class="line">              (sckns, currentSocketId, senddata))</span><br><span class="line">        emit(<span class="string">&#x27;updateNamespaceList&#x27;</span>, senddata, broadcast=<span class="literal">True</span>, json=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 加入JoinToApp事件加入某個namespace</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_JoinToApp</span>(<span class="params">self, data</span>):</span><br><span class="line">        namespaceToConnect = self.ChatServer.searchObjectOnArray(</span><br><span class="line">            data[<span class="string">&quot;namespace&quot;</span>])</span><br><span class="line">        <span class="keyword">if</span> namespaceToConnect != <span class="literal">None</span>:</span><br><span class="line">            sendmsg = &#123;<span class="string">&quot;namespace&quot;</span>: namespaceToConnect&#125;</span><br><span class="line">            emit(<span class="string">&#x27;JoinToApp&#x27;</span>, sendmsg, json=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>可以參考<a href="https://github.com/ttom921/StudyPython">github</a>的<code>TestFlaskSocketIONs</code>專案</p>
<p>因為要處理影像相關的程式所以要來建立新的<code>service</code>的處理</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g service services/imagefile </span><br></pre></td></tr></table></figure>

<h3 id="客戶端一次開8個"><a href="#客戶端一次開8個" class="headerlink" title="客戶端一次開8個"></a>客戶端一次開8個</h3><p>將傳送端分開先產生頁面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g c \chat\sendchannel</span><br></pre></td></tr></table></figure>

<p>將之的<code>room1</code>, 掛到這個元件的下面在<code>src\app\chat\sendchannel\sendchannel.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">  不顯示只傳送: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;myCheck&quot;</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;myCheck&quot;</span> [<span class="attr">value</span>]=<span class="string">&quot;myCheck&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;CheckClick()&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">app-room1</span> [<span class="attr">isVisiableImg</span>]=<span class="string">&quot;myCheck&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">app-room1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>先產生頁面<code>chat\room</code>,</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g c \chat\room</span><br></pre></td></tr></table></figure>

<p>在加入路由表在<code>src\app\app-routing.module.ts</code>的內容</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;room&#x27;</span>, <span class="attr">pathMatch</span>: <span class="string">&#x27;full&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;sendchannel&#x27;</span>, <span class="attr">component</span>: <span class="title class_">SendchannelComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;room&#x27;</span>, <span class="attr">component</span>: <span class="title class_">RoomComponent</span> &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>每一個是獨立的<code>charRoom</code>,所以來產生</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g c \chat\charRoom</span><br></pre></td></tr></table></figure>



<p>因為要有4個頻道所以來產生<code>char\channel</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g c \chat\channel</span><br></pre></td></tr></table></figure>

<p>問題目前同時連線到服務器，上限只有5個，超個5個不能動作，原因還不知道是因為沒有使用<code>winsocket</code>的協議，在<code>python</code>中要安裝<code>gevent-websocket</code>這個套件</p>
<h6 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h6><p><a href="https://www.itread01.com/content/1531210942.html">結合manage.py，在flask項目中使用 flask-socketio</a><br><a href="https://gwj41.iteye.com/blog/2399535">ular 4 上传多个文件到Spring boot</a><br><a href="https://codertw.com/%E5%89%8D%E7%AB%AF%E9%96%8B%E7%99%BC/230955/">Angular2裡獲取（input file）上傳檔案的內容的方法</a><br><a href="https://stackoverflow.com/questions/43492354/how-to-allow-access-outside-localhost">How to allow access outside localhost</a></p>
]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask-SocketIO</category>
      </categories>
      <tags>
        <tag>Flask-SocketIO</tag>
      </tags>
  </entry>
  <entry>
    <title>學習Flask-SocketIO的聊天訊息</title>
    <url>/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E8%81%8A%E5%A4%A9%E8%A8%8A%E6%81%AF/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E8%81%8A%E5%A4%A9%E8%A8%8A%E6%81%AF/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>這是為了了解Flask-SocketIO的特性和是否可以使用動態的<code>namespace</code>來建立的測試程式</p>
<h3 id="設定環境"><a href="#設定環境" class="headerlink" title="設定環境"></a>設定環境</h3><p>先建立來使用虛擬環境來建立Flask的環境</p>
<p>可以參考之前<a href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92Flask%E8%B5%B7%E6%89%8B%E5%BC%8F/">學習Flask起手式</a>因為我之前有建立好的虛擬環境，所以只要起動它就可以，在下面建立<code>app.py</code>的內容如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello flask&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span>  <span class="comment"># vscode 才可以偵錯</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p>在設定<code>vscode</code>的工作區設定裏將虛擬環境的python執行路徑加入到<code>python:Venv Path</code>如下的圖示</p>
<img src="2019-05-15_10_59_07_Image.jpg" style="zoom:80%;" />

<p>目前的內容如下，這是虛擬環境的<code>python</code>的執行檔</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\Project\github\StudyPython\pyvirenv\pyenv37\Scripts</span><br></pre></td></tr></table></figure>

<p>要設定<code>launch.json</code>的內容如下</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 使用 IntelliSense 以得知可用的屬性。</span></span><br><span class="line">    <span class="comment">// 暫留以檢視現有屬性的描述。</span></span><br><span class="line">    <span class="comment">// 如需詳細資訊，請瀏覽: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python：Flask&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flask&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="comment">// 選擇虛擬環境中的python版本</span></span><br><span class="line">            <span class="attr">&quot;pythonPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:/Project/github/StudyPython/pyvirenv/pyenv37/Scripts/python.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;FLASK_APP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app.py&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;FLASK_ENV&quot;</span><span class="punctuation">:</span> <span class="string">&quot;development&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;FLASK_DEBUG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;run&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-debugger&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-reload&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;jinja&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>安裝<strong>Flask-SocketIO</strong></p>
<p>啟動虛擬環境來安裝</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install flask-socketio</span><br><span class="line">pip install gevent</span><br></pre></td></tr></table></figure>

<p>修改<code>app.py</code>如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> SocketIO, send, emit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&quot;SECRET_KEY&quot;</span>] = <span class="string">&quot;secret1&quot;</span></span><br><span class="line">socketio = SocketIO(app)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello Flask-SocketIO&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;connect&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onconnect</span>():</span><br><span class="line">    <span class="comment"># socket id</span></span><br><span class="line">    currentSocketId = request.sid</span><br><span class="line">    <span class="comment"># socketio namespace</span></span><br><span class="line">    <span class="built_in">print</span>(request.namespace)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;connect&gt; socket.id=%s&quot;</span> % (currentSocketId))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;connected&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onConnected</span>(<span class="params">data</span>):</span><br><span class="line">    currentSocketId = request.sid</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;connected&gt; socket.id=%s msg=%s&quot;</span> %</span><br><span class="line">          (currentSocketId, data))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;disconnect&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ondisconnect</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;disconnect&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;chatmessage&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onchatmessage</span>(<span class="params">data</span>):</span><br><span class="line">    msg = <span class="string">&quot;[server]&lt;chatmessage&gt;:%s&quot;</span> % (data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;chatmessage&gt;:%s&quot;</span>, msg)</span><br><span class="line">    <span class="comment">##emit(&quot;chatmessage&quot;, &#123;&#x27;data&#x27;: data&#125;)</span></span><br><span class="line">    emit(<span class="string">&quot;chatmessage&quot;</span>, data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span>  <span class="comment"># vscode 才可以偵錯</span></span><br><span class="line">    socketio.run(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">5000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="客戶端"><a href="#客戶端" class="headerlink" title="客戶端"></a>客戶端</h3><p>設定<code>client</code>端是用<code>Angular</code>可以參考之前的<a href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92typescript%E5%92%8Csocket-io%E7%9A%84%E4%BD%BF%E7%94%A8/">學習typescript和socket-io的使用</a>有關客戶端的設定</p>
<p>建立新的<code>angular</code>的客戶端</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng new chatclient</span><br></pre></td></tr></table></figure>

<p>建立<code>chat</code>下的<code>room1</code>的頁面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g c chat/room1</span><br></pre></td></tr></table></figure>

<p>安裝用到的模組</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install socket.io --save</span><br></pre></td></tr></table></figure>

<p>加入連線用到的服務</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g service chat/services/socket</span><br></pre></td></tr></table></figure>
<p>在<code>src\app\chat\services\socket.service.ts</code>如下</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> socketIo <span class="keyword">from</span> <span class="string">&quot;socket.io-client&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Event</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../model/event&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">SocketService</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">socket</span>: socketIo;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">initSocket</span>(<span class="params">ns_url: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span> = <span class="title function_">socketIo</span>(ns_url);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">onEvent</span>(<span class="attr">event</span>: <span class="title class_">Event</span>): <span class="title class_">Observable</span>&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observable</span>&lt;<span class="title class_">Event</span>&gt;(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">on</span>(event, <span class="function">() =&gt;</span> observer.<span class="title function_">next</span>());</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title class_">SendConnect</span>() &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">emit</span>(<span class="string">&quot;connected&quot;</span>, <span class="string">&quot;我已連線了&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title class_">Sendchatmessage</span>(<span class="attr">msg</span>: <span class="built_in">string</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">emit</span>(<span class="string">&quot;chatmessage&quot;</span>, msg);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title class_">Onchatmessage</span>(): <span class="title class_">Observable</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observable</span>&lt;<span class="built_in">string</span>&gt;(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">on</span>(<span class="string">&quot;chatmessage&quot;</span>, <span class="function">(<span class="params">data: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(data)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// public disconnect()&#123;</span></span><br><span class="line">  <span class="comment">//   this.socket.disconnect();</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>剩下的可以參考一下<a href="https://github.com/ttom921/StudyPython">github</a>中的TestFlaskSocketIOchat</p>
<p><strong>注意</strong>在<code>app.py</code>中的<code>emit</code>使用上要注意</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">emit(<span class="string">&quot;chatmessage&quot;</span>, data) <span class="comment">##只傳送給自已</span></span><br><span class="line">emit(<span class="string">&quot;chatmessage&quot;</span>, data, broadcast=<span class="literal">True</span>) <span class="comment">## 會傳送給所有在這namespace和room包括自已</span></span><br><span class="line">emit(<span class="string">&quot;chatmessage&quot;</span>, data, broadcast=<span class="literal">True</span>, include_self=<span class="literal">False</span>) <span class="comment">## 會傳送給所有在這namespace和room不包括自已</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask-SocketIO</category>
      </categories>
      <tags>
        <tag>Flask-SocketIO</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>學習FlaskSSE的相關使用</title>
    <url>/%E5%AD%B8%E7%BF%92FlaskSSE%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92FlaskSSE%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>這是記錄有關python在SSE（Server-sent events）的使用方法，它是單向的，資料是從server傳送給client，比較像websocket，只是它是單向的</p>
<span id="more"></span>


<h2 id="基本可以執行的程式"><a href="#基本可以執行的程式" class="headerlink" title="基本可以執行的程式"></a>基本可以執行的程式</h2><p>在<code>/home/ttom/project/StudyPython/TestSSE/server/app.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># from flask import Flask</span></span><br><span class="line"><span class="comment"># app = Flask(__name__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># @app.route(&#x27;/&#x27;)</span></span><br><span class="line"><span class="comment"># def index():</span></span><br><span class="line"><span class="comment">#     return &#x27;Hello, world&#x27;</span></span><br><span class="line"><span class="comment"># if __name__ == &#x27;__main__&#x27;:</span></span><br><span class="line"><span class="comment">#     app.run(host=&#x27;0.0.0.0&#x27;,debug=False) # 設定False才可以在vscode裏單步偵錯</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">&#x27;asdf&#x27;</span></span><br><span class="line">red = redis.StrictRedis()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">event_stream</span>():</span><br><span class="line">    pubsub = red.pubsub()</span><br><span class="line">    pubsub.subscribe(<span class="string">&#x27;chat&#x27;</span>)</span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> handle client disconnection.</span></span><br><span class="line">    <span class="keyword">for</span> message <span class="keyword">in</span> pubsub.listen():</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">&#x27;data: %s\n\n&#x27;</span> % message[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> flask.request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        flask.session[<span class="string">&#x27;user&#x27;</span>] = flask.request.form[<span class="string">&#x27;user&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> flask.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;user: &lt;input name=&quot;user&quot;&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/post&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post</span>():</span><br><span class="line">    message = flask.request.form[<span class="string">&#x27;message&#x27;</span>]</span><br><span class="line">    user = flask.session.get(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;anonymous&#x27;</span>)</span><br><span class="line">    now = datetime.datetime.now().replace(microsecond=<span class="number">0</span>).time()</span><br><span class="line">    red.publish(<span class="string">&#x27;chat&#x27;</span>, <span class="string">u&#x27;[%s] %s: %s&#x27;</span> % (now.isoformat(), user, message))</span><br><span class="line">    <span class="keyword">return</span> flask.Response(status=<span class="number">204</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/stream&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stream</span>():</span><br><span class="line">    <span class="keyword">return</span> flask.Response(event_stream(),</span><br><span class="line">                          mimetype=<span class="string">&quot;text/event-stream&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;user&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> flask.session:</span><br><span class="line">        <span class="keyword">return</span> flask.redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;!doctype html&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;chat&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;script src=&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">        &lt;style&gt;body &#123; max-width: 500px; margin: auto; padding: 1em; background: black; color: #fff; font: 16px/1.6 menlo, monospace; &#125;&lt;/style&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;&lt;b&gt;hi, %s!&lt;/b&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;Message: &lt;input id=&quot;in&quot; /&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;pre id=&quot;out&quot;&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">            function sse() &#123;</span></span><br><span class="line"><span class="string">                var source = new EventSource(&#x27;/stream&#x27;);</span></span><br><span class="line"><span class="string">                var out = document.getElementById(&#x27;out&#x27;);</span></span><br><span class="line"><span class="string">                source.onmessage = function(e) &#123;</span></span><br><span class="line"><span class="string">                    // XSS in chat is fun</span></span><br><span class="line"><span class="string">                    out.innerHTML =  e.data + &#x27;\\n&#x27; + out.innerHTML;</span></span><br><span class="line"><span class="string">                &#125;;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            $(&#x27;#in&#x27;).keyup(function(e)&#123;</span></span><br><span class="line"><span class="string">                if (e.keyCode == 13) &#123;</span></span><br><span class="line"><span class="string">                    $.post(&#x27;/post&#x27;, &#123;&#x27;message&#x27;: $(this).val()&#125;);</span></span><br><span class="line"><span class="string">                    $(this).val(&#x27;&#x27;);</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;);</span></span><br><span class="line"><span class="string">            sse();</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span> % flask.session[<span class="string">&#x27;user&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,debug=<span class="literal">False</span>) <span class="comment"># 設定False才可以在vscode裏單步偵錯</span></span><br></pre></td></tr></table></figure>

<h2 id="基本Angular例子"><a href="#基本Angular例子" class="headerlink" title="基本Angular例子"></a>基本Angular例子</h2><p>因為有找到基本的例子，EventSource是HTML5新帶進來的特性，用途是可以單向的接收從服務端推送過來的消息，要雙向通個的話要使用WebSocket了。</p>
<p>在<code>D:\Project\github\StudyPython\TestSSE\server\</code>下建立資料夾<code>.vscode</code>在裡面建立兩個檔案</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">launch.json</span><br><span class="line">settings.json</span><br></pre></td></tr></table></figure>
<p>lanuch.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python: Current File&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;file&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integratedTerminal&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>settings.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;python.venvPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:\\Project\\github\\StudyPython\\pyvirenv\\pyenv37\\Scripts&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;python.pythonPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:\\Project\\github\\StudyPython\\pyvirenv\\pyenv37\\Scripts\\python.exe&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>建立 app.py</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> <span class="title class_">Flask</span></span><br><span class="line">app = <span class="title class_">Flask</span>(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app</span>.<span class="title function_">route</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, world&#x27;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.<span class="title function_">run</span>(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,debug=<span class="title class_">False</span>) # 設定<span class="title class_">False</span>才可以在vscode裏單步偵錯</span><br></pre></td></tr></table></figure>

<p>可以來執行它，以瀏覽器<code>http://127.0.0.1:5000來瀏覽，會看到 Hello, world</code></p>
<p>Flask中需要使用<code>yield</code>來進行Stream類型的通信，我們今峋的主角是<code>EventSource</code></p>
<h3 id="我們先來入門"><a href="#我們先來入門" class="headerlink" title="我們先來入門"></a>我們先來入門</h3><p>先來<code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,Response</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_message</span>():</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;this could be any function that blocks until data is ready&#x27;&#x27;&#x27;</span></span><br><span class="line">    time.sleep(<span class="number">1.0</span>)</span><br><span class="line">    s = time.ctime(time.time())</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/stream&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stream</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">eventStream</span>():</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># wait for source data to be available, then push it</span></span><br><span class="line">            <span class="keyword">yield</span> <span class="string">&#x27;data: &#123;&#125;\n\n&#x27;</span>.<span class="built_in">format</span>(get_message())</span><br><span class="line">    <span class="keyword">return</span> Response(eventStream(), mimetype=<span class="string">&quot;text/event-stream&quot;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> OK();</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,debug=<span class="literal">False</span>,threaded=<span class="literal">True</span>) <span class="comment"># 設定False才可以在vscode裏單步偵錯</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\chat\chat.component.ts</code>中</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; environment &#125; <span class="keyword">from</span> <span class="string">&#x27;src/environments/environment&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-chat&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./chat.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./chat.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ChatComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">any</span> = &#123;&#125;;</span><br><span class="line">  api = <span class="string">`<span class="subst">$&#123;environment.apiUrl&#125;</span>/stream`</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> evtSource = <span class="keyword">new</span> <span class="title class_">EventSource</span>(<span class="variable language_">this</span>.<span class="property">api</span>);</span><br><span class="line"></span><br><span class="line">    evtSource.<span class="property">onmessage</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;connection message&#x27;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    evtSource.<span class="property">onerror</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;connection error&#x27;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">      evtSource.<span class="title function_">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    evtSource.<span class="property">onopen</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;connection open&#x27;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因為有CROS的問題，所以加入<code>proxy.config.json</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;/api&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;target&quot;</span>: <span class="string">&quot;http://172.18.2.33:5000&quot;</span>,</span><br><span class="line">    <span class="string">&quot;secure&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;changeOrigin&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;/asa&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;target&quot;</span>: <span class="string">&quot;http://172.18.2.160&quot;</span>,</span><br><span class="line">    <span class="string">&quot;secure&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;changeOrigin&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;/opendata&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;target&quot;</span>: <span class="string">&quot;http://data.taipei&quot;</span>,</span><br><span class="line">    <span class="string">&quot;secure&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;changeOrigin&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>package.json</code>中加入proxy</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;ng&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng serve --host=0.0.0.0 --proxy-config proxy.config.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng build&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng test&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng lint&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;e2e&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng e2e&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>








<p>在看<a href="https://flask-sse.readthedocs.io/en/latest/quickstart.html">官方</a>的快速教學上，它需要有flask, redis，這些服務，所先來安裝基本的環境。</p>
<h3 id="基本環境安裝"><a href="#基本環境安裝" class="headerlink" title="基本環境安裝"></a>基本環境安裝</h3><p>在<code>D:\Project\github\StudyPython\TestSSE\server\</code>下建立資料夾<code>.vscode</code>在裡面建立兩個檔案</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">launch.json</span><br><span class="line">settings.json</span><br></pre></td></tr></table></figure>

<p>lanuch.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python: Current File&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;file&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integratedTerminal&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>settings.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;python.venvPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:\\Project\\github\\StudyPython\\pyvirenv\\pyenv37\\Scripts&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;python.pythonPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:\\Project\\github\\StudyPython\\pyvirenv\\pyenv37\\Scripts\\python.exe&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>建立 app.py</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> <span class="title class_">Flask</span></span><br><span class="line">app = <span class="title class_">Flask</span>(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app</span>.<span class="title function_">route</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, world&#x27;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.<span class="title function_">run</span>(debug=<span class="title class_">False</span>) # 設定<span class="title class_">False</span>才可以在vscode裏單步偵錯</span><br></pre></td></tr></table></figure>

<h3 id="安裝需要的組件"><a href="#安裝需要的組件" class="headerlink" title="安裝需要的組件"></a>安裝需要的組件</h3><p>在切換到虛擬環境來安裝相關的組件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install flask-sse gunicorn gevent</span><br></pre></td></tr></table></figure>

<p>因為在windows下無法執行，所以改在linux的系統下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gunicorn sse:app --worker-class gevent --bind 0.0.0.0:8000</span><br></pre></td></tr></table></figure>

<h3 id="安裝-gunicorn"><a href="#安裝-gunicorn" class="headerlink" title="安裝 gunicorn"></a>安裝 gunicorn</h3><p><a href="https://stackoverflow.com/questions/51922443/why-is-there-no-command-for-gunicorn/51923906">https://stackoverflow.com/questions/51922443/why-is-there-no-command-for-gunicorn/51923906</a></p>
<h3 id="安裝redis"><a href="#安裝redis" class="headerlink" title="安裝redis"></a>安裝redis</h3><p><a href="https://wangxin1248.github.io/linux/2018/07/ubuntu18.04-install-redis.html">https://wangxin1248.github.io/linux/2018/07/ubuntu18.04-install-redis.html</a></p>
<h2 id="可以傳送訊息和接收例子"><a href="#可以傳送訊息和接收例子" class="headerlink" title="可以傳送訊息和接收例子"></a>可以傳送訊息和接收例子</h2><p>在win10下要安裝redis</p>
<p><a href="https://github.com/microsoftarchive/redis/releases/tag/win-3.2.100">https://github.com/microsoftarchive/redis/releases/tag/win-3.2.100</a></p>
<p>在虛擬的python環境上安裝</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install flask-sse gunicorn gevent</span><br></pre></td></tr></table></figure>

<p>先建立post訊息的元件和服務</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g component pages/ChatPost --module pages\dashboard\dashboard.module.ts</span><br><span class="line">ng g service _services/Chat</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\_services\chat.service.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; environment &#125; <span class="keyword">from</span> <span class="string">&#x27;src/environments/environment&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ChatService</span> &#123;</span><br><span class="line">  api = <span class="string">`<span class="subst">$&#123;environment.apiUrl&#125;</span>/users`</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient</span>) &#123; &#125;</span><br><span class="line">  <span class="comment">//送息給server</span></span><br><span class="line">  <span class="title class_">Post</span>(data) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">api</span> = <span class="string">`<span class="subst">$&#123;environment.apiUrl&#125;</span>/messages`</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="built_in">any</span>&gt;(<span class="variable language_">this</span>.<span class="property">api</span>, data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//取得sse的channel物件</span></span><br><span class="line">  <span class="title function_">getEventSource</span>(<span class="params">channel: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> source = <span class="keyword">new</span> <span class="title class_">EventSource</span>(<span class="string">`<span class="subst">$&#123;environment.apiUrl&#125;</span>/stream?channel=<span class="subst">$&#123;channel&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> source;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\chat-post\chat-post.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;flex-container&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;center&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>chat-post works!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> [<span class="attr">formGroup</span>]=<span class="string">&quot;formModel&quot;</span> (<span class="attr">ngSubmit</span>)=<span class="string">&quot;onSubmit($event)&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-card</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mat-form-field</span> <span class="attr">class</span>=<span class="string">&quot;full-width&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">mat-icon</span> <span class="attr">matPrefix</span> <span class="attr">style</span>=<span class="string">&quot;margin-right: 10px;&quot;</span>&gt;</span>mail<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">matInput</span> <span class="attr">placeholder</span>=<span class="string">&quot;channelname&quot;</span> <span class="attr">formControlName</span>=<span class="string">&quot;channel&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">mat-error</span> *<span class="attr">ngIf</span>=<span class="string">&quot;formErrors.channel&quot;</span>&gt;</span>&#123;&#123;formErrors.channel&#125;&#125;<span class="tag">&lt;/<span class="name">mat-error</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mat-form-field</span> <span class="attr">class</span>=<span class="string">&quot;full-width&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">mat-icon</span> <span class="attr">matPrefix</span> <span class="attr">style</span>=<span class="string">&quot;margin-right: 10px;&quot;</span>&gt;</span>vpn_key<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">matInput</span> <span class="attr">placeholder</span>=<span class="string">&quot;message&quot;</span> <span class="attr">formControlName</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">mat-error</span> *<span class="attr">ngIf</span>=<span class="string">&quot;formErrors.message&quot;</span>&gt;</span>&#123;&#123;formErrors.message&#125;&#125;<span class="tag">&lt;/<span class="name">mat-error</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mat-card-actions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-raised-button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> [<span class="attr">disabled</span>]=<span class="string">&quot;!formModel.valid&quot;</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mat-card-actions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">mat-card</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\chat-post\chat-post.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FormGroup</span>, <span class="title class_">FormBuilder</span>, <span class="title class_">Validators</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ChatService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_services/chat.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-chat-post&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./chat-post.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./chat-post.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ChatPostComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//#region form 相關</span></span><br><span class="line">  <span class="attr">formModel</span>: <span class="title class_">FormGroup</span></span><br><span class="line">  hide = <span class="literal">true</span>;</span><br><span class="line">  <span class="attr">dataInfo</span>: <span class="built_in">any</span> = &#123;&#125;;</span><br><span class="line">  formErrors = &#123;</span><br><span class="line">    <span class="string">&quot;channel&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;formError&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  vaildationMessages = &#123;</span><br><span class="line">    <span class="string">&quot;channel&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: <span class="string">&quot;必須輸入&quot;</span>,</span><br><span class="line">      <span class="string">&quot;minlength&quot;</span>: <span class="string">&quot;至少要2位&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: <span class="string">&quot;必須須輸入&quot;</span>,</span><br><span class="line">      <span class="string">&quot;minlength&quot;</span>: <span class="string">&quot;至少要2位&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//#endregion</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> fb: FormBuilder,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> chatService: ChatService,</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">buildForm</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">buildForm</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">formModel</span> = <span class="variable language_">this</span>.<span class="property">fb</span>.<span class="title function_">group</span>(&#123;</span><br><span class="line">      <span class="string">&quot;channel&quot;</span>: [</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dataInfo</span>.<span class="property">channel</span>,</span><br><span class="line">        [</span><br><span class="line">          <span class="title class_">Validators</span>.<span class="property">required</span>,</span><br><span class="line">          <span class="title class_">Validators</span>.<span class="title function_">minLength</span>(<span class="number">2</span>),</span><br><span class="line">        ]</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: [</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dataInfo</span>.<span class="property">message</span>,</span><br><span class="line">        [</span><br><span class="line">          <span class="title class_">Validators</span>.<span class="property">required</span>,</span><br><span class="line">          <span class="title class_">Validators</span>.<span class="title function_">minLength</span>(<span class="number">2</span>),</span><br><span class="line">        ]</span><br><span class="line">      ]</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">valueChanges</span>.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onValueChange</span>(data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onValueChange</span>(<span class="params">data?: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">formModel</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//檢查是否有錯誤和顯示錯誤訊息</span></span><br><span class="line">    <span class="keyword">const</span> form = <span class="variable language_">this</span>.<span class="property">formModel</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> field <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">formErrors</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">formErrors</span>[field] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">const</span> control = form.<span class="title function_">get</span>(field);</span><br><span class="line">      <span class="keyword">if</span> (control &amp;&amp; control.<span class="property">dirty</span> &amp;&amp; !control.<span class="property">valid</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> messages = <span class="variable language_">this</span>.<span class="property">vaildationMessages</span>[field];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> control.<span class="property">errors</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">formErrors</span>[field] += messages[key] + <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onSubmit</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">valid</span>) &#123;</span><br><span class="line">      <span class="comment">//console.log(&#x27;send to server&#x27;);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dataInfo</span> = <span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">dataInfo</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">chatService</span>.<span class="title class_">Post</span>(<span class="variable language_">this</span>.<span class="property">dataInfo</span>).<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">      &#125;,</span><br><span class="line">        <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在接收<code>src\app\pages\chat\chat.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;flex-container&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;center&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of lidatas&quot;</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\chat\chat.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; environment &#125; <span class="keyword">from</span> <span class="string">&#x27;src/environments/environment&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ChatService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_services/chat.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-chat&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./chat.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./chat.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ChatComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  lidatas = [];</span><br><span class="line">  api = <span class="string">`<span class="subst">$&#123;environment.apiUrl&#125;</span>/stream`</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> chatService: ChatService,</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> source = <span class="variable language_">this</span>.<span class="property">chatService</span>.<span class="title function_">getEventSource</span>(<span class="string">&quot;channel1&quot;</span>);</span><br><span class="line">    source.<span class="title function_">addEventListener</span>(<span class="string">&#x27;social&#x27;</span>, <span class="function">(<span class="params">event: MessageEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(event.<span class="property">data</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">lidatas</span>.<span class="title function_">push</span>(event.<span class="property">data</span>);</span><br><span class="line">      <span class="comment">//var data = JSON.parse(event.data);</span></span><br><span class="line">    &#125;);</span><br><span class="line">    source.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">event: MessageEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;reconnected service!&#x27;</span>)</span><br><span class="line">    &#125;, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="傳送物件資料和接收"><a href="#傳送物件資料和接收" class="headerlink" title="傳送物件資料和接收"></a>傳送物件資料和接收</h2><p>先來建立post物件和服務</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g component pages/DVR/DVRPost --module pages\dashboard\dashboard.module.ts</span><br><span class="line">ng g service _services/dvr/DVR</span><br></pre></td></tr></table></figure>

<h3 id="先來安裝flex-layout模組"><a href="#先來安裝flex-layout模組" class="headerlink" title="先來安裝flex-layout模組"></a>先來安裝flex-layout模組</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install --save @angular/flex-layout@8.0.0-beta.27</span><br></pre></td></tr></table></figure>

<p>再來建立list物件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g component pages/DVR/DVRList --module pages\dashboard\dashboard.module.ts</span><br></pre></td></tr></table></figure>

<h3 id="在傳送資料"><a href="#在傳送資料" class="headerlink" title="在傳送資料"></a>在傳送資料</h3><p>資料格式</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CarGroup</span> &#123;</span><br><span class="line">  <span class="attr">car_group_id</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">company_id</span>: <span class="built_in">number</span>; <span class="comment">//     # 公司ID</span></span><br><span class="line">  <span class="attr">car_group_name</span>: <span class="built_in">string</span>;<span class="comment">// # 車輛群組名稱</span></span><br><span class="line">  <span class="attr">is_action</span>: <span class="built_in">boolean</span>;<span class="comment">//			# 是否啟用</span></span><br><span class="line">  <span class="attr">created_time</span>: <span class="title class_">Date</span>;<span class="comment">//     # 創立時間</span></span><br><span class="line">  <span class="attr">modified_time</span>: <span class="title class_">Date</span>;<span class="comment">//     # 修改時間</span></span><br><span class="line">  <span class="attr">deleted_time</span>: <span class="title class_">Date</span>;<span class="comment">//     # 註銷時間</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Car</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./cars&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//公司資料.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Company</span> &#123;</span><br><span class="line">  id?: <span class="built_in">number</span>;<span class="comment">//Company ID.</span></span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  address?: <span class="built_in">string</span>;</span><br><span class="line">  tel?: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Car 基本資料.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">  id?: <span class="built_in">number</span>; <span class="comment">//Car ID</span></span><br><span class="line">  <span class="attr">car_uid</span>: <span class="built_in">string</span>;<span class="comment">//車牌</span></span><br><span class="line">  fw_update_progress?: <span class="built_in">number</span>;<span class="comment">//Remote FW update 進度.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Car 狀態.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">CarStatus</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;<span class="comment">// Online (string) - 車輛狀態名稱.</span></span><br><span class="line">  id?: <span class="built_in">number</span>;<span class="comment">// 1 (int) - 車輛狀態ID. 1: Online. 2: Offline</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//DVR ports.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">DVRPorts</span> &#123;</span><br><span class="line">  web?: <span class="built_in">number</span>;<span class="comment">// 80 (int) - Web Servic port.</span></span><br><span class="line">  stream?: <span class="built_in">number</span>;<span class="comment">// 554 (int) - RTSP port.</span></span><br><span class="line">  ctrl?: <span class="built_in">number</span>;<span class="comment">// 8080 (int) - Controle port.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">CarInfo</span> &#123;</span><br><span class="line">  id?: <span class="built_in">number</span>;<span class="comment">//DVR ID.</span></span><br><span class="line">  dvr_uid?: <span class="built_in">string</span>;<span class="comment">//DVR UID.</span></span><br><span class="line">  dvr_model?: <span class="built_in">string</span>;<span class="comment">// 1(string) - DVR model.</span></span><br><span class="line">  version?: <span class="built_in">string</span>;<span class="comment">// 1(string) - DVR; FW; 版本.</span></span><br><span class="line">  <span class="attr">company</span>: <span class="title class_">Company</span>;<span class="comment">//公司資料.</span></span><br><span class="line">  <span class="attr">car</span>: <span class="title class_">Car</span>;<span class="comment">//Car 基本資料.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\DVR\dvrpost\dvrpost.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;flex-container&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>dvrpost works!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> #<span class="attr">btn</span> <span class="attr">disabled</span>=<span class="string">&quot;&#123;&#123;btnisDisable&#125;&#125;&quot;</span> <span class="attr">mat-raised-button</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;onClick($event)&quot;</span>&gt;</span>Start<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\DVR\dvrpost\dvrpost.component.scss</code></p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.flex-container</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;   <span class="comment">/* Magic begins */</span></span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">  <span class="comment">//margin-top: 64px;</span></span><br><span class="line">  <span class="attribute">flex-direction</span>: row;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100vw</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\DVR\dvrpost\dvrpost.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span>, <span class="title class_">ElementRef</span>, <span class="title class_">ViewChild</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DVRService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_services/dvr/dvr.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CarInfo</span>, <span class="title class_">Company</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_models/car-info&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Car</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_models/cars&#x27;</span>;</span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-dvrpost&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./dvrpost.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./dvrpost.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DVRPostComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="meta">@ViewChild</span>(<span class="string">&#x27;btn&#x27;</span>, &#123; <span class="attr">static</span>: <span class="literal">true</span> &#125;) <span class="attr">btn</span>: <span class="title class_">ElementRef</span>;</span><br><span class="line">  btnisDisable = <span class="literal">false</span>;</span><br><span class="line">  <span class="attr">dvrInfos</span>: <span class="title class_">CarInfo</span>[] = [];</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dvrService: DVRService</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">testGenDVRInfos</span>();</span><br><span class="line">    <span class="comment">//console.log(this.dvrInfos);</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onClick</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="comment">//this.btnisDisable = true;</span></span><br><span class="line">    <span class="comment">// e.target.disable = true;</span></span><br><span class="line">    <span class="comment">// console.log(e);</span></span><br><span class="line">    <span class="comment">// setInterval(() =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//   this.testRanderProgress();</span></span><br><span class="line">    <span class="comment">// &#125;, 10000);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">testRanderProgress</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//#region 以下是測試程式</span></span><br><span class="line">  <span class="title function_">testRanderProgress</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dvrInfos</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      item.<span class="property">car</span>.<span class="property">fw_update_progress</span> = <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">100</span> | <span class="number">0</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//let jsonstr = JSON.stringify(this.dvrInfos);</span></span><br><span class="line">    <span class="comment">//console.log(jsonstr);</span></span><br><span class="line">    <span class="keyword">let</span> dataInfo = &#123;</span><br><span class="line">      <span class="attr">channel</span>: <span class="string">&quot;HiSharp&quot;</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="variable language_">this</span>.<span class="property">dvrInfos</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dvrService</span>.<span class="title class_">Post</span>(dataInfo).<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">testGenDVRInfos</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="attr">mycar</span>: <span class="title class_">Car</span> = &#123;</span><br><span class="line">        <span class="attr">car_uid</span>: <span class="string">`車牌-<span class="subst">$&#123;i&#125;</span>`</span>,</span><br><span class="line">        <span class="attr">id</span>: i,</span><br><span class="line">        <span class="attr">fw_update_progress</span>: <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">100</span> | <span class="number">0</span>,</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> <span class="attr">mycompany</span>: <span class="title class_">Company</span> = &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;HiSharp&quot;</span>,</span><br><span class="line">        <span class="attr">id</span>: <span class="number">888</span>,</span><br><span class="line">        <span class="comment">//address: &quot;住址&quot;,</span></span><br><span class="line">        <span class="comment">//tel: &quot;電話&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> <span class="attr">dvrinfo</span>: <span class="title class_">CarInfo</span> = &#123;</span><br><span class="line">        <span class="attr">id</span>: i,</span><br><span class="line">        <span class="attr">dvr_uid</span>: <span class="variable language_">this</span>.<span class="property">dvrService</span>.<span class="title function_">base64</span>(<span class="title class_">String</span>(i)),</span><br><span class="line">        <span class="attr">dvr_model</span>: <span class="string">&quot;MR800&quot;</span>,</span><br><span class="line">        <span class="attr">version</span>: <span class="string">&quot;v01.00.00&quot;</span>,</span><br><span class="line">        <span class="attr">car</span>: mycar,</span><br><span class="line">        <span class="attr">company</span>: mycompany</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dvrInfos</span>.<span class="title function_">push</span>(dvrinfo);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//#endregion</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="在接收資料"><a href="#在接收資料" class="headerlink" title="在接收資料"></a>在接收資料</h3><p>使用<code>cdk-virtual-scroll-viewport</code>來使多個顯示時，比較不會顯示太慢，在使用上和<code>mat-table</code>有點像，可以控制標頭是否一直在最上面在<code>&lt;tr mat-header-row *matHeaderRowDef=&quot;[...];sticky:true&quot;&gt;&lt;/tr&gt;</code>，在控制顯示大小可以使用css來控制如<code>example-viewport</code></p>
<p>在<code>src\app\pages\DVR\dvrlist\dvrlist.component.html</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line">&lt;div <span class="keyword">class</span>=<span class="string">&quot;flex-container&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;center&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">cdk-virtual-scroll-viewport</span> <span class="attr">itemSize</span>=<span class="string">&quot;0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;example-viewport&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">table</span> <span class="attr">mat-table</span> [<span class="attr">dataSource</span>]=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mat-elevation-z8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!--- Note that these columns can be defined in any order.</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">              The actual rendered columns are set as a property on the row definition&quot; --&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 表格標題 --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;dvr_uid&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">th</span> <span class="attr">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span> DVR UID <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">td</span> <span class="attr">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row&quot;</span>&gt;</span> &#123;&#123;row.dvr_uid&#125;&#125; <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 表格標題 車牌 --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;car_uid&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">th</span> <span class="attr">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span> 車牌 <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">td</span> <span class="attr">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row&quot;</span>&gt;</span> &#123;&#123;row.car.car_uid&#125;&#125; <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 表格標題 車牌 --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;dvr_model&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">th</span> <span class="attr">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span> 型號 <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">td</span> <span class="attr">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row&quot;</span>&gt;</span> &#123;&#123;row.dvr_model&#125;&#125; <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 表格標題 --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;version&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">th</span> <span class="attr">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span> 版本 <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">td</span> <span class="attr">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row&quot;</span>&gt;</span> &#123;&#123;row.version&#125;&#125; <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 表格標題 --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;fw_update_progress&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">th</span> <span class="attr">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span> 進度 <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">td</span> <span class="attr">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123;&#123;row.car.fw_update_progress&#125;&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">mat-progress-bar</span> <span class="attr">mode</span>=<span class="string">&quot;determinate&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;row.car.fw_update_progress&#125;&#125;&quot;</span> <span class="attr">color</span>=<span class="string">&quot;accent&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">mat-progress-bar</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">tr</span> <span class="attr">mat-header-row</span> *<span class="attr">matHeaderRowDef</span>=<span class="string">&quot;[&#x27;dvr_uid&#x27;,&#x27;car_uid&#x27;,&#x27;dvr_model&#x27;,&#x27;version&#x27;,&#x27;fw_update_progress&#x27;];sticky:true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">tr</span> <span class="attr">mat-row</span> *<span class="attr">matRowDef</span>=<span class="string">&quot;let row; columns: [&#x27;dvr_uid&#x27;,&#x27;car_uid&#x27;,&#x27;dvr_model&#x27;,&#x27;version&#x27;,&#x27;fw_update_progress&#x27;];&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">cdk-virtual-scroll-viewport</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\DVR\dvrlist\dvrlist.component.scss</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line">.<span class="property">flex</span>-container &#123;</span><br><span class="line">  <span class="attr">display</span>: flex;   <span class="comment">/* Magic begins */</span></span><br><span class="line">  align-<span class="attr">items</span>: center;</span><br><span class="line">  <span class="comment">//margin-top: 64px;</span></span><br><span class="line">  flex-<span class="attr">direction</span>: column;</span><br><span class="line">  <span class="attr">width</span>: 95vw;</span><br><span class="line">  <span class="attr">height</span>: 100vh;</span><br><span class="line">&#125;</span><br><span class="line">.<span class="property">center</span> &#123;</span><br><span class="line">  <span class="attr">flex</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">table &#123;</span><br><span class="line">  <span class="attr">width</span>: 90vw;</span><br><span class="line">&#125;</span><br><span class="line">.<span class="property">example</span>-viewport &#123;</span><br><span class="line">  <span class="attr">height</span>: 90vh;</span><br><span class="line">  <span class="attr">width</span>: 90vw;</span><br><span class="line">  <span class="attr">border</span>: 1px solid black;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\DVR\dvrlist\dvrlist.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatTableDataSource</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/table&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DVRService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_services/dvr/dvr.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CarInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_models/car-info&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-dvrlist&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./dvrlist.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./dvrlist.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DVRListComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">dvrinfos</span>: <span class="title class_">CarInfo</span>[] = [];</span><br><span class="line">  dataSource = [];</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dvrService: DVRService</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> source = <span class="variable language_">this</span>.<span class="property">dvrService</span>.<span class="title function_">getEventSource</span>(<span class="string">&quot;HiSharp&quot;</span>);</span><br><span class="line">    source.<span class="title function_">addEventListener</span>(<span class="string">&#x27;dvr&#x27;</span>, <span class="function">(<span class="params">event: MessageEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> jsonobj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(event.<span class="property">data</span>)</span><br><span class="line">      <span class="comment">//console.log(jsonobj);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dvrinfos</span> = jsonobj.<span class="property">message</span> <span class="keyword">as</span> <span class="title class_">CarInfo</span>[];</span><br><span class="line">      <span class="comment">//可以解碼base64</span></span><br><span class="line">      <span class="comment">// dvrinfos.map(item =&gt; &#123;</span></span><br><span class="line">      <span class="comment">//   item.dvr_uid = this.dvrService.decodebase64(item.dvr_uid)</span></span><br><span class="line">      <span class="comment">// &#125;);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dataSource</span> = <span class="variable language_">this</span>.<span class="property">dvrinfos</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    source.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">event: MessageEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;reconnected service!&#x27;</span>)</span><br><span class="line">    &#125;, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>參考資料</p>
<p><a href="https://stackblitz.com/edit/cdk-virtual-table-sticky-header?file=src/app/app.component.css">表格</a></p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><p><a href="https://reality0ne.com/eventsource-in-flask/">在 Flask 中使用 EventSource</a></p>
<p><a href="https://flask-sse.readthedocs.io/en/latest/quickstart.html">https://flask-sse.readthedocs.io/en/latest/quickstart.html</a></p>
<p><a href="https://code-examples.net/zh-TW/q/baa670">https://code-examples.net/zh-TW/q/baa670</a></p>
<p><a href="https://xbuba.com/questions/12232304">https://xbuba.com/questions/12232304</a></p>
<p><a href="https://learnku.com/articles/30542">https://learnku.com/articles/30542</a></p>
]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flash-SSE</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>學習Flask起手式</title>
    <url>/%E5%AD%B8%E7%BF%92Flask%E8%B5%B7%E6%89%8B%E5%BC%8F/%E5%AD%B8%E7%BF%92Flask%E8%B5%B7%E6%89%8B%E5%BC%8F/</url>
    <content><![CDATA[<h3 id="先來設定flask的開發環境"><a href="#先來設定flask的開發環境" class="headerlink" title="先來設定flask的開發環境"></a>先來設定flask的開發環境</h3><p>先來建立虛擬環境，來執行flask,先建立虛擬環境要用的資料夾，我是建立像是這樣’D:\Project\Python\study_flask\venv\flask00’建立這樣是因為會有可能多個測試環境,這樣各環境之間不會互相干擾</p>
<h3 id="使用自帶的venv"><a href="#使用自帶的venv" class="headerlink" title="使用自帶的venv"></a>使用自帶的venv</h3><p>經過實驗，目前無法在vscode裏來單步執行</p>
<h4 id="安裝python的虛擬環境"><a href="#安裝python的虛擬環境" class="headerlink" title="安裝python的虛擬環境"></a>安裝python的虛擬環境</h4><ul>
<li><p>先切到此目錄下’D:\Project\Python\study_flask\venv’在下指令模式 python -m venv flask00 如下圖在flask00的資料下會產生相關的資料夾和程式庫</p>
  <img src="2019-04-12_12_12_20_Image.jpg" style="zoom:80%;" />
</li>
<li><p>起動虛擬環境，到flask00的路徑下的Scripts的目錄下執行activate.bat</p>
<p>在起動時提示字元會換成資料夾名稱如下圖所示</p>
<img src="2019-04-12_12_18_36_Image.jpg" style="zoom:80%;" />
</li>
<li><p>離開虛擬環境，到flask00的路徑下的Scripts的目錄下執行deactivate.bat</p>
<p>提示字元會回到原來的提示字元</p>
</li>
<li><p>安裝flask</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install flask</span><br></pre></td></tr></table></figure>
</li>
<li><p>檢查flask版本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flask --version</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="第一個程式"><a href="#第一個程式" class="headerlink" title="第一個程式"></a>第一個程式</h4><p>在flask00的資料夾下建立helloflask.py內容</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, world&#x27;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>在flask00的路徑執行python helloflask.py會出現如下的畫面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> * Serving Flask app &quot;helloflask&quot; (lazy loading)</span><br><span class="line"> * Environment: production</span><br><span class="line">   WARNING: Do not use the development server in a production environment.</span><br><span class="line">   Use a production WSGI server instead.</span><br><span class="line"> * Debug mode: on</span><br><span class="line"> * Restarting with stat</span><br><span class="line"> * Debugger is active!</span><br><span class="line"> * Debugger PIN: 313-752-154</span><br><span class="line"> * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</span><br><span class="line">127.0.0.1 - - [12/Apr/2019 13:43:04] &quot;GET / HTTP/1.1&quot; 200 -</span><br><span class="line">127.0.0.1 - - [12/Apr/2019 13:43:04] &quot;GET /favicon.ico HTTP/1.1&quot; 404 -</span><br></pre></td></tr></table></figure>

<p>打開瀏覽器，輸入<a href="http://127.0.0.1:5000/">http://127.0.0.1:5000</a></p>
<img src="2019-04-12_13_54_49_Image.jpg" style="zoom:80%;" />

<h4 id="使用vscode來執行和偵錯-目前無法單步執行"><a href="#使用vscode來執行和偵錯-目前無法單步執行" class="headerlink" title="使用vscode來執行和偵錯(目前無法單步執行)"></a>使用vscode來執行和偵錯(目前無法單步執行)</h4><p>接上面的專案，先以命令列模式，先到flask00的目錄下執行“code .”來執行vscode,在vscode裏來編輯launch.json,來執行和debug此專案,launch.json的內容如下</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python Flask&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flask&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stopOnEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="comment">// 將python指定為虛擬環境中的python</span></span><br><span class="line">            <span class="attr">&quot;pythonPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceRoot&#125;/Scripts/python.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceRoot&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="comment">// 指定這個項目的入口文件</span></span><br><span class="line">                <span class="attr">&quot;FLASK_APP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;helloflask.py&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;FLASK_ENV&quot;</span><span class="punctuation">:</span> <span class="string">&quot;development&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;FLASK_DEBUG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;run&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-debugger&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-reload&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="comment">// 虛擬環境的根目錄</span></span><br><span class="line">            <span class="attr">&quot;envFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceRoot&#125;/.venv&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;jinja&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>**注意的是虛擬環境中的python的位置</p>
<p>**注意的是這個項目的入口文件</p>
<h3 id="使用virtualenv的虛擬環境"><a href="#使用virtualenv的虛擬環境" class="headerlink" title="使用virtualenv的虛擬環境"></a>使用virtualenv的虛擬環境</h3><p>使用第三方的虛擬環境</p>
<h4 id="安裝virtualenv"><a href="#安裝virtualenv" class="headerlink" title="安裝virtualenv"></a>安裝virtualenv</h4><p>  會安裝在Lib\site-packages下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip install virtualenv</span><br></pre></td></tr></table></figure>

<p>卸載eirualenv</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip uninstall virtualenv</span><br></pre></td></tr></table></figure>

<h4 id="用virtualenv配置python虛擬環境"><a href="#用virtualenv配置python虛擬環境" class="headerlink" title="用virtualenv配置python虛擬環境"></a>用virtualenv配置python虛擬環境</h4><p>  <strong>注意虛擬什麼版本python,一定是這個python提前已經裝好了</strong></p>
<p>首先準備對哪個目錄進行虛擬，就到這個目錄下的上一層(D:\Project\Python\study_flask),然後運行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">virtualenv flaskenv</span><br><span class="line">## 這是使用原來安裝的python版本</span><br></pre></td></tr></table></figure>

<p>如果要安裝其他的版本,要指定安裝python的版本目錄</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">virtualenv -p c:\Python36\python.exe flaskenv</span><br></pre></td></tr></table></figure>

<h4 id="起動虛擬環境和退出虛擬環境"><a href="#起動虛擬環境和退出虛擬環境" class="headerlink" title="起動虛擬環境和退出虛擬環境"></a>起動虛擬環境和退出虛擬環境</h4><p>執行falskenv下的Scripts的activate.bat</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flaskenv\Scripts\activate.bat</span><br></pre></td></tr></table></figure>

<p>如下圖</p>
<img src="2019-04-15_09_46_30_Image.jpg" style="zoom:80%;" />

<p>退出虛擬環境</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flaskenv\Scripts\deactivate.bat</span><br></pre></td></tr></table></figure>

<h4 id="使用vscode來執行和偵錯"><a href="#使用vscode來執行和偵錯" class="headerlink" title="使用vscode來執行和偵錯"></a>使用vscode來執行和偵錯</h4><p>在起動虛擬環境後，在建立一個flask00的資料夾, 之後在虛擬環境起動vscode</p>
<img src="2019-04-15_10_05_17_Image.jpg" style="zoom:80%;" />

<p>之後在vscode的工作區設定裏將虛擬環境的python執行路徑加入到python:Venv Path</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\Project\Python\study_flask\flaskenv\Scripts</span><br></pre></td></tr></table></figure>

<img src="2019-04-15_10_11_24_Image.jpg" style="zoom:80%;" />

<h4 id="安裝flask"><a href="#安裝flask" class="headerlink" title="安裝flask"></a>安裝flask</h4><p>在虛擬的環境下來安裝</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install flask</span><br></pre></td></tr></table></figure>

<img src="2019-04-15_10_14_49_Image.jpg" style="zoom:80%;" />

<h4 id="建立第一個flask程式"><a href="#建立第一個flask程式" class="headerlink" title="建立第一個flask程式"></a>建立第一個flask程式</h4><p>在study_flask下在建立一個hello_flask(記得要啟動虛擬環境)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir hello_flask</span><br></pre></td></tr></table></figure>

<img src="2019-04-15_10_19_55_Image.jpg" style="zoom:80%;" />

<p>在hello_flask下的目錄啟動vscode,在設定vscode的工作區設定裏將虛擬環境的python執行路徑加入到python:Venv Path</p>
<p>在app.py裏加入</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, world&#x27;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">False</span>) <span class="comment"># 設定False才可以在vscode裏單步偵錯</span></span><br></pre></td></tr></table></figure>

<p><strong>記得要vscode要重序起動</strong></p>
]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>學習Flask起手式01</title>
    <url>/%E5%AD%B8%E7%BF%92Flask%E8%B5%B7%E6%89%8B%E5%BC%8F01/%E5%AD%B8%E7%BF%92Flask%E8%B5%B7%E6%89%8B%E5%BC%8F01/</url>
    <content><![CDATA[<h3 id="建立launch-json"><a href="#建立launch-json" class="headerlink" title="建立launch.json"></a>建立launch.json</h3><p>在打開vscode之後，使用Ctrl+Shift+D,會動生成一個launch.json,如果有出現選擇環境,我們選擇Python,只留下”name”: “Python: Flask”,剩下的可以刪除</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python: Flask&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flask&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="comment">// 選擇虛擬環境中的python版本</span></span><br><span class="line">            <span class="attr">&quot;pythonPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:/Project/Python/study_flask/flaskenv/Scripts/python.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="comment">// 入口文件</span></span><br><span class="line">                <span class="attr">&quot;FLASK_APP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;main.py&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;run&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-debugger&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-reload&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;jinja&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>加入main.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World!&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span> <span class="comment"># vscode 才可以偵錯</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>學習flask-restful Resource的重構</title>
    <url>/%E5%AD%B8%E7%BF%92flask-restful-Resource%E7%9A%84%E9%87%8D%E6%A7%8B/%E5%AD%B8%E7%BF%92flask-restful-Resource%E7%9A%84%E9%87%8D%E6%A7%8B/</url>
    <content><![CDATA[<h3 id="重構Resource"><a href="#重構Resource" class="headerlink" title="重構Resource"></a>重構Resource</h3><p>先重新檢視一下現有的程式碼，有把一些驗證請求參的部份抽離到UserSchema內，不過Resource下的user.py仍有許多改善的空間</p>
<h4 id="截至目前的user-py-Resource"><a href="#截至目前的user-py-Resource" class="headerlink" title="截至目前的user.py(Resource)"></a>截至目前的user.py(Resource)</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Resource</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> models.schema.user <span class="keyword">import</span> UserSchema</span><br><span class="line">users = []</span><br><span class="line">user_schema= UserSchema()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Resource</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, name</span>):</span><br><span class="line">        find = [item <span class="keyword">for</span> item <span class="keyword">in</span> users <span class="keyword">if</span> item[<span class="string">&#x27;name&#x27;</span>] == name]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(find) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;username not exist!&#x27;</span></span><br><span class="line">            &#125;, <span class="number">403</span></span><br><span class="line">        user = find[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;username not exist!&#x27;</span></span><br><span class="line">            &#125;, <span class="number">403</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>: user</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, name</span>):</span><br><span class="line">        result = user_schema.load(request.json)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result.errors)&gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> result.errors, <span class="number">433</span></span><br><span class="line">        user = &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: name,</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span>: result.data[<span class="string">&#x27;email&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: result.data[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">global</span> users</span><br><span class="line">        users.append(user)</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>:<span class="string">&#x27;Inser user success&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>:user</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, name</span>):</span><br><span class="line">        result = user_schema.load(request.json)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result.errors) &gt;<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> result.errors, <span class="number">433</span></span><br><span class="line"></span><br><span class="line">        find = [item <span class="keyword">for</span> item <span class="keyword">in</span> users <span class="keyword">if</span> item[<span class="string">&#x27;name&#x27;</span>]==name]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(find) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span>&#123;</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span>:<span class="string">&#x27;username not exist&#x27;</span></span><br><span class="line">            &#125;,<span class="number">403</span></span><br><span class="line">        user = find[<span class="number">0</span>]   </span><br><span class="line">        user[<span class="string">&#x27;email&#x27;</span>]= result.data[<span class="string">&#x27;email&#x27;</span>] </span><br><span class="line">        user[<span class="string">&#x27;password&#x27;</span>] = result.data[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>:<span class="string">&#x27;Update user success&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>:user</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">global</span> users</span><br><span class="line">        users = [item <span class="keyword">for</span> item <span class="keyword">in</span> users <span class="keyword">if</span> item[<span class="string">&#x27;name&#x27;</span>] != name]</span><br><span class="line">        <span class="keyword">return</span>&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Delete done!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Users</span>(<span class="title class_ inherited__">Resource</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;users&#x27;</span>: users</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="建立user-py-models"><a href="#建立user-py-models" class="headerlink" title="建立user.py(models)"></a>建立user.py(models)</h3><p>首先將使用者相關的函式抽離User這Resource，而且將users這個變數也放到models.user.py內，所以重構的第一個步驟就是產生含有以下內肉的models.user.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">users = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserModel</span>:</span><br><span class="line">    name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    email = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    password = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, email, password</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.email = email</span><br><span class="line">        self.password = password</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_user</span>(<span class="params">self</span>):</span><br><span class="line">        users.append(self)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">name</span>):</span><br><span class="line">        find = [item <span class="keyword">for</span> item <span class="keyword">in</span> users <span class="keyword">if</span> item.name == name]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(find)==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> find[<span class="number">0</span>]    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_user</span>(<span class="params">name</span>):</span><br><span class="line">        <span class="keyword">global</span> users</span><br><span class="line">        users = [item <span class="keyword">for</span> item <span class="keyword">in</span> users <span class="keyword">if</span> item.name!= name]</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_all_user</span>():</span><br><span class="line">        <span class="keyword">return</span> users</span><br><span class="line">        </span><br><span class="line">            </span><br></pre></td></tr></table></figure>

<h3 id="修改User這個Resource"><a href="#修改User這個Resource" class="headerlink" title="修改User這個Resource"></a>修改User這個Resource</h3><p>我們首先整理User這個Resource，簡單來說就是把相容的動作以呼叫models.user來取代，但是在返還回客戶端會遇到Model解析的問是，因為我們之前的使用者資料都是返回dict格式，所以flask-restful會自動轉換為JSON格式，但是現在的使用者資料都是UserModel所以返還時無法解析，這時再透過flask-marshmallow來處理即可，處理的方式如下說明</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">user_schema.dump(user).data</span><br></pre></td></tr></table></figure>

<p>最後user修改如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Resource</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> models.schema.user <span class="keyword">import</span> UserSchema</span><br><span class="line"><span class="keyword">from</span> models.user <span class="keyword">import</span> UserModel</span><br><span class="line"></span><br><span class="line">user_schema = UserSchema(many=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Resource</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, name</span>):</span><br><span class="line">        user = UserModel.get_user(name)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;username not exist!&#x27;</span></span><br><span class="line">            &#125;, <span class="number">403</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>: user_schema.dump(user).data</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, name</span>):</span><br><span class="line">        result = user_schema.load(request.json)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result.errors)&gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> result.errors, <span class="number">433</span></span><br><span class="line">        user = UserModel(name,result.data[<span class="string">&#x27;email&#x27;</span>],result.data[<span class="string">&#x27;password&#x27;</span>])    </span><br><span class="line">        user.add_user()</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>:<span class="string">&#x27;Inser user success&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>:user_schema.dump(user)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, name</span>):</span><br><span class="line">        result = user_schema.load(request.json)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result.errors) &gt;<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> result.errors, <span class="number">433</span></span><br><span class="line">        user = UserModel.get_user(name)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            <span class="keyword">return</span>&#123;</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span>:<span class="string">&#x27;username not exist&#x27;</span></span><br><span class="line">            &#125;,<span class="number">403</span></span><br><span class="line">        user.email= result.data[<span class="string">&#x27;email&#x27;</span>] </span><br><span class="line">        user.password = result.data[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>:<span class="string">&#x27;Update user success&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>:user_schema.dump(user).data</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self, name</span>):</span><br><span class="line">        UserModel.delete_user(name)</span><br><span class="line">        <span class="keyword">return</span>&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Delete done!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Users</span>(<span class="title class_ inherited__">Resource</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;users&#x27;</span>: user_schema.dump(UserModel.get_all_user(),<span class="literal">True</span>).data</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="改善取得請求參數問題"><a href="#改善取得請求參數問題" class="headerlink" title="改善取得請求參數問題"></a>改善取得請求參數問題</h4><p>這邊我們在針對POST與PUT都在處理請求參數抽離共同函式來處理，而相關改善的程式碼如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 放在uer.py的上面</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_param</span>():</span><br><span class="line">    data = request.get_json(force=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        data = request.form</span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>學習flask-restful_Url_Routing的參數處理</title>
    <url>/%E5%AD%B8%E7%BF%92flask-restful-Url-Routing%E7%9A%84%E5%8F%83%E6%95%B8%E8%99%95%E7%90%86/%E5%AD%B8%E7%BF%92flask-restful-Url-Routing%E7%9A%84%E5%8F%83%E6%95%B8%E8%99%95%E7%90%86/</url>
    <content><![CDATA[<h3 id="搞懂Url-Routing的參數處理"><a href="#搞懂Url-Routing的參數處理" class="headerlink" title="搞懂Url Routing的參數處理"></a>搞懂Url Routing的參數處理</h3><h4 id="來做個使用者CRUD"><a href="#來做個使用者CRUD" class="headerlink" title="來做個使用者CRUD"></a>來做個使用者CRUD</h4><p>先來做一個基本的CRUD的操作</p>
<h4 id="User基本結構"><a href="#User基本結構" class="headerlink" title="User基本結構"></a>User基本結構</h4><p>先定義User這個Resource的基本結構, 這只是定義結構</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Resource</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Resource</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="註冊Resouce"><a href="#註冊Resouce" class="headerlink" title="註冊Resouce"></a>註冊Resouce</h4><p>不過如何將name由url帶入方法內</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Api</span><br><span class="line"><span class="keyword">from</span> resources.user <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">api = Api(app)</span><br><span class="line"></span><br><span class="line">api.add_resource(User, <span class="string">&#x27;/user/&lt;string:name&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如此可以把<code>User</code>綁定到<code>url/user/</code>,而最後一個內容會轉型成字串傳遞給熱法當作是<code>name</code>的變數, 可以先以postman來測試,之前的uri應該是url</p>
<h4 id="設定POSTMAN"><a href="#設定POSTMAN" class="headerlink" title="設定POSTMAN"></a>設定POSTMAN</h4><img src="2019-04-16_11_14_41_Image.jpg" style="zoom:80%;" />

<p>可以在postman上執行get,post,put,delete的方法，只不過服務器的回應是null,應為我們的方法是空的</p>
<img src="2019-04-16_11_21_27_Image.jpg" style="zoom:80%;" />
#### 實作GET方法

<p>先不以資料庫的操作,修改user.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Resource</span><br><span class="line"></span><br><span class="line">users = [&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;kitty&#x27;</span></span><br><span class="line">&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Resource</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, name</span>):</span><br><span class="line">        find = [item <span class="keyword">for</span> item <span class="keyword">in</span> users <span class="keyword">if</span> item[<span class="string">&#x27;name&#x27;</span>] == name]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(find) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;username not exist!&#x27;</span></span><br><span class="line">            &#125;, <span class="number">403</span></span><br><span class="line">        user = find[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;username not exist!&#x27;</span></span><br><span class="line">            &#125;, <span class="number">403</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>: user</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h4 id="實作delete"><a href="#實作delete" class="headerlink" title="實作delete"></a>實作delete</h4><p>可以使用get方法來測試</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Resource</span><br><span class="line"></span><br><span class="line">users = [</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;kitty&#x27;</span>&#125;, </span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;tom&#x27;</span>&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Resource</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, name</span>):</span><br><span class="line">        find = [item <span class="keyword">for</span> item <span class="keyword">in</span> users <span class="keyword">if</span> item[<span class="string">&#x27;name&#x27;</span>] == name]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(find) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;username not exist!&#x27;</span></span><br><span class="line">            &#125;, <span class="number">403</span></span><br><span class="line">        user = find[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;username not exist!&#x27;</span></span><br><span class="line">            &#125;, <span class="number">403</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>: user</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">global</span> users</span><br><span class="line">        users = [item <span class="keyword">for</span> item <span class="keyword">in</span> users <span class="keyword">if</span> item[<span class="string">&#x27;name&#x27;</span>] != name]</span><br><span class="line">        <span class="keyword">return</span>&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Delete done!&#x27;</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>學習flask-restful使用flask-marshmallow</title>
    <url>/%E5%AD%B8%E7%BF%92flask-restful%E4%BD%BF%E7%94%A8flask-marshmallow/%E5%AD%B8%E7%BF%92flask-restful%E4%BD%BF%E7%94%A8flask-marshmallow/</url>
    <content><![CDATA[<h3 id="導入flask-marshmallow"><a href="#導入flask-marshmallow" class="headerlink" title="導入flask-marshmallow"></a>導入flask-marshmallow</h3><p>透過此函式庫可以讓我們的程式在處理請求參數更彈性。在user.py的寫法沒有辦法驗證&#x3D;&#x3D;email&#x3D;&#x3D;以及&#x3D;&#x3D;password&#x3D;&#x3D;資料的正確性，頂多只確定使用者有提交此參數,所以這裡我們要介紹一個套件來取代原來flask-restul內建的reqpase。</p>
<h3 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h3><p>安裝的方法很簡單就是輸入以下指令即可。記得如果有虛擬環境要先啟動才來安裝</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install flask-marshmallow</span><br></pre></td></tr></table></figure>
<h3 id="初始設定"><a href="#初始設定" class="headerlink" title="初始設定"></a>初始設定</h3><p>在安裝完flask-marshmallow後要處理的是如何在我們先新增一個<code>ma.py</code>在<code>common</code>資料夾內。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># common/ma.py</span></span><br><span class="line"><span class="keyword">from</span> flask_marshmallow <span class="keyword">import</span> Marshmallow</span><br><span class="line">ma = Marshmallow()</span><br></pre></td></tr></table></figure>

<p>為什麼要做這個動作呢，主要是為了避色以後的開法產生循環參考的狀況，因為在後續的動作很會使用到<code>ma</code>這個實體。</p>
<h3 id="加入應用程序內"><a href="#加入應用程序內" class="headerlink" title="加入應用程序內"></a>加入應用程序內</h3><p>在設定好flask-marshmallow後要把flask-marshmallow加到我們的flask-restful應用程序之中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Api</span><br><span class="line"><span class="keyword">from</span> resources.user <span class="keyword">import</span> User,Users</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">api = Api(app)</span><br><span class="line">api.add_resource(User, <span class="string">&#x27;/user/&lt;string:name&gt;&#x27;</span>)</span><br><span class="line">api.add_resource(Users, <span class="string">&#x27;/users/&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 在此加入</span></span><br><span class="line">    <span class="keyword">from</span> common.ma <span class="keyword">import</span> ma</span><br><span class="line">    ma.init_app(app)</span><br><span class="line">    app.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="marshmallow的元素"><a href="#marshmallow的元素" class="headerlink" title="marshmallow的元素"></a>marshmallow的元素</h3><p>在這邊我們透過建立一個解析請求參數內容的方式介紹marshmallow內含的元素，先介紹schema</p>
<h4 id="schema"><a href="#schema" class="headerlink" title="schema"></a>schema</h4><p>我們可以透過這一個schema來建立我們預期請求參數的內容的基本結構，下面例子我們建立一個<code>UserSchema</code>來定義我們接收到使用者的請求參數所包含的元素</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> common.ma <span class="keyword">import</span> ma</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserSchema</span>(ma.Schema):</span><br><span class="line">    email = ma.Str()</span><br><span class="line">    password = ma.Str()</span><br></pre></td></tr></table></figure>

<p>在定義<code>UserSchema</code>之前我們需要把先前的flask-marshmallow函式庫import進來，因為所有自訂義的marshmallow的schema都要繼承Marshmllow.Schema，接下來我們在<code>UserSchema</code>定義他有兩個屬性<code>email</code>與<code>password</code>這兩個屬性的型別是字串，而marshmallow的field有很多䅜以下針對下列幾點加以說明</p>
<ul>
<li>Str,Int,Bool,Float</li>
<li>DateTime,LocalDatTime</li>
<li>Email</li>
<li>Nested</li>
</ul>
<h4 id="Str-Int-Bool-Float"><a href="#Str-Int-Bool-Float" class="headerlink" title="Str,Int,Bool,Float"></a>Str,Int,Bool,Float</h4><p>這就是一些常用的基本型別</p>
<h4 id="DateTime-LocalDatTime"><a href="#DateTime-LocalDatTime" class="headerlink" title="DateTime,LocalDatTime"></a>DateTime,LocalDatTime</h4><p>這是一些時間的型別</p>
<h4 id="Email"><a href="#Email" class="headerlink" title="Email"></a>Email</h4><p>這就限制字串內容是Email的格式</p>
<h4 id="Nested"><a href="#Nested" class="headerlink" title="Nested"></a>Nested</h4><p>這個Nested比較特別，就是的個複雜的型號它可以透過傳入另外一個Schema告訴目前的Schema知道那個屬性是該Schema的型別，這樣說來很抽象就讓大家看看下列例子</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ASchema</span>(ma.Schema):</span><br><span class="line">    name = ma.Str()</span><br><span class="line">    password = ma.Str()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BSchema</span>(ma.Schema):</span><br><span class="line">    aItem = ma.Nested(ASchema)</span><br></pre></td></tr></table></figure>

<h4 id="validate"><a href="#validate" class="headerlink" title="validate"></a>validate</h4><p>由於先前的內容會驗證所需內容一要會提交，但是沒有驗證格式是否相符，所以我們 進一步修正上述的例子</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> common.ma <span class="keyword">import</span> ma</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserSchema</span>(ma.Schema):</span><br><span class="line">    email = ma.Email(required=<span class="literal">True</span>)</span><br><span class="line">    password = ma.Str(required=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>經過修正之後我們針對email的內容加規範，所以當提交內容不符合Email的規範時他會提示錯誤內容，並且該屬性的內容會是Node,不過password若是提交空字串他還是會通過，因此我們再日以修正如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># models/schema/user.py</span></span><br><span class="line"><span class="keyword">from</span> common.ma <span class="keyword">import</span> ma</span><br><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> validate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserSchema</span>(ma.Schema):</span><br><span class="line">    email = ma.Email(required=<span class="literal">True</span>)</span><br><span class="line">    password = ma.Str(required=<span class="literal">True</span>, validate=[</span><br><span class="line">                      validate.Length(<span class="built_in">min</span>=<span class="number">6</span>, <span class="built_in">max</span>=<span class="number">36</span>)])</span><br></pre></td></tr></table></figure>

<p>透過<code>validate.Length</code>我們可以指定密碼的長度落在6~36之間，所以當下次提交請求時若是password提交空字串時會得到驗證失敗的錯誤</p>
<h3 id="在flask-restful內加入Schema"><a href="#在flask-restful內加入Schema" class="headerlink" title="在flask-restful內加入Schema"></a>在flask-restful內加入Schema</h3><p>首先建立一個資料夾<code>models</code>在下面在建立一個資料夾<code>schema</code>,並在schema內加入<code>user.py</code>的檔案將上述的內容貼到user.py檔案內，接下來我們針對Resource下的user.py加以修改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> models.schema.user <span class="keyword">import</span> UserSchema</span><br></pre></td></tr></table></figure>

<p>當然第一步是先將先前寫好的UserSchema給import進來, 在來下一步是產生一個UserSchema的實體</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">user_schema = UserSchema()</span><br></pre></td></tr></table></figure>

<p>最後就是在處理POST與PUT方法時使用<code>user_schema</code>來解析傳入參數的內容以下是例子</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">json_data = request.json</span><br><span class="line">result = user_schema.load(json_data)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(result.errors) &gt; <span class="number">0</span>:</span><br><span class="line">	<span class="keyword">return</span> result.errors, <span class="number">433</span></span><br><span class="line">user = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>:name,</span><br><span class="line">    <span class="string">&#x27;email&#x27;</span>:result.data[<span class="string">&#x27;email&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span>:result.data[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>

<p>不遛這裡有個缺點，就是需要明確的定義請求的方式是透過form或是json格式，像上述是透過json方式，如果改成form的方式傳遞就會解析失敗，如果是以form來傳遞就要修改成以下內容</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">json_data = request.form</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>學習flask-restful如何透過POSTMAN執行整合測試</title>
    <url>/%E5%AD%B8%E7%BF%92flask-restful%E5%A6%82%E4%BD%95%E9%80%8F%E9%81%8EPOSTMAN%E5%9F%B7%E8%A1%8C%E6%95%B4%E5%90%88%E6%B8%AC%E8%A9%A6/%E5%AD%B8%E7%BF%92flask-restful%E5%A6%82%E4%BD%95%E9%80%8F%E9%81%8EPOSTMAN%E5%9F%B7%E8%A1%8C%E6%95%B4%E5%90%88%E6%B8%AC%E8%A9%A6/</url>
    <content><![CDATA[<h3 id="簡介"><a href="#簡介" class="headerlink" title="簡介"></a>簡介</h3><p>因為有看到使用POSTMAN來測試自已寫好的API，如果已經寫好的API可以寫一系列的測試案例來測試自已的程式，如果測試案例全過，代表程式應該被修改到，可以安心，這只是一個簡單的測試用例，記錄一下如何使用POSTMAN</p>
<ul>
<li><p>測試用例是取得所有的使用者</p>
<p>因為一開始將所有的使用者清空，所有得到的是長度為0的陣列，可以來判斷是否是沒有使用者</p>
<img src="2019-04-18_17_47_12_Image.jpg" style="zoom:80%;" /></li>
</ul>
<p>在上圖中選擇<code>&#123;&#123;url&#125;&#125;/users</code>來測試此API，在右邊的橘色的框框是測試的範本，可以直接來點選，在左邊的紅色框框是可以寫的測試腳本是以JavaScript來撰寫</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">pm.<span class="title function_">test</span>(<span class="string">&quot;get users&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> jsonData = pm.<span class="property">response</span>.<span class="title function_">json</span>();</span><br><span class="line">    pm.<span class="title function_">expect</span>(jsonData.<span class="property">users</span>.<span class="property">length</span>).<span class="property">to</span>.<span class="title function_">eql</span>(<span class="number">0</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask,PostMan</tag>
      </tags>
  </entry>
  <entry>
    <title>學習flask-restful請求參數處理</title>
    <url>/%E5%AD%B8%E7%BF%92flask-restful%E8%AB%8B%E6%B1%82%E5%8F%83%E6%95%B8%E8%99%95%E7%90%86/%E5%AD%B8%E7%BF%92flask-restful%E8%AB%8B%E6%B1%82%E5%8F%83%E6%95%B8%E8%99%95%E7%90%86/</url>
    <content><![CDATA[<h4 id="處理參數"><a href="#處理參數" class="headerlink" title="處理參數"></a>處理參數</h4><p>之前處理的參數是透個url來傳遞參數，如果是使用post和put可就沒辦法使用，而是需要透過參數傳遞</p>
<h4 id="新增Users"><a href="#新增Users" class="headerlink" title="新增Users"></a>新增Users</h4><p>我們要確認users的內容到底有多少，可以新增一個Users的Resource來提交取得所有user的&#x3D;&#x3D;GET&#x3D;&#x3D;方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Users</span>(<span class="title class_ inherited__">Resource</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>:<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;users&#x27;</span>:users</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>修改一下app.py註冊Users</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">api.add_resource(Users, &#x27;/users/&#x27;)</span><br></pre></td></tr></table></figure>

<p>執行結果如下</p>
<img src="2019-04-17_09_58_51_Image.jpg" style="zoom:80%;" />

<h4 id="開發POST"><a href="#開發POST" class="headerlink" title="開發POST"></a>開發POST</h4><p>我們先import一個函式庫進來，因為我們需要解析請求的參數</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> reqparse</span><br></pre></td></tr></table></figure>

<p>在import reqparse這函式庫之後首先要定義欲接受請求的參數內容，在要使用的地方</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Resource</span>):</span><br><span class="line">    parser = reqparse.RequestParser()</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;email&#x27;</span>,required=<span class="literal">True</span>,<span class="built_in">help</span>=<span class="string">&#x27;Email is required&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;password&#x27;</span>,required=<span class="literal">True</span>,<span class="built_in">help</span>=<span class="string">&#x27;Password is required&#x27;</span>)</span><br><span class="line"><span class="comment">##以下省略    </span></span><br></pre></td></tr></table></figure>

<p>type:是要指定的型別</p>
<p>required:請求參數中屬於必填，入無輸入會直接回傳錯誤</p>
<p>help:是當請求參睥驗證失敗(型別不符，未填寫)會返回的訊息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">parser.add_argument(<span class="string">&#x27;foo&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, required=<span class="literal">True</span>,<span class="built_in">help</span>=<span class="string">&#x27;error message&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="實作POST"><a href="#實作POST" class="headerlink" title="實作POST"></a>實作POST</h4><p>使用reqparse之後，實作就變的很簡單</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在user.py中的class User</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, name</span>):</span><br><span class="line">        arg = self.parser.parse_args()</span><br><span class="line">        user = &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: name,</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span>: arg[<span class="string">&#x27;email&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: arg[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">global</span> users</span><br><span class="line">        users.append(user)</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>:<span class="string">&#x27;Inser user success&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>:user</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h5 id="設定postman"><a href="#設定postman" class="headerlink" title="設定postman"></a>設定postman</h5><p>可以設定postman來驗證POST是否正確</p>
<p>首先先選擇POST的方法如下圖</p>
<img src="2019-04-17_10_48_51_Image.jpg" style="zoom:80%;" />

<p>接下來設定傳送的內容有兩種JSON和FORM</p>
<h5 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h5><img src="2019-04-17_10_52_35_Image.jpg" style="zoom:80%;" />

<h5 id="FORM"><a href="#FORM" class="headerlink" title="FORM"></a>FORM</h5><img src="2019-04-17_10_54_42_Image.jpg" style="zoom:80%;" />

<p>這兩個作法都能接受，如果要指定格式參考以下例子</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Look only in the POST body</span></span><br><span class="line">parser.add_argument(<span class="string">&#x27;name&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, location=<span class="string">&#x27;form&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Look only in the querystring</span></span><br><span class="line">parser.add_argument(<span class="string">&#x27;name&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, location=<span class="string">&#x27;args&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Look only in the json</span></span><br><span class="line">parser.add_argument(<span class="string">&#x27;name&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, location=<span class="string">&#x27;json&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Look only in the multi location</span></span><br><span class="line">parser.add_argument(<span class="string">&#x27;name&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, location=[<span class="string">&#x27;form&#x27;</span>, <span class="string">&#x27;json&#x27;</span>])</span><br></pre></td></tr></table></figure>

<h4 id="開發PUT"><a href="#開發PUT" class="headerlink" title="開發PUT"></a>開發PUT</h4><p>put是更新資料</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在user.py中的class User</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, name</span>):</span><br><span class="line">        arg =self.parser.parse_args()</span><br><span class="line">        find = [item <span class="keyword">for</span> item <span class="keyword">in</span> users <span class="keyword">if</span> item[<span class="string">&#x27;name&#x27;</span>]==name]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(find) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span>&#123;</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span>:<span class="string">&#x27;username not exist&#x27;</span></span><br><span class="line">            &#125;,<span class="number">403</span></span><br><span class="line">        user = find[<span class="number">0</span>]   </span><br><span class="line">        user[<span class="string">&#x27;email&#x27;</span>]= arg[<span class="string">&#x27;email&#x27;</span>] </span><br><span class="line">        user[<span class="string">&#x27;password&#x27;</span>] = arg[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>:<span class="string">&#x27;Update user success&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>:user</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h5 id="驗證PUT"><a href="#驗證PUT" class="headerlink" title="驗證PUT"></a>驗證PUT</h5><p>首先先選擇PUT方法</p>
<img src="2019-04-17_11_09_06_Image.jpg" style="zoom:80%;" />

<p>在json中輸入資料和form中輸入資料，可以看到有改變，可以使用get&#x2F;users來查看</p>
]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>學習flask-restful起手式</title>
    <url>/%E5%AD%B8%E7%BF%92flask-restful%E8%B5%B7%E6%89%8B%E5%BC%8F/%E5%AD%B8%E7%BF%92flask-restful%E8%B5%B7%E6%89%8B%E5%BC%8F/</url>
    <content><![CDATA[<h3 id="flask-restful起手式"><a href="#flask-restful起手式" class="headerlink" title="flask-restful起手式"></a>flask-restful起手式</h3><h4 id="安裝flask-restful"><a href="#安裝flask-restful" class="headerlink" title="安裝flask-restful"></a>安裝flask-restful</h4><p>要在虛擬python版本的環境安裝</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install flask-restful</span><br></pre></td></tr></table></figure>

<h4 id="第一個resource"><a href="#第一個resource" class="headerlink" title="第一個resource"></a>第一個resource</h4><p>以下是基本的結構</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Api</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">api =Api(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>以下是新增一個resource,而restful就是以資源為基礎，每一個項目都可以是一個資源，所以我們在添加一個resource在原來的內容中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Api</span><br><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Resource</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PrintHelloWorld</span>(<span class="title class_ inherited__">Resource</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span>&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>:<span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">        &#125;,<span class="number">200</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">api =Api(app)</span><br><span class="line"></span><br><span class="line">api.add_resource(PrintHelloWorld,<span class="string">&#x27;/print_hello_world&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<h4 id="第一個POSTMAN請求"><a href="#第一個POSTMAN請求" class="headerlink" title="第一個POSTMAN請求"></a>第一個POSTMAN請求</h4><p>安裝postman, 可以登入或是不登人(在畫面的最不方可以選擇不登入)</p>
<p>首先先建立目前的使用環境的通用變數,例如目前的測試server是127.0.0.1:5000,可以在postman先建立好，可以直接來使用在’Manage Environments’來設定</p>
<img src="2019-04-15_16_00_29_Image.jpg" style="zoom:80%;" />

<p>在按下’Add’後可以開始設定要用到的變數</p>
<img src="2019-04-15_16_04_32_Image.jpg" style="zoom:80%;" />

<p>在VARIABLE-&gt; uri , INITIAL VALUE-&gt; 120.0.0.1 CURRENT VALUE-&gt; 127.0.0.1:5000接下來按下’Add’，便可接下來送post命令</p>
<img src="2019-04-15_16_08_02_Image.jpg" style="zoom:80%;" />

<p>選擇’flask-restful’在GET輸入’&#x2F;print_hello_world’接下來按下’Send’的按鈕，可以在Body收到如上圖的’Hello world’,即完成第一個restfule api的功能</p>
<h3 id="專案的基本結構"><a href="#專案的基本結構" class="headerlink" title="專案的基本結構"></a>專案的基本結構</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">│- app.py</span><br><span class="line">│  __init__.py</span><br><span class="line">│</span><br><span class="line">├─common</span><br><span class="line">│      util.py</span><br><span class="line">│      __init__.py</span><br><span class="line">│</span><br><span class="line">└─resources</span><br><span class="line">        foo.py</span><br><span class="line">        bar.py</span><br><span class="line">        __init__.py</span><br></pre></td></tr></table></figure>

<ul>
<li>app.py 主要是主程式和routes</li>
<li>util.py 主要是常用的公用函數</li>
<li>foo.py和bar.py 相關邏輯</li>
</ul>
]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>學習flask上載和下載的相關使用</title>
    <url>/%E5%AD%B8%E7%BF%92flask%E4%B8%8A%E8%BC%89%E5%92%8C%E4%B8%8B%E8%BC%89%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92flask%E4%B8%8A%E8%BC%89%E5%92%8C%E4%B8%8B%E8%BC%89%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h2 id="使用Angular"><a href="#使用Angular" class="headerlink" title="使用Angular"></a>使用Angular</h2><p>因為專案有使用到，可以使用angular來作上傳的動作，所以來學習一下</p>
<span id="more"></span>

<p>先來建立基本架構</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng new nguploadfile</span><br></pre></td></tr></table></figure>

<h3 id="加入AngularMateial"><a href="#加入AngularMateial" class="headerlink" title="加入AngularMateial"></a>加入AngularMateial</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng add @angular/material</span><br></pre></td></tr></table></figure>

<p>目前選擇<code>indigo-pink</code><br>加入theme設定<br>在’styles.scss’中,有四種選一種</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/deeppurple-amber.css&quot;;</span></span><br><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/indigo-pink.css&quot;;</span></span><br><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/pink-bluegrey.css&quot;;</span></span><br><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/purple-green.css&quot;;</span></span><br></pre></td></tr></table></figure>

<p>加入SharedAngularMaterial &lt;<a href="https://ithelp.ithome.com.tw/articles/10209937">https://ithelp.ithome.com.tw/articles/10209937</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g m share\SharedAngularMaterial</span><br></pre></td></tr></table></figure>

<h3 id="在MatIcon中使用Icon-Font"><a href="#在MatIcon中使用Icon-Font" class="headerlink" title="在MatIcon中使用Icon Font"></a>在MatIcon中使用Icon Font</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install --save @fortawesome/fontawesome-free</span><br></pre></td></tr></table></figure>

<p>接下來在src\styles.scss中</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/deeppurple-amber.css&quot;;</span></span><br><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/indigo-pink.css&quot;;</span></span><br><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/pink-bluegrey.css&quot;;</span></span><br><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/purple-green.css&quot;;</span></span><br><span class="line"><span class="keyword">@import</span> <span class="string">&quot;~@fortawesome/fontawesome-free/css/all.css&quot;</span>;</span><br><span class="line"><span class="comment">//使mat-car有作用</span></span><br><span class="line">mat-card&#123;</span><br><span class="line">  <span class="attribute">margin</span>:<span class="number">4px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//寬度為填滿</span></span><br><span class="line"><span class="selector-class">.full-width</span>&#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">html</span>, <span class="selector-tag">body</span>, app-root,mat-sidenav-container, <span class="selector-class">.site</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.site</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-direction</span>: column;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">main</span> &#123;</span><br><span class="line">  <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-direction</span>: column;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">  <span class="attribute">margin-top</span>:<span class="number">64px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.fill-remaining-space</span> &#123;</span><br><span class="line">  <span class="comment">// 使用 flexbox 填充剩余空间</span></span><br><span class="line">  <span class="comment">// @angular/material 中的很多控件使用了 flex 布局</span></span><br><span class="line">  <span class="attribute">flex</span>: <span class="number">1</span> <span class="number">1</span> auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//#region 以下是自定義字型大小</span></span><br><span class="line"><span class="selector-class">.mat-raised-button</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">18px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// .mat-list-base .mat-list-item .mat-line:nth-child(n+2) &#123;</span></span><br><span class="line"><span class="comment">//   font-size: 18px;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="selector-class">.mat-line</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">18px</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mat-list-base</span> <span class="selector-class">.mat-list-option</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">18px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mat-header-cell</span>&#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">14px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mat-cell</span>&#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">18px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//#endregion 以下是自定義字型大小</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.color1</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f80909</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.color2</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f4f809</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.color3</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#31f809</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.color4</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#0949f8</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.color5</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#c809f8</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="建立測試元件"><a href="#建立測試元件" class="headerlink" title="建立測試元件"></a>建立測試元件</h3><p>一個上傳檔案，一個是檔案列表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g component pages/Upload</span><br><span class="line">ng g component pages/FwFileList</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\fw-file-list\fw-file-list.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;padding: 13px;&quot;</span>&gt;</span></span><br><span class="line">  Angular 8 tutorial &amp; example — How to upload image file with FormData &amp; HttpClient</span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="設定路由"><a href="#設定路由" class="headerlink" title="設定路由"></a>設定路由</h3><p>在<code>src\app\app-routing.module.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;fwupload&#x27;</span>, <span class="attr">pathMatch</span>: <span class="string">&#x27;full&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;fwupload&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UploadComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;fwfilelist&#x27;</span>, <span class="attr">component</span>: <span class="title class_">FwFileListComponent</span> &#125;</span><br><span class="line">];</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppRoutingModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="設定切換"><a href="#設定切換" class="headerlink" title="設定切換"></a>設定切換</h3><p>在<code>src\app\app.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mat-toolbar</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">    ngImageUpload</span><br><span class="line">  <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">routerLink</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Upload<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">routerLink</span>=<span class="string">&quot;/fwfilelist&quot;</span>&gt;</span>檔案列表<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-toolbar</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-outlet</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="建立上傳服務"><a href="#建立上傳服務" class="headerlink" title="建立上傳服務"></a>建立上傳服務</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g service fw/_services/upload</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\_services\fw\upload.service.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UploadService</span> &#123;</span><br><span class="line">  <span class="comment">//api = `$&#123;environment.apiUrl&#125;/servers`;</span></span><br><span class="line">  api = <span class="string">&quot;https://file.io/&quot;</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> httpClient: HttpClient</span>) &#123; &#125;</span><br><span class="line">  <span class="title function_">upload</span>(<span class="params">formData</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">httpClient</span>.<span class="property">post</span>&lt;<span class="built_in">any</span>&gt;(<span class="variable language_">this</span>.<span class="property">api</span>, formData, &#123;</span><br><span class="line">      <span class="attr">reportProgress</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">observe</span>: <span class="string">&#x27;events&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\upload\upload.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center; margin-top: 100px; &quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-card</span> <span class="attr">style</span>=<span class="string">&quot;margin-top:10px; width: 50%;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-card-content</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let file of files&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">mat-progress-bar</span> [<span class="attr">value</span>]=<span class="string">&quot;file.progress&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">mat-progress-bar</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;file-label&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">          <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-card-content</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-card-actions</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- &lt;button mat-button color=&quot;warn&quot; (click)=&quot;onClick()&quot;&gt;</span></span><br><span class="line"><span class="comment">        &lt;mat-icon&gt;file_upload&lt;/mat-icon&gt;</span></span><br><span class="line"><span class="comment">        Upload</span></span><br><span class="line"><span class="comment">      &lt;/button&gt; --&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-flat-button</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mat-icon</span>&gt;</span>file_upload<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">        Upload</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> #<span class="attr">fileUpload</span> <span class="attr">id</span>=<span class="string">&quot;fileUpload&quot;</span> <span class="attr">name</span>=<span class="string">&quot;fileUpload&quot;</span> (<span class="attr">change</span>)=<span class="string">&quot;onFileSelected($event)&quot;</span> <span class="attr">style</span>=<span class="string">&quot;opacity: 0; position:absolute; left:0px; top:0px; width:100%; height:100%;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-card-actions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-card</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;input type=&quot;file&quot; #fileUpload id=&quot;fileUpload&quot; name=&quot;fileUpload&quot; multiple=&quot;multiple&quot; accept=&quot;image/*&quot; style=&quot;display:none;&quot; /&gt; --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;input type=&quot;file&quot; #fileUpload id=&quot;fileUpload&quot; name=&quot;fileUpload&quot; accept=&quot;image/*&quot; style=&quot;display:none;&quot; /&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\upload\upload.component.scss</code></p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">ul</span>,</span><br><span class="line"><span class="selector-tag">li</span> &#123;</span><br><span class="line">      <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">      <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">      <span class="attribute">list-style</span>: none;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\upload\upload.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span>, <span class="title class_">ViewChild</span>, <span class="title class_">ElementRef</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpEventType</span>, <span class="title class_">HttpErrorResponse</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; catchError, map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UploadService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_services/fw/upload.service&#x27;</span>;</span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-upload&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./upload.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./upload.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UploadComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ViewChild</span>(<span class="string">&quot;fileUpload&quot;</span>, &#123; <span class="attr">static</span>: <span class="literal">false</span> &#125;) <span class="attr">fileUpload</span>: <span class="title class_">ElementRef</span>;</span><br><span class="line">  files = [];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> uploadService: UploadService</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">uploadFile</span>(<span class="params">file</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">    formData.<span class="title function_">append</span>(<span class="string">&quot;file&quot;</span>, file.<span class="property">data</span>);</span><br><span class="line">    file.<span class="property">inProgress</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">uploadService</span>.<span class="title function_">upload</span>(formData).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.<span class="property">type</span>) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="title class_">HttpEventType</span>.<span class="property">UploadProgress</span>:</span><br><span class="line">            <span class="comment">//console.log(event);</span></span><br><span class="line">            file.<span class="property">progress</span> = <span class="title class_">Math</span>.<span class="title function_">round</span>(event.<span class="property">loaded</span> * <span class="number">100</span> / event.<span class="property">total</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="title class_">HttpEventType</span>.<span class="property">Response</span>:</span><br><span class="line">            <span class="keyword">return</span> event;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="title function_">catchError</span>(<span class="function">(<span class="params">error: HttpErrorResponse</span>) =&gt;</span> &#123;</span><br><span class="line">        file.<span class="property">inProgress</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">of</span>(<span class="string">`<span class="subst">$&#123;file.data.name&#125;</span> upload failed.`</span>)</span><br><span class="line">      &#125;)).<span class="title function_">subscribe</span>(<span class="function">(<span class="params">event: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> (event) === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(event.<span class="property">body</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">uploadFiles</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fileUpload</span>.<span class="property">nativeElement</span>.<span class="property">value</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">files</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">uploadFile</span>(file);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onFileSelected</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">target</span>.<span class="property">files</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; event.<span class="property">target</span>.<span class="property">files</span>.<span class="property">length</span>; index++) &#123;</span><br><span class="line">        <span class="keyword">const</span> file = event.<span class="property">target</span>.<span class="property">files</span>[index];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">files</span>.<span class="title function_">push</span>(&#123; <span class="attr">data</span>: file, <span class="attr">inProgress</span>: <span class="literal">false</span>, <span class="attr">progress</span>: <span class="number">0</span> &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">uploadFiles</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// const fileUpload = this.fileUpload.nativeElement;</span></span><br><span class="line">    <span class="comment">// for (let index = 0; index &lt; fileUpload.files.length; index++) &#123;</span></span><br><span class="line">    <span class="comment">//   const file = fileUpload.files[index];</span></span><br><span class="line">    <span class="comment">//   this.files.push(&#123; data: file, inProgress: false, progress: 0 &#125;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// fileUpload.onchange = () =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//   for (let index = 0; index &lt; fileUpload.files.length; index++) &#123;</span></span><br><span class="line">    <span class="comment">//     const file = fileUpload.files[index];</span></span><br><span class="line">    <span class="comment">//     this.files.push(&#123; data: file, inProgress: false, progress: 0 &#125;);</span></span><br><span class="line">    <span class="comment">//   &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// fileUpload.click();</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://www.ahmedbouchefra.com/angular/angular-9-8-tutorial-example-upload-files-with-formdata-httpclient-rxjs-and-material-progressbar/">Angular 9&#x2F;8 Tutorial &amp; Example — Upload Files with FormData, HttpClient, RxJS, and Material ProgressBar</a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>因為專案上有使用到檔案的上傳和下載，所以來記錄一下在Python上如何的使用，網路上的範例是以flask加上它回傳的template的html檔來使用。但是我們的專案比較像是web service的方式來處理。</p>
<h3 id="建立基本的架構"><a href="#建立基本的架構" class="headerlink" title="建立基本的架構"></a>建立基本的架構</h3><p>參考的程式碼<a href="https://github.com/ttom921/StudyPython/tree/master/Test_flask_rest_api_file_upload/">github</a></p>
<p>先來建立一開始使用的python的web服務器的架構，因為在之前有建立相關的python的結構，所以就直接複制過來使用，包括<code>.vscoe</code>的設定檔</p>
<p>在<code>.vscode\launch.json</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python: Flask&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flask&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="comment">// 選擇虛擬環境中的python版本</span></span><br><span class="line">            <span class="attr">&quot;pythonPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:/Project/github/StudyPython/pyvirenv/pyenv37/Scripts/python.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="comment">// 入口文件</span></span><br><span class="line">                <span class="attr">&quot;FLASK_APP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;main.py&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;run&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-debugger&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-reload&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;jinja&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在<code>.vscode\settings.json</code>這是訯是虛擬環境的設定</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;python.venvPath&quot;: &quot;D:\\Project\\github\\StudyPython\\pyvirenv\\pyenv37\\Scripts&quot;,</span><br><span class="line">    &quot;python.pythonPath&quot;: &quot;D:\\Project\\github\\StudyPython\\pyvirenv\\pyenv37\\Scripts\\python.exe&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最簡單的web在<code>main.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, redirect, jsonify</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hellworld</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h3 id="查看檔案的列表"><a href="#查看檔案的列表" class="headerlink" title="查看檔案的列表"></a>查看檔案的列表</h3><p>在<code>main.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, redirect, jsonify</span><br><span class="line"></span><br><span class="line">UPLOAD_FOLDER = <span class="string">&#x27;d:/uploads&#x27;</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.secret_key = <span class="string">&quot;secret key&quot;</span></span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>] = UPLOAD_FOLDER</span><br><span class="line"><span class="comment"># 檔案的大小</span></span><br><span class="line">app.config[<span class="string">&#x27;MAX_CONTENT_LENGTH&#x27;</span>] = <span class="number">256</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 檔案列表功能</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/files&#x27;</span>,defaults=&#123;<span class="string">&#x27;folder&#x27;</span>: <span class="literal">None</span>,<span class="string">&#x27;sub_folder&#x27;</span>: <span class="literal">None</span>&#125;, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">files</span>(<span class="params">folder,sub_folder</span>):</span><br><span class="line">    <span class="comment"># print(request.environ[&#x27;HTTP_ORIGIN&#x27;])</span></span><br><span class="line">    basedir = app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>]</span><br><span class="line">    directory = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> folder != <span class="literal">None</span>:</span><br><span class="line">        directory = directory + <span class="string">&#x27;/&#x27;</span> + folder</span><br><span class="line">    <span class="keyword">if</span> sub_folder != <span class="literal">None</span>:</span><br><span class="line">        directory = directory + <span class="string">&#x27;/&#x27;</span> + sub_folder    </span><br><span class="line">    files = os.listdir(basedir + directory)  </span><br><span class="line">    resp= jsonify(&#123;<span class="string">&#x27;fileslist&#x27;</span> : files&#125;)  </span><br><span class="line">    resp.status_code = <span class="number">200</span></span><br><span class="line">    <span class="comment"># CORS問題</span></span><br><span class="line">    resp.headers[<span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>] = request.environ[<span class="string">&#x27;HTTP_ORIGIN&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>有CORS的問題，可以暫時解決使用在回傳時加入<code>resp.headers[&#39;Access-Control-Allow-Origin&#39;] = request.environ[&#39;HTTP_ORIGIN&#39;]</code></p>
<h3 id="Client端的設定"><a href="#Client端的設定" class="headerlink" title="Client端的設定"></a>Client端的設定</h3><p>可以參考<a href="https://github.com/ttom921/StudyJavaScript/tree/master/learn-rollup4">learn-rollup4</a>的檔案來當作一個骨架來加入設定</p>
<p>在<code>src\index.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// import &#123; delay &#125; from &quot;rxjs/operators&quot;;</span></span><br><span class="line"><span class="comment">// 可以使用 TypeScript definitions</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Engine</span> &#123;</span><br><span class="line">    <span class="comment">//#region Singleton</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="attr">_instance</span>: <span class="title class_">Engine</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">constructor</span>(<span class="params"></span>) &#123; &#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title function_">getInstance</span>(): <span class="title class_">Engine</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_instance</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_instance</span> = <span class="keyword">new</span> <span class="title class_">Engine</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_instance</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//#endregion Singleton</span></span><br><span class="line">    <span class="keyword">private</span> <span class="attr">_appid</span>: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">init</span>(<span class="params">appid: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="comment">//console.log(&#x27;init&#x27;);</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_appid</span> = appid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">showAppid</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;appid=&#x27;</span> + <span class="variable language_">this</span>.<span class="property">_appid</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取得檔案列表</span></span><br><span class="line">    <span class="title function_">getFilelist</span>(<span class="params">callback: (ent: <span class="built_in">any</span>) =&gt; <span class="built_in">void</span></span>) &#123;</span><br><span class="line">        axios.<span class="title function_">get</span>(<span class="string">&#x27;http://127.0.0.1:5000/files&#x27;</span>)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">data</span>);</span><br><span class="line">                <span class="keyword">if</span> (callback != <span class="literal">null</span>)</span><br><span class="line">                    <span class="title function_">callback</span>(res.<span class="property">data</span>.<span class="property">fileslist</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// Error</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">                <span class="comment">// Error 的詳細資訊</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">response</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Engine</span>;</span><br></pre></td></tr></table></figure>

<p>在<code>dist\index.html</code>要加入使用的程式庫<code>axios</code>和<code>jquery</code>接下來在加入自已編譯好的<code>index.js</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-3.4.1.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/axios/dist/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- This is the bundle generated by rollup.js --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>file list<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Python Flask File(s) Upload - Select file(s) to upload<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dl</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;msg&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;multiFiles&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;upload&quot;</span>&gt;</span>Upload<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> m = monitor.<span class="title function_">getInstance</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//取得檔案列表</span></span></span><br><span class="line"><span class="language-javascript">        m.<span class="title function_">getFilelist</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//console.log(&quot;filelist=&gt;&quot; + res);</span></span></span><br><span class="line"><span class="language-javascript">            res.<span class="title function_">forEach</span>(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&quot;element=&gt;&quot; + element);</span></span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&quot;ul&quot;</span>).<span class="title function_">append</span>(<span class="string">`&lt;li&gt;<span class="subst">$&#123;element&#125;</span> &lt;button onclick=&quot;filedownload(&#x27;<span class="subst">$&#123;element&#125;</span>&#x27;)&quot;&gt;下載&lt;/button&gt;&lt;/li&gt;`</span>)</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">filedownload</span>(<span class="params">params</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(params);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在畫面上會列出在<code>D:\uploads</code>下的所有檔案列表，在點擊下載按鈕，在console的畫面會顯示檔案名稱</p>
<img src="2020-02-06_14_45_32_Image.jpg" style="zoom:80%;" />

<h3 id="上傳檔案"><a href="#上傳檔案" class="headerlink" title="上傳檔案"></a>上傳檔案</h3><p>目前是上傳的檔案會放在<code>D:\uploads</code>下面</p>
<p>在client的html裏要宣告<code>&lt;input type=&quot;file&quot; id=&quot;file&quot; /&gt;</code>在從裏面將要上傳的檔案來取出，可以有兩種取法，一是使用Jquery，一是使用原生的<code>document.getElementById</code>，可以取得屬性</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Python Flask File Upload - Select file to upload<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dl</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;msg&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;upload&quot;</span>&gt;</span>Upload<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> file_dataa = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;file&#x27;</span>).<span class="property">files</span>[<span class="number">0</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(file_dataa);</span><br><span class="line"><span class="keyword">let</span> file_data = $(<span class="string">&#x27;#file&#x27;</span>).<span class="title function_">prop</span>(<span class="string">&#x27;files&#x27;</span>)[<span class="number">0</span>]<span class="comment">//取得上傳檔案屬性</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(file_data);</span><br></pre></td></tr></table></figure>

<p>上傳的<code>dist\index.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> m = monitor.<span class="title function_">getInstance</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//取得檔案列表</span></span></span><br><span class="line"><span class="language-javascript">        m.<span class="title function_">getFilelist</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//console.log(&quot;filelist=&gt;&quot; + res);</span></span></span><br><span class="line"><span class="language-javascript">            res.<span class="title function_">forEach</span>(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&quot;element=&gt;&quot; + element);</span></span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&quot;ul&quot;</span>).<span class="title function_">append</span>(<span class="string">`&lt;li&gt;<span class="subst">$&#123;element&#125;</span> &lt;button onclick=&quot;filedownload(&#x27;<span class="subst">$&#123;element&#125;</span>&#x27;)&quot;&gt;下載&lt;/button&gt;&lt;/li&gt;`</span>)</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">filedownload</span>(<span class="params">params</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(params);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//</span></span></span><br><span class="line"><span class="language-javascript">        $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ready&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#upload&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> form_data = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//let file_dataa = document.getElementById(&#x27;file&#x27;).files[0];</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(file_dataa);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> file_data = $(<span class="string">&#x27;#file&#x27;</span>).<span class="title function_">prop</span>(<span class="string">&#x27;files&#x27;</span>)[<span class="number">0</span>]<span class="comment">//取得上傳檔案屬性</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (file_data == <span class="literal">null</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&#x27;#msg&#x27;</span>).<span class="title function_">html</span>(<span class="string">&#x27;&lt;span style=&quot;color:red&quot;&gt;Select at least one file&lt;/span&gt;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(file_data);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//把物件加到file後面,可在python的request中取到</span></span></span><br><span class="line"><span class="language-javascript">                form_data.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, file_data);</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//m.upload(form_data, onUploadProgress);</span></span></span><br><span class="line"><span class="language-javascript">                m.<span class="title function_">upload</span>(form_data);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">onUploadProgress</span>(<span class="params">params</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(params);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\index.ts</code>的上傳的功能</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// import &#123; delay &#125; from &quot;rxjs/operators&quot;;</span></span><br><span class="line"><span class="comment">// 可以使用 TypeScript definitions</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Engine</span> &#123;</span><br><span class="line">    <span class="comment">//#region Singleton</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    public <span class="keyword">static</span> <span class="title function_">getInstance</span>(): <span class="title class_">Engine</span> &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//#endregion Singleton</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//取得檔案列表</span></span><br><span class="line">    <span class="title function_">getFilelist</span>(<span class="params">callback: (ent: any) =&gt; <span class="keyword">void</span></span>) &#123;</span><br><span class="line">       <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//上傳</span></span><br><span class="line">    <span class="title function_">upload</span>(<span class="params">formdata: any, callback: (ent: any) =&gt; <span class="keyword">void</span></span>) &#123;</span><br><span class="line">        <span class="comment">//console.log(formdata);</span></span><br><span class="line">        axios.<span class="title function_">post</span>(<span class="string">&#x27;http://127.0.0.1:5000/file-upload&#x27;</span>, formdata, &#123;</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;multipart/form-data&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">transformRequest</span>: [<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> data;</span><br><span class="line">            &#125;],</span><br><span class="line">            <span class="attr">onUploadProgress</span>: <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> percentage = <span class="title class_">Math</span>.<span class="title function_">round</span>((e.<span class="property">loaded</span> * <span class="number">100</span>) / e.<span class="property">total</span>) || <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (percentage &lt; <span class="number">100</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(percentage + <span class="string">&#x27;%&#x27;</span>);  <span class="comment">// 上傳進度</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="title function_">callback</span>(percentage);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">data</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Engine</span>;</span><br></pre></td></tr></table></figure>

<h3 id="下載檔案"><a href="#下載檔案" class="headerlink" title="下載檔案"></a>下載檔案</h3><p>在每個檔案的列表的後面加入一個下載的按鈕</p>
<p>在<code>main.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, redirect, jsonify, send_file</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># 下載</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/file-download/&lt;filename&gt;&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">downloadFile</span>(<span class="params">filename</span>):</span><br><span class="line">    path= app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>]+<span class="string">&#x27;/&#x27;</span>+filename</span><br><span class="line">    <span class="comment"># print(path)</span></span><br><span class="line">    resp = jsonify(&#123;<span class="string">&#x27;filename&#x27;</span> : filename&#125;) </span><br><span class="line">    resp.status_code = <span class="number">200</span></span><br><span class="line">    <span class="keyword">return</span> send_file(path, as_attachment=<span class="literal">True</span>)  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>在下載的html<code>dist\index.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>file list<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Python Flask File Upload - Select file to upload<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dl</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;msg&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;upload&quot;</span>&gt;</span>Upload<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> m = monitor.<span class="title function_">getInstance</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//取得檔案列表</span></span></span><br><span class="line"><span class="language-javascript">        m.<span class="title function_">getFilelist</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//...</span></span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">filedownload</span>(<span class="params">params</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(params);</span></span><br><span class="line"><span class="language-javascript">            m.<span class="title function_">download</span>(params);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">onDownloadProgress</span>(<span class="params">params</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(params);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//</span></span></span><br><span class="line"><span class="language-javascript">        $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">           <span class="comment">//...</span></span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//...</span></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\index.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// import &#123; delay &#125; from &quot;rxjs/operators&quot;;</span></span><br><span class="line"><span class="comment">// 可以使用 TypeScript definitions</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Engine</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//下載</span></span><br><span class="line">    <span class="title function_">download</span>(<span class="params">dwfilename: <span class="built_in">any</span>, callback: (ent: <span class="built_in">any</span>) =&gt; <span class="built_in">void</span></span>) &#123;</span><br><span class="line">        axios.<span class="title function_">get</span>(<span class="string">&#x27;http://127.0.0.1:5000/file-download/&#x27;</span> + dwfilename, &#123;</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">responseType</span>: <span class="string">&#x27;arraybuffer&#x27;</span>, <span class="comment">// 伺服器回應的數據類型</span></span><br><span class="line">            <span class="attr">transformRequest</span>: [<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> data;</span><br><span class="line">            &#125;],</span><br><span class="line">            <span class="attr">onDownloadProgress</span>: <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> percentage = <span class="title class_">Math</span>.<span class="title function_">round</span>((e.<span class="property">loaded</span> * <span class="number">100</span>) / e.<span class="property">total</span>) || <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (percentage &lt; <span class="number">100</span>) &#123;</span><br><span class="line">                    <span class="comment">//console.log(percentage + &#x27;%&#x27;);  // 下載連度</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//callback(percentage);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">            <span class="keyword">let</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([res.<span class="property">data</span>]);</span><br><span class="line">            <span class="keyword">let</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">            <span class="keyword">let</span> evt = <span class="variable language_">document</span>.<span class="title function_">createEvent</span>(<span class="string">&quot;HTMLEvents&quot;</span>);</span><br><span class="line">            evt.<span class="title function_">initEvent</span>(<span class="string">&quot;click&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            link.<span class="property">href</span> = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line">            link.<span class="property">download</span> = dwfilename;</span><br><span class="line">            link.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">            <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(link);</span><br><span class="line">            link.<span class="title function_">click</span>();</span><br><span class="line">            <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">revokeObjectURL</span>(link.<span class="property">href</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Engine</span>;</span><br></pre></td></tr></table></figure>





<h2 id="參考資料-1"><a href="#參考資料-1" class="headerlink" title="參考資料"></a>參考資料</h2><p><a href="https://tomoya92.github.io/2018/04/16/axios-upload/">使用axios一次上传多张图片，自带上传进度</a></p>
<p><a href="https://www.jianshu.com/p/8daa3d011cfd">Flask下载文件</a></p>
<p><a href="https://blog.johnsonlu.org/getting-started-with-axios/">Getting Started with Axios</a></p>
<p><a href="https://juejin.im/post/5bc6e25d5188255c5a0d2adf">axios前后端分离下载文件</a></p>
<p><a href="https://blog.csdn.net/bbg221/article/details/79886979">CORS</a></p>
<p><a href="https://www.roytuts.com/python-flask-file-upload-example/">Python Flask File Upload Example</a></p>
]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄Flask-SocketIO的坑</title>
    <url>/%E8%A8%98%E9%8C%84Flask-SocketIO%E7%9A%84%E5%9D%91/%E8%A8%98%E9%8C%84Flask-SocketIO%E7%9A%84%E5%9D%91/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在測試Flask-SocketIO有遇到一些坑，記錄一下以免忘記</p>
<h3 id="連線認證"><a href="#連線認證" class="headerlink" title="連線認證"></a>連線認證</h3><p>在實際的專案的應用時，在連線時會帶入token來進行認證，失敗時要回傳狀態碼給client，讓它知道是什麼問題，在Flask-SocketIO它本身如果在連線事件，有認證失敗時，<code>return False</code>就可以了，在client會收到<code>401</code>的狀態</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">on_connect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> Auth</span><br><span class="line">        	<span class="keyword">return</span> <span class="literal">False</span> <span class="comment">#認證有問題</span></span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        currentSocketId = request.sid</span><br><span class="line">        remotip = request.remote_addr</span><br><span class="line">        fmt = <span class="string">&quot;[myns ns=%s]&lt;connect&gt; remote_addr=%s socket.id=%s&quot;</span> % (</span><br><span class="line">            sckns, remotip, currentSocketId)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(fmt)</span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<p>如果你的Flask-SocketIO不使用WebSocket的話，這是可以收到，不過因為Flask-SocketIO本身不提供WebSocket的功能而是使用第三方的套件，我是安裝<a href="https://pypi.python.org/pypi/gevent-websocket/">gevent-websocket</a> 此套件，所以在初始化如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">&quot;12345&quot;</span></span><br><span class="line">socketio = SocketIO(</span><br><span class="line">    app, binary=<span class="literal">True</span>, http_compression=<span class="literal">False</span>, async_mode=<span class="string">&#x27;gevent&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>所以在連線時有問題，回傳<code>False</code>,client端是不會教到任何的回應的</p>
]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask-SocketIO</category>
      </categories>
      <tags>
        <tag>Flask-SocketIO</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄Flask多資料庫的用法</title>
    <url>/%E8%A8%98%E9%8C%84Flask%E5%A4%9A%E8%B3%87%E6%96%99%E5%BA%AB%E7%9A%84%E7%94%A8%E6%B3%95/%E8%A8%98%E9%8C%84Flask%E5%A4%9A%E8%B3%87%E6%96%99%E5%BA%AB%E7%9A%84%E7%94%A8%E6%B3%95/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前有需求要存取多個獨立的database，但是裏面的資料表是完全一樣的，資料是不一樣的例如有三家公司，可以來存取它的資料庫。</p>
<h2 id="先來建立單一網頁CRUD"><a href="#先來建立單一網頁CRUD" class="headerlink" title="先來建立單一網頁CRUD"></a>先來建立單一網頁CRUD</h2><p>先建立資料夾<code>TestFlaskMultDB</code></p>
<p>一樣在虛擬環境，先安裝flask-sqlalchemy</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install flask</span><br><span class="line">pip install flask-sqlalchemy</span><br></pre></td></tr></table></figure>

<h4 id="建立靜態網頁"><a href="#建立靜態網頁" class="headerlink" title="建立靜態網頁"></a>建立靜態網頁</h4><p>先來建立<code>bookmanager.py</code>我們的檔案結構像是這樣</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB\</span><br><span class="line">    bookmanager.py</span><br></pre></td></tr></table></figure>

<p>在<code>bookmanager.py</code>中加入</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;My Flask app&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>這時在vscode按下debug時，可以在<a href="http://127.0.0.1:3000/">http://127.0.0.1:3000/</a> 的網頁中看到<code>My Flask app</code></p>
<img src="2019-08-15_11_50_27_Image.png" style="zoom:80%;" />

<h4 id="可以處理使用者的輸入"><a href="#可以處理使用者的輸入" class="headerlink" title="可以處理使用者的輸入"></a>可以處理使用者的輸入</h4><p>如果是上面的網頁的話，使用者不能作任何的互動，所以Flask提供了一個叫<code>templates</code>的資料夾，將可以顯示在網頁上的<code>html</code>檔放在此，flask 有使用<a href="http://jinja.pocoo.org/">Jinja template engine</a> 來處理template網頁的問題</p>
<h5 id="建立一個輸入的form"><a href="#建立一個輸入的form" class="headerlink" title="建立一個輸入的form"></a>建立一個輸入的form</h5><p>我們在下面在建立一個資料夾叫<code>templates</code>在下面在建立<code>home.html</code>,所以專案結構看起來會是像</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB\</span><br><span class="line">    bookmanager.py</span><br><span class="line">    templates/</span><br><span class="line">        home.html</span><br></pre></td></tr></table></figure>

<p>在<code>home.html</code>中加入</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;增加&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>bookmanager.py</code>中要加入模組才可使用和修改<code>home()</code>回傳<code>html</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="comment"># return &quot;My Flask app&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在度瀏覽<a href="http://127.0.0.1:3000/%E6%9C%83%E7%99%BC%E7%8F%BE%E7%B6%B2%E9%A0%81%E5%A6%82%E4%B8%8B">http://127.0.0.1:3000/會發現網頁如下</a></p>
<img src="2019-08-15_12_12_04_Image.png" style="zoom:80%;" />

<h4 id="處理拿到使用者輸入的資料"><a href="#處理拿到使用者輸入的資料" class="headerlink" title="處理拿到使用者輸入的資料"></a>處理拿到使用者輸入的資料</h4><p>要加入下面的模組</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from flask import request</span><br></pre></td></tr></table></figure>

<p>又網頁有GET和POST的請求，所以要加入到home</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        <span class="built_in">print</span>(request.form)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>在網頁上，輸入資料可以在終端機上看到資訊</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;-m&#x27;</span> <span class="string">&#x27;flask&#x27;</span> <span class="string">&#x27;run&#x27;</span> <span class="string">&#x27;--port=3000&#x27;</span> <span class="string">&#x27;--no-debugger&#x27;</span> <span class="string">&#x27;--no-reload&#x27;</span></span><br><span class="line"> * Serving Flask app <span class="string">&quot;bookmanager.py&quot;</span></span><br><span class="line"> * Environment: production</span><br><span class="line">   WARNING: This is a development server. Do not use it <span class="keyword">in</span> a production deployment.</span><br><span class="line">   Use a production WSGI server instead.</span><br><span class="line"> * Debug mode: off</span><br><span class="line"> * Running on http://127.0.0.1:3000/ (Press CTRL+C to quit)</span><br><span class="line">ImmutableMultiDict([(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;Peter Pen&#x27;</span>)])</span><br><span class="line">127.0.0.1 - - [15/Aug/2019 12:26:44] <span class="string">&quot;POST / HTTP/1.1&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<p>有看到<code>ImmutableMultiDict([(&#39;title&#39;, &#39;Peter Pen&#39;)])</code>可以看到資料是你輸入的資料，有<code>title</code>是因為在<code>home.html</code>裏有<code>&lt;input type=&quot;text&quot; name=&quot;title&quot;&gt;</code></p>
<h4 id="加入資料到資料庫"><a href="#加入資料到資料庫" class="headerlink" title="加入資料到資料庫"></a>加入資料到資料庫</h4><p>先在<code>HeidiSQL</code>的工具加入資料庫<code>bookdatabase</code>,接下來設定資料庫</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/bookdatabase&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        <span class="built_in">print</span>(request.form)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, debug=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/bookdatabase&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(app)</span><br></pre></td></tr></table></figure>

<h4 id="加入ORM模型"><a href="#加入ORM模型" class="headerlink" title="加入ORM模型"></a>加入ORM模型</h4><p> 加入class和建立資料到資料庫</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(db.Model):</span><br><span class="line">    title = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>,</span><br><span class="line">                      nullable=<span class="literal">False</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;Title:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.title)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        book = Book(title=request.form.get(<span class="string">&quot;title&quot;</span>))</span><br><span class="line">        db.session.add(book)</span><br><span class="line">        db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>因為資料庫沒有此物件的資料表，因此先來建立資料表，在python的終端模式下下列的指令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; from bookmanager import db</span><br><span class="line">&gt;&gt;&gt; db.create_all()</span><br><span class="line">&gt;&gt;&gt; exit()</span><br></pre></td></tr></table></figure>

<h4 id="讀取資料庫的資料"><a href="#讀取資料庫的資料" class="headerlink" title="讀取資料庫的資料"></a>讀取資料庫的資料</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">books = Book.query.<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>, books=books)</span><br></pre></td></tr></table></figure>

<p>為了顯示book的資訊，所以要修改<code>home.html</code>加入下列的碼</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;% for book in books %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;book.title&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./update&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;oldtitle&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;newtitle&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Update&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>因為有跳轉的問題，所以加入下列的模組</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from flask import redirect</span><br></pre></td></tr></table></figure>

<p>最後的<code>bookmanager.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/bookdatabase&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(db.Model):</span><br><span class="line">    title = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>,</span><br><span class="line">                      nullable=<span class="literal">False</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;Title:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.title)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    books = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            book = Book(title=request.form.get(<span class="string">&quot;title&quot;</span>))</span><br><span class="line">            db.session.add(book)</span><br><span class="line">            db.session.commit()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Failed to add book&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">    books = Book.query.<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>, books=books)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>和<code>home.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>加入一本書<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;增加&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>書本列表<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    &#123;% for book in books %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;book.title&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./update&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;oldtitle&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;newtitle&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Update&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Update更新資料"><a href="#Update更新資料" class="headerlink" title="Update更新資料"></a>Update更新資料</h4><p>加入更新的資料程式碼</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/update&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        newtitle = request.form.get(<span class="string">&quot;newtitle&quot;</span>)</span><br><span class="line">        oldtitle = request.form.get(<span class="string">&quot;oldtitle&quot;</span>)</span><br><span class="line">        book = Book.query.filter_by(title=oldtitle).first()</span><br><span class="line">        book.title = newtitle</span><br><span class="line">        db.session.commit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to update book&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="Delete刪除資料"><a href="#Delete刪除資料" class="headerlink" title="Delete刪除資料"></a>Delete刪除資料</h4><p>在<code>home.html</code> 加入刪除的按鈕</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./delete&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;刪除&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>加入刪除的程式碼</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/delete&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        title = request.form.get(<span class="string">&quot;title&quot;</span>)</span><br><span class="line">        book = Book.query.filter_by(title=title).first()</span><br><span class="line">        db.session.delete(book)</span><br><span class="line">        db.session.commit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to delete book&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="最後的碼和html"><a href="#最後的碼和html" class="headerlink" title="最後的碼和html"></a>最後的碼和html</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/bookdatabase&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(db.Model):</span><br><span class="line">    title = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>,</span><br><span class="line">                      nullable=<span class="literal">False</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;Title:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.title)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    books = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            book = Book(title=request.form.get(<span class="string">&quot;title&quot;</span>))</span><br><span class="line">            db.session.add(book)</span><br><span class="line">            db.session.commit()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Failed to add book&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">    books = Book.query.<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>, books=books)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/update&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        newtitle = request.form.get(<span class="string">&quot;newtitle&quot;</span>)</span><br><span class="line">        oldtitle = request.form.get(<span class="string">&quot;oldtitle&quot;</span>)</span><br><span class="line">        book = Book.query.filter_by(title=oldtitle).first()</span><br><span class="line">        book.title = newtitle</span><br><span class="line">        db.session.commit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to update book&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/delete&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        title = request.form.get(<span class="string">&quot;title&quot;</span>)</span><br><span class="line">        book = Book.query.filter_by(title=title).first()</span><br><span class="line">        db.session.delete(book)</span><br><span class="line">        db.session.commit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to delete book&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>html</code>檔</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>加入一本書<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;增加&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>書本列表<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    &#123;% for book in books %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;book.title&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./update&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;oldtitle&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;newtitle&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Update&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./delete&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;刪除&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="建立使用多資料庫的方式來建立-有兩種"><a href="#建立使用多資料庫的方式來建立-有兩種" class="headerlink" title="建立使用多資料庫的方式來建立(有兩種)"></a>建立使用多資料庫的方式來建立(有兩種)</h3><p>在ORM的模型上有兩種方法<code>declarative_base</code>和<code>db.Model</code>專案是使用<code>db.Model</code></p>
<h4 id="declarative-base方法-不使用"><a href="#declarative-base方法-不使用" class="headerlink" title="declarative_base方法(不使用)"></a>declarative_base方法(不使用)</h4><p>以HeidiSQL在mariadb來建立多個資料庫分別是<code>dbhisharp</code>、<code>dbasa</code>、<code>dbups</code>，建立好之後來設定先建立<code>run.py</code></p>
<p>所以專案結構看起來會是像</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB\</span><br><span class="line">    run.py</span><br></pre></td></tr></table></figure>

<p>在run.py中加入相關的設定</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line">SQLALCHEMY_BINDS = &#123;</span><br><span class="line">    <span class="string">&#x27;users&#x27;</span>:        <span class="string">&#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;appmeta&#x27;</span>:      <span class="string">&#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;OK&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="建立資料表"><a href="#建立資料表" class="headerlink" title="建立資料表"></a>建立資料表</h5><p>因要連線不同的資料庫，所以要有一個機制來管理依不同的名稱來提供不同的連線，所以現在的專案結構是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB\</span><br><span class="line">	database\</span><br><span class="line">	    __init__.py</span><br><span class="line">	    dbprovide.py</span><br><span class="line">	    </span><br><span class="line">    run.py</span><br></pre></td></tr></table></figure>

<p>在<code>dbprovide.py</code>的內容如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 依名稱來提供不同的資料庫的連線目前有預設，asa，ups</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DbProvide</span>():</span><br><span class="line">    db = <span class="literal">None</span></span><br><span class="line">    connection = <span class="literal">None</span></span><br><span class="line">    session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, center=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> center == <span class="literal">None</span>:</span><br><span class="line">            self.db = create_engine(</span><br><span class="line">                <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span>, echo=<span class="literal">True</span>, pool_threadlocal=<span class="literal">True</span>)</span><br><span class="line">            self.connection = self.db.connect()</span><br><span class="line">        <span class="keyword">if</span> center == <span class="string">&quot;asa&quot;</span>:</span><br><span class="line">            self.db = create_engine(</span><br><span class="line">                <span class="string">&#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;</span>, echo=<span class="literal">True</span>, pool_threadlocal=<span class="literal">True</span>)</span><br><span class="line">            self.connection = self.db.connect()</span><br><span class="line">        <span class="keyword">if</span> center == <span class="string">&quot;ups&quot;</span>:</span><br><span class="line">            self.db = create_engine(</span><br><span class="line">                <span class="string">&#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span>, echo=<span class="literal">True</span>, pool_threadlocal=<span class="literal">True</span>)</span><br><span class="line">            self.connection = self.db.connect()</span><br><span class="line">        Session = sessionmaker(bind=self.db)</span><br><span class="line">        self.session = Session()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也要提供ORM的模型,所以現在的專案結構是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB\</span><br><span class="line">	database\</span><br><span class="line">	    __init__.py</span><br><span class="line">	    dbprovide.py</span><br><span class="line">	    models.py</span><br><span class="line">    run.py</span><br></pre></td></tr></table></figure>

<p>在<code>models.py</code>中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> ForeignKey</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> relationship, backref</span><br><span class="line"><span class="keyword">from</span> dbprovide <span class="keyword">import</span> DbProvide</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br><span class="line">    username = Column(String(<span class="number">80</span>))</span><br><span class="line">    password = Column(String(<span class="number">80</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, username, password</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = hashlib.sha1(password).hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User(&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;)&quot;</span>.<span class="built_in">format</span>(self.name, self.username, self.password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># &#x27;&#x27;&#x27; 此時只有建立 SQLAlchemy Engine 實例，還沒在記憶體內建立資料，</span></span><br><span class="line">    <span class="comment">#     只有第一個 SQL 指令被下達時，才會真正連接到資料庫內執行 &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># engine = create_engine(&#x27;sqlite:///:memory:&#x27;, echo=True)</span></span><br><span class="line">    <span class="comment"># &#x27;&#x27;&#x27; 真正建立表格是使用 Base.metadata.create_all(engine) &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># Base.metadata.create_all(engine)</span></span><br><span class="line">    <span class="comment"># auser = User(&#x27;user1&#x27;, &#x27;username&#x27;, &#x27;password&#x27;.encode(&#x27;utf-8&#x27;))</span></span><br><span class="line">    <span class="comment"># print(&#x27;Mapper:&#x27;, auser.__mapper__)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 建立和測試資料表測試dbhisharp</span></span><br><span class="line"></span><br><span class="line">    dbprv = DbProvide()</span><br><span class="line">    Base.metadata.create_all(dbprv.db)</span><br><span class="line">    user_1 = User(<span class="string">&#x27;user1&#x27;</span>, <span class="string">&#x27;username1&#x27;</span>, <span class="string">&#x27;password_1&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    session = dbprv.session</span><br><span class="line">    session.add(user_1)</span><br><span class="line">    row = session.query(User).filter_by(name=<span class="string">&#x27;user1&#x27;</span>).first()</span><br><span class="line">    <span class="keyword">if</span> row:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Found user1&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Can not find user1&#x27;</span>)</span><br><span class="line">    session.rollback()  <span class="comment"># 資料庫回到新增 user1 之前的狀態</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;測試dbhisharp完成-------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 建立和測試資料表測試dbasa</span></span><br><span class="line"></span><br><span class="line">    dbprv = DbProvide(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">    Base.metadata.create_all(dbprv.db)</span><br><span class="line">    user_1 = User(<span class="string">&#x27;user1&#x27;</span>, <span class="string">&#x27;username1&#x27;</span>, <span class="string">&#x27;password_1&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    session = dbprv.session</span><br><span class="line">    session.add(user_1)</span><br><span class="line">    row = session.query(User).filter_by(name=<span class="string">&#x27;user1&#x27;</span>).first()</span><br><span class="line">    <span class="keyword">if</span> row:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Found user1&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Can not find user1&#x27;</span>)</span><br><span class="line">    session.rollback()  <span class="comment"># 資料庫回到新增 user1 之前的狀態</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;測試dbasa完成-------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 建立和測試資料表測試dbasa</span></span><br><span class="line"></span><br><span class="line">    dbprv = DbProvide(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">    Base.metadata.create_all(dbprv.db)</span><br><span class="line">    user_1 = User(<span class="string">&#x27;user1&#x27;</span>, <span class="string">&#x27;username1&#x27;</span>, <span class="string">&#x27;password_1&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    session = dbprv.session</span><br><span class="line">    session.add(user_1)</span><br><span class="line">    row = session.query(User).filter_by(name=<span class="string">&#x27;user1&#x27;</span>).first()</span><br><span class="line">    <span class="keyword">if</span> row:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Found user1&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Can not find user1&#x27;</span>)</span><br><span class="line">    session.rollback()  <span class="comment"># 資料庫回到新增 user1 之前的狀態</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;測試dbups完成-------------&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="db-Model的方法"><a href="#db-Model的方法" class="headerlink" title="db.Model的方法"></a>db.Model的方法</h4><p>先在一個資料庫上建立資料表，再將此資料表的結構，移到剩下的兩個資料庫</p>
<h5 id="建立資料表-1"><a href="#建立資料表-1" class="headerlink" title="建立資料表"></a>建立資料表</h5><p>在專案的結構如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">database</span><br><span class="line">	models.py</span><br><span class="line">db_create.py	</span><br></pre></td></tr></table></figure>

<p>在<code>database\models.py</code>以下是放ORM的物件如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">64</span>))</span><br><span class="line">    username = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line">    password = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, username, password</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = hashlib.sha1(password).hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User(&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;)&quot;</span>.<span class="built_in">format</span>(self.name, self.username, self.password)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>db_create.py</code>中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 建立基本資料表，通常沒有資料表的時候才會建立</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> db, User</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line"><span class="comment"># SQLALCHEMY_BINDS = &#123;</span></span><br><span class="line"><span class="comment">#     &#x27;asa&#x27;:        &#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;,</span></span><br><span class="line"><span class="comment">#     &#x27;ups&#x27;:      &#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">db.init_app(app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> app.app_context():</span><br><span class="line">            db.create_all()</span><br><span class="line"></span><br><span class="line">            user_1 = User(<span class="string">&#x27;user1&#x27;</span>, <span class="string">&#x27;username1&#x27;</span>, <span class="string">&#x27;password_1&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">            session = db.session</span><br><span class="line">            session.add(user_1)</span><br><span class="line">            row = session.query(User).filter_by(name=<span class="string">&#x27;user1&#x27;</span>).first()</span><br><span class="line">            <span class="keyword">if</span> row:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Found user1&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(row)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Can not find user1&#x27;</span>)</span><br><span class="line">            session.rollback()  <span class="comment"># 資料庫回到新增 user1 之前的狀態</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;User資料表建立完成&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>執行<code>db_create.py</code>後在dbhisharp的資料庫上會建立資料表，在將它的scheme匯出，在匯入到其它兩個的資料庫先到</p>
<p><code>D:\Project\mariadb\mariadb1\bin</code>來執行匯出資料庫結構-R 是有其它的表(如sp)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysqldump -u root -p -d -R dbhisharp &gt; userschema.sql</span><br></pre></td></tr></table></figure>

<p>在以HeidiSQL來載入此sql<code>userschema.sql</code>檔來建立資料表</p>
<h2 id="建立測試三個資料庫的資料-靜態"><a href="#建立測試三個資料庫的資料-靜態" class="headerlink" title="建立測試三個資料庫的資料-靜態"></a>建立測試三個資料庫的資料-靜態</h2><p>這個方法是資料庫在Flask-SQLAlchemy裏已經建立好了連接來處理</p>
<p>在原來的<code>models.py</code>有修改，<strong>主要是加入了<code>__bind_key__</code>為了是使用那一個資料庫</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">64</span>))</span><br><span class="line">    username = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line">    password = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, username, password, bind=<span class="literal">None</span></span>):</span><br><span class="line">        self.__bind_key__ = bind</span><br><span class="line">        self.name = name</span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = hashlib.sha1(password).hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User(&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;)&quot;</span>.<span class="built_in">format</span>(self.name, self.username, self.password)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>先來測試CRUD裏的C,來各別的建立各別的資料來加入三個資料庫，可以來測試之後剩下的動作。在在專案的結構下加入<code>Testdbdata.py</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">database</span><br><span class="line">	models.py</span><br><span class="line">db_create.py</span><br><span class="line">Testdbdata.py</span><br></pre></td></tr></table></figure>

<p>在<code>Testdbdata.py</code>裏加入程式碼</p>
<p>加入資料</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 增加</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestAddDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = MultiDBMgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        username = dbkey+<span class="string">&quot;username&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        password = <span class="string">&quot;password_&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        myuser = User(name, username, password.encode(<span class="string">&#x27;utf-8&#x27;</span>), bindkey)</span><br><span class="line">        <span class="built_in">print</span>(myuser)</span><br><span class="line">        session.add(myuser)</span><br><span class="line">        session.commit()</span><br></pre></td></tr></table></figure>

<p>刪除資料</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 刪除</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestDelDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = MultiDBMgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            session.delete(row)</span><br><span class="line">    session.commit()</span><br></pre></td></tr></table></figure>

<p>查詢資料</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查詢</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestFindDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = MultiDBMgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            <span class="built_in">print</span>(row)</span><br></pre></td></tr></table></figure>

<p>修改資料</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestModDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = MultiDBMgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            row.username += <span class="string">&quot;mod&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(row)</span><br><span class="line">    session.commit()</span><br></pre></td></tr></table></figure>

<p>最後完整的<code>Testdbdata.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 來建立測試用的資料</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> db, User</span><br><span class="line"><span class="keyword">from</span> multidbmanager <span class="keyword">import</span> MultiDBMgr</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line"><span class="comment"># SQLALCHEMY_DATABASE_URI = &#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line"><span class="comment"># SQLALCHEMY_BINDS = &#123;</span></span><br><span class="line"><span class="comment">#     &#x27;asa&#x27;:        &#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;,</span></span><br><span class="line"><span class="comment">#     &#x27;ups&#x27;:      &#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line">app.config[<span class="string">&quot;SQLALCHEMY_BINDS&quot;</span>] = &#123;</span><br><span class="line">    <span class="string">&#x27;asa&#x27;</span>: <span class="string">&#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ups&#x27;</span>: <span class="string">&#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">db.init_app(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestAddDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = MultiDBMgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        username = dbkey+<span class="string">&quot;username&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        password = <span class="string">&quot;password_&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        myuser = User(name, username, password.encode(<span class="string">&#x27;utf-8&#x27;</span>), bindkey)</span><br><span class="line">        <span class="built_in">print</span>(myuser)</span><br><span class="line">        session.add(myuser)</span><br><span class="line">        session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 刪除</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestDelDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = MultiDBMgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            session.delete(row)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查詢</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestFindDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = MultiDBMgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestModDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = MultiDBMgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            row.username += <span class="string">&quot;mod&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(row)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># TestAddDBdata(&quot;asa&quot;)</span></span><br><span class="line">        <span class="keyword">with</span> app.app_context():</span><br><span class="line">            <span class="comment"># 增</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;增加資料----------------&quot;</span>)</span><br><span class="line">            TestAddDBdata()</span><br><span class="line">            TestAddDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestAddDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># 修改</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;修改資料----------------&quot;</span>)</span><br><span class="line">            TestModDBdata()</span><br><span class="line">            TestModDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestModDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># 查</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;查詢資料----------------&quot;</span>)</span><br><span class="line">            TestFindDBdata()</span><br><span class="line">            TestFindDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestFindDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># 刪</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;刪除資料----------------&quot;</span>)</span><br><span class="line">            TestDelDBdata()</span><br><span class="line">            TestDelDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestDelDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;資料表增刪查改完成&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h4 id="先來建立單一資料庫的網頁"><a href="#先來建立單一資料庫的網頁" class="headerlink" title="先來建立單一資料庫的網頁"></a>先來建立單一資料庫的網頁</h4><p>在目前的專案結構加入<code>run.py</code>如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">database\</span><br><span class="line">    __init__.py</span><br><span class="line">	models.py</span><br><span class="line">multidbmanager.py</span><br><span class="line">run.py</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<p>在<code>run.py</code>中加入以下的碼,執行後可以以網頁來瀏覽可以看到顯示<code>single db OK</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> db, User</span><br><span class="line"><span class="keyword">from</span> multidbmanager <span class="keyword">import</span> MultiDBMgr</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line">app.config[<span class="string">&quot;SQLALCHEMY_BINDS&quot;</span>] = &#123;</span><br><span class="line">    <span class="string">&#x27;asa&#x27;</span>: <span class="string">&#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ups&#x27;</span>: <span class="string">&#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">db.init_app(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;single db OK&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="建立靜態網頁-1"><a href="#建立靜態網頁-1" class="headerlink" title="建立靜態網頁"></a>建立靜態網頁</h4><p>我們在下面在建立一個資料夾叫<code>templates</code>在下面在建立<code>home.html</code>,所以專案結構看起來會是像</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">templates\</span><br><span class="line">    home.html</span><br><span class="line">database\</span><br><span class="line">    __init__.py</span><br><span class="line">	models.py</span><br><span class="line">multidbmanager.py</span><br><span class="line">run.py</span><br></pre></td></tr></table></figure>

<p>在<code>home.html</code>中加入</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>預設的資料庫 <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dbkey&quot;</span>&gt;</span></span><br><span class="line">        Name:<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        UserName:<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        Password:<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;增加&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>run.py</code>中要加</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="處理拿到使用者輸入的資料-1"><a href="#處理拿到使用者輸入的資料-1" class="headerlink" title="處理拿到使用者輸入的資料"></a>處理拿到使用者輸入的資料</h4><p>要加入下面的模組</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from flask import request</span><br></pre></td></tr></table></figure>

<p>又網頁有GET和POST的請求，所以要加入到home</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        <span class="built_in">print</span>(request.form)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>在網頁上，輸入資料可以在終端機上看到資訊，<strong>注意dbkey是代表使用那一個資料庫</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> * Serving Flask app <span class="string">&quot;run.py&quot;</span></span><br><span class="line"> * Environment: production</span><br><span class="line">   WARNING: This is a development server. Do not use it <span class="keyword">in</span> a production deployment.</span><br><span class="line">   Use a production WSGI server instead.</span><br><span class="line"> * Debug mode: off</span><br><span class="line"> * Running on http://127.0.0.1:3000/ (Press CTRL+C to quit)</span><br><span class="line">ImmutableMultiDict([(<span class="string">&#x27;dbkey&#x27;</span>, <span class="string">&#x27;&#x27;</span>), (<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;111&#x27;</span>), (<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;222&#x27;</span>), (<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;333&#x27;</span>)])</span><br><span class="line">127.0.0.1 - - [20/Aug/2019 15:17:47] <span class="string">&quot;POST / HTTP/1.1&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<h4 id="Create資料"><a href="#Create資料" class="headerlink" title="Create資料"></a>Create資料</h4><p>在<code>run.py</code>加入以下的碼</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        <span class="comment"># 取得使用那一個資料庫</span></span><br><span class="line">        bindkey = request.form.get(<span class="string">&quot;dbkey&quot;</span>)</span><br><span class="line">        session = MultiDBMgr.getSession(bindkey)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            name = request.form.get(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">            username = request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">            password = request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">            <span class="comment"># 檢查是否有重覆的資料</span></span><br><span class="line">            row = session.query(User).filter_by(name=name).first()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> row:</span><br><span class="line">                myuser = User(name, username, password.encode(<span class="string">&#x27;utf-8&#x27;</span>), bindkey)</span><br><span class="line">                <span class="built_in">print</span>(myuser)</span><br><span class="line">                session.add(myuser)</span><br><span class="line">                session.commit()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;加入資料失敗&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>因為要那一個資料庫的資料<code>run.py</code>所以修改如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        <span class="comment"># 取得使用那一個資料庫</span></span><br><span class="line">        bindkey = request.form.get(<span class="string">&quot;dbkey&quot;</span>)</span><br><span class="line">        session = MultiDBMgr.getSession(bindkey)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            name = request.form.get(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">            username = request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">            password = request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">            <span class="comment"># 檢查是否有重覆的資料</span></span><br><span class="line">            row = session.query(User).filter_by(name=name).first()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> row:</span><br><span class="line">                myuser = User(name, username, password.encode(<span class="string">&#x27;utf-8&#x27;</span>), bindkey)</span><br><span class="line">                <span class="built_in">print</span>(myuser)</span><br><span class="line">                session.add(myuser)</span><br><span class="line">                session.commit()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;加入資料失敗&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="comment"># 取得各個列表</span></span><br><span class="line">    <span class="comment"># 預設列表</span></span><br><span class="line">    users = <span class="literal">None</span></span><br><span class="line">    session = MultiDBMgr.getSession()</span><br><span class="line">    users = session.query(User).<span class="built_in">all</span>()</span><br><span class="line">    <span class="comment"># asa列表</span></span><br><span class="line">    asausers = <span class="literal">None</span></span><br><span class="line">    session = MultiDBMgr.getSession(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">    asausers = session.query(User).<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>, users=users, asausers=asausers)</span><br></pre></td></tr></table></figure>

<p>在<code>home.html</code>修改如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>預設的資料庫 <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dbkey&quot;</span>&gt;</span></span><br><span class="line">        Name:<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        UserName:<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        Password:<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;增加&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>資料列表<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    &#123;% for user in users %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Name:&#123;&#123;user.name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./update&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dbkey&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;user.id&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">        UserName:</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;user.username&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;newusername&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Update&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./delete&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dbkey&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;user.id&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;刪除&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>dbasa的資料庫 <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;asa&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dbkey&quot;</span>&gt;</span></span><br><span class="line">        Name:<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        UserName:<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        Password:<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;增加&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>資料列表<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    &#123;% for user in asausers %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Name:&#123;&#123;user.name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./update&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;asa&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dbkey&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;user.id&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">            UserName:</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;user.username&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;newusername&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Update&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./delete&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;asa&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dbkey&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;user.id&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;刪除&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Update更新資料-1"><a href="#Update更新資料-1" class="headerlink" title="Update更新資料"></a>Update更新資料</h4><p>在<code>run.py</code>將加入更新的程式碼如下，這裏有要注意的地方是，在form會傳入使用那一個資料庫<code>dbkey</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/update&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 取得使用那一個資料庫</span></span><br><span class="line">        bindkey = request.form.get(<span class="string">&quot;dbkey&quot;</span>)</span><br><span class="line">        session = MultiDBMgr.getSession(bindkey)</span><br><span class="line">        <span class="built_in">id</span> = request.form.get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">        newusername = request.form.get(<span class="string">&quot;newusername&quot;</span>)</span><br><span class="line">        row = session.query(User).filter_by(<span class="built_in">id</span>=<span class="built_in">id</span>).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            row.username = newusername</span><br><span class="line">            session.commit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;更新資料失敗&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="以下的方法是codereview的做法"><a href="#以下的方法是codereview的做法" class="headerlink" title="以下的方法是codereview的做法"></a>以下的方法是codereview的做法</h3><p>目前因專案是以db.Model來作為ORM的主體，所以是以db.Model為主,先來建立資料夾<code>TestFlaskMultDB2</code></p>
<h3 id="先來建立資料表"><a href="#先來建立資料表" class="headerlink" title="先來建立資料表"></a>先來建立資料表</h3><p>先在專案結構的目錄下，來建立<code>database</code>的資料夾，下面來建立<code>__init__.py,models.py,multidbmanager.py</code>,再來建立<code>db_create.py</code>,此檔案的目的是為了建立資料庫的資料表，目前的結構如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB2\</span><br><span class="line">	database\</span><br><span class="line">		__init__.py</span><br><span class="line">		models.py</span><br><span class="line">		multidbmanager.py</span><br><span class="line">	db_create.py</span><br></pre></td></tr></table></figure>

<p>在<code>models.py</code>主要是ORM模型，<code>multidbmanager.py</code>主要是來管理多個資料庫的切換，在<code>db_create.py</code>主要是建立資料庫中的資料表</p>
<p>在<code>multidbmanage.py</code>的程式碼如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> current_app</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DBManager</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.app = current_app</span><br><span class="line">        self.db = db</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_bind</span>(<span class="params">self, dbname=<span class="literal">None</span></span>):</span><br><span class="line">        bindstat = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> dbname <span class="keyword">in</span> current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>]:</span><br><span class="line">            bindstat = dbname</span><br><span class="line">        <span class="keyword">return</span> bindstat</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getSession</span>(<span class="params">self, dbname=<span class="literal">None</span></span>):</span><br><span class="line">            <span class="comment"># print(db.get_engine(self.app))</span></span><br><span class="line">            <span class="comment"># print(db.get_engine(self.app, &#x27;asa&#x27;))</span></span><br><span class="line">            <span class="comment"># print(db.get_engine(self.app, &#x27;ups&#x27;))</span></span><br><span class="line">        engine = <span class="literal">None</span></span><br><span class="line">        bindstate = self.check_bind(dbname)</span><br><span class="line">        <span class="keyword">if</span>(bindstate == <span class="literal">None</span>):</span><br><span class="line">            engine = db.get_engine(self.app)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            engine = db.get_engine(self.app, dbname)</span><br><span class="line">        db.session.bind = engine</span><br><span class="line">        session_maker = db.sessionmaker()</span><br><span class="line">        session_maker.configure(bind=engine)</span><br><span class="line">        session = session_maker()</span><br><span class="line">        <span class="keyword">return</span> session</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dbmgr = DBManager()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>models.py</code>的程式碼如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> .multidbmanager <span class="keyword">import</span> db, dbmgr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">64</span>))</span><br><span class="line">    username = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line">    password = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, username, password, bind=<span class="literal">None</span></span>):</span><br><span class="line">        self.__bind_key__ = bind</span><br><span class="line">        self.name = name</span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = hashlib.sha1(password).hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User(&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;)&quot;</span>.<span class="built_in">format</span>(self.name, self.username, self.password)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getAll</span>(<span class="params">dbname=<span class="literal">None</span></span>):</span><br><span class="line">        session = dbmgr.getSession(dbname)</span><br><span class="line">        <span class="keyword">return</span> session.query(User).<span class="built_in">all</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>db_create.py</code>的程式碼如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 建立基本資料表，通常沒有資料表的時候才會建立</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> database.multidbmanager <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line"><span class="comment"># app.config[&quot;SQLALCHEMY_BINDS&quot;] = &#123;</span></span><br><span class="line"><span class="comment">#     &#x27;asa&#x27;: &#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;,</span></span><br><span class="line"><span class="comment">#     &#x27;ups&#x27;: &#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">db.init_app(app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> app.app_context():</span><br><span class="line">            db.create_all()</span><br><span class="line"></span><br><span class="line">            user_1 = User(<span class="string">&#x27;user1&#x27;</span>, <span class="string">&#x27;username1&#x27;</span>, <span class="string">&#x27;password_1&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">            session = db.session</span><br><span class="line">            session.add(user_1)</span><br><span class="line">            row = session.query(User).filter_by(name=<span class="string">&#x27;user1&#x27;</span>).first()</span><br><span class="line">            <span class="keyword">if</span> row:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Found user1&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(row)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Can not find user1&#x27;</span>)</span><br><span class="line">            session.rollback()  <span class="comment"># 資料庫回到新增 user1 之前的狀態</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;User資料表建立完成&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>執行<code>db_create.py</code>後在dbhisharp的資料庫上會建立資料表，在將它的scheme匯出，在匯入到其它兩個的資料庫先到</p>
<p><code>D:\Project\mariadb\mariadb1\bin</code>來執行匯出資料庫結構-R 是有其它的表(如sp)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysqldump -u root -p -d -R dbhisharp &gt; userschema.sql</span><br></pre></td></tr></table></figure>

<p>在以HeidiSQL來載入此sql<code>userschema.sql</code>檔來建立資料表</p>
<h3 id="來測試單元測試三個資料庫的CRUD的功能"><a href="#來測試單元測試三個資料庫的CRUD的功能" class="headerlink" title="來測試單元測試三個資料庫的CRUD的功能"></a>來測試單元測試三個資料庫的CRUD的功能</h3><p>再來建立<code>Testdbdata.py</code>,此檔案的目的是為了單元測試資料庫的資料表，目前的結構如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB2\</span><br><span class="line">	database\</span><br><span class="line">		__init__.py</span><br><span class="line">		models.py</span><br><span class="line">		multidbmanager.py</span><br><span class="line">	db_create.py</span><br><span class="line">	Testdbdata.py</span><br></pre></td></tr></table></figure>

<p>在<code>Testdbdata.py</code>中的程式碼如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 來建立測試用的資料</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> database.multidbmanager <span class="keyword">import</span> db, dbmgr</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line">app.config[<span class="string">&quot;SQLALCHEMY_BINDS&quot;</span>] = &#123;</span><br><span class="line">    <span class="string">&#x27;asa&#x27;</span>: <span class="string">&#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ups&#x27;</span>: <span class="string">&#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">db.init_app(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestAddDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        username = dbkey+<span class="string">&quot;username&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        password = <span class="string">&quot;password_&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        myuser = User(name, username, password.encode(<span class="string">&#x27;utf-8&#x27;</span>), bindkey)</span><br><span class="line">        <span class="built_in">print</span>(myuser)</span><br><span class="line">        session.add(myuser)</span><br><span class="line">        session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 刪除</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestDelDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            session.delete(row)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查詢</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestFindDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestModDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            row.username += <span class="string">&quot;mod&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(row)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># TestAddDBdata(&quot;asa&quot;)</span></span><br><span class="line">        <span class="keyword">with</span> app.app_context():</span><br><span class="line">            <span class="comment"># 增</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;增加資料----------------&quot;</span>)</span><br><span class="line">            TestAddDBdata()</span><br><span class="line">            TestAddDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestAddDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># 修改</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;修改資料----------------&quot;</span>)</span><br><span class="line">            TestModDBdata()</span><br><span class="line">            TestModDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestModDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># 查</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;查詢資料----------------&quot;</span>)</span><br><span class="line">            TestFindDBdata()</span><br><span class="line">            TestFindDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestFindDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># 刪</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;刪除資料----------------&quot;</span>)</span><br><span class="line">            TestDelDBdata()</span><br><span class="line">            TestDelDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestDelDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;資料表增刪查改完成&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="建立網頁來測試存取多個資料庫"><a href="#建立網頁來測試存取多個資料庫" class="headerlink" title="建立網頁來測試存取多個資料庫"></a>建立網頁來測試存取多個資料庫</h3><p>先來建立<code>templates</code>的資料夾，下面在建立<code>home.html</code>和在建立<code>run.py</code>目前的結構如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB2\</span><br><span class="line">	database\</span><br><span class="line">		__init__.py</span><br><span class="line">		models.py</span><br><span class="line">		multidbmanager.py</span><br><span class="line">	templstes\</span><br><span class="line">         home.html</span><br><span class="line">    run.py     </span><br></pre></td></tr></table></figure>

<p>在<code>run.py</code>的程式如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> database.multidbmanager <span class="keyword">import</span> db, dbmgr</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line">app.config[<span class="string">&quot;SQLALCHEMY_BINDS&quot;</span>] = &#123;</span><br><span class="line">    <span class="string">&#x27;asa&#x27;</span>: <span class="string">&#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ups&#x27;</span>: <span class="string">&#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">db.init_app(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="comment"># 取得使用那一個資料庫</span></span><br><span class="line">    bindkey = request.form.get(<span class="string">&quot;dbkey&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line"></span><br><span class="line">        session = dbmgr.getSession(bindkey)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            name = request.form.get(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">            username = request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">            password = request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">            <span class="comment"># 檢查是否有重覆的資料</span></span><br><span class="line">            row = User.findByName(name, bindkey)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> row:</span><br><span class="line">                myuser = User(name, username, password.encode(<span class="string">&#x27;utf-8&#x27;</span>), bindkey)</span><br><span class="line">                <span class="built_in">print</span>(myuser)</span><br><span class="line">                session.add(myuser)</span><br><span class="line">                session.commit()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;加入資料失敗&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="comment"># 取得各個列表</span></span><br><span class="line">    <span class="comment"># 預設列表</span></span><br><span class="line">    users = <span class="literal">None</span></span><br><span class="line">    users = User.getAll()</span><br><span class="line">    <span class="comment"># asa列表</span></span><br><span class="line">    asausers = <span class="literal">None</span></span><br><span class="line">    asausers = User.getAll(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">    <span class="comment"># ups 列表</span></span><br><span class="line">    upsusers = <span class="literal">None</span></span><br><span class="line">    upsusers = User.getAll(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>, users=users, asausers=asausers, upsusers=upsusers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/update&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 取得使用那一個資料庫</span></span><br><span class="line">        bindkey = request.form.get(<span class="string">&quot;dbkey&quot;</span>)</span><br><span class="line">        session = dbmgr.getSession(bindkey)</span><br><span class="line">        <span class="built_in">id</span> = request.form.get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">        newusername = request.form.get(<span class="string">&quot;newusername&quot;</span>)</span><br><span class="line">        row = session.query(User).filter_by(<span class="built_in">id</span>=<span class="built_in">id</span>).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            row.username = newusername</span><br><span class="line">            session.commit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;更新資料失敗&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刪除</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/delete&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 取得使用那一個資料庫</span></span><br><span class="line">        bindkey = request.form.get(<span class="string">&quot;dbkey&quot;</span>)</span><br><span class="line">        session = dbmgr.getSession(bindkey)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; (id=&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(session, <span class="built_in">id</span>(session)))</span><br><span class="line">        uid = request.form.get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">        row = session.query(User).filter_by(<span class="built_in">id</span>=uid).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            User.delete(row, session)</span><br><span class="line">            <span class="comment"># session.delete(row)</span></span><br><span class="line">            <span class="comment"># session.commit()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;刪除資料失敗&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="建立測試三個資料庫的資料-動態"><a href="#建立測試三個資料庫的資料-動態" class="headerlink" title="建立測試三個資料庫的資料-動態"></a>建立測試三個資料庫的資料-動態</h2><p>目前的資料表和資料庫是使用上面所建立的基礎來擴充</p>
<h3 id="1-以sqlalchemy的功能來建立"><a href="#1-以sqlalchemy的功能來建立" class="headerlink" title="1. 以sqlalchemy的功能來建立"></a>1. 以sqlalchemy的功能來建立</h3><p>先來建立資料夾來作為專案的主要資料夾<code>TestFlaskMultDB3</code></p>
<h4 id="單元測試三個資料庫的CRUD的功能"><a href="#單元測試三個資料庫的CRUD的功能" class="headerlink" title="單元測試三個資料庫的CRUD的功能"></a>單元測試三個資料庫的CRUD的功能</h4><p>要測試三個資料庫，先來建立和使用一個資料庫，如果可以執行的話，那三個也是可以的，先來建立資料庫的管理和連結目前的專案結構是如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB3\</span><br><span class="line">    Testdbdata.py</span><br><span class="line">	database\</span><br><span class="line">	    __init__.py</span><br><span class="line">	    dbmanager.py</span><br><span class="line">	    models.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>database\models.py</code>是放對映的ORM的物件程式碼如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> .dbmanager <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">64</span>))</span><br><span class="line">    username = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line">    password = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, username, password, bind=<span class="literal">None</span></span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = hashlib.sha1(password).hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User(&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;)&quot;</span>.<span class="built_in">format</span>(self.name, self.username, self.password)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>database\dbmanager.py</code>是主要的切換資料庫的地方</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> scoped_session, sessionmaker</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> current_app</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SessionManager</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    DBBinds = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;SessionManager.__init__&quot;</span>)</span><br><span class="line">        self.dbname = <span class="literal">None</span></span><br><span class="line">        self.session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 取得資料庫的session</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getSession</span>(<span class="params">self, dbname=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># 檢查是那一個資料庫</span></span><br><span class="line">        db_name = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> dbname <span class="keyword">in</span> SessionManager.DBBinds:</span><br><span class="line">            db_name = dbname</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            db_name = <span class="string">&quot;default&quot;</span></span><br><span class="line">        <span class="comment"># 檢查是否是同一個session</span></span><br><span class="line">        <span class="keyword">if</span> self.session:</span><br><span class="line">            <span class="keyword">if</span> self.session.name == db_name:</span><br><span class="line">                <span class="keyword">return</span> self.session</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.session.remove()</span><br><span class="line">                self.session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.session:</span><br><span class="line">            engine = create_engine(SessionManager.DBBinds[db_name])</span><br><span class="line">            db_session = scoped_session(sessionmaker(bind=engine))</span><br><span class="line">            db_session.name = db_name</span><br><span class="line">            self.session = db_session</span><br><span class="line">        <span class="keyword">return</span> db_session</span><br><span class="line">    <span class="comment"># 加入資料的連結</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">AddDBUrl</span>(<span class="params">self, key, dburl</span>):</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> SessionManager.DBBinds:</span><br><span class="line">            SessionManager.DBBinds[key] = dburl</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            SessionManager.DBBinds[key] = dburl</span><br><span class="line">        <span class="comment"># print(SessionManager.DBBinds)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dbmgr = SessionManager()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>單元測試的主程式<code>Testdbdata.py</code>的程式碼如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 來建立測試用的資料</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> database.dbmanager <span class="keyword">import</span> db, dbmgr</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 動態加入資料庫</span></span><br><span class="line">dbmgr.AddDBUrl(<span class="string">&quot;default&quot;</span>, <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span>)</span><br><span class="line">dbmgr.AddDBUrl(<span class="string">&quot;asa&quot;</span>, <span class="string">&#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;</span>)</span><br><span class="line">dbmgr.AddDBUrl(<span class="string">&quot;ups&quot;</span>, <span class="string">&#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestAddDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        username = dbkey+<span class="string">&quot;username&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        password = <span class="string">&quot;password_&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        myuser = User(name, username, password.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        <span class="built_in">print</span>(myuser)</span><br><span class="line">        session.add(myuser)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 刪除</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestDelDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            session.delete(row)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查詢</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestFindDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestModDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            row.username += <span class="string">&quot;mod&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(row)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># TestAddDBdata(&quot;asa&quot;)</span></span><br><span class="line">        <span class="keyword">with</span> app.app_context():</span><br><span class="line">            <span class="comment"># 增加</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;增加資料----------------&quot;</span>)</span><br><span class="line">            TestAddDBdata()</span><br><span class="line">            TestAddDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestAddDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># 修改</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;修改資料----------------&quot;</span>)</span><br><span class="line">            TestModDBdata()</span><br><span class="line">            TestModDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestModDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># # 查</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;查詢資料----------------&quot;</span>)</span><br><span class="line">            TestFindDBdata()</span><br><span class="line">            TestFindDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestFindDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># 刪</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;刪除資料----------------&quot;</span>)</span><br><span class="line">            TestDelDBdata()</span><br><span class="line">            TestDelDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestDelDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;資料表增刪查改完成&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="建立網頁來存取多個資料庫"><a href="#建立網頁來存取多個資料庫" class="headerlink" title="建立網頁來存取多個資料庫"></a>建立網頁來存取多個資料庫</h4><p>先來建立<code>templates</code>的資料夾，下面在建立<code>home.html</code>和在建立<code>run.py</code>目前的結構如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB3\</span><br><span class="line">    Testdbdata.py</span><br><span class="line">	database\</span><br><span class="line">	    __init__.py</span><br><span class="line">	    dbmanager.py</span><br><span class="line">	    models.py</span><br><span class="line">	templates\</span><br><span class="line">        home.html</span><br><span class="line">     run.py    </span><br></pre></td></tr></table></figure>

<h5 id="先來建立和取得所有的列表"><a href="#先來建立和取得所有的列表" class="headerlink" title="先來建立和取得所有的列表"></a>先來建立和取得所有的列表</h5><p>在<code>run.py</code>中的程式碼如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> database.dbmanager <span class="keyword">import</span> dbmgr</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 動態加入資料庫</span></span><br><span class="line">dbmgr.AddDBUrl(<span class="string">&quot;default&quot;</span>, <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span>)</span><br><span class="line">dbmgr.AddDBUrl(<span class="string">&quot;asa&quot;</span>, <span class="string">&#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;</span>)</span><br><span class="line">dbmgr.AddDBUrl(<span class="string">&quot;ups&quot;</span>, <span class="string">&#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="comment"># 取得使用那一個資料庫</span></span><br><span class="line">    bindkey = request.form.get(<span class="string">&quot;dbkey&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            session = dbmgr.getSession(bindkey)</span><br><span class="line">            name = request.form.get(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">            username = request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">            password = request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">            <span class="comment"># 檢查是否有重覆的資料</span></span><br><span class="line">            row = User.findByName(name, session)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> row:</span><br><span class="line">                myuser = User(name, username, password.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">                <span class="built_in">print</span>(myuser)</span><br><span class="line">                session.add(myuser)</span><br><span class="line">                session.commit()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;加入資料失敗&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="comment"># 取得各個列表</span></span><br><span class="line">    <span class="comment"># 預設列表</span></span><br><span class="line">    users = <span class="literal">None</span></span><br><span class="line">    users = User.getAll()</span><br><span class="line">    <span class="comment"># asa列表</span></span><br><span class="line">    asausers = <span class="literal">None</span></span><br><span class="line">    asausers = User.getAll(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">    <span class="comment"># ups 列表</span></span><br><span class="line">    upsusers = <span class="literal">None</span></span><br><span class="line">    upsusers = User.getAll(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>, users=users, asausers=asausers, upsusers=upsusers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h5 id="加入更新資料"><a href="#加入更新資料" class="headerlink" title="加入更新資料"></a>加入更新資料</h5><p>在原來的<code>run.py</code>中加入更新的功能</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 更新資料</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/update&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 取得使用那一個資料庫</span></span><br><span class="line">        bindkey = request.form.get(<span class="string">&quot;dbkey&quot;</span>)</span><br><span class="line">        session = dbmgr.getSession(bindkey)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;修改:&#123;&#125; (id=&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(session, <span class="built_in">id</span>(session)))</span><br><span class="line">        uid = request.form.get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">        newusername = request.form.get(<span class="string">&quot;newusername&quot;</span>)</span><br><span class="line">        row = session.query(User).filter_by(<span class="built_in">id</span>=uid).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            row.username = newusername</span><br><span class="line">            session.commit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;更新資料失敗&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="加入刪除資料"><a href="#加入刪除資料" class="headerlink" title="加入刪除資料"></a>加入刪除資料</h5><p>在原來的<code>run.py</code>中加入刪除的功能</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 刪除</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/delete&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 取得使用那一個資料庫</span></span><br><span class="line">        bindkey = request.form.get(<span class="string">&quot;dbkey&quot;</span>)</span><br><span class="line">        session = dbmgr.getSession(bindkey)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;刪除:&#123;&#125; (id=&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(session, <span class="built_in">id</span>(session)))</span><br><span class="line">        uid = request.form.get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">        row = session.query(User).filter_by(<span class="built_in">id</span>=uid).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            User.delete(row, bindkey)</span><br><span class="line">            <span class="comment"># session.delete(row)</span></span><br><span class="line">            <span class="comment"># session.commit()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;刪除資料失敗&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="2-以flask-sqlalchemy的功能來建立"><a href="#2-以flask-sqlalchemy的功能來建立" class="headerlink" title="2 .以flask_sqlalchemy的功能來建立"></a>2 .以flask_sqlalchemy的功能來建立</h3><p>先來建立資料夾來作為專案的主要資料夾&#96;TestFlaskMultDB4</p>
<h4 id="單元測試三個資料庫的CRUD的功能-1"><a href="#單元測試三個資料庫的CRUD的功能-1" class="headerlink" title="單元測試三個資料庫的CRUD的功能"></a>單元測試三個資料庫的CRUD的功能</h4><p>要測試三個資料庫，先來建立和使用一個資料庫，如果可以執行的話，那三個也是可以的，先來建立資料庫的管理和連結目前的專案結構是如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB4\</span><br><span class="line">    Testdbdata.py</span><br><span class="line">	database\</span><br><span class="line">	    __init__.py</span><br><span class="line">	    dyndbmanager.py</span><br><span class="line">	    models.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>database\models.py</code>是放對映的ORM的物件程式碼如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> .dyndbmanager <span class="keyword">import</span> db, dbmgr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">64</span>))</span><br><span class="line">    username = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line">    password = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, username, password, bind=<span class="literal">None</span></span>):</span><br><span class="line">        self.__bind_key__ = bind</span><br><span class="line">        self.name = name</span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = hashlib.sha1(password).hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User(&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;)&quot;</span>.<span class="built_in">format</span>(self.name, self.username, self.password)</span><br></pre></td></tr></table></figure>

<p>在<code>database\dyndbmanager.py</code>是主要的切換資料庫的地方</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> current_app</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DynDBManager</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;DynDBManager.__init__&quot;</span>)</span><br><span class="line">        self.app = current_app</span><br><span class="line">        self.db = db</span><br><span class="line">        self.dburl = <span class="literal">None</span></span><br><span class="line">        self.session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加入資料的連結</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">AddDBUrl</span>(<span class="params">self, key, dburl</span>):</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>]:</span><br><span class="line">            current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>][key] = dburl</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>][key] = dburl</span><br><span class="line">        <span class="comment"># 重新整理連結的資料庫</span></span><br><span class="line">        self.db.get_binds(self.app)</span><br><span class="line">        <span class="built_in">print</span>(current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getSession</span>(<span class="params">self, dbname=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># 檢查那一個資料庫</span></span><br><span class="line">        db_name = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> dbname <span class="keyword">in</span> current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>]:</span><br><span class="line">            db_name = dbname</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 檢查是否是同一個session</span></span><br><span class="line">        <span class="keyword">if</span> self.session:</span><br><span class="line">            <span class="keyword">if</span> self.session.name == db_name:</span><br><span class="line">                <span class="keyword">return</span> self.session</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.session:</span><br><span class="line">            engine = db.get_engine(self.app, dbname)</span><br><span class="line">            db.session.bind = engine</span><br><span class="line">            session_maker = db.sessionmaker()</span><br><span class="line">            session_maker.configure(bind=engine)</span><br><span class="line">            session = session_maker()</span><br><span class="line">            session.name = db_name</span><br><span class="line">            self.session = session</span><br><span class="line">            <span class="keyword">return</span> session</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dbmgr = DynDBManager()</span><br></pre></td></tr></table></figure>

<p>單元測試的主程式<code>Testdbdata.py</code>的程式碼如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 來建立測試用的資料</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> database.dyndbmanager <span class="keyword">import</span> db, dbmgr</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line">app.config[<span class="string">&quot;SQLALCHEMY_BINDS&quot;</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">db.init_app(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 動態加入資料庫</span></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    dbmgr.AddDBUrl(<span class="string">&quot;asa&quot;</span>, <span class="string">&#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;</span>)</span><br><span class="line">    dbmgr.AddDBUrl(<span class="string">&quot;ups&quot;</span>, <span class="string">&#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestAddDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> dbkey != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        username = dbkey+<span class="string">&quot;username&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        password = <span class="string">&quot;password_&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        myuser = User(name, username, password.encode(<span class="string">&#x27;utf-8&#x27;</span>), bindkey)</span><br><span class="line">        <span class="comment"># 檢查是否有重覆的資料</span></span><br><span class="line">        row = User.findByName(name, bindkey)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> row:</span><br><span class="line">            <span class="built_in">print</span>(myuser)</span><br><span class="line">            session.add(myuser)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 刪除</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestDelDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> dbkey != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            session.delete(row)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查詢</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestFindDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> dbkey != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestModDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> dbkey != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            row.username += <span class="string">&quot;mod&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(row)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> app.app_context():</span><br><span class="line">            <span class="comment"># 增加</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;增加資料----------------&quot;</span>)</span><br><span class="line">            TestAddDBdata()</span><br><span class="line">            TestAddDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestAddDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># 修改</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;修改資料----------------&quot;</span>)</span><br><span class="line">            TestModDBdata()</span><br><span class="line">            TestModDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestModDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># # 查</span></span><br><span class="line">            <span class="comment"># print(&quot;查詢資料----------------&quot;)</span></span><br><span class="line">            TestFindDBdata()</span><br><span class="line">            TestFindDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestFindDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># # 刪</span></span><br><span class="line">            <span class="comment"># print(&quot;刪除資料----------------&quot;)</span></span><br><span class="line">            TestDelDBdata()</span><br><span class="line">            TestDelDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestDelDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;資料表增刪查改完成&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="建立網頁來存取多個資料庫-1"><a href="#建立網頁來存取多個資料庫-1" class="headerlink" title="建立網頁來存取多個資料庫"></a>建立網頁來存取多個資料庫</h4><p>先來建立<code>templates</code>的資料夾，下面在建立<code>home.html</code>和在建立<code>run.py</code>目前的結構如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB3\</span><br><span class="line">    Testdbdata.py</span><br><span class="line">	database\</span><br><span class="line">	    __init__.py</span><br><span class="line">	    dyndbmanager.py</span><br><span class="line">	    models.py</span><br><span class="line">	templates\</span><br><span class="line">        home.html</span><br><span class="line">     run.py    </span><br></pre></td></tr></table></figure>

<h5 id="先來建立和取得所有的列表-1"><a href="#先來建立和取得所有的列表-1" class="headerlink" title="先來建立和取得所有的列表"></a>先來建立和取得所有的列表</h5><p>在<code>run.py</code>中的程式碼如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> database.dyndbmanager <span class="keyword">import</span> db, dbmgr</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line">app.config[<span class="string">&quot;SQLALCHEMY_BINDS&quot;</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">db.init_app(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 動態加入資料庫</span></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    dbmgr.AddDBUrl(<span class="string">&quot;asa&quot;</span>, <span class="string">&#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;</span>)</span><br><span class="line">    dbmgr.AddDBUrl(<span class="string">&quot;ups&quot;</span>, <span class="string">&#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span>)</span><br><span class="line">    <span class="comment"># db.get_binds()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">checkdbname</span>(<span class="params">dbname=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> dbname == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> dbname</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="comment"># 取得使用那一個資料庫</span></span><br><span class="line">    bindkey = checkdbname(request.form.get(<span class="string">&quot;dbkey&quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            session = dbmgr.getSession(bindkey)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;新增:&#123;&#125; (id=&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(session, <span class="built_in">id</span>(session)))</span><br><span class="line">            name = request.form.get(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">            username = request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">            password = request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">            <span class="comment"># 檢查是否有重覆的資料</span></span><br><span class="line">            row = User.findByName(name, bindkey)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> row:</span><br><span class="line">                myuser = User(name, username, password.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">                <span class="built_in">print</span>(myuser)</span><br><span class="line">                session.add(myuser)</span><br><span class="line">                session.commit()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;加入資料失敗&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="comment"># 取得各個列表</span></span><br><span class="line">    <span class="comment"># 預設列表</span></span><br><span class="line">    users = <span class="literal">None</span></span><br><span class="line">    users = User.getAll()</span><br><span class="line">    <span class="comment"># asa列表</span></span><br><span class="line">    asausers = <span class="literal">None</span></span><br><span class="line">    asausers = User.getAll(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">    <span class="comment"># ups 列表</span></span><br><span class="line">    upsusers = <span class="literal">None</span></span><br><span class="line">    upsusers = User.getAll(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>, users=users, asausers=asausers, upsusers=upsusers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="加入更新資料-1"><a href="#加入更新資料-1" class="headerlink" title="加入更新資料"></a>加入更新資料</h5><p>在原來的<code>run.py</code>中加入更新的功能</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 更新資料</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/update&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 取得使用那一個資料庫</span></span><br><span class="line">        bindkey = checkdbname(request.form.get(<span class="string">&quot;dbkey&quot;</span>))</span><br><span class="line">        session = dbmgr.getSession(bindkey)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;修改:&#123;&#125; (id=&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(session, <span class="built_in">id</span>(session)))</span><br><span class="line">        uid = request.form.get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">        newusername = request.form.get(<span class="string">&quot;newusername&quot;</span>)</span><br><span class="line">        row = session.query(User).filter_by(<span class="built_in">id</span>=uid).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            row.username = newusername</span><br><span class="line">            session.commit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;更新資料失敗&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="加入刪除資料-1"><a href="#加入刪除資料-1" class="headerlink" title="加入刪除資料"></a>加入刪除資料</h5><p>在原來的<code>run.py</code>中加入刪除的功能</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 刪除</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/delete&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 取得使用那一個資料庫</span></span><br><span class="line">        bindkey = checkdbname(request.form.get(<span class="string">&quot;dbkey&quot;</span>))</span><br><span class="line">        session = dbmgr.getSession(bindkey)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;刪除:&#123;&#125; (id=&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(session, <span class="built_in">id</span>(session)))</span><br><span class="line">        uid = request.form.get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">        row = session.query(User).filter_by(<span class="built_in">id</span>=uid).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            User.delete(row, bindkey)</span><br><span class="line">            <span class="comment"># session.delete(row)</span></span><br><span class="line">            <span class="comment"># session.commit()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;刪除資料失敗&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="以Angular來測試一下多個資料庫"><a href="#以Angular來測試一下多個資料庫" class="headerlink" title="以Angular來測試一下多個資料庫"></a>以Angular來測試一下多個資料庫</h2><p>之前的資料表和資料庫是不變，目前以angular來當前端主要的功能有</p>
<ol>
<li>可以在網頁上動態的加入資料𢉦的連結</li>
<li>可以網頁上來切換選擇使用那一個資料來作操作</li>
</ol>
<p>後台的建立基本上和<a href="#%E5%BB%BA%E7%AB%8B%E6%B8%AC%E8%A9%A6%E4%B8%89%E5%80%8B%E8%B3%87%E6%96%99%E5%BA%AB%E7%9A%84%E8%B3%87%E6%96%99-%E5%8B%95%E6%85%8B">上面</a>的差不多只是要安裝python需要的程式庫,記得要在虛擬環境下安裝</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install flask-marshmallow</span><br><span class="line">pip install marshmallow-sqlalchemy</span><br></pre></td></tr></table></figure>

<p>先來建立資料夾<code>TestFlaskMultDB5</code>在下面在建立兩個資料夾<code>client</code>和<code>server</code>,<code>client</code>是給前端使用而<code>server</code>是給python後端來使用，檔案結構如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TestFlaskMultDB5\</span><br><span class="line">    client\</span><br><span class="line">    server\</span><br></pre></td></tr></table></figure>



<h3 id="建立基本後台"><a href="#建立基本後台" class="headerlink" title="建立基本後台"></a>建立基本後台</h3><p>後台的專案結構如下下以<code>server</code>的資料夾為開始的路徑</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">database\</span><br><span class="line">    __init__.py</span><br><span class="line">    dyndbmanager.py</span><br><span class="line">    models.py</span><br><span class="line">lib\</span><br><span class="line">    retrespon.oy</span><br><span class="line">db_create.py</span><br><span class="line">run.py</span><br><span class="line">Testdbdata.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>db_create.py</code>主要是建立資料表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 建立基本資料表，通常沒有資料表的時候才會建立</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> database.dyndbmanager <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line"><span class="comment"># app.config[&quot;SQLALCHEMY_BINDS&quot;] = &#123;</span></span><br><span class="line"><span class="comment">#     &#x27;asa&#x27;: &#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;,</span></span><br><span class="line"><span class="comment">#     &#x27;ups&#x27;: &#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">db.init_app(app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> app.app_context():</span><br><span class="line">            db.create_all()</span><br><span class="line"></span><br><span class="line">            user_1 = User(<span class="string">&#x27;user1&#x27;</span>, <span class="string">&#x27;username1&#x27;</span>, <span class="string">&#x27;password_1&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">            session = db.session</span><br><span class="line">            session.add(user_1)</span><br><span class="line">            row = session.query(User).filter_by(name=<span class="string">&#x27;user1&#x27;</span>).first()</span><br><span class="line">            <span class="keyword">if</span> row:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Found user1&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(row)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Can not find user1&#x27;</span>)</span><br><span class="line">            session.rollback()  <span class="comment"># 資料庫回到新增 user1 之前的狀態</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;User資料表建立完成&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>Testdbdata.py</code>主要是單元測試，和資料庫的CRUD的動作是否正常</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 來建立測試用的資料</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> database.dyndbmanager <span class="keyword">import</span> db, dbmgr</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line">app.config[<span class="string">&quot;SQLALCHEMY_BINDS&quot;</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">db.init_app(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 動態加入資料庫</span></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    dbmgr.AddDBUrl(<span class="string">&quot;asa&quot;</span>, <span class="string">&#x27;mysql://root:12345678@localhost:33306/dbasa&#x27;</span>)</span><br><span class="line">    dbmgr.AddDBUrl(<span class="string">&quot;ups&quot;</span>, <span class="string">&#x27;mysql://root:12345678@localhost:33307/dbups&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestAddDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> dbkey != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        username = dbkey+<span class="string">&quot;username&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        password = <span class="string">&quot;password_&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        myuser = User(name, username, password.encode(<span class="string">&#x27;utf-8&#x27;</span>), bindkey)</span><br><span class="line">        <span class="comment"># 檢查是否有重覆的資料</span></span><br><span class="line">        row = User.findByName(name, bindkey)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> row:</span><br><span class="line">            <span class="built_in">print</span>(myuser)</span><br><span class="line">            session.add(myuser)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 刪除</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestDelDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> dbkey != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            session.delete(row)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查詢</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestFindDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> dbkey != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TestModDBdata</span>(<span class="params">dbkey=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    bindkey = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> dbkey != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        bindkey = dbkey</span><br><span class="line">    session = dbmgr.getSession(bindkey)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        name = dbkey+<span class="string">&quot;user&quot;</span>+<span class="built_in">str</span>(idx)</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> row:</span><br><span class="line">            row.username += <span class="string">&quot;mod&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(row)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> app.app_context():</span><br><span class="line">            <span class="comment"># 增加</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;增加資料----------------&quot;</span>)</span><br><span class="line">            TestAddDBdata()</span><br><span class="line">            TestAddDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestAddDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># 修改</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;修改資料----------------&quot;</span>)</span><br><span class="line">            TestModDBdata()</span><br><span class="line">            TestModDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestModDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># # 查</span></span><br><span class="line">            <span class="comment"># print(&quot;查詢資料----------------&quot;)</span></span><br><span class="line">            TestFindDBdata()</span><br><span class="line">            TestFindDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestFindDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line">            <span class="comment"># 刪</span></span><br><span class="line">            <span class="comment"># print(&quot;刪除資料----------------&quot;)</span></span><br><span class="line">            TestDelDBdata()</span><br><span class="line">            TestDelDBdata(<span class="string">&quot;asa&quot;</span>)</span><br><span class="line">            TestDelDBdata(<span class="string">&quot;ups&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;資料表增刪查改完成&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因為後台動作的成功或失敗是要回傳結果給前台知道成功時可繼續來動作，失敗時可以通知前台為什麼失敗所以需要有物件來處理就是<code>lib\retrespon.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 建立網頁回覆的json</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resData</span>(<span class="params">status, msg, tokendata=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> tokendata:</span><br><span class="line">        responseObject = &#123;</span><br><span class="line">            <span class="string">&quot;status&quot;</span>: status,</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: msg,</span><br><span class="line">            <span class="string">&quot;auth_token&quot;</span>: tokendata</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseObject</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        responseObject = &#123;</span><br><span class="line">            <span class="string">&quot;status&quot;</span>: status,</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: msg,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseObject</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><code>database\models.py</code>主要的ORM物件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> .dyndbmanager <span class="keyword">import</span> db, ma, dbmgr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">64</span>))</span><br><span class="line">    username = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line">    password = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, username, password, bind=<span class="literal">None</span></span>):</span><br><span class="line">        self.__bind_key__ = bind</span><br><span class="line">        self.name = name</span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = hashlib.sha1(password).hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User(&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;,&#x27;&#123;&#125;&#x27;)&quot;</span>.<span class="built_in">format</span>(self.name, self.username, self.password)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">findByName</span>(<span class="params">name, dbname</span>):</span><br><span class="line">        session = dbmgr.getSession(dbname)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;findByName:&#123;&#125; (id=&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(session, <span class="built_in">id</span>(session)))</span><br><span class="line">        row = session.query(User).filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">return</span> row</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getAll</span>(<span class="params">dbname=<span class="literal">None</span></span>):</span><br><span class="line">        session = dbmgr.getSession(dbname)</span><br><span class="line">        <span class="keyword">return</span> session.query(User).<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">row, dbname=<span class="literal">None</span></span>):</span><br><span class="line">        session = dbmgr.getSession(dbname)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;delete&#123;&#125; (id=&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(session, <span class="built_in">id</span>(session)))</span><br><span class="line">        session.delete(row)</span><br><span class="line">        session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserSchema</span>(ma.Schema):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        <span class="comment"># Fields to expose</span></span><br><span class="line">        fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>database\dyndbmanager.py</code>主要是來取得目前在處理那一個資料庫，在有問題的連結會移除和重新將exception丟出</p>
<h4 id="加入和刪除資料庫的連結"><a href="#加入和刪除資料庫的連結" class="headerlink" title="加入和刪除資料庫的連結"></a>加入和刪除資料庫的連結</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> current_app</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_marshmallow <span class="keyword">import</span> Marshmallow</span><br><span class="line">db = SQLAlchemy()</span><br><span class="line">ma = Marshmallow()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DynDBManager</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;DynDBManager.__init__&quot;</span>)</span><br><span class="line">        self.app = current_app</span><br><span class="line">        self.db = db</span><br><span class="line">        self.dburl = <span class="literal">None</span></span><br><span class="line">        self.session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加入資料的連結</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">AddDBUrl</span>(<span class="params">self, key, dburl</span>):</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>]:</span><br><span class="line">            current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>][key] = dburl</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>][key] = dburl</span><br><span class="line">        <span class="comment"># 重新整理連結的資料庫</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            currlist = self.db.get_binds(self.app)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">            current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>].pop(key, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>])</span><br><span class="line">    <span class="comment"># 移除資料庫的連結</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">DelDBUrl</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>]:</span><br><span class="line">            current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>].pop(key, <span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># 重新整理連結的資料庫</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            currlist = self.db.get_binds(self.app)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">            current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>].pop(key, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">raise</span> e</span><br><span class="line">        <span class="built_in">print</span>(current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getSession</span>(<span class="params">self, dbname=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># 檢查那一個資料庫</span></span><br><span class="line">        db_name = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> dbname <span class="keyword">in</span> current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>]:</span><br><span class="line">            db_name = dbname</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 檢查是否是同一個session</span></span><br><span class="line">        <span class="keyword">if</span> self.session:</span><br><span class="line">            <span class="keyword">if</span> self.session.name == db_name:</span><br><span class="line">                <span class="keyword">return</span> self.session</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.session:</span><br><span class="line">            engine = db.get_engine(self.app, dbname)</span><br><span class="line">            db.session.bind = engine</span><br><span class="line">            session_maker = db.sessionmaker()</span><br><span class="line">            session_maker.configure(bind=engine)</span><br><span class="line">            session = session_maker()</span><br><span class="line">            session.name = db_name</span><br><span class="line">            self.session = session</span><br><span class="line">            <span class="keyword">return</span> session</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getAllDB</span>(<span class="params">self</span>):</span><br><span class="line">        dbbinds = []</span><br><span class="line">        dicdbbinds = &#123;<span class="string">&quot;dbkey&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;dburl&quot;</span>: self.app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>]&#125;</span><br><span class="line">        dbbinds.append(dicdbbinds)</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>].items():</span><br><span class="line">            dicdbbinds = &#123;<span class="string">&quot;dbkey&quot;</span>: k, <span class="string">&quot;dburl&quot;</span>: v&#125;</span><br><span class="line">            dbbinds.append(dicdbbinds)</span><br><span class="line">        <span class="keyword">return</span> dbbinds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dbmgr = DynDBManager()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>run.py</code>主要程式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Response, request, jsonify</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> database.models <span class="keyword">import</span> User, UserSchema</span><br><span class="line"><span class="keyword">from</span> database.dyndbmanager <span class="keyword">import</span> db, ma, dbmgr</span><br><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span><br><span class="line"><span class="keyword">from</span> lib.retrespon <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">CORS(app)</span><br><span class="line"><span class="comment"># 資料庫設定</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/dbhisharp&#x27;</span></span><br><span class="line">app.config[<span class="string">&quot;SQLALCHEMY_BINDS&quot;</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 設置每次請求當結束後會自動提交數據庫中的改動</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_COMMIT_ON_TEARDOWN&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 查詢時會顯示原始SQL語句</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_ECHO&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">db.init_app(app)</span><br><span class="line">ma.init_app(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 檢查資料庫是否合法</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">checkdbname</span>(<span class="params">dbname=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> dbname == <span class="string">&quot;&quot;</span> <span class="keyword">or</span> dbname == <span class="string">&quot;default&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> dbname</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/databaseproc&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">databaselist</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> request.form:</span><br><span class="line">            dbkey = request.form.get(<span class="string">&quot;dbkey&quot;</span>)</span><br><span class="line">            dburl = request.form.get(<span class="string">&quot;dburl&quot;</span>)</span><br><span class="line">            password = request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">            fmt = <span class="string">&#x27;%s-&gt; %s&#x27;</span> % (dbkey, dburl)</span><br><span class="line">            <span class="built_in">print</span>(fmt)</span><br><span class="line">            dbmgr.AddDBUrl(dbkey, dburl)</span><br><span class="line">            responseObject = resData(<span class="string">&quot;success&quot;</span>, <span class="string">&quot;資料庫連結加入成功&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> jsonify(responseObject), <span class="number">200</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 取得資料庫列表</span></span><br><span class="line">            result = dbmgr.getAllDB()</span><br><span class="line">            X_Total_Count = <span class="built_in">len</span>(result)</span><br><span class="line">            resp = jsonify(result)</span><br><span class="line">            resp.status_code = <span class="number">200</span></span><br><span class="line">            <span class="comment"># 可加入多少個</span></span><br><span class="line">            resp.headers.add(<span class="string">&#x27;X-Total-Count&#x27;</span>, X_Total_Count)</span><br><span class="line">            <span class="keyword">return</span> resp</span><br><span class="line">            <span class="comment"># return jsonify(result)</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to api databaseproc&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        responseObject = resData(<span class="string">&quot;fail&quot;</span>, <span class="string">&quot;Failed to api databaseproc&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(responseObject), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/databaseproc/&lt;dbkey&gt;&quot;</span>, methods=[<span class="string">&quot;DELETE&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">database_delete</span>(<span class="params">dbkey</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># if request.form:</span></span><br><span class="line">        <span class="comment">#     dbkey = request.form.get(&quot;dbkey&quot;)</span></span><br><span class="line">        <span class="comment">#     dburl = request.form.get(&quot;dburl&quot;)</span></span><br><span class="line">        <span class="comment">#     fmt = &#x27;%s-&gt; %s&#x27; % (dbkey, dburl)</span></span><br><span class="line">        <span class="comment"># print(dbkey)</span></span><br><span class="line">        dbmgr.DelDBUrl(dbkey)</span><br><span class="line">        responseObject = resData(<span class="string">&quot;success&quot;</span>, <span class="string">&quot;資料庫連結刪除成功&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(responseObject), <span class="number">200</span></span><br><span class="line">        <span class="comment"># user = User.query.get(id)</span></span><br><span class="line">        <span class="comment"># db.session.delete(user)</span></span><br><span class="line">        <span class="comment"># db.session.commit()</span></span><br><span class="line">        <span class="comment"># return user_schema.jsonify(user)</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to delete api databaseproc&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        responseObject = resData(<span class="string">&quot;fail&quot;</span>, <span class="string">&quot;Failed to delete api databaseproc&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(responseObject), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用者相關</span></span><br><span class="line"><span class="comment"># endpoint to show all users</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;dbkey&gt;&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">dbkey</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> dbkey == <span class="string">&quot;default&quot;</span>:</span><br><span class="line">            dbkey = <span class="literal">None</span></span><br><span class="line">        page = <span class="built_in">int</span>(request.args.get(<span class="string">&quot;page&quot;</span>))</span><br><span class="line">        limit = <span class="built_in">int</span>(request.args.get(<span class="string">&quot;limit&quot;</span>))</span><br><span class="line">        <span class="comment"># print(&quot;page=&quot;, page)</span></span><br><span class="line">        <span class="comment"># print(&quot;limit=&quot;, limit)</span></span><br><span class="line">        pageobj = User.paginate(dbkey, page, limit)</span><br><span class="line">        user_schema = UserSchema(many=<span class="literal">True</span>)</span><br><span class="line">        result = user_schema.dump(pageobj.object_list)</span><br><span class="line">        resp = jsonify(result)</span><br><span class="line">        resp.status_code = <span class="number">200</span></span><br><span class="line">        <span class="comment"># 全部有多少個</span></span><br><span class="line">        X_Total_Count = pageobj.paginator.count</span><br><span class="line">        resp.headers[<span class="string">&#x27;Access-Control-Expose-Headers&#x27;</span>] = <span class="string">&#x27;X-Total-Count&#x27;</span></span><br><span class="line">        resp.headers.add(<span class="string">&#x27;X-Total-Count&#x27;</span>, X_Total_Count)</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to get all user&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        result = &#123;<span class="string">&#x27;data&#x27;</span>: <span class="string">&#x27;notok&#x27;</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> jsonify(result), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># endpoint to create new user</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_user</span>():</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            dbkey = checkdbname(request.form.get(<span class="string">&#x27;dbkey&#x27;</span>))</span><br><span class="line">            name = request.form.get(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">            username = request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">            password = request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line"></span><br><span class="line">            new_user = User(name, username, password.encode(<span class="string">&#x27;utf-8&#x27;</span>), dbkey)</span><br><span class="line">            session = dbmgr.getSession(dbkey)</span><br><span class="line">            session.add(new_user)</span><br><span class="line">            session.commit()</span><br><span class="line">            responseObject = resData(<span class="string">&quot;success&quot;</span>, <span class="string">&quot;使用者加入成功&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> jsonify(responseObject), <span class="number">200</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Failed to add user&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">            result = &#123;<span class="string">&#x27;data&#x27;</span>: <span class="string">&#x27;加入使用者失敗&#x27;</span>&#125;</span><br><span class="line">            <span class="keyword">return</span> jsonify(result), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># endpoint to update user</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;id&gt;&quot;</span>, methods=[<span class="string">&quot;PUT&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_update</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        dbkey = checkdbname(request.form.get(<span class="string">&#x27;dbkey&#x27;</span>))</span><br><span class="line">        name = request.form.get(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">        username = request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">        password = request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">        row = User.getUser(<span class="built_in">id</span>, dbkey)</span><br><span class="line">        row.name = name</span><br><span class="line">        row.username = username</span><br><span class="line">        row.password = password</span><br><span class="line">        session = dbmgr.getSession(dbkey)</span><br><span class="line">        session.flush()</span><br><span class="line">        responseObject = resData(<span class="string">&quot;success&quot;</span>, <span class="string">&quot;修改使用者成功&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(responseObject), <span class="number">200</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to update user&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        result = &#123;<span class="string">&#x27;data&#x27;</span>: <span class="string">&#x27;修改使用者失敗&#x27;</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> jsonify(result), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># endpoint to delete user</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;dbkey&gt;/&lt;id&gt;&quot;</span>, methods=[<span class="string">&quot;DELETE&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_delete</span>(<span class="params">dbkey, <span class="built_in">id</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> dbkey == <span class="string">&quot;default&quot;</span>:</span><br><span class="line">            dbkey = <span class="literal">None</span></span><br><span class="line">        row = User.getUser(<span class="built_in">id</span>, dbkey)</span><br><span class="line">        User.delete(row, dbkey)</span><br><span class="line">        responseObject = resData(<span class="string">&quot;success&quot;</span>, <span class="string">&quot;使用者刪除成功&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(responseObject), <span class="number">200</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to del user&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        result = &#123;<span class="string">&#x27;data&#x27;</span>: <span class="string">&#x27;刪除使用者失敗&#x27;</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> jsonify(result), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="建立基本的前台UI介面"><a href="#建立基本的前台UI介面" class="headerlink" title="建立基本的前台UI介面"></a>建立基本的前台UI介面</h3><p>在<code>TestFlaskMultDB5\client</code>下以命令列來建立angular的程式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng new ngclient</span><br></pre></td></tr></table></figure>

<h4 id="建立基本的Layout"><a href="#建立基本的Layout" class="headerlink" title="建立基本的Layout"></a>建立基本的Layout</h4><p>加人dashboard的模組</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g m dashboard --routing</span><br></pre></td></tr></table></figure>

<p>加人dashboard的元件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g c dashboard</span><br></pre></td></tr></table></figure>

<p>安裝@angular&#x2F;material和@angular&#x2F;cdk</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install --save @angular/material @angular/cdk</span><br></pre></td></tr></table></figure>

<p>加入SharedAngularMaterial &lt;<a href="https://ithelp.ithome.com.tw/articles/10209937">https://ithelp.ithome.com.tw/articles/10209937</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g m share\SharedAngularMaterial</span><br></pre></td></tr></table></figure>

<p>加入theme設定</p>
<p>在’styles.scss’中,有四種選一種</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@import</span> <span class="string">&quot;~@angular/material/prebuilt-themes/deeppurple-amber.css&quot;</span>;</span><br><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/indigo-pink.css&quot;;</span></span><br><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/pink-bluegrey.css&quot;;</span></span><br><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/purple-green.css&quot;;</span></span><br></pre></td></tr></table></figure>

<p>加入Material Icons</p>
<p>可以到此網站找到需要的Icon,<a href="https://material.io/icons/">Material Icons</a></p>
<p>在<code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;https://fonts.googleapis.com/icon?family=Material+Icons&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在MatIcon中使用SVG</p>
<p>必須透過Angular提供的DomSanitizer Service來信任這個路徑。接著我們就可以透過<code>MatIconRegistry</code>來擴充SVG icon</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">SharedAngularMaterialModule</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> matIconRegistry: MatIconRegistry, <span class="keyword">private</span> domSanitizer: DomSanitizer</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">ngOnInit</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="comment">// this.matIconRegistry.addSvgIconInNamespace(</span></span><br><span class="line">    <span class="comment">//   &quot;custom-svg&quot;,</span></span><br><span class="line">    <span class="comment">//   &quot;angular&quot;,</span></span><br><span class="line">    <span class="comment">//   this.domSanitizer.bypassSecurityTrustResourceUrl(&quot;assets/images/angular_solidBlack.svg&quot;)</span></span><br><span class="line">    <span class="comment">// );</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在MatIcon中使用Icon Font</p>
<p>以FontAwesome為例，我們先來安裝庫</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install --save @fortawesome/fontawesome-free</span><br></pre></td></tr></table></figure>

<p>接下來在<code>src\styles.scss</code>中</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@import</span> <span class="string">&quot;~@angular/material/prebuilt-themes/deeppurple-amber.css&quot;</span>;</span><br><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/indigo-pink.css&quot;;</span></span><br><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/pink-bluegrey.css&quot;;</span></span><br><span class="line"><span class="comment">//@import &quot;~@angular/material/prebuilt-themes/purple-green.css&quot;;</span></span><br><span class="line"><span class="keyword">@import</span> <span class="string">&quot;~@fortawesome/fontawesome-free/css/all.css&quot;</span>;</span><br></pre></td></tr></table></figure>



<h4 id="加入通知訊息"><a href="#加入通知訊息" class="headerlink" title="加入通知訊息"></a>加入通知訊息</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g s services\toaster</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatSnackBar</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/snack-bar&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ToasterService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> snackBar: MatSnackBar</span>) &#123; &#125;</span><br><span class="line">  <span class="title function_">showToaster</span>(<span class="params">msg: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">snackBar</span>.<span class="title function_">open</span>(msg, <span class="literal">null</span>, &#123;</span><br><span class="line">      <span class="attr">duration</span>: <span class="number">2000</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="打造基本後台UI"><a href="#打造基本後台UI" class="headerlink" title="打造基本後台UI"></a>打造基本後台UI</h4><p>在<code>src\app\dashboard\dashboard.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mat-toolbar</span> <span class="attr">class</span>=<span class="string">&quot;demo-app-header&quot;</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-icon-button</span> (<span class="attr">click</span>)=<span class="string">&quot;sideNav.toggle()&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-icon</span>&gt;</span>&#123;&#123;sideNav.opened ? &#x27;close&#x27;:&#x27;menu&#x27;&#125;&#125;<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>動態元件 demo<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 在這之後的都會被推到右邊去 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toolbar-seprator&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-icon-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-icon</span>&gt;</span>message<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-icon-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-icon</span>&gt;</span>exit_to_app<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-toolbar</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-sidenav-container</span> <span class="attr">class</span>=<span class="string">&quot;demo-app-container&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-sidenav</span> <span class="attr">class</span>=<span class="string">&quot;demo-app-sidenav&quot;</span> #<span class="attr">sideNav</span> <span class="attr">mode</span>=<span class="string">&quot;push&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-nav-list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h3</span> <span class="attr">matSubheader</span>&gt;</span>示範用頁面<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/&#x27;, &#x27;dashboard&#x27;, &#x27;survey&#x27;]&quot;</span> <span class="attr">mat-list-item</span>&gt;</span>問卷調查<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/&#x27;, &#x27;dashboard&#x27;, &#x27;blog&#x27;]&quot;</span> <span class="attr">mat-list-item</span>&gt;</span>部落格<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/&#x27;, &#x27;dashboard&#x27;, &#x27;inbox&#x27;]&quot;</span> <span class="attr">mat-list-item</span>&gt;</span>收件夾<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-divider</span>&gt;</span><span class="tag">&lt;/<span class="name">mat-divider</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 另外一組選單 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h3</span> <span class="attr">matSubheader</span>&gt;</span>其他頁面<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/&#x27;]&quot;</span> <span class="attr">mat-list-item</span>&gt;</span>首頁<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/&#x27;]&quot;</span> <span class="attr">mat-list-item</span>&gt;</span>Google<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/&#x27;]&quot;</span> <span class="attr">mat-list-item</span>&gt;</span>Facebook<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-nav-list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-sidenav</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-sidenav-content</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;width: 100%;height: 20em;background-color: blueviolet&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-outlet</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-sidenav-content</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-sidenav-container</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dashboard\dashboard.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-dashboard&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./dashboard.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./dashboard.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DashboardComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在加入ToolBar有點小小問題，會隨著畫面捲動要讓toolbar個定在最上方設定一下CSS就好了在<code>src\app\dashboard\dashboard.component.scss</code></p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">mat-sidenav-container&#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.demo-app-header</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.demo-app-container</span>,</span><br><span class="line">  <span class="selector-class">.demo-app-sidenav</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">padding-top</span>: <span class="number">64px</span>;</span><br><span class="line">    <span class="comment">//width: 100%;</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="selector-class">.toolbar-seprator</span>&#123;</span><br><span class="line">  <span class="attribute">flex</span>:<span class="number">1</span> <span class="number">1</span> auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改<code>src\app\app.module.ts</code>加入需要的模組</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">BrowserModule</span>,</span><br><span class="line">    <span class="title class_">BrowserAnimationsModule</span>,</span><br><span class="line">    <span class="title class_">FormsModule</span>,</span><br><span class="line">    <span class="title class_">AppRoutingModule</span>,</span><br><span class="line">    <span class="title class_">DashboardModule</span></span><br><span class="line">  ],</span><br></pre></td></tr></table></figure>

<p>修改<code>src\app\dashboard\dashboard.module.ts</code>中加入需要的模組</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">CommonModule</span>,</span><br><span class="line">    <span class="title class_">FormsModule</span>,</span><br><span class="line">    <span class="title class_">SharedAngularMaterialModule</span>,</span><br><span class="line">    <span class="title class_">DashboardRoutingModule</span></span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>

<p>修改路徑</p>
<p><code>src\app\app-routing.module.ts</code>中</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;dashboard&#x27;</span>, <span class="attr">pathMatch</span>: <span class="string">&#x27;full&#x27;</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dashboard\dashboard-routing.module.ts</code>中</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;dashboard&#x27;</span>, <span class="attr">component</span>: <span class="title class_">DashboardComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      </span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<h4 id="在加入處理資料庫的頁面"><a href="#在加入處理資料庫的頁面" class="headerlink" title="在加入處理資料庫的頁面"></a>在加入處理資料庫的頁面</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g component dashboard/DataBasePage</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dashboard\dashboard-routing.module.ts</code>中修改一下</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;dashboard&#x27;</span>, <span class="attr">component</span>: <span class="title class_">DashboardComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;dbpage&#x27;</span>, <span class="attr">pathMatch</span>: <span class="string">&#x27;full&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;dbpage&#x27;</span>, <span class="attr">component</span>: <span class="title class_">DataBasePageComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dashboard\dashboard.component.html</code>中修改</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mat-toolbar</span> <span class="attr">class</span>=<span class="string">&quot;demo-app-header&quot;</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-icon-button</span> (<span class="attr">click</span>)=<span class="string">&quot;sideNav.toggle()&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-icon</span>&gt;</span>&#123;&#123;sideNav.opened ? &#x27;close&#x27;:&#x27;menu&#x27;&#125;&#125;<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>動態元件 demo<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 在這之後的都會被推到右邊去 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toolbar-seprator&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-icon-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-icon</span>&gt;</span>message<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-icon-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-icon</span>&gt;</span>exit_to_app<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-toolbar</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-sidenav-container</span> <span class="attr">class</span>=<span class="string">&quot;demo-app-container&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-sidenav</span> <span class="attr">class</span>=<span class="string">&quot;demo-app-sidenav&quot;</span> #<span class="attr">sideNav</span> <span class="attr">mode</span>=<span class="string">&quot;push&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-nav-list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h3</span> <span class="attr">matSubheader</span>&gt;</span>示範用頁面<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/&#x27;, &#x27;dashboard&#x27;, &#x27;survey&#x27;]&quot;</span> <span class="attr">mat-list-item</span>&gt;</span>問卷調查<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/&#x27;, &#x27;dashboard&#x27;, &#x27;blog&#x27;]&quot;</span> <span class="attr">mat-list-item</span>&gt;</span>部落格<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/&#x27;, &#x27;dashboard&#x27;, &#x27;inbox&#x27;]&quot;</span> <span class="attr">mat-list-item</span>&gt;</span>收件夾<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-divider</span>&gt;</span><span class="tag">&lt;/<span class="name">mat-divider</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 另外一組選單 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h3</span> <span class="attr">matSubheader</span>&gt;</span>管理資料庫<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/&#x27;,&#x27;dashboard&#x27;,&#x27;dbpage&#x27;]&quot;</span> <span class="attr">mat-list-item</span>&gt;</span>資料庫<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-nav-list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-sidenav</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-sidenav-content</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;width: 100%;height: 20em;background-color: blueviolet&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-outlet</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-sidenav-content</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-sidenav-container</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="產生加入資料庫的Dialog"><a href="#產生加入資料庫的Dialog" class="headerlink" title="產生加入資料庫的Dialog"></a>產生加入資料庫的Dialog</h5><p>因為要使用對話框來加入資料庫的資料，所以來產生一下對話框</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g c dialog/add-database-dialog</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dialog\add-database-dialog\add-database-dialog.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">mat-dialog-title</span>&gt;</span>新增資料庫連紿<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-dialog-content</span> <span class="attr">class</span>=<span class="string">&quot;post-form&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">matInput</span> <span class="attr">placeholder</span>=<span class="string">&quot;資料庫鍵值&quot;</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;dbinof.dbkey&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">matInput</span> <span class="attr">placeholder</span>=<span class="string">&quot;資料庫連結&quot;</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;dbinof.dburl&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-dialog-content</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-dialog-actions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;Add()&quot;</span>&gt;</span>加入<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">mat-dialog-close</span> <span class="attr">color</span>=<span class="string">&quot;warn&quot;</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-dialog-actions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dialog\add-database-dialog\add-database-dialog.component.ts</code>中有<code>Add()</code>的功能來加入資料到python的後台，之後在關畢對話框時，重新來刷新頁面來讀取新的資料庫列表。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialogRef</span>, <span class="title class_">MatDialog</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DataBaseInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/models/database&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ToasterService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/toaster.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DbInfoService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/db-info.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-add-database-dialog&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./add-database-dialog.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./add-database-dialog.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AddDatabaseDialogComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="attr">dbinof</span>: <span class="title class_">DataBaseInfo</span> = <span class="keyword">new</span> <span class="title class_">DataBaseInfo</span>();</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> dialogRef: MatDialogRef&lt;AddDatabaseDialogComponent&gt;,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dbinfoservice: DbInfoService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialog: MatDialog,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> toasterService: ToasterService</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//加入database的資料</span></span><br><span class="line">  <span class="title class_">Add</span>() &#123;</span><br><span class="line">    <span class="comment">//console.log(this.dbinof);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dbinfoservice</span>.<span class="title function_">addDataBaseInfo</span>(<span class="variable language_">this</span>.<span class="property">dbinof</span>).<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;success------------------&#x27;</span> + data);</span><br><span class="line">        <span class="comment">//this.getDBInfos();</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(data.<span class="property">message</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dialogRef</span>.<span class="title function_">close</span>();</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(error.<span class="property">error</span>.<span class="property">message</span>);</span><br><span class="line">        <span class="comment">//this.toasterService.showToaster(error.error.message);</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dialogRef</span>.<span class="title function_">close</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在資料庫的頁面<code>src\app\dashboard\data-base-page\data-base-page.component.html</code>中加入</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">資料庫</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-raised-button</span> (<span class="attr">click</span>)=<span class="string">&quot;shwoAddDataBaseDialog()&quot;</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span>新增資料庫<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">資料庫列表</span><br><span class="line"><span class="tag">&lt;<span class="name">mat-table</span> #<span class="attr">table</span> [<span class="attr">dataSource</span>]=<span class="string">&quot;dataSource&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;dbkey&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span>資料庫主鍵<span class="tag">&lt;/<span class="name">mat-header-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row&quot;</span>&gt;</span>&#123;&#123;row.dbkey&#125;&#125; <span class="tag">&lt;/<span class="name">mat-cell</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;dburl&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span>資料庫連結<span class="tag">&lt;/<span class="name">mat-header-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row&quot;</span>&gt;</span>&#123;&#123;row.dburl&#125;&#125; <span class="tag">&lt;/<span class="name">mat-cell</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;management&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">u</span>&gt;</span>管理<span class="tag">&lt;/<span class="name">u</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-header-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span>回覆<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">color</span>=<span class="string">&quot;warn&quot;</span>&gt;</span>刪除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-cell</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-header-row</span> *<span class="attr">matHeaderRowDef</span>=<span class="string">&quot;[&#x27;dbkey&#x27;,&#x27;dburl&#x27;,&#x27;management&#x27;]&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">mat-header-row</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-row</span> *<span class="attr">matRowDef</span>=<span class="string">&quot;let eachrows;columns:[&#x27;dbkey&#x27;,&#x27;dburl&#x27;,&#x27;management&#x27;]&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">mat-row</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在處理的主要程式<code>src\app\dashboard\data-base-page\data-base-page.component.ts</code>中加入</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DbInfoService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/db-info.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DataBaseInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/models/database&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ToasterService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/toaster.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatTableDataSource</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/table&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialog</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AddDatabaseDialogComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/dialog/add-database-dialog/add-database-dialog.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-data-base-page&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./data-base-page.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./data-base-page.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DataBasePageComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  dataSource = <span class="keyword">new</span> <span class="title class_">MatTableDataSource</span>&lt;<span class="built_in">any</span>&gt;();</span><br><span class="line">  <span class="attr">totalCount</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="attr">dbinof</span>: <span class="title class_">DataBaseInfo</span> = <span class="keyword">new</span> <span class="title class_">DataBaseInfo</span>();</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dbinfoservice: DbInfoService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialog: MatDialog,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> toasterService: ToasterService</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getDBInfos</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getDBInfos</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(&#x27;getDBInfos------------------&#x27;);</span></span><br><span class="line">    <span class="comment">// //curdblist = [];</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dbinfoservice</span>.<span class="title function_">getDBInfos</span>().<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(res);</span></span><br><span class="line">        <span class="comment">//this.dblist = res;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dataSource</span>.<span class="property">data</span> = res;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(error.<span class="property">statusText</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">shwoAddDataBaseDialog</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> dialogRef = <span class="variable language_">this</span>.<span class="property">dialog</span>.<span class="title function_">open</span>(<span class="title class_">AddDatabaseDialogComponent</span>);</span><br><span class="line">    dialogRef.<span class="title function_">afterClosed</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(&quot;對話框被關畢&quot;);</span></span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">getDBInfos</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在主要呼叫對話框是在<code>shwoAddDataBaseDialog()</code>裏的<code>this.dialog.open</code>將要呼叫的對話框的元件傳入，即可呼叫會回傳它的參考傳，可以接起來，之後在對話框關畢的時候可以來訂閱它，收到之後可以重新來取資料庫的列表，在<code>src\app\dashboard\dashboard.module.ts</code>的模組，要將對話框的元件加入</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">CommonModule</span>,</span><br><span class="line">    <span class="title class_">FormsModule</span>,</span><br><span class="line">    <span class="title class_">SharedAngularMaterialModule</span>,</span><br><span class="line">    <span class="title class_">DashboardRoutingModule</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">entryComponents</span>: [<span class="title class_">AddDatabaseDialogComponent</span>]</span><br></pre></td></tr></table></figure>

<h5 id="加入刪除資料庫的Dialog"><a href="#加入刪除資料庫的Dialog" class="headerlink" title="加入刪除資料庫的Dialog"></a>加入刪除資料庫的Dialog</h5><p>先來產生刪除的對話框，這個對話框在之後有刪除使用者也可以使用到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g component dialog/delete-database-dialog</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dialog\delete-database-dialog\delete-database-dialog.component.html</code>中加入</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">mat-dialog-title</span>&gt;</span>移除資料庫的連結<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-dialog-content</span>&gt;</span></span><br><span class="line">  確定要移除這資料庫的連結？<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  資料庫主鍵-&gt; &#123;&#123;dbkey&#125;&#125; 資料庫連結-&gt; &#123;&#123;dburl&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-dialog-content</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-dialog-actions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;confirm()&quot;</span>&gt;</span>確認<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">mat-dialog-close</span> <span class="attr">color</span>=<span class="string">&quot;warn&quot;</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-dialog-actions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dialog\delete-database-dialog\delete-database-dialog.component.ts</code>中加入</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span>, <span class="title class_">Inject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialog</span>, <span class="variable constant_">MAT_DIALOG_DATA</span>, <span class="title class_">MatDialogRef</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DbInfoService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/db-info.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ToasterService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/toaster.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-delete-database-dialog&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./delete-database-dialog.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./delete-database-dialog.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DeleteDatabaseDialogComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">dbkey</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">dbinfo</span>.<span class="property">dbkey</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">dburl</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">dbinfo</span>.<span class="property">dburl</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dbinfoservice: DbInfoService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> toasterService: ToasterService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialogRef: MatDialogRef&lt;DeleteDatabaseDialogComponent&gt;,</span></span><br><span class="line"><span class="params">    <span class="meta">@Inject</span>(MAT_DIALOG_DATA) <span class="keyword">private</span> data: <span class="built_in">any</span></span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">confirm</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">delete</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">dbinfo</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">delete</span>(<span class="params">dbinfo</span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(dbinfo);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dbinfoservice</span>.<span class="title function_">delDataBaseInfo</span>(dbinfo).<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dialogRef</span>.<span class="title function_">close</span>();</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(res.<span class="property">message</span>);</span><br><span class="line">    &#125;, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(error.<span class="property">statusText</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dialogRef</span>.<span class="title function_">close</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在模組<code>src\app\dashboard\dashboard.module.ts</code>要加入</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="attr">entryComponents</span>: [<span class="title class_">AddDatabaseDialogComponent</span>,<span class="title class_">DeleteDialogComponent</span>]</span><br></pre></td></tr></table></figure>

<p>在資料庫的頁面<code>src\app\dashboard\data-base-page\data-base-page.component.html</code>中修改成如下，有加入移除的功能</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">資料庫</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-raised-button</span> (<span class="attr">click</span>)=<span class="string">&quot;shwoAddDataBaseDialog()&quot;</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span>新增資料庫<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">資料庫列表</span><br><span class="line"><span class="tag">&lt;<span class="name">mat-table</span> #<span class="attr">table</span> [<span class="attr">dataSource</span>]=<span class="string">&quot;dataSource&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;dbkey&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span>資料庫主鍵<span class="tag">&lt;/<span class="name">mat-header-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row;&quot;</span>&gt;</span>&#123;&#123;row.dbkey&#125;&#125;<span class="tag">&lt;/<span class="name">mat-cell</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;dburl&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span>資料庫連結<span class="tag">&lt;/<span class="name">mat-header-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row&quot;</span>&gt;</span>&#123;&#123;row.dburl&#125;&#125; <span class="tag">&lt;/<span class="name">mat-cell</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;management&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">u</span>&gt;</span>管理<span class="tag">&lt;/<span class="name">u</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-header-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row;&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- &lt;button mat-button color=&quot;primary&quot;&gt;回覆 &lt;/button&gt; --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> *<span class="attr">ngIf</span>=<span class="string">&quot;row.dbkey!=&#x27;&#x27;&quot;</span> <span class="attr">mat-button</span> <span class="attr">color</span>=<span class="string">&quot;warn&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;showDeleteDialog(row)&quot;</span>&gt;</span>移除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-cell</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-header-row</span> *<span class="attr">matHeaderRowDef</span>=<span class="string">&quot;[&#x27;dbkey&#x27;,&#x27;dburl&#x27;,&#x27;management&#x27;]&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">mat-header-row</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-row</span> *<span class="attr">matRowDef</span>=<span class="string">&quot;let eachrows;columns:[&#x27;dbkey&#x27;,&#x27;dburl&#x27;,&#x27;management&#x27;]&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">mat-row</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-table</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在處理的主要程式<code>src\app\dashboard\data-base-page\data-base-page.component.ts</code>中修改</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DbInfoService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/db-info.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DataBaseInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/models/database&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ToasterService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/toaster.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatTableDataSource</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/table&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialog</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AddDatabaseDialogComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/dialog/add-database-dialog/add-database-dialog.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DeleteDatabaseDialogComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/dialog/delete-database-dialog/delete-database-dialog.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-data-base-page&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./data-base-page.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./data-base-page.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DataBasePageComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  dataSource = <span class="keyword">new</span> <span class="title class_">MatTableDataSource</span>&lt;<span class="built_in">any</span>&gt;();</span><br><span class="line">  <span class="attr">totalCount</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="attr">dbinof</span>: <span class="title class_">DataBaseInfo</span> = <span class="keyword">new</span> <span class="title class_">DataBaseInfo</span>();</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dbinfoservice: DbInfoService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialog: MatDialog,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> toasterService: ToasterService</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getDBInfos</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getDBInfos</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(&#x27;getDBInfos------------------&#x27;);</span></span><br><span class="line">    <span class="comment">// //curdblist = [];</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dbinfoservice</span>.<span class="title function_">getDBInfos</span>().<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(res);</span></span><br><span class="line">        <span class="comment">//this.dblist = res;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dataSource</span>.<span class="property">data</span> = res;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(error.<span class="property">statusText</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">shwoAddDataBaseDialog</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> dialogRef = <span class="variable language_">this</span>.<span class="property">dialog</span>.<span class="title function_">open</span>(<span class="title class_">AddDatabaseDialogComponent</span>);</span><br><span class="line">    dialogRef.<span class="title function_">afterClosed</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(&quot;對話框被關畢&quot;);</span></span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">getDBInfos</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 顯示刪除的對話框</span></span><br><span class="line">  <span class="title function_">showDeleteDialog</span>(<span class="params">row</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(row);</span><br><span class="line">    <span class="keyword">const</span> dialogRef = <span class="variable language_">this</span>.<span class="property">dialog</span>.<span class="title function_">open</span>(<span class="title class_">DeleteDatabaseDialogComponent</span>, &#123;</span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">dbinfo</span>: row</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    dialogRef.<span class="title function_">afterClosed</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">getDBInfos</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="加入處理使用者頁面"><a href="#加入處理使用者頁面" class="headerlink" title="加入處理使用者頁面"></a>加入處理使用者頁面</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g component dashboard/UserPage</span><br></pre></td></tr></table></figure>

<p>修改一下路徑<code>src\app\dashboard\dashboard-routing.module.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;dashboard&#x27;</span>, <span class="attr">component</span>: <span class="title class_">DashboardComponent</span>, <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;userpage&#x27;</span>, <span class="attr">pathMatch</span>: <span class="string">&#x27;full&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;userpage&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserPageComponent</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;dbpage&#x27;</span>, <span class="attr">component</span>: <span class="title class_">DataBasePageComponent</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dashboard\dashboard.component.html</code>中加入連結</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mat-toolbar</span> <span class="attr">class</span>=<span class="string">&quot;demo-app-header&quot;</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-icon-button</span> (<span class="attr">click</span>)=<span class="string">&quot;sideNav.toggle()&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-icon</span>&gt;</span>&#123;&#123;sideNav.opened ? &#x27;close&#x27;:&#x27;menu&#x27;&#125;&#125;<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>動態資料庫demo<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 在這之後的都會被推到右邊去 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toolbar-seprator&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-icon-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-icon</span>&gt;</span>message<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-icon-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-icon</span>&gt;</span>exit_to_app<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-toolbar</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-sidenav-container</span> <span class="attr">class</span>=<span class="string">&quot;demo-app-container&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-sidenav</span> <span class="attr">class</span>=<span class="string">&quot;demo-app-sidenav&quot;</span> #<span class="attr">sideNav</span> <span class="attr">mode</span>=<span class="string">&quot;push&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-nav-list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h3</span> <span class="attr">matSubheader</span>&gt;</span>使用者相關<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/&#x27;, &#x27;dashboard&#x27;, &#x27;userpage&#x27;]&quot;</span> <span class="attr">mat-list-item</span>&gt;</span>使用者<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-divider</span>&gt;</span><span class="tag">&lt;/<span class="name">mat-divider</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 另外一組選單 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h3</span> <span class="attr">matSubheader</span>&gt;</span>管理資料庫<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/&#x27;,&#x27;dashboard&#x27;,&#x27;dbpage&#x27;]&quot;</span> <span class="attr">mat-list-item</span>&gt;</span>資料庫<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-nav-list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-sidenav</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-sidenav-content</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;div style=&quot;width: 100%;height: 20em;background-color: blueviolet&quot;&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    &lt;/div&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-outlet</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-sidenav-content</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-sidenav-container</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="產生加入使用者的Dialog"><a href="#產生加入使用者的Dialog" class="headerlink" title="產生加入使用者的Dialog"></a>產生加入使用者的Dialog</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g component dialog/add-user-dialog</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dialog\add-user-dialog\add-user-dialog.component.html</code>中修改</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">mat-dialog-title</span>&gt;</span>新增資料庫連紿<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-dialog-content</span> <span class="attr">class</span>=<span class="string">&quot;post-form&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">matInput</span> <span class="attr">placeholder</span>=<span class="string">&quot;資料庫鍵值&quot;</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;dbinof.dbkey&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">matInput</span> <span class="attr">placeholder</span>=<span class="string">&quot;資料庫連結&quot;</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;dbinof.dburl&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-dialog-content</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-dialog-actions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;Add()&quot;</span>&gt;</span>加入<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">mat-dialog-close</span> <span class="attr">color</span>=<span class="string">&quot;warn&quot;</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-dialog-actions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dialog\add-database-dialog\add-database-dialog.component.ts</code>中修改</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialogRef</span>, <span class="title class_">MatDialog</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DataBaseInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/models/database&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ToasterService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/toaster.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DbInfoService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/db-info.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-add-database-dialog&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./add-database-dialog.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./add-database-dialog.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AddDatabaseDialogComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="attr">dbinof</span>: <span class="title class_">DataBaseInfo</span> = <span class="keyword">new</span> <span class="title class_">DataBaseInfo</span>();</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> dialogRef: MatDialogRef&lt;AddDatabaseDialogComponent&gt;,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dbinfoservice: DbInfoService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialog: MatDialog,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> toasterService: ToasterService</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//加入database的資料</span></span><br><span class="line">  <span class="title class_">Add</span>() &#123;</span><br><span class="line">    <span class="comment">//console.log(this.dbinof);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dbinfoservice</span>.<span class="title function_">addDataBaseInfo</span>(<span class="variable language_">this</span>.<span class="property">dbinof</span>).<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(&#x27;success------------------&#x27; + data);</span></span><br><span class="line">        <span class="comment">//this.getDBInfos();</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(data.<span class="property">message</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dialogRef</span>.<span class="title function_">close</span>();</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(error.<span class="property">error</span>.<span class="property">message</span>);</span><br><span class="line">        <span class="comment">//this.toasterService.showToaster(error.error.message);</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dialogRef</span>.<span class="title function_">close</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dashboard\user-page\user-page.component.html</code>中修改</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">使用者相關</span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-label</span>&gt;</span>選擇資料庫<span class="tag">&lt;/<span class="name">mat-label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-select</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;dbinfoservice.Seldbkey&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dbkey&quot;</span> (<span class="attr">ngModelChange</span>)=<span class="string">&quot;onDBSelection()&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-option</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let db of dblist&quot;</span> [<span class="attr">value</span>]=<span class="string">&quot;db.dbkey&quot;</span>&gt;</span></span><br><span class="line">      &#123;&#123;db.dbkey&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-option</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">加入使用者</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> [<span class="attr">disabled</span>]=<span class="string">&quot;!dbinfoservice.Seldbkey&quot;</span> <span class="attr">mat-raised-button</span> (<span class="attr">click</span>)=<span class="string">&quot;showAddUserDialog()&quot;</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span>加入<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">使用者列表</span><br><span class="line"><span class="tag">&lt;<span class="name">mat-paginator</span> #<span class="attr">paginator</span> [<span class="attr">length</span>]=<span class="string">&quot;totalCount&quot;</span> [<span class="attr">pageIndex</span>]=<span class="string">&quot;0&quot;</span> [<span class="attr">pageSize</span>]=<span class="string">&quot;pageSize&quot;</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">pageSizeOptions</span>]=<span class="string">&quot;pageSizeOptions&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-paginator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-table</span> #<span class="attr">table</span> [<span class="attr">dataSource</span>]=<span class="string">&quot;dataSource&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span>姓名<span class="tag">&lt;/<span class="name">mat-header-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row;&quot;</span>&gt;</span>&#123;&#123;row.name&#125;&#125;<span class="tag">&lt;/<span class="name">mat-cell</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;username&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span>暱稱<span class="tag">&lt;/<span class="name">mat-header-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row&quot;</span>&gt;</span>&#123;&#123;row.username&#125;&#125; <span class="tag">&lt;/<span class="name">mat-cell</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;management&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">u</span>&gt;</span>管理<span class="tag">&lt;/<span class="name">u</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-header-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row;&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- &lt;button mat-button color=&quot;primary&quot;&gt;回覆 &lt;/button&gt; --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> *<span class="attr">ngIf</span>=<span class="string">&quot;row.dbkey!=&#x27;&#x27;&quot;</span> <span class="attr">mat-button</span> <span class="attr">color</span>=<span class="string">&quot;warn&quot;</span>&gt;</span>刪除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-cell</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-header-row</span> *<span class="attr">matHeaderRowDef</span>=<span class="string">&quot;[&#x27;name&#x27;,&#x27;username&#x27;,&#x27;management&#x27;]&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">mat-header-row</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-row</span> *<span class="attr">matRowDef</span>=<span class="string">&quot;let eachrows;columns:[&#x27;name&#x27;,&#x27;username&#x27;,&#x27;management&#x27;]&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">mat-row</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-table</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dashboard\user-page\user-page.component.ts</code>中修改</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span>, <span class="title class_">ViewChild</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DataBaseInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/models/database&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DbInfoService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/db-info.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/models/user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatTableDataSource</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/table&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ToasterService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/toaster.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatPaginator</span>, <span class="title class_">PageEvent</span>, <span class="title class_">MatPaginatorIntl</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/paginator&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialog</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AddUserDialogComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/dialog/add-user-dialog/add-user-dialog.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-user-page&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./user-page.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./user-page.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserPageComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="comment">//分頁功能</span></span><br><span class="line">  <span class="meta">@ViewChild</span>(<span class="title class_">MatPaginator</span>, &#123; <span class="attr">static</span>: <span class="literal">true</span> &#125;) <span class="attr">paginator</span>: <span class="title class_">MatPaginator</span>;</span><br><span class="line">  <span class="attr">totalCount</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">  pageSize = <span class="number">2</span>;</span><br><span class="line">  <span class="attr">pageSizeOptions</span>: <span class="built_in">number</span>[] = [<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>];</span><br><span class="line">  <span class="keyword">private</span> userUrl = <span class="string">&quot;http://localhost:3000&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attr">dblist</span>: <span class="title class_">DataBaseInfo</span>[] = [];</span><br><span class="line">  dataSource = <span class="keyword">new</span> <span class="title class_">MatTableDataSource</span>&lt;<span class="built_in">any</span>&gt;();</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialog: MatDialog,</span></span><br><span class="line"><span class="params">    <span class="keyword">public</span> dbinfoservice: DbInfoService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> userservice: UserService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> toasterService: ToasterService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> matPaginatorIntl: MatPaginatorIntl, </span>) &#123; &#125;</span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getDBInfos</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分頁切換時，重新取得資料</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paginator</span>.<span class="property">page</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">page: PageEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(`pageIndex=$&#123;page.pageIndex&#125;:pageSize=$&#123;page.pageSize&#125;`);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">getPages</span>(page.<span class="property">pageIndex</span>, page.<span class="property">pageSize</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 設定顯示筆數資訊文字</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">getRangeLabel</span> = (<span class="attr">page</span>: <span class="built_in">number</span>, <span class="attr">pageSize</span>: <span class="built_in">number</span>, <span class="attr">length</span>: <span class="built_in">number</span>): <span class="function"><span class="params">string</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (length === <span class="number">0</span> || pageSize === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`第 0 筆、共  <span class="subst">$&#123;length&#125;</span> 筆`</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      length = <span class="title class_">Math</span>.<span class="title function_">max</span>(length, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">const</span> startIndex = page * pageSize;</span><br><span class="line">      <span class="keyword">const</span> ednIndex = startIndex &lt; length ? <span class="title class_">Math</span>.<span class="title function_">min</span>(startIndex + pageSize, length) : startIndex + pageSize;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`第 <span class="subst">$&#123;startIndex + <span class="number">1</span>&#125;</span> - <span class="subst">$&#123;ednIndex&#125;</span> 筆、共  <span class="subst">$&#123;length&#125;</span> 筆`</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 設定其他顯示資訊文字</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">itemsPerPageLabel</span> = <span class="string">&#x27;每頁筆數：&#x27;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">nextPageLabel</span> = <span class="string">&#x27;下一頁&#x27;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">previousPageLabel</span> = <span class="string">&#x27;上一頁&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getDBInfos</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(&#x27;getDBInfos------------------&#x27;);</span></span><br><span class="line">    <span class="comment">// //curdblist = [];</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dbinfoservice</span>.<span class="title function_">getDBInfos</span>().<span class="title function_">subscribe</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      res.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(item);</span></span><br><span class="line">        <span class="keyword">if</span> (item.<span class="property">dbkey</span> == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">          item.<span class="property">dbkey</span> = <span class="string">&quot;default&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dblist</span> = res;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onDBSelection</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> fmt = <span class="string">`onDBSelection:Seldbkey=<span class="subst">$&#123;<span class="variable language_">this</span>.dbinfoservice.Seldbkey&#125;</span>`</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(fmt);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getPages</span>(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//分頁功能相關</span></span><br><span class="line">  <span class="title function_">getPages</span>(<span class="params">pageIndex, PageSize</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userservice</span>.<span class="title function_">getUsers</span>(<span class="variable language_">this</span>.<span class="property">dbinfoservice</span>.<span class="property">Seldbkey</span>, pageIndex, <span class="title class_">PageSize</span>).<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">resp</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(res);</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dataSource</span>.<span class="property">data</span> = resp.<span class="property">body</span>;</span><br><span class="line">        <span class="comment">// //分頁功能</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">totalCount</span> = <span class="title class_">Number</span>(resp.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;X-Total-Count&#x27;</span>));</span><br><span class="line">        <span class="comment">//console.log(resp.headers.get(&#x27;X-Total-Count&#x27;));</span></span><br><span class="line">        <span class="comment">// 從後端取得資料時，就不用指定data srouce的paginator了</span></span><br><span class="line">        <span class="comment">//this.dataSource.paginator = this.paginator;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(error.<span class="property">statusText</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 顯示加入使用者</span></span><br><span class="line">  <span class="title function_">showAddUserDialog</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> dialogRef = <span class="variable language_">this</span>.<span class="property">dialog</span>.<span class="title function_">open</span>(<span class="title class_">AddUserDialogComponent</span>);</span><br><span class="line">    dialogRef.<span class="title function_">afterClosed</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">paginator</span>.<span class="property">pageSize</span> = <span class="variable language_">this</span>.<span class="property">pageSize</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onDBSelection</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="加入刪除使用者的Dialog"><a href="#加入刪除使用者的Dialog" class="headerlink" title="加入刪除使用者的Dialog"></a>加入刪除使用者的Dialog</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g component dialog/delete-user-dialog</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dialog\delete-user-dialog\delete-user-dialog.component.html</code>中加入</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">mat-dialog-title</span>&gt;</span>刪除使用者<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-dialog-content</span>&gt;</span></span><br><span class="line">  確定要刪除這使用者？<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  名稱-&gt; &#123;&#123;name&#125;&#125; 暱稱-&gt; &#123;&#123;username&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-dialog-content</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-dialog-actions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;confirm()&quot;</span>&gt;</span>確認<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">mat-dialog-close</span> <span class="attr">color</span>=<span class="string">&quot;warn&quot;</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-dialog-actions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dialog\delete-user-dialog\delete-user-dialog.component.ts</code>中加入</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span>, <span class="title class_">Inject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">MAT_DIALOG_DATA</span>, <span class="title class_">MatDialogRef</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ToasterService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/toaster.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@<span class="title class_">Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-delete-user-dialog&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./delete-user-dialog.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./delete-user-dialog.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DeleteUserDialogComponent</span> implements <span class="title class_">OnInit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">name</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">iteminfo</span>.<span class="property">name</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">username</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">iteminfo</span>.<span class="property">username</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    private dialogRef: MatDialogRef&lt;DeleteUserDialogComponent&gt;,</span></span><br><span class="line"><span class="params">    private userservice: UserService,</span></span><br><span class="line"><span class="params">    private toasterService: ToasterService,</span></span><br><span class="line"><span class="params">    @Inject(MAT_DIALOG_DATA) private data: any</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">confirm</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">delete</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">iteminfo</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">delete</span>(<span class="params">iteminfo</span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(iteminfo);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userservice</span>.<span class="title function_">delUser</span>(iteminfo).<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dialogRef</span>.<span class="title function_">close</span>();</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(res.<span class="property">message</span>);</span><br><span class="line">    &#125;, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(error.<span class="property">statusText</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dialogRef</span>.<span class="title function_">close</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dashboard\user-page\user-page.component.ts</code>中加入</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span>, <span class="title class_">ViewChild</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DataBaseInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/models/database&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DbInfoService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/db-info.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/models/user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatTableDataSource</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/table&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ToasterService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/toaster.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatPaginator</span>, <span class="title class_">PageEvent</span>, <span class="title class_">MatPaginatorIntl</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/paginator&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialog</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AddUserDialogComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/dialog/add-user-dialog/add-user-dialog.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DeleteUserDialogComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/dialog/delete-user-dialog/delete-user-dialog.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@<span class="title class_">Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-user-page&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./user-page.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./user-page.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserPageComponent</span> implements <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="comment">//分頁功能</span></span><br><span class="line">  @<span class="title class_">ViewChild</span>(<span class="title class_">MatPaginator</span>, &#123; <span class="attr">static</span>: <span class="literal">true</span> &#125;) <span class="attr">paginator</span>: <span class="title class_">MatPaginator</span>;</span><br><span class="line">  <span class="attr">totalCount</span>: number = <span class="number">0</span>;</span><br><span class="line">  pageSize = <span class="number">2</span>;</span><br><span class="line">  <span class="attr">pageSizeOptions</span>: number[] = [<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>];</span><br><span class="line">  private userUrl = <span class="string">&quot;http://localhost:3000&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attr">dblist</span>: <span class="title class_">DataBaseInfo</span>[] = [];</span><br><span class="line">  dataSource = <span class="keyword">new</span> <span class="title class_">MatTableDataSource</span>&lt;any&gt;();</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    private dialog: MatDialog,</span></span><br><span class="line"><span class="params">    public dbinfoservice: DbInfoService,</span></span><br><span class="line"><span class="params">    private userservice: UserService,</span></span><br><span class="line"><span class="params">    private toasterService: ToasterService,</span></span><br><span class="line"><span class="params">    private matPaginatorIntl: MatPaginatorIntl, </span>) &#123; &#125;</span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getDBInfos</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分頁切換時，重新取得資料</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paginator</span>.<span class="property">page</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">page: PageEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(`pageIndex=$&#123;page.pageIndex&#125;:pageSize=$&#123;page.pageSize&#125;`);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">getPages</span>(page.<span class="property">pageIndex</span>, page.<span class="property">pageSize</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 設定顯示筆數資訊文字</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">getRangeLabel</span> = (<span class="attr">page</span>: number, <span class="attr">pageSize</span>: number, <span class="attr">length</span>: number): <span class="function"><span class="params">string</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (length === <span class="number">0</span> || pageSize === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`第 0 筆、共  <span class="subst">$&#123;length&#125;</span> 筆`</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      length = <span class="title class_">Math</span>.<span class="title function_">max</span>(length, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">const</span> startIndex = page * pageSize;</span><br><span class="line">      <span class="keyword">const</span> ednIndex = startIndex &lt; length ? <span class="title class_">Math</span>.<span class="title function_">min</span>(startIndex + pageSize, length) : startIndex + pageSize;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`第 <span class="subst">$&#123;startIndex + <span class="number">1</span>&#125;</span> - <span class="subst">$&#123;ednIndex&#125;</span> 筆、共  <span class="subst">$&#123;length&#125;</span> 筆`</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 設定其他顯示資訊文字</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">itemsPerPageLabel</span> = <span class="string">&#x27;每頁筆數：&#x27;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">nextPageLabel</span> = <span class="string">&#x27;下一頁&#x27;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">previousPageLabel</span> = <span class="string">&#x27;上一頁&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getDBInfos</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(&#x27;getDBInfos------------------&#x27;);</span></span><br><span class="line">    <span class="comment">// //curdblist = [];</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dbinfoservice</span>.<span class="title function_">getDBInfos</span>().<span class="title function_">subscribe</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      res.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(item);</span></span><br><span class="line">        <span class="keyword">if</span> (item.<span class="property">dbkey</span> == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">          item.<span class="property">dbkey</span> = <span class="string">&quot;default&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dblist</span> = res;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onDBSelection</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> fmt = <span class="string">`onDBSelection:Seldbkey=<span class="subst">$&#123;<span class="variable language_">this</span>.dbinfoservice.Seldbkey&#125;</span>`</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(fmt);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getPages</span>(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//分頁功能相關</span></span><br><span class="line">  <span class="title function_">getPages</span>(<span class="params">pageIndex, PageSize</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userservice</span>.<span class="title function_">getUsers</span>(<span class="variable language_">this</span>.<span class="property">dbinfoservice</span>.<span class="property">Seldbkey</span>, pageIndex, <span class="title class_">PageSize</span>).<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">resp</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(res);</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dataSource</span>.<span class="property">data</span> = resp.<span class="property">body</span>;</span><br><span class="line">        <span class="comment">// //分頁功能</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">totalCount</span> = <span class="title class_">Number</span>(resp.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;X-Total-Count&#x27;</span>));</span><br><span class="line">        <span class="comment">//console.log(resp.headers.get(&#x27;X-Total-Count&#x27;));</span></span><br><span class="line">        <span class="comment">// 從後端取得資料時，就不用指定data srouce的paginator了</span></span><br><span class="line">        <span class="comment">//this.dataSource.paginator = this.paginator;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(error.<span class="property">statusText</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">reloaduser</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paginator</span>.<span class="property">pageSize</span> = <span class="variable language_">this</span>.<span class="property">pageSize</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">onDBSelection</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 顯示加入使用者</span></span><br><span class="line">  <span class="title function_">showAddUserDialog</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> dialogRef = <span class="variable language_">this</span>.<span class="property">dialog</span>.<span class="title function_">open</span>(<span class="title class_">AddUserDialogComponent</span>);</span><br><span class="line">    dialogRef.<span class="title function_">afterClosed</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reloaduser</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 顯示刪除的對話框</span></span><br><span class="line">  <span class="title function_">showDeleteUserDialog</span>(<span class="params">row</span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(row);</span></span><br><span class="line">    <span class="keyword">const</span> dialogRef = <span class="variable language_">this</span>.<span class="property">dialog</span>.<span class="title function_">open</span>(<span class="title class_">DeleteUserDialogComponent</span>, &#123;</span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">iteminfo</span>: row</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    dialogRef.<span class="title function_">afterClosed</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reloaduser</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="加入修改使用者"><a href="#加入修改使用者" class="headerlink" title="加入修改使用者"></a>加入修改使用者</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g component dialog/modify-user-dialog</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dialog\delete-user-dialog\delete-user-dialog.component.ts</code>中加入</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">mat-dialog-title</span>&gt;</span>修改使用者<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-dialog-content</span>&gt;</span></span><br><span class="line">  確定要修改這使用者？<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  名稱-&gt; &#123;&#123;name&#125;&#125; 暱稱-&gt; &#123;&#123;username&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-dialog-content</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-dialog-actions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;confirm()&quot;</span>&gt;</span>確認<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-button</span> <span class="attr">mat-dialog-close</span> <span class="attr">color</span>=<span class="string">&quot;warn&quot;</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-dialog-actions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dialog\modify-user-dialog\modify-user-dialog.component.ts</code>中加入</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span>, <span class="title class_">Inject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialogRef</span>, <span class="variable constant_">MAT_DIALOG_DATA</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ToasterService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/toaster.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-modify-user-dialog&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./modify-user-dialog.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./modify-user-dialog.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ModifyUserDialogComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">name</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">iteminfo</span>.<span class="property">name</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">username</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">iteminfo</span>.<span class="property">username</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialogRef: MatDialogRef&lt;ModifyUserDialogComponent&gt;,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> userservice: UserService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> toasterService: ToasterService,</span></span><br><span class="line"><span class="params">    <span class="meta">@Inject</span>(MAT_DIALOG_DATA) <span class="keyword">private</span> data: <span class="built_in">any</span></span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">confirm</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">modify</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">iteminfo</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">modify</span>(<span class="params">iteminfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userservice</span>.<span class="title function_">modify</span>(iteminfo).<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dialogRef</span>.<span class="title function_">close</span>();</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(res.<span class="property">message</span>);</span><br><span class="line">    &#125;, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dialogRef</span>.<span class="title function_">close</span>();</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(error.<span class="property">statusText</span>);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dashboard\user-page\user-page.component.html</code>中加入修改使用者</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">使用者相關</span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-label</span>&gt;</span>選擇資料庫<span class="tag">&lt;/<span class="name">mat-label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-select</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;dbinfoservice.Seldbkey&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dbkey&quot;</span> (<span class="attr">ngModelChange</span>)=<span class="string">&quot;onDBSelection()&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-option</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let db of dblist&quot;</span> [<span class="attr">value</span>]=<span class="string">&quot;db.dbkey&quot;</span>&gt;</span></span><br><span class="line">      &#123;&#123;db.dbkey&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-option</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">加入使用者</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> [<span class="attr">disabled</span>]=<span class="string">&quot;!dbinfoservice.Seldbkey&quot;</span> <span class="attr">mat-raised-button</span> (<span class="attr">click</span>)=<span class="string">&quot;showAddUserDialog()&quot;</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span>加入<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">使用者列表</span><br><span class="line"><span class="tag">&lt;<span class="name">mat-paginator</span> #<span class="attr">paginator</span> [<span class="attr">length</span>]=<span class="string">&quot;totalCount&quot;</span> [<span class="attr">pageIndex</span>]=<span class="string">&quot;0&quot;</span> [<span class="attr">pageSize</span>]=<span class="string">&quot;pageSize&quot;</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">pageSizeOptions</span>]=<span class="string">&quot;pageSizeOptions&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-paginator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mat-table</span> #<span class="attr">table</span> [<span class="attr">dataSource</span>]=<span class="string">&quot;dataSource&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span>姓名<span class="tag">&lt;/<span class="name">mat-header-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-form-field</span> <span class="attr">floatLabel</span>=<span class="string">&quot;never&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">matInput</span> <span class="attr">placeholder</span>=<span class="string">&quot;Name&quot;</span> [<span class="attr">value</span>]=<span class="string">&quot;row.name&quot;</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;row.name&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-cell</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;username&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span>暱稱<span class="tag">&lt;/<span class="name">mat-header-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row&quot;</span>&gt;</span>&#123;&#123;row.username&#125;&#125; <span class="tag">&lt;/<span class="name">mat-cell</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">matColumnDef</span>=<span class="string">&quot;management&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-header-cell</span> *<span class="attr">matHeaderCellDef</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">u</span>&gt;</span>管理<span class="tag">&lt;/<span class="name">u</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-header-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-cell</span> *<span class="attr">matCellDef</span>=<span class="string">&quot;let row;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> *<span class="attr">ngIf</span>=<span class="string">&quot;row.dbkey!=&#x27;&#x27;&quot;</span> <span class="attr">mat-button</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;showModifyUserDialog(row)&quot;</span>&gt;</span>修改 <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> *<span class="attr">ngIf</span>=<span class="string">&quot;row.dbkey!=&#x27;&#x27;&quot;</span> <span class="attr">mat-button</span> <span class="attr">color</span>=<span class="string">&quot;warn&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;showDeleteUserDialog(row)&quot;</span>&gt;</span>刪除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-cell</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-header-row</span> *<span class="attr">matHeaderRowDef</span>=<span class="string">&quot;[&#x27;name&#x27;,&#x27;username&#x27;,&#x27;management&#x27;]&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">mat-header-row</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-row</span> *<span class="attr">matRowDef</span>=<span class="string">&quot;let eachrows;columns:[&#x27;name&#x27;,&#x27;username&#x27;,&#x27;management&#x27;]&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">mat-row</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mat-table</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\dashboard\user-page\user-page.component.ts</code>中加入修改使用者</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span>, <span class="title class_">ViewChild</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DataBaseInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/models/database&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DbInfoService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/db-info.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/models/user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatTableDataSource</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/table&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ToasterService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/services/toaster.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatPaginator</span>, <span class="title class_">PageEvent</span>, <span class="title class_">MatPaginatorIntl</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/paginator&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialog</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AddUserDialogComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/dialog/add-user-dialog/add-user-dialog.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DeleteUserDialogComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/dialog/delete-user-dialog/delete-user-dialog.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ModifyUserDialogComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/dialog/modify-user-dialog/modify-user-dialog.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-user-page&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./user-page.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./user-page.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserPageComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="comment">//分頁功能</span></span><br><span class="line">  <span class="meta">@ViewChild</span>(<span class="title class_">MatPaginator</span>, &#123; <span class="attr">static</span>: <span class="literal">true</span> &#125;) <span class="attr">paginator</span>: <span class="title class_">MatPaginator</span>;</span><br><span class="line">  <span class="attr">totalCount</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">  pageSize = <span class="number">2</span>;</span><br><span class="line">  <span class="attr">pageSizeOptions</span>: <span class="built_in">number</span>[] = [<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>];</span><br><span class="line">  <span class="keyword">private</span> userUrl = <span class="string">&quot;http://localhost:3000&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attr">dblist</span>: <span class="title class_">DataBaseInfo</span>[] = [];</span><br><span class="line">  dataSource = <span class="keyword">new</span> <span class="title class_">MatTableDataSource</span>&lt;<span class="built_in">any</span>&gt;();</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialog: MatDialog,</span></span><br><span class="line"><span class="params">    <span class="keyword">public</span> dbinfoservice: DbInfoService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> userservice: UserService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> toasterService: ToasterService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> matPaginatorIntl: MatPaginatorIntl, </span>) &#123; &#125;</span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getDBInfos</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分頁切換時，重新取得資料</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paginator</span>.<span class="property">page</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">page: PageEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(`pageIndex=$&#123;page.pageIndex&#125;:pageSize=$&#123;page.pageSize&#125;`);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">getPages</span>(page.<span class="property">pageIndex</span>, page.<span class="property">pageSize</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 設定顯示筆數資訊文字</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">getRangeLabel</span> = (<span class="attr">page</span>: <span class="built_in">number</span>, <span class="attr">pageSize</span>: <span class="built_in">number</span>, <span class="attr">length</span>: <span class="built_in">number</span>): <span class="function"><span class="params">string</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (length === <span class="number">0</span> || pageSize === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`第 0 筆、共  <span class="subst">$&#123;length&#125;</span> 筆`</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      length = <span class="title class_">Math</span>.<span class="title function_">max</span>(length, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">const</span> startIndex = page * pageSize;</span><br><span class="line">      <span class="keyword">const</span> ednIndex = startIndex &lt; length ? <span class="title class_">Math</span>.<span class="title function_">min</span>(startIndex + pageSize, length) : startIndex + pageSize;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`第 <span class="subst">$&#123;startIndex + <span class="number">1</span>&#125;</span> - <span class="subst">$&#123;ednIndex&#125;</span> 筆、共  <span class="subst">$&#123;length&#125;</span> 筆`</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 設定其他顯示資訊文字</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">itemsPerPageLabel</span> = <span class="string">&#x27;每頁筆數：&#x27;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">nextPageLabel</span> = <span class="string">&#x27;下一頁&#x27;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">previousPageLabel</span> = <span class="string">&#x27;上一頁&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getDBInfos</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(&#x27;getDBInfos------------------&#x27;);</span></span><br><span class="line">    <span class="comment">// //curdblist = [];</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dbinfoservice</span>.<span class="title function_">getDBInfos</span>().<span class="title function_">subscribe</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      res.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(item);</span></span><br><span class="line">        <span class="keyword">if</span> (item.<span class="property">dbkey</span> == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">          item.<span class="property">dbkey</span> = <span class="string">&quot;default&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dblist</span> = res;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onDBSelection</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> fmt = <span class="string">`onDBSelection:Seldbkey=<span class="subst">$&#123;<span class="variable language_">this</span>.dbinfoservice.Seldbkey&#125;</span>`</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(fmt);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getPages</span>(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//分頁功能相關</span></span><br><span class="line">  <span class="title function_">getPages</span>(<span class="params">pageIndex, PageSize</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userservice</span>.<span class="title function_">getUsers</span>(<span class="variable language_">this</span>.<span class="property">dbinfoservice</span>.<span class="property">Seldbkey</span>, pageIndex, <span class="title class_">PageSize</span>).<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="function"><span class="params">resp</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(res);</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dataSource</span>.<span class="property">data</span> = resp.<span class="property">body</span>;</span><br><span class="line">        <span class="comment">// //分頁功能</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">totalCount</span> = <span class="title class_">Number</span>(resp.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;X-Total-Count&#x27;</span>));</span><br><span class="line">        <span class="comment">//console.log(resp.headers.get(&#x27;X-Total-Count&#x27;));</span></span><br><span class="line">        <span class="comment">// 從後端取得資料時，就不用指定data srouce的paginator了</span></span><br><span class="line">        <span class="comment">//this.dataSource.paginator = this.paginator;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">toasterService</span>.<span class="title function_">showToaster</span>(error.<span class="property">statusText</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">reloaduser</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paginator</span>.<span class="property">pageSize</span> = <span class="variable language_">this</span>.<span class="property">pageSize</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">onDBSelection</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 顯示加入使用者</span></span><br><span class="line">  <span class="title function_">showAddUserDialog</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> dialogRef = <span class="variable language_">this</span>.<span class="property">dialog</span>.<span class="title function_">open</span>(<span class="title class_">AddUserDialogComponent</span>);</span><br><span class="line">    dialogRef.<span class="title function_">afterClosed</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reloaduser</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 顯示刪除的對話框</span></span><br><span class="line">  <span class="title function_">showDeleteUserDialog</span>(<span class="params">row</span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(row);</span></span><br><span class="line">    <span class="keyword">const</span> dialogRef = <span class="variable language_">this</span>.<span class="property">dialog</span>.<span class="title function_">open</span>(<span class="title class_">DeleteUserDialogComponent</span>, &#123;</span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">iteminfo</span>: row</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    dialogRef.<span class="title function_">afterClosed</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reloaduser</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//顯示修改的對話框</span></span><br><span class="line">  <span class="title function_">showModifyUserDialog</span>(<span class="params">row</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> dialogRef = <span class="variable language_">this</span>.<span class="property">dialog</span>.<span class="title function_">open</span>(<span class="title class_">ModifyUserDialogComponent</span>, &#123;</span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">iteminfo</span>: row</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    dialogRef.<span class="title function_">afterClosed</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reloaduser</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h5 id="加入分頁"><a href="#加入分頁" class="headerlink" title="加入分頁"></a>加入分頁</h5><p>先來安裝分頁模組</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install SQLAlchemy-Paginator</span><br></pre></td></tr></table></figure>

<p>在安裝模組要修改一下，以免不能執行<code>D:\project\github\studypython\pyvirenv\pyenv37\lib\site-packages\sqlalchemy_paginator\paginator.py</code><a href="https://github.com/ahmadjavedse/sqlalchemy-paginator/issues/3">參考一下</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from .exceptions import PageNotAnInteger, EmptyPage</span><br></pre></td></tr></table></figure>

<p>在<code>run.py</code>中的<code>get_user</code>的功能要修改一下，因為想要在response heads將全部的數量加到reaponse heads所以要改寫一下<strong>注意</strong>如果client要可以取回加在head裏的值，在python回傳時也要設定一下<code>Access-Control-Expose-Headers</code>在下面的程式碼會看到，如果不加，目前client取不到此值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;dbkey&gt;&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">dbkey</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> dbkey == <span class="string">&quot;default&quot;</span>:</span><br><span class="line">            dbkey = <span class="literal">None</span></span><br><span class="line">        page = <span class="built_in">int</span>(request.args.get(<span class="string">&quot;page&quot;</span>))</span><br><span class="line">        limit = <span class="built_in">int</span>(request.args.get(<span class="string">&quot;limit&quot;</span>))</span><br><span class="line">        <span class="comment"># print(&quot;page=&quot;, page)</span></span><br><span class="line">        <span class="comment"># print(&quot;limit=&quot;, limit)</span></span><br><span class="line">        pageobj = User.paginate(dbkey, page, limit)</span><br><span class="line">        user_schema = UserSchema(many=<span class="literal">True</span>)</span><br><span class="line">        result = user_schema.dump(pageobj.object_list)</span><br><span class="line">        resp = jsonify(result)</span><br><span class="line">        resp.status_code = <span class="number">200</span></span><br><span class="line">        <span class="comment"># 全部有多少個</span></span><br><span class="line">        X_Total_Count = pageobj.paginator.count</span><br><span class="line">        resp.headers[<span class="string">&#x27;Access-Control-Expose-Headers&#x27;</span>] = <span class="string">&#x27;X-Total-Count&#x27;</span></span><br><span class="line">        resp.headers.add(<span class="string">&#x27;X-Total-Count&#x27;</span>, X_Total_Count)</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to get all user&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        result = &#123;<span class="string">&#x27;data&#x27;</span>: <span class="string">&#x27;notok&#x27;</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> jsonify(result), <span class="number">500</span></span><br></pre></td></tr></table></figure>

<h5 id="設定mat-paginator的提示文字"><a href="#設定mat-paginator的提示文字" class="headerlink" title="設定mat-paginator的提示文字"></a>設定mat-paginator的提示文字</h5><p>可以在<code>src\app\dashboard\user-page\user-page.component.ts</code>裏的<code>&lt;mat-aginator&gt;</code>中的文字內容都是英文的包含上一頁及下一頁按鈕，當滑鼠移過去時會呈現一個tooltip。當然這個文字我們也可以進行調整，只要在<code>MatPaginatorIntl</code>這個service裡面設定即可：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getDBInfos</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分頁切換時，重新取得資料</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paginator</span>.<span class="property">page</span>.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">page: PageEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(`pageIndex=$&#123;page.pageIndex&#125;:pageSize=$&#123;page.pageSize&#125;`);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">getPages</span>(page.<span class="property">pageIndex</span>, page.<span class="property">pageSize</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 設定顯示筆數資訊文字</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">getRangeLabel</span> = (<span class="attr">page</span>: number, <span class="attr">pageSize</span>: number, <span class="attr">length</span>: number): <span class="function"><span class="params">string</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (length === <span class="number">0</span> || pageSize === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`第 0 筆、共  <span class="subst">$&#123;length&#125;</span> 筆`</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      length = <span class="title class_">Math</span>.<span class="title function_">max</span>(length, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">const</span> startIndex = page * pageSize;</span><br><span class="line">      <span class="keyword">const</span> ednIndex = startIndex &lt; length ? <span class="title class_">Math</span>.<span class="title function_">min</span>(startIndex + pageSize, length) : startIndex + pageSize;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`第 <span class="subst">$&#123;startIndex + <span class="number">1</span>&#125;</span> - <span class="subst">$&#123;ednIndex&#125;</span> 筆、共  <span class="subst">$&#123;length&#125;</span> 筆`</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 設定其他顯示資訊文字</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">itemsPerPageLabel</span> = <span class="string">&#x27;每頁筆數：&#x27;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">nextPageLabel</span> = <span class="string">&#x27;下一頁&#x27;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">matPaginatorIntl</span>.<span class="property">previousPageLabel</span> = <span class="string">&#x27;上一頁&#x27;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>













<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><p><a href="https://github.com/mattermost/mattermost-server/issues/6159#">CORS Access-Control-Expose-Headers</a></p>
<p><a href="https://github.com/ahmadjavedse/sqlalchemy-paginator">sqlalchemy-paginator</a></p>
<p><a href="http://blog.luisrei.com/articles/flaskrest.html">Implementing a RESTful Web API with Python &amp; Flask</a></p>
<p><a href="https://stackoverflow.com/questions/46291244/how-to-use-httpclient-send-a-form-data-request">How to use HttpClient send a form data request?</a></p>
<p><a href="https://stackoverflow.com/questions/11277432/how-to-remove-a-key-from-a-python-dictionary">How to remove a key from a Python dictionary?</a></p>
<p><a href="https://stackoverflow.com/questions/14491678/flask-sqlalchemy-setup-dynamic-uri">Flask SQLAlchemy setup dynamic URI</a></p>
<p><a href="http://wingyumin.com/2017/02/25/%E4%BD%BF%E7%94%A8flask-sqlalchemy%E7%8E%A9%E8%BD%ACMySQL/">使用flask-sqlalchemy玩转MySQL</a></p>
<p><a href="https://myapollo.com.tw/2016/09/28/python-sqlalchemy-orm-1/">Python SQLAlchemy ORM - 1</a><br><a href="https://myapollo.com.tw/2016/09/28/python-sqlalchemy-orm-2/">Python SQLAlchemy ORM - 2</a><br><a href="https://myapollo.com.tw/2016/09/28/python-sqlalchemy-orm-3/">Python SQLAlchemy ORM - 3</a></p>
<p><a href="https://www.cnblogs.com/alima/p/5734992.html">关于flask-SQLAlchemy的初级使用教程</a></p>
<p><a href="https://stackoverflow.com/questions/37427646/sqlalchemy-db-create-all-not-creating-tables">Sqlalchemy db.create_all() not creating tables</a></p>
<p><a href="https://stackoverflow.com/questions/45675405/using-multiple-database-with-same-model-in-flask-sqlalchemy">Using multiple database with same model in flask-sqlalchemy</a></p>
<p><a href="https://www.codementor.io/garethdwyer/building-a-crud-application-with-flask-and-sqlalchemy-dm3wv7yu2">Building a CRUD application with Flask and SQLAlchemy</a></p>
]]></content>
      <categories>
        <category>記錄</category>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>資料庫</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄Flask相關教學</title>
    <url>/%E8%A8%98%E9%8C%84Flask%E7%9B%B8%E9%97%9C%E6%95%99%E5%AD%B8/%E8%A8%98%E9%8C%84Flask%E7%9B%B8%E9%97%9C%E6%95%99%E5%AD%B8/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p> 因在學習相關的Flask的教學在此記錄起來，以後可以來查閱<br> <span id="more"></span> </p>
<h2 id="原始的github"><a href="#原始的github" class="headerlink" title="原始的github"></a>原始的github</h2><p><a href="https://github.com/mooc-class/python-flask-minapp">https://github.com/mooc-class/python-flask-minapp</a></p>
<h1 id="安裝Ubuntu"><a href="#安裝Ubuntu" class="headerlink" title="安裝Ubuntu"></a>安裝Ubuntu</h1><p>安裝ubuntu的系統，可以參考網路上的教學，目前只針對套件的安裝來記錄一下。</p>
<h2 id="安裝MariaDB"><a href="#安裝MariaDB" class="headerlink" title="安裝MariaDB"></a>安裝MariaDB</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install software-properties-common dirmngr apt-transport-https</span><br><span class="line">sudo apt-key adv --fetch-keys &#x27;https://mariadb.org/mariadb_release_signing_key.asc&#x27;</span><br><span class="line">sudo add-apt-repository &#x27;deb [arch=amd64,arm64,ppc64el] https://ftp.ubuntu-tw.org/mirror/mariadb/repo/10.5/ubuntu bionic main&#x27;</span><br></pre></td></tr></table></figure>

<p>接下來</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install mariadb-server</span><br></pre></td></tr></table></figure>

<p>檢查版本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql -V</span><br></pre></td></tr></table></figure>

<p>設定root</p>
<p>安裝MariaDB過程中沒有問root密碼要設什麼，也沒有預設密碼，那之後用什麼密碼連呢？紀錄一下，免得忘記：<br>用sudo使用無密碼進入mysql</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo mysql -u root</span><br></pre></td></tr></table></figure>

<p>建立使用者</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt;</span><br><span class="line">CREATE USER &#x27;imooc&#x27; IDENTIFIED BY &#x27;12345678&#x27;;</span><br><span class="line">GRANT USAGE ON *.* TO &#x27;imooc&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;12345678&#x27;;</span><br><span class="line">GRANT USAGE ON *.* TO &#x27;imooc&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;12345678&#x27;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">//檢查</span><br><span class="line">SHOW GRANTS FOR &#x27;imooc&#x27;@&#x27;localhost&#x27;;  </span><br><span class="line"></span><br><span class="line">grant all privileges on *.* to &#x27;imooc&#x27;@&#x27;localhost&#x27; identified by &#x27;12345678&#x27; with grant option;</span><br><span class="line">grant all privileges on *.* to &#x27;imooc&#x27;@&#x27;%&#x27; identified by &#x27;12345678&#x27; with grant option;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p>不能遠端連線</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/mysql/mariadb.conf.d/50-server.cnf</span><br></pre></td></tr></table></figure>

<p><a href="https://websiteforstudents.com/allow-remote-access-to-mariadb-database-server-on-ubuntu-18-04/">https://websiteforstudents.com/allow-remote-access-to-mariadb-database-server-on-ubuntu-18-04/</a></p>
<p>主要是將bind-address &#x3D; 127.0.0.1 修改成 bind-address &#x3D; 0.0.0.0</p>
<p>命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl stop mariadb.service</span><br><span class="line">sudo systemctl start mariadb.service</span><br><span class="line">sudo systemctl enable mariadb.service</span><br></pre></td></tr></table></figure>

<h2 id="分享資料夾"><a href="#分享資料夾" class="headerlink" title="分享資料夾"></a>分享資料夾</h2><p><a href="https://askubuntu.com/questions/29284/how-do-i-mount-shared-folders-in-ubuntu-using-vmware-tools">https://askubuntu.com/questions/29284/how-do-i-mount-shared-folders-in-ubuntu-using-vmware-tools</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo mkdir /mnt/cdrom</span><br><span class="line">sudo mount /dev/cdrom /mnt/cdrom/</span><br><span class="line">cd /mnt/cdrom</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>令檢視當前有哪些共享的目錄</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vmware-hgfsclient</span><br><span class="line">sudo vmhgfs-fuse .host:/imooc /mnt/hgfs/ -o allow_other -o uid=1000</span><br></pre></td></tr></table></figure>

<p>You may have use a specific folder instead of <code>.host:/</code>. In that case you can find out the share’s name with <code>vmware-hgfsclient</code>. For example:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vmware-hgfsclient</span><br><span class="line">my-shared-folder</span><br><span class="line">$ sudo vmhgfs-fuse .host:/my-shared-folder /mnt/hgfs/ -o allow_other -o uid=1000</span><br></pre></td></tr></table></figure>

<p>If you want them mounted on startup, update <code>/etc/fstab</code> with the following:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Use shared folders between VMWare guest and host</span><br><span class="line">.host:/    /mnt/hgfs/    fuse.vmhgfs-fuse    defaults,allow_other,uid=1000     0    0</span><br></pre></td></tr></table></figure>

<p>I choose to mount them on demand and have them ignored by <code>sudo mount -a</code> and the such with the <code>noauto</code> option, because I noticed the shares have an impact on VM performance.</p>
<p>在<code>/mnt/hgfs/imooc</code>下建立目錄www</p>
<p>然後建立symbolylink</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo ln -s /mnt/hgfs/imooc/www/ /home/ttom/www</span><br></pre></td></tr></table></figure>

<p>之後會在<code>/home/ttom</code>下面出www的連結，可以在此下面建立程式和資料，這在windwo也會出現資料夾和資料</p>
<p>安裝pip3</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install python3-pip</span><br></pre></td></tr></table></figure>

<p>安裝虛擬環境</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt install python3-venv</span><br></pre></td></tr></table></figure>

<p>起動虛擬環境</p>
<p>先在家目錄建立環境，將其複制到分享的資料夾，之後可以移除原來建立的資料夾</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd ~</span><br><span class="line">python3 -m venv test_env</span><br><span class="line">cp -Lr test_env/ www</span><br><span class="line">cd www</span><br><span class="line">source test_env/bin/activate</span><br><span class="line">deactivate</span><br></pre></td></tr></table></figure>

<p>可以移除原來建立的資料夾</p>
<p>先來建立imooc_env的虛擬環境</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd ~</span><br><span class="line">python3 -m venv imooc_env</span><br><span class="line">cp -Lr imooc_env/ www</span><br><span class="line">rm -rf imooc_env</span><br><span class="line">cd www</span><br><span class="line">source immoc_env/bin/activate</span><br></pre></td></tr></table></figure>

<h2 id="安裝Flask-在虛擬環境下"><a href="#安裝Flask-在虛擬環境下" class="headerlink" title="安裝Flask(在虛擬環境下)"></a>安裝Flask(在虛擬環境下)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip3 install flask</span><br></pre></td></tr></table></figure>

<p>測試一下</p>
<p>建立order的目錄和hello.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)  </span><br></pre></td></tr></table></figure>

<p>打開瀏覽器，網址是ubuntu的ip加5000,例如<code>http://192.168.83.128:5000/</code></p>
<h2 id="安裝nginx"><a href="#安裝nginx" class="headerlink" title="安裝nginx"></a>安裝nginx</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure>

<p>檢查nginx的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl status nginx</span><br></pre></td></tr></table></figure>

<p>nginx的相關命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl stop nginx</span><br><span class="line">sudo systemctl start nginx</span><br><span class="line">sudo systemctl restart nginx</span><br><span class="line">sudo systemctl reload nginx</span><br></pre></td></tr></table></figure>



<h1 id="flask-框架入門基礎知識"><a href="#flask-框架入門基礎知識" class="headerlink" title="flask 框架入門基礎知識"></a>flask 框架入門基礎知識</h1><h2 id="使用blueprint"><a href="#使用blueprint" class="headerlink" title="使用blueprint"></a>使用blueprint</h2><p>修改一下nginx的設定檔的名稱叫<code>imooc.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">                <span class="attribute">root</span> /home/ttom/www;<span class="comment"># server 靜態檔案位置</span></span><br><span class="line">                <span class="attribute">index</span> index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#以下是api的webservice</span></span><br><span class="line">        <span class="section">location</span><span class="regexp"> ^~</span> /v0.<span class="number">0</span>/ &#123; <span class="comment"># 當api prefix是v0.0開頭 rquest過來會proxy 給5000 port的 local api service</span></span><br><span class="line">                <span class="attribute">proxy_pass</span> http://127.0.0.1:5000;</span><br><span class="line">                <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;<span class="comment"># 在proxy request 時保留client 的header</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新增檔案叫<code>imooc.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line">route_imooc = Blueprint(<span class="string">&quot;imooc_page&quot;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@route_imooc.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;imooc index page&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@route_imooc.route(<span class="params"><span class="string">&quot;/hello&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index_hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;imooc hello page&quot;</span></span><br></pre></td></tr></table></figure>

<p>在修改一下<code>hello2.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,jsonify,jsonify</span><br><span class="line"><span class="keyword">from</span> imooc <span class="keyword">import</span> route_imooc</span><br><span class="line">API_VERSION=<span class="string">&quot;v0.0&quot;</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.register_blueprint(route_imooc,url_prefix=<span class="string">&#x27;/&#123;0&#125;/api/imooc&#x27;</span>.<span class="built_in">format</span>(API_VERSION))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">v0_0index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello world /v0.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello world /v0.0/api&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/movies&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_movies_api</span>():</span><br><span class="line">    movies=[&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;刺激1995&#x27;</span>&#125;,&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;教父&#x27;</span>&#125;]</span><br><span class="line">    <span class="keyword">return</span> jsonify(movies) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>在瀏覽器下可以取得到資料</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://192.168.83.128/v0.0/</span><br><span class="line">http://192.168.83.128/v0.0/api</span><br><span class="line">http://192.168.83.128/v0.0/api/movies</span><br><span class="line">使用blueprint</span><br><span class="line">http://192.168.83.128/v0.0/api/imooc</span><br><span class="line">http://192.168.83.128/v0.0/api/imooc/hello</span><br></pre></td></tr></table></figure>

<h2 id="鏈接管理器"><a href="#鏈接管理器" class="headerlink" title="鏈接管理器"></a>鏈接管理器</h2><p>在order下建立common\libs\UrlManager.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UrlManager</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUrl</span>(<span class="params">path</span>):</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildStaticUrl</span>(<span class="params">path</span>):</span><br><span class="line">        <span class="keyword">return</span> path   </span><br></pre></td></tr></table></figure>

<p>測試</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,url_for,jsonify</span><br><span class="line"><span class="keyword">from</span> imooc <span class="keyword">import</span> route_imooc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> common.libs.UrlManager <span class="keyword">import</span> UrlManager</span><br><span class="line"></span><br><span class="line">API_VERSION=<span class="string">&quot;v0.0&quot;</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.register_blueprint(route_imooc,url_prefix=<span class="string">&#x27;/&#123;0&#125;/api/imooc&#x27;</span>.<span class="built_in">format</span>(API_VERSION))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">v0_0index</span>():</span><br><span class="line">    url = url_for(<span class="string">&quot;hello_world&quot;</span>)</span><br><span class="line">    url1_1= UrlManager.buildUrl(<span class="string">&quot;/v0.0/api&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello world url=%s , url1_1=%s &quot;</span> %(url,url1_1)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello world /v0.0/api&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/movies&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_movies_api</span>():</span><br><span class="line">    movies=[&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;刺激1995&#x27;</span>&#125;,&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;教父&#x27;</span>&#125;]</span><br><span class="line">    <span class="keyword">return</span> jsonify(movies) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>瀏覽器”<a href="http://192.168.83.128/v0.0/">http://192.168.83.128/v0.0/</a>“</p>
<h2 id="日誌系統"><a href="#日誌系統" class="headerlink" title="日誌系統"></a>日誌系統</h2><p>Flask有內建一的日誌系統，來測試一下, 有三個級別，只有error是在所有情況下輸出資訊</p>
<p>以下是範例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">app.logger.debug(<span class="string">&#x27;A value for debugging&#x27;</span>)</span><br><span class="line">app.logger.warning(<span class="string">&#x27;A warning occurred (%d apples)&#x27;</span>, <span class="number">42</span>)</span><br><span class="line">app.logger.error(<span class="string">&#x27;An error occurred&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>修改一下<code>hello2.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,url_for,jsonify</span><br><span class="line"><span class="keyword">from</span> imooc <span class="keyword">import</span> route_imooc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> common.libs.UrlManager <span class="keyword">import</span> UrlManager</span><br><span class="line"></span><br><span class="line">API_VERSION=<span class="string">&quot;v0.0&quot;</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.register_blueprint(route_imooc,url_prefix=<span class="string">&#x27;/&#123;0&#125;/api/imooc&#x27;</span>.<span class="built_in">format</span>(API_VERSION))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">v0_0index</span>():</span><br><span class="line">    url = url_for(<span class="string">&quot;hello_world&quot;</span>)</span><br><span class="line">    url1_1= UrlManager.buildUrl(<span class="string">&quot;/v0.0/api&quot;</span>)</span><br><span class="line">    msg =  <span class="string">&quot;hello world url=%s , url1_1=%s &quot;</span> %(url,url1_1)</span><br><span class="line">    app.logger.debug(msg)</span><br><span class="line">    app.logger.warning(msg)</span><br><span class="line">    app.logger.error(msg)   </span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello world /v0.0/api&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/movies&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_movies_api</span>():</span><br><span class="line">    movies=[&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;刺激1995&#x27;</span>&#125;,&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;教父&#x27;</span>&#125;]</span><br><span class="line">    <span class="keyword">return</span> jsonify(movies) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>瀏覽器”<a href="http://192.168.83.128/v0.0/%22%E5%9C%A8console%E4%B8%AD%E5%A6%82%E4%B8%8B%E7%9A%84%E9%A1%AF%E7%A4%BA">http://192.168.83.128/v0.0/&quot;在console中如下的顯示</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"> * Serving Flask app <span class="string">&quot;hello2&quot;</span> (lazy loading)</span><br><span class="line"> * Environment: production</span><br><span class="line">   WARNING: This is a development server. Do not use it <span class="keyword">in</span> a production deployment.</span><br><span class="line">   Use a production WSGI server instead.</span><br><span class="line"> * Debug mode: off</span><br><span class="line"> * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</span><br><span class="line">[2020-11-19 01:26:40,227] WARNING <span class="keyword">in</span> hello2: hello world url=/v0.0/api , url1_1=/v0.0/api</span><br><span class="line">[2020-11-19 01:26:40,227] ERROR <span class="keyword">in</span> hello2: hello world url=/v0.0/api , url1_1=/v0.0/api</span><br><span class="line">127.0.0.1 - - [19/Nov/2020 01:26:40] <span class="string">&quot;GET /v0.0/ HTTP/1.0&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<p>如果要全部輸出的話，要將Debug mode打開<code>hello2.py</code>修改如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 以上不變</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run( debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>輸出如下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"> * Serving Flask app &quot;hello2&quot; (lazy loading)</span><br><span class="line"> * Environment: production</span><br><span class="line">   WARNING: This is a development server. Do not use it in a production deployment.</span><br><span class="line">   Use a production WSGI server instead.</span><br><span class="line"> * Debug mode: on</span><br><span class="line"> * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</span><br><span class="line"> * Restarting with stat</span><br><span class="line"> * Debugger is active!</span><br><span class="line"> * Debugger PIN: 153-792-531</span><br><span class="line">[2020-11-19 01:33:02,534] DEBUG in hello2: hello world url=/v0.0/api , url1_1=/v0.0/api</span><br><span class="line">[2020-11-19 01:33:02,534] WARNING in hello2: hello world url=/v0.0/api , url1_1=/v0.0/api</span><br><span class="line">[2020-11-19 01:33:02,535] ERROR in hello2: hello world url=/v0.0/api , url1_1=/v0.0/api</span><br><span class="line">127.0.0.1 - - [19/Nov/2020 01:33:02] &quot;GET /v0.0/ HTTP/1.0&quot; 200 -</span><br></pre></td></tr></table></figure>

<h2 id="錯誤處理"><a href="#錯誤處理" class="headerlink" title="錯誤處理"></a>錯誤處理</h2><p>目前測試是以找不到網頁來測試，以下是範例程式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page_not_found</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;This page does not exist&#x27;</span>, <span class="number">404</span></span><br></pre></td></tr></table></figure>

<p>在hello2.py中修改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,url_for,jsonify</span><br><span class="line"><span class="keyword">from</span> imooc <span class="keyword">import</span> route_imooc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> common.libs.UrlManager <span class="keyword">import</span> UrlManager</span><br><span class="line"></span><br><span class="line">API_VERSION=<span class="string">&quot;v0.0&quot;</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.register_blueprint(route_imooc,url_prefix=<span class="string">&#x27;/&#123;0&#125;/api/imooc&#x27;</span>.<span class="built_in">format</span>(API_VERSION))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">v0_0index</span>():</span><br><span class="line">    url = url_for(<span class="string">&quot;hello_world&quot;</span>)</span><br><span class="line">    url1_1= UrlManager.buildUrl(<span class="string">&quot;/v0.0/api&quot;</span>)</span><br><span class="line">    msg =  <span class="string">&quot;hello world url=%s , url1_1=%s &quot;</span> %(url,url1_1)</span><br><span class="line">    app.logger.debug(msg)</span><br><span class="line">    app.logger.warning(msg)</span><br><span class="line">    app.logger.error(msg)   </span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello world /v0.0/api&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/movies/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_movies_api</span>():</span><br><span class="line">    movies=[&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;刺激1995&#x27;</span>&#125;,&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;教父&#x27;</span>&#125;]</span><br><span class="line">    <span class="keyword">return</span> jsonify(movies) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 找不到網頁的error handler</span></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page_not_found</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;This page does not exist&#x27;</span>, <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run( debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>當找不到網頁時，會顯示<code>This page does not exist</code></p>
<h2 id="資料庫ORM"><a href="#資料庫ORM" class="headerlink" title="資料庫ORM"></a>資料庫ORM</h2><p>先來安裝相關的套件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get -y install default-libmysqlclient-dev software-properties-common</span><br><span class="line">pip3 install mysqlclient SQLAlchemy flask-sqlalchemy</span><br></pre></td></tr></table></figure>

<p>在hello2.py中修改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,url_for,jsonify</span><br><span class="line"><span class="keyword">from</span> imooc <span class="keyword">import</span> route_imooc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> common.libs.UrlManager <span class="keyword">import</span> UrlManager</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line">API_VERSION=<span class="string">&quot;v0.0&quot;</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫相關</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&quot;mysql://imooc:12345678@127.0.0.1:3306/mysql&quot;</span></span><br><span class="line">db=SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line">app.register_blueprint(route_imooc,url_prefix=<span class="string">&#x27;/&#123;0&#125;/api/imooc&#x27;</span>.<span class="built_in">format</span>(API_VERSION))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">v0_0index</span>():</span><br><span class="line">    url = url_for(<span class="string">&quot;hello_world&quot;</span>)</span><br><span class="line">    url1_1= UrlManager.buildUrl(<span class="string">&quot;/v0.0/api&quot;</span>)</span><br><span class="line">    msg =  <span class="string">&quot;hello world url=%s , url1_1=%s &quot;</span> %(url,url1_1)</span><br><span class="line">    app.logger.debug(msg)</span><br><span class="line">    app.logger.warning(msg)</span><br><span class="line">    app.logger.error(msg)   </span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> text</span><br><span class="line">    sql= text(<span class="string">&quot;SELECT * from `user`&quot;</span>)</span><br><span class="line">    result = db.engine.execute(sql)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        app.logger.info(row)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello world /v0.0/api&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/movies/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_movies_api</span>():</span><br><span class="line">    movies=[&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;刺激1995&#x27;</span>&#125;,&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;教父&#x27;</span>&#125;]</span><br><span class="line">    <span class="keyword">return</span> jsonify(movies) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 找不到網頁的error handler</span></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page_not_found</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;This page does not exist&#x27;</span>, <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run( debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h1 id="flask框架入門實作"><a href="#flask框架入門實作" class="headerlink" title="flask框架入門實作"></a>flask框架入門實作</h1><p>這是一個基礎的框架，可以來使用到很多的地方</p>
<h2 id="基本說明"><a href="#基本說明" class="headerlink" title="基本說明"></a>基本說明</h2><p>目前所使用到的目錄結構</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">order                               # 主要目錄</span><br><span class="line">│  application.py                   # 封裝的Flask的全局變量，包括app，資料庫等</span><br><span class="line">│  manage.py                        # 啟動入口</span><br><span class="line">│  readme.md                        # 使用文檔</span><br><span class="line">│  requirements.txt                 # python 擴展</span><br><span class="line">│  www.py                           # HTTP 模塊相關起動</span><br><span class="line">│</span><br><span class="line">├─common                            # 存放公用部分        </span><br><span class="line">│  ├─libs                           # 公用方法或者類</span><br><span class="line">│  └─models                         # 所有的資料庫model</span><br><span class="line">├─config                            # 配置文件</span><br><span class="line">│      base_setting.py              # 基礎配置</span><br><span class="line">│      local_setting_demo.py        # 本地開發環境配置demo</span><br><span class="line">│      production_setting.py        # 生產環境的配置</span><br><span class="line">│</span><br><span class="line">├─docs                              # 文檔存放</span><br><span class="line">│      mariadb.md                   # 所有資料庫變更必須在這里記錄</span><br><span class="line">│</span><br><span class="line">├─jobs                              # 定時任務</span><br><span class="line">│  └─tasks                          # 所有定時任務都存放在這里</span><br><span class="line">└─web                               # HTTP 存放</span><br></pre></td></tr></table></figure>

<h2 id="加入需要的lib"><a href="#加入需要的lib" class="headerlink" title="加入需要的lib"></a>加入需要的lib</h2><p>在requirements.txt中加入需要的lib</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flask</span><br><span class="line">SQLAlchemy</span><br><span class="line">flask-sqlalchemy</span><br><span class="line">mysqlclient</span><br></pre></td></tr></table></figure>



<h2 id="建立基礎"><a href="#建立基礎" class="headerlink" title="建立基礎"></a>建立基礎</h2><p>先來處理<code>application.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Application</span>(<span class="title class_ inherited__">Flask</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,import_name</span>):</span><br><span class="line">        <span class="built_in">super</span>(Application,self).__init__(import_name)</span><br><span class="line">        self.config.from_pyfile(<span class="string">&#x27;config/base_setting.py&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        db.init_app(self)</span><br><span class="line">        </span><br><span class="line">db = SQLAlchemy()</span><br><span class="line">app = Application(__name__)</span><br></pre></td></tr></table></figure>

<p>處理<code>manager.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">#app.run(host=&#x27;0.0.0.0&#x27;,debug=&#x27;True&#x27;)</span></span><br><span class="line">    app.run(debug=<span class="string">&#x27;True&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        sys.exit(main())</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc()</span><br></pre></td></tr></table></figure>

<p>加入資料庫配置文件<code>base_setting.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">&#x27;mysql://imooc:12345678@127.0.0.1:3306/mysql&#x27;</span></span><br><span class="line"></span><br><span class="line">SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<h2 id="flask-script"><a href="#flask-script" class="headerlink" title="flask_script"></a>flask_script</h2><p>可以在執行<code>manager.py</code>時代入參數在<code>requirements.txt</code>中加入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flask</span><br><span class="line">SQLAlchemy</span><br><span class="line">flask-sqlalchemy</span><br><span class="line">mysqlclient</span><br><span class="line">flask_script</span><br></pre></td></tr></table></figure>

<p>安裝</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip3 install -r  requirements.txt</span><br></pre></td></tr></table></figure>

<p>在<code>application.py</code>中加入它的管理器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Manager</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Application</span>(<span class="title class_ inherited__">Flask</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,import_name</span>):</span><br><span class="line">        <span class="built_in">super</span>(Application,self).__init__(import_name)</span><br><span class="line">        self.config.from_pyfile(<span class="string">&#x27;config/base_setting.py&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        db.init_app(self)</span><br><span class="line">        </span><br><span class="line">db = SQLAlchemy()</span><br><span class="line">app = Application(__name__)</span><br><span class="line">manager = Manager(app)</span><br></pre></td></tr></table></figure>

<p>在<code>manage.py</code>中加入Server</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app,manager</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Server</span><br><span class="line"></span><br><span class="line"><span class="comment">## web server</span></span><br><span class="line">manager.add_command(<span class="string">&quot;runserver&quot;</span>,Server(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=<span class="number">5000</span>,use_debugger=<span class="literal">True</span>,use_reloader=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">#app.run(host=&#x27;0.0.0.0&#x27;,debug=&#x27;True&#x27;)</span></span><br><span class="line">    <span class="comment">#app.run(debug=&#x27;True&#x27;)</span></span><br><span class="line">    manager.run();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        sys.exit(main())</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc()</span><br></pre></td></tr></table></figure>

<p>如何使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 manager.py runserver</span><br></pre></td></tr></table></figure>

<p>如果要修改port，可以從設定檔來取得修改一下<code>config\base_setting.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">SERVER_PORT = <span class="number">8999</span></span><br><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">&#x27;mysql://imooc:12345678@127.0.0.1:3306/mysql&#x27;</span></span><br><span class="line">SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>在<code>manage.py</code>中修改 port&#x3D;app.config[‘SERVER_PORT’]</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app,manager</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Server</span><br><span class="line"></span><br><span class="line"><span class="comment">## web server</span></span><br><span class="line">manager.add_command(<span class="string">&quot;runserver&quot;</span>,Server(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=app.config[<span class="string">&#x27;SERVER_PORT&#x27;</span>],use_debugger=<span class="literal">True</span>,use_reloader=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">#app.run(host=&#x27;0.0.0.0&#x27;,debug=&#x27;True&#x27;)</span></span><br><span class="line">    <span class="comment">#app.run(debug=&#x27;True&#x27;)</span></span><br><span class="line">    manager.run();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        sys.exit(main())</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc()</span><br></pre></td></tr></table></figure>

<p>就可以起動時修改port</p>
<h2 id="不同環境的加載"><a href="#不同環境的加載" class="headerlink" title="不同環境的加載"></a>不同環境的加載</h2><p>使用os.environ的變數來加載不同的設定檔</p>
<p>在<code>application.py</code>中來修改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Manager</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Application</span>(<span class="title class_ inherited__">Flask</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,import_name</span>):</span><br><span class="line">        <span class="built_in">super</span>(Application,self).__init__(import_name)</span><br><span class="line">        self.config.from_pyfile(<span class="string">&#x27;config/base_setting.py&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;ops_config&quot;</span> <span class="keyword">in</span> os.environ:</span><br><span class="line">            self.config.from_pyfile(<span class="string">&#x27;config/%s_setting.py&#x27;</span> % os.environ[<span class="string">&#x27;ops_config&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        db.init_app(self)</span><br><span class="line">        </span><br><span class="line">db = SQLAlchemy()</span><br><span class="line">app = Application(__name__)</span><br><span class="line">manager = Manager(app)</span><br></pre></td></tr></table></figure>

<p>在linux的命令行中，加入系統變數</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export ops_config=local</span><br></pre></td></tr></table></figure>

<p>在配置中的環境是不一樣的</p>
<p>在<code>config\base_setting.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">SERVER_PORT = <span class="number">5000</span></span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line">SQLALCHEMY_ECHO = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>在<code>config\local_setting.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">DEBUG = <span class="literal">True</span></span><br><span class="line">SQLALCHEMY_ECHO = <span class="literal">True</span></span><br><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">&#x27;mysql://imooc:12345678@127.0.0.1:3306/mysql&#x27;</span></span><br><span class="line">SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">False</span></span><br><span class="line">SQLALCHEMY_ENCODING = <span class="string">&#x27;utf-8&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="測試index"><a href="#測試index" class="headerlink" title="測試index"></a>測試index</h2><p>controller層在<code>web\controller\index.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line">router_index = Blueprint(<span class="string">&#x27;index_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_index.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>

<p>在<code>www.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> web.controller.index <span class="keyword">import</span> router_index</span><br><span class="line"></span><br><span class="line">app.register_blueprint(router_index,url_prefix=<span class="string">&quot;/&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>在<code>manage.py</code>中引入www</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app,manager</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Server</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> www <span class="comment">#引入</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## web server</span></span><br><span class="line">manager.add_command(<span class="string">&quot;runserver&quot;</span>,Server(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=app.config[<span class="string">&#x27;SERVER_PORT&#x27;</span>],use_debugger=<span class="literal">True</span>,use_reloader=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">#app.run(host=&#x27;0.0.0.0&#x27;,debug=&#x27;True&#x27;)</span></span><br><span class="line">    <span class="comment">#app.run(debug=&#x27;True&#x27;)</span></span><br><span class="line">    manager.run();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        sys.exit(main())</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc()</span><br></pre></td></tr></table></figure>

<p>在nginx的設定檔有修改<code>/etc/nginx/sites-available/imooc.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#location / &#123;</span></span><br><span class="line">        <span class="comment">#       root /home/ttom/www;# server 靜態檔案位置</span></span><br><span class="line">        <span class="comment">#        index index.html;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">        <span class="comment">#以下是api的webservice</span></span><br><span class="line">        <span class="comment">#location ^~ /v0.0/ &#123; # 當api prefix是v0.0開頭 rquest過來會proxy 給5000 port的 local api service</span></span><br><span class="line">        <span class="comment">#       proxy_pass http://127.0.0.1:5000;</span></span><br><span class="line">        <span class="comment">#       proxy_set_header Host $host;# 在proxy request 時保留client 的header</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="section">location</span> / &#123; <span class="comment"># 當api prefix是v0.0開頭 rquest過來會proxy 給5000 port的 local api service</span></span><br><span class="line">               <span class="attribute">proxy_pass</span> http://127.0.0.1:5000;</span><br><span class="line">               <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;<span class="comment"># 在proxy request 時保留client 的header</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="後台帳戶模塊開發"><a href="#後台帳戶模塊開發" class="headerlink" title="後台帳戶模塊開發"></a>後台帳戶模塊開發</h1><h2 id="認證功能"><a href="#認證功能" class="headerlink" title="認證功能"></a>認證功能</h2><h3 id="登錄退出"><a href="#登錄退出" class="headerlink" title="登錄退出"></a>登錄退出</h3><ul>
<li><p>新建數據庫</p>
<p>數據庫名：food_db</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE DATABASE `food_db` DEFAULT CHARACTER SET = `utf8mb4`;</span><br></pre></td></tr></table></figure>


</li>
<li><p>新建管理員數據表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DROP TABLE IF EXISTS `user`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `user` (</span><br><span class="line">  `uid` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;用户uid&#x27;,</span><br><span class="line">  `nickname` varchar(100) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;用户名&#x27;,</span><br><span class="line">  `mobile` varchar(20) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;手机号码&#x27;,</span><br><span class="line">  `email` varchar(100) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;邮箱地址&#x27;,</span><br><span class="line">  `sex` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;1：男 2：女 0：没填写&#x27;,</span><br><span class="line">  `avatar` varchar(64) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;头像&#x27;,</span><br><span class="line">  `login_name` varchar(20) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;登录用户名&#x27;,</span><br><span class="line">  `login_pwd` varchar(32) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;登录密码&#x27;,</span><br><span class="line">  `login_salt` varchar(32) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;登录密码的随机加密秘钥&#x27;,</span><br><span class="line">  `status` tinyint(1) NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;1：有效 0：无效&#x27;,</span><br><span class="line">  `updated_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;最后一次更新时间&#x27;,</span><br><span class="line">  `created_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;插入时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`uid`),</span><br><span class="line">  UNIQUE KEY `login_name` (`login_name`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;用户表（管理员）&#x27;;</span><br></pre></td></tr></table></figure>


</li>
<li><p>使用<code>flask-sqlacodegen</code>擴展方便快速生成ORM model</p>
<p>安裝flask-sqlacodegen</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip3 install flask-sqlacodegen</span><br></pre></td></tr></table></figure>

<p>使用方法<strong>注意路徑</strong>主要使用一張表一個py檔</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flask-sqlacodegen &#x27;mysql://root:密碼@127.0.0.1/food_db?charset=utf8mb4&#x27; --outfile &quot;common/models/model.py&quot;  --flask</span><br><span class="line">flask-sqlacodegen &#x27;mysql://root:密碼@127.0.0.1/food_db?charset=utf8mb4&#x27; --tables user --outfile &quot;common/models/user.py&quot;  --flask</span><br><span class="line">//</span><br><span class="line">flask-sqlacodegen &#x27;mysql://imooc:12345678@127.0.0.1/food_db?charset=utf8mb4&#x27; --tables user --outfile &quot;common/models/user.py&quot;  --flask</span><br></pre></td></tr></table></figure>


</li>
<li><p>修改自動生成的model中的db變量</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from application impor db</span><br></pre></td></tr></table></figure>


</li>
<li><p>修改配置文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">&#x27;mysql://imooc:12345678@127.0.0.1/food_db&#x27;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>開始寫代碼</p>
</li>
</ul>
<h2 id="先來重新配置網頁和nginx"><a href="#先來重新配置網頁和nginx" class="headerlink" title="先來重新配置網頁和nginx"></a>先來重新配置網頁和nginx</h2><h3 id="先來建置網頁"><a href="#先來建置網頁" class="headerlink" title="先來建置網頁"></a>先來建置網頁</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng new foodwebbackend</span><br></pre></td></tr></table></figure>

<p>設定nginx的設定檔<code>sudo vim /etc/nginx/sites-enabled/imooc.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="comment">#主網頁的位置</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">                <span class="comment">#root /home/ttom/www;# server 靜態檔案位置</span></span><br><span class="line">                <span class="comment">#index index.html;</span></span><br><span class="line">                <span class="comment">#alias /usr/share/nginx/html/;</span></span><br><span class="line">                <span class="attribute">alias</span> /home/ttom/www/foodwebbackend/dist/foodwebbackend/;</span><br><span class="line">                <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/  /index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#以下是api的webservice</span></span><br><span class="line">        <span class="section">location</span><span class="regexp"> ^~</span> /v0.<span class="number">0</span>/ &#123; <span class="comment"># 當api prefix是v0.0開頭 rquest過來會proxy 給5000 port的 local api service</span></span><br><span class="line">                <span class="attribute">proxy_pass</span> http://127.0.0.1:5000;</span><br><span class="line">                <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;<span class="comment"># 在proxy request 時保留client 的header</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>config\base_setting.py</code>中加入API_VERSION</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SERVER_PORT = 5000</span><br><span class="line">DEBUG = False</span><br><span class="line">SQLALCHEMY_ECHO = False</span><br><span class="line">API_VERSION = &#x27;v0.0&#x27;</span><br></pre></td></tr></table></figure>

<p>加入<code>web\controller\user\User.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;login&quot;</span></span><br></pre></td></tr></table></figure>

<p>要給angular的RXJS正確的返回值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,make_response,jsonify</span><br><span class="line"></span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login&quot;</span>), <span class="number">200</span>)</span><br></pre></td></tr></table></figure>

<p>在<code>www.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> web.controller.index <span class="keyword">import</span> router_index</span><br><span class="line"><span class="keyword">from</span> web.controller.user.User <span class="keyword">import</span> router_user</span><br><span class="line"><span class="comment">#註冊api</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#app.register_blueprint(router_index,url_prefix=&quot;/&quot;)</span></span><br><span class="line"><span class="comment">#app.register_blueprint(router_user,url_prefix = &quot;/v0.0/user&quot;)</span></span><br><span class="line">app.register_blueprint(router_index,url_prefix=<span class="string">&#x27;/&#123;0&#125;/&#x27;</span>.<span class="built_in">format</span>(app.config[<span class="string">&#x27;API_VERSION&#x27;</span>]))</span><br><span class="line">app.register_blueprint(router_user,url_prefix=<span class="string">&#x27;/&#123;0&#125;/user&#x27;</span>.<span class="built_in">format</span>(app.config[<span class="string">&#x27;API_VERSION&#x27;</span>]))</span><br></pre></td></tr></table></figure>

<h2 id="加入login"><a href="#加入login" class="headerlink" title="加入login"></a>加入login</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g c login</span><br></pre></td></tr></table></figure>



<h2 id="加入404頁"><a href="#加入404頁" class="headerlink" title="加入404頁"></a>加入404頁</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g c pages/not-found</span><br></pre></td></tr></table></figure>

<p>在<code>web\controller\user\User.py</code></p>
<p>加入request來取得”GET”,”POST”</p>
<p>加入mak_response產生web的頭</p>
<p>加入jsonify產生json</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"></span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login get&quot;</span>), <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;用戶登入&quot;</span>), <span class="number">200</span>)    </span><br></pre></td></tr></table></figure>

<p>在登入的網頁有修改<code>src\app\login\login.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> [<span class="attr">formGroup</span>]=<span class="string">&quot;formModel&quot;</span> (<span class="attr">ngSubmit</span>)=<span class="string">&quot;onSubmit($event)&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-card</span> <span class="attr">class</span>=<span class="string">&quot;login-card mat-elevation-z4&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;login100-form-title p-b-26&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;zmdi&quot;</span>&gt;</span>Welcome to Food<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-form-field</span> <span class="attr">class</span>=<span class="string">&quot;full-width&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-icon</span> <span class="attr">matPrefix</span> <span class="attr">style</span>=<span class="string">&quot;margin-right: 10px;&quot;</span>&gt;</span>mail<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">matInput</span> <span class="attr">placeholder</span>=<span class="string">&quot;登入名字&quot;</span> <span class="attr">formControlName</span>=<span class="string">&quot;login_name&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-error</span> *<span class="attr">ngIf</span>=<span class="string">&quot;formErrors.login_name&quot;</span>&gt;</span>&#123;&#123;formErrors.login_name&#125;&#125;<span class="tag">&lt;/<span class="name">mat-error</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-form-field</span> <span class="attr">class</span>=<span class="string">&quot;full-width&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-icon</span> <span class="attr">matPrefix</span> <span class="attr">style</span>=<span class="string">&quot;margin-right: 10px;&quot;</span>&gt;</span>vpn_key<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">matInput</span> <span class="attr">placeholder</span>=<span class="string">&quot;password&quot;</span> <span class="attr">formControlName</span>=<span class="string">&quot;login_pwd&quot;</span> [<span class="attr">type</span>]=<span class="string">&quot;hide ? &#x27;password&#x27; : &#x27;text&#x27;&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- &lt;mat-icon matSuffix (click)=&quot;hide = !hide&quot;&gt;&#123;&#123;hide ? &#x27;visibility_off&#x27; : &#x27;visibility&#x27;&#125;&#125;&lt;/mat-icon&gt; --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-error</span> *<span class="attr">ngIf</span>=<span class="string">&quot;formErrors.login_pwd&quot;</span>&gt;</span>&#123;&#123;formErrors.login_pwd&#125;&#125;<span class="tag">&lt;/<span class="name">mat-error</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-card-actions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-raised-button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> [<span class="attr">disabled</span>]=<span class="string">&quot;!formModel.valid&quot;</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-card-actions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-card</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\login\login.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FormBuilder</span>, <span class="title class_">FormGroup</span>, <span class="title class_">Validators</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../_service/user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-login&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./login.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./login.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="comment">//#region form 相關</span></span><br><span class="line">  <span class="attr">formModel</span>: <span class="title class_">FormGroup</span>;</span><br><span class="line">  hide = <span class="literal">true</span>;</span><br><span class="line">  <span class="attr">userInfo</span>: <span class="built_in">any</span> = &#123;&#125;;</span><br><span class="line">  formErrors = &#123;</span><br><span class="line">    <span class="string">&quot;login_name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;login_pwd&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;formError&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  vaildationMessages = &#123;</span><br><span class="line">    <span class="string">&quot;login_name&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: <span class="string">&quot;郵箱必須輸入&quot;</span>,</span><br><span class="line">      <span class="string">&quot;minlength&quot;</span>: <span class="string">&quot;請輸入至少要4位&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;login_pwd&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: <span class="string">&quot;密碼必須輸入&quot;</span>,</span><br><span class="line">      <span class="string">&quot;minlength&quot;</span>: <span class="string">&quot;密碼至少要4位&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">//#endregion form 相關</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> fb: FormBuilder,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> router: Router,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> userService: UserService</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">buildForm</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">buildForm</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">formModel</span> = <span class="variable language_">this</span>.<span class="property">fb</span>.<span class="title function_">group</span>(&#123;</span><br><span class="line">      <span class="string">&quot;login_name&quot;</span>: [</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_name</span>,</span><br><span class="line">        [</span><br><span class="line">          <span class="title class_">Validators</span>.<span class="property">required</span>,</span><br><span class="line">          <span class="title class_">Validators</span>.<span class="title function_">minLength</span>(<span class="number">4</span>),</span><br><span class="line">        ]</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;login_pwd&quot;</span>: [</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_pwd</span>,</span><br><span class="line">        [</span><br><span class="line">          <span class="title class_">Validators</span>.<span class="property">required</span>,</span><br><span class="line">          <span class="title class_">Validators</span>.<span class="title function_">minLength</span>(<span class="number">4</span>),</span><br><span class="line">        ]</span><br><span class="line">      ]</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">valueChanges</span>.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onValueChange</span>(data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onValueChange</span>(<span class="params">data?: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">formModel</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//檢查是否有錯誤和顯示錯誤訊息</span></span><br><span class="line">    <span class="keyword">const</span> form = <span class="variable language_">this</span>.<span class="property">formModel</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> field <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">formErrors</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">formErrors</span>[field] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">const</span> control = form.<span class="title function_">get</span>(field);</span><br><span class="line">      <span class="keyword">if</span> (control &amp;&amp; control.<span class="property">dirty</span> &amp;&amp; !control.<span class="property">valid</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> messages = <span class="variable language_">this</span>.<span class="property">vaildationMessages</span>[field];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> control.<span class="property">errors</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">formErrors</span>[field] += messages[key] + <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onSubmit</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">valid</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title class_">Post</span>(<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>).<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>web\controller\user\User.py</code>先將資料轉成json來處理</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        app.logger.debug(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login get&quot;</span>), <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if request.method == &quot;POST&quot;:</span></span><br><span class="line">    <span class="comment">#     return make_response(jsonify(&quot;用戶登入&quot;), 200) </span></span><br><span class="line">    <span class="comment"># 取值</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment">#app.logger.debug(&quot;POST&quot;)</span></span><br><span class="line">        <span class="comment">#取得JSON的值因為angular是這樣傳值的</span></span><br><span class="line">        data = json.loads(request.data)</span><br><span class="line">        app.logger.debug(data)</span><br><span class="line">        <span class="comment">#req= request.values</span></span><br><span class="line">        login_name = data[<span class="string">&#x27;login_name&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_name&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">        login_pwd = data[<span class="string">&#x27;login_pwd&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_pwd&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        resmsg=<span class="string">&quot;%s-%s&quot;</span> % (login_name,login_pwd)</span><br><span class="line">        app.logger.debug(resmsg)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(resmsg),<span class="number">200</span>)  </span><br></pre></td></tr></table></figure>

<h3 id="網頁參數的判斷"><a href="#網頁參數的判斷" class="headerlink" title="網頁參數的判斷"></a>網頁參數的判斷</h3><p>在<code>web\controller\user\User.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        app.logger.debug(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login get&quot;</span>), <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if request.method == &quot;POST&quot;:</span></span><br><span class="line">    <span class="comment">#     return make_response(jsonify(&quot;用戶登入&quot;), 200) </span></span><br><span class="line">    <span class="comment"># 取值</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment">#app.logger.debug(&quot;POST&quot;)</span></span><br><span class="line">        <span class="comment">#取得JSON的值因為angular是傳json值的</span></span><br><span class="line">        data = json.loads(request.data)</span><br><span class="line">        app.logger.debug(data)</span><br><span class="line">        <span class="comment"># 返回值</span></span><br><span class="line">        resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登錄成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">        login_name = data[<span class="string">&#x27;login_name&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_name&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">        login_pwd = data[<span class="string">&#x27;login_pwd&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_pwd&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        resmsg=<span class="string">&quot;%s-%s&quot;</span> % (login_name,login_pwd)</span><br><span class="line">        app.logger.debug(resmsg)</span><br><span class="line">        <span class="comment"># return make_response(jsonify(resmsg),200)  </span></span><br><span class="line">        <span class="comment"># 檢查參數值</span></span><br><span class="line">        <span class="keyword">if</span> login_name <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_name) &lt; <span class="number">1</span> :</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span></span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄用戶名~~&quot;</span></span><br><span class="line">            app.logger.debug(resp)</span><br><span class="line">            <span class="keyword">return</span> make_response(jsonify(resp))</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> login_pwd <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_pwd) &lt;<span class="number">1</span>:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span></span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄密碼~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> make_response(jsonify(resp),<span class="number">200</span>)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(resmsg),<span class="number">200</span>)  </span><br></pre></td></tr></table></figure>

<h3 id="帳號和密碼的判斷"><a href="#帳號和密碼的判斷" class="headerlink" title="帳號和密碼的判斷"></a>帳號和密碼的判斷</h3><p>先來使用sql來逼立第一個帳號和密碼</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` (`uid`, `nickname`, `mobile`, `email`, `sex`, `avatar`, `login_name`, `login_pwd`, `login_salt`, `status`, `updated_time`, `created_time`)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">	(<span class="number">1</span>, <span class="string">&#x27;正點學院&#x27;</span>, <span class="string">&#x27;11012345679&#x27;</span>, <span class="string">&#x27;apanly@163.com&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;54php&#x27;</span>, <span class="string">&#x27;816440c40b7a9d55ff9eb7b20760862c&#x27;</span>, <span class="string">&#x27;cF3JfH5FJfQ8B2Ba&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;2017-03-15 14:08:48&#x27;</span>, <span class="string">&#x27;2017-03-15 14:08:48&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>他的帳號<code>54php</code>,密碼<code>123456</code></p>
<p>建立加密服務在<code>common\libs\user\UserService.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib,base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span>():</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">genePwd</span>(<span class="params">pwd,salt</span>):</span><br><span class="line">        <span class="comment"># 啟動md5</span></span><br><span class="line">        m= hashlib.md5()</span><br><span class="line">        <span class="built_in">str</span>=<span class="string">&quot;%s-%s&quot;</span>%( base64.encodebytes(pwd.encode(<span class="string">&quot;utf-8&quot;</span>)),salt)</span><br><span class="line">        <span class="comment"># 產生md5</span></span><br><span class="line">        m.update(<span class="built_in">str</span>.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> m.hexdigest()</span><br></pre></td></tr></table></figure>

<p>在<code>web\controller\user\User.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"><span class="keyword">from</span> common.models.User <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> common.libs.user.UserService <span class="keyword">import</span> UserService</span><br><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        app.logger.debug(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login get&quot;</span>), <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if request.method == &quot;POST&quot;:</span></span><br><span class="line">    <span class="comment">#     return make_response(jsonify(&quot;用戶登入&quot;), 200) </span></span><br><span class="line">    <span class="comment"># 取值</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment">#app.logger.debug(&quot;POST&quot;)</span></span><br><span class="line">        <span class="comment">#取得JSON的值因為angular是傳json值的</span></span><br><span class="line">        data = json.loads(request.data)</span><br><span class="line">        app.logger.debug(data)</span><br><span class="line">        <span class="comment"># 返回值</span></span><br><span class="line">        resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登錄成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">        login_name = data[<span class="string">&#x27;login_name&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_name&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">        login_pwd = data[<span class="string">&#x27;login_pwd&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_pwd&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        resmsg=<span class="string">&quot;%s-%s&quot;</span> % (login_name,login_pwd)</span><br><span class="line">        app.logger.debug(resmsg)</span><br><span class="line">        <span class="comment"># return make_response(jsonify(resmsg),200)  </span></span><br><span class="line">        <span class="comment"># 檢查參數值</span></span><br><span class="line">        <span class="keyword">if</span> login_name <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_name) &lt; <span class="number">1</span> :</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span></span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄用戶名~~&quot;</span></span><br><span class="line">            app.logger.debug(resp)</span><br><span class="line">            <span class="keyword">return</span> make_response(jsonify(resp))</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> login_pwd <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_pwd) &lt;<span class="number">1</span>:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span></span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄密碼~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> make_response(jsonify(resp),<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 資料庫相關</span></span><br><span class="line">        user_info = User.query.filter_by( login_name= login_name).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_info:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span></span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的用戶名和密碼-1~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> make_response(jsonify(resp),<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 檢查密碼</span></span><br><span class="line">        <span class="keyword">if</span> user_info.login_pwd != UserService.genePwd(login_pwd,user_info.login_salt):</span><br><span class="line">           resp[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span></span><br><span class="line">           resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的用戶名和密碼-2~~&quot;</span></span><br><span class="line">           <span class="keyword">return</span> make_response(jsonify(resp),<span class="number">200</span>) </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(resmsg),<span class="number">200</span>)  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="建立auth-code"><a href="#建立auth-code" class="headerlink" title="建立auth code"></a>建立auth code</h2><p>在<code>config\base_setting.py</code>中先建立回傳的值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">SERVER_PORT = <span class="number">5000</span></span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line">SQLALCHEMY_ECHO = <span class="literal">False</span></span><br><span class="line">API_VERSION = <span class="string">&#x27;v0.0&#x27;</span></span><br><span class="line"></span><br><span class="line">AUTH_TOKEN_NAME=<span class="string">&quot;authtoken&quot;</span></span><br></pre></td></tr></table></figure>

<p>在<code>common\libs\user\UserService.py</code>中來產生auth code </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib,base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span>():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 產生auth code</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">geneAuthCode</span>(<span class="params">user_info</span>):</span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        <span class="built_in">str</span> = <span class="string">&quot;%s-%s-%s-%s&quot;</span>%(user_info.uid,user_info.login_name,user_info.login_pwd,user_info.login_salt)</span><br><span class="line">        <span class="comment"># 產生md5</span></span><br><span class="line">        m.update(<span class="built_in">str</span>.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">genePwd</span>(<span class="params">pwd,salt</span>):</span><br><span class="line">        <span class="comment"># 啟動md5</span></span><br><span class="line">        m= hashlib.md5()</span><br><span class="line">        <span class="built_in">str</span>=<span class="string">&quot;%s-%s&quot;</span>%( base64.encodebytes(pwd.encode(<span class="string">&quot;utf-8&quot;</span>)),salt)</span><br><span class="line">        <span class="comment"># 產生md5</span></span><br><span class="line">        m.update(<span class="built_in">str</span>.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> m.hexdigest()</span><br></pre></td></tr></table></figure>

<p>在登入成功後，回傳給client在<code>web\controller\user\User.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"><span class="keyword">from</span> common.models.User <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> common.libs.user.UserService <span class="keyword">import</span> UserService</span><br><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">   	<span class="comment"># ----</span></span><br><span class="line">    <span class="comment"># 取值</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">         	<span class="comment"># ----</span></span><br><span class="line">        <span class="comment"># 返回值</span></span><br><span class="line">        resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登錄成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">        login_name = data[<span class="string">&#x27;login_name&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_name&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">        login_pwd = data[<span class="string">&#x27;login_pwd&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_pwd&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      	<span class="comment"># ----</span></span><br><span class="line">        <span class="comment"># 檢查參數值</span></span><br><span class="line">        <span class="comment"># ----</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 資料庫相關</span></span><br><span class="line">        <span class="comment"># ----</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 檢查密碼</span></span><br><span class="line">        <span class="comment"># ----</span></span><br><span class="line">        <span class="comment"># 登入成功 時，返回 auth code </span></span><br><span class="line">        tokenData=<span class="built_in">dict</span>()</span><br><span class="line">        <span class="comment">#tokenData[&quot;mooc_foo&quot;]=&quot;%s#%s&quot;%(&quot;aaaaa&quot;,user_info.uid)</span></span><br><span class="line">        tokenData[app.config[<span class="string">&quot;AUTH_TOKEN_NAME&quot;</span>]]=<span class="string">&quot;%s#%s&quot;</span>%(UserService.geneAuthCode(user_info),user_info.uid)</span><br><span class="line">        </span><br><span class="line">        resp[<span class="string">&#x27;data&#x27;</span>]=tokenData</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(resp),<span class="number">200</span>)  </span><br></pre></td></tr></table></figure>

<p>在client端的JS將此資料儲在localStorage</p>
<p>在client建立服務<code>src\app\_service\auth\authentication.service.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../../_models/user-info&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthenticationService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line">  <span class="title function_">loginSuccess</span>(<span class="params">username: <span class="built_in">string</span>, password: <span class="built_in">string</span>, resdata: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(resdata);</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">new</span> <span class="title class_">UserInfo</span>;</span><br><span class="line">    user.<span class="property">login_name</span> = username;</span><br><span class="line">    user.<span class="property">user_token</span> = resdata.<span class="property">data</span>.<span class="property">authtoken</span>;</span><br><span class="line">    <span class="comment">//console.log(user);</span></span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;foodUser&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user));</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在client的login中修改如下</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FormBuilder</span>, <span class="title class_">FormGroup</span>, <span class="title class_">Validators</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthenticationService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../_service/auth/authentication.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../_service/user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-login&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./login.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./login.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="comment">//#region form 相關</span></span><br><span class="line">  <span class="attr">formModel</span>: <span class="title class_">FormGroup</span>;</span><br><span class="line">  hide = <span class="literal">true</span>;</span><br><span class="line">  <span class="attr">userInfo</span>: <span class="built_in">any</span> = &#123;&#125;;</span><br><span class="line">  formErrors = &#123;</span><br><span class="line">    <span class="string">&quot;login_name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;login_pwd&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;formError&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  vaildationMessages = &#123;</span><br><span class="line">    <span class="string">&quot;login_name&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: <span class="string">&quot;必須輸入&quot;</span>,</span><br><span class="line">      <span class="string">&quot;minlength&quot;</span>: <span class="string">&quot;請輸入至少要4位&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;login_pwd&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: <span class="string">&quot;密碼必須輸入&quot;</span>,</span><br><span class="line">      <span class="string">&quot;minlength&quot;</span>: <span class="string">&quot;密碼至少要4位&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">//#endregion form 相關</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> fb: FormBuilder,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> router: Router,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> userService: UserService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> authenticationService: AuthenticationService</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">buildForm</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">buildForm</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">formModel</span> = <span class="variable language_">this</span>.<span class="property">fb</span>.<span class="title function_">group</span>(&#123;</span><br><span class="line">      <span class="string">&quot;login_name&quot;</span>: [</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_name</span>,</span><br><span class="line">        [</span><br><span class="line">          <span class="comment">// Validators.required,</span></span><br><span class="line">          <span class="comment">// Validators.minLength(4),</span></span><br><span class="line">        ]</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;login_pwd&quot;</span>: [</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_pwd</span>,</span><br><span class="line">        [</span><br><span class="line">          <span class="comment">// Validators.required,</span></span><br><span class="line">          <span class="comment">// Validators.minLength(4),</span></span><br><span class="line">        ]</span><br><span class="line">      ]</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">valueChanges</span>.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onValueChange</span>(data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onValueChange</span>(<span class="params">data?: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">formModel</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//檢查是否有錯誤和顯示錯誤訊息</span></span><br><span class="line">    <span class="keyword">const</span> form = <span class="variable language_">this</span>.<span class="property">formModel</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> field <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">formErrors</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">formErrors</span>[field] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">const</span> control = form.<span class="title function_">get</span>(field);</span><br><span class="line">      <span class="keyword">if</span> (control &amp;&amp; control.<span class="property">dirty</span> &amp;&amp; !control.<span class="property">valid</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> messages = <span class="variable language_">this</span>.<span class="property">vaildationMessages</span>[field];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> control.<span class="property">errors</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">formErrors</span>[field] += messages[key] + <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onSubmit</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">valid</span>) &#123;</span><br><span class="line">      <span class="comment">//console.log(this.formModel.value);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userInfo</span> = <span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title class_">Post</span>(<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>).<span class="title function_">subscribe</span>(</span><br><span class="line">        <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="title function_">loginSuccess</span>(<span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_name</span>, <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_pwd</span>, res);</span><br><span class="line">          <span class="comment">//console.log(res);</span></span><br><span class="line">          <span class="keyword">let</span> url = <span class="string">&#x27;/dashboard&#x27;</span>;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">`<span class="subst">$&#123;url&#125;</span>`</span>]);</span><br><span class="line">          <span class="comment">//this.router.navigate([&#x27;&#x27;]);</span></span><br><span class="line">          <span class="comment">//this.router.navigate([&#x27;/dashboard&#x27;]);</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="在client建立回傳值的dialog"><a href="#在client建立回傳值的dialog" class="headerlink" title="在client建立回傳值的dialog"></a>在client建立回傳值的dialog</h2><p>先來建立資料夾<code>src\app\_dialog</code>，在將元件放在此</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g component _dialog/SimpleDialog</span><br></pre></td></tr></table></figure>

<p>加入服務</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g service _services/messagebox/Messagebox</span><br></pre></td></tr></table></figure>

<p>建立ts檔</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_dialog/message-box.ts</span><br><span class="line">_dialog/message-enums.ts</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\app.module.ts</code>加入對話框</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">entryComponents</span>: [</span><br><span class="line">    <span class="title class_">SimpleDialogComponent</span>,</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\_services\messagebox\messagebox.service.ts</code>中加入部分的回傳值</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialog</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MessageBox</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_dialog/message-box&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MessageBoxButton</span>, <span class="title class_">MessageBoxStyle</span>, <span class="title class_">RespCode</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_dialog/message-enums&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">MessageboxService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialog: MatDialog,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> router: Router,</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line">  <span class="title class_">ResponseErrorMsg</span>(error, message = <span class="string">&#x27;Please login again.&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(&quot;ResponseErrorMsg-&gt;&quot; + error.status);</span></span><br><span class="line">    <span class="keyword">switch</span> (error.<span class="property">status</span>) &#123;</span><br><span class="line">      <span class="comment">// case RespCode.ARGS_ERROR:// = 912,//# 上傳參數錯誤</span></span><br><span class="line">      <span class="comment">//   message = &quot;912 Parameter error&quot;;</span></span><br><span class="line">      <span class="comment">//   MessageBox.show(this.dialog, message);</span></span><br><span class="line">      <span class="comment">//   break;</span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">RespCode</span>.<span class="property">UNDEFINERROR</span>:<span class="comment">// = 999 //# 未定義的錯誤</span></span><br><span class="line">        message = <span class="string">&quot;999 Undefine error&quot;</span>;</span><br><span class="line">        <span class="title class_">MessageBox</span>.<span class="title function_">show</span>(<span class="variable language_">this</span>.<span class="property">dialog</span>, message);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        message = <span class="string">`<span class="subst">$&#123;error.status&#125;</span> <span class="subst">$&#123;error.statusText&#125;</span>`</span>;</span><br><span class="line">        <span class="title class_">MessageBox</span>.<span class="title function_">show</span>(<span class="variable language_">this</span>.<span class="property">dialog</span>, message);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服務器回傳成功訊息顯示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="title class_">SuccessDialog</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> message = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> title = <span class="string">&quot;Info&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> information = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> button = <span class="title class_">MessageBoxButton</span>.<span class="property">Ok</span>;</span><br><span class="line">    <span class="keyword">let</span> allow_outside_click = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> style = <span class="title class_">MessageBoxStyle</span>.<span class="property">Full</span>;</span><br><span class="line">    <span class="keyword">let</span> width = <span class="string">&quot;450px&quot;</span>;</span><br><span class="line">    <span class="title class_">MessageBox</span>.<span class="title function_">show</span>(<span class="variable language_">this</span>.<span class="property">dialog</span>, message, title, information, button, allow_outside_click, style, width);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\login\login.component.ts</code>中修改</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">onSubmit</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">valid</span>) &#123;</span><br><span class="line">      <span class="comment">//console.log(this.formModel.value);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userInfo</span> = <span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title class_">Post</span>(<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>).<span class="title function_">subscribe</span>(</span><br><span class="line">        <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="title function_">loginSuccess</span>(<span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_name</span>, <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_pwd</span>, res);</span><br><span class="line">          <span class="comment">//console.log(res);</span></span><br><span class="line">          <span class="keyword">let</span> url = <span class="string">&#x27;/dashboard&#x27;</span>;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">`<span class="subst">$&#123;url&#125;</span>`</span>]);</span><br><span class="line">          <span class="comment">//this.router.navigate([&#x27;&#x27;]);</span></span><br><span class="line">          <span class="comment">//this.router.navigate([&#x27;/dashboard&#x27;]);</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// console.log(&quot;----------------------&quot;);</span></span><br><span class="line">          <span class="comment">// console.log(error);</span></span><br><span class="line">          <span class="comment">// console.log(&quot;----------------------&quot;);</span></span><br><span class="line">          <span class="comment">//this.authenticationService.loginFail(error);</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">messageboxService</span>.<span class="title class_">ResponseErrorMsg</span>(error);</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;/login&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在Python端</p>
<p>在增加回傳碼<code>common\libs\response\RespCode.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RespCode</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    UNDEFINERROR = <span class="number">999</span> <span class="comment"># 未定義的錯誤</span></span><br></pre></td></tr></table></figure>

<p>在<code>web\controller\user\User.py</code>修改一下回傳的方式，有錯誤值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> common.models.User <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> common.libs.user.UserService <span class="keyword">import</span> UserService</span><br><span class="line"><span class="keyword">from</span> common.libs.response.RespCode <span class="keyword">import</span> RespCode</span><br><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        app.logger.debug(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login get&quot;</span>), <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if request.method == &quot;POST&quot;:</span></span><br><span class="line">    <span class="comment">#     return make_response(jsonify(&quot;用戶登入&quot;), 200) </span></span><br><span class="line">    <span class="comment"># 取值</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment">#app.logger.debug(&quot;POST&quot;)</span></span><br><span class="line">        <span class="comment">#取得JSON的值因為angular是傳json值的</span></span><br><span class="line">        data = json.loads(request.data)</span><br><span class="line">        app.logger.debug(data)</span><br><span class="line">        <span class="comment"># 返回值</span></span><br><span class="line">        resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登錄成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">        login_name = data[<span class="string">&#x27;login_name&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_name&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">        login_pwd = data[<span class="string">&#x27;login_pwd&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_pwd&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        resmsg=<span class="string">&quot;%s-%s&quot;</span> % (login_name,login_pwd)</span><br><span class="line">        app.logger.debug(resmsg)</span><br><span class="line">        <span class="comment"># return make_response(jsonify(resmsg),200)  </span></span><br><span class="line">        <span class="comment"># 檢查參數值</span></span><br><span class="line">        <span class="keyword">if</span> login_name <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_name) &lt; <span class="number">1</span> :</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄用戶名~~&quot;</span></span><br><span class="line">            app.logger.debug(resp)</span><br><span class="line">            <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> login_pwd <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_pwd) &lt;<span class="number">1</span>:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄密碼~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 資料庫相關</span></span><br><span class="line">        user_info = User.query.filter_by( login_name= login_name).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_info:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的用戶名和密碼-1~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 檢查密碼</span></span><br><span class="line">        <span class="keyword">if</span> user_info.login_pwd != UserService.genePwd(login_pwd,user_info.login_salt):</span><br><span class="line">           resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">           resp[<span class="string">&#x27;msg&#x27;</span>] =<span class="string">&quot;請輸入正確的用戶名和密碼-2~~&quot;</span></span><br><span class="line">           <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line">        <span class="comment"># 登入成功 時，返回 auth code </span></span><br><span class="line">        tokenData=<span class="built_in">dict</span>()</span><br><span class="line">        <span class="comment">#tokenData[&quot;mooc_foo&quot;]=&quot;%s#%s&quot;%(&quot;aaaaa&quot;,user_info.uid)</span></span><br><span class="line">        tokenData[app.config[<span class="string">&quot;AUTH_TOKEN_NAME&quot;</span>]]=<span class="string">&quot;%s#%s&quot;</span>%(UserService.geneAuthCode(user_info),user_info.uid)</span><br><span class="line">        </span><br><span class="line">        resp[<span class="string">&#x27;data&#x27;</span>]=tokenData</span><br><span class="line">        <span class="comment">#return make_response(jsonify(resp),200)  </span></span><br><span class="line">        <span class="keyword">return</span> jsonify(resp)  </span><br></pre></td></tr></table></figure>

<h2 id="攔劫器"><a href="#攔劫器" class="headerlink" title="攔劫器"></a>攔劫器</h2><p>這是為了判斷使用者是不是合法的登入，在client端和server端都要來判斷</p>
<h3 id="client端"><a href="#client端" class="headerlink" title="client端"></a>client端</h3><p>在每次傳送時，要將authkey代入，傳給server端，來檢查是否可以來進行操作</p>
<p>加入攔劫器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g interceptor _helpers/HttpConfig --flat</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\_helpers\httpconfig.interceptor.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">HttpRequest</span>,</span><br><span class="line">  <span class="title class_">HttpHandler</span>,</span><br><span class="line">  <span class="title class_">HttpEvent</span>,</span><br><span class="line">  <span class="title class_">HttpInterceptor</span>,</span><br><span class="line">  <span class="title class_">HttpResponse</span>,</span><br><span class="line">  <span class="title class_">HttpErrorResponse</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span>, throwError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthenticationService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../_service/auth/authentication.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HttpConfigInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HttpInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> authenticationService: AuthenticationService</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">intercept</span>(<span class="attr">request</span>: <span class="title class_">HttpRequest</span>&lt;<span class="built_in">unknown</span>&gt;, <span class="attr">next</span>: <span class="title class_">HttpHandler</span>): <span class="title class_">Observable</span>&lt;<span class="title class_">HttpEvent</span>&lt;<span class="built_in">unknown</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">//有token</span></span><br><span class="line">    <span class="comment">// add authorization header with basic auth credentials if available</span></span><br><span class="line">    <span class="keyword">const</span> currentUser = <span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="property">currentUserValue</span>;</span><br><span class="line">    <span class="keyword">if</span> (currentUser) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">token</span>: <span class="built_in">string</span> = currentUser.<span class="property">user_token</span>;</span><br><span class="line">      <span class="keyword">if</span> (token) &#123;</span><br><span class="line">        request = request.<span class="title function_">clone</span>(&#123; <span class="attr">headers</span>: request.<span class="property">headers</span>.<span class="title function_">set</span>(<span class="string">&#x27;Authorization&#x27;</span>, token) &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if (!request.headers.has(&#x27;Content-Type&#x27;)) &#123;</span></span><br><span class="line">    <span class="comment">//   request = request.clone(&#123; headers: request.headers.set(&#x27;Content-Type&#x27;, &#x27;application/json&#x27;) &#125;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//request = request.clone(&#123; headers: request.headers.set(&#x27;Accept&#x27;, &#x27;application/json&#x27;) &#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next.<span class="title function_">handle</span>(request).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">map</span>(<span class="function">(<span class="params">event: HttpEvent&lt;<span class="built_in">any</span>&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> <span class="title class_">HttpResponse</span>) &#123;</span><br><span class="line">          <span class="comment">//console.log(&#x27;event---&gt;&gt;&gt;&#x27;, event);</span></span><br><span class="line">          <span class="comment">// this.errorDialogService.openDialog(event);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> event;</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="title function_">catchError</span>(<span class="function">(<span class="params">error: HttpErrorResponse</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> data = &#123;&#125;;</span><br><span class="line">        data = &#123;</span><br><span class="line">          <span class="attr">reason</span>: error &amp;&amp; error.<span class="property">error</span> &amp;&amp; error.<span class="property">error</span>.<span class="property">reason</span> ? error.<span class="property">error</span>.<span class="property">reason</span> : <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">          <span class="attr">status</span>: error.<span class="property">status</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//this.errorDialogService.openDialog(data);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">throwError</span>(error);</span><br><span class="line">      &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在未認證的清況下，可以在client端的dashboard中使用api</p>
<p>在<code>web\controller\user\User.py</code>中加入測試的API</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> common.models.User <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> common.libs.user.UserService <span class="keyword">import</span> UserService</span><br><span class="line"><span class="keyword">from</span> common.libs.response.RespCode <span class="keyword">import</span> RespCode</span><br><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        app.logger.debug(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login get&quot;</span>), <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if request.method == &quot;POST&quot;:</span></span><br><span class="line">    <span class="comment">#     return make_response(jsonify(&quot;用戶登入&quot;), 200) </span></span><br><span class="line">    <span class="comment"># 取值</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment">#app.logger.debug(&quot;POST&quot;)</span></span><br><span class="line">        <span class="comment">#取得JSON的值因為angular是傳json值的</span></span><br><span class="line">        data = json.loads(request.data)</span><br><span class="line">        app.logger.debug(data)</span><br><span class="line">        <span class="comment"># 返回值</span></span><br><span class="line">        resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登錄成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">        login_name = data[<span class="string">&#x27;login_name&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_name&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">        login_pwd = data[<span class="string">&#x27;login_pwd&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_pwd&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        resmsg=<span class="string">&quot;%s-%s&quot;</span> % (login_name,login_pwd)</span><br><span class="line">        app.logger.debug(resmsg)</span><br><span class="line">        <span class="comment"># return make_response(jsonify(resmsg),200)  </span></span><br><span class="line">        <span class="comment"># 檢查參數值</span></span><br><span class="line">        <span class="keyword">if</span> login_name <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_name) &lt; <span class="number">1</span> :</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄用戶名~~&quot;</span></span><br><span class="line">            app.logger.debug(resp)</span><br><span class="line">            <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> login_pwd <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_pwd) &lt;<span class="number">1</span>:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄密碼~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 資料庫相關</span></span><br><span class="line">        user_info = User.query.filter_by( login_name= login_name).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_info:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的用戶名和密碼-1~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 檢查密碼</span></span><br><span class="line">        <span class="keyword">if</span> user_info.login_pwd != UserService.genePwd(login_pwd,user_info.login_salt):</span><br><span class="line">           resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">           resp[<span class="string">&#x27;msg&#x27;</span>] =<span class="string">&quot;請輸入正確的用戶名和密碼-2~~&quot;</span></span><br><span class="line">           <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line">        <span class="comment"># 登入成功 時，返回 auth code </span></span><br><span class="line">        tokenData=<span class="built_in">dict</span>()</span><br><span class="line">        <span class="comment">#tokenData[&quot;mooc_foo&quot;]=&quot;%s#%s&quot;%(&quot;aaaaa&quot;,user_info.uid)</span></span><br><span class="line">        tokenData[app.config[<span class="string">&quot;AUTH_TOKEN_NAME&quot;</span>]]=<span class="string">&quot;%s#%s&quot;</span>%(UserService.geneAuthCode(user_info),user_info.uid)</span><br><span class="line">        </span><br><span class="line">        resp[<span class="string">&#x27;data&#x27;</span>]=tokenData</span><br><span class="line">        <span class="comment">#return make_response(jsonify(resp),200)  </span></span><br><span class="line">        <span class="keyword">return</span> jsonify(resp)  </span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/example&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">userexample</span>():</span><br><span class="line">    <span class="comment"># 返回值</span></span><br><span class="line">    resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;測試成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">    <span class="keyword">return</span> jsonify(resp)  </span><br></pre></td></tr></table></figure>

<p>在<code>src\app\_service\user.service.ts</code>中加入服務的API</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; environment &#125; <span class="keyword">from</span> <span class="string">&#x27;src/environments/environment&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">  api = <span class="string">`<span class="subst">$&#123;environment.apiUrl&#125;</span>/user/login`</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient</span>) &#123; &#125;</span><br><span class="line">  <span class="title class_">Gets</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="built_in">any</span>&gt;(<span class="variable language_">this</span>.<span class="property">api</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Post</span>(data) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="built_in">any</span>&gt;(<span class="variable language_">this</span>.<span class="property">api</span>, data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">example</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> url = <span class="string">`<span class="subst">$&#123;environment.apiUrl&#125;</span>/user/example`</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="built_in">any</span>&gt;(url);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\dashboard\dashboard.component.ts</code>中來呼叫</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_service/user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-dashboard&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./dashboard.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./dashboard.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DashboardComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> userService: UserService,</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">example</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在服務端要檢查，所以加入攔劫器<code>web\interceptors\AuthInterceptor.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">before_request</span>():</span><br><span class="line">    path= request.path</span><br><span class="line">    check_login()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">判斷用戶是否已經登錄</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_login</span>():</span><br><span class="line">    <span class="comment">#app.logger.info(&quot;headers=&#123;&#125;&quot;.format(request.headers))  </span></span><br><span class="line">    token = request.headers.get(<span class="string">&#x27;Authorization&#x27;</span>)</span><br><span class="line">    app.logger.info(<span class="string">&quot;token=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(token))    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>www.py</code>中來調用它</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line">#註冊攔劫器</span><br><span class="line"><span class="keyword">from</span> web.<span class="property">interceptors</span>.<span class="property">AuthInterceptor</span> <span class="keyword">import</span> *</span><br><span class="line">#註冊攔劫器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#藍圖功能，對所有的url進行藍圖功能配置</span><br><span class="line"><span class="keyword">from</span> web.<span class="property">controller</span>.<span class="property">index</span> <span class="keyword">import</span> router_index</span><br><span class="line"><span class="keyword">from</span> web.<span class="property">controller</span>.<span class="property">user</span>.<span class="property">User</span> <span class="keyword">import</span> router_user</span><br><span class="line">#app.<span class="title function_">register_blueprint</span>(router_index,url_prefix=<span class="string">&quot;/&quot;</span>)</span><br><span class="line">#app.<span class="title function_">register_blueprint</span>(router_user,url_prefix = <span class="string">&quot;/v0.0/user&quot;</span>)</span><br><span class="line">app.<span class="title function_">register_blueprint</span>(router_index,url_prefix=<span class="string">&#x27;/&#123;0&#125;/&#x27;</span>.<span class="title function_">format</span>(app.<span class="property">config</span>[<span class="string">&#x27;API_VERSION&#x27;</span>]))</span><br><span class="line">app.<span class="title function_">register_blueprint</span>(router_user,url_prefix=<span class="string">&#x27;/&#123;0&#125;/user&#x27;</span>.<span class="title function_">format</span>(app.<span class="property">config</span>[<span class="string">&#x27;API_VERSION&#x27;</span>]))</span><br><span class="line">#藍圖功能，對所有的url進行藍圖功能配置</span><br></pre></td></tr></table></figure>

<p>在client端配置好，可以在debug 訊息中看到取到token</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[2020-12-11 02:55:00,312] INFO <span class="keyword">in</span> AuthInterceptor: token=c51aec6a2f71ea77208bf7bad53da850<span class="comment">#1</span></span><br><span class="line">127.0.0.1 - - [11/Dec/2020 02:55:00] <span class="string">&quot;GET /v0.0/user/example HTTP/1.0&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<h3 id="否是需要檢查登入"><a href="#否是需要檢查登入" class="headerlink" title="否是需要檢查登入"></a>否是需要檢查登入</h3><p>有些網址不需要檢查是否已登入，例如登入的網址</p>
<p>加入不用檢查的網址在<code>config\base_setting.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">SERVER_PORT = <span class="number">5000</span></span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line">SQLALCHEMY_ECHO = <span class="literal">False</span></span><br><span class="line">API_VERSION = <span class="string">&#x27;v0.0&#x27;</span></span><br><span class="line"></span><br><span class="line">AUTH_TOKEN_NAME=<span class="string">&quot;authtoken&quot;</span></span><br><span class="line"><span class="comment"># 過濾url</span></span><br><span class="line">IGNORE_URLS=[</span><br><span class="line">    <span class="string">&quot;^/&#123;0&#125;/user/login&quot;</span>.<span class="built_in">format</span>(API_VERSION),</span><br><span class="line">]</span><br><span class="line">IGNORE_CHECK_LOGIN_URLS=[</span><br><span class="line">    <span class="string">&quot;^/favicon.ico&quot;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="comment"># 過濾url</span></span><br></pre></td></tr></table></figure>

<p>在<code>web\interceptors\AuthInterceptor.py</code>來判斷</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> common.models.User <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> common.libs.user.UserService <span class="keyword">import</span> UserService</span><br><span class="line"><span class="keyword">from</span> common.libs.response.RespCode <span class="keyword">import</span> RespCode</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">before_request</span>():</span><br><span class="line">    path= request.path</span><br><span class="line">    <span class="comment"># 返回值</span></span><br><span class="line">    resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登錄成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#不用檢查</span></span><br><span class="line">    ignore_urls= app.config[<span class="string">&#x27;IGNORE_URLS&#x27;</span>]</span><br><span class="line">    ignore_check_login_urls=app.config[<span class="string">&#x27;IGNORE_CHECK_LOGIN_URLS&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    pattern=re.<span class="built_in">compile</span>(<span class="string">&#x27;%s&#x27;</span> % <span class="string">&quot;|&quot;</span>.join(ignore_check_login_urls))</span><br><span class="line">    <span class="keyword">if</span> pattern.<span class="keyword">match</span>(path):</span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">   </span><br><span class="line">    user_info=check_login()</span><br><span class="line"></span><br><span class="line">    pattern=re.<span class="built_in">compile</span>(<span class="string">&#x27;%s&#x27;</span> % <span class="string">&quot;|&quot;</span>.join(ignore_urls))</span><br><span class="line">    <span class="comment">#app.logger.info(&quot;pattern=&#123;&#125;&quot;.format(pattern)) </span></span><br><span class="line">    <span class="comment">#app.logger.info(&quot;path=&#123;&#125;&quot;.format(path)) </span></span><br><span class="line">    <span class="keyword">if</span> pattern.<span class="keyword">match</span>(path):</span><br><span class="line">        <span class="comment">#app.logger.info(&quot;match=&#123;&#125;&quot;.format(ignore_urls)) </span></span><br><span class="line">        <span class="comment">#return resp[&#x27;msg&#x27;],resp[&#x27;code&#x27;]  </span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_info:</span><br><span class="line">       resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.TOKEN_ERROR</span><br><span class="line">       resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;Token 無法解析&quot;</span></span><br><span class="line">       <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]  </span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">判斷用戶是否已經登錄</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_login</span>():</span><br><span class="line">    <span class="comment">#app.logger.info(&quot;headers=&#123;&#125;&quot;.format(request.headers))  </span></span><br><span class="line">    token_info = request.headers.get(<span class="string">&#x27;Authorization&#x27;</span>)</span><br><span class="line">    <span class="comment">#app.logger.info(&quot;token=&#123;&#125;&quot;.format(token)) </span></span><br><span class="line">    <span class="keyword">if</span> token_info <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>   </span><br><span class="line"></span><br><span class="line">    auth_info = token_info.split(<span class="string">&quot;#&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(auth_info) !=<span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user_info=User.query.filter_by( uid=auth_info[<span class="number">1</span>]).first()    </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        app.logger.error(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> user_info <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> auth_info[<span class="number">0</span>] != UserService.geneAuthCode(user_info):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> user_info        </span><br></pre></td></tr></table></figure>

<p>在client加入header和sidebar來登出在header</p>
<p>直接刪除localstorage在<code>src\app\pages\dashboard\header\header.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">EventEmitter</span>, <span class="title class_">OnInit</span>, <span class="title class_">Output</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialog</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MessageBox</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_dialog/message-box&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MessageBoxButton</span>, <span class="title class_">MessageBoxStyle</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_dialog/message-enums&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthenticationService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_service/auth/authentication.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; isNullOrUndefined &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_util/custutil&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; environment &#125; <span class="keyword">from</span> <span class="string">&#x27;src/environments/environment&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-header&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./header.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./header.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HeaderComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="meta">@Output</span>() toggle = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>&lt;<span class="built_in">void</span>&gt;();</span><br><span class="line">  <span class="attr">isLoggedIn$</span>: <span class="title class_">Observable</span>&lt;<span class="built_in">boolean</span>&gt;;</span><br><span class="line">  <span class="attr">login_name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialog: MatDialog,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> router: Router,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> authenticationService: AuthenticationService</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoggedIn$</span> = <span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="title function_">isLoggedIn</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (environment.<span class="property">debug</span> != <span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_">isNullOrUndefined</span>(<span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="property">currentUserValue</span>)) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">login_name</span> = <span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="property">currentUserValue</span>.<span class="property">login_name</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">toggle</span>.<span class="title function_">emit</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(&quot;logout&quot;);</span></span><br><span class="line">    <span class="keyword">let</span> message = <span class="string">&quot;Are you sure logout?&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> title = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> information = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> button = <span class="title class_">MessageBoxButton</span>.<span class="property">YesNo</span>;</span><br><span class="line">    <span class="keyword">let</span> allow_outside_click = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> style = <span class="title class_">MessageBoxStyle</span>.<span class="property">Simple</span>;</span><br><span class="line">    <span class="keyword">let</span> width = <span class="string">&quot;450px&quot;</span>;</span><br><span class="line">    <span class="title class_">MessageBox</span>.<span class="title function_">show</span>(<span class="variable language_">this</span>.<span class="property">dialog</span>, message, title, information, button, allow_outside_click, style, width).<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="keyword">if</span> (res.<span class="property">result</span> == <span class="string">&quot;yes&quot;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="title function_">logout</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;/login&#x27;</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// let respone = &quot;respones value=&quot; + res;</span></span><br><span class="line">      <span class="comment">// MessageBox.show(this.dialog, `The result is : $&#123;respone&#125;`);</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="查看Python的路徑"><a href="#查看Python的路徑" class="headerlink" title="查看Python的路徑"></a>查看Python的路徑</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install dialog</span><br><span class="line"></span><br><span class="line">sudo apt-get -y install git build-essential libpcre3 libpcre3-dev openssl zlib1g-dev cmake clang libclang-dev zlib1g-dev </span><br><span class="line">sudo apt-get -y install python3 python3-pip python3-dev python-dev python3-lxml libxml2-dev libxslt1-dev libffi-dev</span><br><span class="line"></span><br><span class="line">sudo pip3 install --upgrade pip</span><br><span class="line">sudo pip3 install virtualenv uwsgi flask Flask-HTTPAuth gevent zmq pillow qrcode pydes numpy psutil msgpack pytz</span><br><span class="line"></span><br><span class="line">sudo apt-get -y install default-libmysqlclient-dev software-properties-common</span><br><span class="line">sudo pip3 install mysqlclient SQLAlchemy flask-sqlalchemy flask_marshmallow marshmallow-sqlalchemy</span><br></pre></td></tr></table></figure>

<p>可以查看python的模組放在那個路徑</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 -m site</span><br><span class="line">pip3 show flask</span><br></pre></td></tr></table></figure>

<h1 id="安裝uwsgi"><a href="#安裝uwsgi" class="headerlink" title="安裝uwsgi"></a>安裝uwsgi</h1><p>安裝 C 及 Python 開發工具</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install build-essential python-dev python-pip</span><br></pre></td></tr></table></figure>

<p>安裝 uwsgi</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo pip3 install flask SQLAlchemy flask-sqlalchemy mysqlclient flask_script</span><br><span class="line">sudo pip3 install uwsgi</span><br><span class="line">sudo pip3 install gevent</span><br></pre></td></tr></table></figure>

<p>建立 uwsgi-hello.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">application</span>(<span class="params">env, start_response</span>):</span><br><span class="line">    start_response(<span class="string">&#x27;200 OK&#x27;</span>, [(<span class="string">&#x27;Content-Type&#x27;</span>,<span class="string">&#x27;text/html&#x27;</span>)])</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">b&quot;Hello World via uWSGI&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>執行 uWSGI, 作為 HTTP server&#x2F;router, 把 request pass 給 WSGI application uwsgi-hello.py</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">uwsgi --http :9090 --wsgi-file uwsgi-hello.py</span><br></pre></td></tr></table></figure>

<p>使用chrom <a href="http://192.168.83.128:9090/">http://192.168.83.128:9090/</a></p>
<p>配置uwsgi</p>
<p>將程式連接到<code>/usr/share/nginx</code>下面來建立連結<code>sudo ln -s /home/ttom/www/order/ /usr/share/nginx/wa0_0</code>這是API的資料夾</p>
<p>建立服務</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/systemd/system/uwsgi.service</span><br></pre></td></tr></table></figure>

<p>內容</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=uWSGI Emperor <span class="number">0.5</span></span><br><span class="line"><span class="attr">After</span>=syslog.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="comment">#設定檔的位置</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/uwsgi --emperor /usr/share/nginx/wa<span class="number">0_0</span>/config/vassals --uid www-data --gid www-data</span><br><span class="line"><span class="comment"># Requires systemd version 211 or newer</span></span><br><span class="line"><span class="attr">RuntimeDirectory</span>=uwsgi</span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"><span class="attr">KillSignal</span>=SIGQUIT</span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">StandardError</span>=syslog</span><br><span class="line"><span class="attr">NotifyAccess</span>=all</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建立uwsgi設定檔在<code>config\vassals\config.ini</code></p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[uwsgi]</span></span><br><span class="line"><span class="comment">#API程式的路徑</span></span><br><span class="line"><span class="attr">chdir</span> = /usr/share/nginx/wa<span class="number">0_0</span></span><br><span class="line"><span class="comment">#python的環境</span></span><br><span class="line"><span class="comment">#home=/usr/share/python3</span></span><br><span class="line"><span class="attr">module</span> = manage</span><br><span class="line"><span class="attr">callable</span> = app</span><br><span class="line"><span class="attr">master</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment">#processes = 4</span></span><br><span class="line"><span class="attr">processes</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">enable-threads</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">http-websockets</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">gevent-monkey-patch</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">gevent</span> = <span class="number">1024</span></span><br><span class="line"><span class="attr">py-autoreload</span> = <span class="number">3</span>     <span class="comment">#Release時要拿掉</span></span><br><span class="line"></span><br><span class="line"><span class="attr">chmod-socket</span> = <span class="number">660</span></span><br><span class="line"><span class="comment">#chown-socket = www-data:www-data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">uid</span> = www-data</span><br><span class="line"><span class="attr">gid</span> = www-data</span><br><span class="line"><span class="attr">vacuum</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">die-on-term</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment">#stats = 127.0.0.1:5000</span></span><br><span class="line"><span class="comment">#http = 0.0.0.0:5000</span></span><br><span class="line"><span class="attr">socket</span> = /tmp/app<span class="number">0_0</span>.sock</span><br><span class="line"><span class="comment">#daemonize=/var/log/uwsgi/uwsgi.log</span></span><br><span class="line"></span><br><span class="line"><span class="attr">post-buffering</span> = <span class="number">16384</span>    <span class="comment">#沒這行會一直有502錯誤</span></span><br><span class="line"><span class="attr">buffer-size</span> = <span class="number">131072</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#開啟log</span></span><br><span class="line"><span class="attr">log-maxsize</span> = <span class="number">5000000</span></span><br><span class="line"><span class="attr">logto</span> = /tmp/uwsgi_0.<span class="number">0</span>.log</span><br><span class="line"><span class="attr">log-master</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">threaded-log</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#要Debug才能開啟</span></span><br><span class="line"><span class="attr">catch-exceptions</span> = <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在linux的命令行中，加入系統變數</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo -H vim /etc/environment</span><br><span class="line">ops_config=&quot;local&quot;</span><br></pre></td></tr></table></figure>

<p>在配置中的環境是不一樣的,登出和登入don’t forget to logout and login again to enable the environment variables.</p>
<p>目前無作用</p>
<h1 id="WebSocket相關"><a href="#WebSocket相關" class="headerlink" title="WebSocket相關"></a>WebSocket相關</h1><h2 id="使用Flask-Sockets-測試上問題"><a href="#使用Flask-Sockets-測試上問題" class="headerlink" title="使用Flask-Sockets(測試上問題)"></a>使用Flask-Sockets(測試上問題)</h2><p>最後在接上uwsgi和nginx時無法收到websocket的資訊</p>
<p>參考</p>
<p><a href="https://github.com/heroku-python/flask-sockets">https://github.com/heroku-python/flask-sockets</a></p>
<p>安裝</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo pip3 install Flask-Sockets</span><br></pre></td></tr></table></figure>

<p>在server端</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Blueprint</span><br><span class="line"><span class="keyword">from</span> flask_sockets <span class="keyword">import</span> Sockets</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">html = Blueprint(<span class="string">r&#x27;html&#x27;</span>, __name__)</span><br><span class="line">ws = Blueprint(<span class="string">r&#x27;ws&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@html.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    now = datetime.datetime.now().isoformat()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World! &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(now)</span><br><span class="line"></span><br><span class="line"><span class="meta">@ws.route(<span class="params"><span class="string">&#x27;/echo&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">echo_socket</span>(<span class="params">socket</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> socket.closed:</span><br><span class="line">        message = socket.receive()</span><br><span class="line">        now = datetime.datetime.now().isoformat()</span><br><span class="line">        sendmsg=message+<span class="string">&#x27; &#x27;</span>+now</span><br><span class="line">        socket.send(sendmsg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">sockets = Sockets(app)</span><br><span class="line"></span><br><span class="line">app.register_blueprint(html, url_prefix=<span class="string">r&#x27;/&#x27;</span>)</span><br><span class="line">sockets.register_blueprint(ws, url_prefix=<span class="string">r&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">from</span> gevent <span class="keyword">import</span> pywsgi</span><br><span class="line">    <span class="keyword">from</span> geventwebsocket.handler <span class="keyword">import</span> WebSocketHandler</span><br><span class="line">    server = pywsgi.WSGIServer((<span class="string">&#x27;&#x27;</span>, <span class="number">5000</span>), app, handler_class=WebSocketHandler)</span><br><span class="line">    server.serve_forever()</span><br></pre></td></tr></table></figure>

<p>在client端<code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- message form --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;publish&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Send&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- div with messages --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&#x27;./index.js&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//使用 WebSocket 的網址向 Server 開啟連結</span></span><br><span class="line"><span class="keyword">let</span> ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&#x27;ws://192.168.83.128:5000/echo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//開啟後執行的動作，指定一個 function 會在連結 WebSocket 後執行</span></span><br><span class="line">ws.<span class="property">onopen</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;open connection&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//關閉後執行的動作，指定一個 function 會在連結中斷後執行</span></span><br><span class="line">ws.<span class="property">onclose</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Closed connect=<span class="subst">$&#123;event.code&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接收 Server 發送的訊息</span></span><br><span class="line">ws.<span class="property">onmessage</span> = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(event)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(event.<span class="property">data</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// send message from the form</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">forms</span>.<span class="property">publish</span>.<span class="property">onsubmit</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> outgoingMessage = <span class="variable language_">this</span>.<span class="property">message</span>.<span class="property">value</span>;</span><br><span class="line"></span><br><span class="line">    ws.<span class="title function_">send</span>(outgoingMessage);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><a href="https://blog.csdn.net/z_ipython/article/details/99305623">https://blog.csdn.net/z_ipython/article/details/99305623</a></p>
<p>在<code>manage.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app,manager</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Server</span><br><span class="line"><span class="keyword">import</span> www <span class="comment">#引入</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## web server</span></span><br><span class="line"><span class="comment">#manager.add_command(&quot;runserver&quot;,Server(host=&#x27;0.0.0.0&#x27;,port=app.config[&#x27;SERVER_PORT&#x27;],use_debugger=True,use_reloader=True))</span></span><br><span class="line"><span class="comment">#manager.add_command(&quot;runserver&quot;,runserver_gevent)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="meta">@manager.command </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">runserver</span>():</span><br><span class="line">    <span class="keyword">from</span> gevent <span class="keyword">import</span> pywsgi</span><br><span class="line">    <span class="keyword">from</span> geventwebsocket.handler <span class="keyword">import</span> WebSocketHandler</span><br><span class="line">    <span class="keyword">import</span> logging</span><br><span class="line">    logging.basicConfig(level=logging.DEBUG)</span><br><span class="line">    app.debug = <span class="literal">True</span></span><br><span class="line">    server = pywsgi.WSGIServer((<span class="string">&#x27;&#x27;</span>, <span class="number">5000</span>),application=app, handler_class=WebSocketHandler,log=app.logger)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">         server.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> (KeyboardInterrupt, SystemExit):</span><br><span class="line">        <span class="keyword">if</span> server.started:</span><br><span class="line">            server.stop()</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">#app.run(host=&#x27;0.0.0.0&#x27;,debug=&#x27;True&#x27;)</span></span><br><span class="line">    <span class="comment">#app.run(debug=&#x27;True&#x27;)</span></span><br><span class="line">    <span class="comment">#from gevent import pywsgi</span></span><br><span class="line">    <span class="comment">#from geventwebsocket.handler import WebSocketHandler</span></span><br><span class="line">    <span class="comment">#server = pywsgi.WSGIServer((&#x27;0.0.0.0&#x27;, 8540), manager, handler_class=WebSocketHandler)</span></span><br><span class="line">    manager.run()</span><br><span class="line">    <span class="comment">#server.serve_forever()</span></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        sys.exit(main())</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc()</span><br></pre></td></tr></table></figure>

<p>在<code>web\controller\wsocket\wsocket.py</code>建立服務</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">router_websocket = Blueprint(<span class="string">&#x27;websocket_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_websocket.route(<span class="params"><span class="string">&quot;/echo&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">echo_socket</span>(<span class="params">socket</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> socket.closed:</span><br><span class="line">        msg = socket.receive()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;i received:<span class="subst">&#123;msg&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="comment"># message = socket.receive()</span></span><br><span class="line">        <span class="comment"># print(message)</span></span><br><span class="line">        <span class="keyword">if</span> msg:</span><br><span class="line">            now = datetime.datetime.now()</span><br><span class="line">            sendmsg=<span class="string">&#x27;&#123;&#125; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(msg,now)</span><br><span class="line">            socket.send(sendmsg)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;i sent:<span class="subst">&#123;sendmsg&#125;</span>&#x27;</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<p>測試用聊天室</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng new ngchat</span><br></pre></td></tr></table></figure>

<p>參考資料</p>
<p><a href="https://blog.csdn.net/diaolouan9546/article/details/101492264?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control">https://blog.csdn.net/diaolouan9546/article/details/101492264?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control</a></p>
<p>聊天室，有姓名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g component muc_nick</span><br><span class="line">ng g service muc-nick/_service/Chat</span><br></pre></td></tr></table></figure>

<p><code>src\app\muc-nick\_service\chat.service.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WebsocketService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_service/websocket.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CHAT_URL</span> = <span class="string">&#x27;ws://192.168.83.128:5000/v0.0/ws/echo&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">  <span class="attr">author</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">message</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ChatService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="attr">messages</span>: <span class="title class_">Subject</span>&lt;<span class="title class_">Message</span>&gt;;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">websocketService: WebsocketService</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">messages</span> = &lt;<span class="title class_">Subject</span>&lt;<span class="title class_">Message</span>&gt;&gt;websocketService</span><br><span class="line">      .<span class="title function_">connect</span>(<span class="variable constant_">CHAT_URL</span>)</span><br><span class="line">      .<span class="title function_">pipe</span>(<span class="title function_">map</span>((<span class="attr">response</span>: <span class="title class_">MessageEvent</span>): <span class="function"><span class="params">Message</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(response.<span class="property">data</span>);</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">author</span>: data.<span class="property">author</span>,</span><br><span class="line">          <span class="attr">message</span>: data.<span class="property">message</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>src\app\muc-nick\muc-nick.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>用戶聊天nickname<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>請nickname：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;nickname1&quot;</span> #<span class="attr">nickname</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;chat_room&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>請輸入聊天內容：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> #<span class="attr">msg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;send&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;send()&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> #<span class="attr">chat_content</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of messagelist&quot;</span>&gt;</span></span><br><span class="line">      &#123;&#123;item.author&#125;&#125; -&gt;&#123;&#123;item.message&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\muc-nick\muc-nick.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">ElementRef</span>, <span class="title class_">OnInit</span>, <span class="title class_">ViewChild</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ChatService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../muc-nonick/_service/chat.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;muc-nick&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./muc-nick.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./muc-nick.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">MucNickComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ViewChild</span>(<span class="string">&#x27;nickname&#x27;</span>, &#123; <span class="attr">static</span>: <span class="literal">true</span> &#125;) <span class="attr">nickname</span>: <span class="title class_">ElementRef</span>;</span><br><span class="line">  <span class="meta">@ViewChild</span>(<span class="string">&#x27;msg&#x27;</span>, &#123; <span class="attr">static</span>: <span class="literal">true</span> &#125;) <span class="attr">msg</span>: <span class="title class_">ElementRef</span>;</span><br><span class="line">  messagelist = [];</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> chatService: ChatService</span>) &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chatService</span>.<span class="property">messages</span>.<span class="title function_">subscribe</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(&quot;Response from websocket: &quot; + msg);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">messagelist</span>.<span class="title function_">push</span>(msg);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">send</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sendmsg = &#123;</span><br><span class="line">      <span class="attr">author</span>: <span class="string">&#x27;tutorialedge&#x27;</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;this is a test message&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//console.log(this.msg.nativeElement.value);</span></span><br><span class="line">    sendmsg.<span class="property">author</span> = <span class="variable language_">this</span>.<span class="property">nickname</span>.<span class="property">nativeElement</span>.<span class="property">value</span>;</span><br><span class="line">    sendmsg.<span class="property">message</span> = <span class="variable language_">this</span>.<span class="property">msg</span>.<span class="property">nativeElement</span>.<span class="property">value</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chatService</span>.<span class="property">messages</span>.<span class="title function_">next</span>(sendmsg);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="flask-uwsgi-websocket"><a href="#flask-uwsgi-websocket" class="headerlink" title="flask-uwsgi-websocket"></a><a href="https://github.com/zeekay/flask-uwsgi-websocket">flask-uwsgi-websocket</a></h2><p>使用另外一套的python的lib</p>
<p>安裝</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo pip3 install Flask-uWSGI-WebSocket</span><br></pre></td></tr></table></figure>

<p>刪除起動的uwsgi</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo pkill -f uwsgi -9</span><br></pre></td></tr></table></figure>

<p>使用<code>GeventWebSocket</code>可以收到兩個client</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,debug=<span class="string">&#x27;True&#x27;</span>,gevent=<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>使用<code>WebSocket</code>，只可服務一個</p>
]]></content>
      <categories>
        <category>學習</category>
        <category>Python</category>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄flask-restful和Angular和MariaDB的基本使用</title>
    <url>/%E8%A8%98%E9%8C%84flask-restful%E5%92%8CAngular%E5%92%8CMariaDB%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84flask-restful%E5%92%8CAngular%E5%92%8CMariaDB%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h3 id="記錄和測試前端-angualr-和後端-python-的基本使用"><a href="#記錄和測試前端-angualr-和後端-python-的基本使用" class="headerlink" title="記錄和測試前端(angualr)和後端(python)的基本使用"></a>記錄和測試前端(angualr)和後端(python)的基本使用</h3><p>先在MariaDB上建立資料庫名<code>userdb</code></p>
<p>建立資料表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE `tbl_user` (</span><br><span class="line">  `user_id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `user_name` varchar(45) COLLATE utf8_unicode_ci DEFAULT NULL,</span><br><span class="line">  `user_email` varchar(45) COLLATE utf8_unicode_ci DEFAULT NULL,</span><br><span class="line">  `user_password` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`user_id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;</span><br></pre></td></tr></table></figure>
<p>導入flask-marshmallow<br>透過此函式庫可以讓我們的程式在處理請求參數更彈性</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install -U marshmallow</span><br></pre></td></tr></table></figure>

<h3 id="Flask-CORS使用"><a href="#Flask-CORS使用" class="headerlink" title="Flask-CORS使用"></a>Flask-CORS使用</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span><br><span class="line"><span class="comment">## ...</span></span><br><span class="line">CORS(app)</span><br></pre></td></tr></table></figure>



<p>安裝</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install -U flask-cors</span><br></pre></td></tr></table></figure>



<h3 id="建立python的restful的API"><a href="#建立python的restful的API" class="headerlink" title="建立python的restful的API"></a>建立python的restful的API</h3><p>先建立<code>crud_user.py</code>為執行python的主執行程式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, redirect, jsonify</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_marshmallow <span class="keyword">import</span> Marshmallow</span><br><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">CORS(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫相關</span></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;Fianna&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/userdb&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line">ma = Marshmallow(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定義ORM物件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;tbl_user&#x27;</span></span><br><span class="line">    user_id = db.Column(db.Integer, nullable=<span class="literal">False</span>,</span><br><span class="line">                        primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    user_name = db.Column(db.String(<span class="number">45</span>), nullable=<span class="literal">True</span>)</span><br><span class="line">    user_email = db.Column(db.String(<span class="number">45</span>), nullable=<span class="literal">True</span>)</span><br><span class="line">    user_password = db.Column(db.String(<span class="number">45</span>), nullable=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, username, useremail, userpassword=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">        self.user_name=username</span><br><span class="line">        self.user_email=useremail</span><br><span class="line">        self.user_password=userpassword</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;User %r,user_id %r&gt;&#x27;</span> % (self.user_name, self.user_id)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserSchema</span>(ma.Schema):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        <span class="comment"># Fields to expose</span></span><br><span class="line">        fields = (<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;user_name&#x27;</span>, <span class="string">&#x27;user_email&#x27;</span>, <span class="string">&#x27;user_password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">user_schema = UserSchema()</span><br><span class="line">users_schema = UserSchema(many=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># endpoint to create new user</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_user</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        username = request.json[<span class="string">&#x27;user_name&#x27;</span>]</span><br><span class="line">        email = request.json[<span class="string">&#x27;user_email&#x27;</span>]</span><br><span class="line">        password= request.json[<span class="string">&#x27;user_password&#x27;</span>]</span><br><span class="line">        new_user = User(username, email,password)</span><br><span class="line"></span><br><span class="line">        db.session.add(new_user)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> user_schema.jsonify(new_user)</span><br><span class="line">        <span class="comment"># resp = jsonify(&#x27;User added successfully!&#x27;)</span></span><br><span class="line">        <span class="comment"># resp.status_code = 200</span></span><br><span class="line">        <span class="comment"># return resp</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to add user&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)    </span><br><span class="line"></span><br><span class="line"><span class="comment"># endpoint to show all users</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        all_users = User.query.<span class="built_in">all</span>()</span><br><span class="line">        result = users_schema.dump(all_users)</span><br><span class="line">        <span class="keyword">return</span> jsonify(result.data)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Failed to get all user&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)    </span><br><span class="line"></span><br><span class="line"><span class="comment"># endpoint to get user detail  by id</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;id&gt;&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_detail</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user = User.query.get(<span class="built_in">id</span>)</span><br><span class="line">        <span class="keyword">return</span> user_schema.jsonify(user)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to get user&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e) </span><br><span class="line"><span class="comment"># endpoint to update user</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;id&gt;&quot;</span>, methods=[<span class="string">&quot;PUT&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_update</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user = User.query.get(<span class="built_in">id</span>)</span><br><span class="line">        username = request.json[<span class="string">&#x27;user_name&#x27;</span>]</span><br><span class="line">        email = request.json[<span class="string">&#x27;user_email&#x27;</span>]</span><br><span class="line">        password= request.json[<span class="string">&#x27;user_password&#x27;</span>]</span><br><span class="line">        user.user_name=  username</span><br><span class="line">        user.user_email = email</span><br><span class="line">        user.user_password = password</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> user_schema.jsonify(user)        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to update user&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e) </span><br><span class="line">    </span><br><span class="line"><span class="comment"># endpoint to delete user</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;id&gt;&quot;</span>, methods=[<span class="string">&quot;DELETE&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_delete</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user = User.query.get(<span class="built_in">id</span>)</span><br><span class="line">        db.session.delete(user)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> user_schema.jsonify(user)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to del user&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e) </span><br><span class="line">	</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上的程式碼分成幾部分</p>
<p>導入需要的程式庫和建利App物件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, redirect, jsonify</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_marshmallow <span class="keyword">import</span> Marshmallow</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br></pre></td></tr></table></figure>
<p>有關資料庫相關</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 資料庫相關</span><br><span class="line">app.config[&#x27;SECRET_KEY&#x27;] = &#x27;Fianna&#x27;</span><br><span class="line">app.config[&#x27;SQLALCHEMY_DATABASE_URI&#x27;] = &#x27;mysql://root:12345678@localhost:3306/userdb&#x27;</span><br><span class="line">app.config[&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;] = True</span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line">ma = Marshmallow(app)</span><br></pre></td></tr></table></figure>

<p>有關ORM</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 定義ORM物件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;tbl_user&#x27;</span></span><br><span class="line">    user_id = db.Column(db.Integer, nullable=<span class="literal">False</span>,</span><br><span class="line">                        primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    user_name = db.Column(db.String(<span class="number">45</span>), nullable=<span class="literal">True</span>)</span><br><span class="line">    user_email = db.Column(db.String(<span class="number">45</span>), nullable=<span class="literal">True</span>)</span><br><span class="line">    user_password = db.Column(db.String(<span class="number">45</span>), nullable=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, username, useremail, userpassword=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">        self.user_name=username</span><br><span class="line">        self.user_email=useremail</span><br><span class="line">        self.user_password=userpassword</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;User %r,user_id %r&gt;&#x27;</span> % (self.user_name, self.user_id)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserSchema</span>(ma.Schema):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        <span class="comment"># Fields to expose</span></span><br><span class="line">        fields = (<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;user_name&#x27;</span>, <span class="string">&#x27;user_email&#x27;</span>, <span class="string">&#x27;user_password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">user_schema = UserSchema()</span><br><span class="line">users_schema = UserSchema(many=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>有關C，建立使用者</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># endpoint to create new user</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_user</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        username = request.json[<span class="string">&#x27;user_name&#x27;</span>]</span><br><span class="line">        email = request.json[<span class="string">&#x27;user_email&#x27;</span>]</span><br><span class="line">        password= request.json[<span class="string">&#x27;user_password&#x27;</span>]</span><br><span class="line">        new_user = User(username, email,password)</span><br><span class="line"></span><br><span class="line">        db.session.add(new_user)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> user_schema.jsonify(new_user)</span><br><span class="line">        <span class="comment"># resp = jsonify(&#x27;User added successfully!&#x27;)</span></span><br><span class="line">        <span class="comment"># resp.status_code = 200</span></span><br><span class="line">        <span class="comment"># return resp</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to add user&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)    </span><br></pre></td></tr></table></figure>

<p>有關R，讀取使用者和所有使用者</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># endpoint to show all users</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        all_users = User.query.<span class="built_in">all</span>()</span><br><span class="line">        result = users_schema.dump(all_users)</span><br><span class="line">        <span class="keyword">return</span> jsonify(result.data)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Failed to get all user&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)    </span><br><span class="line"></span><br><span class="line"><span class="comment"># endpoint to get user detail  by id</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;id&gt;&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_detail</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user = User.query.get(<span class="built_in">id</span>)</span><br><span class="line">        <span class="keyword">return</span> user_schema.jsonify(user)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to get user&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e) </span><br></pre></td></tr></table></figure>

<p>有關U，更新使用者資料</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># endpoint to update user</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;id&gt;&quot;</span>, methods=[<span class="string">&quot;PUT&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_update</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user = User.query.get(<span class="built_in">id</span>)</span><br><span class="line">        username = request.json[<span class="string">&#x27;user_name&#x27;</span>]</span><br><span class="line">        email = request.json[<span class="string">&#x27;user_email&#x27;</span>]</span><br><span class="line">        password= request.json[<span class="string">&#x27;user_password&#x27;</span>]</span><br><span class="line">        user.user_name=  username</span><br><span class="line">        user.user_email = email</span><br><span class="line">        user.user_password = password</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> user_schema.jsonify(user)        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to update user&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e) </span><br></pre></td></tr></table></figure>

<p>有關D，刪除使用者</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># endpoint to delete user</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;id&gt;&quot;</span>, methods=[<span class="string">&quot;DELETE&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_delete</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user = User.query.get(<span class="built_in">id</span>)</span><br><span class="line">        db.session.delete(user)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> user_schema.jsonify(user)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to del user&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br></pre></td></tr></table></figure>

<h3 id="建立Agnular測試端"><a href="#建立Agnular測試端" class="headerlink" title="建立Agnular測試端"></a>建立Agnular測試端</h3><p>先建立專案</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng new angular-python</span><br></pre></td></tr></table></figure>

<p>在建立各個元件在user的目錄下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g c user/user-list</span><br><span class="line">ng g c user/user-add</span><br><span class="line">ng g c user/user-edit</span><br><span class="line">ng g c user/user-detail</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\app-routing.module.ts</code>下來建立接下來的路由路徑</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Routes</span>, <span class="title class_">RouterModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserListComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user-list/user-list.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/user&#x27;</span>, <span class="attr">pathMatch</span>: <span class="string">&#x27;full&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;user&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserListComponent</span> &#125;</span><br><span class="line"></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">RouterModule</span>.<span class="title function_">forRoot</span>(routes)],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">RouterModule</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppRoutingModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>先測試路由和元件是否能顯示輸入<code>http://localhost:4200/</code>會自動轉成<code>http://localhost:4200/user</code>會顯示user-list的元件</p>
<p>建立使用者物件在<code>user</code>的資料夾下<code>src\app\user\user.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">User</span>&#123;</span><br><span class="line">    user_id?:<span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">user_name</span>:<span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">user_email</span>:<span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">user_password</span>:<span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>建立服務物件在<code>user</code> 的資料夾下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ng g s user\user</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\user\user.service.ts</code>下先加入列出所有的使用者服務</p>
<p>要先將使用的模塊加入到<code>src\app\app.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClientModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [</span><br><span class="line">    <span class="title class_">AppComponent</span>,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">BrowserModule</span>,</span><br><span class="line">    <span class="title class_">HttpClientModule</span>,</span><br><span class="line">    <span class="title class_">AppRoutingModule</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: [],</span><br><span class="line">  <span class="attr">bootstrap</span>: [<span class="title class_">AppComponent</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="顯示所有使用者"><a href="#顯示所有使用者" class="headerlink" title="顯示所有使用者"></a>顯示所有使用者</h4><p>在<code>src\app\user\user.service.ts</code>的服務引用，並在構造函數中聲明,因為有使用到user的物件也需要引用進來,因為使用Obserable所以也要引用進來，在加入取得所以的資料流</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> ,<span class="title class_">HttpHeaders</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@angular/common/http&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">   <span class="comment">// api address</span></span><br><span class="line">  <span class="keyword">private</span> userUrl = <span class="string">&quot;http://localhost:5000&quot;</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> http:HttpClient</span>) &#123; &#125;</span><br><span class="line">  <span class="comment">// 取得所有的使用者</span></span><br><span class="line">  <span class="title function_">getUsers</span>():<span class="title class_">Observable</span>&lt;<span class="title class_">User</span>[]&gt;&#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="variable language_">this</span>.<span class="property">userUrl</span>+<span class="string">&quot;/user&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="title class_">User</span>[]&gt;(api);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在顯示端<code>src\app\user\user-list\user-list.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>使用者列表<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;a [routerLink]=&quot;[&#x27;/add&#x27;]&quot;&gt;加入使用者&lt;/a&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>ID<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Name<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Email<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Actions<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tr</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let user of users&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.user_id&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.user_name&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.user_email&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>notimp<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="加入使用者"><a href="#加入使用者" class="headerlink" title="加入使用者"></a>加入使用者</h4><p>因為要加入雙向綁定所以要加入<strong>FormsModule</strong>模組</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; FormsModule &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>在路由端要加入<code>src\app\app-routing.module.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Routes</span>, <span class="title class_">RouterModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserListComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user-list/user-list.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserAddComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user-add/user-add.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/user&#x27;</span>, <span class="attr">pathMatch</span>: <span class="string">&#x27;full&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;user&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserListComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;add&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserAddComponent</span> &#125;</span><br><span class="line"></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">RouterModule</span>.<span class="title function_">forRoot</span>(routes)],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">RouterModule</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppRoutingModule</span> &#123; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在服務端<code>src\app\user\user.service.ts</code>中要加入<strong>HttpHeaders</strong>的物件</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> ,<span class="title class_">HttpHeaders</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@angular/common/http&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> httpOptions = &#123;</span><br><span class="line">  <span class="attr">headers</span>: <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>(&#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// api address</span></span><br><span class="line">  <span class="keyword">private</span> userUrl = <span class="string">&quot;http://localhost:5000&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> http:HttpClient</span>) &#123; &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 取得所有的使用者</span></span><br><span class="line">  <span class="title function_">getUsers</span>():<span class="title class_">Observable</span>&lt;<span class="title class_">User</span>[]&gt;&#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="variable language_">this</span>.<span class="property">userUrl</span>+<span class="string">&quot;/user&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="title class_">User</span>[]&gt;(api);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 加入一個使用者</span></span><br><span class="line">  <span class="title function_">addUser</span>(<span class="attr">user</span>: <span class="title class_">User</span>): <span class="title class_">Observable</span>&lt;<span class="title class_">User</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="variable language_">this</span>.<span class="property">userUrl</span> + <span class="string">&quot;/user&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="title class_">User</span>&gt;(api, user, httpOptions);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\user\user-add\user-add.component.ts</code>中</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Location</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-user-add&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./user-add.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./user-add.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserAddComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="attr">user</span>: <span class="title class_">User</span>= <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> usersevice:UserService,<span class="keyword">private</span> location:Location</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 加人使用者</span></span><br><span class="line">  <span class="title function_">save</span>():<span class="built_in">void</span>&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">usersevice</span>.<span class="title function_">addUser</span>(<span class="variable language_">this</span>.<span class="property">user</span>).<span class="title function_">subscribe</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">goBack</span>()&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 回上一頁</span></span><br><span class="line">  <span class="title function_">goBack</span>():<span class="built_in">void</span>&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">location</span>.<span class="title function_">back</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在顯示端<code>src\app\user\user-add\user-add.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>加入使用者<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>姓名：<span class="tag">&lt;<span class="name">input</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;user.user_name&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;請輸人姓名&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>Email:<span class="tag">&lt;<span class="name">input</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;user.user_email&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;請輸人email&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>密碼:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;user.user_password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;請輸人密碼&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">&quot;goBack()&quot;</span> &gt;</span>回到上一頁<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">&quot;save()&quot;</span> &gt;</span>加入<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="顯示一個使用者"><a href="#顯示一個使用者" class="headerlink" title="顯示一個使用者"></a>顯示一個使用者</h4><p>在路由上加上顯示使用者<code>src\app\app-routing.module.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Routes</span>, <span class="title class_">RouterModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserListComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user-list/user-list.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserAddComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user-add/user-add.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserDetailComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user-detail/user-detail.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/user&#x27;</span>, <span class="attr">pathMatch</span>: <span class="string">&#x27;full&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;user&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserListComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;add&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserAddComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;detail/:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserDetailComponent</span> &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">RouterModule</span>.<span class="title function_">forRoot</span>(routes)],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">RouterModule</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppRoutingModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>在路由顯示端<code>src\app\user\user-list\user-list.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>使用者列表<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/add&#x27;]&quot;</span>&gt;</span>加入使用者<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>ID<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Name<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Email<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Actions<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tr</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let user of users&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.user_id&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.user_name&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.user_email&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">&quot;/detail/&#123;&#123;user.user_id&#125;&#125;&quot;</span>&gt;</span>使用者資訊<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>先在服務端<code>src\app\user\user.service.ts</code>加入以id來取得使用者資訊</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span>, <span class="title class_">HttpHeaders</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@angular/common/http&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> httpOptions = &#123;</span><br><span class="line">  <span class="attr">headers</span>: <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>(&#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// api address</span></span><br><span class="line">  <span class="keyword">private</span> userUrl = <span class="string">&quot;http://localhost:5000&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 取得所有的使用者</span></span><br><span class="line">  <span class="title function_">getUsers</span>(): <span class="title class_">Observable</span>&lt;<span class="title class_">User</span>[]&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="variable language_">this</span>.<span class="property">userUrl</span> + <span class="string">&quot;/user&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="title class_">User</span>[]&gt;(api);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 加入一個使用者</span></span><br><span class="line">  <span class="title function_">addUser</span>(<span class="attr">user</span>: <span class="title class_">User</span>): <span class="title class_">Observable</span>&lt;<span class="title class_">User</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="variable language_">this</span>.<span class="property">userUrl</span> + <span class="string">&quot;/user&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="title class_">User</span>&gt;(api, user, httpOptions);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 取得一個使用者的資訊</span></span><br><span class="line">  <span class="title function_">getUser</span>(<span class="attr">id</span>: <span class="built_in">string</span>):<span class="title class_">Observable</span>&lt;<span class="title class_">User</span>&gt;&#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.userUrl&#125;</span>/user/<span class="subst">$&#123;id&#125;</span>`</span>;</span><br><span class="line">    <span class="comment">//console.log(api);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="title class_">User</span>&gt;(api);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\user\user-detail\user-detail.component.ts</code>中加入</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Location</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-user-detail&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./user-detail.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./user-detail.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserDetailComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="attr">user</span>: <span class="title class_">User</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> route: ActivatedRoute, <span class="keyword">private</span> userService: UserService, <span class="keyword">private</span> location: Location</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getUser</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getUser</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">snapshot</span>.<span class="property">paramMap</span>.<span class="title function_">get</span>(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">getUser</span>(id).<span class="title function_">subscribe</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">user</span> = data;</span><br><span class="line">      <span class="comment">// console.log(this.user);</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">goBack</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">location</span>.<span class="title function_">back</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在顯示端s<code>rc\app\user\user-detail\user-detail.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123;user.user_name | uppercase &#125;&#125; 細節<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>Id:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> &#123;&#123;user.user_id&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">		Name: &#123;&#123;user.user_name&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">		Email: &#123;&#123;user.user_email&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">&quot;goBack()&quot;</span>&gt;</span>go back<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="編輯一個使用者"><a href="#編輯一個使用者" class="headerlink" title="編輯一個使用者"></a>編輯一個使用者</h4><p>在路由上加上顯示使用者<code>src\app\app-routing.module.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Routes</span>, <span class="title class_">RouterModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserListComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user-list/user-list.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserAddComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user-add/user-add.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserDetailComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user-detail/user-detail.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserEditComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user-edit/user-edit.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;/user&#x27;</span>, <span class="attr">pathMatch</span>: <span class="string">&#x27;full&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;user&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserListComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;add&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserAddComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;detail/:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserDetailComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;edit/:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserEditComponent</span> &#125;</span><br><span class="line"></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">RouterModule</span>.<span class="title function_">forRoot</span>(routes)],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">RouterModule</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppRoutingModule</span> &#123; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在路由顯示端<code>src\app\user\user-list\user-list.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>使用者列表<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/add&#x27;]&quot;</span>&gt;</span>加入使用者<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>ID<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Name<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Email<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Actions<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tr</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let user of users&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.user_id&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.user_name&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.user_email&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">&quot;/detail/&#123;&#123;user.user_id&#125;&#125;&quot;</span>&gt;</span>使用者資訊<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="symbol">&amp;nbsp;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">&quot;/edit/&#123;&#123;user.user_id&#125;&#125;&quot;</span>&gt;</span>編輯使用者資訊<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>先在服務端<code>src\app\user\user.service.ts</code>加入以傳入user來編輯使用者資訊</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span>, <span class="title class_">HttpHeaders</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@angular/common/http&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> httpOptions = &#123;</span><br><span class="line">  <span class="attr">headers</span>: <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>(&#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// api address</span></span><br><span class="line">  <span class="keyword">private</span> userUrl = <span class="string">&quot;http://localhost:5000&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 取得所有的使用者</span></span><br><span class="line">  <span class="title function_">getUsers</span>(): <span class="title class_">Observable</span>&lt;<span class="title class_">User</span>[]&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="variable language_">this</span>.<span class="property">userUrl</span> + <span class="string">&quot;/user&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="title class_">User</span>[]&gt;(api);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 加入一個使用者</span></span><br><span class="line">  <span class="title function_">addUser</span>(<span class="attr">user</span>: <span class="title class_">User</span>): <span class="title class_">Observable</span>&lt;<span class="title class_">User</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="variable language_">this</span>.<span class="property">userUrl</span> + <span class="string">&quot;/user&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="title class_">User</span>&gt;(api, user, httpOptions);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 取得一個使用者的資訊</span></span><br><span class="line">  <span class="title function_">getUser</span>(<span class="attr">id</span>: <span class="built_in">string</span>):<span class="title class_">Observable</span>&lt;<span class="title class_">User</span>&gt;&#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.userUrl&#125;</span>/user/<span class="subst">$&#123;id&#125;</span>`</span>;</span><br><span class="line">    <span class="comment">//console.log(api);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="title class_">User</span>&gt;(api);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 編輯一個使用者的資訊</span></span><br><span class="line">  <span class="title function_">updateUser</span>(<span class="attr">user</span>:<span class="title class_">User</span>):<span class="title class_">Observable</span>&lt;<span class="title class_">User</span>&gt;&#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.userUrl&#125;</span>/user/<span class="subst">$&#123;user.user_id&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">put</span>&lt;<span class="title class_">User</span>&gt;(api,user,httpOptions);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\user\user-edit\user-edit.component.ts</code>中加入</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Location</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-user-edit&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./user-edit.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./user-edit.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserEditComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="attr">user</span>: <span class="title class_">User</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> route: ActivatedRoute, <span class="keyword">private</span> userService: UserService, <span class="keyword">private</span> location: Location</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getUser</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getUser</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="variable language_">this</span>.<span class="property">route</span>.<span class="property">snapshot</span>.<span class="property">paramMap</span>.<span class="title function_">get</span>(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">getUser</span>(id).<span class="title function_">subscribe</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">user</span> = data;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">save</span>():<span class="built_in">void</span>&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">updateUser</span>(<span class="variable language_">this</span>.<span class="property">user</span>).<span class="title function_">subscribe</span>(<span class="function">(<span class="params">success</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">goBack</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">goBack</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">location</span>.<span class="title function_">back</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在顯示端<code>src\app\user\user-edit\user-edit.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123;user.user_name | uppercase &#125;&#125; 細節<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>Id:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> &#123;&#123;user.user_id&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">		Name: &#123;&#123;user.user_name&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">		Email: &#123;&#123;user.user_email&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">&quot;goBack()&quot;</span>&gt;</span>go back<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="刪除一個使用者"><a href="#刪除一個使用者" class="headerlink" title="刪除一個使用者"></a>刪除一個使用者</h4><p>先在服務端<code>src\app\user\user.service.ts</code>加入以傳入user來刪除使用者資訊</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span>, <span class="title class_">HttpHeaders</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@angular/common/http&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> httpOptions = &#123;</span><br><span class="line">  <span class="attr">headers</span>: <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>(&#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// api address</span></span><br><span class="line">  <span class="keyword">private</span> userUrl = <span class="string">&quot;http://localhost:5000&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 取得所有的使用者</span></span><br><span class="line">  <span class="title function_">getUsers</span>(): <span class="title class_">Observable</span>&lt;<span class="title class_">User</span>[]&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="variable language_">this</span>.<span class="property">userUrl</span> + <span class="string">&quot;/user&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="title class_">User</span>[]&gt;(api);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 加入一個使用者</span></span><br><span class="line">  <span class="title function_">addUser</span>(<span class="attr">user</span>: <span class="title class_">User</span>): <span class="title class_">Observable</span>&lt;<span class="title class_">User</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="variable language_">this</span>.<span class="property">userUrl</span> + <span class="string">&quot;/user&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="title class_">User</span>&gt;(api, user, httpOptions);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 取得一個使用者的資訊</span></span><br><span class="line">  <span class="title function_">getUser</span>(<span class="attr">id</span>: <span class="built_in">string</span>):<span class="title class_">Observable</span>&lt;<span class="title class_">User</span>&gt;&#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.userUrl&#125;</span>/user/<span class="subst">$&#123;id&#125;</span>`</span>;</span><br><span class="line">    <span class="comment">//console.log(api);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="title class_">User</span>&gt;(api);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 編輯一個使用者的資訊</span></span><br><span class="line">  <span class="title function_">updateUser</span>(<span class="attr">user</span>:<span class="title class_">User</span>):<span class="title class_">Observable</span>&lt;<span class="title class_">User</span>&gt;&#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.userUrl&#125;</span>/user/<span class="subst">$&#123;user.user_id&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">put</span>&lt;<span class="title class_">User</span>&gt;(api,user,httpOptions);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 刪除一個使用者的資訊</span></span><br><span class="line">  <span class="title function_">deleteUser</span>(<span class="attr">user</span>:<span class="title class_">User</span>):<span class="title class_">Observable</span>&lt;<span class="title class_">User</span>&gt;&#123;</span><br><span class="line">    <span class="keyword">var</span> api = <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.userUrl&#125;</span>/user/<span class="subst">$&#123;user.user_id&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">delete</span>&lt;<span class="title class_">User</span>&gt;(api);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\user\user-list\user-list.component.ts</code>元件中加入刪除使用者</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Location</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Subscriber</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../user&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-user-list&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./user-list.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./user-list.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserListComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="attr">users</span>: <span class="title class_">User</span>[] = [];</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> uservice:UserService,<span class="keyword">private</span> location: Location</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getUsers</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getUsers</span>():<span class="built_in">void</span>&#123;</span><br><span class="line">    <span class="comment">//console.log(&#x27;getUsers------------------&#x27;);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">uservice</span>.<span class="title function_">getUsers</span>().<span class="title function_">subscribe</span>(<span class="function">(<span class="params">users</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">users</span>=users;</span><br><span class="line">        <span class="comment">//console.log(users);</span></span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">delete</span>(<span class="attr">user</span>:<span class="title class_">User</span>):<span class="built_in">void</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">confirm</span>(<span class="string">&quot;Are you sure to delete?&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">uservice</span>.<span class="title function_">deleteUser</span>(user).<span class="title function_">subscribe</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在顯示端加入<code>src\app\user\user-list\user-list.component.html</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>使用者列表<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">&quot;[&#x27;/add&#x27;]&quot;</span>&gt;</span>加入使用者<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>ID<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Name<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Email<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Actions<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tr</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let user of users&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.user_id&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.user_name&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.user_email&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">&quot;/detail/&#123;&#123;user.user_id&#125;&#125;&quot;</span>&gt;</span>使用者資訊<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="symbol">&amp;nbsp;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">&quot;/edit/&#123;&#123;user.user_id&#125;&#125;&quot;</span>&gt;</span>編輯使用者資訊<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="symbol">&amp;nbsp;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">&quot;delete(user)&quot;</span>&gt;</span>X<span class="tag">&lt;/<span class="name">button</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以參考<a href="https://github.com/ttom921/StudyPython.git%E8%A3%8F%E7%9A%84TestFlaskAngular%E7%9A%84%E5%B0%88%E6%A1%88">https://github.com/ttom921/StudyPython.git裏的TestFlaskAngular的專案</a></p>
<h6 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h6><p><a href="https://medium.com/python-pandemonium/build-simple-restful-api-with-python-and-flask-part-2-724ebf04d12">Build Simple Restful Api With Python and Flask Part 2</a><br><a href="https://www.roytuts.com/python-rest-api-crud-example-using-flask-and-mysql/">Python REST API CRUD Example using Flask and MySQL</a><br><a href="https://www.roytuts.com/python-rest-flask-angularjs-crud/">Python REST APIs + Flask + Angular CRUD Example</a></p>
]]></content>
      <categories>
        <category>記錄</category>
        <category>資料庫</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>資料庫</tag>
        <tag>MariaDB</tag>
        <tag>Angular</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄flask和MariaDB的基本使用</title>
    <url>/%E8%A8%98%E9%8C%84flask%E5%92%8CMariaDB%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84flask%E5%92%8CMariaDB%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h3 id="記錄flask存取MariaDB"><a href="#記錄flask存取MariaDB" class="headerlink" title="記錄flask存取MariaDB"></a>記錄flask存取MariaDB</h3><p>一樣在虛擬環境，先安裝flask-sqlalchemy</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install flask</span><br><span class="line">pip install flask-sqlalchemy</span><br></pre></td></tr></table></figure>

<h3 id="建立產生靜態網頁"><a href="#建立產生靜態網頁" class="headerlink" title="建立產生靜態網頁"></a>建立產生靜態網頁</h3><p>在它的資料夾下建立templates,這是為了可以回傳html檔，可以讓瀏覽器可以看到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Testflasksql/</span><br><span class="line">    bookmanager.py</span><br><span class="line">    templates/</span><br><span class="line">      home.html</span><br></pre></td></tr></table></figure>

<p>在<code>home.html</code>加入以下的碼</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Add&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>bookmanager.py</code>下加入以下的碼</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<p>這樣執行<code>bookmanager.py</code>可以產生一個有輸入資料的網頁</p>
<h3 id="加入後端的處理"><a href="#加入後端的處理" class="headerlink" title="加入後端的處理"></a>加入後端的處理</h3><p>在home.html碼可以看到的碼<code>&lt;form method=&quot;POST&quot; action=&quot;/&quot;&gt;</code>指到處理的後端程式，因為要取到資料所以在<code>bookmanager.py</code>裏加入<code>from flask import request</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        <span class="built_in">print</span>(request.form)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="加到資料庫"><a href="#加到資料庫" class="headerlink" title="加到資料庫"></a>加到資料庫</h3><p>設定資料庫的組態</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;Fianna&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/bookdatabase&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(db.Model):</span><br><span class="line">    title = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;Title: &#123;&#125;&gt;&quot;</span>.<span class="built_in">format</span>(self.title)   </span><br><span class="line">    </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        book = Book(title=request.form.get(<span class="string">&quot;title&quot;</span>))</span><br><span class="line">        db.session.add(book)</span><br><span class="line">        db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>)</span><br><span class="line">   </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">        app.run(debug = <span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>要在資料庫先建立資料庫<code>bookdatabase</code>，才可以來以物件來建立資料表</p>
<h3 id="建立Book物件"><a href="#建立Book物件" class="headerlink" title="建立Book物件"></a>建立Book物件</h3><p>建立Book物件資料庫，可以之後在資料庫建立資料表</p>
<h3 id="初始化資料庫"><a href="#初始化資料庫" class="headerlink" title="初始化資料庫"></a>初始化資料庫</h3><p>在python的命令列下，執行下面的命令</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> bookmanager <span class="keyword">import</span> db</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.create_all()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>exit()</span><br></pre></td></tr></table></figure>

<h3 id="取得所有的資料"><a href="#取得所有的資料" class="headerlink" title="取得所有的資料"></a>取得所有的資料</h3><p>在<code>bookmanager.py</code>裏加入<code>books = Book.query.all()</code>和<code>return render_template(&quot;home.html&quot;, books=books)</code>如下面的代碼</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@app.route(&quot;/&quot;, methods=[&quot;GET&quot;, &quot;POST&quot;])</span><br><span class="line">def home():</span><br><span class="line">    if request.form:</span><br><span class="line">        book = Book(title=request.form.get(&quot;title&quot;))</span><br><span class="line">        db.session.add(book)</span><br><span class="line">        db.session.commit()</span><br><span class="line">    books = Book.query.all()    </span><br><span class="line">    return render_template(&quot;home.html&quot;, books=books)</span><br></pre></td></tr></table></figure>

<p>在<code>home.html</code>修改如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Add book<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Add&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Books<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    &#123;% for book in books %&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;book.title&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="更新資料"><a href="#更新資料" class="headerlink" title="更新資料"></a>更新資料</h3><p>在<code>homt.html</code>裏修改如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Add book<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Add&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Books<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    &#123;% for book in books %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;book.title&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./update&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;oldtitle&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;newtitle&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Update&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>bookmanager.py</code>下加入和修改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;Fianna&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/bookdatabase&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(db.Model):</span><br><span class="line">    title = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;Title: &#123;&#125;&gt;&quot;</span>.<span class="built_in">format</span>(self.title)     </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        book = Book(title=request.form.get(<span class="string">&quot;title&quot;</span>))</span><br><span class="line">        db.session.add(book)</span><br><span class="line">        db.session.commit()</span><br><span class="line">    books = Book.query.<span class="built_in">all</span>()    </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>, books=books)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/update&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>():</span><br><span class="line">    newtitle = request.form.get(<span class="string">&quot;newtitle&quot;</span>)</span><br><span class="line">    oldtitle = request.form.get(<span class="string">&quot;oldtitle&quot;</span>)</span><br><span class="line">    book = Book.query.filter_by(title=oldtitle).first()</span><br><span class="line">    book.title = newtitle</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">        app.run(debug = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<h3 id="刪除資料"><a href="#刪除資料" class="headerlink" title="刪除資料"></a>刪除資料</h3><p>和更新資料很像</p>
<p>在<code>home.html</code>修改如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Add book<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Add&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Books<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    &#123;% for book in books %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;book.title&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./update&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;oldtitle&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;newtitle&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Update&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./delete&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Delete&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>bookmanager.py</code>加入delete的功能</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/delete&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    title = request.form.get(<span class="string">&quot;title&quot;</span>)</span><br><span class="line">    book = Book.query.filter_by(title=title).first()</span><br><span class="line">    db.session.delete(book)</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>最律修改一下<code>home.html</code>使它好看一下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Add book<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Add&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Books<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    &#123;% for book in books %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">        &#123;&#123;book.title&#125;&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./update&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: inline&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;oldtitle&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;newtitle&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Update&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./delete&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: inline&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;book.title&#125;&#125;&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Delete&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>最後在<code>bookmanager.py</code>加入try catch</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;Fianna&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:12345678@localhost:3306/bookdatabase&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(db.Model):</span><br><span class="line">    title = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;Title: &#123;&#125;&gt;&quot;</span>.<span class="built_in">format</span>(self.title)     </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    books = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> request.form:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            book = Book(title=request.form.get(<span class="string">&quot;title&quot;</span>))</span><br><span class="line">            db.session.add(book)</span><br><span class="line">            db.session.commit()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Failed to add book&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)           </span><br><span class="line">    books = Book.query.<span class="built_in">all</span>()    </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;home.html&quot;</span>, books=books)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/update&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        newtitle = request.form.get(<span class="string">&quot;newtitle&quot;</span>)</span><br><span class="line">        oldtitle = request.form.get(<span class="string">&quot;oldtitle&quot;</span>)</span><br><span class="line">        book = Book.query.filter_by(title=oldtitle).first()</span><br><span class="line">        book.title = newtitle</span><br><span class="line">        db.session.commit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Failed to add book&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)         </span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/delete&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        title = request.form.get(<span class="string">&quot;title&quot;</span>)</span><br><span class="line">        book = Book.query.filter_by(title=title).first()</span><br><span class="line">        db.session.delete(book)</span><br><span class="line">        db.session.commit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Failed to add book&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(e)         </span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">        app.run(debug = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>記錄</category>
        <category>資料庫</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Flask</tag>
        <tag>資料庫</tag>
        <tag>MariaDB</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄3DPrint的相關資訊</title>
    <url>/%E8%A8%98%E9%8C%843DPrint%E7%9A%84%E7%9B%B8%E9%97%9C%E8%B3%87%E8%A8%8A/%E8%A8%98%E9%8C%843DPrint%E7%9A%84%E7%9B%B8%E9%97%9C%E8%B3%87%E8%A8%8A/</url>
    <content><![CDATA[<p>  因為同事要使用3DPrint所以將放很久的設備拿出來整理一下</p>
<h1 id="3D-印表機安裝記錄"><a href="#3D-印表機安裝記錄" class="headerlink" title="3D 印表機安裝記錄"></a>3D 印表機安裝記錄</h1><ol>
<li>首先安裝底座 <img src="底座.png" style="zoom:85%;" />
 先安裝長的兩個框框，鎖的時候要對準
 <img src="DX301066.JPG" style="zoom:85%;" />
 接下將四根鋁擠裝上，就完成的底座，要確定有互相垂直
  <img src="DX301067.JPG" style="zoom:85%;" /></li>
<li>   安裝Z軸<br> 距離是230mm，這裏要注意 <img src="DX301068.JPG" style="zoom:85%;" /></li>
<li>X軸的組裝  <img src="DX301069.JPG" style="zoom:85%;" /></li>
</ol>
  <img src="DX301072.JPG" style="zoom:85%;" />
 
   <img src="DX301073.JPG" style="zoom:85%;" />
 
   <img src="DX301070.JPG" style="zoom:85%;" />
 
  <img src="DX301074.JPG" style="zoom:85%;" />
 
  <img src="DX301075.JPG" style="zoom:85%;" />
  
<ol start="4">
<li><p>Z軸和整體框架組裝<br>  Z軸組裝所需材料：列印件<em>2，電機</em>2，聯軸器<em>2，m3</em>10螺絲<em>8，m4</em>10螺絲<em>4，m4T型螺母</em>4<br>&lt;img src&#x3D;Z軸組裝所需材料.png” style&#x3D;”zoom:85%;” &#x2F;&gt;</p>
<img src="DX301077.JPG" style="zoom:85%;" /></li>
</ol>
<p>   <strong>注意電機的接線的方向</strong></p>
<p>   所需材料：列印件<em>2,330mm光軸</em>2，300mm絲杆<em>2，M4</em>10螺母<em>4，M3</em>20螺絲<em>2，M4T型螺母</em>4，M3螺母*2</p>
<p>   將框架，X軸以及以上配件裝配在一起如下圖<br>   <img src="光軸.png" style="zoom:85%;" /></p>
<p>   將框架，X軸以及以上配件裝配在一起如下圖<br>   <img src="組合好.png" style="zoom:85%;" /></p>
   <img src="DX301078.JPG" style="zoom:85%;" />
   
<p>5 熱床組裝<br>  熱床所需材料：熱床鋁板<em>1，列印件</em>4，m3<em>8螺絲</em>6，m3<em>10螺絲</em>2，m3平墊片<em>8，m3螺母</em>8<br>  <img src="熱床組裝.png" style="zoom:85%;" /></p>
<p>   5-1 用m3<em>8的螺丝将y轴承座和m3</em>10的螺丝将y皮带座分别固定在铝板上，如下图<br>    <img src="鋁鈑.JPG" style="zoom:85%;" /><br>    <img src="DX301080.JPG" style="zoom:85%;" /></p>
<p>6 Y轴组装<br>  所需材料：打印件<em>6，电机</em>1，345mm光轴<em>2，直线轴承</em>3，皮带轮<em>1,695轴承</em>1，m5<em>25螺丝</em>1，m5<em>10螺丝</em>2，<br>  m5<em>8螺丝</em>2，m4<em>10螺丝</em>10，m3<em>10螺丝</em>4，m5垫片<em>4，m5 T型螺母</em>4，m5螺母<em>1<br>  <img src="y軸.jpg" style="zoom:85%;" /><br>  6-1 首先用m5</em>10螺丝和m5<em>25的螺丝将Y被动轮座安装如图所示，695轴承的两边分别垫2个m5的垫片<br>  6-2 安裝y馬達座和皮帶輪。先用M5</em>8的螺絲和T型螺母固定在上面，在用M5<em>8的螺絲和T型螺母固定例一面。最後用4個M3</em>10的螺絲將馬達固定。<br>  如下圖所示：在升級版安裝時，在內側的T型螺母要先將2020的鋁擠拆下來將此馬達座和螺絲先滑進去之後在來固定位置<br>  <img src="y軸2.png" style="zoom:85%;" /></p>
<p>7 电源安装<br>  电源<em>1，电源线</em>1，红黑电源线<em>1，打印件</em>2，m4<em>10螺丝</em>2，m3<em>8螺丝，m4T型螺母</em>2，m3螺母*2<br>  <img src="電源.jpg" style="zoom:85%;" /></p>
<h2 id="Prusa-i3的注意事項"><a href="#Prusa-i3的注意事項" class="headerlink" title="Prusa i3的注意事項"></a>Prusa i3的注意事項</h2><p>   阻位開關，不是請參考下面的圖<br>   <img src="阻位開關.png" style="zoom:85%;" /></p>
   <img src="Rampswire14.jpg" style="zoom:85%;" />

   <img src="Ramps14MEGA.png" style="zoom:85%;" />
   ]]></content>
      <categories>
        <category>記錄</category>
        <category>其它</category>
      </categories>
      <tags>
        <tag>3DPrint</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄CentOS的安裝</title>
    <url>/%E8%A8%98%E9%8C%84CentOS%E7%9A%84%E5%AE%89%E8%A3%9D/%E8%A8%98%E9%8C%84CentOS%E7%9A%84%E5%AE%89%E8%A3%9D/</url>
    <content><![CDATA[<p>  記錄CentOS的安裝,主機板有使用UEFI和沒有使用UEFI</p>
<h3 id="有使用UEFI"><a href="#有使用UEFI" class="headerlink" title="有使用UEFI"></a>有使用UEFI</h3><p>  在設置biso的UEFI的設罝，將QuickBoot&#x2F;FastBoot和Secure Boot已被禁用</p>
<h3 id="在使用ISO燒錄的注意事項"><a href="#在使用ISO燒錄的注意事項" class="headerlink" title="在使用ISO燒錄的注意事項"></a>在使用ISO燒錄的注意事項</h3><p>  目前使用Rufus,選擇GPT</p>
<h3 id="加入強制使用-GPT-分割表的安裝參數"><a href="#加入強制使用-GPT-分割表的安裝參數" class="headerlink" title="加入強制使用 GPT 分割表的安裝參數"></a>加入強制使用 GPT 分割表的安裝參數</h3><p>使用方向鍵，將游標移動到『 Install CentOS 7 』的項目中<br>按下鍵盤的 [Tab] 按鈕，讓游標跑到畫面最下方等待輸入額外的核心參數<br>在出現的畫面中，輸入如下畫面的資料 (注意，各個項目要有空格，最後一個是游標本身而非底線)<br>其實重點就是輸入『 inst.gpt 』這個關鍵字</p>
<img src="centos7_02.jpg" style="zoom:80%;" />
### 文字模式安裝
inst.text  
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vmlinuz initrd=initrd.img linux dd quiet</span><br><span class="line">vmlinuz initrd=initrd.img inst.stage2=hd:/dev/sdc4 quiet</span><br></pre></td></tr></table></figure>

<h3 id="防火牆設定"><a href="#防火牆設定" class="headerlink" title="防火牆設定"></a>防火牆設定</h3><p>顯示目前的設定</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> firewall-cmd --list-all</span><br></pre></td></tr></table></figure>
<p>需要打開的防火牆</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port=3306/tcp</span><br><span class="line">firewall-cmd --permanent --add-port=8080/tcp</span><br><span class="line">firewall-cmd --permanent --zone=public --add-port=22/tcp</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<h3 id="關閉-SELinux"><a href="#關閉-SELinux" class="headerlink" title="關閉 SELinux"></a>關閉 SELinux</h3><p>開啟檔案 &#x2F;etc&#x2F;selinux&#x2F;config:<br> vi &#x2F;etc&#x2F;selinux&#x2F;config<br>找到以下一行:<br>SELINUX&#x3D;enforce<br>改成:<br>SELINUX&#x3D;disabled</p>
<h2 id="安裝MariaDB-10-2-的版本"><a href="#安裝MariaDB-10-2-的版本" class="headerlink" title="安裝MariaDB 10.2 的版本"></a>安裝MariaDB 10.2 的版本</h2><p>  透過 MariaDB 官方提供的 Repositories快速的在 Linux 上佈署 MariaDB 是蠻簡單的事情<br>像是 Ubuntn 或 Debian 也都只需要跟著步驟操作即可首先連結到 <a href="https://downloads.mariadb.org/mariadb/repositories/#mirror=ossplanet">Setting up MariaDB Repositories</a> 頁面<br>選擇 系統、版本 和 MariaDB 版本，稍等一下就會顯示安裝步驟<br>以 CentOS 7 為例<br>先在 &#x2F;etc&#x2F;yum.repos.d&#x2F;MariaDB.repo 檔案，內容如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># MariaDB 10.2 CentOS repository list - created 2017-11-28 09:28 UTC</span><br><span class="line"># http://downloads.mariadb.org/mariadb/repositories/</span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = http://yum.mariadb.org/10.2/centos7-amd64</span><br><span class="line">gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1</span><br></pre></td></tr></table></figure>

<h2 id="安裝MariaDB-10-3-的版本"><a href="#安裝MariaDB-10-3-的版本" class="headerlink" title="安裝MariaDB 10.3 的版本"></a>安裝MariaDB 10.3 的版本</h2><p>透過 MariaDB 官方提供的 Repositories快速的在 Linux 上佈署 MariaDB 是蠻簡單的事情<br>像是 Ubuntn 或 Debian 也都只需要跟著步驟操作即可首先連結到 <a href="https://downloads.mariadb.org/mariadb/repositories/#mirror=ossplanet">Setting up MariaDB Repositories</a> 頁面<br>選擇 系統、版本 和 MariaDB 版本，稍等一下就會顯示安裝步驟<br>以 CentOS 7 為例<br>先在 &#x2F;etc&#x2F;yum.repos.d&#x2F;MariaDB.repo 檔案，內容如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># MariaDB 10.3 CentOS repository list - created 2018-06-11 06:16 UTC</span><br><span class="line"># http://downloads.mariadb.org/mariadb/repositories/</span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = http://yum.mariadb.org/10.3/centos7-amd64</span><br><span class="line">gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接著時間下 yum 指令來進行安裝</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install MariaDB-server MariaDB-client</span><br><span class="line">或</span><br><span class="line">sudo MariaDB-server MariaDB-client</span><br></pre></td></tr></table></figure>

<p>若詢問是否 Importing GPG key 就同意吧,等跑完就安裝起好了<br>啟動 並設定開啟 自動啟動</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 馬上啟動 MariaDB</span><br><span class="line">systemctl start mariadb</span><br><span class="line"># 設定開機自動啟動</span><br><span class="line">systemctl enable mariadb</span><br></pre></td></tr></table></figure>

<p>若是全新安裝，就是跟著做安全性的初始化</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 設定 root 的密碼</span><br><span class="line"># 將 new-password 取代成要使用的新密碼</span><br><span class="line">[root@git ~]# /usr/bin/mysqladmin -u root password &#x27;new-password&#x27;</span><br><span class="line"> </span><br><span class="line">[root@git ~]# /usr/bin/mysql_secure_installation</span><br><span class="line"> </span><br><span class="line"># 輸入目前的 root 密碼，直接輸入剛剛設定的密碼</span><br><span class="line">Enter current password for root (enter for none):</span><br><span class="line"> </span><br><span class="line"># 是否變更 root 密碼，因為是剛設定 應該不用變更了</span><br><span class="line">Change the root password? [Y/n]</span><br><span class="line"> </span><br><span class="line"># 是否移除匿名帳號，按下 y 選擇移除</span><br><span class="line">Remove anonymous users? [Y/n]</span><br><span class="line"> </span><br><span class="line"># 是否拒絕遠端使用 root 權限登入</span><br><span class="line"># 依照個別需求，沒特別需要遠端管理就按 y 吧</span><br><span class="line">Disallow root login remotely? [Y/n]</span><br><span class="line"> </span><br><span class="line"># 是否移除 test 這個測試資料庫，和相關權限</span><br><span class="line"># 沒有需求就移除吧</span><br><span class="line">Remove test database and access to it? [Y/n]</span><br><span class="line"> </span><br><span class="line"># 是否重新載入權限資料表，按 y</span><br><span class="line">Reload privilege tables now? [Y/n]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="如果是ubuntu-mariadb-安裝"><a href="#如果是ubuntu-mariadb-安裝" class="headerlink" title="如果是ubuntu mariadb 安裝"></a>如果是ubuntu mariadb 安裝</h3><p><strong>注意設定檔</strong><br>Ubuntu 開啟 MySQL 遠端連線的設定方法<br>設定 MySql的bind-address:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">將bind-address取消</span><br><span class="line">[mysqld]</span><br><span class="line">……</span><br><span class="line">#bind-address = 127.0.0.1 (在前面加#註解掉此行)</span><br></pre></td></tr></table></figure>
<p>要將創建功能打開 <a href="https://www.cnblogs.com/fzng/p/7267002.html">參考</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%func%&#x27;; </span><br><span class="line">mysql&gt; set global log_bin_trust_function_creators=1; </span><br></pre></td></tr></table></figure>
<p>在移動資料庫時，如果有升級時要升級的指令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql_upgrade -u root -p</span><br></pre></td></tr></table></figure>

<h3 id="MariaDB設定utf8"><a href="#MariaDB設定utf8" class="headerlink" title="MariaDB設定utf8"></a>MariaDB設定utf8</h3><p>在  &#x2F;etc&#x2F;my.cnf.d&#x2F;server.cnf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">init-connect=&#x27;SET NAMES utf8mb4&#x27;</span><br><span class="line">collation_server=utf8mb4_unicode_ci</span><br><span class="line">character_set_server=utf8mb4</span><br></pre></td></tr></table></figure>

<p>在 &#x2F;etc&#x2F;my.cnf.d&#x2F;mysql-clients.cnf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="mysql命令"><a href="#mysql命令" class="headerlink" title="mysql命令"></a>mysql命令</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl restart mariadb</span><br><span class="line">sudo systemctl status mariadb</span><br></pre></td></tr></table></figure>

<p>若啟動失敗，可至 &#x2F;var&#x2F;log&#x2F;mariadb&#x2F;error.log 查看錯誤記錄</p>
<h2 id="新增使用者帳號"><a href="#新增使用者帳號" class="headerlink" title="新增使用者帳號"></a>新增使用者帳號</h2><p>在 host_db 主機登入資料庫</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ mysql -u root -p</span><br></pre></td></tr></table></figure>
<p>新增一個可從 % 主機登入的使用者 username ，密碼為 password</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE USER &#x27;username&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;password&#x27;;</span><br></pre></td></tr></table></figure>

<p>加上所有權限</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grant all privileges on *.* to root@&#x27;%&#x27; identified by &#x27;12345678&#x27; with grant option;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<h2 id="Core安裝2-1"><a href="#Core安裝2-1" class="headerlink" title="Core安裝2.1"></a>Core安裝2.1</h2><p>安裝完後，它的路徑有改，放在&#x2F;usr&#x2F;share&#x2F;dotnet<br>Find the package installed</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum list installed | grep &quot;aspnet&quot;</span><br></pre></td></tr></table></figure>
<p>Remove the package</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum remove aspnetcore-store-2.0.0.x86_64</span><br></pre></td></tr></table></figure>
<p>安裝sdk2.1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo rpm -Uvh https://packages.microsoft.com/config/rhel/7/packages-microsoft-prod.rpm</span><br><span class="line">sudo yum update</span><br><span class="line">sudo yum install dotnet-sdk-2.1</span><br></pre></td></tr></table></figure>
<p>加入symbolic link</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo ln -s /usr/share/dotnet/dotnet /usr/bin/dotnet</span><br></pre></td></tr></table></figure>

<h2 id="Core安裝2-0"><a href="#Core安裝2-0" class="headerlink" title="Core安裝2.0"></a>Core安裝2.0</h2><p>Add the dotnet product feed</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc</span><br><span class="line">sudo sh -c &#x27;echo -e &quot;[packages-microsoft-com-prod]\nname=packages-microsoft-com-prod \nbaseurl= https://packages.microsoft.com/yumrepos/microsoft-rhel7.3-prod\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc&quot; &gt; /etc/yum.repos.d/dotnetdev.repo&#x27;</span><br></pre></td></tr></table></figure>
<ol>
<li>Install the .NET SDK<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo yum update</span><br><span class="line">sudo yum install libunwind libicu</span><br><span class="line">sudo yum install dotnet-sdk-2.1.4</span><br></pre></td></tr></table></figure></li>
<li>驗證.NET Core安裝<br>來到這裡你已經成功安裝.NET Core，建立一個專案測試一下 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#建立Console專案</span><br><span class="line"> [root@localhost ~]# dotnet new console -o hwapp </span><br><span class="line">#移至目錄</span><br><span class="line"> [root@localhost ~]# cd hwapp </span><br><span class="line">#restore dependencies，例如JSON.NET，EntityFramework，Bootstrap等Library</span><br><span class="line"> [root@localhost ~]# dotnet restore </span><br><span class="line">#執行 </span><br><span class="line">[root@localhost ~]# dotnet run </span><br><span class="line">#***Output***: #&gt; Hello World! </span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="安裝Nginx"><a href="#安裝Nginx" class="headerlink" title="安裝Nginx"></a>安裝Nginx</h4><p>在 RHEL, CentOS 或 Fedora 安裝 Nginx, 最簡單的方法是先加入 Nginx 的 CentOS 7 yum repository, 然後用 Yum 安裝</p>
<ul>
<li>編寫最新的 Nginx 套件位置<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#vim /etc/yum.repos.d/nginx.repo</span><br><span class="line">[nginx]</span><br><span class="line">name=nginx repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure></li>
<li>更新一下所有套件庫的快取資料。<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y update</span><br></pre></td></tr></table></figure></li>
<li>利用 yum 安裝<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install nginx</span><br></pre></td></tr></table></figure></li>
<li>啟動防火牆<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --permanent --zone=public --add-service=http</span><br><span class="line">firewall-cmd --permanent --zone=public --add-service=https</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure></li>
<li>設定ngix<br>安裝好 Nginx 網頁伺服器後, 便可以用 systemctl 啟動&#x2F;停止&#x2F;重新啟動 Nginx, 現在啟動 Nginx 及設定開機自動啟動:<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start nginx.service</span><br><span class="line">systemctl enable nginx.service</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="設定nginx"><a href="#設定nginx" class="headerlink" title="設定nginx"></a>設定nginx</h4><p>以下是default的設定範例 &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://localhost:5000;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection keep-alive;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_cache_bypass $http_upgrade;</span><br><span class="line">		proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Cookie $http_cookie;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>建立好設定檔後透過以下命令重新啟動 nginx</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl restart nginx.service</span><br><span class="line">sudo service nginx restart</span><br><span class="line">sudo nginx -t 以驗證組態檔的語法</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="建立服務檔"><a href="#建立服務檔" class="headerlink" title="建立服務檔"></a>建立服務檔</h4><p>指令如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/systemd/system/gomoshop.service</span><br></pre></td></tr></table></figure>
<p>內容如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=GomoShop  running on Centos7</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/home/wwwdata/wwwshop</span><br><span class="line">ExecStart=/usr/bin/dotnet /home/wwwdata/wwwshop/Gomo.CC.UI.Portal.dll</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10  # Restart service after 10 seconds if dotnet service crashes</span><br><span class="line">SyslogIdentifier=dotnet-gomoshop</span><br><span class="line">User=root</span><br><span class="line">Environment=ASPNETCORE_ENVIRONMENT=Production</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>指令參考</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl enable gomoshop.service</span><br><span class="line">systemctl status gomoshop.service</span><br><span class="line">systemctl restart gomoshop.service</span><br><span class="line">journalctl -fu gomoshop.service</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h6><ol>
<li><a href="https://rufus.akeo.ie/?locale=zh_TW">Rufus的官方網站</a></li>
<li><a href="http://blog.xuite.net/yh96301/blog/450717778-Rufus%E8%A3%BD%E4%BD%9CUbuntu+16.04+USB%E5%AE%89%E8%A3%9D%E9%9A%A8%E8%BA%AB%E7%A2%9F">Rufus製作Ubuntu 16.04 USB安裝隨身碟</a></li>
<li><a href="https://www.microsoft.com/net/learn/get-started/linux/centos">Core安裝</a></li>
<li><a href="http://linux.vbird.org/linux_basic/0157installcentos7.php">鳥哥</a></li>
</ol>
<h4 id="安裝vsftp"><a href="#安裝vsftp" class="headerlink" title="安裝vsftp"></a>安裝vsftp</h4><p>我們從 CentOS 官方套件庫直接安裝就可以了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo yum -y install vsftpd</span><br></pre></td></tr></table></figure>
<p>啟動服務<br>不必修改任何設定值，就可以正常的啟動 vsFTPd 服務</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl restart vsftpd</span><br></pre></td></tr></table></figure>
<p>預設的 FTP 根目錄在 &#x2F;var&#x2F;ftp。<br>我們可以視需求，決定是否讓服務在開機時就自動啟動。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl enable vsftpd</span><br></pre></td></tr></table></figure>
<p>主設定檔及相關設定檔的預設儲存目錄在 &#x2F;etc&#x2F;vsftpd。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo vi /etc/vsftpd/vsftpd.conf</span><br></pre></td></tr></table></figure>
<p>其他相關設定<br>防火牆</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo firewall-cmd --permanent --zone=public --add-service=ftp</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>如果有啟用被動模式的話，再加上指派給它的通訊埠範圍。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=60101-61200/tcp</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>相關設定檔<br>&#x2F;etc&#x2F;vsftpd&#x2F;ftpusers<br>這個檔案用來列出絕對禁止登入 FTP Server 的本機使用者，預設的名單有 root 跟一些常見的本機服務帳號，像是 mail、sync、shutdown … 之類的。</p>
<h3 id="安裝ftpclient"><a href="#安裝ftpclient" class="headerlink" title="安裝ftpclient"></a>安裝ftpclient</h3><p>  下達下面的指令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install –y ftp</span><br></pre></td></tr></table></figure>

<h6 id="參考-1"><a href="#參考-1" class="headerlink" title="參考"></a>參考</h6><ul>
<li><a href="http://blog.itist.tw/2016/08/build-ftp-server-with-vsftpd-on-centos-7.html">CentOS 7 傳輸檔案的好伙伴，老當益壯的 FTP 伺服器 - vsFTPd</a></li>
<li><a href="https://www.openfoundry.org/en/enterprise-application/9349-centos7">輕鬆學習 centos-7 基礎安裝升級與使用</a></li>
</ul>
]]></content>
      <categories>
        <category>記錄</category>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>CentOS</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄輸入法的使用</title>
    <url>/%E8%A8%98%E9%8C%84%E8%BC%B8%E5%85%A5%E6%B3%95%E7%9A%84%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84%E8%BC%B8%E5%85%A5%E6%B3%95%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h2 id="記錄一下小小輸人法"><a href="#記錄一下小小輸人法" class="headerlink" title="記錄一下小小輸人法"></a>記錄一下小小輸人法</h2><p>【小小輸入法】(無蝦米)</p>
<p>真心覺得不錯用….<br>幫忙中文化的泰瑞先生建議是一律將程式目錄複製到「C:\Windows」底下</p>
<p>1.下載解壓縮後將Terry_Yon資料夾放到「C:\Windows」</p>
<ol start="2">
<li>C:\Windows\Terry_Yong\tsf\install.bat 按右鍵以系統管理員權限執行</li>
</ol>
<p>3.Windows 8&#x2F;8.1&#x2F;10 使用者安裝成功後，請到「控制台」→「語言」（或「新增語言」）項下，<br>點選「中文(台灣)」旁的「選項」，新增「泰瑞版小小輸入法」</p>
<p>在正常情況下，<br>泰瑞版小小輸入法應該會被安裝到「中文(繁體，台灣)」（或「中文(台灣)」）這個輸入語言之下，<br>如果被安裝到「中文(簡體，中國)」這個輸入語言之下，<br>請執行「uninstall.bat」後，再重新「install.bat」，就會成功了！</p>
<p>4.製作「yong.exe」的捷徑，並存放到 Windows 程式集的「啟動」裡。<br>Windows 8&#x2F;8.1&#x2F;10 預設的「啟動」資料夾路徑是：<br>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\啟動<br>(C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp –&gt;英文版的路徑)</p>
<ol start="5">
<li>C:\Windows\Terry_Yong\yong.exe 按右鍵以系統管理員權限執行</li>
</ol>
<p>6.在工作列右邊的小蝸牛圖示上按滑鼠右鍵，選「結束」，即可關閉程式。<br>7.開啟／關閉輸入法主視窗（畫面右下方的橫條）：Ctrl + Space（內置版請改為 Ctrl + <code>）。 8.中打／英打切換：左 Shift。 9.打繁出繁／打繁出简切換：Ctrl + Alt + S。 10.半型／全型切換：Shift + Space。 11.半型／全型標點符號切換：Ctrl + .（針對 Shift + </code>～Shift + &#x3D; 的符號進行全半型切換）。<br>12.重複上一個字：Ctrl + Alt + G。</p>
<p>輸入法模式切換：</p>
<p>Ctrl + Shift + 5：無蝦米；<br>Ctrl + Shift + 7：注音（只適合用來反查注音，不適合用來打字）；<br>Ctrl + Shift + 9：英文。</p>
<p>注意：<br>(1)必須先開啟輸入法主視窗才能進行切換。<br>(2)在 Word 中，Ctrl + 1、Ctrl + Alt + 1 已定義為其他作用，因此使用以上熱鍵組合已是最佳選擇。</p>
<p>開啟螢幕小鍵盤（軟鍵盤）：<br>Ctrl + Alt + K<br>注意事項：<br>(1)開啟後必須以滑鼠點選符號，而且使用完畢後必須自行關閉視窗。<br>(2)在主視窗上的「鍵盤圖示」上按右鍵，可切換至不同類別之符號。</p>
<p>◎特殊功能：<br>一、萬用碼：<code>（Tab 上方的按鍵），不確定正確拆碼時，可用來進行模糊拆碼（一個「</code>」代表一個模糊碼）。<br>二、注音輸入：除注音模式外，在其他中文模式下，可用「’」當作前導字元，然後模擬注音輸入。<br>三、手動反查組字字根：<br>切換到想查的輸入法模式（倉頡、行列30、無蝦米、注音、拼音、大易皆可），<br>選取並複製想要查的字（必須是單一漢字，而且一定要先按 Ctrl + C 複製起來），<br>再直接按「Ctrl + &#x2F;」，即可反查該字在對應模式下的所有拆碼；<br>接著，可用滑鼠、方向鍵（加空白鍵）或鍵盤右邊的數字鍵，將反查到的拆碼直接「上屏」。<br>注意：在注音模式以外的其他中文模式下，因為結合注音輸入的功能，<br>　　　所以反查到的注音拆碼 它們會以「@」開頭，方便我們來識別。</p>
<p>以上整理來自「泰瑞版的小小輸入法」<br><a href="http://terryhung.pixnet.net/blog/post/26968247">http://terryhung.pixnet.net/blog/post/26968247</a></p>
<p>泰瑞版小小輸入法─安裝設置篇<br><a href="http://terryhung.pixnet.net/blog/post/27952497">http://terryhung.pixnet.net/blog/post/27952497</a></p>
<p>泰瑞版小小輸入法─相關字詞篇<br><a href="http://terryhung.pixnet.net/blog/post/27912895">http://terryhung.pixnet.net/blog/post/27912895</a></p>
<p>泰瑞版小小輸入法 for Linux<br><a href="http://terryhung.pixnet.net/blog/post/28864128">http://terryhung.pixnet.net/blog/post/28864128</a></p>
<h6 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h6><ul>
<li><a href="http://fygul.blogspot.com/2018/05/yong-tw2018.html">小小輸入法臺灣包2018年版</a></li>
<li><a href="https://fygul.github.io/yong-tw2018-help/">小小輸入法平台臺灣包2018年版</a></li>
<li><a href="https://eb1.hcc.edu.tw/edu/data/schmedia/50/201609080026001352.txt">說明</a></li>
</ul>
]]></content>
      <categories>
        <category>記錄</category>
        <category>其它</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄SSL的安裝</title>
    <url>/%E8%A8%98%E9%8C%84SSL%E7%9B%B8%E9%97%9C/%E8%A8%98%E9%8C%84SSL%E7%9A%84%E5%AE%89%E8%A3%9D/%E8%A8%98%E9%8C%84SSL%E7%9A%84%E5%AE%89%E8%A3%9D/</url>
    <content><![CDATA[<h1 id="記錄SSL的安裝"><a href="#記錄SSL的安裝" class="headerlink" title="記錄SSL的安裝"></a>記錄SSL的安裝</h1><p> 因為有使用到SSL所以記錄一下，有關SSL的相關資訊</p>
 <span id="more"></span> 

<h2 id="Let’s-Encrypt-申請"><a href="#Let’s-Encrypt-申請" class="headerlink" title="Let’s Encrypt 申請"></a>Let’s Encrypt 申請</h2><p>因為是免費 SSL 憑證</p>
<ul>
<li><p>使用 SSH 登入 Ubuntu 18.04.1 LTS 主機</p>
</li>
<li><p>先確認 snapd 已升級到最新版本,確認現有已安裝的 Certbot 已確實移除</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo snap install core; sudo snap refresh core</span><br><span class="line">sudo apt-get remove certbot</span><br><span class="line">sudo snap install --classic certbot</span><br><span class="line">sudo ln -s /snap/bin/certbot /usr/bin/certb</span><br></pre></td></tr></table></figure>

<blockquote>
<p>安裝過程中會自動安裝一個 <code>snap.certbot.renew.service</code> 系統服務，此服務專門用來自動更新憑證之用。你可以透過 <code>systemctl list-units --all --type=service --no-pager | grep certbot</code> 查詢該服務，或透過 <code>service snap.certbot.renew status</code> 查詢目前的執行狀態。剛安裝好的 certbot 並不會有服務執行。</p>
</blockquote>
<ul>
<li><p>建立Let’s Encrypt需要的文件</p>
<p>因為nginx是docker來建立的，它的html放在<code>/usr/shar/nginx</code></p>
<p> docker-compose.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.4&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"> <span class="comment">#......</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="comment">#....</span></span><br><span class="line">    <span class="comment"># ---------------- nginx  ----------------</span></span><br><span class="line">    <span class="comment">#- ~/docker/uwsgi/docker_config/nginx.conf:/etc/nginx/nginx.conf 在app的目錄下</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./docker_config/nginx.conf:/app/nginx.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./docker_config/server.conf:/etc/nginx/server.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./docker_config/location_v0.5.conf:/etc/nginx/location_v0.5.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./docker_config/uwsgi.ini:/app/uwsgi.ini</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./docker_config/uwsgi.ini:/etc/uwsgi/uwsgi.ini</span></span><br><span class="line">    <span class="comment"># -----------------html ------------------</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/usr/share/nginx:/usr/share/nginx</span></span><br><span class="line">    <span class="comment">#.....</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure></li>
</ul>
<p>​      建立資料夾</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /usr/share/nginx</span><br><span class="line">sudo mkdir -p /usr/share/nginx/letsencrypt/.well-known/acme-challenge</span><br></pre></td></tr></table></figure>

<p>在server.conf加入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#Let’s Encrypt相關 </span><br><span class="line">location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">  default_type &quot;text/plain&quot;;</span><br><span class="line">  root /usr/share/nginx/letsencrypt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>並測試網址可以正常連接在路徑下<code>/usr/share/nginx/letsencrypt/.well-known/acme-challenge</code>下建立test.html</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">this is a ssl</span><br></pre></td></tr></table></figure>

<p>重啟nginx</p>
<p>以瀏覽器連接網址<code>http://www.examplefms.com/.well-known/acme-challenge/test.html</code>如果可以顯示就可以進行下一步</p>
<ul>
<li>取得憑證</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">certbot certonly --webroot --agree-tos --email ttom@example.com.tw --webroot-path /usr/share/nginx/letsencrypt -d examplefms.com -d www.examplefms.com</span><br></pre></td></tr></table></figure>
<p>命令中的幾個<code>flag</code>大概解釋</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">certonly :說明我們只需要獲取證書，不需要`certbot` 為我們去執行自動安裝</span><br><span class="line">--webroot:使用Webroot的驗証方式</span><br><span class="line">--agree-tos:默認同意Let&#x27;s Ecnrypt的一些agreements,不加的話在命令執行過程還是會問用戶是否同意</span><br><span class="line">--email:用來獲取一些通知，比如証書過期</span><br><span class="line">--webroot-path: 對應上面nginx設罝中的server定義區壞里的root地址</span><br><span class="line">-d: 需要驗証的SSL的域名，可以多個</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：所有<strong>偵錯訊息</strong>都會放在 <code>/var/log/letsencrypt/letsencrypt.log</code> 檔案中。</p>
</blockquote>
<p>接下來成功的畫面</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Successfully received certificate.</span><br><span class="line">Certificate is saved at: /etc/letsencrypt/live/&#123;&#123; EXAMPLE.COM &#125;&#125;/fullchain.pem</span><br><span class="line">Key is saved at:         /etc/letsencrypt/live/&#123;&#123; EXAMPLE.COM &#125;&#125;/privkey.pem</span><br><span class="line">This certificate expires on &#123;&#123; SOME DATE &#125;&#125;.</span><br><span class="line">These files will be updated when the certificate renews.</span><br><span class="line">Certbot has <span class="built_in">set</span> up a scheduled task to automatically renew this certificate <span class="keyword">in</span> the background.</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">If you like Certbot, please consider supporting our work by:</span><br><span class="line"> * Donating to ISRG / Let<span class="string">&#x27;s Encrypt:   https://letsencrypt.org/donate</span></span><br><span class="line"><span class="string"> * Donating to EFF:                    https://eff.org/donate-le</span></span><br><span class="line"><span class="string">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>生成的證書會保存在固定的路徑下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/letsencrypt/live/&#123;&#123; EXAMPLE.COM &#125;&#125;/fullchain.pem</span><br><span class="line">/etc/letsencrypt/live/&#123;&#123; EXAMPLE.COM &#125;&#125;/privkey.pem</span><br></pre></td></tr></table></figure>

<h3 id="測試是否會自動更新憑證"><a href="#測試是否會自動更新憑證" class="headerlink" title="測試是否會自動更新憑證"></a>測試是否會自動更新憑證</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo certbot renew --dry-run</span><br></pre></td></tr></table></figure>

<p>在server.conf加入SSL的設定</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">   <span class="comment">#        listen 80;</span></span><br><span class="line">   <span class="comment">#    listen 443 ssl;</span></span><br><span class="line">   <span class="comment"># ---真實IP---------------</span></span><br><span class="line">   <span class="attribute">listen</span> <span class="number">80</span> proxy_protocol; <span class="comment">#負責解開data資訊</span></span><br><span class="line">   <span class="attribute">listen</span> <span class="number">443</span> ssl proxy_protocol;</span><br><span class="line">   </span><br><span class="line">   <span class="comment"># ---真實IP---------------</span></span><br><span class="line">   <span class="attribute">set_real_ip_from</span> <span class="number">172.30.0.0</span>/<span class="number">16</span>;</span><br><span class="line">   <span class="attribute">real_ip_header</span>  proxy_protocol;</span><br><span class="line">   <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;&quot;</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> X-Real-IP       <span class="variable">$proxy_protocol_addr</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_protocol_addr</span>;</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   <span class="comment"># location @app &#123;</span></span><br><span class="line">   <span class="comment">#     include uwsgi_params;</span></span><br><span class="line">   <span class="comment">#     uwsgi_pass unix:///tmp/uwsgi.sock;</span></span><br><span class="line">   <span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="attribute">server_name</span> example.com www.example.com ;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment">#    ssl on;      #開啟的話只能使用https</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span>      /etc/nginx/fullchain.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span>  /etc/nginx/privkey.pem;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">5m</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">ssl_ciphers</span> <span class="string">&quot;EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA RC4-SHA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#...  </span></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">alias</span> /usr/share/nginx/html/;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line"><span class="comment">#        root /usr/share/nginx/html/;</span></span><br><span class="line"><span class="comment">#        index index.html index.htm;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#...   </span></span><br><span class="line">    <span class="comment"># Let’s Encrypt相關 </span></span><br><span class="line">    <span class="section">location</span><span class="regexp"> ^~</span> /.well-known/acme-challenge/ &#123;</span><br><span class="line">       <span class="attribute">default_type</span> <span class="string">&quot;text/plain&quot;</span>;</span><br><span class="line">       <span class="attribute">root</span> /usr/share/nginx/letsencrypt;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#...   </span></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/location_v0.<span class="number">5</span>.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="確認憑證狀態"><a href="#確認憑證狀態" class="headerlink" title="確認憑證狀態"></a>確認憑證狀態</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo certbot certificates</span><br></pre></td></tr></table></figure>

<h3 id="自動更新憑證"><a href="#自動更新憑證" class="headerlink" title="自動更新憑證"></a>自動更新憑證</h3><p>驗證憑證自動更新</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo certbot renew --dry-run</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述命令會自動設定一個系統排程，你可以透過 <code>systemctl list-timers --no-pager</code> 或 <code>systemctl list-unit-files --type timer</code> 查詢到一個名為 <code>snap.certbot.renew.timer</code> 的排程作業(UNIT)。</p>
</blockquote>
<p>調整 Systemd 的 Timer 排程</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/systemd/system/timers.target.wants/snap.certbot.renew.timer</span><br></pre></td></tr></table></figure>

<p>如下</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment">#....</span></span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line">Unit=snap.certbot.renew.<span class="attribute">service</span></span><br><span class="line">OnCalendar=*-*-* <span class="number">20</span>:<span class="number">06</span></span><br><span class="line">OnCalendar=*-*-* <span class="number">14</span>:<span class="number">58</span>                                                                                             <span class="comment">#....</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>動作</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl start snap.certbot.renew.timer</span><br><span class="line">sudo systemctl enable snap.certbot.renew.timer</span><br><span class="line">sudo systemctl status snap.certbot.renew.timer</span><br><span class="line">sudo systemctl restart snap.certbot.renew.timer</span><br></pre></td></tr></table></figure>



<p>參考資料</p>
<p><a href="https://blog.miniasp.com/post/2021/05/09/Create-SSL-TLS-certificates-from-LetsEncrypt-using-Certbot-2">如何使用 Certbot 建立免費的 TLS&#x2F;SSL 網域憑證並自動產生 PFX 憑證</a></p>
<p><a href="https://blog.gtwang.org/linux/secure-nginx-with-lets-encrypt-ssl-certificate-on-ubuntu-and-debian/">NGINX 使用 Let’s Encrypt 免費 SSL 憑證設定 HTTPS 安全加密網頁教學</a></p>
<h2 id="Comodo的申請"><a href="#Comodo的申請" class="headerlink" title="Comodo的申請"></a>Comodo的申請</h2><p>因為公司同事已經有申請SSL下來，所以要來安裝到IIS上，記錄下來以免下次再使用時忘記</p>
<ul>
<li>第 1 步：建立憑證要求<br>公司同事有申請下來，所以此步驟來跳過去，可參考下面參考資料的保哥</li>
<li>第 2 步：購買憑證<br>我們是向COMODO來購買的<br>有四個檔案<br>153940105.crt<br>AddTrustExternalCARoot.crt<br>COMODORSAAddTrustCA.crt<br>COMODORSADomainValidationSecureServerCA.crt</li>
<li>憑證匯入<br>在153940105.crt雙擊在詳細資料的主體別名有列出可以使用的網域<br>在IIS上選擇”伺服器憑證” <img src="1-2-6.jpg" alt="image" style="zoom:80%;" />
在右邊選擇"完成憑證要求"
<img src="1-3-4.jpg" alt="image" style="zoom:80%;" />
「含有憑證授權單位回應的檔案名稱(R):」輸入要安裝的憑證。
「好記的名稱(Y): 」輸入憑證名稱或自己好記的名字。
「選取新憑證的儲存區」依個人喜好選擇。
<img src="1-4-4.jpg" alt="image" style="zoom:80%;" />
「確定」後即可看到憑證已安裝完成。
<img src="1-5-3.jpg" alt="image" style="zoom:80%;" /></li>
<li>設定站台繫結<br>最後一個步驟就是要將剛剛完成的憑證繫結(Binding)到站台去，你可以先選取要設定 SSL 的站台，按下滑鼠右鍵並選取 [繫結]<br>然後點擊 [新增] 按鈕，在類型欄位選取 https，然後再到 SSL 憑證欄位選取你剛剛新增的 [自我憑證]，這裡顯示的名稱是你剛剛匯入自我憑證時「好記的名稱」欄位所設定的值。最後按下 [確定] 按鈕即可將 SSL 憑證設定完成。</li>
</ul>
<h3 id="Comodo的三個crt檔合併"><a href="#Comodo的三個crt檔合併" class="headerlink" title="Comodo的三個crt檔合併"></a>Comodo的三個crt檔合併</h3><p>因此我們正確的作法是將Comodo所提供的三個crt檔合併指令如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat www_cklube_com_tw.crt COMODORSADomainValidationSecureServerCA.crt  COMODORSAAddTrustCA.crt &gt; club_ssll.crt</span><br></pre></td></tr></table></figure>


<h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><ul>
<li><a href="https://blog.cloudmax.com.tw/ssl-installed-windows-server-2012-r2/">SSL 憑證安裝攻略-Windows Server 2012 R2</a></li>
<li><a href="https://blog.miniasp.com/post/2010/03/02/The-Complete-Guide-for-Purchase-Install-SSL-Certificate-to-IIS7.aspx">購買與安裝 SSL 憑證完全攻略（以 IIS7 為例）</a></li>
<li><a href="https://www.ez2o.com/Blog/Post/Buy-Cheap-Web-SSL-Use-IIS">平價 Web SSL 憑證 購買 選擇 分析 使用 IIS 作為範例</a></li>
</ul>
]]></content>
      <categories>
        <category>記錄</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>SSL</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄pfx證書的產生</title>
    <url>/%E8%A8%98%E9%8C%84SSL%E7%9B%B8%E9%97%9C/%E8%A8%98%E9%8C%84pfx%E8%AD%89%E6%9B%B8%E7%9A%84%E7%94%A2%E7%94%9F/%E8%A8%98%E9%8C%84pfx%E8%AD%89%E6%9B%B8%E7%9A%84%E7%94%A2%E7%94%9F/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>這是因為有使用到<code>pfx證書</code>的使用，所以來記錄一下，自已來產生<code>pfx</code>檔的過程。</p>
<span id="more"></span>

<p>可以使用openssl來生成首先到<a href="https://slproweb.com/products/Win32OpenSSL.html">openssl的官網</a>來下載安裝檔，來安裝，我是預設安裝所以路徑是<code>C:\Program Files\OpenSSL-Win64\bin</code>，之後在這裏以命令列來處理</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openssl req -newkey rsa:2048 -nodes -keyout socialnetwork.key -x509 -days 3650 -out socialnetwork.cer</span><br><span class="line">.............................................................................................................................+++++</span><br><span class="line">..................................................+++++</span><br><span class="line">writing new private key to &#x27;socialnetwork.key&#x27;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [AU]:TW</span><br><span class="line">State or Province Name (full name) [Some-State]:Taiwan</span><br><span class="line">Locality Name (eg, city) []:Taipei</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:netschool</span><br><span class="line">Organizational Unit Name (eg, section) []:dev</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:ttom</span><br><span class="line">Email Address []:你的email或 .</span><br></pre></td></tr></table></figure>

<p>輸入相關的資訊，可以不輸入以<code>.</code>來替代這個證書有效期是3650天</p>
<p>一個證書和一個key,我們需要封裝成一個文件，以便有用卩的可以使用它們去正確的簽名，需要使用另一個命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openssl pkcs12 -export -in socialnetwork.cer -inkey socialnetwork.key -out socialnetwork.pfx</span><br></pre></td></tr></table></figure>

<p>會要求密碼：<code>12345678</code>就產生好了pfx檔</p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><p><a href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92IdentityServer4%E7%9A%84%E7%9B%B8%E9%97%9C%E7%9F%A5%E8%AD%98/#%E4%BD%BF%E7%94%A8%E6%AD%A3%E7%B6%93%E7%9A%84%E8%A8%BC%E6%9B%B8">學習IdentityServer4的相關知識</a></p>
]]></content>
      <categories>
        <category>記錄</category>
        <category>其它</category>
      </categories>
      <tags>
        <tag>SSL</tag>
      </tags>
  </entry>
  <entry>
    <title>記錄免費憑證的使用</title>
    <url>/%E8%A8%98%E9%8C%84SSL%E7%9B%B8%E9%97%9C/%E8%A8%98%E9%8C%84%E5%85%8D%E8%B2%BB%E6%86%91%E8%AD%89%E7%9A%84%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84%E5%85%8D%E8%B2%BB%E6%86%91%E8%AD%89%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="申請免費的憑證的使用"><a href="#申請免費的憑證的使用" class="headerlink" title="申請免費的憑證的使用"></a>申請免費的憑證的使用</h1><p>記錄一下免費憑證的申請和放到IIS</p>
<ol>
<li>開啟 SSL For Free 網站後，直接在上方填入你要申請 Let’s Encrypt 憑證的網域名稱，可以用空白來分隔不同的網址，<br> 例如「subdomain.domain.com domain.com other.com」，填入後點選右邊的「Create Free SSL Certificate」繼續。 <img src="SSL-For-Free2015-12-29_1451.png" style="zoom:80%;" /></li>
<li>為了確定這個網域名稱使你所有，會有兩種驗證方式，如果你的網站本身開啟 FTP 功能的話，可使用「Automatic FTP Verification」<br>   來輸入相關資訊完成驗證；因為要將驗證分段操作給讀者看，所以我選擇使用手動的驗證方式，必須自己下載檔案，依照說明上傳到主機。<br>   點選後，點選下方的「Manually Verify Domain」繼續。   <img src="SSL-For-Free2015-12-29_1454.png" style="zoom:80%;" /></li>
<li>點選網站上提供的檔案下載鏈結，依照說明順序建立兩層資料夾，將檔案放進去即可。記得要按下圖第 5 步驟的鏈結來看看能否正常讀取檔案，如果不行，代表你的路徑可能錯誤，總之呢要讓鏈結都能正常開啟，<br>使SSL For Free能夠正常驗證你的站台。<img src="2018-09-21_10_13_2Image.png" style="zoom:80%;" />
先在網站建立一個資料夾叫 *.well-known/acme-challenge* 將第一次下載的檔上傳到 .well-known/acme-challenge 下
這裡我相信很多人都是在這邊失敗、失敗、再失敗！無論如何就是沒有辦法讓驗證鏈結正常開啟！
明明按照說明在站台建立好指定的路徑，也都正確放入驗證檔
在不斷的 google 找尋檔案後才發現原來因為他的鏈結路徑「.well-known\acme-challenge」*前面那個「.」關係*，站台認不出來！
就會一直無法正常顯示，在 IIS 平台上要記得先行設定 MIME類型，讓 IIS 認得「.well-known\acme-challenge」鏈結路徑
或者直接在 IIS 平台的站台上點選進入「MIME 類型」。
<img src="2018-09-21_10_16_3Image.png" style="zoom:80%;" />
加入「副檔名： . MIME 類型：text/plain」即可。
 <img src="2018-09-21_10_19_4Image.png" style="zoom:80%;" /></li>
<li>確定驗證連結沒有問題後，再點選最下方的「Download SSL Certificate」，通過驗證後，SSL For Free 就會開始產生 SSL 憑證</li>
<li>當憑證產生後，你就能在最終的結果頁面看到這些資訊。不過在此之前，我會建議你先找到如下面擷圖標示出來的「Get Notified of Expiration」欄位，<br>設定一組 Email 和密碼，即可在憑證過期前取得通知，以免錯過延長（renew）時間。</li>
<li>從網頁最下方點選「Download All SSL Certificate Files」就能打包這些檔案，<br>解壓縮後可以取得一個私密金鑰（Privacy Key）、CA_bundle.crt 和 certificate.crt<br>三個檔案，返回你的主機控制台，即可將憑證安裝進去囉！	</li>
<li>產生的憑證是 .crt 非 .pfx，IIS 憑台只能使用 .pfx 憑證檔，所以這時候就需要透過工具做轉換，<br>我們到 <a href="http://slproweb.com/products/Win32OpenSSL.html">OpenSSL for Windows</a> 去下載 OpenSSL 回來，並把他安裝完成</li>
<li>   安裝完成後，開啟命令提示字元，透過下面的指令來執行格式轉換，<br> 過程中，OpenSSL 會要我們輸入一個保護 SSL 憑證的密碼（密碼在後面 IIS 匯入時會用到）<br> 注意：指令中 D:\Downloads\sslforfree\ 是電腦的路徑，請更改你放憑證檔的路徑。<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\OpenSSL-Win64\bin\openssl pkcs12 -export -out D:\Downloads\sslforfree\certificate.pfx -inkey D:\Downloads\sslforfree\private.key -in D:\Downloads\sslforfree\certificate.crt -certfile D:\Downloads\sslforfree\ca_bundle.crt</span><br></pre></td></tr></table></figure></li>
<li>執行完畢後，PKCS#12 憑證檔 certificate.pfx 就會產生在我們指定的目錄下面（檔案類型為個人資訊交換）。</li>
<li>我們只要把PKCS#12 憑證檔上傳到 IIS 的站台，請至 IIS 點選「伺服器憑證」  <img src="2018-09-21_10_43_5Image.png" style="zoom:80%;" />
  點選右邊動作「匯入 …」。
  在匯入憑證視窗，點選「…」，選擇你產生出來的 certificate.pfx 憑證檔 
  並輸入之前使用  OpenSSL 轉檔時的密碼。
  站台新增繫結，請先點選你的站台，在右邊動作點選「繫結」，於站台繫結點選「新增」。
  類型選擇「https」，SSL 憑證就直接點選你剛剛放入的憑證。</li>
</ol>
<h6 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h6><ul>
<li><a href="http://tech.smallya.net/2016/07/07/%E4%BD%BF%E7%94%A8-ssl-for-free-%E7%94%A2%E7%94%9F-lets-encrypt-ssl-%E6%86%91%E8%AD%89%E4%B8%8A%E5%82%B3%E7%B5%A6-iis-%E7%AB%99%E5%8F%B0%E4%BD%BF%E7%94%A8/">產生lets encrypt ssl 憑證上傳給 iis 站台使用</a></li>
<li><a href="https://free.com.tw/ssl-for-free/">SSL For Free 免費 SSL 憑證申請，使用 Let’s Encrypt 最簡單方法教學</a></li>
<li><a href="https://letsencrypt.org/">免費憑證</a></li>
</ul>
]]></content>
      <categories>
        <category>記錄</category>
        <category>其它</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
</search>
