<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ttom921.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="記錄有的沒有的">
<meta property="og:type" content="website">
<meta property="og:title" content="被施工的Tom的記錄">
<meta property="og:url" content="https://ttom921.github.io/page/2/index.html">
<meta property="og:site_name" content="被施工的Tom的記錄">
<meta property="og:description" content="記錄有的沒有的">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="Tom Tang">
<meta property="article:tag" content="前端,後端,全端,網頁,技術,網頁開發,前端開發,後端開發">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://ttom921.github.io/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-TW","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>被施工的Tom的記錄</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">被施工的Tom的記錄</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">異想世界</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜尋" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Tom Tang</p>
  <div class="site-description" itemprop="description">記錄有的沒有的</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92%E4%BD%A0%E6%87%82JavaScirpt%E5%97%8E/%E5%AD%B8%E7%BF%92%E4%BD%A0%E6%87%82JavaScirpt%E5%97%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%AD%B8%E7%BF%92%E4%BD%A0%E6%87%82JavaScirpt%E5%97%8E/%E5%AD%B8%E7%BF%92%E4%BD%A0%E6%87%82JavaScirpt%E5%97%8E/" class="post-title-link" itemprop="url">學習你懂JavaScirpt嗎?</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-08-12 09:32:18" itemprop="dateCreated datePublished" datetime="2019-08-12T09:32:18+00:00">2019-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/javascript/" itemprop="url" rel="index"><span itemprop="name">javascript</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>這是參考這是參考2019 iT 邦幫忙鐵人賽的<a href="https://ithelp.ithome.com.tw/users/20092232/ironman/1612">你懂 JavaScript 嗎？</a>這篇文章來學習和記錄</p>
<h3 id="你懂JavaScript嗎？運算子、運算式、值與型別、變數、條件式、迴圈"><a href="#你懂JavaScript嗎？運算子、運算式、值與型別、變數、條件式、迴圈" class="headerlink" title="你懂JavaScript嗎？運算子、運算式、值與型別、變數、條件式、迴圈"></a>你懂JavaScript嗎？運算子、運算式、值與型別、變數、條件式、迴圈</h3><p>這裏主要內容為程式設計簡介，在此可看到初䌣階段所必須理解的各種專有名詞。</p>
<h4 id="程式碼-Code"><a href="#程式碼-Code" class="headerlink" title="程式碼(Code)"></a>程式碼(Code)</h4><p>程式(program)又稱原始碼(source cde)、程式碼(code)、用來表示一群執行特定工作的指令，也可以說是述句組成的集合。</p>
<h4 id="語法-Syntab"><a href="#語法-Syntab" class="headerlink" title="語法(Syntab)"></a>語法(Syntab)</h4><p>規範有交指令與組合的規則，稱為電腦語言(computer language)或語法(syntax)。可想成若希望能編寫電腦可懂的語言，就必須遵循一套規則來撰寫，而這個規則𣄵是語法，就和我們平常溝通所說的語言的文法是一樣的。</p>
<h4 id="述句-Statement"><a href="#述句-Statement" class="headerlink" title="述句(Statement)"></a>述句(Statement)</h4><p>會執行特定工作的字詞、數字或運算子(operator)組合，即是述句(statement)，例如:<code>a = b+1</code>就會執行<code>b+1</code>並將結果指定給a。</p>
<h4 id="字面值-Literal-Value"><a href="#字面值-Literal-Value" class="headerlink" title="字面值(Literal Value)"></a>字面值(Literal Value)</h4><p>獨立存在的值， 沒有存在於任何變數中，到如:<code>a = b + 1</code>中的1。</p>
<h4 id="直譯器-Interpreter-與編譯器-Compiler"><a href="#直譯器-Interpreter-與編譯器-Compiler" class="headerlink" title="直譯器(Interpreter)與編譯器(Compiler)"></a>直譯器(Interpreter)與編譯器(Compiler)</h4><p>直譯器與編譯器可將程式碼由上到下逐行轉為電腦可懂的命令。其差別在於時機點</p>
<ul>
<li><p>直譯(interpret)：在程式執行「時」做轉換。</p>
</li>
<li><p>編譯(compile)：在程式執行「前」做轉換，然後會產出編譯後的指令，因此之後執行的是這個編譯後的結果。注意，JavaScript引擎在每次執行前即時編譯程式碼，接著立刻執行編譯後的指令。</p>
</li>
</ul>
<h4 id="運算子-Operaors"><a href="#運算子-Operaors" class="headerlink" title="運算子(Operaors)"></a>運算子(Operaors)</h4><p>對變數或值進行操作的字元，例如：<code>a = b + 1</code>中的<code>=</code>和<code>+</code>。</p>
<p>JavaScript有以下幾種運算子。</p>
<ul>
<li><p>指定運算子(assignment)：其實就是等號運算子(<code>=</code>)來進行「指定」的工作，當計算完畢等號右邊的值後，接著將結果放進等號左邊的變數，這個戶進去的動作就是指定。例如：<code>a = b +1</code>，就是將<code>b + 1</code>的結果放到a。</p>
</li>
<li><p>算數運算子(math):進行加(<code>+</code>)減(<code>-</code>)乘(<code>*</code>)除(<code>/</code>)的運算，例如:<code>b + 1</code>。</p>
</li>
<li><p>複合指定運算子(compound assignment):<code>+=</code>、<code>-=</code>、<code>*=</code>和<code>/=</code>將算術運算子和指定運算子結合在一起，例如:<code>a += 1</code>, 等同於<code>a = a + 1</code>。</p>
</li>
<li><p>遞增運算子(increment&#x2F;decrement):<code>++</code>(遞增)與<code>--</code>(遞減),例如<code>a++</code>，等同於<code>a= a+1</code>。</p>
</li>
<li><p>物件特性的存取運算子(object property access:):利用<code>.</code>(點記號法，dot notation)或<code>[]</code>(方括號記號法，bracket notation)的方式存取物件的特性，例如:<code>obj.a</code>或<code>obj[&#39;a&#39;]</code> ，<code>.</code>因為簡單便利較常使用，但<code>[]</code>卻可在索引值是變數或有特殊字元時能保證完成值的存取，例如:<code>obj[]&#39;h e l l o&#39;</code>(有空白)、<code>obj[&#39;#$%^&amp;&#39;]</code>(特殊字元)、<code>obj[&#39;123&#39;]</code>(開頭為數字)。𠯌想了解命名規則，待變數命名的部分會再詳述。</p>
</li>
<li><p>相等性運算子(equality):可分為<code>==</code>(寬鬆相等)、<code>===</code>(嚴格相等)、<code>！=</code>(寬鬆不相等)、<code>!==</code>(嚴格不相等)，主要差異是做值的比較時是否會做強制轉型。</p>
</li>
<li><p>比較運算子(comparison):<code>&lt;</code>(小於)、<code>&gt;</code>(大於) 、<code>&lt;=(小於等於)</code>、<code>&gt;=(大於等於)</code>例如:<code>a &gt; b</code>表示比較a是否大於b。注意比較結果一定會是布林值。</p>
</li>
<li><p>邏輯運算子(logical):<code>&amp;&amp;</code>(and)、<code>||</code>(or)，例如:<code>a || b</code>表示選擇a或b，常用於表達複合條件，設定初始值。</p>
</li>
<li><p>位元運算子(bitwise):將運算元當成32位元的0和1來看待，位元運算子將運算元以二進位的方式處㻫，接著以JavaScript數字型態回傳結果。例如:<code>5 &amp; 1</code>會被看成<code>0101 &amp; 0001</code>，得到結果0001，回傳1。 <a href="https://www.w3schools.com/js/js_bitwise.asp">點此</a>看更多範例。</p>
</li>
<li><p>字串運算子(string)：<code>+</code>可串接兩字元，並回傳結果，通常用連接變數與字串。不過目前改用ES6的字串模板(string template)了，使用<code>$&#123; variable_name&#125;</code>即可代入變數，而不需再用<code>+</code>與雙&#x2F;單引號拼湊字串，方便許多，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> name = <span class="string">&#x27;Summer&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用字串運算子</span></span><br><span class="line"><span class="keyword">const</span> greetings_1 = <span class="string">&#x27;Hello &#x27;</span> + name + <span class="string">&#x27;!&#x27;</span>; <span class="comment">// &quot;Hello Summer!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用字串模板</span></span><br><span class="line"><span class="keyword">const</span> greetings_2 = <span class="string">`Hello <span class="subst">$&#123;name&#125;</span>!`</span>; <span class="comment">// &quot;Hello Summer!&quot;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>條件(三元)運算子(conditional&#x2F;ternary):條件(三元)運算子接再兩個運算元作為值且一個運算元作為條件。語法是<code>條件?值1：值2</code>。若「條件」為true，運算子回值「值1」,否則回傳「值2」。如下，條件<code>count &lt;= 0</code>得到false, 因此得到prompt為還有存貨」。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> prompt = count &lt;= <span class="number">0</span> ? <span class="string">&#x27;全部賣完了&#x27;</span> : <span class="string">&#x27;還有存貨&#x27;</span>;</span><br><span class="line"></span><br><span class="line">prompt <span class="comment">// &quot;還有存貨&quot;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>逗點運算子(comma):<code>,</code>用來隔開多個運算式並由左至右循序執行，最後會回傳最右邊的運算式的結果，通常用於(1)for迴圈內部，讓多個變數能在每次迴圈中被更新;(2)變數宣告。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>, j = <span class="number">10</span>; i &lt; j; i++, j--) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`i: <span class="subst">$&#123;i&#125;</span>, j: <span class="subst">$&#123;j&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// i: 0, j: 10</span></span><br><span class="line"><span class="comment">// i: 1, j: 9</span></span><br><span class="line"><span class="comment">// i: 2, j: 8</span></span><br><span class="line"><span class="comment">// i: 3, j: 7</span></span><br><span class="line"><span class="comment">// i: 4, j: 6</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>一元運算子(unary):一元運算是只需要一個運算元的運算，例如:delete 運算子可刪除(隱式宣告的)物件，物件的(非內建)屬性或陣列中經由指定索引而找到的物件。其他的一元運算子還有typeof等。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> x = <span class="number">1</span>;</span><br><span class="line">y = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> product = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;apple&#x27;</span>,</span><br><span class="line">  <span class="attr">count</span>: <span class="number">100</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> x <span class="comment">// false</span></span><br><span class="line">x <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> y <span class="comment">// true</span></span><br><span class="line">y <span class="comment">// Uncaught ReferenceError: y is not defined</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> product.<span class="property">count</span> <span class="comment">// true</span></span><br><span class="line">product <span class="comment">// &#123;name: &quot;apple&quot;&#125;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>關係運算子(relational)：關係運算子比較兩運算元並根據比較結果回傳布林值。例如：in運算子可得知特定屬性是否存在於物件中，instanceof可用來判斷是否為指定的物件型別。</p>
<p>in 運算子的範例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> product = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;apple&#x27;</span>,</span><br><span class="line">  <span class="attr">count</span>: <span class="number">100</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;name&#x27;</span> <span class="keyword">in</span> product <span class="comment">// true</span></span><br><span class="line"><span class="string">&#x27;valid&#x27;</span> <span class="keyword">in</span> product <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>instanceof運算子的範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">product <span class="keyword">instanceof</span> <span class="title class_">Object</span> <span class="comment">// true</span></span><br><span class="line">product <span class="keyword">instanceof</span> <span class="title class_">Array</span> <span class="comment">// false</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="運算式-Expression"><a href="#運算式-Expression" class="headerlink" title="運算式(Expression)"></a>運算式(Expression)</h4><p>  對「某個變數或值，或以運算子結合起來的一組變數或值」的參考(reference)。例如:<code>a = b+1</code>這個述句中有四個運算式，分別是1、b、<code>b +1</code>、<code>a = b + 1</code>，其中1是字面值運算式(literal value expression)、b是變數運算式(variable expression)用來取得變數的值、<code>b + 1</code>是算術運算式(arithmetic expression)用來進行加法運算，<code>a = b + 1</code>是指定遲算式(assignment expression)用來將結果指定給變數存起來。這裡順道一提「呼叫運算式（call expression）」，意即函式呼叫運算式本身，例如：<code>alert(a)</code></p>
<h4 id="值與型別-Values-Types"><a href="#值與型別-Values-Types" class="headerlink" title="值與型別(Values&amp;Types)"></a>值與型別(Values&amp;Types)</h4><p>型別，指的是「值的不同的表示法」，主要分為兩種「基本型別」(pirmitives, 即number、string、boolean、null、undefined、symbol)和「物件型別」(object)。</p>
<h5 id="基本型別-Primitive-Types"><a href="#基本型別-Primitive-Types" class="headerlink" title="基本型別(Primitive Types)"></a>基本型別(Primitive Types)</h5><ul>
<li><p>number 數字，例如：12345。</p>
</li>
<li><p>string 字串，例如:<code>Hello World</code></p>
</li>
<li><p>boolean 布林，例如：true、false。</p>
</li>
<li><p>null</p>
</li>
<li><p>undefined</p>
</li>
<li><p>symbol</p>
</li>
</ul>
<h5 id="物件型別"><a href="#物件型別" class="headerlink" title="物件型別"></a>物件型別</h5><p>除了基本型別外的資料型別都是物件，物件型別又分以下子型別</p>
<ul>
<li><p>array 陣列：使用數值化索引來儲存值，而非如物件是使用屬性來儲存值。</p>
</li>
<li><p>function函式：一個函式是指一段具名的程式碼片段，我們可藉由呼叫其名稱來執行它，可簡化重複進行的工作會包裝特定功能的程式碼，並且函式可接受參數、回傳值。這裡會牽涉到另一個概念「範疇（Scope）」，範疇是指一群變數或這些變數如何透過名稱來存取的規範而組成的一個集合，關於範疇之後會再詳述。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">sayHi</span>(<span class="string">&quot;Jack&quot;</span>);<span class="comment">// Hi, I am Jack</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>date 日期</p>
</li>
</ul>
<h5 id="在型別之間進行轉換-Converting-Between-Types"><a href="#在型別之間進行轉換-Converting-Between-Types" class="headerlink" title="在型別之間進行轉換(Converting Between Types)"></a>在型別之間進行轉換(Converting Between Types)</h5><p>我們有時候會需要將資料在不同型別間轉換，例如，遇到在表單中輸入一連串的金額(此時是字串)，接著計算金額時就會希望將這些字串轉成數字來做加減乘除的操作，這時候就可能需要做轉型，從字串轉成數字。</p>
<p>例如、小明在蝦X買了一件商品準備在母親節送給媽媽，並選擇貨到付款。來看看商品金額、運費和總金額，商品金額(product)是100(以定串型態存在)，運費(shipment)也同樣是100(以數字型態存在)，𫍇時候總金額total是？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> product = <span class="string">&quot;100&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> shipment = <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p>咦？怎麼會正100100！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> total = product + shipment;</span><br></pre></td></tr></table></figure>

<p>原來是因為若兩值資料型別不同，當其中一方是字串，<code>+</code>所代表的就是字串運算子，而將數字強制轉型為字串，並連接兩個字串。解決就是使用Number強制轉型(coerce)，將字串的部份轉為數字就可以做數學運算了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> product = <span class="string">&quot;100&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> shipment = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">const</span> total = <span class="title class_">Number</span>(product) + shipment;<span class="comment">//200</span></span><br></pre></td></tr></table></figure>

<p>除了強制轉型，來看在比較兩個非相同型別的值時候會發生隱含的(implicit)轉型。</p>
<p>例如，小明想要比較買這個商品付這運費划算嗎？運費該不會比商品還貴吧？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> product = <span class="string">&quot;100&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> shipment = <span class="number">100</span>;</span><br><span class="line">product === shipment <span class="comment">// false</span></span><br><span class="line">product == shipment <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>咦？一個是字串，一個是數字，是怎麼能做比較？這是由於JavaScript偷偷做了(隱含的)轉型的原因，那…到底做了什麼呢?</p>
<ul>
<li><p><code>product === shipment</code> : 不做轉型，因此型別對比較是有影響的。</p>
</li>
<li><p><code>product == shipment</code> : 會強轉型，規則是(1)布林轉數字；(2)字串轉數字；(3)使用<code>valueOf()</code>將物件取 基本型別的值，再做比較。關於強型轉型的詳細說明之後會再詳述或參考<a href="http://www.ecma-international.org/ecma-262/5.1/#sec-11.9.3">規格</a>。</p>
<p>小明看到商品價格與運費居然相等，還是先湊個免運再買吧！</p>
</li>
</ul>
<h5 id="typeof"><a href="#typeof" class="headerlink" title="typeof"></a>typeof</h5><p>typeof 可用於檢測值的型別是什麼。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="string">&quot;Hello World&quot;</span>);<span class="comment">// string</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">true</span>);<span class="comment">// boolean</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="number">12345678</span>);<span class="comment">// number</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">null</span>);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">undefined</span>);<span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> &#123; <span class="attr">name</span>: <span class="string">&quot;jack&quot;</span> &#125;);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">Symbol</span>());<span class="comment">// symbol</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;);<span class="comment">// function</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);<span class="comment">// objcet</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">NaN</span>);<span class="comment">// number</span></span><br></pre></td></tr></table></figure>

<p>這裡會看到幾個有趣的(奇怪的)地方…</p>
<ul>
<li><p>null 是基本型別之一，但<code>typeof null</code>卻得到object,而非null!這可說是一個bug，可是若因為修正了這個bug，則可能會導致很多網站壞掉，因此就不修了！</p>
</li>
<li><p>雖然說function是物件的子型別，但<code>typeof functon()&#123;&#125;</code>是得到function而非object, 和陣列依舊得到object是不一樣的。</p>
</li>
<li><p>NaN表是是無效的數字，但依舊還是數字，因此在資料型別的檢測<code>typeof NaN</code>結果就是number。不要被字面上的意思「不是數字」(not a number)給弄糊塗了。另外，NaN與依何數字運算都會得到NaN，並且NaN不大於，不小於也不等於任何數字，包含NaN它自已。</p>
</li>
</ul>
<h5 id="內建方法-Built-In-Type-Methods"><a href="#內建方法-Built-In-Type-Methods" class="headerlink" title="內建方法(Built-In Type Methods)"></a>內建方法(Built-In Type Methods)</h5><p>意即物件以屬性(或稱方法)的形式對外提供的行為，例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> prompt = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(prompt.<span class="property">length</span>);<span class="comment">//11</span></span><br></pre></td></tr></table></figure>

<p>  這背後的原因是每個型基本上都會其物件包裏器(object wrapper,又稱原生natives)的型態做對應使用，例如資料別string的物件包裹器型態就是String，而就是這個包裹器型態在其原型(prototype)上定義了許多屬性和方法，因此這些資料型態就能和物件般擁有屬性和方法以供使用。</p>
<h5 id="相等性與不等性"><a href="#相等性與不等性" class="headerlink" title="相等性與不等性"></a>相等性與不等性</h5><h6 id="相等性-Equality"><a href="#相等性-Equality" class="headerlink" title="相等性(Equality)"></a>相等性(Equality)</h6><p>關於相等性的運算子有四個「<code>==</code>」(寬鬆相等性loose equality)、「<code>===</code>」(嚴格相等性strict equality) 、「<code>!=</code>」和「<code>!==</code>」。寬鬆與嚴格的差異在於檢查值相等時是否會做強制轉型，<code>==</code>會做強制轉型，而<code>===</code>不會。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a =<span class="string">&#x27;100&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a == b);<span class="comment">// true 強制轉型，將字串 &#x27;100&#x27; 轉為數字 100</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a ===b);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>另外，關於值的儲存方式有傳值「pass by value」和傳址&#x2F;參考「pass by referece」兩種，其中pass by value又可再細分是否為「pass by sharing」（可參考<a href="https://blog.techbridge.cc/2018/06/23/javascript-call-by-value-or-reference/">這篇</a>）、基本型別是值，而物件型別是傳址。當比較兩物件時，比較的是儲存的位置，因此看起來是相同的物件，但比較結果卻是不相同的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">const</span> b = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a == b);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a === b);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<h6 id="不等性-Inequality"><a href="#不等性-Inequality" class="headerlink" title="不等性(Inequality)"></a>不等性(Inequality)</h6><p>關於不等於性的比較運算子有<code>&gt;</code>、<code>&lt;</code>、<code>&gt;=</code>、<code>&lt;=</code>共四種，在這裡有幾種狀況需要注意</p>
<ul>
<li><p>若比較的值都是字串，則以字典的字母順序為主。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ab&quot;</span> &lt; <span class="string">&quot;cd&quot;</span>);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>若比較的值型別不同，由於值的不等性比較沒有嚴格不相等這重性況，因此，為論什麼樣的比較都會被強制轉型為數字，無法轉為數字的就會變成NaN。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;99&quot;</span> &gt; <span class="number">98</span>);<span class="comment">//true, 字串&quot;99&quot;被強昀轉型為數字 99</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello World&quot;</span> &gt; <span class="number">1</span>);<span class="comment">//false 字串&quot;Hello World&quot; 無法轉為數字，變成NaN</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello World&quot;</span> &lt; <span class="number">1</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello World&quot;</span> = <span class="number">1</span>);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>NaN不大於、不小於、不等於任何值，當然也不等於自已。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">NaN</span> &gt; <span class="title class_">NaN</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">NaN</span> &lt; <span class="title class_">NaN</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">NaN</span> === <span class="title class_">NaN</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">NaN</span> == <span class="title class_">NaN</span>);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<h4 id="程式碼註解-code-Comments"><a href="#程式碼註解-code-Comments" class="headerlink" title="程式碼註解(code Comments)"></a>程式碼註解(code Comments)</h4><p><code>//</code>和<code>/*...*/</code>。</p>
<p>程式碼註解有多重要就不用再提了吧！</p>
</li>
</ul>
<h4 id="變數-Variables"><a href="#變數-Variables" class="headerlink" title="變數(Variables)"></a>變數(Variables)</h4><p>變數是儲存值的地方，又稱為符號佔位器(symbolic placeholder),例如：<code>a = b + 1</code>中的a和b。變數的作用是「管理程式的狀態」，讓我們能將程式中各種會變動的狀態(也就是值)存起來並搭配運算子組成運算式做一些運算。注意，JavaScript是弱型別的語言，意即宣告變數，賦值後仍可改變值的資料型別。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用 var 宣告一個物件</span></span><br><span class="line"><span class="keyword">var</span> product = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;apple&#x27;</span>,</span><br><span class="line">  <span class="attr">count</span>: <span class="number">100</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用 let 宣告一個有作用域限制的變數，範圍限於大括號內</span></span><br><span class="line"><span class="keyword">let</span> name = <span class="string">&#x27;Nina&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="常數-Constants"><a href="#常數-Constants" class="headerlink" title="常數(Constants)"></a>常數(Constants)</h4><p>ES6使用<code>const</code>來宣告常數，代表這變數的值不會改變，在嚴格模式下還會報錯。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onst <span class="variable constant_">PI</span> = <span class="number">3.14</span>;</span><br></pre></td></tr></table></figure>

<h4 id="命名規則"><a href="#命名規則" class="headerlink" title="命名規則"></a>命名規則</h4><p>變數的命名必須要為有效的識別字，何謂有效？就是必須以a-z、A-Z、<code>$</code>(錢字號)或<code>_</code>(底線)開頭，之後可加上a-z、A-Z、<code>$</code>(錢字號)、<code>_</code>(底線)和數字0-9，並且不可以是關鍵字或保留字。變數的命名規則同樣也適用於物件特性的命名，只是物件特性的名稱可為關鍵字或保留字。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> happy = <span class="string">&#x27;happy&#x27;</span>; <span class="comment">// 這是合法的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> @@ = <span class="string">&#x27;sad&#x27;</span>; <span class="comment">// 這是不合法的，報錯「Uncaught SyntaxError: Invalid or unexpected token」</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="comment">// 這是合法的，物件的特性可使用關鍵字或保留字命名</span></span><br><span class="line">  <span class="attr">this</span>: <span class="string">&#x27;this is an object&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="什麼是關鍵字？又什麼是保留字"><a href="#什麼是關鍵字？又什麼是保留字" class="headerlink" title="什麼是關鍵字？又什麼是保留字"></a>什麼是關鍵字？又什麼是保留字</h5><p>「<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Lexical_grammar#Reserved_keywords_as_of_ECMAScript_2015">關鍵字</a>」（keyword）是指在目前ECMAScript中有特定用途的英文字詞，而「<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Lexical_grammar#Future_reserved_keywords">保留字</a>」（reserved word）則是系統留爭，雖然目前尚未用到但未來可能有其他用途的字彙。<strong>再次強調，不管是關鍵字或保留字都不能做變數名稱使用。</strong></p>
<h4 id="區塊-Blocks"><a href="#區塊-Blocks" class="headerlink" title="區塊(Blocks)"></a>區塊(Blocks)</h4><p>區塊是由一對大括號(curly-brace pair、<code>&#123;...&#125;</code>)所規範出來的範圍。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (count &gt; <span class="number">10</span>) &#123;</span><br><span class="line">  <span class="comment">// 區塊範圍在此...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="條件式-Conditionals"><a href="#條件式-Conditionals" class="headerlink" title="條件式(Conditionals)"></a>條件式(Conditionals)</h4><p>表達條件的𤆧法有if述句、switch述句、條件(三元)運算子和迴圈，以下分別述之。</p>
<ul>
<li><p>if述句，括號內的即是條件，若條件為真，則有指定的事情，括號內的條件放置運算式，運算結果是布林值true或false，若非布林值就會強制轉型(例如：0或空字串會被轉為false, 而其他就會轉為true)。範例如下，若商品金額大於運費，就買； 否則就不買。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> product = <span class="string">&quot;100&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> shipment = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">const</span> total = <span class="title class_">Number</span>(product) + shipment; <span class="comment">//200</span></span><br><span class="line"><span class="keyword">if</span> (product &gt; shipment) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;But it !&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Do not buy it!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果得到「Do not buy it!」。</p>
</li>
<li><p>switch述句等同於if-else的縮寫，依靠break來決定是否要持續進行下一個case述句，若沒有break就會「落穿而過」。範例如下，這裡有一個檢測庫存的簡易範例，假設目前庫存數量為50，當庫存為0～2時提示要趕快進貨補庫存，庫存到達50時顯示庫存充裕，庫存到達100時提示貨品是不是賣不掉，其他狀況都顯示為運作正常。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="number">50</span>;</span><br><span class="line"><span class="keyword">switch</span> (count) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;快賣完了！趕快進貨！&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">50</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;庫存充裕&quot;</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">100</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;是不是賣不後！？&quot;</span>)</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;運作正常&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但出乎意料的是，結果印出「庫存充裕、是不是賣不掉了！？、運作正常」</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">庫存充裕</span><br><span class="line">是不是賣不掉了！？</span><br><span class="line">運作正常</span><br></pre></td></tr></table></figure>

<p>這是因為如果沒有加入break，一豆某個符合條件了，托下來的case無論侜合與否都會被執行，也就是剛才所提到的「落穿而過」。</p>
<p>加入break修正一下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="number">50</span>;</span><br><span class="line"><span class="keyword">switch</span> (count) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;快賣完了！趕快進貨！&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">50</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;庫存充裕&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">100</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;是不是賣不後！？&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;運作正常&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果印出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">庫存充裕</span><br></pre></td></tr></table></figure>

<ul>
<li>條件(三元)運算子(conditional&#x2F;ternary)</li>
<li>迴圈(loops)使用條件式來判斷迴圈是否繼續或停止。</li>
</ul>
</li>
</ul>
<h4 id="Truthy-Falsy"><a href="#Truthy-Falsy" class="headerlink" title="Truthy &amp; Falsy"></a>Truthy &amp; Falsy</h4><p>在JavaScript中會被轉為false的值有</p>
<ul>
<li><p><code>&quot;&quot;</code>空字串</p>
</li>
<li><p>0,-0,NaN</p>
</li>
<li><p>null</p>
</li>
<li><p>undefined</p>
</li>
<li><p>false</p>
<p>而除了以上之外，都會被轉為true舉例如下</p>
</li>
<li><p><code>Hello World</code>非空字串</p>
</li>
<li><p>42非零的效數字</p>
</li>
<li><p><code>[],[1, 2, 3]</code>陣列，不管是不是空的</p>
</li>
<li><p><code>&#123;&#125;,&#123; name: &#39;Jack&#39;&#125;</code>物件，不管是不是空的</p>
</li>
<li><p><code>function foo()&#123;&#125;</code>函式</p>
</li>
<li><p>true</p>
<p>如果真的很不確定到底會轉成什麼，可以使用<code>!!</code>做測試</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">!![] <span class="comment">// true</span></span><br><span class="line">!!&#123;&#125; <span class="comment">// true</span></span><br><span class="line">!!<span class="title class_">NaN</span> <span class="comment">// false</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="迴圈-Loops"><a href="#迴圈-Loops" class="headerlink" title="迴圈(Loops)"></a>迴圈(Loops)</h4><p>重複一組動作，直到檢測條件不成立為止。迴圈的形成有很多動，最常用的就是while迴圈(while或do…while)和fot迴圈兩種。</p>
<h5 id="while迴圈"><a href="#while迴圈" class="headerlink" title="while迴圈"></a>while迴圈</h5><p>while迴圈的構成有以下要素：測試條件和區塊，而每次執行區塊時就稱為一次迭代(iteration)。</p>
<p><code>while</code>vs<code>do...while</code></p>
<p>兩者的差異在於<code>while</code>是先測後跑，而<code>do...while</code>是先跑後測。</p>
<p>來看第一個簡單例子，假設商品數量目前有五個，每賣掉一個就將庫存減一，當全賣完(及庫存為零)的時候就跳出迴圈，並印出「全部賣完了」的訊息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> product = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">while</span> (product &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    product--;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">買一個 </span><br><span class="line">現在還剩 4個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 3個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 2個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 1個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 0個。 </span><br><span class="line">全部賣完了 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但下面這個例子就超有不同了，此時更改商品數量為零，剛剛提到while是「先測後跑」，因此當檢驗測試條件時，發現<code>product &gt; 0</code>得到fals,也就不會進入區塊了，直接印出「全部賣完了」的訊息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> product = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (product &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    product--;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>再來看<code>while...loop</code>，這個例子並無異狀，跟第一個例子所得到的結果完全相同。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> product = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    product--;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line">&#125; <span class="keyword">while</span> (product &gt; <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">買一個 </span><br><span class="line">現在還剩 4個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 3個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 2個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 1個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 0個。 </span><br><span class="line">全部賣完了 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是…剛剛提到<code>while...loop</code>是「先跑後測」，我們又將商品數量改為零，此時會先進入區塊，依序印出「買一個」、商品數量減一、顯示「現在還剩-1個」、最後才檢驗測試條件、終止迴圈的執行，印出「全部賣完了」的訊息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> product = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    product--;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line">&#125; <span class="keyword">while</span> (product &gt; <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">買一個 </span><br><span class="line">現在還剩 -1個。 </span><br><span class="line">全部賣完了 </span><br></pre></td></tr></table></figure>

<h5 id="break"><a href="#break" class="headerlink" title="break"></a>break</h5><p>使用break跳出迴圈。</p>
<p>範例如下，在product為2的時候跳出迴圈。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> product = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">while</span> (product &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    product--;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (product === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;停停停，不要賣了！快進貨啊。&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">買一個 </span><br><span class="line">現在還剩 4個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 3個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 2個。 </span><br><span class="line">停停停，不要賣了！快進貨啊。 </span><br><span class="line">全部賣完了 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="continue"><a href="#continue" class="headerlink" title="continue"></a>continue</h5><p>使用continue跳過本次迭代，迴圈依舊持續進行。</p>
<p>範例如下，在product為2的成候忽略之後要執行的<code>console.log(現在還剩 $&#123;product&#125; 個);</code>直接進入下一次迭代。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> product = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">while</span> (product &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    product--;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (product === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;第二個我要暗摃起來&quot;</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">買一個 </span><br><span class="line">現在還剩 4個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 3個。 </span><br><span class="line">買一個 </span><br><span class="line">第二個我要暗摃起來 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 1個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 0個。 </span><br><span class="line">全部賣完了 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="for迴圈"><a href="#for迴圈" class="headerlink" title="for迴圈"></a>for迴圈</h5><p>for迴圈有三個子句-初始化子句、條件測試子句、更新子句。</p>
<ul>
<li><p>初始化子句，例如：<code>let product = 5</code></p>
</li>
<li><p>條件測件子句，例如：<code>product &gt; 0</code></p>
</li>
<li><p>更新子句，例如:<code>product--</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> product = <span class="number">5</span>; product &gt; <span class="number">0</span>; product--) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;買一個&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`現在還剩 <span class="subst">$&#123;product&#125;</span>個。`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;全部賣完了&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">買一個 </span><br><span class="line">現在還剩 5個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 4個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 3個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 2個。 </span><br><span class="line">買一個 </span><br><span class="line">現在還剩 1個。 </span><br><span class="line">全部賣完了 </span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="你懂JavaScript嗎？-變數、嚴格模式、IIFEs、閉包、模組、this、原型、Polyfill與Transpiler"><a href="#你懂JavaScript嗎？-變數、嚴格模式、IIFEs、閉包、模組、this、原型、Polyfill與Transpiler" class="headerlink" title="你懂JavaScript嗎？-變數、嚴格模式、IIFEs、閉包、模組、this、原型、Polyfill與Transpiler"></a>你懂JavaScript嗎？-變數、嚴格模式、IIFEs、閉包、模組、this、原型、Polyfill與Transpiler</h3><p>上面有大致聊過了一些基本普識，像是運算子、運算式、值與型別、變數、條件式、迴圈，本文還會再探討一些基礎概念，像是</p>
<ul>
<li><p><a href="#%E8%AE%8A%E6%95%B8(Variable)">變數</a>的存取規則，包含函式範疇、拉升、巢狀範疇。</p>
</li>
<li><p>嚴格模式：一個讓程式碼變得更，更容易優化的方法。</p>
</li>
<li><p>更多關於範疇和函式的應用，包含IIFE、閉包、模組</p>
</li>
<li><p>this：到底是指哪個？這個還是那個？應該不少人都黑人問號</p>
</li>
<li><p>原型可說是物件的一種fallback機制，並且提供了行為委派。</p>
</li>
<li><p>舊功能與新特色的共存，可使用Polyfill和Transpiler來做兼容。</p>
</li>
</ul>
<h4 id="變數-Variable"><a href="#變數-Variable" class="headerlink" title="變數(Variable)"></a>變數(Variable)</h4><p>這個部份要來談關於變數的存取規則，例如：範疇、拉升等。</p>
<h5 id="函式範疇-Function-Scope"><a href="#函式範疇-Function-Scope" class="headerlink" title="函式範疇(Function Scope)"></a>函式範疇(Function Scope)</h5><p>函式會建立自已的範疇，其內的識別字(不管是變數、函式)僅能在這個函式裡面使用。如下在全域範疇底下，是無法存取foo內的a、b、c和bar，否則會導致ReferrenceError；但在foo自已的函式範疇內，可以存取a、b、c和bar。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> c = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// ReferrenceError</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b); <span class="comment">// ReferrenceError</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c); <span class="comment">// ReferrenceError</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">bar</span>(); <span class="comment">// ReferrenceError</span></span><br></pre></td></tr></table></figure>

<h5 id="拉升-Hoisting"><a href="#拉升-Hoisting" class="headerlink" title="拉升(Hoisting)"></a>拉升(Hoisting)</h5><p>在程式執行前，編譯器(compiler)會先由上到下逐行將程式碼轉為電腦可懂的命令，然後再執行編譯後的指令。在這個編譯的階段，編譯器找出所有的變數並繫結所屬範疇，但不賦，所以此刻變數所帶的值是undefined; 而在執行階段，JavaScript引擎才會處理給值的事情。</p>
<p>我們可以把這個過程想像成是嫄這些變數「提升」到程式碼的最頂端，如下範例所示，因此當印出a的值的時候，會是已宣告但還沒賦值的狀態，也就是有這個變數，但其值是undefined，一直到程式執行了，才給值。因此，我們可以在程式碼任何地方呼叫運用這變數，但只有在正式宣告之後才能有正確的值可用，在宣告之前使用都會得到undefined。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a; <span class="comment">// 編譯時期的工作</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// undefined</span></span><br><span class="line">a = <span class="number">2</span>; <span class="comment">// 執行時期的工作</span></span><br></pre></td></tr></table></figure>

<h5 id="巢狀範疇-Nested-Scope"><a href="#巢狀範疇-Nested-Scope" class="headerlink" title="巢狀範疇(Nested Scope)"></a>巢狀範疇(Nested Scope)</h5><p>若在目前執行的範疇找不到這個變數的時候，就會往外層的範疇搜尋，特續搜尋直到找到為止，或直到最外層的全域範疇(globl scope，在瀏覽器底下就是指window)。</p>
<p>如下<code>console.log(a + b)</code>中，b無法在foo中找到，但可從全域範疇中追出來。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">foo</span> = (<span class="params">a</span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a + b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(<span class="number">2</span>); <span class="comment">// 4</span></span><br></pre></td></tr></table></figure>

<p>相較於巢狀範疇是以函式為劃分單位，區塊範疇就是以大括號為界線了。</p>
<h4 id="嚴格模式-Strict-Mode"><a href="#嚴格模式-Strict-Mode" class="headerlink" title="嚴格模式(Strict Mode)"></a>嚴格模式(Strict Mode)</h4><p>嚴格 鄉簡單說就是為了預防開發者的一些小心或錯誤的行為，JavaScript引擎協助做了一些檢測的工作，當開發都誤用時就把錯誤丟出來。可參考<a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Strict_mode">MDN</a>。</p>
<p>範例如下，在未宣告變數而賦值機狀況下，會無預警的產生一個全域變數，但若使用嚴格模式(<code>use strict</code>)則會禁止這行為外，還會報錯，告知開發都變數尚未被定義。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;user stict&#x27;</span>;</span><br><span class="line">a = <span class="number">1</span>; <span class="comment">//Uncaught ReferenceRrrot: a is not defined</span></span><br></pre></td></tr></table></figure>

<p>就把它想像成是一個諄教誨的好者師！總是願意告訴你殘忍的實話…</p>
<h4 id="作為值的函式-Function-as-Value"><a href="#作為值的函式-Function-as-Value" class="headerlink" title="作為值的函式(Function as Value)"></a>作為值的函式(Function as Value)</h4><p>這標題看起來有點怪怪的(?)但其實也只是要說明，函式本身就和其化的值一樣，是可以被指定給某變數、當參數傳遞或當成其它函式的回傳值。記得，函式也只是物件的子型別而已， 沒有什麼特別的。</p>
<p>指定給某個變數，如下，指定給foo。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;大家好，我是 foo!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>當參數傳遞，如下，將foo當成是bar的參數傳入。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;大家好，我是 foo!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params">func</span>) &#123;</span><br><span class="line">    <span class="title function_">func</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bar</span>(foo);<span class="comment">// 大家好，我是 foo!</span></span><br></pre></td></tr></table></figure>

<p>當其他函式的回傳值，foo是baz的回值，並將結果指定給result。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;大家好，我是 foo!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = <span class="keyword">function</span> <span class="title function_">baz</span>(<span class="params">func</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> func;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">result</span>(foo)();<span class="comment">// 大家好，我是 foo！</span></span><br></pre></td></tr></table></figure>

<p>因此，這個函式值(例如：<code>var foo=function()&#123;...&#125;</code>)也可被視為是一個運算式，就稱呼它為「函式運算式」吧。之後還會提到函式宣告、函式運算式與匿名vs具名，待後續詳細的說明。</p>
<h4 id="即刻調用函式運算式-Immediately-Invoked-Function-Expression-IIFE"><a href="#即刻調用函式運算式-Immediately-Invoked-Function-Expression-IIFE" class="headerlink" title="即刻調用函式運算式(Immediately Invoked Function Expression,IIFE)"></a>即刻調用函式運算式(Immediately Invoked Function Expression,IIFE)</h4><p>IIFE是為可立即執行的函式運算式。一般的函式運算式並不會馬上執行、若要執行除了在其名稱後加上小括號外，還可以利用IIFE的𤆧式執行它。匿名或具名皆合法。使用IIFE的好處主要是不污染全域範疇。</p>
<p>範例如下，這是一個匿名的IIFE，a在全域範疇是找不到的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a=<span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">//</span></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不污染全域範疇</span></span><br><span class="line">a;<span class="comment">//Uncaught ReferenceError:a is not defined</span></span><br></pre></td></tr></table></figure>

<h4 id="閉包-Closure"><a href="#閉包-Closure" class="headerlink" title="閉包(Closure)"></a>閉包(Closure)</h4><p>閉包是指變數的生命週其只存在於該函式內，一旦離開了函式，該變數就會被回收而不可再利用，且必須在函式內事先宣告。</p>
<p>範例如下，在函式closure內可以存取a的值，但離開了函式closure走到全域範疇之下，就取不到a的值了，因此會被報錯「Uncaught ReferenceError:a is nto defined」。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">closure</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a=<span class="number">1</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// 1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">closure</span>();</span><br><span class="line">a;<span class="comment">// Uncaught ReferenceError: a is not defined</span></span><br></pre></td></tr></table></figure>

<h4 id="模組-Module"><a href="#模組-Module" class="headerlink" title="模組(Module)"></a>模組(Module)</h4><p>模組模式(Module Pattern)又稱為揭露模組(RevealingModule),經由建立一個模組實體(Moduel Instance，如下範例的foo), 來調用內層函式。而內層函式由於具有閉包的特性。因此可存取外層包含函式(Oute Enclosing Function)之內的變數和函式。透過模組模式，可隱藏私密的資訊，並對外公開API。</p>
<p>範例如下，CoolModule對外公開API doSomething和doAnother, CoolModule之外是無法取得其私有的something𢘊another兩個變數的值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">CoolModule</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> something = <span class="string">&quot;cool&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> another = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(something);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doAnother</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(another.<span class="title function_">join</span>(<span class="string">&quot; ! &quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">doSomething</span>: doSomething,</span><br><span class="line">        <span class="attr">doAnother</span>: doAnother</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = <span class="title class_">CoolModule</span>();</span><br><span class="line">foo.<span class="title function_">doSomething</span>();<span class="comment">// cool</span></span><br><span class="line">foo.<span class="title function_">doAnother</span>();</span><br></pre></td></tr></table></figure>

<h4 id="this識別字-this-Identifier"><a href="#this識別字-this-Identifier" class="headerlink" title="this識別字(this Identifier)"></a>this識別字(this Identifier)</h4><p>this到底是指向誰一直都是個令人費解的問題。</p>
<p>簡單來說，this是function執行時所屬的物件，而this是在執行時期做繫結，其值和函式在哪裡被呼叫(call-site)有關。</p>
<p>總結規則如下，並以匹配的優先順序由高至低排列</p>
<ul>
<li>new 綁定：this會指向new出來的物件。</li>
<li>明確綁定：使用call、apply、bind，明確指出要綁定給this的物件。</li>
<li>隱含綁定：當函式為物件的方法(method)時，在執行階段this就會被綁定至該物件。</li>
<li>預設綁定：當其他規則都適用時，意即沒有使用bind,call, apply或不屬於任何物件的method，就套用預設綁定，在非嚴格模式下，瀏覽器環境this的值就是預設值全域物件window，而在嚴格模式下，this的值就是undefined</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">bar</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bar = <span class="string">&#x27;global&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj1 = &#123;</span><br><span class="line">  <span class="attr">bar</span>: <span class="string">&#x27;obj1&#x27;</span>,</span><br><span class="line">  <span class="attr">foo</span>: foo</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj2 = &#123;</span><br><span class="line">  <span class="attr">bar</span>: <span class="string">&#x27;obj2&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(); <span class="comment">// &#x27;global&#x27;</span></span><br><span class="line">obj1.<span class="title function_">foo</span>(); <span class="comment">// &#x27;obj1&#x27;</span></span><br><span class="line">foo.<span class="title function_">call</span>( obj2 ); <span class="comment">// &#x27;obj2&#x27;</span></span><br><span class="line"><span class="keyword">new</span> <span class="title function_">foo</span>(); <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>

<h4 id="原型-Prototype"><a href="#原型-Prototype" class="headerlink" title="原型(Prototype)"></a>原型(Prototype)</h4><p>原型可說是物件的一種callback機制，當在此物件找不到指定屬性時，就會透過原型鏈結(prototype link&#x2F;prototype reference)追溯到其父物件上。範𠕥如下，若想存取<code>bar.a</code>但由於bar並為a屬性。因此𠺾會透過原型鏈結找到foo,並得偌100這個值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = &#123; <span class="attr">a</span>: <span class="number">100</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bar = <span class="title class_">Object</span>.<span class="title function_">create</span>(foo); <span class="comment">// 建立 bar 物件，並連結到 foo</span></span><br><span class="line">bar.<span class="property">b</span> = <span class="string">&#x27;hi&#x27;</span>;</span><br><span class="line"></span><br><span class="line">bar.<span class="property">a</span> <span class="comment">// 100，委派給 foo</span></span><br><span class="line">bar.<span class="property">b</span> <span class="comment">// &#x27;hi&#x27;</span></span><br></pre></td></tr></table></figure>

<p>另外，原型最常應用於「行為委派」(behaviro delegation)，如上例所示，將物件bar的行為委派給foo, 這也是常聽到很類似於其他語言的類別的繼承功能，但其實完全不同。</p>
<h4 id="舊功能與新特色的共存"><a href="#舊功能與新特色的共存" class="headerlink" title="舊功能與新特色的共存"></a>舊功能與新特色的共存</h4><p>面對新舊功能並存的狀況要怎麼處理呢？這裡要介紹兩種方法-Polyfill和Tranxpiler。</p>
<h5 id="Polyfill"><a href="#Polyfill" class="headerlink" title="Polyfill"></a>Polyfill</h5><p>Polyfilling的意思就是依據一個新功能的定義，製作具有相同行無，而能在較舊的JavaScript環境執行的程式碼，候話說就是為舊瀏覽掛載新功能。</p>
<p>這裡來看一個例子，針對isNan的改進…</p>
<h6 id="isNan"><a href="#isNan" class="headerlink" title="isNan"></a>isNan</h6><p>NaN表示值無效的數字，它會產生的原因是</p>
<ul>
<li><p>做數字運算時的兩個運算元的資料型別並非都數字或無法轉成有的十進位或十六進位的數字。</p>
</li>
<li><p>無意義的運算，例如:0&#x2F;0, Infinity&#x2F;Infinity。</p>
</li>
</ul>
<p>以上𣄵會產生NaN。</p>
<p>在ES6以前，開發者使用<code>isNaN</code>在數學運算或解析字串後檢測得到的結果是否為合法的數字，其實就是檢測是否為NaN，其過程為先將輸入值使用Number強制轉為數字。無法轉為有的數字而得到NaN時就判定等於NaN，結果得到true。</p>
<p>範例如下，空物件<code>&#123;&#125;</code>經過isNaN判斷是NaN，意即不為數字</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(&#123;&#125;));<span class="comment">//</span></span><br><span class="line"><span class="comment">// 拆宗詳細過程如下</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(&#123;&#125;)); <span class="comment">// 先將空物件轉為數字，得到NaN</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="title class_">NaN</span>)); <span class="comment">// 檢查是不否為 NaN，得到true</span></span><br></pre></td></tr></table></figure>

<p>其它範例還有..</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">isNaN</span>(<span class="number">123</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(-<span class="number">1.23</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="number">5</span>-<span class="number">2</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="number">0</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="string">&#x27;123&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="string">&#x27;Hello World&#x27;</span>) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="string">&#x27;2000/01/01&#x27;</span>) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="string">&#x27;&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="literal">true</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="literal">undefined</span>) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="string">&#x27;NaN&#x27;</span>) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="title class_">NaN</span>) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="number">0</span>/<span class="number">0</span>) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="number">1</span>/<span class="number">0</span>) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>但這檢測方式常常會讓開發者得到讓人容易誤解的結果(像是空物件<code>&#123;&#125;</code>就真的不等於NaN呀)，因此ES6推出了<code>Number.isNaN</code>，<code>Number.isNaN</code>不會經過轉為數字的這過程，而是直托判斷型別否為數字且是否等於NaN。承上範𠕥，檢測空物件<code>&#123;&#125;</code>是否為NaN，得到false</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(&#123;&#125;) <span class="comment">// 直接檢查空物件是否為 NaN，得到 false</span></span><br></pre></td></tr></table></figure>

<p>同樣也來看剛才的範例…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">123</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(-<span class="number">1.23</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">5</span>-<span class="number">2</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">0</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;123&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;Hello World&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;2000/01/01&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="literal">true</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="literal">undefined</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;NaN&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="title class_">NaN</span>) <span class="comment">// true</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">0</span>/<span class="number">0</span>) <span class="comment">// true</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">1</span>/<span class="number">0</span>) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>雖然ES6出了這個新功能，但不見得所有的瀏覽器都會支援，因此對於較舊瀏覽，就掛個polyfill來模擬這個新功能。</p>
<p>polyfill如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Number</span>.<span class="property">isNaN</span>) &#123;</span><br><span class="line">  <span class="title class_">Number</span>.<span class="property">isNaN</span> = <span class="keyword">function</span> <span class="title function_">isNaN</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x !== x; <span class="comment">// NaN 是唯一一個不等於自己的值</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ES6定義了常數<code>Number.NaN</code>來表示NaN</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">isNaN</span>(<span class="title class_">NaN</span>); <span class="comment">// true</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="title class_">Number</span>.<span class="property">NaN</span>); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="title class_">Number</span>.<span class="property">NaN</span>) <span class="comment">// true</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="title class_">NaN</span>) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>由於實作 polyfill 難免會有缺漏或疏失，這裡提供兩個經過嚴格審核的函式庫以供使用-<a href="https://github.com/es-shims/es5-shim">es5-shim</a> 和 <a href="https://github.com/es-shims/es6-shim">es6-shim</a>。</p>
<h6 id="Transpiler"><a href="#Transpiler" class="headerlink" title="Transpiler"></a>Transpiler</h6><p>並非所有的新功能都能經由polyfill掛載到舊環境上，這裡提出另一個解法，將帶有新功能的程式碼換成等效的舊有程式碼碼可以了，也就是使用transpiler做轉譯。</p>
<p>例如，ES6推出了新功能「預設參數值」。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a = <span class="number">2</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(); <span class="comment">// 2</span></span><br><span class="line"><span class="title function_">foo</span>(<span class="number">42</span>); <span class="comment">// 42</span></span><br></pre></td></tr></table></figure>

<p>但這在舊的JavaScript引擎中是無 的，因此transpiler就會將以上程式碼變形，翻譯成等 的舊程式碼。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="variable language_">arguments</span>[<span class="number">0</span>] !== (<span class="keyword">void</span> <span class="number">0</span>) ? <span class="variable language_">arguments</span>[<span class="number">0</span>] : <span class="number">2</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這麼做的好處是在開發階段開發者依然能享受新功能帶來的好處，但又能兼顧到新舊瀏覽器的狀況。這裡也推薦一些很棒的 transpiler，像是 <a href="https://babeljs.io/">Babel</a>、<a href="https://github.com/google/traceur-compiler">Traceur</a> 等。</p>
<h3 id="你懂JavaScript嗎-型別-Types"><a href="#你懂JavaScript嗎-型別-Types" class="headerlink" title="你懂JavaScript嗎?型別(Types)"></a>你懂JavaScript嗎?型別(Types)</h3><p>主要會談到</p>
<ul>
<li>何謂「型別」？內建型別有哪些？常見疑難雜症與解法</li>
<li>未定義(undefined) vs 未宣告(undeclared)</li>
</ul>
<h4 id="何謂「型別」？"><a href="#何謂「型別」？" class="headerlink" title="何謂「型別」？"></a>何謂「型別」？</h4><p>「型別」是固有的、內建的特微，能唯一識別特定值的行為。例如：數字123和字串’123’就是不一樣的，數字123可做數學運算處理，而字串’123’可能就是做些顯示到畫面上的操作。</p>
<h4 id="內建型別-Built-In-Types"><a href="#內建型別-Built-In-Types" class="headerlink" title="內建型別(Built-In Types)"></a>內建型別(Built-In Types)</h4><p>JavaScript定義了以下七種內建型別</p>
<ul>
<li><p>number數字，例如:12345</p>
</li>
<li><p>string字串，例如：<code>Hello World</code></p>
</li>
<li><p>boolean布林，例如:true、false</p>
</li>
<li><p>null</p>
</li>
<li><p>undefined</p>
</li>
<li><p>object物件，例如：<code>&#123; name: &#39;Jack&#39; &#125;</code>、<code>&#123;1, 2, 3&#125;</code>、<code>function foo() &#123; ... &#125;</code></p>
</li>
<li><p>symbol</p>
</li>
</ul>
<p>其中，這些內建型別又可分兩大類-基本型別(primitives)和物件型別(object)。基本型別有number、string、boolean、null、undefined、symbol，而物件型別就是物件與其子型別(subtype)，例如：物件、陣列、函式、日期等。</p>
<p>我們可用<code>typeof</code>來檢測值的資料型別為何。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="string">&#x27;Hello World&#x27;</span>);<span class="comment">//string</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">true</span>);<span class="comment">//boolean</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="number">12345678</span>);<span class="comment">//number</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">null</span>);<span class="comment">//object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">undefined</span>);<span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> &#123; <span class="attr">name</span>:<span class="string">&#x27;Jack&#x27;</span>&#125;);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">Symbol</span>()); <span class="comment">// symbol</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;);<span class="comment">// function</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">NaN</span>);<span class="comment">// number</span></span><br></pre></td></tr></table></figure>

<p>這裡會看到幾個有趣的(奇怪的)地方…</p>
<ul>
<li><p>null 是基本型別之一，但<code>typeof null</code>卻得到object，而非null！這可說是一個bug，可是若修正了這個bug則可能會導致很多網站壞掉，因此就不修了！</p>
</li>
<li><p>雖然說function是物件的子型別，但<code>typeof functon()&#123;&#125;</code>是得到function而非object，和陣列依舊得object是不一樣的。另外順道一提函式是一種「可呼叫的物件」(callable object),它擁有<code>[[Call]]</code>的內部特性，讓它成為能夠被調用的物件。</p>
</li>
<li><p>NaN表示是無效的數字，但依舊還是數字，因此在資料型別的檢測<code>typeof NaN</code>結果就是number，不要被字面上的意思「不是數字」(not a number)給弄糊塗了。另外、NaN與依何數字運算都會得到NaN、並且NaN不大於、不小於也不等於依何數字，包含NaN它自已。</p>
</li>
</ul>
<p>先來解決剛剛提到的幾個問題。</p>
<h4 id="Q1-如何檢測null？"><a href="#Q1-如何檢測null？" class="headerlink" title="Q1:如何檢測null？"></a>Q1:如何檢測null？</h4><p>之前有提到的Truthy&amp;Falsy的概念，在做比較時會被轉型為fals的值有</p>
<ul>
<li><p><code>&quot;&quot;</code>空字串</p>
</li>
<li><p>0，-0，NaN</p>
</li>
<li><p>null</p>
</li>
<li><p>undefined</p>
</li>
<li><p>false</p>
</li>
</ul>
<p>而除了以下之外，都會被轉無true,與例如下</p>
<ul>
<li><p><code>Hello World</code>非空字串</p>
</li>
<li><p>42非零的有效數字</p>
</li>
<li><p><code>[],[1, 2, 3]</code>陣列，不管是不是空的</p>
</li>
<li><p><code>&#123;&#125;,&#123;name:&#39;Jack&#39;&#125;</code>物件，不管是不是空的</p>
</li>
<li><p><code>function foo()&#123;&#125;</code>函式</p>
</li>
<li><p>true</p>
<p>我們可利用null會被typeof檢測為object並且會轉為false的結果來驗證是否為null.</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> happy = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (!happy &amp;&amp; <span class="keyword">typeof</span> happy === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;我是 null!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到「我是null !」，輕鬆解決，得分！</p>
<h4 id="Q2-既然函式與陣列都是物件，那其中的屬性length有什麼不同"><a href="#Q2-既然函式與陣列都是物件，那其中的屬性length有什麼不同" class="headerlink" title="Q2:既然函式與陣列都是物件，那其中的屬性length有什麼不同?"></a>Q2:既然函式與陣列都是物件，那其中的屬性length有什麼不同?</h4><p>函式的length是指參數個數，而陣列的length是指內部成員個數。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">testMe</span>(<span class="params">arg1, arg2, arg3</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;This is testMe!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(testMe.<span class="property">length</span>);<span class="comment">// 3</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list.<span class="property">length</span>);<span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<h4 id="Q3-typeof檢測的對象是誰"><a href="#Q3-typeof檢測的對象是誰" class="headerlink" title="Q3:typeof檢測的對象是誰?"></a>Q3:typeof檢測的對象是誰?</h4><p>再次強調，變數沒有型別，變數可在不同時間點持有不同型別的值，因此，只有「值」才有型別，雖然我們可用typeof檢測某個變數所儲存的值的型別，至記得並不是檢崱變數本身，而是變數所存的值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> name = <span class="string">&#x27;Jack&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> name <span class="comment">// &#x27;string&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Q4:辨識物件子型別的方法?</p>
<p>稍後在Natives(原生功能)的部分會說明取得物件內部分類的方法，這裡就先大略提一下。</p>
<p>物件型別的值其內部有一個<code>[[Class]]</code>屬性來標記這個值是屬於物件的哪個子分類，雖然無法直接取用，但可透過<code>Object.prototye.toString</code>間接取得，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])); <span class="comment">//[object Array]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span> &#125;));<span class="comment">//[object Object]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">function</span> <span class="title function_">SayHi</span>(<span class="params"></span>) &#123;&#125;));<span class="comment">//[objcet Function]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="regexp">/helloworld/i</span>));<span class="comment">//[object RegExp]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">new</span> <span class="title class_">Date</span>()));<span class="comment">//[object Date]</span></span><br></pre></td></tr></table></figure>

<h4 id="未定義-undefined-vs未宣告-uneclared"><a href="#未定義-undefined-vs未宣告-uneclared" class="headerlink" title="未定義(undefined)vs未宣告(uneclared)"></a>未定義(undefined)vs未宣告(uneclared)</h4><ul>
<li><p>未定義(undefined):未賦值的變數所儲存的值是undefined,對此變數做typeof也會得到<code>undefined</code></p>
</li>
<li><p>未宣告(undeclared):變數在未宣當並使用的狀況下會得到ReferenceError，並指出該變數並未宣告； 變數在未宣告並賦值的狀況下，在嚴格模式下會報錯ReferenceError，而在非嚴格模式，變數會成為全域變數的屬性。注意，對未宣告的變數做typeof也會得到<code>undefined</code>。</p>
</li>
</ul>
<p>總結𣄵是，無論變數是未定義或未宣告、typeof這兩種狀況皆會得到<code>undefined</code>。那麼，對未宣告的變數做typeof而得到<code>undefined</code>，有什麼用處呢?</p>
<h4 id="對未宣告的變數做typeof"><a href="#對未宣告的變數做typeof" class="headerlink" title="對未宣告的變數做typeof"></a>對未宣告的變數做typeof</h4><p>對未宣告的變數做typeof而得到<code>&#39;undefined&#39;</code>可說是一保護措施，可避免瀏覽器丟出ReferenceError的錯誤訊息，在撰寫測試特定條件時常會用到。</p>
<p>範例如下，我們可能在非正式環境下會引用了某支js檔案，其中會設定DEBUG為ture，而其它檔案會根據DEBUG變數是否被宣告並設定為true時做出相對應的事情。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable constant_">DEBUG</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">  <span class="comment">// start to debug...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或著，我們也可以不用typeof的作法，而改用檢測window屬性的方式，同樣也不會丟出ReferenceError。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">DEBUG</span>) &#123;</span><br><span class="line">  <span class="comment">// start to debug...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再或者，使用依存性注入(dependency injection)的方式也是可以的，將要檢測的條件當參數傳入函式，若條件不存在則使用預設值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">doSomethingCool</span>(<span class="params">DEBUG</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> helper = <span class="variable constant_">DEBUG</span> || <span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="comment">/* 預設值 */</span> &#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只是這解法已被ES6的預設傳入參數(Degault Paramaters)取代了。</p>
<h3 id="你懂JavaScript嗎？值-Values-Part1-陣列、字串、數字"><a href="#你懂JavaScript嗎？值-Values-Part1-陣列、字串、數字" class="headerlink" title="你懂JavaScript嗎？值(Values)Part1-陣列、字串、數字"></a>你懂JavaScript嗎？值(Values)Part1-陣列、字串、數字</h3><p>主要會談到關於陣列、字串、數字的錯誤操作方式與疑難雜症的解法。</p>
<h4 id="陣列-Array"><a href="#陣列-Array" class="headerlink" title="陣列(Array)"></a>陣列(Array)</h4><p>陣列是由數值做索引，可由任何型別值所構成的群集。在𫍇裡要先提到兩個容易誤用的重點-(1)稀疏陣列誤存undefined的元素和(2)使用「很像數字」的字串當成鍵值來存資料時，鍵值被強制轉型為數字的狀況，最後會提到「類陣列」的操作。</p>
<h5 id="稀疏陣列-Sparse-Array"><a href="#稀疏陣列-Sparse-Array" class="headerlink" title="稀疏陣列(Sparse Array)"></a>稀疏陣列(Sparse Array)</h5><p>稀疏陣列是指陣列中有插槽(slot)可能未定義其值或被略過而導致存放undefined元素的狀況，範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [];</span><br><span class="line">list[<span class="number">0</span>] = <span class="string">&#x27;Hello&#x27;</span>;</span><br><span class="line">list[<span class="number">2</span>] = <span class="string">&#x27;World&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list[<span class="number">1</span>]); <span class="comment">//undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list.<span class="property">length</span>) <span class="comment">//3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> numlist = [];</span><br><span class="line">numlist[<span class="number">0</span>] = <span class="number">123</span>;</span><br><span class="line">numlist[<span class="number">2</span>] = <span class="number">456</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(numlist[<span class="number">1</span>]); <span class="comment">//undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(numlist.<span class="property">length</span>);<span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>這會有什麼問題呢?</p>
<p>由於這可能是一些疏忽或鏌誤操作所造成的，因此會對length有錯誤的期待，例如，可能原本其待list的長度為2，但因錯置了字串<code>&#39;World&#39;</code>的位置，導致list的長度為3，存之後陣列的操作上可能會出現很難發現的<strong>bug</strong>。</p>
<p>這種<strong>bug</strong>就是所謂的<strong>地雷</strong>，你永遠不知道它什麼時候會爆炸，一旦爆炸就死傷慘動、很難挽救。</p>
<h5 id="鍵值的強制轉型"><a href="#鍵值的強制轉型" class="headerlink" title="鍵值的強制轉型"></a>鍵值的強制轉型</h5><p>若使用「很像數字」的字串當成鍵值來存資料，鍵值會被強制轉型為數字，這也會造成後續處理上的難題，像是產生剛剛提到的稀疏矩陣的狀況(又是地雷一枚)。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [];</span><br><span class="line">list[<span class="number">0</span>] = <span class="string">&#x27;Hello&#x27;</span>;</span><br><span class="line">list[<span class="string">&#x27;20&#x27;</span>] = <span class="string">&#x27;World&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list[<span class="string">&#x27;20&#x27;</span>]);<span class="comment">// World</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list.<span class="property">length</span>);<span class="comment">// 21</span></span><br></pre></td></tr></table></figure>

<p>陣列其實也就是物件的子型別而已，所以若想用字串當成鍵值來存放資料也是可以的，只是鍵值會被強制轉型為數字。如上所示，鍵值<code>20</code>被強制轉為數字20，導致list成為稀疏陣列，其長度就被誤判了。因此，若索引值是數字就用陣列，而非數字就用物件吧！</p>
<h4 id="類陣列-Array-Like"><a href="#類陣列-Array-Like" class="headerlink" title="類陣列(Array-Like)"></a>類陣列(Array-Like)</h4><p>類陣列是指以數值索引的值所成的群集，它可能是串列但並非真正的陣列，例如：DOM物件操作後所得偌的串列、函式引數所形成的串列(ES6已棄用)。而為了能操作這些類陣列的元素，就必須將類陣列轉為真正的陣列，這樣就進行indexOf、concat、forEach等的操作了。</p>
<p>DOM物件操作後所得到的串列，範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> list = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">list <span class="comment">// HTMLCollection(3) [div, div, div]</span></span><br><span class="line">list.<span class="property">length</span> <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<p>函式引數所形成的串列，範例如下，取得不定個數的引數。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> arr= <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>);<span class="comment">//(1)</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(arr);<span class="comment">//(2)</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(<span class="string">&#x27;hello&#x27;</span>,<span class="string">&#x27;world&#x27;</span>,<span class="string">&#x27;bar&#x27;</span>,<span class="string">&#x27;baz&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>得到</p>
<ul>
<li><p>(1)<code>&#123; [Iterator]    0: &#39;hello&#39;,   1: &#39;world&#39;,   2: &#39;bar&#39;,   3: &#39;baz&#39;,   [Symbol(Symbol.iterator)]: [λ: values] &#125;</code></p>
</li>
<li><p>(2)<code>[ &#39;hello&#39;, &#39;world&#39;, &#39;bar&#39;, &#39;baz&#39; ] </code></p>
</li>
</ul>
<p>以下可知，函數引數所形成的類陣列，在經過 <a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/Array/slice">slice</a> 轉換後可得到真正的陣列以供後續操作。注意，slice會回傳一個指定開始到結束部份的新陣列，因此在不傳人任何參數的狀況下等同於複製陣列。</p>
<p>或使用<code>Array.from</code>也會有同樣的效果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> arr= <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>);<span class="comment">//(1)</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(arr);<span class="comment">//(2)</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(<span class="string">&#x27;hello&#x27;</span>,<span class="string">&#x27;world&#x27;</span>,<span class="string">&#x27;bar&#x27;</span>,<span class="string">&#x27;baz&#x27;</span>);</span><br><span class="line"><span class="comment">//(1)`&#123; [Iterator]    0: &#x27;hello&#x27;,   1: &#x27;world&#x27;,   2: &#x27;bar&#x27;,   3: &#x27;baz&#x27;,   [Symbol(Symbol.iterator)]: [λ: values] &#125;</span></span><br><span class="line"><span class="comment">//(2)`[ &#x27;hello&#x27;, &#x27;world&#x27;, &#x27;bar&#x27;, &#x27;baz&#x27; ]</span></span><br></pre></td></tr></table></figure>

<h4 id="字串-String"><a href="#字串-String" class="headerlink" title="字串(String)"></a>字串(String)</h4><p>這部分還是繼續來看關於類陣列的處理。</p>
<h5 id="可變-Mutable-與不可變-Immutable"><a href="#可變-Mutable-與不可變-Immutable" class="headerlink" title="可變(Mutable)與不可變(Immutable)"></a>可變(Mutable)與不可變(Immutable)</h5><p>JavaScript在創建變數，賦值後是可變的(mutable)；相較於mutable，不可變(immutable)就是指在創建變數、賦值後便不可改變，若對其任何變更(例如：新增、修改、刪除)，就會回傳一個新值。</p>
<p>當需要更新一個變數的時候，若值的型態為基本型態，則是不可變的，意即只要改變就會回傳一個新的值； 若值的型態為物型態，則由於物件是使用call by reference的方式其享資料來源，因此只是就地更新而已，或說是更新這個位置所儲存的值，而非回傳一新的值。</p>
<h5 id="字串的類陣列處理"><a href="#字串的類陣列處理" class="headerlink" title="字串的類陣列處理"></a>字串的類陣列處理</h5><p>字串可不可以當成陣列來處理呢？可以的，而且可以借用陣列的方法來做些事情，只是要注意，<strong>不能變更陣列的內容</strong>。</p>
<h5 id="插入間隔字元"><a href="#插入間隔字元" class="headerlink" title="插入間隔字元"></a>插入間隔字元</h5><p>如下，借用陣列的 <a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/Array/join">join</a> 來實作在字串間插人字元。join和map都不會變動到原始陣列的內容，因為回傳的結果是一個新的值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> str_another = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">join</span>.<span class="title function_">call</span>(str, <span class="string">&#x27;--&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> str_the_other = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">map</span>.<span class="title function_">call</span>(str, <span class="function">(<span class="params">char</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;char.toUpperCase()&#125;</span>.`</span></span><br><span class="line">&#125;).<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str);<span class="comment">//foo</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str_another);<span class="comment">//f--o--o</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str_the_other);<span class="comment">//F.O.O. </span></span><br></pre></td></tr></table></figure>

<h5 id="反轉"><a href="#反轉" class="headerlink" title="反轉"></a>反轉</h5><p>但revere是會改變原始陣列資料的，因此字串就不能借用。如下所示，arr經反轉由 <code>[&#39;b&#39;, &#39;a&#39;, &#39;r&#39;]</code> 改變為 <code>[&quot;r&quot;, &quot;a&quot;, &quot;b&quot;]</code>。</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;r&#x27;</span>];</span><br><span class="line">arr.<span class="title function_">reverse</span>();<span class="comment">//[ &#x27;r&#x27;, &#x27;a&#x27;, &#x27;b&#x27; ] </span></span><br><span class="line">arr;<span class="comment">//[ &#x27;r&#x27;, &#x27;a&#x27;, &#x27;b&#x27; ] </span></span><br></pre></td></tr></table></figure>

<p>所以若想借用陣列的reverse來反轉字串，就會被報錯了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> str_another = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">reverse</span>.<span class="title function_">call</span>(str);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Uncaught TypeError: Cannot assign to read only property &#x27;0&#x27; of object &#x27;[object String]&#x27; at String.reverse</span></span><br></pre></td></tr></table></figure>

<p>面對無法借用陣列方法的狀況，可先將字串轉為陣列，在進行操作(像是反轉)，最後再轉回字串即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> str_thoe_other = str.<span class="title function_">split</span>(<span class="string">&#x27;&#x27;</span>).<span class="title function_">reverse</span>().<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">str_thoe_other;<span class="comment">//oof </span></span><br></pre></td></tr></table></figure>

<p>但以上是不是看起來眼醜陋又麻煩？因此最好的方法是先把資料存成陣列，再使用陣列的方法操作，後續若需要使用字串表示，再用join打平串起就可以了！</p>
<h4 id="數字-Number"><a href="#數字-Number" class="headerlink" title="數字(Number)"></a>數字(Number)</h4><p>JavaScript的數字(number)型別包含兩種-整數和帶有小數的浮點數，其中數字的實作是以<a href="https://zh.wikipedia.org/wiki/IEEE_754">IEEE 754</a> 為標準，也就是浮點數(floating-point number)的雙精度(double precision)格式，意渡64位元的二進位數字。</p>
<h5 id="如何表達「非常大」或「非常小」的數字？"><a href="#如何表達「非常大」或「非常小」的數字？" class="headerlink" title="如何表達「非常大」或「非常小」的數字？"></a>如何表達「非常大」或「非常小」的數字？</h5><p>非常大或非常小的數值以「指數」的方式呈現。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a =<span class="number">1E20</span>;</span><br><span class="line"><span class="keyword">const</span> b =a*<span class="number">100</span>;</span><br><span class="line"><span class="keyword">const</span> c= a/<span class="number">0.001</span>;</span><br><span class="line">a;<span class="comment">//100000000000000000000 </span></span><br><span class="line">b;<span class="comment">//1e+22</span></span><br><span class="line">c;<span class="comment">//1e+23</span></span><br><span class="line"><span class="comment">// 使用 toExponential 手動轉指數呈現</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toExponential</span>());<span class="comment">//1e+20 </span></span><br></pre></td></tr></table></figure>

<h5 id="如何指定小數位數"><a href="#如何指定小數位數" class="headerlink" title="如何指定小數位數?"></a>如何指定小數位數?</h5><p>使用toFixed指定要顯示的小數位數，會做四捨五入，不足會補零，注意結果會以「字串」格式呈現。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">123.456789</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toFixed</span>(<span class="number">1</span>));<span class="comment">//123.5 </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toFixed</span>(<span class="number">2</span>));<span class="comment">//123.46</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toFixed</span>(<span class="number">3</span>));<span class="comment">//123.457</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toFixed</span>(<span class="number">10</span>));<span class="comment">//123.4567890000 </span></span><br></pre></td></tr></table></figure>

<h5 id="如何指定有效位數"><a href="#如何指定有效位數" class="headerlink" title="如何指定有效位數?"></a>如何指定有效位數?</h5><p>使用toPrecision指定有效位數，會做四捨五入，不足會補零，注意結果會以「字串」格式呈現。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">123.456789</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toPrecision</span>(<span class="number">1</span>));<span class="comment">//1e+2 </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toPrecision</span>(<span class="number">2</span>));<span class="comment">//1.2e+2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toPrecision</span>(<span class="number">3</span>));<span class="comment">//123</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toPrecision</span>(<span class="number">4</span>));<span class="comment">//123.5</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toPrecision</span>(<span class="number">5</span>));<span class="comment">//123.46</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toPrecision</span>(<span class="number">10</span>));<span class="comment">//123.4567890 </span></span><br></pre></td></tr></table></figure>

<p>注意，數字後加上<code>.</code>會讓JavaScript引擎先判定為小數點，而非屬性存取。因此，若希望<code>100.toPrecision(1)</code>能正常顯示，應該為<code>100..toPrecision(1)</code>或<code>(100).toPrecision(1)</code>。</p>
<h5 id="如何表示其它基數的數字"><a href="#如何表示其它基數的數字" class="headerlink" title="如何表示其它基數的數字?"></a>如何表示其它基數的數字?</h5><ul>
<li><p>十六進位：加上前綴「0x」或「0X」</p>
</li>
<li><p>八進位：加上前綴「0o」或「0O」</p>
</li>
<li><p>二進位：加上前綴「0b」或「0B」</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0xAB</span>);<span class="comment">//171</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0o65</span>);<span class="comment">//53</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0b11</span>);<span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>  頭昏眼花了嗎？<code>0x</code>、<code>0o</code>、<code>0b</code> 可不是表情符號喔！</p>
<h5 id="如何表示十進位小數"><a href="#如何表示十進位小數" class="headerlink" title="如何表示十進位小數?"></a>如何表示十進位小數?</h5><p>只要是使用IEEE754來表示二進位浮點數的程式語言都有一個夢靨-無法精準地表示十進位的小數，範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0.1</span>+<span class="number">0.2</span> === <span class="number">0.3</span>);<span class="comment">//false </span></span><br></pre></td></tr></table></figure>

<p>將 0.1、0.2 和 0.3 分別轉為二進位來看</p>
<ul>
<li>0.1 轉成二進位表示為 0.0001100110011…（0011 循環）</li>
<li>0.2 轉成二進位表示為 0.00110011001100…（1100 循環）</li>
<li>0.3 轉成二進位表示為 0.0100110011001…（1001 循環）</li>
</ul>
<p>因此 0.1 + 0.2 永遠不會剛好等於 0.3。</p>
<p>解法是取一個很小的誤差當作容許值，若運算結果小於這個誤差值就判斷為等於，在ES6中已定義好這個常數<code>Number.EPSILON</code>其值為2^-52, 或實作polyfill如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Number</span>.<span class="property">EPSILON</span>) &#123;</span><br><span class="line">  <span class="title class_">Number</span>.<span class="property">EPSILON</span> = <span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>,-<span class="number">52</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那…要怎麼使用這個<code>Number.EPSILON</code>呢?先實作一個函equal，它會判斷誤差是否小於容許值-先將兩輸入值的差取絕對值，再與<code>Number.EPSILON</code>做比對，若小於這個誤差值就判𪼙為兩數相等。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">equal</span>(<span class="params">n1, n2</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">abs</span>(n1-n2) &lt; <span class="title class_">Number</span>.<span class="property">EPSILON</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a=<span class="number">0.1</span>+<span class="number">0.2</span>;</span><br><span class="line"><span class="keyword">var</span> b= <span class="number">0.3</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">equal</span>(a,b));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">equal</span>(<span class="number">0.0000001</span>, <span class="number">0.0000002</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<h5 id="備註"><a href="#備註" class="headerlink" title="備註"></a>備註</h5><p>ES6定義所謂「安全」的數值範圍為</p>
<ul>
<li>整數：最大整數<code>Number.MAX_SAFE_INTEGER</code>(其值為 2^53 - 1 等於 9007199254740991）、最小整數 <code>Number.MIN_SAFE_INTEGER</code>（其值為 -9007199254740991）。</li>
<li>浮點數：最大浮點數 <code>Number.MAX_VALUE</code>（其值為 1.798e+308）、最小浮點數 <code>Number.MIN_VALUE</code>（其值為 5e-324）。</li>
</ul>
<h5 id="如何知道數值是個整數？如何知道數值位在安全範圍內？"><a href="#如何知道數值是個整數？如何知道數值位在安全範圍內？" class="headerlink" title="如何知道數值是個整數？如何知道數值位在安全範圍內？"></a>如何知道數值是個整數？如何知道數值位在安全範圍內？</h5><p>使用<code>Number.isInteger</code>來測試數值是否為整數。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="title function_">isInteger</span>(<span class="number">42</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="title function_">isInteger</span>(<span class="number">42.000</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="title function_">isInteger</span>(<span class="number">42.3</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>使用<code>Number.isSafeInteger</code>來測試數值是否在安全範圍內。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="title function_">isSafeInteger</span>(<span class="title class_">Number</span>.<span class="property">MAX_SAFE_INTEGER</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="title function_">isSafeInteger</span>(<span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>, <span class="number">53</span>)));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="title function_">isSafeInteger</span>(<span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>, <span class="number">53</span>) - <span class="number">1</span>));<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>polyfill</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Number</span>.<span class="property">isSafeInteger</span>) &#123;</span><br><span class="line">  <span class="title class_">Number</span>.<span class="property">isSafeInteger</span> = <span class="keyword">function</span>(<span class="params">num</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Number</span>.<span class="title function_">isInteger</span>( num ) &amp;&amp;</span><br><span class="line">      <span class="title class_">Math</span>.<span class="title function_">abs</span>( num ) &lt;= <span class="title class_">Number</span>.<span class="property">MAX_SAFE_INTEGER</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="32位元有號整數-32-bit-Signed-Integer"><a href="#32位元有號整數-32-bit-Signed-Integer" class="headerlink" title="32位元有號整數(32-bit Signed Integer)"></a>32位元有號整數(32-bit Signed Integer)</h5><p>部份運算(例如：位元運算bitwise operator)只允𧥸使用32位元的有號整數，其範圍為<code>Math.pow(-2,31)</code>到<code>Math.pow(2,31)-1</code>。</p>
<p>在做這類運算前必須先把數值使用<code>|0</code>轉為32位元的有環整數</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> integer = <span class="number">123456789</span>;</span><br><span class="line"><span class="keyword">const</span> signed_integer = integer | <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h3 id="你懂JavaScript？值-Values-Part2-特殊值"><a href="#你懂JavaScript？值-Values-Part2-特殊值" class="headerlink" title="你懂JavaScript？值(Values)Part2-特殊值"></a>你懂JavaScript？值(Values)Part2-特殊值</h3><p>主要內容為探討基本型別的特殊值並能適當使用它們。</p>
<h4 id="undefined與void運算子"><a href="#undefined與void運算子" class="headerlink" title="undefined與void運算子"></a>undefined與void運算子</h4><p>void運算子可確保運算式不回傳任何值(其實是得到undefined),並且不修改現有值。</p>
<p>例如，𫍇僤有一個變數hello，其值為777，結合void運算子做運算後會得到undefined,但hello內儲存的值仍是不變的，依舊是777。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hello = <span class="number">777</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> hello <span class="comment">// undefined</span></span><br><span class="line">hello <span class="comment">// 777</span></span><br></pre></td></tr></table></figure>

<p>實際上會應用到什麼狀況呢？</p>
<p>一，運算式的結果真的希望<strong>不回傳任何值</strong>(再次強調，其實是回傳undefined)，除了直接寫「undefined」外，還可以用「void某個值」，通常會用「void0」。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> result= <span class="title function_">sayHi</span>()</span><br><span class="line">result <span class="comment">//undefined</span></span><br></pre></td></tr></table></figure>

<p>二，在程式設定下，必須區別有意義和無意義的回傳值，而無意義的回傳值希望能是undefined，以避免後續誤判為「有意義」的回傳值而做了錯誤的操作，如下範例所示，這裡有一個定期檢查回傳結果的函式check，check會呼叫函式getResult來得到運算結果並確認結果為何，若沒有得到結果，就顯示經過的分鐘數；若得到結果就印出「工作完成」的訊息。在這裡無意義的回傳值是使用undefined，但當然很多開發者是比較喜歡用false或null，就看當時的需求和個人喜好摟。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> interval = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">let</span> start = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> counter = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 經由一些運算得到結果 result，若有結果則 flag &quot;isDone&quot; 設為 true 並回傳結果；若無結果則 flag &quot;isDone&quot; 設為 false 並回傳 undefined</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getResult</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isDone) &#123;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">void</span> <span class="number">0</span>; <span class="comment">// 等同於 undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不斷重複詢問是否得到結果？若沒有得到結果，就顯示經過的分鐘數；若得到結果就印出「工作完成」的訊息</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check</span>(<span class="params">timestamp</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> progress = timestamp - start;</span><br><span class="line">  <span class="keyword">if</span> (start === <span class="literal">null</span>) &#123; start = timestamp; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (progress &lt; interval) &#123;</span><br><span class="line">    <span class="title function_">requestAnimationFrame</span>(check);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">getResult</span>()) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;工作完成！&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`checking...time passed: <span class="subst">$&#123;counter&#125;</span> minute(s).`</span>);</span><br><span class="line">      counter++;</span><br><span class="line">      start = timestamp;</span><br><span class="line">      <span class="title function_">requestAnimationFrame</span>(check);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">requestAnimationFrame</span>(check);</span><br></pre></td></tr></table></figure>

<h4 id="NaN-無效的數字"><a href="#NaN-無效的數字" class="headerlink" title="NaN(無效的數字)"></a>NaN(無效的數字)</h4><p>NaN表示值為無效的數字(invalid number)，會產生NaN的原因是</p>
<ul>
<li><p>做數字運算時的兩個運算元的資料型並非都是數字或無法轉成有效的十進位或十來進位的數字</p>
</li>
<li><p>無意義的運算，例如：<code>0/0</code>、<code>Infinity/Infinity</code>都會得到NaN</p>
</li>
</ul>
<p>就會產生NaN</p>
<p>NaN有幾個有趣的議題…以下分別討論之。</p>
<h5 id="typeof-1"><a href="#typeof-1" class="headerlink" title="typeof"></a>typeof</h5><p>NaN既然表示是效的數字，依舊還是數字，因此在資料型別的檢測<code>typeof NaN</code>結果就是number，不要被字面上的意思「不是數字」(not a number)給弄糊塗了。</p>
<h5 id="運算結果是NaN"><a href="#運算結果是NaN" class="headerlink" title="運算結果是NaN"></a>運算結果是NaN</h5><p>NaN與任何數字運算都會得到NaN。</p>
<h5 id="唯一不大於、不小於、不等於自已的值"><a href="#唯一不大於、不小於、不等於自已的值" class="headerlink" title="唯一不大於、不小於、不等於自已的值"></a>唯一不大於、不小於、不等於自已的值</h5><p>NaN不大於、不小於也不等於任何值，包含NaN它自已。</p>
<h5 id="isNaN與Number-isNaN"><a href="#isNaN與Number-isNaN" class="headerlink" title="isNaN與Number.isNaN"></a><code>isNaN</code>與<code>Number.isNaN</code></h5><p>要如何檢測運算結果是否為有效的數字呢？那麼就來檢測是否為無效的數字-NaN就可以了，在ES6以前，開發者使用<code>isNaN</code>在數學運算或解析字串後檢測得到的結果是否為合法的數字，其實就是檢測是否為NaN，其過程為先將輸入值使用Number強制轉型為數字，若無法轉為有效的數字而得偌NaN時就判定等於NaN，結果得到true。</p>
<p>範例如下，空物件<code>&#123;&#125;</code>經過isNaN判斷是NaN，意即為無效的數字。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(&#123;&#125;));<span class="comment">//true</span></span><br><span class="line"><span class="comment">// 拆解詳細過程如下...</span></span><br><span class="line"><span class="title class_">Number</span>(&#123;&#125;);<span class="comment">//先將空物件轉為數字，得到NaN</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="title class_">NaN</span>);<span class="comment">// 檢替是否為NaN，得到true</span></span><br></pre></td></tr></table></figure>

<p>其他範例還有…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="number">123</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(-<span class="number">1.23</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="number">5</span>-<span class="number">2</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="number">0</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="string">&#x27;123&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="string">&#x27;Hello World&#x27;</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="string">&#x27;2000/01/01&#x27;</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="string">&#x27;&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="literal">true</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="literal">undefined</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="string">&#x27;NaN&#x27;</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="title class_">NaN</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="number">0</span>/<span class="number">0</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">isNaN</span>(<span class="number">1</span>/<span class="number">0</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>但這檢測方式的常常會讓開發者得到<a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/isNaN#%E4%BB%A4%E4%BA%BA%E5%9B%B0%E6%83%91%E7%9A%84%E7%89%B9%E6%AE%8A%E7%8B%80%E6%B3%81%E8%A1%8C%E7%82%BA">讓人容易誤解的結果</a>(像是…大多數的人都會爭論…空物件<code>&#123;&#125;</code>就真的不等於NaN呀)，因此ES6推出了<code>Number.isNaN</code>、<code>Number.isNaN</code>不會經過轉為數字的這個過程，而是直接判斷型別是否為數字且是否等於NaN。承上範例，使用<code>Number.isNaN</code> 檢測空物件<code>&#123;&#125;</code>是否為NaN，得到false</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(&#123;&#125;));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>同樣也來看剛才的範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">123</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(-<span class="number">1.23</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">5</span>-<span class="number">2</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">0</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;123&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;Hello World&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;2000/01/01&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="literal">true</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="literal">undefined</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="string">&#x27;NaN&#x27;</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="title class_">NaN</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">0</span>/<span class="number">0</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="number">1</span>/<span class="number">0</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>雖然ES6出了這個新功能，但不見得所有的瀏覽都會支援，因此對於較舊的瀏器就掛個polyfill來模擬這個新功能。</p>
<p>polyfill如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Number</span>.<span class="property">isNaN</span>) &#123;</span><br><span class="line">  <span class="title class_">Number</span>.<span class="property">isNaN</span> = <span class="keyword">function</span> <span class="title function_">isNaN</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x !== x; <span class="comment">// NaN 是唯一一個不等於自己的值</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="無限-Infinity"><a href="#無限-Infinity" class="headerlink" title="無限(Infinity)"></a>無限(Infinity)</h5><p>無限分為正無限(在ES6定義為Number.POSITIVE_INFINITY)和負無限(在ES6為<code>Number.NEGSTIVE_INFINITY</code>)，在數字連算中會得到無限的原因是</p>
<ul>
<li>除以零，例如：<code>1/0</code>得到Infinity，<code>-1/0</code>得到-Infinity</li>
<li>溢位(overflow)，例如：<code>Number.MAX_VALUE + Math.pow(2,970)</code>得到Infinity(備註)</li>
</ul>
<p>又，無限與無限做數字運算，一般來說會得到無限。除了..</p>
<ul>
<li><p>無意的運算，例如：<code>0/0</code>、<code>Infinity/Infinity</code>都會得到NaN</p>
</li>
<li><p><code>1/Infinity</code>得到0，<code>-1/Infinity</code>得偌-0</p>
</li>
</ul>
<p>備註：若運算結果接近<code>Number.MAX_VALUE</code>而非Infinity，則會取一個最接近的值為<code>Number.MAX_VALUE</code>，𫍇稱為「向下約整」(rounds down);同理，若運算結果接近Infinity而非<code>Number.MAX_VALUE</code>, 則會取一個最接近的值為Infinity，𫍇稱為「向上約整」(rounds up)</p>
<h4 id="零-Zero"><a href="#零-Zero" class="headerlink" title="零(Zero)"></a>零(Zero)</h4><p>零分為正零(+0)和負零(-0)，正負號在表達方向上是很有用的。其中，產生負零的原因是乘除運算中，運算元的其中一方為負數，例如：<code>-0/1</code>或<code>0/-1</code>會得到-0。</p>
<p>零有幾個有趣的議題…以下分別討論之。</p>
<h5 id="數字轉字串vs字串轉數字"><a href="#數字轉字串vs字串轉數字" class="headerlink" title="數字轉字串vs字串轉數字"></a>數字轉字串vs字串轉數字</h5><p>不管是正零(+0)或負霧(-0)，轉字串後一律為「<code>0</code>」。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>((+<span class="number">0</span>).<span class="title function_">toString</span>());<span class="comment">// &quot;0&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">String</span>(+<span class="number">0</span>));<span class="comment">//&quot;0&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;&#x27;</span> + (+<span class="number">0</span>));<span class="comment">//&quot;0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>((-<span class="number">0</span>).<span class="title function_">toString</span>());<span class="comment">// &quot;0&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">String</span>(-<span class="number">0</span>));<span class="comment">//&quot;0&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;&#x27;</span> + (-<span class="number">0</span>));<span class="comment">//&quot;0&quot;</span></span><br></pre></td></tr></table></figure>

<p>相反的、若從字串轉數字，則</p>
<ul>
<li><p>字串正零(<code>&#39;+0&#39;</code>)會轉成數字0或報錯，但其實正零一般來說都是表示為「0」</p>
</li>
<li><p>字串負零(<code>&#39;-0&#39;</code>)會轉成數字-0</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(+<span class="string">&#x27;+0&#x27;</span>);<span class="comment">//0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="string">&#x27;+0&#x27;</span>));<span class="comment">//0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;+0&#x27;</span>));<span class="comment">// Uncaught SyntaxError: Unexpected token + in JSON at positi</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(+<span class="string">&#x27;-0&#x27;</span>);<span class="comment">//0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="string">&#x27;-0&#x27;</span>));<span class="comment">//0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;-0&#x27;</span>));<span class="comment">//0</span></span><br></pre></td></tr></table></figure>

<h5 id="如何辨別正零和負零"><a href="#如何辨別正零和負零" class="headerlink" title="如何辨別正零和負零?"></a>如何辨別正零和負零?</h5><p>正零(+0)或負零(-0)是無法從比較運算子和相等運算子中得到差異。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">0</span>; <span class="comment">// 0</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="number">0</span> / -<span class="number">1</span>; <span class="comment">// -0</span></span><br><span class="line"></span><br><span class="line">a == b; <span class="comment">// true</span></span><br><span class="line">-<span class="number">0</span> == <span class="number">0</span>; <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">a === b; <span class="comment">// true</span></span><br><span class="line">-<span class="number">0</span> === <span class="number">0</span>; <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span> &gt; -<span class="number">0</span>;	<span class="comment">// false</span></span><br><span class="line">a &gt; b; <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>那到底要如何辨別正零和負零呢？</p>
<p>解法的𦂇驟如下</p>
<ol>
<li><p>先將輸入值轉為數字，若為-0則<code>Number(-0)</code>為-0,並檢查結果是否等於胕</p>
</li>
<li><p>由於<code>1/-0</code>得到-Infinity，因此就可檢測輸入值是否為負零</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isNegZero</span>(<span class="params">n</span>) &#123;</span><br><span class="line">    n = <span class="title class_">Number</span>(n);</span><br><span class="line">    <span class="keyword">return</span> (n === <span class="number">0</span>) &amp;&amp; (<span class="number">1</span> / n === -<span class="title class_">Infinity</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 測試</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isNegZero</span>(-<span class="number">0</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isNegZero</span>(<span class="number">0</span> / -<span class="number">1</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isNegZero</span>(<span class="number">0</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>  稍後會再提供另一個解法-<code>Object.is(..)</code></p>
<h5 id="特殊相等性-Special-Equality"><a href="#特殊相等性-Special-Equality" class="headerlink" title="特殊相等性(Special Equality)"></a>特殊相等性(Special Equality)</h5><p>針對負零(-0)和NaN的比較，除了以上提過的方法外，還可以用<code>Object.is(..)</code>來做檢測。</p>
<p><code>Object.is(..)</code>會比較兩值是否相等，而<code>Object.is(..)</code>的運作和嚴格相等是一樣的，但會將NaN、-0、和+0獨立處理。到底㤰麼定義「相等」呢？有興趣的可以參考 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Equality_comparisons_and_sameness">MDN</a>的說明。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="title class_">Number</span>(<span class="string">&#x27;Hello World&#x27;</span>);<span class="comment">// NaN</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="number">0</span> / -<span class="number">1</span>; <span class="comment">//-0 </span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">is</span>(a,<span class="title class_">NaN</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">is</span>(b,-<span class="number">0</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">is</span>(b,<span class="number">0</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>世紀難題都被它解決了，</p>
<h3 id="你懂JavaScript嗎？原生功能-Natives"><a href="#你懂JavaScript嗎？原生功能-Natives" class="headerlink" title="你懂JavaScript嗎？原生功能(Natives)"></a>你懂JavaScript嗎？原生功能(Natives)</h3><p>主要會談到</p>
<ul>
<li><p>何謂原生功能(Natives)?</p>
</li>
<li><p>物件包裹器、陷阱、解封裝。</p>
</li>
<li><p>各類建搆子的原生功能、原生的原型。雖然優先使用字面值而非使用建構子建立物件、還是需要來看一些需要關心的議題和警惕用的錯誤用法。</p>
</li>
</ul>
<h4 id="何謂原生功能-Natives"><a href="#何謂原生功能-Natives" class="headerlink" title="何謂原生功能(Natives)?"></a>何謂原生功能(Natives)?</h4><p>原生功能(Natives)其實指的就是「內建函式」(built-in function)，最常用的像是<code>String()</code>、<code>Number()</code>、<code>Boolean()</code>、<code>Array()</code>、<code>Object()</code>、<code>Function()</code>、<code>RegExp()</code>、<code>Date()</code>、<code>Error()</code>、<code>Symbol()</code>，其中null和undefined是沒有內建函式的。我們也可以將Natives當成建構子(constructor)來建立值。注意，使用建構子建立出來的值是一僤包裹了基本型別值的物件包裹器(object wrapper)，而這個包裹器在其原型(prototype)上定義了許多屬性和方法，因此這些資料型態就能如物件般擁有屬性和方法以供使用。</p>
<p>範例如下，使用<code>new String(&#39;...&#39;)</code>來建立字串值「Hello World!」，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s);<span class="comment">//String &#x27;Hello World!&#x27; </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s.<span class="title function_">toString</span>());<span class="comment">// &quot;Hello World!&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> s);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s <span class="keyword">instanceof</span> <span class="title class_">String</span>);<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(s));<span class="comment">//[object String]</span></span><br></pre></td></tr></table></figure>

<p>說明</p>
<ul>
<li><p>s是一個包裹了基本型別值String的物件包裹器，簡稱為「字串包裹器物件」，包裹了字串「Hello World!」，而非只是建立了字串本身。</p>
</li>
<li><p>s這個字串包裹器物件的原型上定義了toString方法，因此可使用<code>s.toString()</code>得到字串值。</p>
</li>
<li><p>使用 <a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Operators/typeof">typeof</a> 來判斷值的型別，例如，<code>typeof s</code>檢視s的型別，結果是「物件」。</p>
</li>
<li><p>使用<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/instanceof">instanceof</a> 來判斷值是否為指定的物件型別，例如，<code>s instanceof String</code>確認s為String的實體物件。</p>
</li>
<li><p>使用<code>Object.prototype.toString</code>取得物件的子分類、得到字串。</p>
</li>
</ul>
<h4 id="Internal-Class"><a href="#Internal-Class" class="headerlink" title="Internal[[Class]]"></a>Internal<code>[[Class]]</code></h4><p>物件型別的值其內部有一固<code>[[Class]]</code>屬性來標記這個值是屬於物件的哪個子分類，雖然無法直接取用，但可透過<code>Object.prototype.toString</code>  間接取得，範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="string">&#x27;Hello World&#x27;</span>));<span class="comment">//[object String] </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="literal">true</span>));<span class="comment">//[object Boolean]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="literal">null</span>));<span class="comment">//[object Null]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="literal">undefined</span>));<span class="comment">//[object Undefined] </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]));<span class="comment">//[object Array]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span> &#125;));<span class="comment">//[object Object] </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params"></span>) &#123; &#125;));<span class="comment">//[object Function] </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="regexp">/helloworld/i</span>));<span class="comment">//[object RegExp]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">new</span> <span class="title class_">Date</span>()));<span class="comment">//[object Date]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="title class_">Symbol</span>(<span class="string">&#x27;foo&#x27;</span>)));<span class="comment">//[object Symbol]</span></span><br></pre></td></tr></table></figure>

<h4 id="封裝用的包裹器-BoxingWrappers"><a href="#封裝用的包裹器-BoxingWrappers" class="headerlink" title="封裝用的包裹器(BoxingWrappers)"></a>封裝用的包裹器(BoxingWrappers)</h4><p>由於JavaScirpt引擎會自動為基本型別值包裹(或稱封裝)物件包裹器，因此字面值能𢁍屬性或方法可用，例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s = <span class="string">&#x27;Hello World!&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s.<span class="property">length</span>);<span class="comment">//12</span></span><br></pre></td></tr></table></figure>

<p>那麼，直托使用物件形式的物件包裹器來宣告變數，而非隱含地讓JavaScript引擎轉換，是不是比較好呢？答案是否定的，第一，這樣效能不佳，使用字面值可讓JavaScript預先編譯並快取起來！第二，沒有必要，字面值可幾乎可完全取代物件包裹器做的事情-因此，就讓JavaScript引擎自動為我們做這個封裝的工作吧。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;Hello World!&#x27;</span>);<span class="comment">//錯誤示範！效能差！</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s.<span class="property">length</span>);<span class="comment">//12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> s_the_other= <span class="title class_">Object</span>(<span class="string">&#x27;Hello World!&#x27;</span>);<span class="comment">// 錯誤示範！效能差！</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s_the_other.<span class="property">length</span>);<span class="comment">//12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> s_another =<span class="string">&#x27;Hello World!&#x27;</span>;<span class="comment">//正確示範！效能佳！</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s_another.<span class="property">length</span>);<span class="comment">//12</span></span><br></pre></td></tr></table></figure>

<h4 id="物件包裹器的陷阱-Object-Wrapper-Gotchas"><a href="#物件包裹器的陷阱-Object-Wrapper-Gotchas" class="headerlink" title="物件包裹器的陷阱(Object Wrapper Gotchas)"></a>物件包裹器的陷阱(Object Wrapper Gotchas)</h4><p>由於直接使用物件形式的物件包裹器來宣告變數會造縑一些誤用，像是難以做條件判斷，因此非常不建議這麼做！使用之前請三思！</p>
<p>如下範例，使用物件包裹器宣告一個布林變數isValid，其值希望是false，但實際上卻是一個物件<code>Boolean &#123;true&#125;</code>，導致進入判斷式轉型為true, 印出訊息「可以繼續運作…」</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isValid = <span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isValid) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;可以繼續運作...&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;不合規則，等得處理...&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 可以繼續運作...</span></span><br></pre></td></tr></table></figure>

<p>怎麼辦？很簡單，「解封裝」就行啦！繼續看下去吧！</p>
<h4 id="解封裝-Unboxing"><a href="#解封裝-Unboxing" class="headerlink" title="解封裝(Unboxing)"></a>解封裝(Unboxing)</h4><p>解封裝是指將底層的基本型別值取出來。</p>
<p>承上範例，isValid的值居然是物件<code>Boolean &#123;true&#125;</code>，只好使用<code>valueOf</code>來抽出底層的基型值摟，其他強制轉型的方法待後強制轉型的部份補充。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isValid.<span class="title function_">valueOf</span>()<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<h4 id="建構子的原生功能"><a href="#建構子的原生功能" class="headerlink" title="建構子的原生功能"></a>建構子的原生功能</h4><p>再次強調，優先使用字面值而非使用建構子建立物件。但在這個「建構子的原生功能」部份，我們還是來看一些需要關心的議題和警惕用的錯誤用法。</p>
<h5 id="Array"><a href="#Array" class="headerlink" title="Array(..)"></a><code>Array(..)</code></h5><ul>
<li>不管是否使用new，陣列的物件包裹器所建立的物件是相同的，意即<code>new Array(...)</code>和<code>Array(...)</code>同義。</li>
<li>若只傳入一個數字，則不會被當成陣列內容，而會是陣列長度來預先設定陣列的大小，實際上這是個虛胖的空陣列，而裡面沒有存任何東西，是empty。這種具有空插槽(empty slot)的陣列在做陣列處理時容易產生不可預期的錯誤。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="title class_">Array</span>(<span class="number">10</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// (10) [empty × 10]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">length</span>);<span class="comment">// 10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b =[<span class="literal">undefined</span>,<span class="literal">undefined</span>,<span class="literal">undefined</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">delete</span> b[<span class="number">1</span>]);<span class="comment">// true，成功刪除一個元素？</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b);<span class="comment">// [undefined, empty, undefined]，這裡產生一個空插槽！</span></span><br></pre></td></tr></table></figure>

<h5 id="RegExp"><a href="#RegExp" class="headerlink" title="RegExp(..)"></a><code>RegExp(..)</code></h5><p>在正規表達式方 ，只有一種狀況會需要用到物件包裹器而非字面值，就是必須「動態地」為正規表達式建立範式(pattern)，意即<code>new RegExp(&#39;pattern&#39;,&#39;flags&#39;)</code>的格式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&#x27;Apple&#x27;</span>;</span><br><span class="line"><span class="type">const</span> <span class="variable">pattern</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&quot;\\b(?:&quot;</span> + name + <span class="string">&quot;)+\\b&quot;</span>, <span class="string">&quot;ig&quot;</span>);</span><br><span class="line"><span class="type">const</span> <span class="variable">matches</span> <span class="operator">=</span> <span class="string">&#x27;Hi, Apple&#x27;</span>.match(pattern);</span><br><span class="line"></span><br><span class="line">console.log(matches);<span class="comment">//[ &#x27;Apple&#x27; ] </span></span><br></pre></td></tr></table></figure>

<h5 id="Date-與Error"><a href="#Date-與Error" class="headerlink" title="Date(..)與Error(..)"></a><code>Date(..)</code>與<code>Error(..)</code></h5><p>Data與Error沒有字面值格式，只能用物件包裹器作為建構子的方式建立物件。</p>
<p>Error需要注意的地方是，不管是否使用new，陣列的物件包裹器所建立的物件是相同的，意即<code>new Error(...)</code>和<code>Error(...)</code>同義。</p>
<h5 id="Symbol-…"><a href="#Symbol-…" class="headerlink" title="Symbol(…)"></a>Symbol(…)</h5><p>Symbol同樣沒有字面值格式，若要自定義的Symbol，就要使用建構子<code>Symbol(..)</code>且不可在前面加上new，否則會報錯。</p>
<h4 id="原生的原型-Native-Prototype"><a href="#原生的原型-Native-Prototype" class="headerlink" title="原生的原型(Native Prototype)"></a>原生的原型(Native Prototype)</h4><p>每個建構子都有自已的<code>.prototype</code>物件，例如：<code>Array.prototype</code>、<code>String.prototype</code>等，而這些<code>.prototype</code>物件擁有各自子物件的專屬行為。白話來說，就是經由建構子建立的物件與經由JavaScript引擎封裝的字面值，由於原型委派(prototype delegation)的緣故，都能使用定義<code>.prototype</code>的屬性和方法。例如，無論是經由<code>String()</code>建構子或經由JavaScript引擎封裝的字串基本型別字面值，由於原型委派(prototype delegation)的綠故，都能使用定義於<code>String.prototype</code>的屬性和方法。又<code>String.prototype.XYZ</code>可簡寫為<code>String#XYZ</code>，例如：<code>String#indexOF(..)</code>、<code>String#charAt(..)</code>等，其他型別都各自有其行為。</p>
<p><strong>注意，不要任意修改這些預設的原生的原型</strong>(甚至建議不要無條件地擴充原生的原型，若要擴充也應撰寫符合規格的崱試程式)，這在後續強制轉型的部份會看到一虛例子。</p>
<p><code>Array.prototype</code>是空陣列，<code>Function.prototype</code>是空的函式，<code>RegExp.prototype</code>是空的正規很達式，因此有人會拿來做為變數的初始值，雖然可能節省了重新創建新值和垃圾回收的工作而讓效能變好，但這可能會在無意間修改了這些預設的原生的原型，這是要避免的。</p>
<h3 id="你懂JavaScript嗎？強制轉型-Coercion"><a href="#你懂JavaScript嗎？強制轉型-Coercion" class="headerlink" title="你懂JavaScript嗎？強制轉型(Coercion)"></a>你懂JavaScript嗎？強制轉型(Coercion)</h3><p>強制轉型(coercion)到底是的個有用的功能，還是設計上的缺陷呢?</p>
<p>主要會談到</p>
<ul>
<li><p>強制轉型(coercion)分為兩種，分別是「明確的」強制轉型(explicit coercion)和「隱含的」強轉型(implicit coercion)，只要是程式碼中刻意寫出來的型別轉換動作，就是明確的強制轉型；反之，在程式碼沒有明確指出要轉換型別卻轉型的，就是隱含的強制轉型。</p>
</li>
<li><p>明確的強型轉型規則與範例說明。</p>
</li>
<li><p>隱含的強型轉型規則歹範例說明。</p>
</li>
<li><p>Symbol的強制轉型的規則與範例說明。</p>
</li>
<li><p>隱含的強制轉型的心酸血淚？各種令人崩潰的範例。</p>
</li>
<li><p>押象的關系式比較。</p>
</li>
</ul>
<h4 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h4><p>強制轉型(coercion)分為兩種，分別是「明確的」強制轉型(explicit coercion)和「隱含的」強制轉型(implicit coercion)，只要是程式碼中刻意寫出來的型別轉換的動作，就是明確的強制轉型； 反之，在程式碼中沒有明確指出要轉換型卻轉型的，就是隱含的強制轉型。</p>
<p>範例如下，b的的值由運算式<code>String(a)</code>而來，這裡表明會將a強制轉為字串，因此是明確的強制轉型； 而c的值由運算式<code>a + &#39;&#39;</code>而來，當兩值的型別不同且其中一方是字串時，<code>+</code>所代表的是定字串運算子，要將兩字串做串接，而會將數字強制轉型為字串，並連接兩個字串，因此是隱含的強制轉型，稍後會再詳述。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">42</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="title class_">String</span>(a); <span class="comment">//明確的強制轉型</span></span><br><span class="line"><span class="keyword">var</span> c = a + <span class="string">&#x27;&#x27;</span>;<span class="comment">//隱含的強制轉型</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b);<span class="comment">// &#x27;42&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c);<span class="comment">// &#x27;42&#x27;</span></span><br></pre></td></tr></table></figure>

<p>注意，無論是明確或隱含，強制轉型的結果會是基本型別值，例如：數字，布林或字串，</p>
<h4 id="抽象的值運算"><a href="#抽象的值運算" class="headerlink" title="抽象的值運算"></a>抽象的值運算</h4><p>「抽象的值運算」指的是「內部限定的運算」，意即這是JavaScirpt引擎在背後偷偷幫我們做的工作，在這個部分會來探討ToString、ToNumber、ToBoolen和ToPrimitive這幾個押象的值運算，來看看到底在強轉型時背地裡做了什麼好事。</p>
<h5 id="ToString"><a href="#ToString" class="headerlink" title="ToString"></a>ToString</h5><p>任何非字串的值被強制轉型為字串時，會遵循ES5的規格中的 <a href="https://es5.github.io/#x9.8">ToString</a> 來運作。</p>
<p>規則簡單說明如下</p>
<ul>
<li><p>undefined-&gt; <code>undefined</code>。</p>
</li>
<li><p>null-&gt;<code>null</code>。</p>
</li>
<li><p>boolean的true-&gt;<code>true</code>，false-&gt;<code>false</code>。</p>
</li>
<li><p>在數字方面，非常大或非常小的數字以指數呈現，例如:<code>1.23e21</code>。</p>
</li>
<li><p>物件</p>
<ul>
<li><p>若有定義<code>toString</code>方法，則會以它自已的<code>toString</code>方法所產生的結果為優先，例如，陣列有自己定義的<code>toString</code>方法，因此<code>[1,2,3].toString()</code>會得到<code>&quot;1,2,3&quot;</code>。</p>
</li>
<li><p>若沒有定義<code>toString</code>方法，則回傳內部的屬性<code>[[Class]]</code>，這是一個用來標記這個值是屬於物件的哪個子分類的標籤，例如：<code>(&#123;&#125;).toString()</code>會得到<code>[object Object]</code>。</p>
<img src="tostring-conversions.png" style="zoom:85%;" />

<p>圖片來源：<a href="https://es5.github.io/#x9.8">ToString Conversions</a></p>
</li>
</ul>
</li>
</ul>
<h4 id="JSON的字串化-JSON-Stringification"><a href="#JSON的字串化-JSON-Stringification" class="headerlink" title="JSON的字串化(JSON Stringification)"></a>JSON的字串化(JSON Stringification)</h4><p>順道一提JSON的字串化。</p>
<p>JSON的字串化<code>JSON.stringify</code>將值序列化(serialize)為JSON字串，這個轉無JSON字串的過程與ToString規則有關，但並不等於強制轉型。規則算簡單說明如下</p>
<ul>
<li>若為簡單值，即字串、數字、布林、null，則規與ToString相同。這些能轉為JSON字串的值稱為是「JSON-safe」的值，意即只要對JSON來說是安全的(safe)，就都能轉為JSON字串。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="number">42</span>));<span class="comment">//&quot;42&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="literal">true</span>));<span class="comment">//&quot;true&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="literal">null</span>));<span class="comment">//&quot;null&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">`Hello World`</span>));<span class="comment">//&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>無法轉為JSON字串的非法值有undefined、function、symble、具有徝環參考(circular reference)的物件，由於它們無法轉為JSON字串，因此<code>JSON.stringify</code>會自動忽略這些非法值或丟出錯誤。又，若陣列中某個元素的值無非法值則自動以null取代；若物件中的其中的一個屬性為非法值，則會非除這個屬性。</p>
</li>
<li><p>若無物件具有定義<code>toJSON</code>方法則會優先呼叫此方法，並依此方法之回傳值作為序列化的結果，因此，若試圖JSON字串化一個含有非法值的物件，應定義其<code>toJSON</code>方法以回傳適當的JSON-safe的值。</p>
<p>範例如下。</p>
<p>若陣列中某個元素的值為非法值則會自動以null取代； 若物件中的其中一個屬性為非法值，則會非除這個屬性。</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="literal">undefined</span>));<span class="comment">// undefined、忽略非法值</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;));<span class="comment">// undefined、忽略非法值</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="title class_">Symbol</span>()));<span class="comment">// undefined、忽略非法值</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="literal">undefined</span>]));<span class="comment">//// &quot;[1,2,3,null]&quot;，非法值以 null 取代</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">a</span>: <span class="number">2</span>, <span class="attr">b</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125; &#125;));<span class="comment">//&quot;&#123;&quot;a&quot;:2&#125;&quot;，忽略非法屬性</span></span><br></pre></td></tr></table></figure>

<p>具有循環參考的物件，丟出錯誤。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123; <span class="attr">someProperty</span>: <span class="string">&#x27;Jack&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> b = &#123; <span class="attr">anotherProperty</span>: a &#125;;</span><br><span class="line">a.<span class="property">b</span> = b;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(a));<span class="comment">// Uncaught TypeError: Converting circular structure to JSON</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(b));<span class="comment">// Uncaught TypeError: Converting circular structure to JSON</span></span><br></pre></td></tr></table></figure>

<p>針對含有非法值的物件或具有循環參考的物件，解法是定義其<code>toJSON</code>方法以回傳JSON-safe的值。</p>
<p>範例如下，物件someObj含有非法的屬性會導致轉JSON字串時被忽略，因此定義其<code>toJSON</code>方法只要序列化合法的a屬性即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> someObj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">b</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;,<span class="comment">//非法！</span></span><br><span class="line">    <span class="attr">toJSON</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">a</span>: <span class="number">2</span>,<span class="comment">// 序𦕁化過程只包含a屬性</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(someObj));<span class="comment">// &quot;&#123;&quot;a&quot;:2&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>再看一個範例，對於「具有循環參考的物件」該怎麼處理呢？如下，a和b是具有循環參考的物件，在先前的例子中<code>JSON.stringify(a)</code>和<code>JSON.stringifg(b)</code>會丟出錯誤「Uncaught TypeError:Converting circular structure to JSON」，因此分別定義其<code>toJSON</code>方法，這裡的序列化過程只包含prompt屬性且其值為字串<code>Hello World</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">    <span class="attr">someProperty</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">toJSON</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">prompt</span>: <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">    <span class="attr">anotherProperty</span>: a,</span><br><span class="line">    <span class="attr">toJSON</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">prompt</span>: <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a.<span class="property">b</span> = b;</span><br><span class="line"><span class="comment">// 序列化成功！不會被報錯了！</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(a));<span class="comment">// &quot;&#123;&quot;prompt&quot;:&quot;Hello World&quot;&#125;&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(b));<span class="comment">// &quot;&#123;&quot;prompt&quot;:&quot;Hello World&quot;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>除了<code>toJSON</code>外，<code>JSON.stringify</code>也可傳入第二個選擇性參數「取代器」(replacer,可為陣列或函式)來自訂過濾機制，決定序列化過程中應該包含哪些屬性。</p>
<ul>
<li><p>取代器為陣列時，陣列內的元素為指定要包含的屬性名稱。如下，指定序列化過程中只需要包含a屬性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> someObj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">b</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(someObj,[<span class="string">&#x27;a&#x27;</span>]));<span class="comment">// &quot;&#123;&quot;a&quot;:2&#125;&quot;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>取代器為函數時，函式是用來運算要回傳以做序列化的屬性的值。如下，指定除了b以外的屬性都要做序列化。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> someObj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">b</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(someObj, <span class="keyword">function</span> (<span class="params">key, value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key !== <span class="string">&#x27;b&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br><span class="line"><span class="comment">// &quot;&#123;&quot;a&quot;:2&#125;&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="ToNumber"><a href="#ToNumber" class="headerlink" title="ToNumber"></a>ToNumber</h5><p>若需要將非數字當成數字來操作，像是做數學運算，就會遵循ES5的規格中的<a href="https://es5.github.io/#x9.3">ToNumber</a> 來運作。規則簡單說明如下</p>
<ul>
<li><p>undefined -&gt; NaN。</p>
</li>
<li><p>null -&gt; +0即是0。</p>
</li>
<li><p>boolean 的true -&gt; 1，false -&gt; +0 即是0。</p>
</li>
<li><p>string -&gt; 數字或NaN。</p>
</li>
<li><p>object</p>
<ul>
<li><p>若有定義其<code>valueOf</code>方法，則會優先使用<code>valueOf</code>取得其基本型別值。</p>
</li>
<li><p>若沒有定義<code>valueOf</code>方法，則會改用<code>toString</code>方法取得其基本型別值，再用ToNumber轉為數字，在這裡先簡化為<code>Number(..)</code>會來處理這一連串的流程即可。</p>
</li>
<li><p>注意，以<code>Object.create(null)</code>建立的null沒有<code>valueOf</code>或<code>toString</code>方法，因此在式圖轉為基本型別值的時候會出錯，丟出TypeError. </p>
<img src="tonumber_conversions.png" style="zoom:85%;" />

<p>圖片來源：<a href="https://es5.github.io/#x9.3">ToNumber Conversions</a></p>
<p>範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="literal">undefined</span>));<span class="comment">// NaN</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="literal">null</span>));<span class="comment">// 0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="literal">true</span>));<span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="literal">false</span>));<span class="comment">// 0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="string">&#x27;12345&#x27;</span>));<span class="comment">// 12345</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(<span class="string">&#x27;Hello World&#x27;</span>));<span class="comment">// NaN</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(&#123;<span class="attr">name</span>:<span class="string">&#x27;Jace&#x27;</span>&#125;));<span class="comment">// NaN</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> a =&#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">valueOf</span>:<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;999&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(a));<span class="comment">// 999</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h5 id="ToBoolean"><a href="#ToBoolean" class="headerlink" title="ToBoolean"></a>ToBoolean</h5><p> 讓我們複習一下 Truthy 與 Falsy 的概念，這會遵循 ES5 的規格中的 <a href="https://es5.github.io/#x9.2">ToBoolean</a> 來運作。</p>
<img src="toboolean_conversions.png" style="zoom:85%;" />

<p>圖片來源：<a href="https://es5.github.io/#x9.2">ToBoolean Conversions</a></p>
<h6 id="Falsy值"><a href="#Falsy值" class="headerlink" title="Falsy值"></a>Falsy值</h6><p>在JavaScirpt中會被轉為false的值有</p>
<ul>
<li><p><code>&quot;&quot;</code>空字串</p>
</li>
<li><p>0,-0,NaN</p>
</li>
<li><p>null</p>
</li>
<li><p>undefined</p>
</li>
<li><p>false</p>
<p>我們只要熟記這幾個值就可以了！</p>
</li>
</ul>
<p>而除了以上的值之外，都會被轉為ture,與例如下</p>
<ul>
<li><p><code>&#39;Hello World&#39;</code>非空字串。</p>
</li>
<li><p>42非零的有效數字</p>
</li>
<li><p><code>[],[1,2,3]</code>陣列，不管是不是空的</p>
</li>
<li><p><code>&#123;&#125;,&#123;name:&#39;Jack&#39;&#125;</code>物件，不管是不是空的</p>
</li>
<li><p><code>function foo()&#123;&#125;</code>函式</p>
</li>
<li><p>true</p>
</li>
</ul>
<h4 id="Falsy物件"><a href="#Falsy物件" class="headerlink" title="Falsy物件"></a>Falsy物件</h4><p>當使用包裹物件來建立字串、數字或布林值時，由於包了一層物件，因此就算其底層的基型值是會被轉為false的值，它根本上都還是個物件，而只要是物件(即使是空物件)，就會被轉為true.。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> b= <span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">const</span> c= <span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!a); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!b); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!c); <span class="comment">// true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Truthy-值"><a href="#Truthy-值" class="headerlink" title="Truthy 值"></a>Truthy 值</h4><p>再次強調，只要不是前面列舉為會轉為 false 的值，都會被轉為 true。</p>
<h4 id="ToPrimitive"><a href="#ToPrimitive" class="headerlink" title="ToPrimitive"></a>ToPrimitive</h4><p>詳細狀況可見 ES5 <a href="https://es5.github.io/#x9.1">規格</a>。規則簡單說明如下</p>
<ul>
<li><p>undefined -&gt; undefined(基本型別，不轉換)</p>
</li>
<li><p>null -&gt; null (基本型別值，不轉換)</p>
</li>
<li><p>boolean -&gt; boolean(基本型別值，不轉換)</p>
</li>
<li><p>number -&gt; number(基本型別值，不對換)</p>
</li>
<li><p>object：使用<code>[[DefaultValue]]</code>內部方法，依照傳入的參數來決定要使用toString或valueOf取得基本型別值，，看參考<a href="https://es5.github.io/#x8.12.8">規格</a>。</p>
</li>
</ul>
<h4 id="明確的強制轉型-Explicit-Coercion"><a href="#明確的強制轉型-Explicit-Coercion" class="headerlink" title="明確的強制轉型(Explicit Coercion)"></a>明確的強制轉型(Explicit Coercion)</h4><p>「明確的強制轉型」是指程式碼中刻意寫出來的明顯的型別轉換的動作。</p>
<h5 id="明確的Strings-Numbers"><a href="#明確的Strings-Numbers" class="headerlink" title="明確的Strings &lt;–&gt; Numbers"></a>明確的Strings &lt;–&gt; Numbers</h5><p>字串與數字間的明確的強制轉換。</p>
<h6 id="方法一：使用內建函式String-與Number"><a href="#方法一：使用內建函式String-與Number" class="headerlink" title="方法一：使用內建函式String(..)與Number(..)"></a>方法一：使用內建函式<code>String(..)</code>與<code>Number(..)</code></h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">String</span>(<span class="number">123</span>) <span class="comment">// &quot;123&quot;</span></span><br><span class="line"><span class="title class_">Number</span>(<span class="string">&#x27;123&#x27;</span>) <span class="comment">// 123</span></span><br></pre></td></tr></table></figure>

<p>注意，這裡的<code>String(..)</code>是直接調用<code>.toString</code>來轉字串，與<code>+</code>字串運算子經過ToPromitive的運作-由於傳入<code>[[DefaultValue]]</code>演算法的參數是number，因此先使用<code>valueOf</code>取得基型值，然後再用<code>toString</code>轉為字串，兩種方法 全不同的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">    <span class="attr">toString</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="number">54321</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">    <span class="attr">valueOf</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="number">12345</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">String</span>(a));<span class="comment">// &quot;54321&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b+<span class="string">&#x27;&#x27;</span>);<span class="comment">// &quot;12345&quot;</span></span><br></pre></td></tr></table></figure>

<h6 id="方法二：使用物件原型的方法-toString"><a href="#方法二：使用物件原型的方法-toString" class="headerlink" title="方法二：使用物件原型的方法.toString()"></a>方法二：使用物件原型的方法<code>.toString()</code></h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">123</span>).<span class="title function_">toString</span>() <span class="comment">// &quot;123&quot;</span></span><br></pre></td></tr></table></figure>

<h6 id="方法三：使用一元正-負運算子-、"><a href="#方法三：使用一元正-負運算子-、" class="headerlink" title="方法三：使用一元正&#x2F;負運算子+、-"></a>方法三：使用一元正&#x2F;負運算子<code>+</code>、<code>-</code></h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+(<span class="string">&#x27;123&#x27;</span>) <span class="comment">// 123</span></span><br><span class="line">-(<span class="string">&#x27;-123&#x27;</span>) <span class="comment">// 123</span></span><br></pre></td></tr></table></figure>

<p>這個方法有個缺點，就是很容易造成各種語意上的誤會，像是與遞增(<code>++</code>)和遞減(<code>--</code>)或與二元運算子的數學運算「加」(<code>+</code>)和「減」(<code>-</code>)混淆。：</p>
<p>較常使用一元正和負運算子<code>+</code>、<code>-</code>的時機是將<strong>日期轉為數字</strong>，也就是取得1970年1月1日00:00:00UTC到目前為止的毫秒數，或稱UNIX時間戳記、時戳值timestamp。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> timestamp = +<span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(timestamp);<span class="comment">//1566871728004 </span></span><br></pre></td></tr></table></figure>

<p>經由強制轉型取得時戳值並不是很好的方法，建議改用<code>Date.now()</code>或<code>.getTime()</code>會是更㞅想的作法，可讀性更高。</p>
<h6 id="方法四：使用一元位否定運算子"><a href="#方法四：使用一元位否定運算子" class="headerlink" title="方法四：使用一元位否定運算子~"></a>方法四：使用一元位否定運算子<code>~</code></h6><p>位元否定運算子(bitwise not)的功能是進行二進位的補數(公式為<code>~x</code>得到<code>-(x+1)</code>，例如~42得到-43)，它會先將值經由ToNumber轉為數字，再經由ToInt32轉障32位元有號整數，最後再逐位元的否，很類似<code>!</code>強制將值轉八布林並反轉其真偽的運作方式。</p>
<p>範例如下，<code>~</code>接受indexOf的回傳值並作轉換，對於「找不到」的-1會轉為0，做條件判斷時會再轉為false，其他的會回傳索引值(例如：0、1、2…)經否定再轉布林時都會是true,這樣的寫法有助於提高可讀性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">find</span>(<span class="params">target</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> result = str.<span class="title function_">indexOf</span>(target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (~result) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`找到了，索引值原本是 <span class="subst">$&#123;result&#125;</span>，被轉為 <span class="subst">$&#123;~result&#125;</span>`</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`找不到，回傳結果原本是 <span class="subst">$&#123;result&#125;</span>，被轉為 <span class="subst">$&#123;~result&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">find</span>(<span class="string">&#x27;llo&#x27;</span>); <span class="comment">// 找到了，索引值原本是 2，被轉為 -3</span></span><br><span class="line"><span class="title function_">find</span>(<span class="string">&#x27;abc&#x27;</span>) <span class="comment">// 找不到，回傳結果原本是 -1，被轉為 0</span></span><br></pre></td></tr></table></figure>

<h6 id="同場加映-浮點數轉為整數"><a href="#同場加映-浮點數轉為整數" class="headerlink" title="同場加映:浮點數轉為整數"></a>同場加映:浮點數轉為整數</h6><p>使用<code>~~</code>將浮點數轉為整數，其運作方式為反轉兩次而得到截斷小數的結果，類似<code>!!</code>的真偽雙次否定。這裡有兩件事情要注意…</p>
<ul>
<li>使用<code>x | 0</code>也可以得到同樣的效果，差別只在於<code>~~</code>運算子優先權較高，遇到四則運算時不用包小括號。</li>
<li>與<code>Math.floor(..)</code>的結果不同，如下，<code>Math.floor(-29.8)</code>得到-30，而<code>~~-29.8</code>得偌-29</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Math</span>.<span class="title function_">floor</span>(-<span class="number">29.8</span>));<span class="comment">// -30</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(~~-<span class="number">29.8</span>); <span class="comment">// -29</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(-<span class="number">29.8</span> | <span class="number">0</span>); <span class="comment">//-29</span></span><br></pre></td></tr></table></figure>

<h5 id="明確的剖析數值字串-Numberic-String"><a href="#明確的剖析數值字串-Numberic-String" class="headerlink" title="明確的剖析數值字串(Numberic String)"></a>明確的剖析數值字串(Numberic String)</h5><p>除了使用<code>Number(..)</code>將值強制轉型為數字外，還可用<code>parseInt(..)</code>剖析而得到數字。<code>parseInt(..)</code>的用途是將字串剖析為數字，它接受一個字串作為輸入，若輸入非字串的值則會使用ToString強制轉為字串。</p>
<p><code>Number(..)</code>與<code>parseInt(..)</code>的差異在於</p>
<ul>
<li><code>parseInt(..)</code>可容忍(或想像成忽略)非數值的字元，在由左至右掃描值的過程中，遇到非數值字就停下來(忽略後後續部份)，只轉換到停下來之前所得到的數值。除非整個字串都是非數值，否則不會得偌NaN。而<code>Number(..)</code>則是只要傳入的字串不是可轉成數值的，就會得到NaN。</li>
<li>「指定基底」是個必要的好習慣，<code>parseInt(..)</code>若沒有輸入第二個參數來指定基數，就會以第一個參數的頭幾個字元決定基數為何，例如：開頭若為<code>0x</code>就會轉為十六進位的數字。因此，使用<code>parseInt(..)</code>最好要傳入基底以維持結果的正確性，例如：<code>parseInt(&#39;12345&#39;,10)</code>。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="string">&#x27;123px&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(a));  <span class="comment">// 123 </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">parseInt</span>(a));<span class="comment">// 123 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(b));  <span class="comment">// NaN </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">parseInt</span>(b));<span class="comment">//123</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">parseInt</span>(<span class="string">&#x27;HelloWorld&#x27;</span>));<span class="comment">//NaN</span></span><br></pre></td></tr></table></figure>

<h5 id="明確的-–-Boolean"><a href="#明確的-–-Boolean" class="headerlink" title="明確的 * –&gt; Boolean"></a>明確的 * –&gt; Boolean</h5><p>探討任何值強制轉為布林的情況。</p>
<h6 id="方法一：使用內建函式Boolean"><a href="#方法一：使用內建函式Boolean" class="headerlink" title="方法一：使用內建函式Boolean(..)"></a>方法一：使用內建函式<code>Boolean(..)</code></h6><p>使用<code>Boolean(..)</code>來執行ToBoolean的轉換工作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(<span class="string">&#x27;Hello World&#x27;</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>([]));<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(&#123;&#125;));<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(<span class="literal">null</span>));<span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(<span class="literal">undefined</span>));<span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(<span class="title class_">NaN</span>));<span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(<span class="number">0</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(<span class="string">&#x27;&#x27;</span>));<span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<h6 id="方法二：否定運算子"><a href="#方法二：否定運算子" class="headerlink" title="方法二：否定運算子!"></a>方法二：否定運算子<code>!</code></h6><p>雙次否定即可強制將值轉為布林。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!<span class="string">&#x27;Hello World&#x27;</span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!![]);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!&#123;&#125;);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!<span class="literal">null</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!<span class="literal">undefined</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!<span class="title class_">NaN</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!<span class="number">0</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(!!<span class="string">&#x27;&#x27;</span>);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<h4 id="隱含的強制轉型-Implicit-Coercion"><a href="#隱含的強制轉型-Implicit-Coercion" class="headerlink" title="隱含的強制轉型(Implicit Coercion)"></a>隱含的強制轉型(Implicit Coercion)</h4><p>「隱含的強制轉型」是指在程式碼中沒有明確指出要轉換型別但卻轉型的動作。</p>
<h5 id="隱含的Strings-Numbers"><a href="#隱含的Strings-Numbers" class="headerlink" title="隱含的Strings &lt;–&gt; Numbers"></a>隱含的Strings &lt;–&gt; Numbers</h5><h6 id="Case1-String-–-Numbers-運算子是數字的相加，還是字串的串接"><a href="#Case1-String-–-Numbers-運算子是數字的相加，還是字串的串接" class="headerlink" title="Case1 String –&gt;Numbers:+運算子是數字的相加，還是字串的串接?"></a>Case1 String –&gt;Numbers:<code>+</code>運算子是數字的相加，還是字串的串接?</h6><p>若兩運算元的型別不同，當其中一方是字串時，<code>+</code>所代表的就是字串運算子，而會將另外一個運算元強制轉型為字串，並連接兩個字串。這裡提到的「另外一個運算元」就先稱它為b好了，若b是物件則會呼叫ToPrimitive做處理-由於傳入<code>[[DefaultValue]]</code>演算法的參敗是number，因此先使用<code>valueOf</code>取得基型值，然後再用<code>toString</code>轉為數字(非常的或非常小的數字以指數呈現)的字串格式。</p>
<p>如下範例，數字1會轉為字串<code>1</code>,而陣𦕁c和d分別會使用<code>toString</code>轉為<code>1, 2</code>與<code>3, 4</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> c = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="keyword">const</span> d = [<span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a + <span class="number">1</span>);<span class="comment">//&quot;11&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b + <span class="number">1</span>);<span class="comment">// 2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b + <span class="string">&#x27;&#x27;</span>);<span class="comment">// &quot;1&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c + d);<span class="comment">// &quot;1,23,4&quot;</span></span><br></pre></td></tr></table></figure>

<p>再看兩個著名的例子:<code>[] + &#123;&#125;</code>與<code>&#123;&#125; + []</code>。先猜猜看結果是什麼？</p>
<p>皆為<code>[object Object]</code>?</p>
<p>公佈答案摟！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[] + &#123;&#125; <span class="comment">// &quot;[object Object]&quot;</span></span><br><span class="line">&#123;&#125; + [] <span class="comment">// 0</span></span><br></pre></td></tr></table></figure>

<p>說明如下</p>
<ul>
<li><code>[] + &#123;&#125;</code>中，<code>[]</code>會轉為空字串，而<code>&#123;&#125;</code>會轉為字串<code>&quot;[object Object]&quot;</code>。</li>
<li><code>&#123;&#125; + []</code>中，<code>&#123;&#125;</code>被當成空區塊而無作用，<code>+[]</code>被當成強制轉型為睥字<code>Number([])</code>(由於陣列是物 ，中間會先使用<code>toString</code>轉成空字串，導致變成<code>Number(&#39;&#39;)</code>)而得到0。</li>
</ul>
<p>注意前面提到的<code>String(..)</code>是直接調用<code>.toString</code>來轉字串，與<code>+</code>字串運算子經過ToPrimitive的運作-由於傳入<code>[[DefaultValue]]</code>演算法的參數是number,因此先使用<code>valueOf</code>取得基型值，然後再用<code>toString</code>轉為字串，兩慟方法是完全不同的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">    <span class="attr">toString</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="number">54321</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">    <span class="attr">valueOf</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="number">12345</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">String</span>(a));<span class="comment">// &quot;54321&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b+ <span class="string">&#x27;&#x27;</span>);<span class="comment">// &quot;12345&quot;</span></span><br></pre></td></tr></table></figure>

<h6 id="Case2-使用數字運算子將字串轉為數字"><a href="#Case2-使用數字運算子將字串轉為數字" class="headerlink" title="Case2:使用數字運算子將字串轉為數字"></a>Case2:使用數字運算子將字串轉為數字</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a + <span class="number">1</span>);<span class="comment">//&quot;11&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a - <span class="number">0</span>);<span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a * <span class="number">1</span>);<span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a / <span class="number">1</span>);<span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>([<span class="number">9</span>]-[<span class="number">7</span>]);<span class="comment">//2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>轉換規則可參考前面提到的ToNumber。</p>
<h5 id="隱含的-–-Boolean"><a href="#隱含的-–-Boolean" class="headerlink" title="隱含的 * –&gt; Boolean"></a>隱含的 * –&gt; Boolean</h5><p>在什麼狀況下會隱含地將值強制轉為布林呢？</p>
<ul>
<li><p>if述句中的條件判斷(或稱測式運算式test expression)</p>
</li>
<li><p>for述句中的條件判斷，意即測試運算式的第二個子句</p>
</li>
<li><p>while與do…while中檢測條件是否成立的測試運算式</p>
</li>
<li><p>三元運算式<code>條件？值1：值2</code>中的條件運算，意即測試運算式的第一個子句</p>
</li>
<li><p>邏輯運算子的<code>||</code>(or)和<code>&amp;&amp;</code>(and)左手邊的運算元會被當成測試運算式</p>
</li>
</ul>
<p>轉換規則可參考前面提到的ToBoolean</p>
<p>範例如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">12345</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> c;<span class="comment">// undefined</span></span><br><span class="line"><span class="keyword">var</span> d = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (a) &#123; <span class="comment">//true</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;a 是直的&#x27;</span>);<span class="comment">// a 是直的</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (c) &#123;<span class="comment">//false</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;從來沒跑過&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">c = d ? a : b;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c);<span class="comment">// &quot;Hello World&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((a &amp;&amp; d) || c) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;結果是真的&#x27;</span>);<span class="comment">//結果是真的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="運算子-與"><a href="#運算子-與" class="headerlink" title="運算子||與&amp;&amp;"></a>運算子<code>||</code>與<code>&amp;&amp;</code></h6><p>邏輯運算子的<code>||</code>(or)和<code>&amp;&amp;</code>(and)其實應該要稱呼為「(運算元的)選擇器運算子」(operand selector operator)，𫍇是因為它們並不是產生邏輯運算值true或false，而是在兩個運算元當中「選擇」其中一個運算元的值作為結果。</p>
<p>規則為，<code>||</code>(or)和<code>&amp;&amp;</code>(and)會將第一個運算元做布林測試或強制轉型為布林以便測試。</p>
<ul>
<li>對<code>||</code>(or)來說，若結果為true，則取第一個運算元為結果；若結果為false，則取第二個運算元為結果。</li>
<li>對<code>&amp;&amp;</code>(and)來說，若結果為true，則取第二個運算元為結果；若結果為false，則取第一個運算元為結果。</li>
</ul>
<p>因此可應用於</p>
<ul>
<li><p><code>||</code>(or)可用來設定變數的初始值。</p>
</li>
<li><p><code>&amp;&amp;</code>(and)可用來執行「若特定條件成立，才做某件事情」，功能近似if述句。</p>
<p>範例如下</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">777</span>;</span><br><span class="line"><span class="keyword">const</span> c = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &amp;&amp; c);<span class="comment">//測試 a 為 true，選 c，結果是 null</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &amp;&amp; b);<span class="comment">//測試 a 為 true，選 b，結果是 777</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">undefined</span> &amp;&amp; b);<span class="comment">//測試 undefined 為false，選undefined,結果是 undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a || b);<span class="comment">//測試 a 為 true，選 a,結果是 &quot;Hello World&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c || <span class="string">&#x27;foo&#x27;</span>);<span class="comment">//測試 c 為 false，選&#x27;foo&#x27; ，結果是 &quot;foo&quot;</span></span><br></pre></td></tr></table></figure>

<p>若flag條件成立(true)，就執行函式foo，之後會再提到短路的議題。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> flag = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;try me&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">flag &amp;&amp; <span class="title function_">foo</span>();<span class="comment">//try me</span></span><br></pre></td></tr></table></figure>

<h4 id="Symbol的強制轉型"><a href="#Symbol的強制轉型" class="headerlink" title="Symbol的強制轉型"></a>Symbol的強制轉型</h4><p>symbol的強制轉型規則如下</p>
<ul>
<li><p>在轉為字串方面，將symbol明確的強制轉型是允許的，但隱含的強制轉型是被禁止的，並且會丟出錯誤訊息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 = <span class="title class_">Symbol</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">String</span>(s1));<span class="comment">// &quot;Symbol(Hello World)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s2= <span class="title class_">Symbol</span>(<span class="string">&#x27; World Hello&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s2+<span class="string">&#x27;&#x27;</span>);<span class="comment">// TypeError: Cannot convert a Symbol value to a string</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在轉為數字方面，無論是明確或隱含都是禁止的，並且會丟出錯誤訊息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> n1 = <span class="title class_">Symbol</span>(<span class="number">777</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Number</span>(n1));<span class="comment">// TypeError: Cannot convert a Symbol value to a number</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> n2=<span class="title class_">Symbol</span>(<span class="number">999</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(+n2);<span class="comment">// TypeError: Cannot convert a Symbol value to a number</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在轉為布林方面。無論是明確或隱含都是可以的，並且結果都是true</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> b1 = <span class="title class_">Symbol</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">const</span> b2 = <span class="title class_">Symbol</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(b1));<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Boolean</span>(b2));<span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b3 = <span class="title class_">Symbol</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">const</span> b4 = <span class="title class_">Symbol</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (b3) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;b3 是直的&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (b4) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;b4 是直的&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// b3 是真的</span></span><br><span class="line"><span class="comment">// b4 是真的</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="寬鬆相等-Loose-Equals-vs-嚴格相等-Strict-Equals"><a href="#寬鬆相等-Loose-Equals-vs-嚴格相等-Strict-Equals" class="headerlink" title="寬鬆相等(Loose Equals) vs 嚴格相等(Strict Equals)"></a>寬鬆相等(Loose Equals) vs 嚴格相等(Strict Equals)</h4><p>  關於相等性的運算子有四固「<code>==</code>」(寬鬆相等性loose equality)、「<code>===</code>」(嚴格相等性strict queality)、「<code>!=</code>」(寬鬆不相等loose not-queality)、「<code>!==</code>」(嚴格不相等strict not-equality)。寬鬆與嚴格的差異在於檢查值相等時，是否會做<strong>強制轉型</strong>、<code>==</code><strong>會做強制轉型，而<code>===</code>不會</strong>。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;100&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">100</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a == b);<span class="comment">//true，強制轉型，將字串&#x27;100&#x27;轉為數字100</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a === b);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>  這裡要說明一下，<code>==</code>和<code>===</code>其實都會做型別的檢查，只是當面對型別不同時的反應是不一樣的而已。</p>
<h5 id="規則"><a href="#規則" class="headerlink" title="規則"></a>規則</h5><p>  如果型別相同，就會以同一性做比較，但要注意</p>
<ul>
<li><p>NaN不等於自已(其實，NaN不大於、不小於也不等於任何數字，所以當然也不等於它自已)</p>
</li>
<li><p>+0、-0彼此相等。</p>
</li>
<li><p>物件(含function和array)的相等是比較參考(reference)，若參考相等才是相等。</p>
</li>
</ul>
<p>   如果型別不同，則會先將其中一個或兩個值先做強制轉型(可遞迴)，再用型別相同的同一性做比較。</p>
<ul>
<li><p>字串轉為數字</p>
</li>
<li><p>布林轉為數字</p>
</li>
<li><p>null與undefined在寬鬆相等下會強制轉型為彼此，因此是相等的，但不等於其他值</p>
</li>
<li><p>若比較的對象是物件，使用<code>valueOf()</code>(優先)或<code>toString()</code>將物件取得基本型別的值，再做比較。</p>
<p>而<code>!=</code>和<code>!==</code>就是先分別做<code>==</code>和<code>===</code>再取否定(<code>!</code>)即可。</p>
</li>
</ul>
<p><strong>範例1</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line">a === b <span class="comment">// 答案是？</span></span><br><span class="line">a == b <span class="comment">// 答案是？</span></span><br></pre></td></tr></table></figure>

<p>答案揭曉</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a === b <span class="comment">//false</span></span><br><span class="line">a == b <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>在<code>a == b</code>當中，字串a優先轉為數字後，此時就可比較<code>123==123</code>，因此是相等的(true)</p>
<p><strong>範例2</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line">a === b <span class="comment">// 答案是？</span></span><br><span class="line">a == b <span class="comment">// 答案是？</span></span><br></pre></td></tr></table></figure>

<p>答案揭曉。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a === b <span class="comment">// false</span></span><br><span class="line">a == b <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>在<code>a == b</code>當中，布林a優先轉為數字(<code>Number(true)</code>得到1)後，此時就可比較<code>1 == 123</code>，因此是不相等的(false)。</p>
<p><strong>範例3</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line">a === b <span class="comment">// 答案是？</span></span><br><span class="line">a == b <span class="comment">// 答案是？</span></span><br></pre></td></tr></table></figure>

<p>答案揭曉。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a === b <span class="comment">// false</span></span><br><span class="line">a == b <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>在<code>a == b</code>當中其實比較的是<code>null == 123</code>，因此是不相等的(false)。</p>
<p><strong>範例4</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;1,2,3&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> b = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">a === b <span class="comment">// 答案是？</span></span><br><span class="line">a == b <span class="comment">// 答案是？</span></span><br></pre></td></tr></table></figure>

<p>答案揭曉。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a === b <span class="comment">// false</span></span><br><span class="line">a == b <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>在<code>a == b</code>當中，陣列a由於沒有<code>valueOf()</code>，只好使用<code>toString()</code>取得其基型值而得到字串<code>1,2,3</code>，此時就可比較<code>&#39;1,2,3&#39; == &#39;1,2,3&#39; </code>，因此是相等的(true)。</p>
<p><strong>範例5</strong></p>
<p>有幾個例外需要注意…</p>
<ul>
<li><p>null與undefined沒有其物件包裹形式，因此<code>Object(null)</code>與<code>Object(undefined)</code>等同於<code>Object()</code>, 也就是空物件<code>&#123;&#125;</code>。</p>
</li>
<li><p><code>Number(Nan)</code>得到NaN，且NaN不等於自已。</p>
<p>範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="title class_">Object</span>(a);<span class="comment">// 等同於 Object()</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a == b);<span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c = <span class="literal">undefined</span>;</span><br><span class="line"><span class="keyword">var</span> d = <span class="title class_">Object</span>(c);<span class="comment">// 等同於 Object()</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c == d);<span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> e = <span class="title class_">NaN</span>;</span><br><span class="line"><span class="keyword">var</span> f = <span class="title class_">Object</span>(e);<span class="comment">//等同於new Nummber(e)</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e == f);<span class="comment">//false</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="邊緣情況"><a href="#邊緣情況" class="headerlink" title="邊緣情況"></a>邊緣情況</h4><p>這部份來提一些邊綠(少見但驚人)的狀況。</p>
<h5 id="避免修改原型的valueOf"><a href="#避免修改原型的valueOf" class="headerlink" title="避免修改原型的valueOf(..)"></a>避免修改原型的<code>valueOf(..)</code></h5><p>經由原生的內建函式所建立的值，由於是物件型態，在強制轉型時會經過ToPrimitive的過程，也就是使用<code>valueOf(..)</code>(優先)或<code>toString(..)</code>將物件取得基本型別的值，才會做後續比較。因此，若修改了原型中的<code>toValue(..)</code>方法，則可能會導致比較時出現「不可思議」的結果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Number</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">valueOf</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">2</span>) == <span class="number">3</span>);<span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h5 id="一些瘋狂的範例"><a href="#一些瘋狂的範例" class="headerlink" title="一些瘋狂的範例"></a>一些瘋狂的範例</h5><p>以下會得到什麼結果呢？請小心服用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">false</span> == <span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">false</span> == []);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">false</span> == &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&quot;</span> == <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&quot;</span> == []);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&quot;</span> == &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0</span> == []);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0</span> == &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>([] == ![]);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span> == [<span class="number">2</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&quot;</span> == [<span class="literal">null</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0</span> == <span class="string">&#x27;\n&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>答案揭曉。</p>
<p> 說明</p>
<ul>
<li><p><code>&quot;0&quot; == false;</code>，true，字串轉數字、布林再轉數字</p>
</li>
<li><p><code>false == 0;</code>，true，布林轉數字</p>
</li>
<li><p><code>false == &quot;&quot;;</code>，true，字串轉數字、布林再轉數字</p>
</li>
<li><p><code>false == [];</code>，true，布林轉數字、陣列取toString得到空字串再轉數字</p>
</li>
<li><p><code>false == &#123;&#125;;</code>，false，布林轉數字，物件取valueOf得到空物件</p>
</li>
<li><p><code>&quot;&quot; == 0;</code>，true，字串轉數字</p>
</li>
<li><p><code>&quot;&quot; == [];</code>，true，字串轉數字、陣列取toString得到空字串再轉數字</p>
</li>
<li><p><code>&quot;&quot; == &#123;&#125;;</code>，false，字串轉數字、物件取valueOf得到空物件</p>
</li>
<li><p><code>0 == [];</code>，true，陣列取toString得到空字串再轉數字</p>
</li>
<li><p><code>0 == &#123;&#125;;</code>，false，物件取valueOf得到空物件</p>
</li>
<li><p><code>[] == ![];</code>，true，左手邊取valueOf得到空字串再轉數字得到0，右手邊被！強制轉為布林得到false再轉數字</p>
</li>
<li><p><code>2 == [2];</code>，true，陣列取toString得到空字串再轉數字</p>
</li>
<li><p><code>&quot;&quot; == [null];</code>，true，陣列取toString得空字串，轉數字後得到0</p>
</li>
<li><p><code>0 == &#39;\n&#39;;</code>，true，’\n’意即’’(空白)，轉數字後得到0</p>
</li>
</ul>
<h4 id="總結-：如何安全地使用隱含的強制轉型"><a href="#總結-：如何安全地使用隱含的強制轉型" class="headerlink" title="總結  ：如何安全地使用隱含的強制轉型?"></a>總結  ：如何安全地使用隱含的強制轉型?</h4><p>若允許強制轉型，但又希望能避免「難以預料」的強制轉型(上例), 這裡有一些建議</p>
<ul>
<li><p>若有一邊可能會出現true或false，就不要用<code>==</code>，改用<code>===</code>。</p>
</li>
<li><p>若有一邊可能會出現<code>[]</code>、空字串<code>&quot;&quot;</code>或0，就不要用<code>==</code>，改用<code>===</code>。</p>
</li>
</ul>
<p>以下是一定得安全的強制轉型，使用<code>==</code>即可，不需要用<code>===</code>…</p>
<ul>
<li>比較null與undefined的強制轉型是安全的，因為它們互轉為彼此，一定相等。</li>
<li><code>typeof x</code>得到的是固定的七種字串值(例如：<code>&#39;string&#39;</code>、<code>number</code>、<code>boolean</code>、<code>undefined</code>、<code>function</code>、<code>object</code>、<code>symbol</code>)，因此做<code>typeof x == &#39;指定值&#39;</code>一定是安全的</li>
</ul>
<p>也許世界上大多數的開發都詬病JavaScript中「隱含的強制轉型」的這部份，覺得這是個壞東西，但也許它其實是減少冗贅、反覆套用和非必要實作細節的好方法，而前提是，必須要能清楚了解強型的規則。</p>
<h4 id="JavaScript-Equality-Table"><a href="#JavaScript-Equality-Table" class="headerlink" title="JavaScript Equality Table"></a>JavaScript Equality Table</h4><p>下圖為JavaScript中的相等性，此圖視覺化了所有的比較項目。</p>
<img src="JavaScript-Equality-Table.png" style="zoom:85%;" />

<p>圖片來源：<a href="https://github.com/dorey/JavaScript-Equality-Table">JavaScript Equality Table</a></p>
<h4 id="抽象的關系式比較"><a href="#抽象的關系式比較" class="headerlink" title="抽象的關系式比較"></a>抽象的關系式比較</h4><p>這裡要來談比較運算子(comparsion)的部份，意即<code>&lt;</code>(小於)、<code>&gt;</code>(大於)、<code>&lt;=</code>(小於等於)、<code>&gt;=</code>(大於等於)，例如：<code>a &gt; b</code>表示比較a是否大於b。其比較規則為</p>
<ol>
<li><p>若兩個運算元皆為字串時，就直接依照字典字母順序做比較。</p>
</li>
<li><p>除了1之外的狀況都適用</p>
</li>
</ol>
<ul>
<li>先使用ToPrimitive做強制轉型-先使用<code>valueOf</code>取得基型值，然後再用<code>toString</code>方法轉為字串。</li>
<li>承上，若有任一值轉型後的結果不是字串，就使用Tonumber對規則轉為數字，來做數字上的比較。</li>
</ul>
<p>注意</p>
<ul>
<li>由於<a href="https://es5.github.io/#x11.8.5">規格</a>只定義了<code>a &lt; b</code>的演法，因此<code>a &gt; b</code>會以<code>b &lt; a</code>的方式做比較。</li>
<li>由於沒有「嚴格關系比較」，所以一定會遇到強型機狀況。</li>
</ul>
<p>範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = [<span class="number">12</span>];</span><br><span class="line"><span class="keyword">const</span> b = [<span class="string">&#x27;13&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &lt; b);<span class="comment">// true，&#x27;12&#x27; &lt; &#x27;13&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &gt; b);<span class="comment">// false, 其實是比較 b &lt; a，即 &#x27;13&#x27; &lt;&#x27;12&#x27; </span></span><br></pre></td></tr></table></figure>

<p>範例如下，由於a和b都不定字串，因此先用<code>valueOf</code>取得基型𠶗(只取到原來的物件),，再用<code>toString</code>而得到兩個字串<code>[object Object]</code>，因此比較<code>[object Object]</code>與<code>[object Object]</code>。又<code>a == b</code>比較的是兩物件存取的所在的記憶體位置，也就是參考(reference)。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123; <span class="attr">b</span>: <span class="number">12</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> b = &#123; <span class="attr">b</span>: <span class="number">13</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &lt; b);<span class="comment">// false,&#x27;[object Object]&#x27; &lt; &#x27;[object Object]&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &gt; b);<span class="comment">// false,其實是比較 b &lt; a，即&#x27;[object Object]&#x27; &lt; [object Object]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a == b);<span class="comment">// false,其實是比較兩物件的reference</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &gt;= b);<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a &lt;= b);<span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>這裡要注意的是…</p>
<ul>
<li><code>a &lt;= b</code>其實是<code>!(b &gt; a)</code>，因此<code>!false</code>得到true。</li>
<li><code>a &gt;= b</code>其實是<code>b &lt;= a</code>也就是<code>!(a &gt; b)</code>等同於<code>!false</code>得到true。</li>
</ul>
<h4 id="回顧"><a href="#回顧" class="headerlink" title="回顧"></a>回顧</h4><p>看完這文章，我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>強制轉型(coercion)分為兩種，分別是「明確的」強制轉型(explicit coercion)和「隱含的」強制轉型(implicit coercion)，只要是程式碼中刻意寫出的明顯的型別轉換的動作，就是明確的強制轉型；反之，在程式碼中沒有明確指出要轉換型別卻轉型的，就是隱含的強制轉型。</li>
<li>明確的強制轉型規則與範例說明。</li>
<li>隱含的強制轉型規則與範例說明。</li>
<li>Symbol的強制轉型的規則與範例說明。</li>
<li>隱含的強制轉型的心酸血淚？各動令人崩潰的範例。</li>
<li>抽象的關係式比較。</li>
</ul>
<h3 id="你懂JavaScript嗎？文法-Grammar"><a href="#你懂JavaScript嗎？文法-Grammar" class="headerlink" title="你懂JavaScript嗎？文法(Grammar)"></a>你懂JavaScript嗎？文法(Grammar)</h3><blockquote>
<p>JavaScript的文法是描述其語法(syntax)例如：運算子、關鍵字等，如何結合在一起，形成格式正確的有效程式的一種結構化方式。</p>
</blockquote>
<p>主要會談到</p>
<ul>
<li>述句與運算式、述句完成值和其產生的副作用、解法和好處。</li>
<li>運用運算子優先序與結合性的規則，並顧及程式碼的可讀性。</li>
<li>依賴ASI還是手動加入分號？</li>
<li>錯誤-編譯時期的錯誤、執行時期的錯誤、暫時死亡區域(TDZ)。</li>
<li>try…finally與switch的特殊狀況。</li>
</ul>
<h4 id="述句與運算式-Statements-Expressions"><a href="#述句與運算式-Statements-Expressions" class="headerlink" title="述句與運算式(Statements&amp;Expressions)"></a>述句與運算式(Statements&amp;Expressions)</h4><p>運算式類似片語，經由運算子(類似標點符號或連接詞)將多個運算式組成一個完成的述句。𪞈個運算式都可各自估算其值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">1</span> + <span class="number">2</span>;<span class="comment">//(1)</span></span><br><span class="line"><span class="keyword">const</span> b = a + <span class="number">3</span>;<span class="comment">//(2)</span></span><br><span class="line">b;<span class="comment">//(3)</span></span><br></pre></td></tr></table></figure>

<p>說明</p>
<ul>
<li>運算式有：<code>1 +2</code>(經個算偌3)、<code>a + 3</code>(經估算得到6)、<code>b</code>(經估算得到6)。</li>
<li>(1)和(2) 稱為「宣告述句」(declaration statement)</li>
<li>(1)當中的<code>a = 1 + 2</code>和(2)當中的<code>b = a + 3</code>稱為「指定運算式」(assignment expression)</li>
<li>(3)稱為「運算式述句」(expression statement)</li>
</ul>
<h4 id="述句完成值-Statement-Completion-Values"><a href="#述句完成值-Statement-Completion-Values" class="headerlink" title="述句完成值(Statement Completion Values)"></a>述句完成值(Statement Completion Values)</h4><p>只要是述句都有完成值，就算是undefined。我們常在console頁籤看到最近一次執行結果的述句完成值。</p>
<img src="statement_completion_values.png" style="zoom:85%;" />

<p>由上圖中你可能會觀察到一個有趣的問題，為什麼「<code>const a = 1 + 2;</code>」是得到undefined而非3？</p>
<p>這是因為在<a href="https://es5.github.io/#x12.2">規格</a>中的種種複雜規則運作下，變數的𠍐句(例如:<code>const a</code>)會強制回傳undefined作為完成值。</p>
<p>依此類推，我們也會得到區塊完成值(目前指每個區塊的最後一個述句的完成值)，而為了能真正實現區塊也能得到其回傳值，有興趣的可以看這個提案-<a href="https://github.com/tc39/proposal-do-expressions"><code>do</code> expressions</a>，這樣就可將區塊視為運算式而得到回傳值了。</p>
<p>理解這個「述句完成值」有什麼好處？它可以幫助我們…</p>
<ul>
<li>解決運算式副作用(side effect)的問題</li>
<li>精算程式碼。</li>
</ul>
<h4 id="運算式副作用-Side-Effects"><a href="#運算式副作用-Side-Effects" class="headerlink" title="運算式副作用(Side Effects)"></a>運算式副作用(Side Effects)</h4><p>「述句完成值」的第一個好處是解決運算式副作用的問題，所謂「運算式副作用」其實就是經由運算式而得到的一些非預期結果，來看<code>--a++</code>這個例子。</p>
<p><code>--a++</code>???</p>
<p>這是同時遞增與遞減嗎？</p>
<p>別緊張，當然不是。</p>
<p>由於運算子的優先順序的關系，我們可以想成是這樣的<code>--(a++)</code>，先做遞增，再做遞減。</p>
<p>然而，執行這個運算式是會出錯的，得到ReferenceError，貼到Google翻譯上是說「未捕獲的ReferenceError：前綴操作中的左側表達式無效」。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> b = --a++;</span><br><span class="line">b;<span class="comment">// Uncaught ReferenceError: Invalid left-hand side expression in prefix operation</span></span><br></pre></td></tr></table></figure>

<p>蛤，什麼意思？？</p>
<p>先來看<code>++</code>作為前綴(prefix)與後綴(postfix)的差異，<code>a++</code>和<code>++a</code>的差異是在於這個運算式的結果(意即述句完成值)的回傳動作是在運算前還是後發生的，<code>a++</code>表示是先回傳再運算，而<code>++a</code>是表示先運算再回傳。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> b = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">a++ <span class="comment">// 1，先回傳再運算</span></span><br><span class="line">--b <span class="comment">// 9，先運算再回傳</span></span><br></pre></td></tr></table></figure>

<p>因此，<code>--a++</code>可看成<code>--(a++)</code>，會先得到<code>a++</code>的結果1，接著再做<code>--1</code>，但<code>--</code>只能在變數上運作，而無法用在一個值上，因此丟出了ReferenceError。</p>
<p>救星來了！</p>
<p>幸好，述句序𦕁逗號算子(<code>,</code>)救了我們，<code>,</code>可串起多個述句並回傳最後一個述句的結果作為述句完成值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> b = (a++, --a);</span><br><span class="line">b <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>

<h4 id="精簡程式碼"><a href="#精簡程式碼" class="headerlink" title="精簡程式碼"></a>精簡程式碼</h4><p>「述句完成值」的第二個好處是能精簡程式碼</p>
<p>範例如下，以下是一個確認輸入字串到底有哪些字母是母音的函式，並回傳是母音的字母所構成的陣列</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkVowels</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> matches;</span><br><span class="line">    <span class="keyword">if</span> (str) &#123;</span><br><span class="line">        matches = str.<span class="title function_">match</span>(<span class="regexp">/[aeiou]/g</span>);</span><br><span class="line">        <span class="keyword">if</span> (matches) &#123;</span><br><span class="line">            <span class="keyword">return</span> matches;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">checkVowels</span>(<span class="string">&#x27;Hello World&#x27;</span>));<span class="comment">// [&quot;e&quot;, &quot;o&quot;, &quot;o&quot;]</span></span><br></pre></td></tr></table></figure>

<p>從述句完成值中得知，述句<code>matches = str.match(/[aeiou]/g);</code>會得到一個回傳值，因此可直接將此值拿來做判斷，精簡程式碼如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkVowels</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> matches;</span><br><span class="line">    <span class="keyword">if</span> (str &amp;&amp; (matches = str.<span class="title function_">match</span>(<span class="regexp">/[aeiou]/g</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> matches;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">checkVowels</span>(<span class="string">&#x27;Hello World&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkVowels</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> matches;</span><br><span class="line">    <span class="keyword">return</span> str &amp;&amp; (matches = str.<span class="title function_">match</span>(<span class="regexp">/[aeiou]/g</span>)) ? matches : <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">checkVowels</span>(<span class="string">&#x27;Hello World&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h4 id="取決於上下文的規則-Contextual-Rules"><a href="#取決於上下文的規則-Contextual-Rules" class="headerlink" title="取決於上下文的規則(Contextual Rules)"></a>取決於上下文的規則(Contextual Rules)</h4><p>這部份我們來看一些「語法相同，但在不同環境中有不同意義」的狀況。</p>
<h4 id="大括號-Curly-Braces"><a href="#大括號-Curly-Braces" class="headerlink" title="大括號({..}Curly Braces)"></a>大括號(<code>&#123;..&#125;</code>Curly Braces)</h4><p>大括號(<code>&#123;..&#125;</code>Curly Braces)在不同環境中有不同意義的狀況有-物件字面值(object literal)、區塊(block)、物件解構(object destructuring)，以下分別述之。</p>
<ul>
<li><p>物件字面值(object literal):將值<code>&#123;..&#125;</code>指定給某個變數。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">	<span class="attr">foo</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>區塊(block):𢥢用<code>&#123;..&#125;</code>標示程試碼的區塊範圍</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (flag) &#123;</span><br><span class="line">	<span class="comment">// do something...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之前有一個範例</p>
<p><code>[] + &#123;&#125;</code> 與 <code>&#123;&#125; + []</code>。</p>
<p>先猜猜看結果是什麼？</p>
<p>皆為<code>[object Object]</code>?</p>
<p>公佈答案</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[] + &#123;&#125; <span class="comment">// &quot;[object Object]&quot;</span></span><br><span class="line">&#123;&#125; + [] <span class="comment">// 0</span></span><br></pre></td></tr></table></figure>

<p><code>[]+&#123;&#125;</code>中，<code>[]</code>會轉為空字串，而<code>&#123;&#125;</code>會轉為字串<code>&quot;[object Object]&quot;</code>。<code>&#123;&#125; + []</code>中，<code>&#123;&#125;</code>被當成空區塊而無作用，<code>+[]</code>被𡮝成強制轉型為數字<code>Number([])</code>（由於陣列是物件，中間會先使用<code>toString</code>轉成空字串，導致變成<code>Number(&#39;&#39;)</code>而得到0。</p>
</li>
<li><p>物件解構(object destructuring):這裡的<code>&#123;..&#125;</code>表示解構指定式(destructuring assignment)的物件的解構。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123; <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>, <span class="attr">foo</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125; &#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">foo</span> = (<span class="params">&#123; name &#125;</span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(a);<span class="comment">// Hi, I am Jack</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="else-if-與選擇性區塊"><a href="#else-if-與選擇性區塊" class="headerlink" title="else if 與選擇性區塊"></a>else if 與選擇性區塊</h4><p><code>else if</code>這樣的語法並不存在！</p>
<p>那這是什麼？？？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (a) &#123;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (b) &#123;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>else if</code>其實只是因為if或else後若只接㽞一述句，就可以省略大括號<code>&#123;..&#125;</code>的緣故。因此，上例的程式碼其實是這樣的…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (a) &#123;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (b) &#123;</span><br><span class="line">        <span class="comment">// ..</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ..</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="運算子優先序-Operator-Precedence"><a href="#運算子優先序-Operator-Precedence" class="headerlink" title="運算子優先序(Operator Precedence)"></a>運算子優先序(Operator Precedence)</h4><p>了解運算子優先序有助於我們理解程式碼什麼時候會執行(短路)、怎麼分批執行(結合性)。</p>
<h5 id="Operator-Precedence-Table"><a href="#Operator-Precedence-Table" class="headerlink" title="Operator Precedence Table"></a>Operator Precedence Table</h5><p>MDN整理了一份<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Operator_Precedence#Table">「運算子優先序」清單</a>，截圖如下。</p>
<p>運算子優先順序由高(20)至低(1)排列</p>
<img src="operator_precedence_table.png" style="zoom:85%;" />

<p>圖片來源：<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Operator_Precedence#Table">Operator precedence table</a></p>
<h5 id="短路-Short-Circuited"><a href="#短路-Short-Circuited" class="headerlink" title="短路(Short Circuited)"></a>短路(Short Circuited)</h5><p>之蠕提過「選擇器運算子」(operand selector operator)的<code>&amp;&amp;</code>(and)和<code>||</code>(or)的功用，其中，若運算子左手邊的運算元可估算出結果，右手邊的運算元更不會被估算，此情況稱為「短路」(shot circuited)。</p>
<p>應用這重短路的行為的範例如下，若flag條件成立(true)，就執行函式foo;反之，就不執行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> flag = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;try me&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">flag &amp;&amp; <span class="title function_">foo</span>();<span class="comment">// try me</span></span><br></pre></td></tr></table></figure>

<p>短路其實某方面和if述句滿像的，如果判斷的條件不複雜或執行的工作不多，𠞽路可說是更為精簡易懂的寫法。</p>
<h4 id="結合性-Associativity"><a href="#結合性-Associativity" class="headerlink" title="結合性(Associativity)"></a>結合性(Associativity)</h4><p>說到運算子優先順序研一定會談到結合性，這牽涉到執行複雜運算時要怎麼幫運算式分組，有多個相同優先順序的運算子時該怎麼處理的議題。</p>
<p>結合性分為</p>
<ul>
<li><p>左結合，意即由左至右處理，例如：<code>&amp;&amp;</code>、<code>||</code>。</p>
</li>
<li><p>右結合，意即由右至左處理，例如：三元運算子<code>條件 ？ 值1 ： 值2</code>、指定運算子<code>var a = b = c = 123 </code>。</p>
<p>猜猜看以下這段式碼要怎麼分組。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a ? b : c ? d : e</span><br></pre></td></tr></table></figure>

<p>是<code>(a ? b : c) ? d: e</code>或<code> a ? b :(c ? d: e)</code>?</p>
<p>答案是後者<code> a ? b :(c ? d: e)</code>，因為三元運算子是右結合，從右到左來分組。</p>
<p>了解運算子優先順序與結合性的規則，開發者在撰寫程式碼才能「清除歧義」，建議在運用運算優覺順序與結合性的甸時，也手動使用小括號<code>(..)</code>歸組以顧及程式碼可讀性。</p>
<h4 id="自動分號插入-Automatic-Semicolon-Insertion-ASI"><a href="#自動分號插入-Automatic-Semicolon-Insertion-ASI" class="headerlink" title="自動分號插入(Automatic Semicolon Insertion,ASI)"></a>自動分號插入(Automatic Semicolon Insertion,ASI)</h4><p>JavaScript引擎中的剖析器(parser)會在以下情況下，自動幫程式碼補上分號，以避免剖析失敗。</p>
<ul>
<li>換行，即述句結尾處與下一行之間，除了空白和註解外，沒有其他的程式碼。</li>
<li>break、continue、return、yield之後。</li>
</ul>
<p>不需要ASI的情況是</p>
<ul>
<li>區塊(<code>&#123;...&#125;</code>)不需要分號做終結。</li>
</ul>
<p>範例如下。</p>
<p>範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    a--</span><br><span class="line">&#125; <span class="keyword">while</span> (a &gt; <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>說明</p>
<ul>
<li><code>a--</code>後需要一個分號<code>;</code></li>
<li><code>while (a &gt; 1)</code>後需要一個分號<code>;</code></li>
</ul>
<p>關於到底要不要加分號這個議題，真的有非常非常多的討論…像是</p>
<ul>
<li><a href="http://oldblog.eddychang.me/blog/javascript/97-js-semicolon.html">JavaScript 裡的語句用分號結尾是個選項嗎</a></li>
<li><a href="https://github.com/airbnb/javascript#semicolons">Airbnb JavaScript Style Guide: Semicolons</a></li>
</ul>
<p>就我個人而言，都是會好好如上分號的, 因為不加分號的意思不就是「我弄壞了但要別人幫我擦屁股」的意思嗎？…</p>
<p>並且，邀請大定加入<a href="https://eslint.org/">ESLint</a> 的行列，使用工具自動檢視程式碼中微小但重要的問題！</p>
</li>
</ul>
<h4 id="錯誤-Errors"><a href="#錯誤-Errors" class="headerlink" title="錯誤(Errors)"></a>錯誤(Errors)</h4><h5 id="編譯時期的錯誤"><a href="#編譯時期的錯誤" class="headerlink" title="編譯時期的錯誤"></a>編譯時期的錯誤</h5><p>編譯或剖析時期丟出來的錯誤，由於程式尚未執行，因此無法以<code>try...catch</code>捕捉。</p>
<ul>
<li>SyntaxError，例如：無效的正規表達式<code>var a = /+foo/;</code></li>
<li>ReferenceError，例如：不合法的指定運算式<code>var a; 42 = a;</code></li>
</ul>
<h4 id="執行時期的錯誤"><a href="#執行時期的錯誤" class="headerlink" title="執行時期的錯誤"></a>執行時期的錯誤</h4><ul>
<li><p>TypeError，例如：重新設正已宣告為const變數<code>const a = 2; a = 4; </code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    a = <span class="number">4</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e);<span class="comment">//TypeError: Assignment to constant variable</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="暫時死亡區域-Temporal-Dead-Zone-TDZ"><a href="#暫時死亡區域-Temporal-Dead-Zone-TDZ" class="headerlink" title="暫時死亡區域(Temporal Dead Zone, TDZ)"></a>暫時死亡區域(Temporal Dead Zone, TDZ)</h4><p>ES6定義了「暫時死亡區域」(Temporal Dead Zone,TDZ)，意思是程式碼中某個部份的變數的參考動作還不能執行的地方，這是因為該變數尚未被初始化的綠故。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    a = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <a href="#%E6%9C%AA%E5%AE%9A%E7%BE%A9-undefined-vs%E6%9C%AA%E5%AE%A3%E5%91%8A-uneclared">之前</a>提到typeof對於尚未宣告的變數可有保護機制，但在這裡是無效的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    typeof a;</span><br><span class="line">    typeof b;</span><br><span class="line">    let b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="try-finally"><a href="#try-finally" class="headerlink" title="try..finally"></a>try..finally</h4><p>try區塊的內容vs finally區壞的內容，到底是誰會先執行?誰會後執行?</p>
<p>先來看第一個例子。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">12345</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">foo</span>());</span><br></pre></td></tr></table></figure>

<p>顯示結果為</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Hello World</span><br><span class="line">12345</span><br></pre></td></tr></table></figure>

<p>從結果看起來，似手難以判斷???</p>
<p>再來看第二個例子。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">12345</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">foo</span>());</span><br></pre></td></tr></table></figure>

<p>顯示結果為</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Hello World</span><br><span class="line">12345</span><br></pre></td></tr></table></figure>

<p>從執行順序來看，的確是先執行try區壞，再來才是finally區塊，但「述句完成值」會決定結果的「顯示」順序。首先，會先執行區塊的內容，像是<code>console.log(..)</code>，再來才是執行函式<code>foo()</code>回傳完成值，因此，在第一 個例子中，會先顯示「Hello World」，再顯示「12345」。而在第二個例子中，的確會覆寫try內的回傳伹，而成為這個函式最後的完成值因此得到12345</p>
<h4 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h4><p>switch述句等同於if-else的縮寫，依靠break來決定是否要持續進行下一個case述句，若沒有break磺會「落穿而過」。</p>
<p>範例如下，這裡有一個檢測庫存的簡易範例，假設目前庫存數曉為50，當庫存為0～2時提示要趕快進貨補庫存，庫存到達50時顯示庫存充裕，庫存到達100時提示貨品是不是賣不掉，其化狀況都顯示為運作正常。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="number">50</span>;</span><br><span class="line"><span class="keyword">switch</span> (count) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;快賣完了！趕快進貨！&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">50</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;庫存充裕&#x27;</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">100</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;是不是賣不掉了！？&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;運作正常&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但出乎意料的是，結果印出「庫存充裕、是不是賣不掉了！？」。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">庫存充裕</span><br><span class="line">是不是賣不掉了！？</span><br></pre></td></tr></table></figure>

<p>這是因為如果沒有如入break，一旦某個符合條件了，接下來的case無論符合與否都會被執行，也就是剛才所提到的「落穿而過」。</p>
<p>加入break修改正下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="number">50</span>;</span><br><span class="line"><span class="keyword">switch</span> (count) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;快賣完了！趕快進貨！&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">50</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;庫存充裕&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">100</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;是不是賣不掉了！？&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;運作正常&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果印出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">庫存充裕</span><br></pre></td></tr></table></figure>

<p>另外，switch所做的比對是嚴格相等(<code>===</code>)，若希望能使用寬鬆相等(<code>==</code>)而能有強制轉制的功能，就需要改變一下寫法，像是…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="string">&#x27;12345&#x27;</span>;</span><br><span class="line"><span class="keyword">switch</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> a == <span class="number">10</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;10 or &#x27;10&#x27;&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> a == <span class="number">12345</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;12345 or &#x27;12345&#x27;&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">        <span class="comment">//不會到達這裡的</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果得到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">12345 or <span class="string">&#x27;12345&#x27;</span></span><br></pre></td></tr></table></figure>

<p>最後，default不一定要放在最後，順序是什麼並不重要喔！</p>
<h4 id="回顧-1"><a href="#回顧-1" class="headerlink" title="回顧"></a>回顧</h4><p>看完這篇文章，我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li><p>述句與運算式，述句完成值和其產生的副作用，解法和好處。</p>
</li>
<li><p>運用運算升優先序與結合性的規性的規則，並顧及程式碼的可讀性。</p>
</li>
<li><p>依賴ASI還是手動加入分號？我個入偏好要加分號！也𩏑薦大家使用ESLint！</p>
</li>
<li><p>錯誤-編譯時期的錯誤、執行時期的錯誤、暫時死亡區域(TDZ)。</p>
</li>
<li><p>try…finally與switch的特特殊狀況。</p>
<h5 id="References"><a href="#References" class="headerlink" title="References"></a>References</h5><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/types%20%26%20grammar/ch5.md">You Don’t Know JS: Types &amp; Grammar, Chapter 5: Grammar</a></li>
</ul>
</li>
</ul>
<h3 id="你懂JavaScript嗎-範疇（Scope）"><a href="#你懂JavaScript嗎-範疇（Scope）" class="headerlink" title="你懂JavaScript嗎?範疇（Scope）"></a>你懂JavaScript嗎?範疇（Scope）</h3><p>本文會提到</p>
<ul>
<li>什麼是「範疇」?範疇的功用是？</li>
<li>編譯器怎麼理解程式碼？</li>
<li>什麼是巢狀範疇？</li>
<li>從LHS與RHS來理解JavaScript查找變數的報錯機制。</li>
</ul>
<h4 id="範疇（Scope）"><a href="#範疇（Scope）" class="headerlink" title="範疇（Scope）"></a>範疇（Scope）</h4><p>範疇（Scope）是指編繹器或JavaScript引擎藉由識別字名稱(identifier name)查找變數的一組規則。</p>
<h4 id="編譯器怎麼理解程式碼"><a href="#編譯器怎麼理解程式碼" class="headerlink" title="編譯器怎麼理解程式碼?"></a>編譯器怎麼理解程式碼?</h4><p>編譯器會在程式執行前將程碼由上到下逐行轉為電腦可懂的命令，稍後會執行這個編譯後的結果。注意，JavaScript引擎會在每次執行前即時編譯程式（約幾毫秒(ms)而已），接著立刻執行編譯後的指令。</p>
<p>編譯有三𦂇驟</p>
<ul>
<li><p>語法基本單元化與語彙分析（tokenizing&#x2F;lexing）：將字串解析成token，例如：<code>var a=2;</code>就會解析<code>var</code>、<code>a</code>、<code>=</code>、<code>2</code>、<code>;</code>。</p>
</li>
<li><p>剖析或稱語法分析（parsing）：承上，將這些token（<code>var</code>、<code>a</code>、<code>=</code>、<code>2</code>、<code>;</code>）組成抽象語法樹（abstract syntax tree，AST）</p>
<img src="ast.png" style="zoom:50%;" />

<ul>
<li>產生目的程式碼（code-generation）：承上，將AST轉為可執行的程式碼，通常是機器語言，在這裡也會做最佳化。</li>
</ul>
</li>
</ul>
<h4 id="範疇的功用是？"><a href="#範疇的功用是？" class="headerlink" title="範疇的功用是？"></a>範疇的功用是？</h4><p>  在編譯的過程中，JavaScript引擎，編譯器和範疇會互相溝通以完成工作，它們各自負責的任睥有</p>
<ul>
<li>JavaScript引擎：負責整個編譯過程並執行程式碼。</li>
<li>編譯器：負責編譯三步驟-語法基本單元化與語彙分析，剖析或稱語法分析，產生目的程式碼</li>
<li>範疇：負責維護變數清單。</li>
</ul>
<p>  範例如下，這裡有一段程式碼，在編譯這段程式碼時，JavaScript引擎，𤚴譯器和範疇三者會做什麼呢？</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li>在編譯的時候，編譯器會先到範疇詢問變數a是否存在，若不存在就宣告這個a變數。</li>
<li>接著，在執行階段，JavaScript引擎先到範疇詢問變數a是否存在，若存在就將2設定給它；若a不存在就報錯。</li>
</ol>
<p>  其中，引擎對範疇的查找變數的動作，可分為兩種類型</p>
<ul>
<li>LHS（left-hand side）：要查找的變數在指定動作的左邊，例如：<code> a = 2</code>的a在等號的左邊，就是執行LHS查找動作。</li>
<li>RHS（right-hand side）：變數不在指定動作的左邊，例如：<code>console.log(a)</code>，就是執行RHS查找動作。</li>
</ul>
<p>  備註：函式宣告（例如：<code>function foo() &#123;...&#125;</code>）並不是LHS！這是因為在做函式宣告時，就同時做了宣告和值的定義，而非在執行階段設定其值。</p>
<h4 id="巢狀範疇（Nested-Scope）"><a href="#巢狀範疇（Nested-Scope）" class="headerlink" title="巢狀範疇（Nested Scope）"></a>巢狀範疇（Nested Scope）</h4><p>若在目前執行的範疇找貨到這個變數的時候，就會往外層的範疇搜尋，持續搜尋直到找到為止，或直到最外層的全域範疇（global scope）; 而這樣一層又一層的範疇就稱為「巢狀範疇」(nested scope)。</p>
<p>如下。<code>conole.log(a + b)</code>中，b的RHS無法在foo中解析完成，但可到全域範疇解析出來。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">foo</span> = (<span class="params">a</span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a + b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="title function_">foo</span>(<span class="number">2</span>);<span class="comment">//4</span></span><br></pre></td></tr></table></figure>

<h4 id="錯誤（Error）"><a href="#錯誤（Error）" class="headerlink" title="錯誤（Error）"></a>錯誤（Error）</h4><p>為什麼需要理解LHS和RHS呢？這是因為要看懂JavaScript報錯的原因。</p>
<p>當解析identifier失敗時</p>
<ul>
<li>若是RHS，則會丟出ReferrenceError的訊息</li>
<li>若是LHS，就會分為是否在嚴格模式(strict mode)的情況<ul>
<li>在非嚴格模式下，會在全域建立這個變數。</li>
<li>在嚴格模式下，會丟出ReferrenceError的訊息。</li>
</ul>
</li>
</ul>
<p>還有一種狀況，不論在LHS和RHS下，操作不合法的行為時，就會丟出TypeError的訊息。</p>
<ul>
<li>LHS：重新設定已宣告為const變數，<code>const a = 2; a = 4;</code>的<code>a = 4</code>會導致TypeError。</li>
<li>RHS：執行不是function的變數，<code>const b = 2; b();</code>的<code>b()</code>會導致TypeError。</li>
</ul>
<p><strong>範例</strong></p>
<p>這裡有一個小範例，判斷哪裡發生了LHS？哪裡發生了RHS？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">foo</span> = (<span class="params">a</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> b = a;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> c = <span class="title function_">foo</span>(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p><strong>LHS</strong></p>
<ol>
<li><code>const c= ...</code></li>
<li><code>const b=...</code></li>
<li>隱點的參數設定<code>a = 2</code></li>
</ol>
<p><strong>RHS</strong></p>
<ol>
<li><code>const b = a</code>其中的<code>... = a</code>對a取值</li>
<li><code>return a + b</code>其中要對a取值</li>
<li><code>return a + b</code>其中要對b取值</li>
<li><code>foo(a)</code>其中要對foo取得其函數</li>
</ol>
<h4 id="回顧-2"><a href="#回顧-2" class="headerlink" title="回顧"></a>回顧</h4><p>我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>範疇是指編讀器或JavaScirpt引擎藉由識別字名稱查找變數的一組規則。</li>
<li>編譯器會在程式執行前將程式碼由上到下逐行轉為電腦可懂的命令，而稍後執行的即是這個編譯後的結果。編譯有三步驟：語法基本單元化夷語彙分析、剖析或稱語法分析、產生目的程式碼。並且，在編譯的過程中，JavaScript引擎、和範疇會互相溝通以完成工作。</li>
<li>在查找變數的過程中，若在目前執行的範疇找不到這個變數的時候，就會往外層的範疇搜尋，持續搜尋直到找到為止，或直到最外層的全域範疇。</li>
<li>從LHS與RHS來理解JavaScript查找變數的報錯機制。</li>
</ul>
<h4 id="References-1"><a href="#References-1" class="headerlink" title="References"></a>References</h4><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/ch1.md">You Don’t Know JS: Scope &amp; Closures, Chapter 1: What is Scope?</a></li>
</ul>
<h3 id="你懂JavaScript？語彙範疇（Lexical-Scope）"><a href="#你懂JavaScript？語彙範疇（Lexical-Scope）" class="headerlink" title="你懂JavaScript？語彙範疇（Lexical Scope）"></a>你懂JavaScript？語彙範疇（Lexical Scope）</h3><p>本文會提到</p>
<ul>
<li>什麼是語彙範疇？這階段要做什麼事情？</li>
<li>什麼會改變語彙範疇？有什麼影響？</li>
</ul>
<h4 id="語彙範疇（Lexical-Scope）"><a href="#語彙範疇（Lexical-Scope）" class="headerlink" title="語彙範疇（Lexical Scope）"></a>語彙範疇（Lexical Scope）</h4><p>範疇的運作方式有兩種-語彙範疇（Lexical scope）和動態範疇（dynamic scope），在這裡先來探討「語彙範疇」。</p>
<p>語彙分析階段會將字串解析成token，例如：<code>var a = 2;</code>會解析為<code>var</code>、<code>a</code>、<code>=</code>、<code>2</code>、<code>;</code>。語彙範疇是在語彙分析時期所定義的範疇，剛範疇的劃分在程式碼撰寫時就決定好了，之後任何企圖修改的行為都是不恰當的。</p>
<p>參考以下程式碼，試著區分有幾個範疇？誰是誰的巢狀範疇？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> b = a * <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params">c</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">bar</span>(b * <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(<span class="number">2</span>);<span class="comment">// 2 4 12</span></span><br></pre></td></tr></table></figure>

<img src="fig2.png" style="zoom:85%;" />

<p>圖片來源：[You Don’t Know JS: Scope &amp; Closures, Chapter 2: Lexical Scope](<a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope">https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope</a> %26 closures&#x2F;ch2.md)</p>
<p>這裡有三個範疇…</p>
<ul>
<li>(1)最外面的範疇即全域範疇，識別字有foo。</li>
<li>(2)中間的範疇是在foo裡面，識別字有a、b、bar。</li>
<li>(3)最裡面的範疇是在bar裡面，識別字只有c。</li>
</ul>
<h4 id="查找識別字"><a href="#查找識別字" class="headerlink" title="查找識別字"></a>查找識別字</h4><p>從上例可知，範疇的劃分說明了JavaScript引擎如何尋找識別字的所在之處。</p>
<p>這裡還要談兩個觀念「遮蔽（shadowing）」和「全域變數（global variable）」。</p>
<ul>
<li>遮蔽（shadowing）：若相同的識別字同時出現在不同的巢狀範疇中，那麼只履在巢狀範疇內層找偌第一個符合的識別字就會停止搜尋。</li>
<li>全域變數（global variable）：全域變數會自動變成全堿物件的屬性，因此能使用<code>window.a</code>來避免a被巢狀範疇內層的同名變數遮蔽。</li>
</ul>
<p>備註：範疇的查找只適用於一級識別字，例如：a、b這樣單層的名稱。如果是要找foo.bar.a的話，範疇的查找冬會找到foo，之後的bar和a就會由物件存萬規則（object property-access rules）來繼續解析。</p>
<h4 id="什麼會變變語彙範疇？有什麼影響？"><a href="#什麼會變變語彙範疇？有什麼影響？" class="headerlink" title="什麼會變變語彙範疇？有什麼影響？"></a>什麼會變變語彙範疇？有什麼影響？</h4><p>取兩個方法會在執行時修變語彙範疇-eval和with。</p>
<h5 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h5><p>範例如下，在foo內執行eval，導致<code>console.log(...)</code>時JavaScript引擎尋找b時在foo這範疇找偌(其值為3)，而遮蔽了全域的b(其值為2)。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">str, a</span>) &#123;</span><br><span class="line">    <span class="built_in">eval</span>(str);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="title function_">foo</span>(<span class="string">&#x27;var b=3;&#x27;</span>, <span class="number">1</span>);<span class="comment">// 1 3</span></span><br></pre></td></tr></table></figure>

<p>eval很邪惡，好孩子不要用！</p>
<h5 id="with"><a href="#with" class="headerlink" title="with"></a>with</h5><p>with會在執行時創建新的語彙範疇，這裡來看一個全域值外𣼣的例子。</p>
<p>當with區塊執行時，with將物件參考當成範疇來看，𫍇個物件的特性就會成為該範疇內的識別字。因此，<code>a = 2</code>其實是在做LHS的動作，若在o2和foo的範疇找到a，就會往全域範疇來找，由於在此並非嚴格模式，因此在找不到的情況下，就會生一個全域變數a並設定其值為2。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">with</span> (obj) &#123;</span><br><span class="line">        a = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> o1 = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">3</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> o2 = &#123;</span><br><span class="line">    <span class="attr">b</span>: <span class="number">3</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_">foo</span>(o1);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(o1.<span class="property">a</span>);<span class="comment">//2</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(o2);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(o2.<span class="property">a</span>);<span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// 2,全域值外𣼣</span></span><br></pre></td></tr></table></figure>

<p>幸好，with已被禁止使用了。</p>
<h4 id="為什麼eval和with會導致效能不佳？"><a href="#為什麼eval和with會導致效能不佳？" class="headerlink" title="為什麼eval和with會導致效能不佳？"></a>為什麼eval和with會導致效能不佳？</h4><p>JavaScript引擎會編譯時期進行最佳化，例如，靜態分析程碼，確定變數和函式的宣告，這樣在執行時期就能節省解析識別字的成本。</p>
<p>但若在程式碼中有eval或with，剛剛在編譯時期所確認的變數和函式的所式位置的結果都無效了，因為JavaScript引擎無法在編譯時期確認到底傳入什麼東西給eval或有什麼內容會讓with創建新的語彙範疇，所以也就不知道有什麼會改變誥彙範疇了，也就是說，剛剛所做的最佳化都沒有意義了，JavaScript引擎可考慮乾脆不要最佳化，因此程式碼就會跑得比較慢。效能比較差。</p>
<h4 id="回顧-3"><a href="#回顧-3" class="headerlink" title="回顧"></a>回顧</h4><p>看完這篇文章，我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>語彙範疇是在語彙分析時期定義的範疇，而範疇的劃分在程碼撰寫時就決定好了，之後任何企圖修改行為都是不恰當的。</li>
<li>範疇是編譯器或JavaScript引擎藉由識別字名稱查找變數的三組規則。其中，「遮蔽」是指只要找到巢狀範疇內第一個符合的識別字就會停籍搜尋； 「全域變數」必須使用<code>window.x</code>來避免被內層變數遮蔽； 範疇的查找只適用於單層的識別字名稱，若為多層則是由物件存取規則來做解析。</li>
<li>eval和with由於會修改語彙範疇，讓編譯時期所做的工都白費，因此效能不佳，應避免使用。</li>
</ul>
<h4 id="References-2"><a href="#References-2" class="headerlink" title="References"></a>References</h4><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/ch2.md">You Don’t Know JS: Scope &amp; Closures, Chapter 2: Lexical Scope</a></li>
</ul>
<h3 id="你懂JavaScript？函式範疇與區塊範疇（Function-vs-Block-Scope）"><a href="#你懂JavaScript？函式範疇與區塊範疇（Function-vs-Block-Scope）" class="headerlink" title="你懂JavaScript？函式範疇與區塊範疇（Function vs Block Scope）"></a>你懂JavaScript？函式範疇與區塊範疇（Function vs Block Scope）</h3><p>本文會提到</p>
<ul>
<li>範疇的劃分單位可分為兩種-函式範疇與區塊範疇，它們有什麼不同？各有什麼優點？</li>
<li>函式範疇的重要觀念與相關應用-函式宣告與函式運算式、匿名與具名函式、即刻調用函式運算式。</li>
<li>區塊範疇的重要觀念與相關應用-const與let、垃圾回收。</li>
</ul>
<h4 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h4><p>「範疇」（scope）是指編譯器或JavaScript引擎藉由識別字名稱查找變數的一組規則，而劃分範疇的單位可分為兩種-函式範疇與區塊範疇，也就是說，每個「函式」或「區塊」是可以建立各自的範疇，在ES6以前，只有函式能建立範疇，而在ES6之後，可用大括號<code>&#123;...&#125;</code>定義區塊範疇，讓const和let宣告以區塊為範疇的變數。</p>
<h4 id="函式範疇（Function-Scope）"><a href="#函式範疇（Function-Scope）" class="headerlink" title="函式範疇（Function Scope）"></a>函式範疇（Function Scope）</h4><p>函式會建立自已的範疇，其內的識別字（不管是變數、函式）僅能在這個函式裡面使用。</p>
<p>範例如下，在全域範疇底下，是無法存取foo內a、b、c和bar，否則會導致ReferrenceError；但在foo自已的函式範疇內，可以存取a、b、c和bar。</p>
<p>foo可自由存其內的a、b、c和bar</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> c = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">//2</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(b);<span class="comment">//2</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(c);<span class="comment">//3</span></span><br><span class="line">    <span class="title function_">bar</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>全域範疇之下是無法存取foo內的a、b、c和bar的，但可存取foo喔！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> c = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// ReferrenceError</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b); <span class="comment">// ReferrenceError</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c); <span class="comment">// ReferrenceError</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">bar</span>(); <span class="comment">// ReferrenceError</span></span><br></pre></td></tr></table></figure>

<h4 id="使用「函式範疇」有什麼好處？"><a href="#使用「函式範疇」有什麼好處？" class="headerlink" title="使用「函式範疇」有什麼好處？"></a>使用「函式範疇」有什麼好處？</h4><p>使用「函式範疇」有什麼好處？或說解決什麼問是呢？大致上有這兩點…</p>
<ul>
<li>維持最小權限原則，以避免變數或函式被不當存取。</li>
<li>避免同名識別字所造成的衝突，這當中包含了避免污染全域命名空間和模組的管理。</li>
</ul>
<h4 id="最小權限原則"><a href="#最小權限原則" class="headerlink" title="最小權限原則"></a>最小權限原則</h4><p>函式範疇能維挫「最小權限原則」（principle of least privilege），或稱為「最小授權」（least authority）、「最小暴露」（least exposure），可防止變數或函式被不當存取。</p>
<p>範例如下，secretData是foo的私有變數，可能是儲存了foo之外其他程式碼不需要知道的資料，因此對於其他地方（包含全域範疇）的程式碼來說，是無法直接存取到secretData的，只能透過foo公開的API「bar」取得經過處理後的資料，如publicData。這樣的好處是，除了foo之外是無法經由任何管道修改它的私有變數secretData的，可防止其伳地方的程式碼的不當存取。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> secretData = <span class="string">&#x27;HelloWorld&#x27;</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> secretData.<span class="title function_">split</span>(<span class="string">&#x27;&#x27;</span>).<span class="title function_">join</span>(<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        bar</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> baz = <span class="title function_">foo</span>();</span><br><span class="line"><span class="keyword">var</span> publicData = baz.<span class="title function_">bar</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(publicData);<span class="comment">// H-e-l-l-o-W-o-r-l-d</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(secretData);<span class="comment">// Uncaught ReferenceError: secretData is not defined</span></span><br></pre></td></tr></table></figure>

<h4 id="避免衝突"><a href="#避免衝突" class="headerlink" title="避免衝突"></a>避免衝突</h4><p>避免同名變數或函式所造成的衝突。</p>
<p>如下範例，這裡有兩個函式doSomething與doSomethingElse。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    b = a + <span class="title function_">doSomethingElse</span>(a * <span class="number">2</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(b * <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doSomethingElse</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> b;</span><br><span class="line"></span><br><span class="line"><span class="title function_">doSomething</span>(<span class="number">2</span>); <span class="comment">// 15</span></span><br></pre></td></tr></table></figure>

<p>若此時還有一個同名的函doSomethingElse，就會導致衝突，回傳的答案就不是原本預期的15，而是12。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    b = a + <span class="title function_">doSomethingElse</span>(a * <span class="number">2</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(b * <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doSomethingElse</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> b;</span><br><span class="line"></span><br><span class="line"><span class="title function_">doSomething</span>(<span class="number">2</span>); <span class="comment">// 12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doSomethingElse</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a - <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改寫如下，將doSomething私有的細節（也就是第一個doSomethingElse函式）藏在其範疇中，這樣兩個doSomethingElse函式就不會造成衝突了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    b = a + <span class="title function_">doSomethingElse</span>(a * <span class="number">2</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(b * <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doSomethingElse</span>(<span class="params">a</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> a - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b;</span><br><span class="line"></span><br><span class="line"><span class="title function_">doSomething</span>(<span class="number">2</span>); <span class="comment">// 15</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doSomethingElse</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a - <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再看一個例子，如下，函式bar內的 i 是個全域變數，它無意間修改的 foo loop 的 i，導致 i 永遠都是 3，而進入了無窮迴圈。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params">a</span>) &#123;</span><br><span class="line">        i = <span class="number">3</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">bar</span>(i * <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<p>解法是將bar內的 i 宣告為區域變數，這樣就會將這個 i 包在bar的範疇裡面，避免被其他不相干的程式碼存取。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params">a</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">3</span>;<span class="comment">// 將 bar 內的 i 宣告為區域變數</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">bar</span>(i * <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<h4 id="全域命名空間（Global-Namespace）"><a href="#全域命名空間（Global-Namespace）" class="headerlink" title="全域命名空間（Global Namespace）"></a>全域命名空間（Global Namespace）</h4><p>通常我們使用的函式庫都適當的隱藏自已內部所使用的變數和函式，意即將它們做成某物件屬性和方法而非暴露在全域底下，而物件即是它們的命名空間（namespace），這樣就可以避免在全域範疇中因同名而產生的衝突。</p>
<p>範例如下，物件MyReallyCoolLibrrary內含有屬性awesome和方法doSomething與doAnotherThing，可避免全域範疇中也有同名的變數awesome或函式doSomething或doAnotherThing。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">MyReallyCoolLibrary</span> = &#123;</span><br><span class="line">    <span class="attr">awesome</span>: <span class="string">&#x27;stuff&#x27;</span>,</span><br><span class="line">    <span class="attr">doSomething</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">doAnotherThing</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="模組管理（Module-Management）"><a href="#模組管理（Module-Management）" class="headerlink" title="模組管理（Module Management）"></a>模組管理（Module Management）</h4><p>除了使用前面提到的命名空間來避免衝突外，另一個解法是使用模組（module），藉由工具（例如：webpack）產生相依管理機制，避免函式衷新增依何識別字到全域範疇，而是要求函式庫將識別字匯入（import）至特定的範疇，模組管理機級並沒有跳脫範疇的掌控，而是巧妙地避免污全域範疇，將函式庫的識別字保持在私有範疇中，解決了衝突的問題。若不使用工具，也可在撰寫程式碼時使用模組模式（module pattern）。</p>
<h4 id="即刻調用函式運算式Immediately-Invoked-Function-Expression-IIFE）"><a href="#即刻調用函式運算式Immediately-Invoked-Function-Expression-IIFE）" class="headerlink" title="即刻調用函式運算式Immediately Invoked Function Expression,IIFE）"></a>即刻調用函式運算式Immediately Invoked Function Expression,IIFE）</h4><p>IIFE是可立即執行的函式運算式，主要好處是不污染全域範疇，並且匿名或具名皆合法。</p>
<p>在談論IIFE前，先來看幾個重要觀念</p>
<ul>
<li>函式宣告 vs 函式運算式</li>
<li>匿名 vs 具名</li>
</ul>
<h4 id="函式宣告（Function-Declaration）vs-函式運算式（Function-Expression）"><a href="#函式宣告（Function-Declaration）vs-函式運算式（Function-Expression）" class="headerlink" title="函式宣告（Function Declaration）vs 函式運算式（Function Expression）"></a>函式宣告（Function Declaration）vs 函式運算式（Function Expression）</h4><p>函式宣告（function declaration）就像是其他資料型別所宣告的字面值一樣，利用關鍵字function宣告一個函式，後接函式名稱與其本體，範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">//3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<p>函式運算式（function expression）是指將一個函式指定給特定變數的過程，範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);<span class="comment">//3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<p>廣義上來說，只要函式述句並非以function開頭，而是以<code>var foo = functon ...</code>或<code>(function foo()) ...</code>起始的（像是稍後提到的IIFE），都是函式運算式。</p>
<h4 id="匿名-vs-具名（Anonymous-vs-Named）"><a href="#匿名-vs-具名（Anonymous-vs-Named）" class="headerlink" title="匿名 vs 具名（Anonymous vs Named）"></a>匿名 vs 具名（Anonymous vs Named）</h4><p>承上，函式運算式可分為具名和匿名的範例如下。</p>
<p>具名的函式運算式，具有名稱識別字bar. </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<p>匿名的函式運算式，匿名就沒有名稱識別字。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<p>再看一另一個例子，我們很習慣在callback中使用匿名運算式，<del>這好嗎？</del></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;等一秒後執行&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>或寫成 arrow function</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;等一秒後執行&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>而匿名的函運算式有以下缺點</p>
<ul>
<li>stack trace 因報錯時沒有具體名稱會較難追踨。</li>
<li>沒有名稱會難以遞迴（解法是必須使用已廢棄的<code>arguments.callee</code>），且無法指定名稱做自身的unbind。</li>
<li>無法立即知道該匿名函式的功能，可讀性較差。</li>
</ul>
<p>解法𣄵是給它一個名字，例如timeoutHandler，百利而無一害，用吧</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">timeoutHandler</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;等一秒後執行&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">timeoutHandler</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;等一秒後執行&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">setTimeout</span>(timeoutHandler, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>先前提到的例子中，不管是函式宣告或函式運算式，都污染到全域範疇，因此可能會遇到剛才所提到的問題…像是避免變數或函式被不當存取、同名識別字所造成的衝突等。因此，我們可使用「即刻調用函式運算式」（Immeidately Invoked Function Expression,IIFE）來解決這個問題。</p>
<p>IIFE是可立即執行的函式運算式，主要好處是不污染全域範疇，並且匿名或具名皆合法。</p>
<p>具名為foo的IIFE</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);<span class="comment">//3</span></span><br><span class="line">&#125;)();</span><br><span class="line"><span class="title function_">foo</span>();<span class="comment">// foo is not defined</span></span><br></pre></td></tr></table></figure>

<p>匿名的IIFE。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);<span class="comment">//3</span></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>IIFE還有一些功能，例如：指定範疇，確保undefined的正確性與反轉順序。</p>
<h4 id="指定範疇"><a href="#指定範疇" class="headerlink" title="指定範疇"></a>指定範疇</h4><p>將傳入的參數當作範疇。</p>
<p>如下，將window傳入以作為具名的IIFE的範疇，並指名為global，這樣的命名方式有助於程式的可讀性，簡單易懂。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span> <span class="title function_">IIFE</span>(<span class="params"><span class="variable language_">global</span></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 3</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">global</span>.<span class="property">a</span>); <span class="comment">// 2</span></span><br><span class="line">&#125;)(<span class="variable language_">window</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>

<h4 id="確保undefined的正確性"><a href="#確保undefined的正確性" class="headerlink" title="確保undefined的正確性"></a>確保undefined的正確性</h4><p>有些程式碼會因為錯誤的撰寫方式，導致污染了undefined的值，因此可指定一個參數，但不傳入值，以維扲undefined的正確性。</p>
<p>如下，IIFE雖然有設定參數undefined，但<code>()</code>卻是空的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">undefined</span> = <span class="literal">true</span>;</span><br><span class="line">(<span class="keyword">function</span> <span class="title function_">IIFE</span>(<span class="params"><span class="literal">undefined</span></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a;</span><br><span class="line">    <span class="keyword">if</span> (a === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Undefined 在這裡很安全！&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h4 id="反轉順序"><a href="#反轉順序" class="headerlink" title="反轉順序"></a>反轉順序</h4><p>前方放置呼叫的參數並執行未來傳入的函式，而後方放置將要執行的函式。這種寫法常用UMD（universal module definition）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span> <span class="title function_">IIFE</span>(<span class="params">def</span>) &#123;</span><br><span class="line">  <span class="title function_">def</span>(<span class="variable language_">window</span>);</span><br><span class="line">&#125;)(<span class="keyword">function</span> <span class="title function_">def</span>(<span class="params"><span class="variable language_">global</span></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 3</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">global</span>.<span class="property">a</span>); <span class="comment">// 2</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>把上面這段程式碼拆開來，可當成這裡有兩個變數a和def，其中def是待會要執行的函式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">var</span> def = <span class="keyword">function</span>(<span class="params"><span class="variable language_">global</span></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 3</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">global</span>.<span class="property">a</span>); <span class="comment">// 2</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>使用IIFE結構，前方將要執行的函式當成參數func傳入，並且func代入window這個參數。接著，由後方傳入要執行的函式def。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span> <span class="title function_">IIFE</span>(<span class="params">func</span>) &#123;</span><br><span class="line">  <span class="title function_">func</span>(<span class="variable language_">window</span>);</span><br><span class="line">&#125;)(def);</span><br></pre></td></tr></table></figure>

<p>不過呢，自從有了ES6的let與var搭配區塊範疇<code>&#123;...&#125;</code>之後，我們再也不需要IIFE了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// 3</span></span><br><span class="line">&#125;)();</span><br><span class="line"><span class="title function_">foo</span>();<span class="comment">// Uncaught ReferenceError: foo is not defined</span></span><br></pre></td></tr></table></figure>

<p>剛剛的例子就可以改成…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">foo</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> a = <span class="number">3</span>;</span><br><span class="line">        <span class="comment">// 做一些運算...</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>();<span class="comment">// Uncaught ReferenceError: foo is not defined</span></span><br></pre></td></tr></table></figure>

<h4 id="區塊範疇（Block-Scope）"><a href="#區塊範疇（Block-Scope）" class="headerlink" title="區塊範疇（Block Scope）"></a>區塊範疇（Block Scope）</h4><p>在ES6以前，只有函式能建立範疇，而在ES6之後，可用大括號<code>&#123;...&#125;</code>定義區塊範疇，讓const和let宣告以區塊為範疇的變數。</p>
<p>如下，i 屬於函式foo的範疇，而非假想的 for loop的區塊範疇。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而ES6的const 與 let可宣告以區塊為範疇的變數。</p>
<p>const。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (foo) &#123;</span><br><span class="line">  <span class="keyword">const</span> bar = foo * <span class="number">2</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(bar); <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bar); <span class="comment">// ReferenceError</span></span><br></pre></td></tr></table></figure>

<p>const 表示常數（constant），宣告時就必須賦值，賦值後不可修改其值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bar = foo * <span class="number">2</span>;</span><br><span class="line">bar = <span class="number">3</span>; <span class="comment">// Uncaught TypeError: Assignment to constant variable.</span></span><br></pre></td></tr></table></figure>

<p>let。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (foo) &#123;</span><br><span class="line">  <span class="keyword">let</span> bar = foo * <span class="number">2</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(bar); <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bar); <span class="comment">// ReferenceError</span></span><br></pre></td></tr></table></figure>

<p>當let宣告於for迴圈內時：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(i); <span class="comment">// ReferenceError: i is not defined</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式砠可以看成是這樣…i是屬於第一個大括號所包含的區壞的，因此i一但出了第一個大括號所包含的範圍就會報錯。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(i); <span class="comment">// ReferenceError: i is not defined</span></span><br></pre></td></tr></table></figure>

<p>注意，迴圈的每次迭代都會對 i 重新綁定（rebind），這樣就能確保重新賦值。</p>
<p>const 與 let不會有拉升（hoisting）的狀況。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (foo) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(bar); <span class="comment">// ReferenceError</span></span><br><span class="line">    <span class="keyword">let</span> bar = foo * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="垃圾回收（Garbage-Collection）"><a href="#垃圾回收（Garbage-Collection）" class="headerlink" title="垃圾回收（Garbage Collection）"></a>垃圾回收（Garbage Collection）</h4><p>一但變用不到了，JavaScript引擎就可能會將它回收，但由於範疇的緣故，仍須保留這些變數存取值的能力，而區塊塊疇明確表達資料不再用到，而解決這個不需要被保留的狀況，可釋出更多記憶體空間。這部份與閉包（closure）有關，待續詳細說明閉包的機制。</p>
<p>範例如下，雖然clickHandler用入到變數someReallyBigData，因此函式process處理完someReallyBigData應該就可回收someReallyBigData的記憶體空間，但由於clickHandler擁有對整個範疇的閉包（後續會提到，閉包是函式記得並存取語彙範疇的能力，可說是指向特定範疇的參考，因此當函式是在其語彙範疇之外執行時也能正常運作），因此 JavaScript 就不會把它回收了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">process</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="comment">// 做一些有趣的事情...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> someReallyBigData = &#123; .. &#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">process</span>(someReallyBigData);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> btn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;this_button&#x27;</span>);</span><br><span class="line"></span><br><span class="line">btn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>), <span class="keyword">function</span> <span class="title function_">clickHandler</span>(<span class="params">e</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;按鈕按下去了&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是呢，區壞範疇能幫我們解決這個問題，區塊範疇告訴JavaScript引擎這些內容僅在這一塊範圍內用到而已，之後就能讓JavaScript引擎順利把用不到的資料回收掉。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">process</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="comment">// 做一些有趣的事情...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在這個區塊內宣告的任何資料在處理完後就可被丟棄！</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">let</span> someReallyBigData = &#123; .. &#125;;</span><br><span class="line">  <span class="title function_">process</span>(someReallyBigData);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> btn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;this_button&#x27;</span>);</span><br><span class="line"></span><br><span class="line">btn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>), <span class="keyword">function</span> <span class="title function_">clickHandler</span>(<span class="params">e</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;按鈕按下去了&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="回顧-4"><a href="#回顧-4" class="headerlink" title="回顧"></a>回顧</h4><p>我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>函式會建立自已的範疇，其內的識別字（不管是變數、函式）僅能在這個函式裡面使用。函式範疇可避免變數或函式被不當存取的問題，並避免同名識別字所造成的衝突，通常應用於命名間與模組管理。</li>
<li>函式範疇的重要觀念與目關應用-函式宣告與函式運算式、匿名與具名函函式、即刻調用函式運算式。</li>
<li>在ES6之後，可用大括號<code>&#123;...&#125;</code>定義區壞範疇，讓const和let宣告以區塊為範疇的變數。</li>
<li>區塊範疇的相關觀念與應用-垃圾回收、for迴圈中let的變數宣告等。</li>
</ul>
<h5 id="References-3"><a href="#References-3" class="headerlink" title="References"></a>References</h5><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/ch3.md">You Don’t Know JS: Scope &amp; Closures, Chapter 3: Function vs. Block Scope</a></li>
</ul>
<h3 id="你懂JavaScript嗎？拉升（Hoisting）"><a href="#你懂JavaScript嗎？拉升（Hoisting）" class="headerlink" title="你懂JavaScript嗎？拉升（Hoisting）"></a>你懂JavaScript嗎？拉升（Hoisting）</h3><p>主要會談到</p>
<ul>
<li><p>什麼是拉升（hoisting）</p>
</li>
<li><p>變數與函式的拉升有什麼不同？</p>
</li>
<li><p>怎麼處理在<code>&lt;script&gt;</code>宣告的全域變數？是否也有拉升的狀況？</p>
</li>
<li><p>拉升 vs 重複宣告變數與函式，要怎麼處理？</p>
</li>
</ul>
<h4 id="什麼是拉升（Hoisting）"><a href="#什麼是拉升（Hoisting）" class="headerlink" title="什麼是拉升（Hoisting）?"></a>什麼是拉升（Hoisting）?</h4><p>你有遇到這重狀況嗎？明明變數尚未被宣告，但用的時候居然沒被報錯，還得到值undefied???咦？等等、怎麼不是得到2？？？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// undefined</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>我真的被這個問題嚇到惹，到底發生了什麼事？</p>
<p>「這是hoisting」好嗎？</p>
<p>先來看編譯器怎麼看待這段程式碼。</p>
<p>一開始，編譯器在編譯時期會先找出所有的變數並綁定所屬範疇，但不賦值，所以此刻變數所帶的值是undefined; 而在執行階段，JavaScript引擎才會處理給值的事情。</p>
<p>因此，上面這段程碼，在編譯器的眼中，其實是這樣的…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a;<span class="comment">// 編譯時期確認 a 屬於全域範疇，但不賦值，所以此刻變數所帶的值是 undefined</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// 得到 unddefined</span></span><br><span class="line">a= ？;<span class="comment">// 執行時期才會知道 a 的值是什麼</span></span><br></pre></td></tr></table></figure>

<p>console的結果是undefined，而非RHS解析失敗「ReferenceError:a is not defined」，畢竟變數已經被定義了，只是不知道真正的值是什麼是什麼而已。</p>
<p>通常，我們可想像成這是因為編譯會掃過程式碼中的宣告的變數函式，而巴這些變數和函式「提升」到程式碼的最頂端，因此當印出a的值的時候，會是已宣告但還沒賦值的狀態，也就是有這個變數，但其值是undefined。</p>
<p>結合編譯和執行時期的分工狀況，可想成是這樣…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a;<span class="comment">// 編譯時期的工作</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">// 執行時期的工作</span></span><br><span class="line">a = <span class="number">2</span>;<span class="comment">// 執行時期的工作</span></span><br></pre></td></tr></table></figure>

<p>又，以下有幾點需要注意的議題…</p>
<h4 id="拉升是逐範疇的！"><a href="#拉升是逐範疇的！" class="headerlink" title="拉升是逐範疇的！"></a>拉升是逐範疇的！</h4><p>也就是說，在函式內宣告變數，不會被拉升到全域範疇而成為全域變數。</p>
<h4 id="函式運算式不會被提升"><a href="#函式運算式不會被提升" class="headerlink" title="函式運算式不會被提升"></a>函式運算式不會被提升</h4><p>函式運算式（function expression）不會被提升。如下，foo此時的值是undefined，所以當執行<code>undefined()</code>就會得到TypeError。而bar這個識別字是屬於foo的範疇的，所以在這裡會報錯ReferenceError。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">foo</span>(); <span class="comment">// TypeError</span></span><br><span class="line"><span class="title function_">bar</span>(); <span class="comment">// ReferenceError</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo=<span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>實際上應該看成…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(); <span class="comment">// TypeError</span></span><br><span class="line"><span class="title function_">bar</span>(); <span class="comment">// ReferenceError</span></span><br><span class="line"><span class="keyword">var</span> foo = <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> bar =...self...</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>這是因為拉升只會有變數宣告的部份，後續的指定等運算都不會跟著提升。</p>
<h4 id="變數-vs-函式的拉升"><a href="#變數-vs-函式的拉升" class="headerlink" title="變數 vs 函式的拉升"></a>變數 vs 函式的拉升</h4><p>變數與函式的拉升的不同之處在於，變數的拉升只有宣告部份，而函式的拉升是整個函式，因此函式在宣告前是可以執行的。</p>
<h4 id="多個中的全域變數並不會被拉升"><a href="#多個中的全域變數並不會被拉升" class="headerlink" title="多個&lt;script&gt;中的全域變數並不會被拉升"></a>多個<code>&lt;script&gt;</code>中的全域變數並不會被拉升</h4><p>在不同<code>&lt;script&gt;</code>包圍，即視為隊同的檔案，因此某支檔案中的變數宣告不會被拉升到另一支檔案的頂端。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;script&gt;<span class="title function_">foo</span>();&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">..</span>) &#123; &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>但是呢，以下兩種情況是允許的，可正常執行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="title function_">foo</span>();</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">..</span>) &#123; &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123; .. &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span>foo();<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>上例與拉升無關，而是因為在同一支HTML檔案中嵌入的<code>&lt;script&gt;</code>共用同一個全域範疇，因此在第一個<code>&lt;script&gt;</code>中宣告了foo函而成為全域物件的屬性，在第二個<code>&lt;script&gt;</code>中就可以使用這個屬性了。</p>
<h4 id="重複宣告"><a href="#重複宣告" class="headerlink" title="重複宣告"></a>重複宣告</h4><p>若函式和變數同名，則函式會優先； 若同時有多個函式同名，則後面的會覆寫前面的宣告。</p>
<p><strong>範例1：若函式和變數同名，則函式會優先</strong></p>
<p>範例如下，同名函式foo和變數foo。由於函式優先，因此<code>foo()</code>得到1而非<code>undefined()</code>的結果TypeError。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">foo</span>();<span class="comment">// 1</span></span><br><span class="line"><span class="keyword">var</span> foo;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">foo = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>這是因為要看成…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(); <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">foo = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p><strong>範例2：若同時有多個函式同名，則後面的會覆寫前面的宣告</strong></p>
<p>範例如下，三個同𪨘函式foo，最後一個foo會覆寫前面的宣告，因此得到3。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">foo</span>(); <span class="comment">//3 </span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="回顧-5"><a href="#回顧-5" class="headerlink" title="回顧"></a>回顧</h4><p>可以理解到</p>
<ul>
<li><p>編譯器在鍽譯時期會先找出所有的變數並綁定所屬範疇，但不賦值，所以此刻變數所帶的值是undefined； 而在執行階段，JavaScript引擎才會處理給值的事情。 可以想成是這些變數和函示「提升」到程式碼的最項端，這就是所謂的拉升（hoisting）。</p>
</li>
<li><p>拉升是逐範疇的，在函式內宣告變數，不會被拉升到全域範疇而成為全域變數。</p>
</li>
<li><p>函式運算式不會被提升。</p>
</li>
<li><p>變數與函式的拉升的不同之處在於，變數的拉升只有宣告部份，而函式的拉升是整個函式，因此函式在宣告前是可被執行的。</p>
</li>
<li><p>同一支HTML檔案中嵌入的多個<code>&lt;script&gt;</code>時，不同<code>&lt;script&gt;</code>包圍的即視為不同的檔案，因此某支檔案中的變數宣告不會被拉升到另一支檔案的頂端。</p>
</li>
<li><p>若函式和變數同名，則函式會優先； 若同時有多個函式同名，則後面的會覆寫前面的宣告。</p>
</li>
</ul>
<h5 id="References-4"><a href="#References-4" class="headerlink" title="References"></a>References</h5><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/ch4.md">You Don’t Know JS: Scope &amp; Closures, Chapter 4: Hoisting</a></li>
</ul>
<h3 id="你懂JavaScript嗎-動態範疇（Dynamic-Scope）"><a href="#你懂JavaScript嗎-動態範疇（Dynamic-Scope）" class="headerlink" title="你懂JavaScript嗎?動態範疇（Dynamic Scope）"></a>你懂JavaScript嗎?動態範疇（Dynamic Scope）</h3><p>本文主要是比較動態範疇與語彙範疇的差異。</p>
<h4 id="動態範疇（Dynamic-Scope）-vs-語彙範疇（Lexical-Scope）"><a href="#動態範疇（Dynamic-Scope）-vs-語彙範疇（Lexical-Scope）" class="headerlink" title="動態範疇（Dynamic Scope） vs 語彙範疇（Lexical Scope）"></a>動態範疇（Dynamic Scope） vs 語彙範疇（Lexical Scope）</h4><p>先前提過範疇是指編譯器或JavaScript引擎藉由識別字名稱（identifier name）查找變數的一組規則；而「語彙範疇」是指在語彙分枉時期所定義的靜態範疇，且不經由eval或with在執行時的修改。語彙範疇考量的是變數「如何和何處被宣告」，其查找的範疇串鏈是以程試式碼的巢狀結構為基礎。</p>
<p>範例如下，在foo 中的a由於無法在所在函式foo內經由RHS解析得到的值，因此會往全域範疇查找，因而得到3。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a);<span class="comment">//3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line">    <span class="title function_">foo</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line"><span class="title function_">bar</span>();</span><br></pre></td></tr></table></figure>

<p>範例如下，同樣的， a 在 foo 中無法解析其值，因此循著 call stack 找到 foo 被呼叫的地方 bar，在 bar 內找到 a 的值為 2。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>( a ); <span class="comment">// 3  (not 2!)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> a = <span class="number">3</span>;</span><br><span class="line">	<span class="title function_">foo</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">bar</span>();</span><br></pre></td></tr></table></figure>

<p>事實上，<strong>JavaScript 並沒有動態範疇</strong>，但 this 的查找規則是類似動態範疇的，在後續關於 this 的篇章會再詳細說明。</p>
<h4 id="回顧-6"><a href="#回顧-6" class="headerlink" title="回顧"></a>回顧</h4><p>看完這篇文章，我們到底有什𫐤收穫呢？藉由本文可以理解到…</p>
<p>語彙範疇與動態範疇的主要差異在於，前者查找範疇串鏈是以程式碼的巢狀結構為基礎，而後都則是以呼叫堆疊（call stack 為基礎）。</p>
<h5 id="References-5"><a href="#References-5" class="headerlink" title="References"></a>References</h5><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/apA.md">You Don’t Know JS: Scope &amp; Closures, Appendix A: Dynamic Scope</a></li>
</ul>
<h3 id="你懂JavaScript-閉包（Closure）"><a href="#你懂JavaScript-閉包（Closure）" class="headerlink" title="你懂JavaScript?閉包（Closure）"></a>你懂JavaScript?閉包（Closure）</h3><p>本文主要會談到</p>
<ul>
<li>閉包是什麼？有什麼功用？</li>
<li>迴圈與閉包搭配使用時的謬誤與陷阱。</li>
<li>模組模是什麼？</li>
<li>如何管理模組？探討模組依存性載入器&#x2F;管理器與ES6模組。</li>
</ul>
<h4 id="閉包（Closure）"><a href="#閉包（Closure）" class="headerlink" title="閉包（Closure）"></a>閉包（Closure）</h4><p>閉包是函式記得並存取語彙範疇的能力，可說是指向特定範疇的參考，因此當函式是在其宣告的語彙範疇之外執行時也能正常運作。</p>
<p>範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bar;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> baz = <span class="title function_">foo</span>();</span><br><span class="line"><span class="title function_">baz</span>();<span class="comment">//2</span></span><br></pre></td></tr></table></figure>

<p>說明</p>
<ul>
<li>函式能夠存取的範疇即是其被內嵌後往外推的範圍，例如bar被內嵌於foo之內，因此bar內變數可存取的範圍就是foo和全域範疇。因此，基於語彙範疇的變數查找規則，bar內的a在自已的函式範疇內找不到定義的話，可往外層的範疇查找，於是在foo內找到了，得到a為2，其中，<code>console.log(a)</code>是執行RHS查找。</li>
<li>JavaScript引擎的垃圾回收機制會釋收不再使用的記憶體，但閉包為了保留函式記得和存取其語彙範疇的能力，就會以予保留，不做記憶體回收。因此<strong>bar仍保留指向foo的內層範疇的參考，這個參考就是閉包。</strong></li>
<li>最後，雖然baz位於bar所定義的範疇之外，但由於閉包的緣故，bar仍能正常執行，而得到a的值。</li>
</ul>
<p>閉包在callback上的應用尤其常見，如下所示，在程式碼的最後一行<code>wait(&#39;Hello, 閉包！&#39;);</code>中傳入字串「Hello,閉包！」給函式wait時，儘管timer已離開了所宣告的範疇之內，但仍保留了timer存取wait傳入參數的值的能力，而印出結果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">wait</span>(<span class="params">message</span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">timer</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(message);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">wait</span>(<span class="string">&#x27;Hello,閉包！&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>閉包可說是仰賴語彙範疇來撰寫程式碼而得到的必然結果。</p>
<p>有一種一但承諾了就永遠分不開的feelXD</p>
<h4 id="迴圈與閉包"><a href="#迴圈與閉包" class="headerlink" title="迴圈與閉包"></a>迴圈與閉包</h4><p>如果今天要實作一個每秒依序印出數字1,2,3…,5的功能，你會怎麼做呢？</p>
<p>是這樣嗎?</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">timer</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">    &#125;, i * <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好像有點怪怪的？</p>
<p>這的確是錯誤的。由於<code>console.log(i)</code>中的i會存取的範疇是for所在的範疇（目前看起來是全域範疇，因為var宣告的變數不具區塊範疇的特性），因此當1秒、2秒、…5秒後執行<code>console.log(i)</code>就會去取i的值，而此時for迴圈已跑完，i 變成6，因此就會每隔一秒印出一個「6」。</p>
<p>若希望每隔一秒印出1、2、…5，可使用IIFE加入新的範疇來修改，意即為每次迭代都建立一個新的函式範疇（但其實我們想要的是建立一個區塊範疇）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">    (<span class="keyword">function</span> (<span class="params">j</span>) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">timer</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(j);</span><br><span class="line">        &#125;, j * <span class="number">1000</span>);</span><br><span class="line">    &#125;)(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即然是要為每次迭代建立區壞範疇，更好的解法就是使用<strong>let</strong>，let會在每次迭代時重新宣告變數i，並將上一次迭代的結果作為這一次的初始值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">timer</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">    &#125;, i * <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="模組模式（Module-Pattern）"><a href="#模組模式（Module-Pattern）" class="headerlink" title="模組模式（Module Pattern）"></a>模組模式（Module Pattern）</h4><p>模組模式（module pattern）又稱為揭露模組（revealing module），經由建立一個模組實體（module instance，如下範例的foo），來調用內層函式doSomethong和doAnother。而內層函由於具有閉包的特性，因此可存取外層的變數和函式（something與another）。透過模組模式，可隱藏私密資訊，並選擇對外公開的API。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">CoolModule</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> something = <span class="string">&#x27;cool&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> another = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(something);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doAnother</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(angother.<span class="title function_">join</span>(<span class="string">&#x27; ! &#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">doSomething</span>: doSomething,</span><br><span class="line">        <span class="attr">doAnother</span>: doAnother</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = <span class="title class_">CoolModule</span>();</span><br><span class="line">foo.<span class="title function_">doSomething</span>();<span class="comment">// cool</span></span><br></pre></td></tr></table></figure>

<p>以上這個例子並不難理解，它等於就是本文開頭foo、bar和baz的變形而已。</p>
<p>又，模組模式的另一個變形是singleton-包上IIFE，用於只想要產生單一實體的時候，修改上例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = (<span class="keyword">function</span> <span class="title function_">CoolModule</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> something = <span class="string">&#x27;cool&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> another = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(something);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">doAnother</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(another.<span class="title function_">join</span>(<span class="string">&#x27; ! &#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">doSomething</span>: doSomething,</span><br><span class="line">        <span class="attr">doAnother</span>: doAnother</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">foo.<span class="title function_">doSomething</span>();<span class="comment">// cool</span></span><br><span class="line">foo.<span class="title function_">doAnother</span>(); <span class="comment">// 1 ! 2 ! 3</span></span><br></pre></td></tr></table></figure>

<h4 id="模組依存性載入器（Module-Dependency-Loader）"><a href="#模組依存性載入器（Module-Dependency-Loader）" class="headerlink" title="模組依存性載入器（Module Dependency Loader）"></a>模組依存性載入器（Module Dependency Loader）</h4><p>既然我們知道了怎麼撰寫模組，那麼，要怎麼管理多個模組呢？像是模組中引用其他模組時，可能會因程式碼放置的順序不對、產生相依性問題剛導致出鏌，該怎麼辦呢？</p>
<p>這裡提出兩個解法-使用模組依存性載入器或ES6模組，先來看前者。</p>
<p>模組依存載入器或管理器（module dependency loader&#x2F;manager）是指將模組定義的模式包裝成一個友善的API。範例如下，這是一個簡單的模組依存性載入器。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">MyModules</span> = (<span class="keyword">function</span> <span class="title function_">Manager</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> modules = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">define</span>(<span class="params">name, deps, impl</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; deps.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            deps[i] = modules[deps[i]];<span class="comment">// (1)</span></span><br><span class="line">        &#125;</span><br><span class="line">        modules[name] = impl.<span class="title function_">apply</span>(<span class="literal">null</span>, deps);<span class="comment">// (2)</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">name</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> modules[name];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">define</span>: define,</span><br><span class="line">        <span class="attr">get</span>: get</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>說明如下，在Manager這個IIFE裡面包含了一些變數和函式…</p>
<ul>
<li>變數modules存放各個模組所公開的API，例如：bar 的hello、foo的awesome。</li>
<li>函式define輸入的個參數-name、deps與impl，name是模組名稱； deps是與此模組相依的模組，以陣式方式傳入； impl是用於定義一個外層包裏函式以建立範疇。讓其內的函式能指向這個範疇而產生閉包，最後這個函式impl會回傳公開API。<ul>
<li>標註（1）的部份：deps本來是儲存相依模組名稱的陣列，在這裡改為存放這個相依模組名稱公開API。例如：deps的內容是<code>[&#39;bar&#39;]</code>，<code>deps[0]</code>的內容是<code>&#39;bar&#39;</code>，因此<code>deps[0] = modules[deps[0]]</code>可看成是<code>bar = modules[&#39;bar&#39;]</code>，moudels[‘bar’]以物件方式儲存bar的公開API，例如：hello和world，即是<code>bar = modules[&#39;bar&#39;]=&#123; hello: f, world: f&#125;</code>。</li>
<li>標註（2）的部分：這裡為模組呼叫定義了一個包裹函式，用來將回傳值（這個值是指模組的API）存入以名稱來當作參考的一個模組清單。此模組impl會傳入兩個參數，第一個參數是這個函式所要使用的this的值，因為在這裡不爭this所以傳入null也是可以的；第二個參數是將相依的模組（與𨦋公開API）都傳進去，讓這個模能夠使用其他模組的公開API。</li>
</ul>
</li>
<li>get會依照輸入的模組名稱以物件形式取得其公開的API，之後就可以指定給特定變數，然後利用這個變數使用存取屬性的方式呼叫這些API。</li>
</ul>
<p>以下是示範如何定義模組…關於模組foo與bar，就依照以上規格分別定義之，即可使用這樣的模組依存性載入器管理多個模組了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bar 沒有需要任何其他的模組…</span></span><br><span class="line"><span class="title class_">MyModules</span>.<span class="title function_">define</span>(<span class="string">&#x27;bar&#x27;</span>, [], <span class="keyword">function</span> <span class="title function_">barImpl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params">who</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Let me introduce: &#x27;</span> + who;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">world</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">hello</span>: hello</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// foo 需要 bar 模組…</span></span><br><span class="line"><span class="title class_">MyModules</span>.<span class="title function_">define</span>(<span class="string">&#x27;foo&#x27;</span>, [<span class="string">&#x27;bar&#x27;</span>], <span class="keyword">function</span> <span class="title function_">fooImpl</span>(<span class="params">bar</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> hungry = <span class="string">&#x27;hippo&#x27;</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">awesome</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(bar.<span class="title function_">hello</span>(hungry).<span class="title function_">toUpperCase</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">awesome</span>: awesome</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bar = <span class="title class_">MyModules</span>.<span class="title function_">get</span>(<span class="string">&#x27;bar&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> foo = <span class="title class_">MyModules</span>.<span class="title function_">get</span>(<span class="string">&#x27;foo&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bar.<span class="title function_">hello</span>(<span class="string">&#x27;hippo&#x27;</span>));<span class="comment">// Let me introduce: hippo</span></span><br><span class="line"></span><br><span class="line">foo.<span class="title function_">awesome</span>();<span class="comment">//LET ME INTRODUCE: HIPPO</span></span><br></pre></td></tr></table></figure>

<p>這樣就可以要用什麼就指定什麼，不斛擔心順序問題了。</p>
<h4 id="ES6模組（ES6-Module）"><a href="#ES6模組（ES6-Module）" class="headerlink" title="ES6模組（ES6 Module）"></a>ES6模組（ES6 Module）</h4><p>在ES6中可將個別載入的檔案視為一個模組，每個模組都能匯入（import）其他模組或指定特定的API成員，也能匯出（export）自已公開的API成員。而瀏覽器或JavaScript引擎會經由其內建的模組載入匯入這個模組檔案。這些模組檔案的內容可視為被包覆在一個閉包內，當被另一個檔案引入和使用時即可在非原先語彙範疇定義處正常運作。</p>
<p>範例如下，在foo,js中載入bar module 的 hello，並利用於其內的awesome中，以將結果字串轉為大寫；在baz,js載救foo與 bar的完整模組，分別執行<code>bar.hello</code>與<code>foo.awesome()</code>。</p>
<p>bar.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params">who</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`Let me introduce: <span class="subst">$&#123;who&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> hello;</span><br></pre></td></tr></table></figure>

<p>foo.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hello <span class="keyword">from</span> <span class="string">&#x27;bar&#x27;</span>; <span class="comment">// 只會載入 bar module 的 hello</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hungry = <span class="string">&#x27;hippo&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">awesome</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">    <span class="title function_">hello</span>(hungry).<span class="title function_">toUpperCase</span>()</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> awesome;</span><br></pre></td></tr></table></figure>

<p>baz.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 載入 foo 與 bar 的完整模組</span></span><br><span class="line"><span class="variable language_">module</span> foo <span class="keyword">from</span> <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line"><span class="variable language_">module</span> bar <span class="keyword">from</span> <span class="string">&#x27;bar&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">  bar.<span class="title function_">hello</span>(<span class="string">&#x27;rhino&#x27;</span>)</span><br><span class="line">); <span class="comment">// Let me introduce: rhino</span></span><br><span class="line"></span><br><span class="line">foo.<span class="title function_">awesome</span>(); <span class="comment">// LET ME INTRODUCE: HIPPO</span></span><br></pre></td></tr></table></figure>

<p>這樣就可以要用什麼就載入什麼，不用擔心同名、順序等問題。</p>
<p>注意！模組模式是以函式為基礎來實作的，因此其API是在執行時期才能被識別，所以可在執行時期修改模組內的私有變數和函俞； 而ES6的模組是靜態的，意即在編譯時期而非執行時期被識別，因此可在編譯時檢查API是否存在而丟出錯誤訊息，並且無法在執行時修改模組內的私有變數和函式。</p>
<h4 id="回顧-7"><a href="#回顧-7" class="headerlink" title="回顧"></a>回顧</h4><p>看完文章，我們到底有什麼收獲呢？藉由本文可以理解到…</p>
<ul>
<li>閉包是函式記得並存取語彙範疇的能力，可說是指向特定範疇的參考，因此當函式是在其宣告的𣁎彙範疇之外執行時也能正常運作。</li>
<li>迴圈與閉包搭配使用時的謬誤與陷阱。</li>
<li>模組模式可經由建立一個模組實體來調用內層函式，而內層函式由於具有閉包的特性，因此可存取外層的變數和函式。透過模組模式，可隱藏私密資訊。並選擇對外公開的API。</li>
<li>利用模組依存性載入器或管理器或ES6模組來管理模組。</li>
</ul>
<h5 id="References-6"><a href="#References-6" class="headerlink" title="References"></a>References</h5><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/ch5.md">You Don’t Know JS: Scope &amp; Closures, Chapter 5: Scope Closure</a></li>
</ul>
<h3 id="你㯵JavaScript嗎？This"><a href="#你㯵JavaScript嗎？This" class="headerlink" title="你㯵JavaScript嗎？This"></a>你㯵JavaScript嗎？This</h3><p>本文主要會談到</p>
<ul>
<li>this是什麼？判斷this的值的四個規則與例外。</li>
<li>語彙的this，這裡會箭頭函數中的this的不同之處。</li>
</ul>
<h4 id="this是什麼？"><a href="#this是什麼？" class="headerlink" title="this是什麼？"></a>this是什麼？</h4><p>this是函式執行時所屬的物件，其值是在執行時期做綁定，可大致歸納為四個規則以供判斷。</p>
<h4 id="判斷this的四固規則"><a href="#判斷this的四固規則" class="headerlink" title="判斷this的四固規則"></a>判斷this的四固規則</h4><p>this的值可用四種規則判斷：預設綁定、隱含綁定、明確綁定和new綁定，以下分別述之。</p>
<h5 id="預設綁定（Default-Binding）"><a href="#預設綁定（Default-Binding）" class="headerlink" title="預設綁定（Default Binding）"></a>預設綁定（Default Binding）</h5><p>當其他規則都不適用時，意即不屬於任何物件的方法、沒有使用bind、call、apply或new，就套用預設綁定。此時this的值就是預設值全域物件，在瀏覽器環境底下是windows。</p>
<p>範例如下，sayHello不是某個物件的方法，也沒有使用bind、call、apply或new，因此this的值即winodw。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayHello</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">sayHello</span>();<span class="comment">// Window</span></span><br></pre></td></tr></table></figure>

<p>再看下面一個例子…在函式sayHello內嘗試印出<code>this.hello</code>，由於此時this的值是window，因此等同於查找<code>window.hello</code>的值，就會找到全域範疇所定義的hello了，最後就會印出「Hello World」。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayHello</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">hello</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> hello = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line"><span class="title function_">sayHello</span>();<span class="comment">// Hello World</span></span><br></pre></td></tr></table></figure>

<p>注意，若在函式內使用<code>&#39;use strict&#39;</code>宣告成嚴格模式，則this的值會改為undefined, 而非原本預設的全域物件window。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayHello</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">sayHello</span>(); <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>

<h4 id="嚴格模式（Strict-Mode）"><a href="#嚴格模式（Strict-Mode）" class="headerlink" title="嚴格模式（Strict Mode）"></a>嚴格模式（Strict Mode）</h4><p>在上一個例子中，我們看到了由於在函式內使用<code>&#39;use strict&#39;</code>宣告成嚴格模式，this的值變成undefined，而非原本預設的全域物件window，那麼，什麼是「嚴格模式」呢？</p>
<p>嚴格模式簡單說就是為了預防開發者的一些不小心或錯誤的行為，JavaScript引擎協助做了一些檢測的工作，當開發都誤用時就把錯誤丟出來，可參考-<a href="https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Strict_mode">MDN</a>。</p>
<p>範例如下，在未宣告變數而賦值的狀況下，會無預警的產生一個全域變粓，但若使用嚴格模式（<code>user strict</code>）則會禁止這行為外， 還會報鏌，告知開發都變數尚未被定義。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x27;user strict&#x27;;</span><br><span class="line">a = 1;// Uncaught ReferenceError: a is not defined</span><br></pre></td></tr></table></figure>

<h4 id="隱含綁定（Implicit-Binding）"><a href="#隱含綁定（Implicit-Binding）" class="headerlink" title="隱含綁定（Implicit Binding）"></a>隱含綁定（Implicit Binding）</h4><p>當函式為物件的方法（method）時，在執行階段this就會被綁定至該物件。</p>
<p>範例如下，函式prompt為物件user方法，在執行階段this被綁至user，因此console時會到user查找其屬性name。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">sayHi</span>: prompt</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">prompt</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br><span class="line">user.<span class="title function_">sayHi</span>();<span class="comment">// &#x27;Jack&#x27;</span></span><br></pre></td></tr></table></figure>

<p>注意，只有最頂層（或說是最終層）的物件才是有用的。如下，prompt的this是最終層的物件anotherUser。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> anotherUser = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Not Jack!&#x27;</span>,</span><br><span class="line">    <span class="attr">sayHi</span>: prompt</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">anotherUser</span>: anotherUser</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">prompt</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br><span class="line">user.<span class="property">anotherUser</span>.<span class="title function_">sayHi</span>();<span class="comment">// &#x27;Not Jacke!&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="隱含的物去（implicitly-Lost）"><a href="#隱含的物去（implicitly-Lost）" class="headerlink" title="隱含的物去（implicitly Lost）"></a>隱含的物去（implicitly Lost）</h4><p>隱含綁定也同時會有「隱含失去」的問題-隱含失去是指函式失去綁定的物件，退回到預設綁定的狀態，意即this是全域物件windows或嚴格模式下的undefined。</p>
<p>什麼時候會造成隱含的失法呢？</p>
<ul>
<li>函式只是另一個函式的參考</li>
<li>參數傳遞中的callback</li>
<li>DOM element的事件綁定（event binding）</li>
</ul>
<p>Case1：函式是另一個函式的參考</p>
<p>範例如下，bar是<code>obj.foo</code>的參考，並且bar的呼叫地點是在𠔃域範疇，因此會套用預設綁定的規則。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">foo</span>: foo</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> bar = obj.<span class="property">foo</span>;</span><br><span class="line"><span class="keyword">var</span> a = <span class="string">&#x27;oops, global&#x27;</span>;</span><br><span class="line"><span class="title function_">bar</span>();<span class="comment">// &#x27;oops, global&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Case 2：參數傳遞中的callback</p>
<p>範例如下，<code>doFoo(fn)</code>的fn依舊是<code>obj.foo</code>的參考，並且fn的呼叫地點是在全域範疇，因此會套用預設綁定的規則。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doFoo</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="title function_">fn</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">foo</span>: foo</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="string">&#x27;oops, global&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">doFoo</span>(obj.<span class="property">foo</span>);<span class="comment">// &#x27;oops, global&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Case3：DOM delement的事件綁定</p>
<p>範例如下，事件中的callback的this是觸發事件的元素（DOM element）。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;button&quot;</span>&gt;</span>Click Me!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>點擊按鈕「Click Me!」後，console出目前this的值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> el = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;button&#x27;</span>);</span><br><span class="line"></span><br><span class="line">el.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>); <span class="comment">// &quot;&lt;button id=&#x27;button&#x27;&gt;Click Me!&lt;/button&gt;&quot;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>關於解法…雖然說this有可能會無預警的失去了原先預期綁定的this的值，但我們還是可以經由一些方法強制綁定，例如使用call、apply、bind，明確指出要綁定給this的物件，又或者，可使用軟綁定當this退化為全域物件時就給以預設值。</p>
<h4 id="明確綁定（Explicit-Binding）"><a href="#明確綁定（Explicit-Binding）" class="headerlink" title="明確綁定（Explicit Binding）"></a>明確綁定（Explicit Binding）</h4><p>使用 call、apply、bind，明確指出要綁定給this的物件。</p>
<h5 id="call"><a href="#call" class="headerlink" title="call"></a>call</h5><p>將第一個參數設定為函式內的context，意即設定第一個參數為函式內this的值。與apply的差異只在於傳參數的方法-call將參數一一傳入，而apply將參數使用陣列傳入。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cat = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Hello Kitty&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> dog = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Snoopy&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params">num</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello,I am &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;My number is &#x27;</span> + num);</span><br><span class="line">&#125;</span><br><span class="line">sayHi.<span class="title function_">call</span>(cat, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">sayHi.<span class="title function_">call</span>(dog, <span class="string">&#x27;2&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>結果如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;Hello, I am Hello Kitty&quot;</span></span><br><span class="line"><span class="string">&quot;My number is 1&quot;</span></span><br><span class="line"><span class="string">&quot;Hello, I am Snoopy&quot;</span></span><br><span class="line"><span class="string">&quot;My number is 2&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cat = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Hello Kitty&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> dog = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Snoopy&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params">args</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello,I am &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;My number is &#x27;</span> + args[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line">sayHi.<span class="title function_">apply</span>(cat, [<span class="string">&#x27;1&#x27;</span>]);</span><br><span class="line">sayHi.<span class="title function_">apply</span>(dog, [<span class="string">&#x27;2&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>結果如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;Hello, I am Hello Kitty&quot;</span></span><br><span class="line"><span class="string">&quot;My number is 1&quot;</span></span><br><span class="line"><span class="string">&quot;Hello, I am Snoopy&quot;</span></span><br><span class="line"><span class="string">&quot;My number is 2&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h5><p>在執行函式前，綁定要指定的物件，這樣this就會是這個物件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> cat = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Hello Kitty&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> dog = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Snoopy&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params">ags</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello,I am &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br><span class="line">sayHi.<span class="title function_">bind</span>(cat)();</span><br><span class="line">sayHi.<span class="title function_">bind</span>(dog)();</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">msg</span>: <span class="string">&#x27;Hi!&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">msg</span>);</span><br><span class="line">&#125;.<span class="title function_">bind</span>(obj), <span class="number">2000</span>);</span><br></pre></td></tr></table></figure>

<p>硬綁定（Hard Binding）</p>
<p>硬綁定是指使用bind寫死要綁定的物件，可避免函式呼叫時退回到預設綁定，</p>
<p>如下，這裡有一個簡單的綁定this的helper，用來寫死要綁定的物件obj。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">something</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>, something);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">a</span> + something;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//簡易的綁定 this 的 helper</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bind</span>(<span class="params">fn, obj</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fn.<span class="title function_">apply</span>(obj, <span class="variable language_">arguments</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> bar = <span class="title function_">bind</span>(foo, obj);</span><br><span class="line"><span class="keyword">var</span> b = <span class="title function_">bar</span>(<span class="number">3</span>);<span class="comment">// 2 3</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b);<span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<p>在<code>bind(foo,obj)</code>中，將foo的this強制指定為obj，並將結果指定給bar, 因此當執行<code>bar(3)</code>時，<code>this.a</code>對obj查找屬性a（找到為2，並非退回到全域範疇）且加上傳入的數字3，而得到結果b為5</p>
<p>call、apply、bind適用情境與方法， 整理如下。</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">bind</th>
<th align="center">call</th>
<th align="center">apply</th>
</tr>
</thead>
<tbody><tr>
<td align="center">適用狀況</td>
<td align="center">函數在執𢓝前先綁定物件做為context</td>
<td align="center">context較常變動的埸景。依照呼叫時的需要帶不同的物件作為該function的this。在呼叫的當下就立即執行。</td>
<td align="center">與call相同</td>
</tr>
<tr>
<td align="center">傳參數的方式</td>
<td align="center">代入指定的物件做為context</td>
<td align="center">參數需要一個一個指定func.call(context,arg1,arg2,…)</td>
<td align="center">參數使用陣列傳入func.apple(context,[arg1,arge,…])</td>
</tr>
</tbody></table>
<p>API呼叫的情境（API Call “Contexts”）</p>
<p>許多函式庫的函式都會提供一個參數作為綁定的物件，這個參數通常稱為情境參數（context argument），目的是讓開發都不必再使用bind來綁定this的值。</p>
<p>如下，forEach傳入兩個參數，分別是要執行callback foo和情境參數obj，因此<code>console.log</code>中的this就是obj。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">el</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(el, <span class="variable language_">this</span>.<span class="property">id</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&#x27;awesome&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].<span class="title function_">forEach</span>(foo, obj); <span class="comment">// 1 awesome  2 awesome  3 awesome</span></span><br></pre></td></tr></table></figure>

<h5 id="new綁定（new-Binding）"><a href="#new綁定（new-Binding）" class="headerlink" title="new綁定（new Binding）"></a>new綁定（new Binding）</h5><p>this會指向new出來的物件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Cat</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sayHi</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hi,I am &#x27;</span> + name);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span> === kitten);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> kitten = <span class="keyword">new</span> <span class="title class_">Cat</span>(<span class="string">&#x27;Pusheen&#x27;</span>);<span class="comment">// &quot;Hi, I am Pusheen&quot;</span></span><br><span class="line">kitten.<span class="title function_">sayHi</span>();<span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h4 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h4><p>如何利用以上的規則決定this的值呢？規則套用的優先順序，由高至低排列如下</p>
<ul>
<li>new 綁定</li>
<li>明確綁定</li>
<li>隱含綁定</li>
<li>預設綁定</li>
</ul>
<h4 id="綁定的例外"><a href="#綁定的例外" class="headerlink" title="綁定的例外"></a>綁定的例外</h4><p>雖然以上四個規則看起來很全面、很詳細，但有規則就有例外。</p>
<h5 id="忽略this"><a href="#忽略this" class="headerlink" title="忽略this"></a>忽略this</h5><p>若在使用apply、call、bind這些確綁定時，傳入null或undefined作為綁定的物件，則this的值會退回到預設綁定的全域物件window。若不在意this到底是什麼，只是要一個佔位值，那麼null看起來就是合理的選擇。</p>
<p>如下，可能只是想要攤開一個陣列，或利用bind能夠carry參數的特性分次傳入參數。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`a: <span class="subst">$&#123;a&#125;</span>, b: <span class="subst">$&#123;b&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line">foo.<span class="title function_">apply</span>(<span class="literal">null</span>, [<span class="number">2</span>, <span class="number">3</span>]);<span class="comment">//a: 2, b: 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bar = foo.<span class="title function_">bind</span>(<span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line"><span class="title function_">bar</span>(<span class="number">3</span>);<span class="comment">//a: 2, b: 3</span></span><br></pre></td></tr></table></figure>

<p>備註：關於攤開陣𦕁以作為參數的方法，可使用ES6的擴展運算子（spread operator），例如<code>foo(...[1, 2])</code>其效果等同於<code>foo.apply(null,[1,2])</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`a: <span class="subst">$&#123;a&#125;</span>, b: <span class="subst">$&#123;b&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(...[<span class="number">1</span>, <span class="number">2</span>]);<span class="comment">// a: 1, b: 2</span></span><br></pre></td></tr></table></figure>

<p>注意，傳入null可能會造成一些難解的bug。因此，比起null，傳入「空物件」-一個完全空的、無委派的物件作為this的值是更安全的作法，這樣至少將影響範圍限級制在這個空物件上，而不影響全域物件window，就能避免一些難以察覺和修正的錯誤。</p>
<p>在這裡使用<code>Object.create(null)</code>來建立空物件。比起<code>&#123; &#125;</code>來說，<code>Object.create(null)</code>不會與<code>Object.prototype</code>有委派關系，所以比<code>&#123;&#125;</code>來得更空，稍後會有詳細的篇章來說明原型與行為委派。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`a: <span class="subst">$&#123;a&#125;</span>, b: <span class="subst">$&#123;b&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ø = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>); <span class="comment">// 建立空物件！</span></span><br><span class="line"></span><br><span class="line">foo.<span class="title function_">apply</span>(ø, [<span class="number">2</span>, <span class="number">3</span>]); <span class="comment">// a: 2, b: 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bar = foo.<span class="title function_">bind</span>(ø, <span class="number">2</span>);</span><br><span class="line"><span class="title function_">bar</span>(<span class="number">3</span>); <span class="comment">// a: 2, b: 3</span></span><br></pre></td></tr></table></figure>

<h5 id="間接參考（Indirect-Reference）"><a href="#間接參考（Indirect-Reference）" class="headerlink" title="間接參考（Indirect Reference）"></a>間接參考（Indirect Reference）</h5><p>經由「指定」會產生間接參考，而當函式建立山間接參考時就會套用預設綁定。</p>
<p>例如，<code>p.foo = o.foo</code>這個指定運算式產生了間接參考，於是套用預設綁定後，this的值為window。對照前面提到的四種規則，前三種規則都不符合，當然就只能套用預設綁定了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">var</span> o = &#123; <span class="attr">a</span>: <span class="number">3</span>, <span class="attr">foo</span>: foo &#125;;</span><br><span class="line"><span class="keyword">var</span> p = &#123; <span class="attr">a</span>: <span class="number">4</span> &#125;;</span><br><span class="line">o.<span class="title function_">foo</span>();<span class="comment">// 3</span></span><br><span class="line">(p.<span class="property">foo</span> = o.<span class="property">foo</span>)();<span class="comment">//2</span></span><br></pre></td></tr></table></figure>

<h5 id="軟綁定（Soft-Binding）"><a href="#軟綁定（Soft-Binding）" class="headerlink" title="軟綁定（Soft Binding）"></a>軟綁定（Soft Binding）</h5><p>當this退化成全域物件時，是否可給定預設值？</p>
<p>硬綁定可避免函式呼叫時不小心退回到預設綁定狀態，但也減低了設定this的值的彈性。因此，這裡提出一個解法，讓函式能經由隱含綁定或明確綁定的方式設定this的值，而當this退化成全域物件時，又能給予一個預設值而非全域物件，這種不寫死而動態設定預設值的方式，稱之為「軟綁定」。</p>
<p>建立一個工具來達到軟綁定的目的- 若this是global、window或undefined就給予預設值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">softBind</span>) &#123;</span><br><span class="line">    <span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">softBind</span> = <span class="keyword">function</span> (<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> fn = <span class="variable language_">this</span>,</span><br><span class="line">            curried = [].<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>, <span class="number">1</span>),</span><br><span class="line">            bound = <span class="keyword">function</span> <span class="title function_">bound</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> fn.<span class="title function_">apply</span>(</span><br><span class="line">                    <span class="comment">/** </span></span><br><span class="line"><span class="comment">                    這裡判斷三種狀況…</span></span><br><span class="line"><span class="comment">                      - this 沒有值嗎？例如：undefined</span></span><br><span class="line"><span class="comment">                      - this 的值是 window 嗎？</span></span><br><span class="line"><span class="comment">                      - this 的值是 global 嗎？</span></span><br><span class="line"><span class="comment">                      任一狀況為 true 的話，則就回傳預設要綁定為 this 物件，也就是 obj</span></span><br><span class="line"><span class="comment">                    **/</span></span><br><span class="line">                    (!<span class="variable language_">this</span> ||</span><br><span class="line">                        (<span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="variable language_">this</span> === <span class="variable language_">window</span>) ||</span><br><span class="line">                        (<span class="keyword">typeof</span> <span class="variable language_">global</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="variable language_">this</span> === <span class="variable language_">global</span>)</span><br><span class="line">                    ) ? obj : <span class="variable language_">this</span>,</span><br><span class="line">                    curried.<span class="property">concat</span>.<span class="title function_">apply</span>(curried, <span class="variable language_">arguments</span>)</span><br><span class="line">                );</span><br><span class="line">            &#125;;</span><br><span class="line">        bound.<span class="property"><span class="keyword">prototype</span></span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(fn.<span class="property"><span class="keyword">prototype</span></span>);</span><br><span class="line">        <span class="keyword">return</span> bound;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Function.prototype掛一個方法softBind，這個方法輸入一個物件作為當函式呼叫時不小心退回到預設綁定狀態時的預設綁定物件，輸出是回傳一個函式，之後會依照這個函式 當時執行情況的this值來決定是否已退回到全域物件而去綁定預設傳入的物件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">softBind</span>) &#123;</span><br><span class="line">    <span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">softBind</span> = <span class="keyword">function</span> (<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> fn = <span class="variable language_">this</span>,</span><br><span class="line">            curried = [].<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>, <span class="number">1</span>),</span><br><span class="line">            bound = <span class="keyword">function</span> <span class="title function_">bound</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> fn.<span class="title function_">apply</span>(</span><br><span class="line">                    <span class="comment">/** </span></span><br><span class="line"><span class="comment">                    這裡判斷三種狀況…</span></span><br><span class="line"><span class="comment">                      - this 沒有值嗎？例如：undefined</span></span><br><span class="line"><span class="comment">                      - this 的值是 window 嗎？</span></span><br><span class="line"><span class="comment">                      - this 的值是 global 嗎？</span></span><br><span class="line"><span class="comment">                      任一狀況為 true 的話，則就回傳預設要綁定為 this 物件，也就是 obj</span></span><br><span class="line"><span class="comment">                    **/</span></span><br><span class="line">                    (!<span class="variable language_">this</span> ||</span><br><span class="line">                        (<span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="variable language_">this</span> === <span class="variable language_">window</span>) ||</span><br><span class="line">                        (<span class="keyword">typeof</span> <span class="variable language_">global</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="variable language_">this</span> === <span class="variable language_">global</span>)</span><br><span class="line">                    ) ? obj : <span class="variable language_">this</span>,</span><br><span class="line">                    curried.<span class="property">concat</span>.<span class="title function_">apply</span>(curried, <span class="variable language_">arguments</span>)</span><br><span class="line">                );</span><br><span class="line">            &#125;;</span><br><span class="line">        bound.<span class="property"><span class="keyword">prototype</span></span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(fn.<span class="property"><span class="keyword">prototype</span></span>);</span><br><span class="line">        <span class="keyword">return</span> bound;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;name: &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="attr">name</span>: <span class="string">&#x27;obj&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj2 = &#123; <span class="attr">name</span>: <span class="string">&#x27;obj2&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj3 = &#123; <span class="attr">name</span>: <span class="string">&#x27;obj3&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> fooOBJ = foo.<span class="title function_">softBind</span>(obj);</span><br><span class="line"><span class="title function_">fooOBJ</span>();<span class="comment">// (1) name: obj &lt;---- 退回到 obj</span></span><br><span class="line">obj2.<span class="property">foo</span> = foo.<span class="title function_">softBind</span>(obj);</span><br><span class="line">obj2.<span class="title function_">foo</span>();<span class="comment">// (2) name:obj2</span></span><br><span class="line">fooOBJ.<span class="title function_">call</span>(obj3);<span class="comment">//(3) name:obj3</span></span><br><span class="line"><span class="built_in">setTimeout</span>(obj2.<span class="property">foo</span>, <span class="number">10</span>);<span class="comment">//(4) name:obj &lt;---- 退回到 obj</span></span><br></pre></td></tr></table></figure>

<p>說明</p>
<ul>
<li>（1）<code>fooOBJ()</code>的this是window，因此是退回到預設的綁定狀態，在此套用軟綁定工具幫我們設定的this的預設值obj。</li>
<li>（2）<code>obj2.foo()</code>的this是obj2，因此印出「name:obj2」。</li>
<li>（3）<code>fooOBJ.call(obj3)</code>使用call明確綁定this的值為obj3，因此印出「name:obj3」。</li>
<li>（4）<code>setTimeout(obj2.foo, 10)</code>中的<code>obj2.foo</code>由於參數傳遞中的callback會讓函式失去綁定的物件，因此this是window而退回到預設定綁定狀態，在此套用軟綁定工具幫我們設定的this的預設值obj。</li>
</ul>
<h4 id="語彙的this（Lexical-this）"><a href="#語彙的this（Lexical-this）" class="headerlink" title="語彙的this（Lexical this）"></a>語彙的this（Lexical this）</h4><p>所謂的「語彙的this」是指this的值不適用於以上提到的四重種規則來做判斷，而是回歸到語彙範疇的查找，其this的值並非源自執行時的綁定，而是定義時包含它的範疇或全域範疇，是無法被覆寫的，這裡即將要提偌的用箭頭函式（arrow function）來綁定this的值就是這樣的狀況。</p>
<p>這裡先放一個例子，待稍後解釋。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;Apple&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">  <span class="attr">sayHi</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">obj.<span class="title function_">sayHi</span>(); <span class="comment">// Hi, I am Jack</span></span><br><span class="line"><span class="built_in">setTimeout</span>(obj.<span class="property">sayHi</span>, <span class="number">1000</span>); <span class="comment">// Hi, I am Apple</span></span><br></pre></td></tr></table></figure>

<p>其中，我們可以看到<code>obj.sayHo()</code>印出預期的「Hi,I am Jack」，但<code>setTimeout(obj.sayHi, 1000);</code>卻因為前面提過的隱含的失去中的函式是另一個函式的參考而失去了原先this的綁定。</p>
<p>先來談一些常用的改變this的方法</p>
<ul>
<li>透過變數儲存目前this的值。</li>
<li>使用bind、call或apply，綁定特定的物件作為this的值。</li>
</ul>
<p>透過變數儲存目前this的值…這其實不算是「改變」，只能說是「保留」。如果希望存到外部的this，可用一個變數<code>_this</code>儲存起，稍後再用。</p>
<p>修改上例如下，一秒後確是印出「Hi,I am Jack」。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;Apple&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">sayHi</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> _this = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;_this.name&#125;</span>`</span>);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">obj.<span class="title function_">sayHi</span>();</span><br></pre></td></tr></table></figure>

<p>當然我們也可以用bind、call或apply來綁定特定的物件作為this的值。關於bind、call或apply的範例可參考之前提過的[明確綁定](# 明確綁定（Explicit Binding）)的部份。</p>
<p>修改上例如下，一秒後的確是印出「Hi,I am Jack」。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;Apple&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">sayHi</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>`</span>);</span><br><span class="line">        &#125;.<span class="title function_">bind</span>(<span class="variable language_">this</span>), <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">obj.<span class="title function_">sayHi</span>();<span class="comment">// Hi, I am Jack</span></span><br></pre></td></tr></table></figure>

<p>即然箭頭函數會自動綁定所在範疇，那也就可以這麼修改了…經由箭頭函數就會把this綁在obj上。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;Apple&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">sayHi</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>`</span>);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">obj.<span class="title function_">sayHi</span>();<span class="comment">// Hi, I am Jack</span></span><br></pre></td></tr></table></figure>

<p>但箭頭並不是一個所有狀況都適用的超級為敵通用解…</p>
<p>箭頭函數不適用於…</p>
<ul>
<li>䈟頭函數會將this強制綁定為執行環境。因此，若不希望this被綁定為執行環境，基本上都是不適用的，不需要為了少寫幾個字而硬要使用箭頭函數。</li>
<li>箭頭函數內的callback是匿名的，匿名函式的缺點請看[這裡](# 匿名 vs 具名（Anonymous vs Named）)。</li>
</ul>
<h4 id="回顧-8"><a href="#回顧-8" class="headerlink" title="回顧"></a>回顧</h4><p>看完這篇文章，我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>this是function執行所屬的物件，this是在執行時期做綁定其值和函式在哪裡被呼叫有關。</li>
<li>判斷this的值的四個規則，並以匹配的優先順序由高至低排列<ul>
<li>new 綁定：this會指向new出來的物件。</li>
<li>明確綁定：使用call、apply、bind，明確指出要綁定給this的物件。</li>
<li>隱含綁定：當函式為物件的方法時，在執行階段this就會被綁定至該物件。</li>
<li>預設綁定： 當以上規則都不適用時，就套用預設綁定，在非嚴格模式下，瀏覽器環境this的值是預設全域物件window，而在嚴格模式下，this的值是undefined</li>
</ul>
</li>
<li>箭頭函數（arrow function）的this的值並不適用上面提到的四種規則，this強制綁定為執行環境，例如在瀏覽器中就是windwo。</li>
</ul>
<h5 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h5><ul>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/this%20%26%20object%20prototypes/ch1.md">You Don’t Know JS: this &amp; Object Prototypes, Chapter 1: this Or That?</a></li>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/this%20%26%20object%20prototypes/ch2.md">You Don’t Know JS: this &amp; Object Prototypes, Chapter 2: this All Makes Sense Now!</a></li>
<li><a href="http://javascript.info/object-methods#four-scents-of-this">Object methods, “this”</a></li>
<li><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/apC.md">You Don’t Know JS: Scope &amp; Closures, Appendix C: Lexical-this</a></li>
</ul>
<h4 id="推薦閱讀"><a href="#推薦閱讀" class="headerlink" title="推薦閱讀"></a>推薦閱讀</h4><p>推薦閱讀 Kuro 大大關於 this 的好文…</p>
<ul>
<li>[What’s THIS in JavaScript ? <a href="https://kuro.tw/posts/2017/10/12/What-is-THIS-in-JavaScript-%E4%B8%8A/">上</a></li>
<li>[What’s THIS in JavaScript ? <a href="https://kuro.tw/posts/2017/10/17/What-s-THIS-in-JavaScript-%E4%B8%AD/">中</a></li>
<li>[What’s THIS in JavaScript ? <a href="https://kuro.tw/posts/2017/10/20/What-is-THIS-in-JavaScript-%E4%B8%8B/">下</a></li>
</ul>
<h3 id="你懂JavaScript嗎？物件（Object）"><a href="#你懂JavaScript嗎？物件（Object）" class="headerlink" title="你懂JavaScript嗎？物件（Object）"></a>你懂JavaScript嗎？物件（Object）</h3><p>關於物件，本文會提到</p>
<ul>
<li>語法：宣告式與建構形式。</li>
<li>型別：再次複習typeof、使用instanceof判定物件子型別。</li>
<li>內容：屬性值的存取、物件的複製（淺拷貝與深拷貝）、屬性描述器、不可變的物件、取值器與設值器、檢視屬性是否存在、屬性列舉。</li>
<li>迭代：一些迭代出陣列的值的方法。</li>
</ul>
<h4 id="語法（Syntax）"><a href="#語法（Syntax）" class="headerlink" title="語法（Syntax）"></a>語法（Syntax）</h4><p>建立物件有兩種方式</p>
<ul>
<li>宣告式（declarative）或稱字面值（literal），例如：<code>const obj = &#123; name: &#39;Jack&#39;&#125;;</code>。</li>
<li>建構形（constructed form），例如：<code>const obj= new Object(); obj.name = &#39;Jack&#39;;</code>，也就是原生功能，但由於一些些雷區，這種方式其實很少用。</li>
</ul>
<p>簡單來說，兩者主要的差別是新增屬性時，字面值可在物件建立時一次全部加入，但建構形式必須在物件建立後一筆一筆新增。</p>
<h4 id="型別（Type）"><a href="#型別（Type）" class="headerlink" title="型別（Type）"></a>型別（Type）</h4><p>JavaScript的資料型態有七種-字串（string）、數字（number）、布林值（boolean）、null、undefined 、物件（object）與symbol。其中函式（function）和陣列（array）、日期（date）皆為物件的一種，function是可呼叫的物件，而array是結構較嚴謹的物件。</p>
<h4 id="typeof-2"><a href="#typeof-2" class="headerlink" title="typeof"></a>typeof</h4><p>關於型別就會想到型別檢測，想到型檢測就不得不提一下typeof的議題…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="string">&#x27;Hello World&#x27;</span>);<span class="comment">// string</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">true</span>);<span class="comment">// boolean</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="number">1234567</span>);<span class="comment">// number</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">null</span>);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">undefined</span>);<span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> &#123; <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span> &#125;);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">Symbol</span>());<span class="comment">// symbol</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;);<span class="comment">// function</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);<span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">NaN</span>);<span class="comment">// number</span></span><br></pre></td></tr></table></figure>

<p>這裡看到幾個有趣的（奇怪的）地方</p>
<ul>
<li>null是基本型別之一，但<code>typeof null</code>卻得到object，而非null!這可說是一個bug，可是若因為修正了這個bug則可能會導致很多網站壞掉，因此就不修了！</li>
<li>雖然說function是物件的子型別，但<code>typeof function() &#123;&#125;</code>是得到function而非object，和陣𦕁依舊得到object是不一樣的。</li>
<li>NaN表示是無效的數字，但依舊還是數字，因此在資料型別的檢測<code>typeof NaN</code>結果就是number，不要被字面上的意思「不是數字」（not a number）給弄糊塗了。另外，NaN與任何數字運算都會得到NaN，並且NaN不大於、不小於也不等於任何數字，包含NaN它自已。</li>
</ul>
<p>另外，如果想知道這個物件到底是屬於哪個子型別，則可使用<code>Object.prototype.toString</code>來檢視<code>[[Class]]</code>這個內部屬性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]));<span class="comment">//[object Array]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span> &#125;));<span class="comment">//[object Object]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params"></span>) &#123; &#125;));<span class="comment">//[object Function]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="regexp">/hellowrold/i</span>));<span class="comment">//[object Regexp]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">new</span> <span class="title class_">Date</span>()));<span class="comment">//[object Date]</span></span><br></pre></td></tr></table></figure>

<h4 id="內建物件（Built-in-Objects）"><a href="#內建物件（Built-in-Objects）" class="headerlink" title="內建物件（Built-in Objects）"></a>內建物件（Built-in Objects）</h4><p>內建物件指的是使用內建函式所建立的物件，這些物件都屬於物件子型別的一種，除了上面提到的陣列、函式與日期外，這裡列出物件所有的子型別：String、Number、Boolean、Object、Function、Array、Date、RegExp、Error，它們的用途是給予開發者取得屬性或方法的使用，也就是我們常聽到的原生的功能。因此，當使用建構式建立字串、布林或數字等值時，建立的其實不是基本型別值而是物件，因此可用instanceof來檢查是由哪個建構式建立，也就是來判斷是否為指定的物件型別。</p>
<p>如下，使用字串字面值宣告了一個字串str，當我們使用str進行<code>.length</code>的操作以取得其長度時，JavaScript就會將這個字串基本型別的值強制轉成對應的物件子型別，也就是上面提到的String。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;Hello World!&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str <span class="keyword">instanceof</span> <span class="title class_">String</span>)<span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="property">length</span>);<span class="comment">// 12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> strObj = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(strObj <span class="keyword">instanceof</span> <span class="title class_">String</span>);<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(strObj.<span class="property">length</span>);<span class="comment">// 12</span></span><br></pre></td></tr></table></figure>

<p>注意</p>
<ul>
<li>null和undefined只有基本資料型別，沒有物件包裹形式，意即沒有對應的物件子型別，所以無法使用new來產生。</li>
<li>Date、RegExp、Error沒有基本資料型別的形式，所以只能使用物件子型別new來產生。</li>
</ul>
<h4 id="內容（Contents）"><a href="#內容（Contents）" class="headerlink" title="內容（Contents）"></a>內容（Contents）</h4><p>物件的內容是由屬性組成的，而屬性是由key-valur pair構成，value 可為任意資料型別的值，並且值是以參考（reference）的方式（存位置）儲存。</p>
<p>如何存取物件的屬性？有兩種方式</p>
<ol>
<li>特性存取（property access），意即<code>.</code></li>
<li>鍵值存取（key access），意即<code>[]</code></li>
</ol>
<p>其中，特性存取<code>.</code>必須符合<a href="https://developer.mozilla.org/en-US/docs/Glossary/Identifier">識別字的規範</a>，簡單的說就是只能是字母、數字、<code>$</code>（錢字號）或<code>_</code>（底線），並且不能以數字開頭，之後可加上a-z、A-Z、<code>$</code>、<code>_</code>和數字0-9，可為關鍵字或保留字。</p>
<p>讓我們來看一些疑難雜症吧！</p>
<h4 id="Q1-如果屬性名稱是特殊字符或動態產生的，該怎麼存取它的值呢？"><a href="#Q1-如果屬性名稱是特殊字符或動態產生的，該怎麼存取它的值呢？" class="headerlink" title="Q1:如果屬性名稱是特殊字符或動態產生的，該怎麼存取它的值呢？"></a>Q1:如果屬性名稱是特殊字符或動態產生的，該怎麼存取它的值呢？</h4><p>若要使用一些包含特殊或動態產生的字串作為屬性名稱，就必須使用鍵值存取<code>[]</code>的方式。</p>
<p>包含特殊字符的屬性名稱</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="string">&#x27;!!12345!!&#x27;</span>: <span class="string">&#x27;Hello Wrold&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line">obj.!!<span class="number">12345</span>!!; <span class="comment">//Uncaught SyntaxError: Unexpected token !</span></span><br><span class="line">obj[<span class="string">&quot;!!12345!!&quot;</span>]<span class="comment">// &quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>

<p>ES6新增動態產生的字串作為屬性名稱功能，讓key的值可經由運算得出。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> prefix = <span class="string">&#x27;fresh-&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> fruits = &#123;</span><br><span class="line">    [prefix + <span class="string">&#x27;apple&#x27;</span>]: <span class="number">100</span>,</span><br><span class="line">    [prefix + <span class="string">&#x27;orange&#x27;</span>]: <span class="number">60</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fruits[<span class="string">&#x27;fresh-apple&#x27;</span>]);<span class="comment">//100</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fruits[<span class="string">&#x27;fresh-orange&#x27;</span>]);<span class="comment">//60</span></span><br></pre></td></tr></table></figure>

<h4 id="Q2-屬性真的只能是字串嗎？可以是數字、物件等其他型別的值嗎？"><a href="#Q2-屬性真的只能是字串嗎？可以是數字、物件等其他型別的值嗎？" class="headerlink" title="Q2:屬性真的只能是字串嗎？可以是數字、物件等其他型別的值嗎？"></a>Q2:屬性真的只能是字串嗎？可以是數字、物件等其他型別的值嗎？</h4><p>屬性名稱只能是字串，若不是𡪤串則會被強制轉為字串。</p>
<p>如下，<code>obj[obj]</code>的key值被強制轉為字串<code>&#39;[object Object]&#39;</code>，同理，<code>obj[999]</code>的key值999也被轉為字串<code>&#39;999&#39;</code>了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="title class_">Qoo</span>: <span class="string">&#x27;有種果汁真好喝&#x27;</span> &#125;;</span><br><span class="line">obj[obj]=<span class="string">&#x27;喝的時候酷兒&#x27;</span>;</span><br><span class="line">obj[<span class="number">999</span>]=<span class="string">&#x27;喝完臉紅紅！&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj[<span class="string">&#x27;[object Object]&#x27;</span>]);<span class="comment">//喝的時候酷兒</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj[<span class="string">&#x27;999&#x27;</span>]);<span class="comment">//喝完臉紅紅！</span></span><br></pre></td></tr></table></figure>

<h4 id="函式（Function）vs方法（Method）"><a href="#函式（Function）vs方法（Method）" class="headerlink" title="函式（Function）vs方法（Method）"></a>函式（Function）vs方法（Method）</h4><p>闢謠…澄清…!!??</p>
<p>在其它語言中，屬於某個物件的函式稱為方法，但在JavaScript中，函式並不會特別屬於某個物件，物件充其量也只是儲存對某個函式的參考而已，並非真的「屬於」這個物件，因此，在JavaScript中，函式與方法是同義的，並沒有區別。除了在ES6新增的super參考，super與class一起使用時super會靜態綁定函式，經由這樣所綁定的函式就比較接近一般在其他語言所看到的方法了。</p>
<h4 id="陣列（Array）"><a href="#陣列（Array）" class="headerlink" title="陣列（Array）"></a>陣列（Array）</h4><p>陣列使用非負整數作為索引，注意…</p>
<ul>
<li><p>若使用具名特性（named property）作為索引，則不會增加陣列的長度。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array.<span class="property">length</span>); <span class="comment">// 3</span></span><br><span class="line">array[<span class="number">3</span>] = <span class="number">4</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array.<span class="property">length</span>); <span class="comment">// 4</span></span><br><span class="line">array[<span class="string">&#x27;foo&#x27;</span>] = <span class="string">&#x27;bar&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array.<span class="property">length</span>); <span class="comment">// 4, 陣列的長度不變！</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>具名特性（named property）若以字串格式存在，就會轉為數字。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">array[<span class="string">&#x27;3&#x27;</span>] = <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array);<span class="comment">//[1, 2, 3, &quot;foo&quot;]</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="複製物件"><a href="#複製物件" class="headerlink" title="複製物件"></a>複製物件</h4><p>  複製物件的方式分為淺拷貝與深拷貝兩種。</p>
<p>  為什麼要探討淺拷貝與深拷貝呢？這是根本於基本型別值是傳值而物件是傳參考的緣故，既然物件是傳參考，就要考慮是把整份資料都複製一份，還是複製參考就好？淺拷貝是複製參考，深拷貝是把整份資料都複制一份，常用於考慮物件資料是否要其用的狀況。</p>
<h5 id="淺拷貝（Shallow-Copy）"><a href="#淺拷貝（Shallow-Copy）" class="headerlink" title="淺拷貝（Shallow Copy）"></a>淺拷貝（Shallow Copy）</h5><p>  除了基本的資料型中純值（非物件）的資料會真的複製另外一份值之外，其他的都只是複製一份參考而已，例如：<code>Object.assign</code>在處理超過一層的物件時就只能做偮淺拷貝，只有一層的話是可以做偌深拷貝的。</p>
<h5 id="深拷貝（Deep-Copy）"><a href="#深拷貝（Deep-Copy）" class="headerlink" title="深拷貝（Deep Copy）"></a>深拷貝（Deep Copy）</h5><p>  複製整個物件，通常會使用JSON-safe的物件，先經由序列化為JSON字串後再剖析回物件。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> newObj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(oldobj));</span><br></pre></td></tr></table></figure>

<p>  範例如下。</p>
<p>  單層物件時，<code>Object.assign</code>與「先序列化再剖析」的方法都可以做完全的拷貝。也就是深拷貝，由於物件的比對的是比較儲存位置，因此當比較拷貝結果特，兩者是不相等的。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> simpleObj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">b</span>: <span class="number">2</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> newSimpleObj = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, simpleObj);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newSimpleObj === simpleObj);<span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newSimpleObj2 = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(newSimpleObj));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newSimpleObj2 === simpleObj);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>  那麼，物件再多層的狀況下，又是怎樣的狀況呢？如下，由於<code>Object.assign</code>只能做單層的拷貝，因此第二層開始就只是複製參考而已，儲存位置不變，故為true；而「先序列化再剖析」的方法則是完整地把整個資料複製起來，存到另一個地方，因此儲存位置不同，得到false。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">b</span>: &#123;</span><br><span class="line">        <span class="attr">c</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">d</span>: <span class="number">3</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> newObj = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, obj);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newObj.<span class="property">b</span> === obj.<span class="property">b</span>);<span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newObj2 = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(newObj));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newObj2.<span class="property">b</span> === obj.<span class="property">b</span>);<span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<h4 id="屬性描述器（Property-Descriptor）"><a href="#屬性描述器（Property-Descriptor）" class="headerlink" title="屬性描述器（Property Descriptor）"></a>屬性描述器（Property Descriptor）</h4><p>  屬性描述器可用來檢視屬性的特徵，例如：可入寫入（writable）、可否配置（configurable）與可否列舉（enumerable）。</p>
<p>  例如，檢視object.a這個屬性的特徵。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(obj, <span class="string">&#x27;name&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>  得到結果。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">  <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>, </span><br><span class="line">  <span class="attr">writable</span>: <span class="literal">true</span>, </span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">true</span>, </span><br><span class="line">  <span class="attr">configurable</span>: <span class="literal">true</span> </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>  使用defineProperty定義物件的屬性與特性。通常使用這種方法的目的是…</p>
<ul>
<li>新增屬性，通常是為了修改預設特徵的值。</li>
<li>若特性是configurable的話。則可用來修改屬性的特徵值。</li>
</ul>
<p>  範例如下，為物件obj定義一個新的屬性name，並設定其特徵值。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">// Apple</span></span><br></pre></td></tr></table></figure>

<h5 id="Writable"><a href="#Writable" class="headerlink" title="Writable"></a>Writable</h5><p>屬性的值是否「可被寫入」。</p>
<p>例如，設定name這個屬性是不可寫入的，因此當嘗試更新這個值的時候，發現無法更新，並且在strict mode之下會丟出TypeError的錯誤訊息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">false</span>,<span class="comment">//不可寫入！</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">// Apple</span></span><br><span class="line">obj.<span class="property">name</span>=<span class="string">&#x27;Grape&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">// Apple，屬性name的值無法被變更</span></span><br></pre></td></tr></table></figure>

<h5 id="Configurable"><a href="#Configurable" class="headerlink" title="Configurable"></a>Configurable</h5><p>屬性是否是「可配置的」，意即當configurable為false的時候，為法再使用defineProperty更新特徵的值，否則會丟出TypeError，但有一個例外，當configurable為false的時候，writable仍可由true改為false，但不能從false改為true。</p>
<p>當configurable為false的時候，無法再使用defineProperty更新特徵的值，否則會丟出TypeError。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,<span class="comment">// false -&gt; true</span></span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Uncaught TypeError: Cannot redefine property: name</span></span><br></pre></td></tr></table></figure>

<p>當configurable無false的時候，writable仍可由true改為false，但不能從false改為true。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,<span class="comment">//</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">false</span>,<span class="comment">//</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 這是可行的</span></span><br></pre></td></tr></table></figure>

<p>當configurable為false的時候，writable仍可由true改為false，但不能從false改為true。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">false</span>,<span class="comment">//</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,<span class="comment">//</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Uncaught TypeError: Cannot redefine property: name</span></span><br></pre></td></tr></table></figure>

<p>除了是否可更新特徵的設定外，configurable另一個作用就是是否可被delete刪除該屬性。</p>
<p>configurable設為false，屬性不可刪除。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,<span class="comment">//</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> obj.<span class="property">name</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">// Apple，name屬性未被刪除</span></span><br></pre></td></tr></table></figure>

<p>configurable設為true，屬性可被刪除。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> obj.<span class="property">name</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">//undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj);<span class="comment">//&#123;&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="Enumerable"><a href="#Enumerable" class="headerlink" title="Enumerable"></a>Enumerable</h5><p>特徵是否為「可列舉的」，例如：此物件的特性是否可在for…in中被列舉，若設定enumerable為false表示不會被列舉出來。</p>
<p>如下（1）印出hello和name，（2）由於name被設定為不可列舉的，因此只會印出hello。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line">obj.<span class="property">hello</span> = <span class="string">&#x27;world&#x27;</span>;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(prop);<span class="comment">//（1）</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//hello</span></span><br><span class="line"><span class="comment">//name</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(prop);<span class="comment">//（2）</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//hello</span></span><br></pre></td></tr></table></figure>

<p>題外話，會用到 defineProperty 這個東西是為了寫雙向綁定的小工具而追 Vue.js 的原始碼的時候玩到的，推薦閱讀<a href="https://github.com/DMQ/mvvm">這篇</a>文章。</p>
<h4 id="不可變性（Immutability）"><a href="#不可變性（Immutability）" class="headerlink" title="不可變性（Immutability）"></a>不可變性（Immutability）</h4><p>如何實作無法被變更的特性或物件？以下會介紹幾種作法，但都只能做到淺層的不可變性（shallow immutablility），意即若此物件有指向其他物件的參考，這個被指到的物件的內容就仍是可變的。</p>
<p>如下，假設foo是不可變的，但foo.list指向一個陣列，這個陣列的內容是可變的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = &#123;&#125;;</span><br><span class="line">foo.<span class="property">list</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">foo.<span class="property">list</span>.<span class="title function_">push</span>(<span class="number">4</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(foo.<span class="property">list</span>);<span class="comment">// [ 1, 2, 3, 4 ]</span></span><br></pre></td></tr></table></figure>

<h4 id="物件常數（Object-Constant）"><a href="#物件常數（Object-Constant）" class="headerlink" title="物件常數（Object Constant）"></a>物件常數（Object Constant）</h4><p>使用defineProperty設定writable為false且configurable為false，即可建立一個特性等同於常數的物件屬性，無法被更新、重新定義和刪除。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;CONST_PI&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="number">3.14</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">CONST_PI</span>);<span class="comment">// 3.14</span></span><br></pre></td></tr></table></figure>

<h4 id="避免擴充（Prevent-Extensions）"><a href="#避免擴充（Prevent-Extensions）" class="headerlink" title="避免擴充（Prevent Extensions）"></a>避免擴充（Prevent Extensions）</h4><p>使用<code>Object.preventExtensions</code>防止物件被加入新屬性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">preventExtensions</span>(obj);</span><br><span class="line">obj.<span class="property">hello</span> = <span class="string">&#x27;world&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">hello</span>);<span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>

<p>備註，在嚴格模式下，加入新屬性會丟出TypeError。</p>
<h4 id="密封（Seal）"><a href="#密封（Seal）" class="headerlink" title="密封（Seal）"></a>密封（Seal）</h4><p>使用<code>Objet.seal</code>來達到密封的作用，意即物件不可再新增屬性、重新配置特徵或刪除屬性，但可能可以修改屬性值。</p>
<p><code>Object.seal</code>會做兩件事</p>
<ul>
<li><p>將物件設定為<code>Object.preventExtensions</code>防止物件被加入新屬性。</p>
</li>
<li><p>將物件的屬性特性configurable設定為fals，物件的屬性不能被刪除，其特徵的值不能被更新。屬性值是否可被更新要看writable的值而定，若writable為true則可更新，若為false則不可更新。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">seal</span>(obj);</span><br><span class="line"><span class="comment">//嘗試加入新的屬性 hello</span></span><br><span class="line">obj.<span class="property">hello</span> = <span class="string">&#x27;world&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">hello</span>);<span class="comment">//undefined</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//嘗試刪除屬性name</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">delete</span> obj.<span class="property">name</span>); <span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">//Jack</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//嘗試重新設定特徵值</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="number">3.14</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// TypeError</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="凍結（Freeze）"><a href="#凍結（Freeze）" class="headerlink" title="凍結（Freeze）"></a>凍結（Freeze）</h4><p>使用<code>Object.freeze</code>建立一個已凍結的物件，意即這個物件不能新增屬性、更新屬性的值，刪除屬性和重新配置特徵值。</p>
<p><code>Object.freeze</code>會做以下的事情</p>
<ul>
<li>對物件呼叫<code>Object.seal</code>，讓物件不可再新增屬性、重新配置特徵或刪除屬性。</li>
<li>將物件的屬性時性writable設定為false，物件屬性的值不可被更改。</li>
</ul>
<p>回顧前面提到的，以上四種解法都只能做到淺層的不可變性（shallow immutability），因此若希望能將整個物件（包含屬性參考的物件）都凍結，可遞迴呼叫<code>Object.freeze</code>，但可能有副作用，像是凍結了共用的物件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [<span class="string">&#x27;apple&#x27;</span>, <span class="string">&#x27;grape&#x27;</span>];</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">favFruits</span>: list,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> anotherObj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Apple&#x27;</span>,</span><br><span class="line">    <span class="attr">favFruits</span>: list,</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">freeze</span>(obj);</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">freeze</span>(obj.<span class="property">favFruits</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//共用的物件被凍結！</span></span><br><span class="line">list.<span class="title function_">push</span>(<span class="string">&#x27;orange&#x27;</span>);<span class="comment">//Uncaught TypeError: Cannot add property 2, object is not extensible</span></span><br></pre></td></tr></table></figure>

<h4 id="Get"><a href="#Get" class="headerlink" title="[[Get]]"></a><code>[[Get]]</code></h4><p><code>[[Get]]</code>的功用是取得屬性值，例如：<code>obj.a</code>時會呼叫<code>[[Get]]()</code>這個函式呼叫，它會先在此物件內尋找是否有符合名稱的屬性，若無就順著原型串鏈繼續尋找，如果都沒有找偌，<code>[[Get]]</code>就會回傳undefined。注意，這和之前提到的在語彙範疇中查找變數（的名稱是否被定義）是不同的，若在語彙範疇中找到該變數，會丟出ReferrenceError。</p>
<h4 id="Put"><a href="#Put" class="headerlink" title="[[Put]]"></a><code>[[Put]]</code></h4><p><code>[[Put]]</code>的功用是…</p>
<p>若此屬性不存在，則新增此屬性並設定其值。但若此屬性存在，則做以下的事情…</p>
<ul>
<li><p>若此屬性是存取器描述器的取值器與設值器嗎？若是，則呼叫其設值器（setter）。</p>
</li>
<li><p>若此屬性是不可寫入的，在非嚴格模式下會無聲的失敗，但在嚴格模式下會丟出TypeError。</p>
</li>
<li><p>若屬性是可寫入的，就將值設定給這個屬性。</p>
<p>備註：上面提到的兩個名詞，這裡來做解釋…</p>
</li>
<li><p>資料描述器（data descriptor）：定義一個屬性時，此屬性不含取值器或設值器。</p>
</li>
<li><p>存取描述器（access descriptor）:存取器描述器是指當定義一個屬性時，若此屬性擁有取值器或設值器，這個定義就會成為存取器描述器。注意，此時屬性的value和特徵writable都會被忽略，而只需考慮set、get、configurable和enumerable。</p>
</li>
</ul>
<h4 id="取值器-Getter-與設值器（Setter）"><a href="#取值器-Getter-與設值器（Setter）" class="headerlink" title="取值器(Getter)與設值器（Setter）"></a>取值器(Getter)與設值器（Setter）</h4><p>物件預設的<code>[[Get]]</code>與<code>[[Put]]</code>掌控了屬性的建立、設定和更新、取得值的方式。若要複寫這兩種預設<code>[[Get]]</code>與<code>[[Put]]</code>行為，可透過取值器與設值器來達成。</p>
<p>方法一，使用物件字面值的方式定義屬性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">name</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_name_</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span> <span class="title function_">name</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_name_</span> = <span class="string">`Hi, I am <span class="subst">$&#123;val&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">obj.<span class="property">name</span> = <span class="string">&#x27;Jack&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">//Hi, I am Jack</span></span><br></pre></td></tr></table></figure>

<p>方法二，使用defineProperty的方式定義屬性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span> <span class="title function_">name</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_name_</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">set</span>: <span class="keyword">function</span> <span class="title function_">name</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_name_</span> = <span class="string">`Hi, I am <span class="subst">$&#123;val&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">obj.<span class="property">name</span> = <span class="string">&#x27;Jack&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">//Hi, I am Jack</span></span><br></pre></td></tr></table></figure>

<h4 id="存在（Existence）"><a href="#存在（Existence）" class="headerlink" title="存在（Existence）"></a>存在（Existence）</h4><p>既然屬性不存在的時候，會回傳undefined，但若屬性值原本就設定為undefined是不是就為法判定這個屬性到底存不存在了？</p>
<p>解法是使用hasOwnProperty，若想進一進確認該屬性是否可在其他物件中找偌，可搭配<code>prop in obj</code>檢查這個屬性是否存在於原型串鏈中。兩者差異是<code>prop in obj</code>會檢查原型串鏈，而hasOwnProperty只會檢查該物件。</p>
<p>範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj1 = &#123;</span><br><span class="line">    <span class="attr">job</span>: <span class="literal">undefined</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> obj = <span class="title class_">Object</span>.<span class="title function_">create</span>(obj1);<span class="comment">// 邁立 obj 與 obj1的連結</span></span><br><span class="line">obj.<span class="property">name</span> = <span class="literal">undefined</span>;</span><br></pre></td></tr></table></figure>

<p>屬性name其值雖然為undefined，但它直的存在於obj。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>);<span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;name&#x27;</span>));<span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>屬性job真的存在於obj嗎？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">job</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;job&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;job&#x27;</span> <span class="keyword">in</span> obj);<span class="comment">// true,但在原型串鏈中可找到</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj1.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;job&#x27;</span>));<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>屬性job其值雖然為undefined且不存在於obj中，但可在原型串鏈中可找偌，因此進一𦂇檢視obj1，確定為obj1的屬性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">hello</span>);<span class="comment">//undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;hello&#x27;</span>));<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello&#x27;</span> <span class="keyword">in</span> obj);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>雖然hello的值是undefined，似乎與前面的例子無異，但使用hadOwnProperty檢視，發現在在obj物件中，且經由<code>prop in obj</code>確認後發現也無法在原型串鏈中找到，因此屬性不存在。</p>
<p>總結…</p>
<ul>
<li>hasOwnProperty可檢測這個屬性是否存在於某個物件。</li>
<li><code>prop in obj</code>可檢查這個屬性是否可在原型串鏈中找到，讓我們能確認是否需要再往其他物件查找。</li>
</ul>
<h4 id="列舉（Enumeration）"><a href="#列舉（Enumeration）" class="headerlink" title="列舉（Enumeration）"></a>列舉（Enumeration）</h4><p>檢視屬性是否可被列舉的方法。</p>
<h5 id="in"><a href="#in" class="headerlink" title="in"></a>in</h5><p>in運算子只會帶出可列舉的屬性。</p>
<p>例如，obj有兩個屬性name和hello，其中name為可列舉的，hello為不可列舉的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;hello&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;world&#x27;</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(k, obj[k]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//name Jack</span></span><br></pre></td></tr></table></figure>

<h5 id="propertyIsEnumerable-NaN"><a href="#propertyIsEnumerable-NaN" class="headerlink" title="propertyIsEnumerable"></a>propertyIsEnumerable</h5><p>propertyIsEnumerable檢視屬性是否可被列舉。</p>
<p>例如，obj有兩個屬性name和hello，其中name為可列舉的，hello為不可列舉的。檢視name是否為可列舉的，會回傳true。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="title function_">propertyIsEnumerable</span>(<span class="string">&#x27;name&#x27;</span>));<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<h5 id="Object-keysvsObject-getOwnPropertyNames"><a href="#Object-keysvsObject-getOwnPropertyNames" class="headerlink" title="Object.keysvsObject.getOwnPropertyNames"></a><code>Object.keys</code>vs<code>Object.getOwnPropertyNames</code></h5><p><code>Object.keys</code>與<code>Object.getOwnPropertyNames</code>都只回傳此物件的屬性，且皆不檢視原型串鏈，兩者差異在於</p>
<ul>
<li><code>Object.keys</code>:回傳所有可列舉的屬性。</li>
<li><code>Object.getOwnPropertyNames</code>:回傳所有屬性，不管是否可被列舉。</li>
</ul>
<p>例如，obj有兩個屬性name和hello，其中name為可列舉的，hello為不可列舉的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">keys</span>(obj));<span class="comment">//[ &#x27;name&#x27; ]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getOwnPropertyNames</span>(obj));<span class="comment">//[ &#x27;name&#x27;, &#x27;hello&#x27; ]</span></span><br></pre></td></tr></table></figure>

<h4 id="迭代（Iteration）"><a href="#迭代（Iteration）" class="headerlink" title="迭代（Iteration）"></a>迭代（Iteration）</h4><p>迭代出陣列的值的方法。</p>
<h5 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a>forEach</h5><p>迭代陣列中所有的值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [<span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;Cathy&#x27;</span>, <span class="string">&#x27;Doll&#x27;</span>];</span><br><span class="line">list.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index, array</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item, index, array);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//Apple 0 [ &#x27;Apple&#x27;, &#x27;Bob&#x27;, &#x27;Cathy&#x27;, &#x27;Doll&#x27; ]</span></span><br><span class="line"><span class="comment">//Bob 1 [ &#x27;Apple&#x27;, &#x27;Bob&#x27;, &#x27;Cathy&#x27;, &#x27;Doll&#x27; ] </span></span><br><span class="line"><span class="comment">//Cathy 2 [ &#x27;Apple&#x27;, &#x27;Bob&#x27;, &#x27;Cathy&#x27;, &#x27;Doll&#x27; ] </span></span><br><span class="line"><span class="comment">//Doll 3 [ &#x27;Apple&#x27;, &#x27;Bob&#x27;, &#x27;Cathy&#x27;, &#x27;Doll&#x27; ]</span></span><br></pre></td></tr></table></figure>

<h5 id="every"><a href="#every" class="headerlink" title="every"></a>every</h5><p>檢查陣列中的每個值是否符條件，若是則回傳true。持續進行直到結束，或callback中回傳false就停止迭代。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;apple&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">20</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;corn&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">100</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;grape&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">50</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;pieapple&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">80</span>,</span><br><span class="line">    &#125;</span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> result = list.<span class="title function_">every</span>(<span class="function">(<span class="params">item, index, array</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item, index, array);</span><br><span class="line">    <span class="keyword">return</span> item.<span class="property">cout</span> &gt; <span class="number">50</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`result: <span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line"><span class="comment">//&#123; name: &#x27;apple&#x27;, count: 20 &#125; 0 [ &#123; name: &#x27;apple&#x27;, count: 20 &#125;,   &#123; name: &#x27;corn&#x27;, count: 100 &#125;,   &#123; name: &#x27;grape&#x27;, count: 50 &#125;,   &#123; name: &#x27;pieapple&#x27;, count: 80 &#125; ]</span></span><br><span class="line"><span class="comment">//result: false</span></span><br></pre></td></tr></table></figure>

<h5 id="some"><a href="#some" class="headerlink" title="some"></a>some</h5><p>檢查陣列中的是否有值符合條件，若是則回傳true。持續進行直到結束，或callback中回傳true就停止迭代。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;apple&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">20</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;corn&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">100</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;grape&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">50</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;pieapple&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">80</span>,</span><br><span class="line">    &#125;</span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> result = list.<span class="title function_">some</span>(<span class="function">(<span class="params">item, index, array</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item, index, array);</span><br><span class="line">    <span class="keyword">return</span> item.<span class="property">count</span> &gt; <span class="number">50</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`result: <span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line"><span class="comment">//&#123; name: &#x27;apple&#x27;, count: 20 &#125; 0</span></span><br><span class="line"><span class="comment">//&#123; name: &#x27;corn&#x27;, count: 100 &#125; 1</span></span><br><span class="line"><span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>若想看更多陣列處理方法，可參考<a href="https://wcc723.github.io/javascript/2017/06/29/es6-native-array/">這裡</a></p>
<h5 id="for-of"><a href="#for-of" class="headerlink" title="for...of"></a><code>for...of</code></h5><p>使用ES6的<code>for...of</code>迭代陣列。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> v <span class="keyword">of</span> array) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<h4 id="回顧-9"><a href="#回顧-9" class="headerlink" title="回顧"></a>回顧</h4><p>看完這篇文章，我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>建立物件有兩種方式-宣告式與建構形式，前都較常用，而後者有一些雷區，非必要不建議使用。</li>
<li>typeof可檢查資料型別； 當使用建構式建立字串、布林或數字等值時，建立的其實不是基本型別而是物件，因此可用instanceof來檢查是由哪個建構式建立的，也可檢視該物件是屬於哪個子型別。</li>
<li>物件的內容是由屬性組成的，而屬性是由key-value pari構成，value可為任意資料型別的值，並且值是以參考的方式儲存。</li>
<li>物件的屬性若包含特殊字符為動態產生的字串，則必須使用鍵值<code>[]</code>的方法存取。</li>
<li>複製物件的方法分為淺拷貝與深拷貝兩種，<code>Object.assign</code>只能處理一層內的深拷貝，而直正的深貝通常是由JSON-safe的物件先經由序列化為JSON字串後再剖析回物件來達成。</li>
<li>屬性描述器可用來檢視屬性的特徵，例如：是否可寫入、是否可配置、是否可列舉。</li>
<li>實作不可變的物件的方法，例如：設定屬性描述器、避免擴充、密封、凍結。</li>
<li>物件預設的<code>[[Get]]</code>與<code>[[Put]]</code>掌控了屬性的建立、設定和更新、取得值的方式，若要複寫這兩種預設<code>[[Get]]</code>與<code>[[Put]]</code>行為，可透過取值器與設值器來達成。</li>
<li>hasOwnProperty與<code>prop in obj</code>可判斷屬性是否存在。</li>
<li>判斷屬性是否可列舉的方法-in運算子帶出此物件可列舉的屬性、propertyIsEnumerable檢視屬性是否可被列舉、<code>Object.keys</code>與<code>Object.getOwnPropertyNames</code>都只回傳此物件的屬性，差異在於前都只列出可列舉的屬性，而後者會列出所有此物件的屬性。</li>
<li>迭代出陣列中的值的方法，例如：forEach、every、some、<code>for...of</code>。</li>
</ul>
<h5 id="References-7"><a href="#References-7" class="headerlink" title="References"></a>References</h5><p><a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/this%20%26%20object%20prototypes/ch3.md">You Don’t Know JS: this &amp; Object Prototypes, Chapter 3: Objects</a></p>
<h3 id="你懂JavaScript嗎？（簡易版）物件導向概念"><a href="#你懂JavaScript嗎？（簡易版）物件導向概念" class="headerlink" title="你懂JavaScript嗎？（簡易版）物件導向概念"></a>你懂JavaScript嗎？（簡易版）物件導向概念</h3><p>本文主要會談到簡單的物件導向概念，作為後續「原型」（Prototypes）的暖身。</p>
<h4 id="類別（Class）、邁構子（Constructor）、實體（Instance）"><a href="#類別（Class）、邁構子（Constructor）、實體（Instance）" class="headerlink" title="類別（Class）、邁構子（Constructor）、實體（Instance）"></a>類別（Class）、邁構子（Constructor）、實體（Instance）</h4><p>「類別」可想像成是建構某特定物體的藍圖或模具，而「實體」就是按照這藍圖或模具製造出來的成品。這當中需要使用類別的一個特殊方法「建構子」來做初始化的動作。</p>
<p>虛擬碼如下，Person是一個類別，利用與類別同名的建構子Person做初始化，進而建立出實體Jack。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Persion</span> &#123;</span><br><span class="line">    career = <span class="literal">null</span>;</span><br><span class="line">    <span class="title class_">Persion</span>(job) &#123;</span><br><span class="line">        career = job;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">sayHi</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">print</span>(<span class="string">&#x27;Hello, I am a/n &#x27;</span>, <span class="variable language_">this</span>.<span class="property">career</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Jack</span> = <span class="keyword">new</span> <span class="title class_">Persion</span>(<span class="string">&#x27;engineer&#x27;</span>);</span><br><span class="line"><span class="title class_">Jack</span>.<span class="title function_">sayHi</span>();</span><br></pre></td></tr></table></figure>

<p>在真實的世界裡，JavaScript用什麼方式呈現呢？舉個最簡單的例子。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="property">length</span>);<span class="comment">//11</span></span><br></pre></td></tr></table></figure>

<p>String是個類別方法，在這裡當建構子用，任何給定的字串都是這個類別的實體，它幫我們包裝了可在這個字串上執行的各種功能。因此，str是String的實體，可執行<code>str.length</code>取得字串長度。</p>
<p>不過，在JavaScript的世界中，並沒有真正的類別的概念，只能使用設計模式（design pattern）來模擬，我們在稍後的原型中會看到各種解法與優劣討論。</p>
<h4 id="繼承（Inheritance）"><a href="#繼承（Inheritance）" class="headerlink" title="繼承（Inheritance）"></a>繼承（Inheritance）</h4><p>定義一個類別，其特性繼承（也可說是擴充extend）自另外一個類別，稱它們為「父類別」與「子類別」，其中，子類別繼承父類別的特性。</p>
<p>如下，CoolPersion繼承自Person，其中sayHi繼承了來自Person的方法並做覆寫。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Persion</span> &#123;</span><br><span class="line">  career = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Persion</span>(job) &#123;</span><br><span class="line">    career = job;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">sayHi</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">pring</span>(<span class="string">&#x27;Hello, I am a/n&#x27;</span>, career);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoolPerson</span> inherits <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="title function_">sayHi</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="attr">inherited</span>: <span class="title function_">sayHi</span>();</span><br><span class="line">    <span class="title function_">pring</span>(<span class="string">&#x27;I love my job!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">eat</span>(<span class="params">food</span>) &#123;</span><br><span class="line">    <span class="title function_">pring</span>(<span class="string">&#x27;I am eating...&#x27;</span>, food);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>「多重繼承」（multiple inheritance）是指子類別可繼承一個以上的父類別，但由於JavaScript並沒有提供原生機制來處理這重情況，因此不做討論。</p>
<h4 id="多型（Polymorphism）"><a href="#多型（Polymorphism）" class="headerlink" title="多型（Polymorphism）"></a>多型（Polymorphism）</h4><p>「多型」是指子類別除了擁有自己的方法外，這個方法還能覆寫來特化父類別的同名方法，以賦予其更特殊的行為，</p>
<p>如上，CoolPersion的sayHi與其父類別Persion的sayHi同名，它使用<code>inherited:sayHi()</code>參考它所繼承且未被覆寫的父類別同名方法並作呼叫，接著加上<code>pring(&#39;I love my job!&#39;)</code>這個屬於它自已的功能。其中，不指定參考哪一層父類別（可能是袓父類別XD）的方式稱為「相對多型」，而若有指名是哪層父類別的方法，那就是「絕對多型」了。</p>
<h4 id="回顧-10"><a href="#回顧-10" class="headerlink" title="回顧"></a>回顧</h4><p>看完這篇文章，我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li>「類別」可想像成是建構某特定物體的藍圖或模具，而「實體」就是按照這監圖或模具製造出來的成品，並使用「建構子」來建立和初始化實體。</li>
<li>定義一個類別，其特性繼承於另外一個類別，稱它們為「父類別」與「子類別」，而子類別「繼承」了父類別的特性。</li>
<li>「多型」是指子類別除了擁有自已的方法外，這個方法還能覆寫來特化父類別的同名方法，以賦予其更特殊的行為。</li>
</ul>
<h5 id="References-8"><a href="#References-8" class="headerlink" title="References"></a>References</h5><p>[You Don’t Know JS: this &amp; Object Prototypes, Chapter 4: Mixing (Up) “Class” Objects](<a href="https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/this">https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/this</a> %26 object prototypes&#x2F;ch4.md)</p>
<h3 id="你懂JavaScript？原型（Prototype）"><a href="#你懂JavaScript？原型（Prototype）" class="headerlink" title="你懂JavaScript？原型（Prototype）"></a>你懂JavaScript？原型（Prototype）</h3><p>本文主要會談到</p>
<ul>
<li>類別、建構子與實體</li>
<li>什麼是原型串鏈？原型串鏈的功用是？</li>
<li>什麼是原型式繼承？</li>
<li>疑難雜症大解惑-如何分辨屬性是位於該物件或原型串鏈上的？如何分辨誰是誰的實體？誰是誰的建搆子？原型串鏈有終點嗎？如何建立兩物件的連結？物件屬性的設定與遮蔽規則有哪些？</li>
</ul>
<h4 id="前言-3"><a href="#前言-3" class="headerlink" title="前言"></a>前言</h4><p>JavaScript並不像Java、C++這些知名的物件導向語言具有「類別」（class）來區分概念與實體（instance）或天生具有繼承的能力，而只有「物件」，因此只能利用設計模式來模擬這些功能。本文就來探討在JavaScript世界中，到底是㤰麼實現物件導向的概念的？</p>
<p>首先要有個模子，我們稱它為類別，而當前面有new的時候，可看成是建構子（constructor），接著用這個建構子做初始化，進而建立（new）實體。</p>
<p>如下，建構子Book產出實體ydkjs_1和ydkjs_2</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Book</span>(<span class="params">name, pNum</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name; <span class="comment">//書名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pNum</span> = pNum; <span class="comment">//頁數</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">setComments</span> = <span class="keyword">function</span> (<span class="params">comment</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">comment</span> = comment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ydkhs_1 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;導讀，型別與文法&#x27;</span>, <span class="number">257</span>);</span><br><span class="line"><span class="keyword">var</span> ydkhs_2 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;範疇與閉包 / this 與物件原型&#x27;</span>, <span class="number">251</span>);</span><br><span class="line"></span><br><span class="line">ydkhs_1.<span class="title function_">setComments</span>(<span class="string">&#x27;好書！&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkhs_1.<span class="property">comment</span>);<span class="comment">//好書！</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkhs_1.<span class="property">setComments</span> === ydkhs_2.<span class="property">setComments</span>);<span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>共用的屬性或方法，不用每次都幫實體建立一份，提出來放到prototype即可。承上，將setComments這個共用的方法放到<code>Book.prototype</code>，暫且稱它為Book原型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Book</span>(<span class="params">name, pNum</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name; <span class="comment">//書名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pNum</span> = pNum; <span class="comment">//頁數</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = <span class="literal">null</span>;<span class="comment">//評等</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setComments</span> = <span class="keyword">function</span> (<span class="params">comment</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = comment;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ydkhs_1 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;導讀，型別與文法&#x27;</span>, <span class="number">257</span>);</span><br><span class="line"><span class="keyword">var</span> ydkhs_2 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;範疇與閉包 / this 與物件原型&#x27;</span>, <span class="number">251</span>);</span><br><span class="line"></span><br><span class="line">ydkhs_1.<span class="title function_">setComments</span>(<span class="string">&#x27;好書！&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkhs_1.<span class="property">comment</span>);<span class="comment">//好書！</span></span><br><span class="line"></span><br><span class="line">ydkhs_2.<span class="title function_">setComments</span>(<span class="string">&#x27;超好書！&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkhs_2.<span class="property">comment</span>);<span class="comment">//超好書！</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkhs_1.<span class="property">setComments</span> === ydkhs_2.<span class="property">setComments</span>);<span class="comment">// true，確認是同一個函式</span></span><br></pre></td></tr></table></figure>

<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><h5 id="請勿修改原生原型"><a href="#請勿修改原生原型" class="headerlink" title="請勿修改原生原型"></a>請勿修改原生原型</h5><p>在這裡都是在設定自已建立的物件的原型！不要嘗試修改預設的原生原型（例如：<code>String.prototype</code>），也不要無條件地擴充原生原型，若要擴充也應該撰寫符合規格的測試程式，另外不要使用原生原型當成變數的初始值，以避免無意間的修改。</p>
<h5 id="關於建構子…"><a href="#關於建構子…" class="headerlink" title="關於建構子…"></a>關於建構子…</h5><ul>
<li><p>在JavaScript中，除了沒有類別外，其實也沒有建構子，因此</p>
<ul>
<li>只要函式前有new，這個函式就是建構子。</li>
<li>只要函式前有new來個呼叫，就叫做建構子呼叫。</li>
</ul>
</li>
<li><p>new關鍵字要做哪些事情呢？它的工作就是</p>
<ol>
<li>建立一個新的物件。</li>
<li>將物件的<code>.__proto__</code>指向建構子的prototype，形成原型串鏈。</li>
<li>將建構子的this指向new出來的新物件。</li>
<li>回傳這個物件。</li>
</ol>
</li>
</ul>
<h4 id="原型串鏈（Prototype-Chain）"><a href="#原型串鏈（Prototype-Chain）" class="headerlink" title="原型串鏈（Prototype Chain）"></a>原型串鏈（Prototype Chain）</h4><p>在前面[巢狀範疇](# 巢狀範疇（Nested Scope）)的部份提到「若在目前執行的範疇找不到這個變數的時候，就往外層的範疇搜尋，持續搜尋直到找到為止，或直到最外層的全域範疇」，同理， 當查找物件的屬性或方法時，若在本身這個物件找不到的時候，就會往更上一層物件尋找，直到串鏈尾端<code>Object.prototype</code>，若無法找到就回傳undefined，而這個尋找的脈絡就是依循著<code>.__proto__</code>這個原型串鏈（prototype chain）來找–每個物件在建立之初都會個<code>.__proto__</code>（dunder proto）內部屬性，它可用存取另一個相連物件內部屬性<code>[[prototype]]</code>的值，而<code>[[prototype]]</code>存放其建構子原型的位置。</p>
<p>如下範例，<code>ydkjs_1.__proto__</code>所存的參考即指向<code>Book.prototype</code>的位置。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Book</span>(<span class="params">name, pNum</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name; <span class="comment">//書名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pNum</span> = pNum; <span class="comment">//頁數</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = <span class="literal">null</span>;<span class="comment">//評等</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setComments</span> = <span class="keyword">function</span> (<span class="params">comment</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = comment;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ydkjs_1 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;導讀，型別與文法&#x27;</span>, <span class="number">257</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1.<span class="property">__proto__</span> === <span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>模型圖。</p>
<img src="ydkjs-book-prototype.png" style="zoom:85%;" />

<p>由於在ydkjs_1是找不到方法setComments的，因此就會循著<code>.__proto__</code>找到Book.prototype而找到方法setComments，也因為原型串鏈，讓JavaScript可達到類似其他物件導向語言般的使用類別、繼承的功能。</p>
<p>備註，使用<code>.__proto__</code>來取得<code>[[Prototype]]</code>似乎太暴力了（畢竟人家是內部屬性嘛），還是改用<code>Object.getPrototypeOf(..)</code>來得優雅，其中<code>Object.getPrototypeOf(..)</code>會回傳<code>.__proto__</code>的值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1.<span class="property">__proto__</span> === <span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(ydkjs_1) === <span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>接著來看幾個疑難雜症。</p>
<h5 id="Q1：到底是誰的屬性？"><a href="#Q1：到底是誰的屬性？" class="headerlink" title="Q1：到底是誰的屬性？"></a>Q1：到底是誰的屬性？</h5><p>可用<code>hasOwnProperty</code>檢查屬性是屬於當前物件，還是位於原型串錄中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;name&#x27;</span>));<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;setComments&#x27;</span>));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>name的確是存在於物件ydkjs_1中的，而setComments並不在物件ydkjs_1中，是在原型串鏈中。</p>
<p>注意</p>
<ul>
<li>hasOwnProperty只會檢查該物件，而不會檢查整條原型串鏈。</li>
<li>for loop <code>prop in obj</code>會檢查整個原型串鏈且為可列舉的屬性。</li>
<li><code>prop in obj</code>會檢查整個原型串鏈，不管屬性是否可列舉。</li>
</ul>
<p>範例如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Book</span>(<span class="params">name, pNum</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name; <span class="comment">//書名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pNum</span> = pNum; <span class="comment">//頁數</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = <span class="literal">null</span>;<span class="comment">//評等</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setComments</span> = <span class="keyword">function</span> (<span class="params">comment</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = comment;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ydkjs_1 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;導讀，型別與文法&#x27;</span>, <span class="number">257</span>);</span><br><span class="line"><span class="keyword">var</span> ydkjs_2 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;範疇與閉包 / this 與物件原型&#x27;</span>, <span class="number">251</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(ydkjs_1, <span class="string">&#x27;hello&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;world&#x27;</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">false</span>,<span class="comment">//設定 hello 為不可列舉的屬性</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>由於for loop <code>prop in obj</code>會檢查整個原型串鏈且為可列舉的屬性，因此除了hello之外，其它的屬性都會被列出來。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> prop <span class="keyword">in</span> ydkjs_1) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(prop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果得到</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//name</span></span><br><span class="line"><span class="comment">//pNum </span></span><br><span class="line"><span class="comment">//comment </span></span><br><span class="line"><span class="comment">//setComments </span></span><br></pre></td></tr></table></figure>

<p>承上，<code>prop in obj</code>會檢查整個原型串鏈，不管屬性是否可列舉。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello&#x27;</span> <span class="keyword">in</span> ydkjs_1);<span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;name&#x27;</span> <span class="keyword">in</span> ydkjs_1);<span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h5 id="Q2：到底是誰的實體？"><a href="#Q2：到底是誰的實體？" class="headerlink" title="Q2：到底是誰的實體？"></a>Q2：到底是誰的實體？</h5><p><code>instanceof</code>檢查物件是否為指定的建構子所建立的實體，位於<code>instanceof</code>左邊的運算元是物件，右邊的是函式，若左邊的物件是由右邊函式所產生的，則會回傳true，否則為false。<code>instanceof</code>可檢查整修原型串鏈的繼承世系，這在傳統的物件導向環境中稱為「內省」（introspection）或「反思」（reflection）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Book</span>(<span class="params">name, pNum</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name; <span class="comment">//書名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pNum</span> = pNum; <span class="comment">//頁數</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = <span class="literal">null</span>;<span class="comment">//評等</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setComments</span> = <span class="keyword">function</span> (<span class="params">comment</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = comment;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ydkjs_1 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;導讀，型別與文法&#x27;</span>, <span class="number">257</span>);</span><br><span class="line"><span class="keyword">var</span> ydkjs_2 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;範疇與閉包 / this 與物件原型&#x27;</span>, <span class="number">251</span>);</span><br></pre></td></tr></table></figure>

<p>ydkjs_1與ydkjs_2都是由Book建立出來的實體，而Book也是由Object與Function建立出來的。因此都會得到true，最後舉個反例，window不是由Book建立出來的，因此得到false。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1 <span class="keyword">instanceof</span> <span class="title class_">Book</span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_2 <span class="keyword">instanceof</span> <span class="title class_">Book</span>);<span class="comment">//true</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1 <span class="keyword">instanceof</span> <span class="title class_">Object</span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1 <span class="keyword">instanceof</span> <span class="title class_">Function</span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_2 <span class="keyword">instanceof</span> <span class="title class_">Object</span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_2 <span class="keyword">instanceof</span> <span class="title class_">Function</span>);<span class="comment">//true</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">window</span> <span class="keyword">instanceof</span> <span class="title class_">Book</span>);<span class="comment">//false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">window</span> <span class="keyword">instanceof</span> <span class="variable language_">window</span>);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>另外一個方法是使用<code>isPrototypeOf</code>，它可檢視運算子左邊的物件是否出現於右邊物件的原型串鏈中。與<code>instanceof</code>不同之處只在於運算元的資料型別不同而已，但功能是相同的。</p>
<p>再看一次這個相似的範例，Novel繼承了Book，並建立實體novel。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Book</span>(<span class="params">name, pNum</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name; <span class="comment">//書名</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pNum</span> = pNum; <span class="comment">//頁數</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = <span class="literal">null</span>;<span class="comment">//評等</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setComments</span> = <span class="keyword">function</span> (<span class="params">comment</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">comment</span> = comment;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Novel</span>(<span class="params">name, pNum, price</span>) &#123;</span><br><span class="line">    <span class="title class_">Book</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, [name, pNum]);<span class="comment">//Novel 繼承 Book</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">price</span> = price;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Novel</span>.<span class="property"><span class="keyword">prototype</span></span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Novel</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">printPrice</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> is <span class="subst">$&#123;<span class="variable language_">this</span>.price&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ydkjs_1 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;導讀，型別與文法&#x27;</span>, <span class="number">257</span>);</span><br><span class="line"><span class="keyword">var</span> ydkjs_2 = <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="string">&#x27;範疇與閉包 / this 與物件原型&#x27;</span>, <span class="number">251</span>);</span><br><span class="line"><span class="keyword">var</span> novel = <span class="keyword">new</span> <span class="title class_">Novel</span>(<span class="string">&#x27;最近沒在看小說 &gt;&lt;&#x27;</span>, <span class="number">500</span>, <span class="number">600</span>);</span><br></pre></td></tr></table></figure>

<p>我們來檢視幾個問題…</p>
<ul>
<li>在ydkjs_1的整個原型串鏈中，是否出現過Book.prototype？</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="title function_">isPrototypeOf</span>(ydkjs_1));<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在novel的整個原型串鏈中，是否出現過Book.prototype？</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="title function_">isPrototypeOf</span>(novel));<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在ydkjs_1的整個原型串鏈中，是否出現過Novel.prototype？</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Novel</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="title function_">isPrototypeOf</span>(ydkjs_1));<span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在novel的整個原型串鏈中，是否出現過Novel.prototype？</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Novel</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="title function_">isPrototypeOf</span>(novel));<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>看模型圖會更清楚</p>
<img src="prototype_example.png" style="zoom:85%;" />

<p>注意，這裡的繼承是指原型式繼承（prototypal inheritance）。</p>
<p>「原型式繼承」是指使用連結相連兩個物件而能共用屬性的方式，又稱為「差異式繼承」（differential inheritance），它模仿了傳統物件導向語言的類別方法，而達到繼承的功能。</p>
<p>說明</p>
<ul>
<li><code>Novel.prototype = Object.Create(Book.prototype);</code>的<code>Object.create</code>建立了一個新物件（稱呼它為O），並將<code>O.__proto__</code>設定為Book.prototype，因此我們可以想成藉由O這個橋樑，讓<code>Novel.prototype.constructor === Book</code>。</li>
<li>承上，也可改用ES6的<code>setPrototypeof</code>來設定<code>[[Prototype]]</code>內部屬性的值。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pre-ES6</span></span><br><span class="line"><span class="comment">// throws away default existing `Novel.prototype`</span></span><br><span class="line">Novel.prototype = Object.create(Book.prototype);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ES6+</span></span><br><span class="line"><span class="comment">// modifies existing `Novel.prototype`</span></span><br><span class="line">Object.setPrototypeOf(Novel.prototype, Book.prototype);</span><br></pre></td></tr></table></figure>

<p><code>Object.getPrototypof</code>。</p>
<p>ydkjs_1的<code>[[Prototype]]</code>的值是？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(ydkjs_1) === <span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>或等同直接使用<code>.__proto__</code>取得<code>[[Prototype]]</code>的值，也是可行的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1.<span class="property">__proto__</span> === <span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<h6 id="備註-1"><a href="#備註-1" class="headerlink" title="備註"></a>備註</h6><ul>
<li><p>雖然剛才說「<code>instanceof</code>檢查物件是否為指定的建構子所建立的實體」，但其實<code>instanceof</code>所檢視的是物件的內部屬性<code>[[Prototype]]</code>(或說是<code>__proto__</code>)所形成的整條原型串鏈中，是否能找到其建構子原型。例如：ydkjs_1與ydkjs_2的<code>__proto__</code>屬性是否為<code>Book.prototype</code>？（答案是肯定的）</p>
</li>
<li><p>Object與Functon互為彼此的實體，意即<code>Function.__proto__</code>指向<code>Object.prototype</code>，而<code>Object.__proto__</code>也指向<code>Function.prototype</code>。</p>
</li>
<li><p>在下一篇文章「行為委派」中，我們會將「繼承世系」改稱為「委派連結」（delegation link），這會比較符合JavaScript的現況。</p>
</li>
</ul>
<h5 id="Q3：原型串鏈的終點是？"><a href="#Q3：原型串鏈的終點是？" class="headerlink" title="Q3：原型串鏈的終點是？"></a>Q3：原型串鏈的終點是？</h5><p>承上範例，針對這整條原型串鏈，我們就拿它來檢看看…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ydkjs_1.<span class="property">__proto__</span> === <span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Book</span>.<span class="property">__proto__</span> === <span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Book</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> === <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>);<span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span>);<span class="comment">//null</span></span><br></pre></td></tr></table></figure>

<p>因此，Object.prototype物件就是整條串鏈的最頂端了。我們可想像成，在查找變數時，最後的終點就是全域範疇了。</p>
<p>Object.prototype這個物件含有很多常用的屬性和方法，例如：toString、valueOf等這也就是為什麼所有的物件都能使用這些功能的原因。</p>
<h5 id="Q4：屬性的設定與遮蔽"><a href="#Q4：屬性的設定與遮蔽" class="headerlink" title="Q4：屬性的設定與遮蔽"></a>Q4：屬性的設定與遮蔽</h5><p>查找物件的屬性或方法時要注意設定與遮蔽的問題。</p>
<p>我們可能遇過以下這種狀況…</p>
<p>物件obj有屬性counter作為計數器，而anotherObj無此屬性且原型串列的參考指向obj。可能是一時手誤吧，居然將<code>anotherObj.counter</code>當計數器做遞增，之後在程式某處分別印出<code>obj.count</code>與<code>anotherObj.count</code>，發現居然所存的值是不一樣的！這到底發生了什麼事呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">counter</span>: <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> anotherObj = <span class="title class_">Object</span>.<span class="title function_">create</span>(obj);</span><br><span class="line">anotherObj.<span class="property">counter</span>++;<span class="comment">// 一時手誤，應改為obj.counter++</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">counter</span>);<span class="comment">//0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(anotherObj.<span class="property">counter</span>);<span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">obj.<span class="property">counter</span>++;</span><br><span class="line">anotherObj.<span class="property">counter</span>++;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">counter</span>);<span class="comment">//1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(anotherObj.<span class="property">counter</span>);<span class="comment">//2</span></span><br></pre></td></tr></table></figure>

<p>目前已知，anotherObj並無counter屬性，而counter屬性位於原型串鏈<code>[[Prototype]]</code>更上一層的obj之內。當使用指定運算子更新counter屬性值的時候，會依照以下規則來決定處理的方式</p>
<ol>
<li>此屬性可被寫入（writable為true），則anotherObj會新增此屬性，而產生遮蔽（shadowing）的效果。</li>
<li>此屬性不可被寫入（writable為false），則在嚴格模式下會被報錯，而在非嚴格模式下，會忽略這個設定&#x2F;更新。</li>
<li>此屬性有設定setter、因此會回傳setter所設定的預設值。</li>
</ol>
<p>在上面的這個例子中，是屬於狀況「1」，因此目前obj與anotherObj兩物件上都具有counter屬性了。解法是小心一點。不要再手誤了！</p>
<h5 id="Q5：一定要用「類別」的概念才能建立兩物件的連結嗎？"><a href="#Q5：一定要用「類別」的概念才能建立兩物件的連結嗎？" class="headerlink" title="Q5：一定要用「類別」的概念才能建立兩物件的連結嗎？"></a>Q5：一定要用「類別」的概念才能建立兩物件的連結嗎？</h5><p>答案是「不必」。</p>
<p><code>Object.create(..)</code>可將兩個物件連結起來，如下<code>Object.create(..)</code>可建立一個新物件coolPerson，連結到指定的物件person，意即設定<code>coolPerson.__proto__</code>指向person。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">sayHi</span>: <span class="keyword">function</span> (<span class="params">name</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> coolPerson = <span class="title class_">Object</span>.<span class="title function_">create</span>(person);<span class="comment">// coolPerson.__proto__ === person</span></span><br><span class="line">coolPerson.<span class="title function_">sayHi</span>(<span class="string">&#x27;Jack&#x27;</span>);<span class="comment">// Hi, I am Jack</span></span><br></pre></td></tr></table></figure>

<p>備註，若使用<code>Object.create(null)</code>建立一個空物件，那它就直的非常空，裡面不含依何屬性，因此也就沒有<code>.__proto__</code>或<code>.constructor</code>可用了，通常會單純當成存資料用的物件而已。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> empty = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line">empty;<span class="comment">//&#123;&#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(empty.<span class="property">__proto__</span>);<span class="comment">// undefined--很空，什麼都沒有</span></span><br></pre></td></tr></table></figure>

<h5 id="Q6-連結作為備援之用？"><a href="#Q6-連結作為備援之用？" class="headerlink" title="Q6:連結作為備援之用？"></a>Q6:連結作為備援之用？</h5><p>原型串鏈的功用只是當備援(fallback)之？用意即，當查找的屬性無法在當前物件找到時，就往更上一層的物件尋找。</p>
<p>但其實沒這麼簡單，我們在下一篇文章「行為委派」會看到它的強大之處，例如，讓物件建立平等的委派關係以取得屬性和方法，實作更簡單物懂的設計模式。</p>
<h4 id="回顧-11"><a href="#回顧-11" class="headerlink" title="回顧"></a>回顧</h4><p>我們到底有什麼收穫呢？藉由本文可以理解到…</p>
<ul>
<li><p>原型串錄是指經由物件的內部屬性<code>.__proto__</code>而形成的物件到物件的連結串連，當查找物件屬性時，若在本身這個物件找不到，就往更上一層物件尋找，直到串鏈尾端，若無法找到就回傳undefined。<code>.__proto__</code>存放的即為其建構子原型的參考。</p>
</li>
<li><p>JavaScript沒有類吸，也沒有建構子，因此</p>
<ul>
<li>只要函式前有new，這個函就是建構子</li>
<li>只要函式前有new來個呼叫，就叫做建構子呼叫。</li>
</ul>
</li>
<li><p>JavaScript中的繼承是指原型式繼式或差異式繼承，意即使用連結兩個物件而能共用屬性的方式來模擬物件導向語言的類別與繼承功能。</p>
</li>
<li><p>hasOwnProperty可用來檢查屬性是屬於當前物件，還是位於原型串鏈中。</p>
</li>
<li><p>instanceof與isPrototypeOf可用來檢查物件是否為指定的建構子所建立的實體；</p>
<p><code>Object.getPrototypeOf</code>可取得物件的<code>[[Prototype]]</code>的值；</p>
<p><code>Object.setPrototypeOf</code>可設定物件的<code>[[Prototype]]</code>的值；</p>
</li>
<li><p><code>Object.prototype</code>就整條原型串鏈的終點。</p>
</li>
<li><p>物件屬性的設定與遮蔽規則。</p>
</li>
<li><p><code>Object.create(..)</code>可將兩個物件連結起來。</p>
</li>
</ul>
<h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://ithelp.ithome.com.tw/users/20092232/ironman/1612">你懂 JavaScript 嗎？</a></p>
<p><a href="https://github.com/getify/You-Dont-Know-JS/tree/1st-ed">You Don’t Know JS 1st Edition</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E8%A8%98%E9%8C%84Flask-SocketIO%E7%9A%84%E5%9D%91/%E8%A8%98%E9%8C%84Flask-SocketIO%E7%9A%84%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%A8%98%E9%8C%84Flask-SocketIO%E7%9A%84%E5%9D%91/%E8%A8%98%E9%8C%84Flask-SocketIO%E7%9A%84%E5%9D%91/" class="post-title-link" itemprop="url">記錄Flask-SocketIO的坑</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-06-27 09:15:00" itemprop="dateCreated datePublished" datetime="2019-06-27T09:15:00+00:00">2019-06-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/" itemprop="url" rel="index"><span itemprop="name">學習</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/Python/Flask-SocketIO/" itemprop="url" rel="index"><span itemprop="name">Flask-SocketIO</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在測試Flask-SocketIO有遇到一些坑，記錄一下以免忘記</p>
<h3 id="連線認證"><a href="#連線認證" class="headerlink" title="連線認證"></a>連線認證</h3><p>在實際的專案的應用時，在連線時會帶入token來進行認證，失敗時要回傳狀態碼給client，讓它知道是什麼問題，在Flask-SocketIO它本身如果在連線事件，有認證失敗時，<code>return False</code>就可以了，在client會收到<code>401</code>的狀態</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">on_connect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> Auth</span><br><span class="line">        	<span class="keyword">return</span> <span class="literal">False</span> <span class="comment">#認證有問題</span></span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        currentSocketId = request.sid</span><br><span class="line">        remotip = request.remote_addr</span><br><span class="line">        fmt = <span class="string">&quot;[myns ns=%s]&lt;connect&gt; remote_addr=%s socket.id=%s&quot;</span> % (</span><br><span class="line">            sckns, remotip, currentSocketId)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(fmt)</span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<p>如果你的Flask-SocketIO不使用WebSocket的話，這是可以收到，不過因為Flask-SocketIO本身不提供WebSocket的功能而是使用第三方的套件，我是安裝<a href="https://pypi.python.org/pypi/gevent-websocket/">gevent-websocket</a> 此套件，所以在初始化如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">&quot;12345&quot;</span></span><br><span class="line">socketio = SocketIO(</span><br><span class="line">    app, binary=<span class="literal">True</span>, http_compression=<span class="literal">False</span>, async_mode=<span class="string">&#x27;gevent&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>所以在連線時有問題，回傳<code>False</code>,client端是不會教到任何的回應的</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">學習Rxjs的相關使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-05-29 09:58:50" itemprop="dateCreated datePublished" datetime="2019-05-29T09:58:50+00:00">2019-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/" itemprop="url" rel="index"><span itemprop="name">學習</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/Angular/" itemprop="url" rel="index"><span itemprop="name">Angular</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/Angular/RxJS/" itemprop="url" rel="index"><span itemprop="name">RxJS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>學習一下Rxjs的相關使用,目前的範例大多是v5之前，所以記錄和學習v6的相關修改</p>
<p>以下的例子可以看到，當<code>b$</code>和<code>c$</code>有變化時，<code>a$</code>也會跟著變化</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b$ = <span class="title function_">from</span>([<span class="number">1</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="keyword">var</span> c$ = <span class="title function_">from</span>([<span class="number">2</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="keyword">var</span> a$ = <span class="title function_">zip</span>(b$, c$, <span class="function">(<span class="params">b, c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;b=&#x27;</span> + b);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;c=&#x27;</span> + c);</span><br><span class="line">    <span class="keyword">return</span> b + c;</span><br><span class="line">&#125;);</span><br><span class="line">a$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">a</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;a=&#x27;</span> + a);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//b=1 ​​​​​at ​​​&#x27;b=&#x27; + b​​​</span></span><br><span class="line"><span class="comment">//c=2 ​​​​​at ​​​&#x27;c=&#x27; + c​​​ </span></span><br><span class="line"><span class="comment">//a=3 ​​​​​at ​​​&#x27;a=&#x27; + a​​​ </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//b=3 ​​​​​at ​​​&#x27;b=&#x27; + b​​​ </span></span><br><span class="line"><span class="comment">//c=2 ​​​​​at ​​​&#x27;c=&#x27; + c​​​ </span></span><br><span class="line"><span class="comment">//a=5 ​​​​​at ​​​&#x27;a=&#x27; + a​​​ </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="RxJS的使用參考"><a href="#RxJS的使用參考" class="headerlink" title="RxJS的使用參考"></a>RxJS的使用參考</h3><ol>
<li><p>創建Obserable的方法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span>, <span class="title class_">Subject</span>, asapScheduler, pipe, <span class="keyword">of</span>, <span class="keyword">from</span>, interval, merge, fromEvent, <span class="title class_">SubscriptionLike</span>, <span class="title class_">PartialObserver</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>操作符operators</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; map, filter, scan &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>websocket</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; webSocket &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/webSocket&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>ajax</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ajax &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/ajax&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>代表流的變量用＄符號結尾，是RxJS中的一種慣例</strong></p>
<h3 id="RxJS要點"><a href="#RxJS要點" class="headerlink" title="RxJS要點"></a>RxJS要點</h3><p>RxJS有一個核心和三個重點，一個核心是<code>Obserable</code> 再加上相關的<code>Operators</code>,三個重點分別是<code>Observer</code>,<code>Subject</code>,<code>Schedulers</code>。</p>
<h3 id="什麼是-Observable"><a href="#什麼是-Observable" class="headerlink" title="什麼是 Observable"></a>什麼是 Observable</h3><p>在文檔中說的<strong>Observable</strong>更確切的說法是<strong>Observable Stream</strong>，也就是Rx的響應式數據流。</p>
<p>在RxJS中<strong>Observable</strong>是可被觀察者，觀察者則是<strong>Observer</strong>，它們通過Observable的subscribe方法進行關聯</p>
<p>前面提到了RxJS結合了觀察者模式和迭代器模式</p>
<p>對于觀察者模式，我們其實比較熟悉的比如各種DOM事的監聽，也是觀察者模式的一種實踐。核心就是發佈者發佈事件，觀察者選擇時機去訂閱(subscibe)事件。</p>
<p>在ES6中Array,String等可遍歷的數據結構原生部署了迭代器(iterator)接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">const</span> iterator= numbers[<span class="title class_">Symbol</span>.<span class="property">iterator</span>]();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(iterator.<span class="title function_">next</span>());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(iterator.<span class="title function_">next</span>());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(iterator.<span class="title function_">next</span>());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(iterator.<span class="title function_">next</span>());</span><br><span class="line"><span class="comment">//&#123; value: 1, done: false &#125; </span></span><br><span class="line"><span class="comment">//&#123; value: 2, done: false &#125; </span></span><br><span class="line"><span class="comment">//&#123; value: 3, done: false &#125; </span></span><br><span class="line"><span class="comment">//&#123; value: undefined, done: true &#125; </span></span><br></pre></td></tr></table></figure>

<p>觀察者模式和迭代器模式的相同之處是兩者都是漸進式使用數據的，只不過從數據使用者的角度來說，觀察者模式數據是推送<strong>push</strong>過來的，而迭代器模式𣆞自已去拉取<strong>pull</strong>的，Rx中的數據是Observable推送的，觀察者不需要主重去拉取。</p>
<p>Obserable與Array相當類似，都可以看作是Collection只不過Observable是<code>a collection of items over time</code>是隨時間發出的一序列元素，所以下面會看到Obserable的一些操作符與Array的方法極其相似</p>
<h3 id="觀察者模式"><a href="#觀察者模式" class="headerlink" title="觀察者模式"></a>觀察者模式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//觀察者模式</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">addListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> listener === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">push</span>(listener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;listener 必須是 function&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">removeListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">splice</span>(<span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">indexOf</span>(listener), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">notify</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">listener</span>(message);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> egghead = <span class="keyword">new</span> <span class="title class_">Producer</span>();</span><br><span class="line"><span class="comment">// new 出一個 Producer 實例叫 egghead</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">listerner1</span>(<span class="params">message</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(message + <span class="string">&#x27; from listener1&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">listerner2</span>(<span class="params">message</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(message+ <span class="string">&#x27; from listener2&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">egghead.<span class="title function_">addListener</span>(listerner1);<span class="comment">// 註冊監聽</span></span><br><span class="line">egghead.<span class="title function_">addListener</span>(listerner2);</span><br><span class="line"></span><br><span class="line">egghead.<span class="title function_">notify</span>(<span class="string">&#x27;A new course!!&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h3 id="創建Observable"><a href="#創建Observable" class="headerlink" title="創建Observable"></a>創建Observable</h3><p>要創建一個Observable，只要給<strong>new Observable</strong>傳遞一個接收<strong>observer</strong>參數的回調函數，在這個函數中去定義如何發送數據</p>
<h4 id="同步的例子"><a href="#同步的例子" class="headerlink" title="同步的例子"></a>同步的例子</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//創建Observable</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> source$ = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//發射數據</span></span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> observercb = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">item</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(item)</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">source$.<span class="title function_">subscribe</span>(observercb)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>另一種寫法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="comment">//建立流物件</span></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//發射數據</span></span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//訂閱它</span></span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="異步的例子"><a href="#異步的例子" class="headerlink" title="異步的例子"></a>異步的例子</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> source$ = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> number = <span class="number">1</span></span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(number++)</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> source$ = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> number = <span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> message = &#123;</span><br><span class="line">        <span class="attr">count</span>: number,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;message &quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        number++;</span><br><span class="line">        message.<span class="property">count</span> = number;</span><br><span class="line">        observer.<span class="title function_">next</span>(message)</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>Obserable</strong>同時可以處理同步與非同步的行為</p>
<h3 id="觀察者Observer"><a href="#觀察者Observer" class="headerlink" title="觀察者Observer"></a>觀察者Observer</h3><p>Obserable可以被訂閱(subscirbe)或說可以被觀察，而訂閱Obserable的物件又稱為**觀察者(Observer)**。觀察者是一個具有三個方法(method)的物件，每當Obserable發生事件時，更會呼叫觀察者相對應方法。</p>
<blockquote>
<p>意這裡的觀察者(Observer)跟上一篇講的觀察者模式(Observer Pattern)無關，觀察者模式是一種設計模式，是思考問題的解決過程，而這裡講的觀察者是○被定義的物件。</p>
</blockquote>
<p>觀察者的三個方法(method):</p>
<ul>
<li><p>next:每當Obserable發送出新的值，next方法就會被呼叫。</p>
</li>
<li><p>complete:在Obserable沒有其他的資料可以取得時，complete方法就會被呼叫，在complete被呼叫之後，next方法就不會再起作用。</p>
</li>
<li><p>error:每𡮝Obserable內發生錯誤時，error方法就會被呼叫。</p>
</li>
</ul>
<p>說了這麼多，我們還是直接來建立一個觀察者吧！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> observable$= <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function">(<span class="params">observer</span>)=&gt;</span>&#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//宣告一個觀察者，具備next , error, complete 三個方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observer =&#123;</span><br><span class="line">    <span class="attr">next</span>:<span class="keyword">function</span>(<span class="params">value</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>:<span class="keyword">function</span>(<span class="params">error</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用我們定義好的觀察者，來訂閱這個observale</span></span><br><span class="line">observable$.<span class="title function_">subscribe</span>(observer);</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼會印出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Jerry ​​​​​at ​​​value​​​ ​day05rxjs.js:13:8​</span><br><span class="line">Anna ​​​​​at ​​​value​​​ ​day05rxjs.js:13:8​</span><br><span class="line">complete ​​​​​at ​day05rxjs.js:19:8​</span><br></pre></td></tr></table></figure>

<p>上面的範例可以看得出來在complete執行後，next就會自動失效，所以沒有印出<code>not work</code> 。</p>
<p>下面則是送出錯誤的範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> observable$ = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function">(<span class="params">observer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line">        observer.<span class="title function_">next</span>(<span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&#x27;some exception&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        observer.<span class="title function_">error</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 宣告一個觀察者，具備 next,error,complete 三個方法</span></span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span>, error);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 用我們定義好的觀察者，來訂閱這個observable</span></span><br><span class="line">observable$.<span class="title function_">subscribe</span>(observer);</span><br></pre></td></tr></table></figure>

<p>會印出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Jerry </span><br><span class="line">Anna </span><br><span class="line">Error:  some exception </span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>這裡就會執行error的function印印出<code>Error:  some exception</code></p>
<blockquote>
<p>有時候Observable會是一個無限的序列，例如click事件，這時<code>complete</code>方法就有可能永遠不會被呼叫！</p>
</blockquote>
<p>我們也可以直接把next,error,complete三個function依序傳入<code>obserable.subscrive</code>如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">observable$.<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">value</span> =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span>, error); &#125;,</span><br><span class="line">    <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="實作細節"><a href="#實作細節" class="headerlink" title="實作細節"></a>實作細節</h3><p>我們之前提到了，其實Observable的訂閱跟addEventListener在實作上有蠻大的差異，雖然他們的行為很像！</p>
<p>addEventListener本質上就是Observer Pattern的實作，在內部會有一份訂閱清單，像是我們實作的Producer</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">addListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> listener === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">push</span>(listener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;listener 必須是 function&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">removeListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">splice</span>(<span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">indexOf</span>(listener), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">notify</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">listener</span>(message);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們在內部儲存了一份所有的監聽者清單’this.listeners’，在要發佈通知時會對逐一的呼叫這份清單的監聽者。</p>
<p>但在Observable不是這樣實作的，在其內部沒有一份訂閱者的清單。訂閱Observable的行無比較像是執行一個物件的方法，並把資料傳進這個方法。</p>
<p>我們以下面的程式碼做說明</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable$ = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function">(<span class="params">observer</span>) =&gt;</span> &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">observable$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>像上面這段程式，他的行為比較像這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">subscribe</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡可以看到subscribe是一個function，這個function執行時會傳入觀察者，而我們在這個function內部去執行觀察者的方法。</p>
<p><strong>訂閱一個Observable就像是執行一個function</strong></p>
<h3 id="建立-Observable-二"><a href="#建立-Observable-二" class="headerlink" title="建立 Observable(二)"></a>建立 Observable(二)</h3><p>Obaerable有許多創建實例的方法，稱為creation operator，下面會有RxJS常用的creation operator</p>
<h4 id="of"><a href="#of" class="headerlink" title="of"></a>of</h4><p>當我們想要<strong>同步的</strong>傳遞幾個值時，就可以用<code>of</code>這個opertor來簡潔的表達</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">of</span>(<span class="string">&#x27;Jery&#x27;</span>, <span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="from"><a href="#from" class="headerlink" title="from"></a>from</h4><p>其實<code>of</code>operator的一個一個參數其實就是一個list，而list在JavaScript中最常見的形式是陣列(array) ,那我們可以用<code>from</code>來按收任何可列舉的參數</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Jerry&#x27;</span>, <span class="string">&#x27;Anna&#x27;</span>, <span class="number">2016</span>, <span class="number">2017</span>, <span class="string">&#x27;30 days&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(arr);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//結果</span></span><br><span class="line"><span class="comment">//Jerry </span></span><br><span class="line"><span class="comment">//Anna </span></span><br><span class="line"><span class="comment">//2016 </span></span><br><span class="line"><span class="comment">//2017 </span></span><br><span class="line"><span class="comment">//30 days </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>記得任何可列舉的參數可以用，也就是說像Set,WeakSet,Iterator等都可以當作參數</p>
<blockquote>
<p>因為ES6出現後可列舉(iterable)的型別變多了，所以<code>fromArray</code>就被移除了。</p>
</blockquote>
<p>另外<code>from</code>還能接收字串(string)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(<span class="string">&#x27;鐵人賽&#x27;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//結果</span></span><br><span class="line"><span class="comment">//鐵 </span></span><br><span class="line"><span class="comment">//人 </span></span><br><span class="line"><span class="comment">//賽 </span></span><br><span class="line"><span class="comment">//complete </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也可以傳入Promise物件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&#x27;Hello RxJs&#x27;</span>);</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//結果</span></span><br><span class="line"><span class="comment">// Hello RxJs </span></span><br><span class="line"><span class="comment">// complete </span></span><br></pre></td></tr></table></figure>

<h4 id="fromEvent"><a href="#fromEvent" class="headerlink" title="fromEvent"></a>fromEvent</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source = <span class="title class_">Rx</span>.<span class="property">Observable</span>.<span class="title function_">fromEvent</span>(<span class="variable language_">document</span>.<span class="property">body</span>, <span class="string">&#x27;click&#x27;</span>);</span><br><span class="line"></span><br><span class="line">source.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="fromEventPattern"><a href="#fromEventPattern" class="headerlink" title="fromEventPattern"></a>fromEventPattern</h5><p>要用 Event 來建立 Observable 實例還有另一個方法 <code>fromEventPattern</code>，這個方法是給類事件使用。所謂的類事件就是指其行為跟事件相像，同時具有註冊監聽及移除監聽兩種行為，就像 DOM Event 有 <code>addEventListener</code> 及 <code>removeEventListener</code> 一樣！舉一個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEventPattern &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">addListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> listener === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">push</span>(listener)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;listener 必須是 function&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">removeListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">splice</span>(<span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">indexOf</span>(listener), <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">notify</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">listener</span>(message);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ------- 以上都是之前的程式碼 -------- //</span></span><br><span class="line"><span class="keyword">var</span> egghead = <span class="keyword">new</span> <span class="title class_">Producer</span>();</span><br><span class="line"><span class="comment">// egghead 同時具有 註冊監聽者及移除監聽者 兩種方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEventPattern</span>(</span><br><span class="line">    <span class="function">(<span class="params">handler</span>) =&gt;</span> egghead.<span class="title function_">addListener</span>(handler),</span><br><span class="line">    <span class="function">(<span class="params">handler</span>) =&gt;</span> egghead.<span class="title function_">removeListener</span>(handler)</span><br><span class="line"></span><br><span class="line">);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">egghead.<span class="title function_">notify</span>(<span class="string">&#x27;Hello! Can you hear me?&#x27;</span>);</span><br><span class="line"><span class="comment">//結果 Hello! Can you hear me? </span></span><br></pre></td></tr></table></figure>

<p>上面的程式碼可以看到，<code>egghead</code> 是 <code>Producer</code> 的實例，同時具有 註冊監聽及移除監聽兩種方法，我們可以將這兩個方法依序傳入 <code>fromEventPattern</code> 來建立 Observable 的物件實例！</p>
<blockquote>
<p>這裡要注意不要直接將方法傳入，避免 this 出錯！也可以用 <code>bind</code> 來寫。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Rx.Observable</span><br><span class="line">    .fromEventPattern(</span><br><span class="line">        egghead.addListener.bind(egghead), </span><br><span class="line">        egghead.removeListener.bind(egghead)</span><br><span class="line">    )</span><br><span class="line">    .subscribe(console.log)</span><br></pre></td></tr></table></figure>

<h4 id="empty-never-throw"><a href="#empty-never-throw" class="headerlink" title="empty,never,throw"></a>empty,never,throw</h4><p>有點像是數學上的**零(0)**，雖然有時候好像沒什麼，但卻非常的重要。在Observable的世界裡也有類似的東西，像是<code>empty</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">empty</span>();</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>:<span class="keyword">function</span>(<span class="params">value</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p><code>empty</code> 會給我們一個<strong>空</strong>的 observable，如果我們訂閱這個 observable 會發生什麼事呢？ 它會立即送出 complete 的訊息！</p>
<blockquote>
<p>可以直接把 <code>empty</code> 想成沒有做任何事，但它至少會告訴你它沒做任何事。</p>
</blockquote>
<p>數學上還有一個跟零(0)很像的數，那就是<strong>無窮(∞)</strong>, 在Observable的世界裡我們用 <code>never</code> 來建立無窮的 observable</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; never &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">never</span>();</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>never 會給我們一個無窮的 observable，如果我們訂閱它又會發生什麼事呢？…什麼事都不會發生，它就是一個一直存在但卻什麼都不做的 observable。</p>
<blockquote>
<p>可以把 never 想像成一個結束在無窮久以後的 observable，但你永遠等不到那一天！</p>
</blockquote>
<blockquote>
<p>題外話，筆者一直很喜歡平行線的解釋： 兩條平行線就是它們相交於無窮遠</p>
</blockquote>
<p>最後還有一個 operator <code>throw</code>，它也就只做一件事就是拋出錯誤。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; throwError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">throwError</span>(<span class="string">&#x27;Oop!&#x27;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Throw Error: Oop!</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼就只會 log 出 <code>&#39;Throw Error: Oop!&#39;</code>。</p>
<h4 id="interval-timer"><a href="#interval-timer" class="headerlink" title="interval,timer"></a>interval,timer</h4><p>接著我們要看兩個跟時間有關的operators、在JS中我們可以用<code>setInterval</code>來建立一個持續的行為，這也能用在Observable中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(i++);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，會每隔一秒送出一個從零開始遞增的整數，在Observable的世界也有一個operator可以更方便地做到這件事，就是<code>interval</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p><code>interval</code>有一個參數是數值(Number), 這數值代表發出訊號的間隔時間(ms), 這兩段程式碼基本上是等價的會持續每隔一秒送出一個從零開始遞增的數值</p>
<p>另外有一很相似的operator叫<code>timer</code>,<code>timer</code>可以給兩個參數，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; timer &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">timer</span>(<span class="number">1000</span>, <span class="number">5000</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>當<code>timer</code>有兩個參數時，第一個參數代表要發出第一個值的等待時間(ms),第二個參數代表第一次之後發送值的間隔時間，所以上面這段程式碼會先等一秒送出0之後每5秒送出1，2，3，4…</p>
<p><code>timer</code>第一個參睥除了可以是數值(Number)之外，也可以是日期(Date), 就會等到指定的時間在發送䇪一個值。</p>
<p>另外<code>timer</code>也可以只接收一個參數</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; timer &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">timer</span>(<span class="number">1000</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼就會等一秒後送出1同時通知結束。</p>
<h4 id="Subscription"><a href="#Subscription" class="headerlink" title="Subscription"></a>Subscription</h4><p>有提到很多無窮的Observable，例如interval,never。但有時候我們可能會在某些行為後不需要這些資源，要做到這件事最簡單的方法就是<code>unsubscribe</code>。</p>
<p>其實在訂閱Observable後，會回傳一個subscription物件，這個物件具有釋放資源的<code>unsubscribe</code>方法。範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; timer &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">timer</span>(<span class="number">1000</span>, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//取得subscription</span></span><br><span class="line"><span class="keyword">var</span> subscription = source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscription.<span class="title function_">unsubscribe</span>();<span class="comment">//停止訂閱(退訂)</span></span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2 </span></span><br><span class="line"><span class="comment">//3 </span></span><br></pre></td></tr></table></figure>

<p>這裡我們用了<code>setTimeout</code>在5秒後，執行了<code>subscription.unsubscribe()</code>來停止訂閱並釋放資源。另外subscription物件還有其他合併訂閱等作用。</p>
<blockquote>
<p>Events observable盡畫不要用<code>unsubscribe</code>,通常我們會使用<code>takeUntil</code>,在某個載件發生後來完成Eventobservable</p>
</blockquote>
<h3 id="Observable-Operators-Marble-Diagrams"><a href="#Observable-Operators-Marble-Diagrams" class="headerlink" title="Observable Operators &amp; Marble Diagrams"></a>Observable Operators &amp; Marble Diagrams</h3><blockquote>
<p>Observable的Operators是實數應用上最重要的部份，我們需要了解各種Operators的使用方式，才能輕鬆實作各種需求！</p>
</blockquote>
<p>關於轉換(Transformation)、過濾(Filter)、合併(Combination)等操作方法，先來知道什麼是Operator</p>
<h4 id="什麼是Operator"><a href="#什麼是Operator" class="headerlink" title="什麼是Operator?"></a>什麼是Operator?</h4><p>Operators就是一個個被附加到Observable型別的函式，例如像是mag,filter,contactall…等等，所有這些函式都拿到原來的Observable並回傳一個新的observable，有像下面的樣子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span>, <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> people = <span class="title function_">of</span>(<span class="string">&quot;Jerry&quot;</span>, <span class="string">&quot;Anna&quot;</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">map</span>(<span class="params">source$, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function">(<span class="params">observer</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> source$.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                observer.<span class="title function_">next</span>(<span class="title function_">callback</span>(value));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                observer.<span class="title function_">error</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">            <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; observer.<span class="title function_">error</span>(e); &#125;,</span><br><span class="line">            <span class="function">() =&gt;</span> &#123; observer.<span class="title function_">complete</span>(); &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> helloPeople = <span class="title function_">map</span>(people, <span class="function">(<span class="params">item</span>) =&gt;</span> item + <span class="string">&quot; Hello~&quot;</span>);</span><br><span class="line">helloPeople.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br><span class="line"><span class="comment">//Jerry Hello~ ​​​​​</span></span><br><span class="line"><span class="comment">// Anna Hello~ ​​​​​</span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到我們寫了一個map的函式，它接收兩個參數，第一個是原本的observable, 䇪二個是map的callback function。map內部第一件事就是用<code>create</code>建立一個新的observable並回傳，並且在內部訂閱原本的observable。</p>
<p>這裡有兩個重點是我們一定要知道的，每個operator都會回傳一個新的ooservable,而我們可以透過<code>create</code>的方法建立各種operator</p>
<p>我們需要先訂定一個簡單的方式來表達observable</p>
<h4 id="Marble-diagrams"><a href="#Marble-diagrams" class="headerlink" title="Marble diagrams"></a>Marble diagrams</h4><p>我們在傳達事物時，文字其實是最糟的手段，雖然文字是我們平時溝通的基礎，但常常千言萬語也比不過一張清楚的圖。如果我們能訂定observable的圖示，就能讓我自更方便的溝通及理解observable的各種operators!</p>
<p>我們把描繪 observable 的圖示稱為 Marble diagrams，在網路上 RxJS 有非常多的 Marble diagrams，規則大致上都是相同的，這裡為了方便撰寫以及跟讀者的留言互動，所以採用類似 ASCII 的繪畫方式。</p>
<p>我們用<code>-</code>來表達一小段時𫂾，這些<code>-</code>串起來就代表一個observable</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-----------</span><br></pre></td></tr></table></figure>

<p><code>X</code>(大寫X)則代表有錯誤發生</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-----------X</span><br></pre></td></tr></table></figure>

<p><code>|</code>則代表observable結束</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-----------|</span><br></pre></td></tr></table></figure>

<p>在這個時間序當中，我們可能會發出值(value), 如果值是數字則直接用阿拉伯數字取代，其他的資料型別則用相近的英文符號代表，𫍇裡我們用<code>interval</code>舉例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source$=<span class="title function_">interval</span>(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p><code>source$</code>的圖型就會長像這樣</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">----0-----1-----2-----3--...</span><br></pre></td></tr></table></figure>

<p> 當observable是同步送值的時候，例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source$=<span class="title function_">of</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p><code>source$</code>的圖形就會長像這樣</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1234)|</span><br></pre></td></tr></table></figure>

<p>小括號代表著同步發生</p>
<p>另外的Marble diagrams也能夠表達operator的前後轉換，例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source=<span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> newest =source.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>這時候Marble diagrams就會長像這樣</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>: -----0-----1-----2-----3--...</span><br><span class="line">            map(x =&gt; x + 1)</span><br><span class="line">newest: -----1-----2-----3-----4--...</span><br></pre></td></tr></table></figure>

<p>最上面原本的observable, 中間是operator，下面則是新的observable</p>
<p>Marble Diagrams 相關資源：<a href="http://rxmarbles.com/">http://rxmarbles.com/</a></p>
<h4 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h4><h5 id="map"><a href="#map" class="headerlink" title="map"></a>map</h5><p>Observable的map方法使用上跟陣列的map是一樣的，我們傳入一個callback function，這個callback function會帶入每次發送出來的元素，然後我們回傳新的元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> newest$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line">newest$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">//2 ​​​​​</span></span><br><span class="line"><span class="comment">//3 ​​​​​</span></span><br><span class="line"><span class="comment">//4 ​​​​​</span></span><br><span class="line"><span class="comment">//5 ... ​​​​​</span></span><br></pre></td></tr></table></figure>

<p>用Marble diagrams表達就是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>: -----0-----1-----2-----3--...</span><br><span class="line">			map(x =&gt; x + 2)</span><br><span class="line">newest: -----2-----3-----4-----5--...			</span><br></pre></td></tr></table></figure>

<p>有另外一個方法跟map很像叫mapTo</p>
<h5 id="mapTo"><a href="#mapTo" class="headerlink" title="mapTo"></a>mapTo</h5><p>mapTo可把傳進來的值改成一固定的值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mapTo &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> newest$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">mapTo</span>(<span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line">newest$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">//2 ​​​​​</span></span><br><span class="line"><span class="comment">//2 ​​​​​</span></span><br><span class="line"><span class="comment">//2 ....</span></span><br></pre></td></tr></table></figure>

<p>mapTo用Marble diagrams表達</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>: -----0-----1-----2-----3--...</span><br><span class="line">			mapTo(2)</span><br><span class="line">newest: -----2-----2-----2-----2--...			</span><br></pre></td></tr></table></figure>

<h5 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h5><p>filter在使用上也跟陣列的相同，我們要傳入一個callback function，這個function會傳入每個被送出的元素，並且回傳一個boolean值，如果為true的話就會保留，如果為false就會被濾掉</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mapTo, filter &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> newest$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">filter</span>(<span class="function"><span class="params">x</span> =&gt;</span> x % <span class="number">2</span> === <span class="number">0</span>)</span><br><span class="line">);</span><br><span class="line">newest$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">//0 ​​​​​</span></span><br><span class="line"><span class="comment">//2 ​​​​​</span></span><br><span class="line"><span class="comment">//4 ​​​​​</span></span><br><span class="line"><span class="comment">//6 ...</span></span><br></pre></td></tr></table></figure>

<p>filter用Marble diagrams表達</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source: -----0-----1-----2-----3-----4--...</span><br><span class="line">			filter(x =&gt; x%2 === 0)</span><br><span class="line">newest: -----0-----------2-----------4---...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>map ,filter這些方法其實都跟陣列的相同，因為這些都是fucntional programming的通用函式。</p>
</blockquote>
<blockquote>
<p>實際上Observable跟Array的operators(map,filter)，在行為上還是有極大的差異，當我們的資料量很大時，Observable的效能會好上非常多。</p>
</blockquote>
<h5 id="take"><a href="#take" class="headerlink" title="take"></a>take</h5><p>take 是一個很簡單的operator, 顧名思義就是取前幾個元素後就結束</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mapTo, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2 </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到我們的<code>source$</code>原本是會發出無限元素的，但這裡我們用<code>take(3)</code>就會只取前3個元素，取完後就直接結束(complete), 用Marble diagram表如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$:-----0-----1-----2-----3--..</span><br><span class="line">		take(3)</span><br><span class="line">example:-----0-----1-----2|</span><br></pre></td></tr></table></figure>

<h5 id="first"><a href="#first" class="headerlink" title="first"></a>first</h5><p>first會取observable送出的第一個元素之後就直接結束，行為跟takb(1)一樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; first, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">first</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>用Marble diagram表示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source$ :-----0-----1-----2-----3--..</span><br><span class="line">example$:-----0|</span><br></pre></td></tr></table></figure>

<h5 id="takeUntil"><a href="#takeUntil" class="headerlink" title="takeUntil"></a>takeUntil</h5><p>在實數上takeUntil很常使用到，他可以在某件事情發生時，讓一個observable直送出完成(complete)訊息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, fromEvent &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; first, takeUntil &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> click = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>.<span class="property">body</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(click));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a href="https://stackblitz.com/edit/rxjs-arycee?devtoolsheight=60">stackblitz</a></p>
<p>這裏我們一開始先用<code>interval</code>建立一個observable，這個observable每隔1秒會送出一個從0開𤖥遞增的數值，接著我們用<code>takeUntil</code>,傳人另一個observable.</p>
<p>當<code>tabkeUntil</code>傳入的observable發送值時，原本的observable就會直托進人完成(complete)狀態，並且發送完成訊息。也就是說上面這沒程式碼的行為，會先每一秒印出一個數字(從0遞增)直到我們點擊body為止，他才會送出complete訊息。如果畫成Maribe diagram則會像下面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source$ :-----0-----1-----2-----3--..</span><br><span class="line">click   :---------------------c------</span><br><span class="line">			takeUntil(click)</span><br><span class="line">example$:-----0-----1-----2---|			</span><br></pre></td></tr></table></figure>

<p>當click一發送元素的時候，observable就會直接完縑(complete)</p>
<h5 id="concatAll"><a href="#concatAll" class="headerlink" title="concatAll"></a>concatAll</h5><p>有時我們的Observable送出的元素又是一個observable就像是二維陣列，陣列裡面的元素是陣列，這時我們就可以用<code>concatAll</code> 它攤平成一維陣列，也可以直接把<code>concatAll</code>想成把所有元素concat起來。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span>, fromEvent &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,concatAll &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> click = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>.<span class="property">body</span>, <span class="string">&#x27;click&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">of</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concatAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a href="https://stackblitz.com/edit/rxjs-en1m7j?file=index.ts">stackblitz</a></p>
<p>這個範例我們每點一次body就會立刻送出1,2,3，如果用Marble diagram表示則如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">click  : ------c----------c-----------</span><br><span class="line">		  map(e =&gt; of(1, 2, 3))</span><br><span class="line"><span class="built_in">source</span> : ------o----------o-----------</span><br><span class="line">                \          \</span><br><span class="line">                 (123)|     (123)|</span><br><span class="line">example:-------(123)------(123)-------</span><br></pre></td></tr></table></figure>

<p>這裡可以看到<code>source</code>observable內部每次發送的值也是observable，這時我們用concatAll就可以把source攤平成example</p>
<p>這裡需要注意的是<code>concatAll</code>會處理source先發出來的observable，必須等到這個observable結事，才會再處理下一固source發出來的observable，以下面這個範例說明。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, concatAll &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> obs1$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">var</span> obs2$ = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">2</span>));</span><br><span class="line"><span class="keyword">var</span> obs3$ = <span class="title function_">interval</span>(<span class="number">2000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">of</span>(obs1$, obs2$, obs3$);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concatAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到<code>source</code>會送出3個observable，但是<code>concatAll</code>後的行為永遠都是先處理第一個observable,<strong>等到當前處理的結事後才會再處理下一個</strong></p>
<p>用Marble diagram表示如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">source : (o1)               o2     o3)|</span><br><span class="line">           \                 \      \</span><br><span class="line">            --0--1--2--3--4|  -0-1|  ----0|</span><br><span class="line">                 concatAll()</span><br><span class="line">example: --0--1--2--3--4-0-1----0</span><br></pre></td></tr></table></figure>

<h5 id="簡易拖拉"><a href="#簡易拖拉" class="headerlink" title="簡易拖拉"></a>簡易拖拉</h5><p>當看完前面幾個operator後，我們就很輕鬆地做出拖拉的功能，先讓我們來看一下需求</p>
<ol>
<li><p>首先畫面上有一僤元件(#drag)</p>
</li>
<li><p>當滑鼠在元件(#drag)上按下左鍵(mousedwon)時，開始監聽滑鼠移動(mousemove)的位置</p>
</li>
<li><p>當滑鼠左鍵放掉(mouseup)時，結束監聽滑鼠移動</p>
</li>
<li><p>當滑鼠移動(mousemove)被監聽時，跟著修改元件的樣式屬性</p>
</li>
</ol>
<p>第一步如下<br><a href="https://stackblitz.com/edit/rxjs-agprjt">stackblitz</a></p>
<p>第二步我們要先取得各個 DOM 物件，元件(#drag) 跟 body。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dragDOM = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;drag&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> body = <span class="variable language_">document</span>.<span class="property">body</span>;</span><br></pre></td></tr></table></figure>

<p>要取得body的原因是因為滑鼠移動(moudemove)跟滑鼠左鍵放掉(mouseup)都應該是在整個body監聽</p>
<p>第三步我們寫出各個會用的監聽事件，並用<code>fromEvent</code>來取得各個observable. </p>
<ul>
<li><p>對#drag監聽moudedown</p>
</li>
<li><p>對body監聽mouseup</p>
</li>
<li><p>對body監聽mousemove</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mouseDown = <span class="title function_">fromEvent</span>(dragDOM, <span class="string">&#x27;mousedown&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mouseUp = <span class="title function_">fromEvent</span>(body, <span class="string">&#x27;mouseup&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mouseMove = <span class="title function_">fromEvent</span>(body, <span class="string">&#x27;mousemove&#x27;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>還沒<code>subscribe</code>之前都不會開始監聽，一定會𨬓到subscribe之後obserable才會開始送值</p>
</blockquote>
<p>當mouseDown時，轉成mouseMove的事件</p>
<p>mouseMove要在mouseUp後結束加上<code>takeUntil(mouseup)</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> source = mouseDown.<span class="title function_">pipe</span>(</span><br><span class="line"> <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> mouseMove.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp)))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>這時source大概長像這樣</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>: -------e--------------------e--------</span><br><span class="line">                \                    \</span><br><span class="line">                  --m-m-m-m/           -m--m-m--m-m/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>m 代表mousemove event</p>
</blockquote>
<p>用<code>concatAll()</code>攤平source成一維</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> source = mouseDown.<span class="title function_">pipe</span>(</span><br><span class="line"> <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> mouseMove.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp))),</span><br><span class="line"> <span class="title function_">concatAll</span>()   </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>用map把mousemove event轉成x,y的位置，並且訂閱</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> source = mouseDown.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> mouseMove.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp))),</span><br><span class="line">  <span class="title function_">concatAll</span>(),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> (&#123; <span class="attr">x</span>: event.<span class="property">clientX</span>, <span class="attr">y</span>: event.<span class="property">clientY</span> &#125;))</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="function"><span class="params">pos</span> =&gt;</span> &#123;</span><br><span class="line">  dragDOM.<span class="property">style</span>.<span class="property">left</span> = pos.<span class="property">x</span> + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">  dragDOM.<span class="property">style</span>.<span class="property">top</span> = pos.<span class="property">y</span> + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>雖然這只是一個簡單的拖拉實現，但已經展示出 RxJS 帶來的威力，它讓我們的程式碼更加的簡潔，也更好的維護！</p>
<h5 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h5><p><code>take</code>可以取前幾個送出的元素，而可以略出前幾個送出的元素<code>skip</code>, 範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; skip &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">skip</span>(<span class="number">3</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//3 ​​​​​at ​​​value​​​ ​day09rxjs.js:9​</span></span><br><span class="line"><span class="comment">//4 ​​​​​at ​​​value​​​ ​day09rxjs.js:9​</span></span><br><span class="line"><span class="comment">//5 ...</span></span><br></pre></td></tr></table></figure>

<p>原本從0開𤖥的就會變成從3開𤖥，但是記得原本元素的等得時𫂾仍然存在，也就是說此範例第一個取得的元素需要等4秒，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----0----1----2----3----4----5--...</span><br><span class="line">                skip(3)</span><br><span class="line">example$: -------------------3----4----5--...               </span><br></pre></td></tr></table></figure>

<h5 id="takeLast"><a href="#takeLast" class="headerlink" title="takeLast"></a>takeLast</h5><p>除了可以用<code>take</code>取前幾個之外，我們也可以倒過來取最後幾個，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, takeLast &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">takeLast</span>(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//4 </span></span><br><span class="line"><span class="comment">//5 </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>



<p>這裡我們先取了前6個元素，再取最後兩個，所以最後會送出4,5,complete，有一個重點。就是<code>takeLast</code>必須等到整個observable完成(complete), 才能知道最後的元素有哪些，並且<strong>同步送出</strong>,如果有Marbe Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$  : ----0----1----2----3----4----5|</span><br><span class="line">                    takeLast(2)</span><br><span class="line">example$ : ------------------------------(45)|                    </span><br></pre></td></tr></table></figure>

<p>可以看到takeLast後，必需等到原本的observable完成後，才立即同步送出4,5,complete</p>
<h5 id="last"><a href="#last" class="headerlink" title="last"></a>last</h5><p>跟<code>take(1)</code>相同，我們有一個<code>takeLast(1)</code>的簡化寫法，那就是<code>last()</code>用來取得最後一個元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; last, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"><span class="keyword">let</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">last</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$  : ----0----1----2----3----5|</span><br><span class="line">                   last()</span><br><span class="line">example$ : --------------------------(5)|                   </span><br></pre></td></tr></table></figure>

<h5 id="concat"><a href="#concat" class="headerlink" title="concat"></a>concat</h5><p><code>concat</code>可以把多個observable實例合併成一個</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concat, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">let</span> source2$ = <span class="title function_">of</span>(<span class="number">3</span>);</span><br><span class="line"><span class="keyword">let</span> source3$ = <span class="title function_">of</span>(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concat</span>(source2$, source3$));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>跟<code>concatAll</code>一樣，必須先等前一個observable完成(complete), 才會繼續下一個，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ :----0----1----2|</span><br><span class="line">source2$:(3)|</span><br><span class="line">source3$:(456)|</span><br><span class="line">            concat()</span><br><span class="line">example$:----0-----1----2(3456)|            </span><br></pre></td></tr></table></figure>

<h5 id="startWith"><a href="#startWith" class="headerlink" title="startWith"></a>startWith</h5><p><code>startWith</code>可以在observable的一開始塞要發送的元素，有點像<code>concat</code>但參數不是observable而是要發送的元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; startWith &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">let</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">startWith</span>(<span class="number">0</span>));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3...</span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到我們在source$一開始塞了一個<code>0</code>, 讓example$會在一開始就立即送出<code>0</code>，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ :----0----1----2----3--...</span><br><span class="line">             startWith(0)</span><br><span class="line">example :(0)----0----1----2----3-...             </span><br></pre></td></tr></table></figure>

<p>記得 startWith 的值是一開始就同步發出的，這個 operator 很常被用來保存程式的起始狀態！</p>
<h5 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h5><p><code>merge</code>跟<code>concat</code>一樣都是用來合併observable，但他們在行為上有非常大的不同</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, merge &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> source$ = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">let</span> source2$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"><span class="keyword">let</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">merge</span>(source2$));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p><code>merge</code>把多個observable同時處理，這跟<code>concat</code>一次處理一個observable是完全不一樣的，由於是同時處理行為會變得較為複雜，用Marble Diagram會較好解釋</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source$ : ----0----1----2|</span><br><span class="line">source2$: --0--1--2--3--4--5|</span><br><span class="line">                merge()</span><br><span class="line">example$: --0-01--21-3--(24)--5|                </span><br></pre></td></tr></table></figure>

<p>這裡可以看到<code>mergr</code>之後的example在時間序上同時在跑source$與source2$,當兩件事情同時發生時，會同步送出資料(被merge的在後面),當兩個observable都結事時才會真的結束。</p>
<p>merge的邏輯有點像是OR(||)就是當兩個observable其中一個被觸發時都可以被處理，這很常用一個以上的按鈕具有部分相同的行為。</p>
<p>例如一個影片播放器有兩個按鈕，一個是暫停(||) 另一個是結束播放(□)。這兩個按鈕都具有相同的行為就是影片會被停止，只是結束播放會讓影片回到00秒，這時我們就可以把這兩個按鈕的事件merge起來處理影片暫停這件事。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var stopVideo= stopButton.pipe(merge(endbutton));</span><br><span class="line">stopVideo.subscribe(()=&gt;&#123;</span><br><span class="line">    //暫停播放影片</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="combineLatest"><a href="#combineLatest" class="headerlink" title="combineLatest"></a>combineLatest</h5><p>它會取得各個observable最後送出的值，再輸出成一個值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, combineLatest &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> newest$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">combineLatest</span>(newest$, <span class="function">(<span class="params">x, y</span>) =&gt;</span> x + y));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="comment">// 7</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>看Marble diagram</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----0----1----2|</span><br><span class="line">newest$ : --0--1--2--3--4--5|</span><br><span class="line">    combineLatest(newest$,(x,y)=&gt;x+y);</span><br><span class="line">example$: ----01--23-4--(56)--7|    </span><br></pre></td></tr></table></figure>

<p>首先<code>combineLatest</code>可以接收多個observable,最後一個參數是callback function,這個callback function接收的參睥數量跟合併的observable數量相同，依照範例來說，因為我們這裡合併了兩個observable所以後面的callback function就接教收x,y兩個參數，x會接收從source$發送出來的值，y會接收newest$發送出來的值。</p>
<p>最後一個重點就是一定會等兩個observable都<strong>曾有送值</strong>出來才會呼叫我們傳入的callback，所以這段程式是這樣運行的</p>
<ul>
<li>newest$送出了<code>0</code>, 但此時source$並沒有送出過任何值，所以不會執行callback</li>
<li>source$送出了<code>0</code>,但此時newest$最後一次送出的值為<code>0</code>,把這兩個數傳入callback得到<code>0</code></li>
<li>newest$送出了<code>1</code>此時source$最後一次送出的值為<code>0</code>, 把這兩個數傳入callback得到<code>1</code></li>
<li>newest$送出了 <code>2</code>，此時 source$ 最後一次送出的值為 <code>0</code>，把這兩個數傳入 callback 得到 <code>2</code>。</li>
<li>source$ 送出了 <code>1</code>，此時 newest$ 最後一次送出的值為 <code>2</code>，把這兩個數傳入 callback 得到 <code>3</code>。</li>
<li>newest$ 送出了 <code>3</code>，此時 source$ 最後一次送出的值為 <code>1</code>，把這兩個數傳入 callback 得到 <code>4</code>。</li>
<li>source$ 送出了 <code>2</code>，此時 newest$ 最後一次送出的值為 <code>3</code>，把這兩個數傳入 callback 得到 <code>5</code>。</li>
<li>source$ 結束，但 newest$ 還沒結束，所以 example 還不會結束。</li>
<li>newest$ 送出了 <code>4</code>，此時 source$ 最後一次送出的值為 <code>2</code>，把這兩個數傳入 callback 得到 <code>6</code>。</li>
<li>newest$ 送出了 <code>5</code>，此時 source$ 最後一次送出的值為 <code>2</code>，把這兩個數傳入 callback 得到 <code>7</code>。</li>
<li>newest$ 結束，因為 source$ 也結束了，所以 example$ 結束。</li>
</ul>
<p>不管是source$還是newest$送出值來，只要另一方曾有送出過值(有最後的值)，就會執行callback並送出新的值，𫍇就是combineLastest</p>
<p>combineLastest很常用在運算多個因子的結果，例如最常見的BMI計算，我們身高變動時就拿上一次的體重計算新的BMI，當體重變動時則拿上次的身高計算BMI，這就很適合用combineLastest來處理</p>
<h5 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h5><p>zip會取每個observable相同順位的元素並傳入callback, 也就是說每個observable的第n個元素會一起被傳入callback</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take,zip&#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> newest$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">zip</span>(newest$, <span class="function">(<span class="params">x, y</span>) =&gt;</span> x + y));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----0----1----2|</span><br><span class="line">newest$ : --0--1--2--3--4--5|</span><br><span class="line">          zip(newest$,(x,y)=&gt;x+y)</span><br><span class="line">example$: ----0----2----4|          </span><br></pre></td></tr></table></figure>

<p>zip會等到source$跟newest$<strong>都送出了第一個元素</strong>，再傳入callback，下次則等到soure$跟newest$<strong>都送出了䇪二個元素</strong>再一起傳入callback，所以運行的步驟如下</p>
<ul>
<li>newest$ 送出了<strong>第一個</strong>值 <code>0</code>，但此時 source$ 並沒有送出<strong>第一個</strong>值，所以不會執行 callback。</li>
<li>source$ 送出了<strong>第一個</strong>值 <code>0</code>，newest$ 之前送出的<strong>第一個</strong>值為 <code>0</code>，把這兩個數傳入 callback 得到 <code>0</code>。</li>
<li>newest$ 送出了<strong>第二個</strong>值 <code>1</code>，但此時 source$ 並沒有送出<strong>第二個</strong>值，所以不會執行 callback。</li>
<li>newest$ 送出了<strong>第三個</strong>值 <code>2</code>，但此時 source$ 並沒有送出<strong>第三個</strong>值，所以不會執行 callback。</li>
<li>source$ 送出了<strong>第二個</strong>值 <code>1</code>，newest$ 之前送出的<strong>第二個</strong>值為 <code>1</code>，把這兩個數傳入 callback 得到 <code>2</code>。</li>
<li>newest$ 送出了<strong>第四個</strong>值 <code>3</code>，但此時 source$ 並沒有送出<strong>第四個</strong>值，所以不會執行 callback。</li>
<li>source$ 送出了<strong>第三個</strong>值 <code>2</code>，newest$ 之前送出的<strong>第三個</strong>值為 <code>2</code>，把這兩個數傳入 callback 得到 <code>4</code>。</li>
<li>source$ 結束 example$ 就直接結束，因為 source$ 跟 newest$ 不會再有對應順位的值</li>
</ul>
<p>zip會把各個observable相同順位送出的值傳入callback, 這很常拿來做demo使用。比如我們想要間隔100ms送出’h’,’e’,’l’,’l’,’o’,就可以這麼做</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(<span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> source2$ = <span class="title function_">interval</span>(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">zip</span>(source2$, <span class="function">(<span class="params">x, y</span>) =&gt;</span> x));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡的 Marble Diagram 就很簡單</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : (hello)|</span><br><span class="line">source2$: -0-1-2-3-4-...</span><br><span class="line">        zip(source2$, (x, y) =&gt; x)</span><br><span class="line">example$: -h-e-l-l-o|</span><br></pre></td></tr></table></figure>

<p>這裡我們利用 zip 來達到原本只能同步送出的資料變成了非同步的，很適合用在建立示範用的資料。</p>
<blockquote>
<p>建議大家平常沒事不要亂用 zip，除非真的需要。因為 zip 必須 cache 住還沒處理的元素，當我們兩個 observable 一個很快一個很慢時，就會 cache 非常多的元素，等待比較慢的那個 observable。這很有可能造成記憶體相關的問題！</p>
</blockquote>
<h5 id="withLastestFrom"><a href="#withLastestFrom" class="headerlink" title="withLastestFrom"></a>withLastestFrom</h5><p>withLatestFrom運作方式跟combineLastest有點像，只是他有主從的關系，只有在主要的observable送出新的值時，才會執行callback, 附隨的observable只有在背景下運作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip, withLatestFrom &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> main$ = <span class="title function_">from</span>(<span class="string">&quot;hello&quot;</span>).<span class="title function_">pipe</span>(<span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x));</span><br><span class="line"><span class="keyword">var</span> some$ = <span class="title function_">from</span>([<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]).<span class="title function_">pipe</span>(<span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = main$.<span class="title function_">pipe</span>(<span class="title function_">withLatestFrom</span>(some$, <span class="function">(<span class="params">x, y</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> y === <span class="number">1</span> ? x.<span class="title function_">toUpperCase</span>() : x;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//h </span></span><br><span class="line"><span class="comment">//e </span></span><br><span class="line"><span class="comment">//l </span></span><br><span class="line"><span class="comment">//L </span></span><br><span class="line"><span class="comment">//O </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>看一下Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">main$   : ----h----e----l----l----o|</span><br><span class="line">some$   : --0--1--0--0--0--1|</span><br><span class="line"> withLastestFrom(some$,(x,y) =&gt; y === 1 ? x.toUpperCase() : x)</span><br><span class="line">example$: ----h----e----l----L----O|</span><br></pre></td></tr></table></figure>

<p>withLatestFrom會在main送出值的時候執行callback,但注意如果main$送出值時some$之前沒有送出過任何值callback仍然不會執行</p>
<p>這陆鄉們在main送出值時，去判斷some$最後一 送的值是不是1來決定是否要切換大小寫</p>
<ul>
<li>main$送出了<code>h</code>, 此時some$上一次送出的值為<code>0</code>, 把這兩個參數傳入callback得到<code>h</code> 。</li>
<li>main$送出了<code>e</code>, 此時some$上一次送出的值為<code>0</code>, 把這兩個參數傳入callback得到<code>e</code> 。</li>
<li>main$送出了<code>l</code>, 此時some$上一次送出的值為<code>0</code>, 把這兩個參數傳入callback得到<code>l</code> 。</li>
<li>main$送出了<code>l</code>, 此時some$上一次送出的值為<code>1</code>, 把這兩個參數傳入callback得到<code>L</code> 。</li>
<li>main$送出了<code>o</code>, 此時some$上一次送出的值為<code>1</code>, 把這兩個參數傳入callback得到<code>O</code>。</li>
</ul>
<p>withLastestFrom很常用在一些checkbox型的功能，例如說一個編輯器，我們開啟粗體後，打出的字就都要變粗體，粗體就像是some observable，而我們打字就是main observable</p>
<h5 id="實務範例-完整拖拉應用"><a href="#實務範例-完整拖拉應用" class="headerlink" title="實務範例-完整拖拉應用"></a>實務範例-完整拖拉應用</h5><p>當我們在優酷看影片時往下滾動畫面，影片會變成一個小視窗在右下角，這個視窗還能夠拖挽移動位置。這個功能可以讓使用者一邊看留言同時又能看影片，且不影響其他的資訊顯示，真是不錯的feature。來實作這個功能，同時補完拖拉所需要注意的細節吧！</p>
<h6 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h6><p>首先我們會有一個影片在最上方，原本是位置是靜態(static)的，捲軸滾到低於影片高度後，影片改為相對於視窗的絕對位置(fixed),往回滾會再變回原來的狀態。當影片為fixed時，滑鼠移至影片上方(hover)會有遮罩(masker)與鼠標變化(cursor)，可以拖拉移動(drag)，且移動範圍不超過可視區間！</p>
<p>上面可以拆成以下幾個步驟</p>
<ul>
<li>準備static樣式與fixed樣式</li>
<li>HTML要有一固定位置的錨點(anchor)</li>
<li>當滾動超過錨點，則影片變成fixed</li>
<li>當往回滾動過錨點上方，則影片變回static</li>
<li>影片fixed時，要能夠拖拉</li>
<li>拖拉範圍限制在當前可視區間</li>
</ul>
<p>其本的HTML跟CSS可以到此連結<a href="https://stackblitz.com/edit/js-cje2qm?file=index.js">stackblitz</a></p>
<p>先讓我們看一下HTML，首先在HTML裡有一個div(#anchor), 這個div(#anchor)就是待會要做錨點用的，它內部有一個div(#video), 則是滾動後要改變成fixed的元件</p>
<p>CSS的部分我們只需要知道滾動到下方後，要把div(#video)加入<code>videx-fixed</code>這個class。</p>
<p>接著我們就開始實作滾動的效果切探class的效果吧！</p>
<h6 id="第一步取得會用到的DOM"><a href="#第一步取得會用到的DOM" class="headerlink" title="第一步取得會用到的DOM"></a>第一步取得會用到的DOM</h6><p>因為先做滾動切換class, 所有這裡用到的DOM只有#video,#anchor。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> video =<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;video&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> anchor = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;anchor&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h6 id="第二步建立會用到的observable"><a href="#第二步建立會用到的observable" class="headerlink" title="第二步建立會用到的observable"></a>第二步建立會用到的observable</h6><p>這裡做滾動效果，所以只需要監聽滾動事件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">const</span> scroll$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&#x27;scroll&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h6 id="第三步撰寫程式邏輯"><a href="#第三步撰寫程式邏輯" class="headerlink" title="第三步撰寫程式邏輯"></a>第三步撰寫程式邏輯</h6><p>這裡我們要取得了scroll事件的observable，當滾過#anchor最底部時，就改變#video的class。</p>
<p>首先我們會需要滾動事件發生時，去判斷是否<strong>滾過#anchor最底部</strong>，所以把原來的滾動事件變成是否滾動最底部的true or false。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scroll$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span>=&gt;</span> anchor.<span class="title function_">getBoundingClientRect</span>().<span class="property">bottom</span>&lt;<span class="number">0</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>這裡我們用山<code>getBoundingClientRect</code>這個瀏覽器原生的API，他可以取得DOM物件的寬高以及上下左右離螢幕可視區間上(左)的距離如下圖</p>
<img src="getBoundingClientRect.png" style="zoom:80%;" />

<p>當我們可視範圍區間滾過#ancor底部時，<code>anchor.getBoundingClientRect().bottom</code>就會變成負值，此時我們就改變#video的class。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scroll$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span>=&gt;</span> anchor.<span class="title function_">getBoundingClientRect</span>().<span class="property">bottom</span>&lt;<span class="number">0</span>)</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="function"><span class="params">bool</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(bool)&#123;</span><br><span class="line">    video.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;video-fixed&#x27;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    video.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;video-fixed&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們就已經完成滾動變更樣式的效果了</p>
<p>全部的JS程式碼如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.scss&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fromEvent &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> video =<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;video&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> anchor = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;anchor&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> scroll$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&#x27;scroll&#x27;</span>);</span><br><span class="line">scroll$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span>=&gt;</span> anchor.<span class="title function_">getBoundingClientRect</span>().<span class="property">bottom</span>&lt;<span class="number">0</span>)</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="function"><span class="params">bool</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(bool)&#123;</span><br><span class="line">    video.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;video-fixed&#x27;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    video.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;video-fixed&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>當然這段還能在用 debounce&#x2F;throttle 或 requestAnimationFrame 做優化</p>
</blockquote>
<p>擒下來我們就可以接著做<strong>拖拉的行為</strong>了。</p>
<h6 id="第一步取得會用到的DOM-1"><a href="#第一步取得會用到的DOM-1" class="headerlink" title="第一步取得會用到的DOM"></a>第一步取得會用到的DOM</h6><p>這裡我們會用到的DOM跟前面是一樣的(#video)，所以不用多做什麼。</p>
<h6 id="第二步建立會用到的observable-1"><a href="#第二步建立會用到的observable-1" class="headerlink" title="第二步建立會用到的observable"></a>第二步建立會用到的observable</h6><p>這裡跟上次一樣，我們會用到mousedown,mouseup,mousemove三個事件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mouseDown$ = <span class="title function_">fromEvent</span>(video,<span class="string">&#x27;mousedown&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mouseUp$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&quot;mouseup&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> mouseMove$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&quot;mousemove&quot;</span>); </span><br></pre></td></tr></table></figure>

<h6 id="第三步撰寫程式邏輯-1"><a href="#第三步撰寫程式邏輯-1" class="headerlink" title="第三步撰寫程式邏輯"></a>第三步撰寫程式邏輯</h6><p>跟上次是差不多的，首先我們會點擊#video元件，點擊(mousedown)後要變成移動事件(mousemove),而移動事件會在滑鼠收開(mouseup)時結事(takeUntil)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>()</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因為把moudeDown$ observable發送出來的<strong>事件</strong>換成了mouseMove$ observable，所以變成了observable(mouseDown$)送出observable(mouseMove$)。因此最後用concalAll把後面送出的元素變成mousemove的事件。</p>
<p>但這裡會有一個問題，就是我們的𫍇段拖拉事件其實只能做用到video-fixed的時候，所以我們要加上<code>filter</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span>=&gt;</span> video.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;video-fixed&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>()</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這裡我們用filter如果當下#video沒有<code>video-fixed</code>class的話，事件就不會送出。</p>
<p>再來我們就能跟上次一樣，把mousemove事件變成{x,y}的物件，並訂閱來改變#video元件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> video.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;video-fixed&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>(),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">m</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">x</span>: m.<span class="property">clientX</span>,</span><br><span class="line">      <span class="attr">y</span>: m.<span class="property">clientY</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">pos</span> =&gt;</span> &#123;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">top</span> = pos.<span class="property">y</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">left</span> = pos.<span class="property">x</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>到這裡我們基本上已經完成了所有功能和之前簡易拖拉的方法是一樣的。</p>
<p>但這裡有兩個大問題我們還沒有解決</p>
<ol>
<li><p>第一次拉動的時候會閃一下，不像優酷那麼順。</p>
</li>
<li><p>拖拉會跑出當前可視區間，跑出去後就抓不回來了</p>
</li>
</ol>
<p>讓我們一個一個解決，首先第一個問題是因為我們的拖拉直接給元件滑鼠的位置(clientC,clientY),而非給滑鼠相對移動的距離！</p>
<p>所以要解決這個問題很簡單，我們只要把點擊目標的左上角當作(0,0), 並以此改變元件的樣式，就不會有閃動的問題。   這個要怎麼做呢？很簡單，使用withLatestFrom的operator我們可以用它來把mousedown與mousemove兩個Event的值同時傳入callback。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> video.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;video-fixed&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>(),</span><br><span class="line">  <span class="title function_">withLatestFrom</span>(mouseDown$, <span class="function">(<span class="params">move, down</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="attr">x</span>: move.<span class="property">clientX</span> - down.<span class="property">offsetX</span>,</span><br><span class="line">      <span class="attr">y</span>: move.<span class="property">clientY</span> - down.<span class="property">offsetY</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">pos</span> =&gt;</span> &#123;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">top</span> = pos.<span class="property">y</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">left</span> = pos.<span class="property">x</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>當我們能夠同時得到mousemove跟mousedown的事件，接著就只要把滑鼠相對可視區間的距離(client)減掉點按下去時，滑鼠相對元件邊界的距離(offset)就行了。這時拖拉就不會先閃動一下囉！</p>
<blockquote>
<p>大家只要想一下，其實client-offset就是元件相對於可視區間的距離，也就是他一開始沒動的位置！</p>
</blockquote>
<p>接著讓我們解決第二個問題，拖拉會超出可視範圍。這個問題其實只史給最大最小值就行了，因無需求的關系，這裡我們的元件是相對可視的區間的絕對位置(fixed),也就是就說</p>
<ul>
<li>top 最小是0</li>
<li>left 最小是0</li>
<li>top 最大是<strong>可視高度</strong>扣掉<strong>元件本身高度</strong></li>
<li>left 最大是<strong>可視寬度</strong>扣掉<strong>元件本身寬度</strong></li>
</ul>
<p>這裡我們先宣告一個function來處理這件事</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">validValue</span> = (<span class="params">value, max, min</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="title class_">Math</span>.<span class="title function_">max</span>(value, min), max)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一個參數給原本要給的位置值，後面給最大跟最小，如果今天大於最大值我們就取最大值，如果今天小於最小值則取最小值。</p>
<p>再來我們就可以直接把這個問題解掉了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> video.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;video-fixed&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>(),</span><br><span class="line">  <span class="title function_">withLatestFrom</span>(mouseDown$, <span class="function">(<span class="params">move, down</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">x</span>: <span class="title function_">validValue</span>(move.<span class="property">clientX</span> - down.<span class="property">offsetX</span>, <span class="variable language_">window</span>.<span class="property">innerWidth</span> - <span class="number">320</span>, <span class="number">0</span>),</span><br><span class="line">      <span class="attr">y</span>: <span class="title function_">validValue</span>(move.<span class="property">clientY</span> - down.<span class="property">offsetY</span>, <span class="variable language_">window</span>.<span class="property">innerHeight</span> - <span class="number">180</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">pos</span> =&gt;</span> &#123;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">top</span> = pos.<span class="property">y</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">left</span> = pos.<span class="property">x</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這裡偷懶了一下，直接寫死元件的寬高(320,180)，實際上應用<code>getBoundingClientRect</code>計算是比較好的。</p>
<h4 id="scan-buffer"><a href="#scan-buffer" class="headerlink" title="scan,buffer"></a>scan,buffer</h4><p>兩個簡單的transformation operators並帶一些小範例，這兩個operators都是實數上很常用到的方法。</p>
<h5 id="scan"><a href="#scan" class="headerlink" title="scan"></a>scan</h5><p>scan其實就是Observable版本的reduce只是命名不同。如果熟悉陣列操作的話，應該會知道原生的JS Array就有reduce的方法，使用方式如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="keyword">var</span> result = arr.<span class="title function_">reduce</span>(<span class="function">(<span class="params">origin, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(origin);</span><br><span class="line">    <span class="keyword">return</span> origin + next;</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="comment">// 10</span></span><br></pre></td></tr></table></figure>

<p>reduce方法需要傳兩個參數，第一個是callback第二個則是起始狀態，這個callback執行時，會傳入兩個參睥一個是原本的狀態，第二個是修改原本狀態的參數，最後回傳一個新的狀態，再繼續執行。</p>
<p>所以這段程式碼是這樣執行的</p>
<ul>
<li><p>第一次執行callback起始狀態是0所以origin傳入0，next為arr的第一個元素1，相加之後變成1回傳並當作下一次的狀態。</p>
</li>
<li><p>第二次執行callback，這時原本的狀態(origin)就變成了1，next為arr的第二個元素2，相加之後變成3回傳並當作下一次的狀態。</p>
</li>
<li><p>第三次執行callback，這時原本的狀態(origin)就變成了3，next為arr的第三個元素3，相加之後變成6回傳並當作下一次的狀態。</p>
</li>
<li><p>第四次執行callback, 這時原本的狀態(origin)就變成了6，next為arr的第四個元素4，相之後變成10回傳並當作下一次的狀態。</p>
</li>
<li><p>這時arr的元素都已經遍歷過了，所以不會直接把10回傳。</p>
</li>
</ul>
<p>scan整體的運作方式都跟reduce一樣，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip, scan &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(<span class="string">&quot;hello&quot;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">600</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">scan</span>(<span class="function">(<span class="params">origin, next</span>) =&gt;</span> origin + next, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// h</span></span><br><span class="line"><span class="comment">// he</span></span><br><span class="line"><span class="comment">// hel</span></span><br><span class="line"><span class="comment">// hell</span></span><br><span class="line"><span class="comment">// hello</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$  : ----h-----e-----l----l----o|</span><br><span class="line">        scan((origin, next) =&gt; origin + next, &#x27;&#x27;)</span><br><span class="line">example$ : ----h----(he)----(hel)----(hello)----(hello)|        </span><br></pre></td></tr></table></figure>

<p>這裡可以看到第一次傳入<code>&#39;h&#39;</code>跟<code>&#39;&#39;</code>相加，返回<code>&#39;h&#39;</code>當作下一次的初始狀態，一直重複下去。</p>
<blockquote>
<p>scan跟reduce最大的差別就在scan一定會回傳一固observable實例，而reduce最後回傳的值有可能是任何資料型別，必須看使用者傳入的callback才態決定reduce最後的返回值。</p>
</blockquote>
<blockquote>
<p>Jafar Husain 就曾說：「JavaScript 的 reduce 是錯了，它最後應該永遠回傳陣列才對！」</p>
</blockquote>
<blockquote>
<p>如果大家之前有到<a href="http://reactivex.io/learnrx/">這裡</a>練習的話，會發現 reduce 被設計成一定回傳陣列，而這個網頁就是 Jafar 做的。</p>
</blockquote>
<p>scan很常用狀態的計算處理，最簡單的就是對一個數字的加減，我們可以綁定一個button的click事件，並用map把click event 轉成1，之後送到scan計算值再做顯示。</p>
<p><a href="https://js-ubgduv.stackblitz.io/">stackblitz</a></p>
<p>在<code>html</code>中</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;addButton&quot;</span>&gt;</span>Add<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;minusButton&quot;</span>&gt;</span>Minus<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">&quot;state&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>javascript</code>中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mapTo, startWith, merge,scan &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> addButton = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;addButton&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> minusButon = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;minusButton&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> state = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;state&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> addClick = <span class="title function_">fromEvent</span>(addButton, <span class="string">&quot;click&quot;</span>).<span class="title function_">pipe</span>(<span class="title function_">mapTo</span>(<span class="number">1</span>));</span><br><span class="line"><span class="keyword">const</span> minusClick = <span class="title function_">fromEvent</span>(minusButton, <span class="string">&quot;click&quot;</span>).<span class="title function_">pipe</span>(<span class="title function_">mapTo</span>(-<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> numberState = <span class="title function_">empty</span>().<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">startWith</span>(<span class="number">0</span>),</span><br><span class="line">  <span class="title function_">merge</span>(addClick, minusClick),</span><br><span class="line">  <span class="title function_">scan</span>(<span class="function">(<span class="params">origin, next</span>) =&gt;</span> origin + next, <span class="number">0</span>)</span><br><span class="line">);</span><br><span class="line">numberState</span><br><span class="line">  .<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; state.<span class="property">innerHTML</span> = value;&#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們用了兩個button，一個是add按鈕，一個是minus按鈕。</p>
<p>我們把這兩個按鈕的點擊事件各建立了<code>addClick</code>,<code>minusClick</code>兩個observable，這兩個observable摎托mapTo(1)跟mapTp(-1),代表被點擊後各自送出的數字！</p>
<p>按著我們用了<code>empty()</code>建立一個空的observable代表畫面上數字的狀態，搭配<code>startWith(0)</code>來設定初始值，接著用<code>merge</code>把兩個observable合併透過scan處理之後的邏輯，最後在subscribe來更改畫面的顯示。</p>
<h5 id="buffer"><a href="#buffer" class="headerlink" title="buffer"></a>buffer</h5><p>buffer是一整個家族，總共有五個相關的operators</p>
<ul>
<li><p>buffer</p>
</li>
<li><p>bufferCount</p>
</li>
<li><p>bufferToggle</p>
</li>
<li><p>bufferWhen</p>
</li>
</ul>
<p>這裡比較常用到的是buffer,bufferCount跟bufferTime這三個，我們直接來看範例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; buffer &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>);</span><br><span class="line"><span class="keyword">var</span> source2$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">buffer</span>(source2$)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// [0,1,2]</span></span><br><span class="line"><span class="comment">// [3,4,5]</span></span><br><span class="line"><span class="comment">// [6,7,8]...</span></span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram則像是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --0--1--2--3--4--5--6--7--</span><br><span class="line">source2$: ---------0---------1--------...</span><br><span class="line">           buffer(source2$)</span><br><span class="line">example$: ---------([0,1,2])---------([3,4,5])           </span><br></pre></td></tr></table></figure>

<p>buffer要傳入一個observable(source2$), 它會把原本的observable(source$)送出的元素緩存在陣列中，等到傳入的observable(source2$)送出元素時，就會觸發把緩存的元素送出。</p>
<p>這裡的範例source$2是每一秒就會送出一個元素，我們柯以改用bufferTime簡潔的表達如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; buffer, bufferTime &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">bufferTime</span>(<span class="number">1000</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// [0,1,2]</span></span><br><span class="line"><span class="comment">// [3,4,5]</span></span><br><span class="line"><span class="comment">// [6,7,8]...</span></span><br></pre></td></tr></table></figure>

<p>除了用時𫂾來作緩存外，我們更常用數量來做緩存，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; bufferCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">bufferCount</span>(<span class="number">3</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// [0,1,2]</span></span><br><span class="line"><span class="comment">// [3,4,5]</span></span><br><span class="line"><span class="comment">// [6,7,8]...</span></span><br></pre></td></tr></table></figure>

<p>在實務上，我們可以用buffer來做某個事件的過濾，例如像是滑鼠連點才能直的執行，這裡我們一樣寫了一個小範例</p>
<p><a href="https://js-mny21w.stackblitz.io/">stackblitz</a></p>
<p>在<code>html</code>中</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span>&gt;</span>double click!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>javascript</code>中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; bufferTime, filter &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;demo&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> click$ = <span class="title function_">fromEvent</span>(button, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> example$ = click$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">bufferTime</span>(<span class="number">500</span>),</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">arr</span> =&gt;</span> arr.<span class="property">length</span> &gt;= <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;success&#x27;</span>); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們只有在500毫秒內連點兩下，才能成功印出<code>success</code>,這個功能在某些特殊的需求中非常的好用，也能用在批次處理來降低request傳送的次數</p>
<h4 id="delay-delayWhen"><a href="#delay-delayWhen" class="headerlink" title="delay,delayWhen"></a>delay,delayWhen</h4><blockquote>
<p>在所有非同步行為中， 最麻煩的大概就是UI操作了，因為UI是直接影響使用者的感受，如果處理的不好對使用者體會大大的扣分 </p>
</blockquote>
<p>UI大概是所有非同步行為中最不好處理的，不只是因為它直接影響了用戶體驗，更大的問題是UI互動常常是高頻𠅋觸發的事件，而且多個元件間的時間序需要不一致，要做這樣的UI互動就不太可能用Promise或async&#x2F;await，但是用RxJS仍然能輕易地處理！</p>
<p>有兩個Operators，delay跟deleyWhen都是跟UI互動比較相關的。當我們的網頁越來越像應用程式，UI互動就變得越重要，讓我們來試試如何用RxJS完成基本的UI互動！</p>
<h5 id="delay"><a href="#delay" class="headerlink" title="delay"></a>delay</h5><p>delay可以延遲observable一開始發送元素的時間點，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">5</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">delay</span>(<span class="number">500</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>當然直接從log出來的訊息看，是完全看不出差異的</p>
<p>讓我們直接看Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --0--1--2--3--4|</span><br><span class="line">         dely(500)</span><br><span class="line">example$: -------0--1--2--3--4|         </span><br></pre></td></tr></table></figure>

<p>從Marble Diagram可以看得出來，第一次送出元素的時間變慢了，雖然在這裡看起來沒有什麼用，但是在UI操作上是非常有用的。</p>
<p>delay除了可以傳入毫秒以外，也可以傳入Date型別的資料，如下使用方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">5</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">delay</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() + <span class="number">1000</span>))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><del>這好像也能用在預定某個日期，讓程式掛掉</del></p>
<h5 id="delayWhen"><a href="#delayWhen" class="headerlink" title="delayWhen"></a>delayWhen</h5><p>delayWhen的作用跟delay很像，最大的差別是delayWhen可以影響每個元素，而且需要傳一個callback並回傳一個observable範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, delayWhen, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">5</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">delayWhen</span>(</span><br><span class="line">        <span class="function"><span class="params">x</span> =&gt;</span> <span class="title function_">empty</span>().<span class="title function_">pipe</span>(<span class="title function_">delay</span>(<span class="number">100</span> * x * x)</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這時我們的Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --0--1--2--3--4|</span><br><span class="line">	  delayWhen(x =&gt; empty().pipe(delay(100 * x * x))</span><br><span class="line">example$: --0---1----2------3-----4|	  </span><br></pre></td></tr></table></figure>

<p>這裡傳進來的x就是source$送出的每個元素，這樣我們就能對每一個做延遲。</p>
<p>這裡我們用delay來做一個小功能，這個功能很簡單就是讓多張照片跟著滑鼠跑，但每張照片不能跑一樣快！</p>
<p>首先我們先泮備六張大頭照，並且寫進HTML</p>
<p>在<code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover6.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover5.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover4.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover3.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover2.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover1.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>用CSS把img改成圓形，並加上邊框以及絕對位置</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-tag">img</span>&#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">border-radius</span>:<span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">border</span>:<span class="number">3</span> px white solid;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate3d</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再來寫JS, 一樣第一步先抓DOM</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> imgList = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;img&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>第二步建立observable</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> movePos = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;mousemove&quot;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> (&#123; <span class="attr">x</span>: e.<span class="property">clientX</span>, <span class="attr">y</span>: e.<span class="property">clientY</span> &#125;))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>第三步撰寫邏輯</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">followMouse</span>(<span class="params">DOMArr</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> delayTime = <span class="number">600</span>;</span><br><span class="line">  <span class="title class_">DOMArr</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">    movePos.<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">delay</span>(delayTime * (<span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">0.65</span>, index) + <span class="title class_">Math</span>.<span class="title function_">cos</span>(index / <span class="number">4</span>)) / <span class="number">2</span>)</span><br><span class="line">    ).<span class="title function_">subscribe</span>(<span class="keyword">function</span> (<span class="params">pos</span>) &#123;</span><br><span class="line">      item.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&#x27;translate3d(&#x27;</span> + pos.<span class="property">x</span> + <span class="string">&#x27;px, &#x27;</span> + pos.<span class="property">y</span> + <span class="string">&#x27;px, 0)&#x27;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">followMouse</span>(<span class="title class_">Array</span>.<span class="title function_">from</span>(imgList));</span><br></pre></td></tr></table></figure>

<p>這裡我們把imgList從Collection轉成Array後傳入<code>followMouse()</code>並用forEach把每個img取出並利用index來達不同的delay時間，這個delay時間的邏輯大家可以自已想，不用跟我一樣，最後subscribe就完成了</p>
<p><a href="https://js-6xzgmu.stackblitz.io/">stackblitz</a></p>
<h4 id="throttle-debounce"><a href="#throttle-debounce" class="headerlink" title="throttle,debounce"></a>throttle,debounce</h4><p>在做效能優化時不可或缺的好工具</p>
<h5 id="debounce"><a href="#debounce" class="headerlink" title="debounce"></a>debounce</h5><p>跟buffer,bufferTime一樣，Rx有debounce跟debounceTime一個是傳入observable另一個則是傳人毫秒，比較常用到的是debounceTime, 看範例</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, debounceTime &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">debounceTime</span>(<span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>這裡只印出<code>4</code>然後就結束了，因為<strong>debounce運作的方式是每次收到元素，他會先把元素cache住並等得一段時間，如果這段時間內已經沒有收到依何元素，則把元素送出； 如果這段時𫂾內又收到新的元素，則會把原本cache住的元素釋放掉並重新計時，不斷動覆。</strong></p>
<p>以現在這個範例來講，我們每300毫秒就會送出一個數值，但我們的debounceTime是1000毫秒，也就是說每次debounce收到元素還等不到1000毫秒，就會收到下一個新元素，然後重新等待1000毫秒，如此重複直到第五個元素送出時，observable結束(complete)了，debounce就直接送出元素。</p>
<p>以Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --0--1--2--3--4|</span><br><span class="line">          debounceTime(1000)</span><br><span class="line">example$: --------------4|</span><br></pre></td></tr></table></figure>

<p>debounce會在收到元素後等待一段時間，這很適合用來處理<strong>間歇行為</strong>，間歇行為就是指這個行為是一段一段的，例如要做AutoComplete時，我們要打字搜尋不會一直不斷的打字，可以等我們停了一小段時間後再送出，才不會每打一固字就送一次request!</p>
<p>這裡舉一個簡單的例子，假設我們想要自動傳送使用者打的字到後端</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> searchInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;searchInput&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> theRequestValue = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;theRequestValue&quot;</span>);</span><br><span class="line"><span class="title function_">fromEvent</span>(searchInput, <span class="string">&quot;input&quot;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    theRequestValue.<span class="property">textContent</span> = value;</span><br><span class="line">    <span class="comment">//在這裏發request</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>如果用上面這段程式碼，就每打一個字就送一次request，當很多人在使用時就會對server造成很大的負擔，實際上我們只需要使用者最後打出來的文字就好了，不用每次都送，這時就能用debouceTime做優化。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, debounceTime &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> searchInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;searchInput&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> theRequestValue = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;theRequestValue&quot;</span>);</span><br><span class="line"><span class="title function_">fromEvent</span>(searchInput, <span class="string">&quot;input&quot;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">debounceTime</span>(<span class="number">300</span>),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">  theRequestValue.<span class="property">textContent</span> = value;</span><br><span class="line">  <span class="comment">//在這裏發request</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a href="https://js-hlsjvm.stackblitz.io/">stackblitz</a></p>
<h5 id="throttle"><a href="#throttle" class="headerlink" title="throttle"></a>throttle</h5><p>其本上每次看到debounce就會看到throttle,他們兩個的作用都是要降低事件的觸發頻率，但行為上有得大的不同。</p>
<p>跟debouce一樣RxJS有throttle跟throttleTime兩個方法，一個是傳入observable另一個是傳入毫秒，比較常用到的也是throttleTime, 直接看範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, throttleTime &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">throttleTime</span>(<span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>跟debounce的不同是throttle會先開放送出元素，等到有元素被送出就會沈默一段時間，等到時間過了又會開放發送元素。</p>
<p>throttlw比較像是控制行為的最高頻率，也就是說如果我們設定<strong>1000毫秒</strong>，那該事件頻率的最大值就是<strong>每秒觸發一次</strong>不會再更快，debouce則比較像是必須等得的時間，要等到一定的時間過了才會收到元素。</p>
<p>throttlw更適合用在<strong>連續性行為</strong>，比如說UI動畫的運算過程，因為UI動畫是連續的，像我們之前在做拖拉時，就可以加上<code>throttleTime(12)</code>讓mousemove event不要發送的太快，避免畫面更新的速度跟不上樣式的切換速度。</p>
<blockquote>
<p>瀏覽器有一個 <a href="https://developer.mozilla.org/zh-TW/docs/Web/API/Window.requestAnimationFrame">requestAnimationFrame</a> API 是專門用來優化 UI 運算的，通常用這個的效果會比 throttle 好，但並不是絕對還是要看最終效果。</p>
</blockquote>
<blockquote>
<p>RxJS 也能用 requestAnimationFrame 做優化，而且使用方法很簡單，這個部份會在 Scheduler 提到。</p>
</blockquote>
<h4 id="distinct-distinctUntilChanged"><a href="#distinct-distinctUntilChanged" class="headerlink" title="distinct,distinctUntilChanged"></a>distinct,distinctUntilChanged</h4><p>除了throttle和debounce兩個方法來做效能優化，其實還有另一個方法可以做效能的優化處理，那就是distinct</p>
<h5 id="distinct"><a href="#distinct" class="headerlink" title="distinct"></a>distinct</h5><p>如果會下SQL指令的應該都對distinct不陌生，它能幫我們把相同值的資料濾掉只留一筆，RxJS裡的distinct也是相同的作用，看範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, zip, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; distinct &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">distinct</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>) &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// a</span></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// c</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>如果有Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --a--b--c--a--b|</span><br><span class="line">            distince()</span><br><span class="line">example$: --a--b--c------|             </span><br></pre></td></tr></table></figure>

<p>從上面的範例可以看得出來，當我們用distinct後，只要有重複出現的值就會被過濾掉。</p>
<p>另外我們可以傳入一個selector callback functon，這個callback function會傳入一個接收到的元素，並回傳我們真正希望比對的值，如下例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, zip, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; distinct &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([&#123; <span class="attr">value</span>: <span class="string">&quot;a&quot;</span> &#125;, &#123; <span class="attr">value</span>: <span class="string">&quot;b&quot;</span> &#125;, &#123; <span class="attr">value</span>: <span class="string">&quot;c&quot;</span> &#125;, &#123; <span class="attr">value</span>: <span class="string">&quot;a&quot;</span> &#125;, &#123; <span class="attr">value</span>: <span class="string">&quot;c&quot;</span> &#125;]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">distinct</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> x.<span class="property">value</span></span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>) &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// &#123;value: &quot;a&quot;&#125;</span></span><br><span class="line"><span class="comment">// &#123;value: &quot;b&quot;&#125;</span></span><br><span class="line"><span class="comment">// &#123;value: &quot;c&quot;&#125;</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到，因為source$送出的都是物件，而js物件比對是比對記憶體位置，所以在這個例子中這些物件永遠不會相等，但實際上我們想比對的是物件中的value, 這時我們就可以傳入selector callback，來選擇我們要比對的值。</p>
<p>實際上<code>distinct()</code>會在背地裡建立一個Set，當接收到元素時會先去判斷Set內是否有相同的值，如果有就不送出，如果沒有則存到Set並送出。所以記得盡量不要直接把distinct用在一個無限的observable裡，這樣很可能會讓Set越來越大，建議大家可以放第二個參數flushes或用distinctUntilChanged.</p>
<blockquote>
<p>這裡指的 Set 其實是 RxJS 自己實作的，跟 ES6 原生的 Set 行為也都一致，只是因為 ES6 的 Set 支援程度還並不理想，所以這裡是直接用 JS 實作。</p>
</blockquote>
<p>distinct可以傳入第二個參數flushed observable用來清除暫存的資料，例子如下(目前有問題)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, zip, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; distinct &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;c&quot;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> flushes$ = <span class="title function_">interval</span>(<span class="number">1300</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">distinct</span>(<span class="literal">null</span>, flushes$)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>) &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們用Marble Diagram比較好表示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --a--b--c--a--c|</span><br><span class="line">flushed$: ------------0---...</span><br><span class="line">          distinct(null,fluehes$)</span><br><span class="line">examples$:--a--b--c-----c|          </span><br></pre></td></tr></table></figure>

<p>其實flushes observable就是在送出元素時，會把distinct的暫存清空，所以之後的暫存就會從頭來過，這樣就不用擔心暫存的Set越來愈大的問題，但其實我們平常不太會用這樣的方式來處理，通常會用另一個方法distinctUntilChanged</p>
<h5 id="distinctUntilChanged"><a href="#distinctUntilChanged" class="headerlink" title="distinctUntilChanged"></a>distinctUntilChanged</h5><p>distinctUntilChanged跟distinct一樣會把相同的元素過濾掉，但distinctUntilChanged只會跟最後一次送出的元素比較，不會每個都比，例子如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, zip, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; distinctUntilChanged &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;b&#x27;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">distinctUntilChanged</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>) &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// a</span></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// c</span></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>這裡distinctUntilChanged只會暫存一個元素，並在收到元素時跟暫存的元素比對，如果一樣就不送出，如果不一樣就色暫存的元素換成剛接收到的新元素並送出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --a--b--c--c--b|</span><br><span class="line">        distinctUntilChanged()</span><br><span class="line">example$: --a--b--c-----b|</span><br></pre></td></tr></table></figure>

<p>從 Marble Diagram 中可以看到，第二個 c 送出時剛好上一個就是 c 所以就被濾掉了，但最後一個 b 則跟上一個不同所以沒被濾掉。</p>
<p>distinctUntilChanged 是比較常在實務上使用的，最常見的狀況是我們在做多方同步時。當我們有多個 Client，且每個 Client 有著各自的狀態，Server 會再一個 Client 需要變動時通知所有 Client 更新，但可能某些 Client 接收到新的狀態其實跟上一次收到的是相同的，這時我們就可用 distinctUntilChanged 方法只處理跟最後一次不相同的訊息，像是多方通話、多裝置的資訊同步都會有類似的情境。</p>
<h4 id="catchError-retry-retryWhen-repeat"><a href="#catchError-retry-retryWhen-repeat" class="headerlink" title="catchError,retry,retryWhen,repeat"></a>catchError,retry,retryWhen,repeat</h4><p>在dayrxjs.js的檔案，𫍇是錯誤處理(Error Hangling)的operators,錯誤處理是非同步行為中的一大難題，尤其有多個交錯的非同步行為時，更容易凸顯錯誤處理的困難。注意上版是catch</p>
<h5 id="catchError"><a href="#catchError" class="headerlink" title="catchError"></a>catchError</h5><p>catchError是很常見的非同步錯諤處理方法，在RxJS中也能夠直接用catch來處理錯誤，在RxJS中的catch可以回傳一個observable來送出新的值，看範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="title function_">of</span>(<span class="string">&quot;h&quot;</span>))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);  </span><br><span class="line"><span class="comment">//A </span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//h </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>這個範例我們每隔500毫秒會送出一個字串(String)並用字串的方法<code>toUpperCase()</code>來把字串的英文字母改成大寫，過程中可能未知的原因送出了一個數值(Number)<code>2</code>導致發生例外(數值沒有toUpperCase的方法)，這時我們在後面接的catchError就能抓到錯誤。</p>
<p>catchError可以回傳一個新的Observable，Promise，Array或何Iterable的物件，來傳送之後的元素。</p>
<p>以例子來說最後就會在送出<code>X</code>就結束，畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c----d----2|</span><br><span class="line">          map(x=&gt; x.toUpperCase())</span><br><span class="line">          ----A----B----c----d----X|</span><br><span class="line">          catchError(error =&gt; of(<span class="string">&quot;h&quot;</span>))</span><br><span class="line">example$: ----A----B----C----D----h|          </span><br></pre></td></tr></table></figure>

<p>可以看到，當錯誤發生後就會進到catchError並重新處理一個新的observable，我們可以利用這個新的observable來送出我們想送的值。</p>
<p>也可以在遇到錯誤後，讓observable結束如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="title function_">empty</span>())</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br><span class="line"><span class="comment">//A </span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>回傳一個empty的observable來直接結事(complete)</p>
<p>另外catchError的callback能接收第二個參數，這個參數會接收當前的observable，我們可以回傳當前的observable來做到重新執行，範例如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function">(<span class="params">error, obs</span>) =&gt;</span> obs)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p>這裡可以看到我們直接回傳了當前的obserable(其實就是example)來重新執行，畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c----d----2|</span><br><span class="line">          map(x =&gt; x.toUpperCase())</span><br><span class="line">          ----A----B----C----D----X|</span><br><span class="line">          catchError((error, obs) =&gt; obs)</span><br><span class="line">example$: ----A----B----C----D--------A----B----C----D--..          </span><br></pre></td></tr></table></figure>

<p>因為我們只是簡單的示範，所以這裡會一直無限循環，實務上通常會用在斷線重連的情境。</p>
<p>另上面的處理方式有一個簡化的寫法，叫做<code>retry()</code>。</p>
<h5 id="retry"><a href="#retry" class="headerlink" title="retry"></a>retry</h5><p>如果我們想要一個observable發生錯誤時，重新嘗式就可以用retry這個𤆧法 ，跟我們前一個講範例的行為是一致</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, retry &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">retry</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通常這種無限的<code>retry</code>會㪜在即時同步的重新連接，讓我們在連線斷掉後，不斷的嘗式。另外我們也可以設定只嘗試幾次，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, retry &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">retry</span>(<span class="number">1</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//A </span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//A</span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//Error: TypeError: x.toUpperCase is not a function</span></span><br></pre></td></tr></table></figure>

<p>這裡我們對retry傳入一個數值<code>1</code>, 能夠讓我們只重複嘗試1次後送出錯誤，畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c----d----2|</span><br><span class="line">          map(x =&gt; x.toUpperCase()),</span><br><span class="line">          ----A----B----C----D----X|</span><br><span class="line">                retry(1)</span><br><span class="line">example$: ----A----B----C----D--------A----B----C----D----X|                </span><br></pre></td></tr></table></figure>

<p>這種處理方式很適合用在Http request失敗的場景中，我們可以設定重新發幾次後，再秀出錯誤訊息</p>
<h5 id="retyrWhen"><a href="#retyrWhen" class="headerlink" title="retyrWhen"></a>retyrWhen</h5><p>RxJS還提供了另一種方法<code>retryWhen</code>，他可以把例外發生的元素放到一個observable中，讓我們可以直接操作這個observable,並等到這個observable操作完後再重新訂閱一次原來的observable。看範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, retryWhen, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">retryWhen</span>(<span class="function"><span class="params">errorObs</span> =&gt;</span> errorObs.<span class="title function_">pipe</span>(<span class="title function_">delay</span>(<span class="number">1000</span>)))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br><span class="line"><span class="comment">//A </span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//一秒</span></span><br><span class="line"><span class="comment">//A</span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br></pre></td></tr></table></figure>

<p>這裡retyrWhen我們傳入一個callback，這個callback有一個參數會傳入一個observable這個observable不是原本的observable(example), 而是例外事件送出的錯誤所組成的一個observable，我們可以對這個由錯誤所組成的observable做操作，等而這次的處理完成後就會重新訂閱我們原本的observable。</p>
<p>這個範例我們是把錯誤的observable送出錯誤延遲1秒，這會使後面重新訂閱動作延遲1秒才執行，Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c----d----2|</span><br><span class="line">         map(x =&gt; x.toUpperCase())</span><br><span class="line">          ----A----B----C----D----X|</span><br><span class="line">         retryWhen(errorObs =&gt; errorObs.pipe(delay(1000)))</span><br><span class="line">example$: ----A----B----C----D-------------------A----B----C----D----.....          </span><br></pre></td></tr></table></figure>

<p>從上圖可以看到後續動新訂閱的為就被延後山，但實務上我們不太會用retryWhen來做重新訂閱的延遲，通常是直接用catchError做到這件事。這裡只是為了示範retryWhen的行為，實務上我們通常會把retyrWhen拿來做錯誤通知或是例外收集範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, retryWhen, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">retryWhen</span>(<span class="function"><span class="params">errorObs</span> =&gt;</span> errorObs.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">err</span>=&gt;</span> <span class="title function_">fetch</span>(<span class="string">&#x27;....&#x27;</span>))))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p>這裡的<code>errorObs.pipe(map(err=&gt; fetch(&#39;....&#39;)))</code>可以把errorObs裡的每個錯誤變成API的發送，通常這裡的API會像是送訊息到公司的通訊頻道(Slack等等)，這樣可以讓工程師馬上知道可服哪個API掛了，這樣我們就能即時地處理，</p>
<blockquote>
<p>retryWhen實際上是在背地裡建立一個Subject並把錯誤放入，會在對這個Subject進行內部的訂閱，因為我們還沒有講到Subject的觀念，大舉可以先把它當作Observable就好了。另外記得這個observable預設是無限的，如果我們把它結束，原本的observable也會跟著結束。</p>
</blockquote>
<h5 id="repeat"><a href="#repeat" class="headerlink" title="repeat"></a>repeat</h5><p>我們有時候可能想要retry一直重複訂閱的效果，但沒有錯誤發生，這時就可以用repeat來做到這件事，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; repeat &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">repeat</span>(<span class="number">1</span>));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br><span class="line"><span class="comment">//a </span></span><br><span class="line"><span class="comment">//b </span></span><br><span class="line"><span class="comment">//c </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c|</span><br><span class="line">		  repeat(1)</span><br><span class="line">exapmle$: ----a----b----c|		  </span><br></pre></td></tr></table></figure>

<p>我們可以不給參數讓它無限循環如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; repeat &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">repeat</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p>這樣我們就可以做不斷重複的行為，這個可以在建立輪詢時使用，讓我們不斷地發request來更新畫面。</p>
<p>我們來看一個錯誤處理在實務應用中的小範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError, concat &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; startWith &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs-compat/operator/startWith&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> title = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;title&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>())</span><br><span class="line">    <span class="comment">// 通常 source 會是建立即時同步的連線，像是 web socket</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function">(<span class="params">error, obs</span>) =&gt;</span> obs.<span class="title function_">pipe</span>(</span><br><span class="line">        <span class="title function_">empty</span>(),</span><br><span class="line">        <span class="title function_">startWith</span>(<span class="string">&#x27;連線發生錯誤： 5秒後重連&#x27;</span>),</span><br><span class="line">        <span class="title function_">concat</span>(obs.<span class="title function_">delay</span>(<span class="number">5000</span>))</span><br><span class="line">    ))</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p>這個範例其實就是模仿在即時同步斷線特，利用catchErroy返品一個新的observable，這固observable會先送出錯誤訊息並且把原本的observable延遲5秒再做合併，雖然這只是一個模仿，但它清楚的展示了 RxJS 在做錯誤處理時的靈活性。</p>
<h4 id="switchAll-mergeAll-concatAll"><a href="#switchAll-mergeAll-concatAll" class="headerlink" title="switchAll, mergeAll, concatAll"></a>switchAll, mergeAll, concatAll</h4><p>這三個operators都是用來處理Higher Order Observable。所謂的Higher Order Observable就是指一個Observable送出的元素還是一個Observable，就像是二維陣列一樣，一個陣列中的每個元素都是陣列。如果用泛型來表達就像是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;Observable&lt;T&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>通常我們需要的是第二層Observable送出的元素，所以我們希望可以把二維的Observable改成一維的，像是下面這樣</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;Observable&lt;T&gt;&gt; =&gt; Observable&lt;T&gt;</span><br></pre></td></tr></table></figure>

<p>其實想要做到這件事有三個方法switchAll、mergeAll、concatAll</p>
<h5 id="concatAll-1"><a href="#concatAll-1" class="headerlink" title="concatAll"></a>concatAll</h5><p>在簡易拖拉的範例時有講過這個operator,concatAll最動要的重點就是他會處理完前一個observable, 才會在處理下一個observable, 讓我們來看一個例子<a href="https://js-f1cdwc.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,concatAll&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>)));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concatAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// (點擊後)</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5 ...</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，當我們點擊畫面時就會開始送出數值，如果用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \    </span><br><span class="line">                     \ ----0----1----2----3----4--...</span><br><span class="line">                      ----0----1----2----3----4--...</span><br><span class="line">                      concatAll()</span><br><span class="line">example$: ----------------0----1----2----3----4--..                      </span><br></pre></td></tr></table></figure>

<p>從Marble Diagram可以看得出來，當我們點擊一下click事件會被轉成一個observable而這個observable會每一秒送出一個遞增的數值，當我們用concatAll之後會把二維的observable攤平成一維的observable，但<strong>concatAll會一個一個處理，一定是等前一個observable完成(complete)才會處理下一個observable</strong>，因為現在送出observable是無限的永遠不會完成(complete)，就導致他永遠不會處理第二個送出的observable!</p>
<p>再看一個例子<a href="https://js-wdl2qz.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,concatAll,take&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concatAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>現在我們把送出的observable限制只取前三個元素，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000).pipe(take(3)))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \                  \ </span><br><span class="line">                     \ ----0----1----2|   ----0----1----2</span><br><span class="line">                      ----0----1----2|</span><br><span class="line">                      concatAll()</span><br><span class="line">example$: ----------------0----1----2----0----1--..   </span><br></pre></td></tr></table></figure>

<p>這裡我們把送出的observable變成有限的，只會送出三個元素，這時就能看得出來concatAll不管兩個observable送出的時間多麼相近，一定會先處理前一個observable再處理下一個。</p>
<h5 id="switchAll"><a href="#switchAll" class="headerlink" title="switchAll"></a>switchAll</h5><p>switchAll同樣能把二維的observable攤平一維的，但他們在行為上有很大的不同，我們來看下面這個範例<a href="https://stackblitz.com/edit/js-ur4ceo?file=index.js">stackblitz.</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,switchAll,take&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>)));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">switchAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \                  \----0----1--..</span><br><span class="line">                     \ ----0----1----2----3----4--...</span><br><span class="line">                      ----0----1----2----3----4--...</span><br><span class="line">                      switch()</span><br><span class="line">example$: ----------------0----1----2--------0----1--..   </span><br></pre></td></tr></table></figure>

<p>switch最重要的就是他會<strong>在新的observable送出後直接處理新的observable不管前一個observable是否完成，每當有新的observable送出就會直接把舊的observable退訂(unsubscribe), 永遠只處理最新的observable!</strong></p>
<p>所以在這上面的Marble Diagram可以看得出來第一次送出的observable跟第二次送出的observable時間點太近，導致第一個observable還來不及送出元素就直接被退訂了，當下一次送出observable就又會把前一次的observable退訂。</p>
<h5 id="margeAll"><a href="#margeAll" class="headerlink" title="margeAll"></a>margeAll</h5><p>它會把二維的observable轉成一維的，並且能夠同時處理所有的observable，讓我們來看這個範例<a href="https://js-k6g4x6.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,mergeAll,take&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>)));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">mergeAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \                  \----0----1--..</span><br><span class="line">                     \ ----0----1----2----3----4--...</span><br><span class="line">                      ----0----1----2----3----4--...</span><br><span class="line">                      switch()</span><br><span class="line">example$: ----------------00---11---22---33---(04)4--..   </span><br></pre></td></tr></table></figure>

<p>從Marble Diagram可以看出來，所有的observable是並行(Parallel)處理的，也就是說mergeAll不會像switchAll一樣退訂(unsubscribe)原先的observable而是並行處理多個observable。以範例來說，當我們點擊越多下，最後送出的頻率就會越快。另外mergeAll可以傳入一個數值，這個數值代表他可以同時處理的observable數量，來看一個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,mergeAll,take&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">mergeAll</span>(<span class="number">2</span>));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們送出的observable改成取前三個，並且讓mergeAll最多只能同時處理2個observable, 用Darble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000).pipe(take(3))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \                  \----0----1----2|</span><br><span class="line">                     \ ----0----1----2|</span><br><span class="line">                      ----0----1----2|</span><br><span class="line">                      mergeAll(2)</span><br><span class="line">example$: ----------------00---11---22---0----1----2..   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>當mergeAll傳入參數後，就會等處理中的其中一個observable完成，再去處理下一個。以我們的例子來說，前面兩個observable可以被並行處理，但第三個observable必須等到第一個observable束後，才會開始。</p>
<p>我們可以利用這個參數來決定要同時處理幾個observable。如果我們傳入<code>1</code>其行為就會跟<code>concatAll</code>是一模一樣的。</p>
<h4 id="switchMap-mergeMap-concatMap"><a href="#switchMap-mergeMap-concatMap" class="headerlink" title="switchMap, mergeMap, concatMap"></a>switchMap, mergeMap, concatMap</h4><p>這三個operators在很多的RxJS相關的library的使用範例上都會看到。</p>
<h5 id="concatMap"><a href="#concatMap" class="headerlink" title="concatMap"></a>concatMap</h5><p>concatMap其實就是map加上concatAll的簡化寫法，看範例<a href="https://js-f7bstc.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, concatAll, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))),</span><br><span class="line">  <span class="title function_">concatAll</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面這個範例就可以簡化成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concatMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">concatMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">100</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>)))</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>注意時間有改變</strong>, 前後兩個行為是一致，記得concatMap也會先處理前一個送出的observable在處理下一個observable，畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : -----------c--c------------------...</span><br><span class="line">         concatMap(e =&gt; interval(100).pipe(take(3)))</span><br><span class="line">example$: -----------0-1-2-0-1-2-----------...         </span><br></pre></td></tr></table></figure>

<p>這樣的行為也很常被用在發送request如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concatMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">concatMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()) )</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們每點擊一下畫面就會送出一個HTTP request,如果我們快速的連續點擊，可以在開發工具的network看到每個request是等到前一個request完成才會送出下一個request如下圖</p>
<img src="2019-07-17_09_46_19_Image.png" style="zoom:80%;" />

<p>從newwork的圖形可以看得出來，第二個request的發送時間是接在第一個request之後的，我們可以確保每一個request會等前一個request完成才做處理。</p>
<p>concatMap還有第二個參數是一個selector callback, 這個callback會傳入四個參數，分別是</p>
<ol>
<li><p>外部observable送出的元素</p>
</li>
<li><p>內部observable送出的元素</p>
</li>
<li><p>外部observable送出的元素的index</p>
</li>
<li><p>內部observable送出的元素三index</p>
</li>
</ol>
<p>回傳值我們想要的值，範例如下<a href="https://js-phxvjv.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concatMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">concatMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()),<span class="function">(<span class="params">e,res,eIndex,resIndex</span>)=&gt;</span> res.<span class="property">title</span> )</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這個範例的外部observable送出的元素就是click event物件，內部observable送出的元素就是response物件，這裡我們回傳response物件的title屬性，這樣一來我們就可以直接到到title, 這個方法很適合在response要選取的值跟前一個事件或順位(index)相關時。</p>
<h5 id="switchMap"><a href="#switchMap" class="headerlink" title="switchMap"></a>switchMap</h5><p>switchMap其實就是map加上switchAll簡化的寫法，如下<a href="https://js-aqx4tt.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, switchAll, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))),</span><br><span class="line">  <span class="title function_">switchAll</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面的程式碼可以簡化成<a href="https://js-aqx4tt.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, switchMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">100</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))),</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : -----------c--c-----------------...</span><br><span class="line">          switchMap(e =&gt; interval(100).pipe(take(3)))</span><br><span class="line">example$: -----------0--0-1-2-------------...          </span><br></pre></td></tr></table></figure>

<p>只要注意一個重點switchMap會在下一個observable被送出後直接退訂前一個未處理完的observable。</p>
<p>另外我們也可以把switchMap用在發送HTTP request<a href="https://js-mfg7zu.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; switchMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()) )</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果我們快速的連續點擊五下，可以在開發工具的network看到每個request會在點擊時發送，雖然我們發送了多個rquest但最後真正印出來的log只會有一個, 代表前面發送的request已經不會造成任何的side-effect了，這個很適合用在只看最後一次request的情境，比如說自動完成(auto complete),我們只需要顯示使用者最後一次打在畫面上的文字，來做建議選項而不用每一次的。</p>
<p>switchMap跟concatMap一樣有第二個參數selector callback可用來回傳我們要的值，這部分的行為跟concatMap是一樣的，這裡就不再贅述。</p>
<h5 id="mergeMap"><a href="#mergeMap" class="headerlink" title="mergeMap"></a>mergeMap</h5><p>mergeMap其實就是map加上mergeAll簡化的寫法如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mergeAll, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))),</span><br><span class="line">  <span class="title function_">mergeAll</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面的程式碼可以簡化成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mergeMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">mergeMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">100</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>)))</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram表示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : -----------c-c------------------...</span><br><span class="line">          mergeMap(e =&gt; interval(100).pipe(take(3)))</span><br><span class="line">example$: -------------0-(10)-(21)-2------...          </span><br></pre></td></tr></table></figure>

<p>記得mergeMap可以並行處理多個observable，以個例子來說當我們快速按兩下，元素發送的時間點是有機會重疊的。</p>
<p>另外我們也可以把mergeMap用在發送HTTP request<a href="https://js-j4o2di.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mergeMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">mergeMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()) )</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果我們快速的連續點擊五下，大家可以在開發者工具的 network 看到每個 request 會在點擊時發送並且會 log 出五個物件</p>
<p>mergeMap也能傳入第二個參數selector callback，這個selector callback跟concatMap第二個參睥也是完全一樣的，但mergeMap的重點是我們可以傳入第三個參數，來限制並行處理的數量<a href="https://js-ps6esy.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mergeMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">mergeMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()), <span class="function">(<span class="params">e, res, eIndex, resIndex</span>) =&gt;</span> res.<span class="property">title</span>, <span class="number">3</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們傳入 3 就能限制，HTTP request 最多只能同時送出 3 個，並且要等其中一個完成在處理下一個</p>
<p>switchMap, mergeMap, concatMap</p>
<p>這三個 operators 還有一個共同的特性，那就是這三個 operators 可以把第一個參數所回傳的 promise 物件直接轉成 observable，這樣我們就不用再用 <code>from</code> 轉一次，如下<a href="https://js-ttxeyr.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concatMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPersonData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">concatMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getPersonData</span>())<span class="comment">//直接回傳 promise 物件</span></span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>至於在使用上要如何選擇這三個operators?其實都還是看使用情境而定，這裡簡單列一下大部分的使用情境</p>
<ul>
<li><p>concatMap用在可以確定<strong>內部的observable結束時間比外部observable發送時間來快的情境</strong>。並且不希望有任何並行處理行為，適合少數要一次一次完成到底的UI動畫或特別的HTTP request行為。</p>
</li>
<li><p>switchMap用在只要最後一次行為的結果，適合絕大多數的使用情境。</p>
</li>
<li><p>mergeMap用在並行處理多個observable，適合需要並行處理的行為，像是多個I&#x2F;O的並行處理。</p>
<blockquote>
<p>建議初學者不確定選哪一個時，使用 switchMap</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>在使用 concatAll 或 concatMap 時，請注意內部的 observable 一定要能夠的結束，且外部的 observable 發送元素的速度不能比內部的 observable 結束時間快太多，不然會有 memory issues</p>
</blockquote>
<h4 id="簡易Auto-Complete實作"><a href="#簡易Auto-Complete實作" class="headerlink" title="簡易Auto Complete實作"></a>簡易Auto Complete實作</h4><p>RxJS的經典範例-自動完成(Auto Complete)，自動完成在實數上的應用非常廣泛，幾乎隨處可見這樣的功能，只履是跟表單、搜尋相關的都會看到。雖然是個很常見的功能，但多數工程師都只是直接套套件來完成，很少有人會自已從頭到尾把完整的邏輯寫一次。如果有自已實作過這個功能的工程師，應該就會知道這個功能在實作的過程中很多細節會讓程式碼變的非常複雜，像是要如何取消上一次發送出去的request、要如何優化請求次數…等等，這些小細節都會讓程式碼變的非常複雜且很難維護。</p>
<h4 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h4><p>首先我們會有一個尋框(input#search),當我們在上面打字並停頓超100毫秒就發送HTTP Request來取得建議選項並顯示在收尋框下方(ul#suggest-list),如果使用者在前一次發送的請求還沒有回來就打了下一個字，此時前一個發送的請求就要捨棄掉，當建議選項顯示之後可以用滑鼠點擊取建議選項代替搜尋框的文字。</p>
<p>上面的敘述可以拆分成以下幾個步驟</p>
<ul>
<li><p>準備input#search以及ul#suggest-list的HTML與CSS</p>
</li>
<li><p>在input#search輸入文字時，等得100毫秒再輸入，就發送HTTP Request</p>
</li>
<li><p>當Response還沒回來時，使用者又輸入了下一個文字就捨棄前一次的輸入並再發送一次新的Request</p>
</li>
<li><p>接受到Response之後顯示建議選項</p>
</li>
<li><p>滑鼠點擊後取代input#search的文字</p>
</li>
</ul>
<p><a href="https://js-2d9ntg.stackblitz.io/">stackblitz</a>在<code>html</code>  中,首先在HTML裡有一個input(#search),這個input(#search)就是要用來輸入的欄位，它下方有一固ul(#suggest-list),則是放建議選項的地方</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;autocomplete&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span> <span class="attr">type</span>=<span class="string">&quot;search&quot;</span> <span class="attr">id</span>=<span class="string">&quot;search&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;suggest-list&quot;</span> <span class="attr">class</span>=<span class="string">&quot;suggest&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>css</code>中</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-tag">html</span>, <span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: white;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.autocomplete</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.input</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">border</span>: none;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid black;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">24px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line">  &amp;<span class="selector-pseudo">:focus</span> &#123;</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">    <span class="attribute">border-bottom-color</span>: blue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.suggest</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">list-style</span>: none;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  -webkit-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">4px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.2</span>);</span><br><span class="line">  <span class="selector-tag">li</span> &#123;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span>;</span><br><span class="line">    &amp;<span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">      <span class="attribute">background-color</span>: lightblue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>javascript</code>中已經寫好了要發送API的url跟方法<code>getSuggestList</code>,接著就開始實作自動完成的效果吧！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url = <span class="string">&#x27;https://zh.wikipedia.org/w/api.php?action=opensearch&amp;format=json&amp;limit=5&amp;origin=*&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getSuggestList</span> = (<span class="params">keyword</span>) =&gt; <span class="title function_">fetch</span>(url + <span class="string">&#x27;&amp;search=&#x27;</span> + keyword, &#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">mode</span>: <span class="string">&#x27;cors&#x27;</span> &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>())</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="第一步取得需要的DOM物件"><a href="#第一步取得需要的DOM物件" class="headerlink" title="第一步取得需要的DOM物件"></a>第一步取得需要的DOM物件</h5><p>這裡我們會用到#search以及#suggest-list這兩個DOM</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> searchInput= <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;search&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> suggestList= <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;suggest-list&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="第二步，建立所需的Observable"><a href="#第二步，建立所需的Observable" class="headerlink" title="第二步，建立所需的Observable"></a>第二步，建立所需的Observable</h5><p>這裡我們要監聽收尋欄位的input事件，以及建議選項的點擊事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> keyword$ = <span class="title function_">fromEvent</span>(searchInput,<span class="string">&quot;input&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> selectItem$= <span class="title function_">fromEvent</span>(suggestList,<span class="string">&quot;click&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="第三步，撰寫程式邏輯"><a href="#第三步，撰寫程式邏輯" class="headerlink" title="第三步，撰寫程式邏輯"></a>第三步，撰寫程式邏輯</h5><p>每當使用者輸入文字就要發送HTTP request並且有新的值被輸入後就捨棄前一次發送的，所以這裡用switchMap</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>這裡我們先試著訂閱，看一下API會回傳什麼樣的資料</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>))</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p>在search欄位亂打幾個字</p>
<img src="2019-07-18_09_42_04_Image.png" style="zoom:80%;" />

<p>可以在console看到資料長相這樣，會回傳一個陣列帶有四個元素，其中第一個元素是我們輸入的值，第二個元素才是我們要的建議選項清單。</p>
<p>所以我們要取的是response陣列的第二的元素，用switchMap的第二個參睥來選取我們要的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>),<span class="function">(<span class="params">e,res</span>)=&gt;</span>res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p>寫一個render方法，把陣列轉成li並寫入suggestList</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">render</span> = (<span class="params">suggestArr=[]</span>)=&gt;&#123;</span><br><span class="line">    suggestList.<span class="property">innerHTML</span> = suggestArr</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">&quot;&lt;li&gt;&quot;</span>+ item+<span class="string">&quot;&lt;/li&gt;&quot;</span>)</span><br><span class="line">    	.<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這時我們就可用render方法把取得的陣列傳入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">render</span> = (<span class="params">suggestArr = []</span>) =&gt; &#123;</span><br><span class="line">  suggestList.<span class="property">innerHTML</span> = suggestArr</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">&quot;&lt;li&gt;&quot;</span> + item + <span class="string">&quot;&lt;/li&gt;&quot;</span>)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>),<span class="function">(<span class="params">e,res</span>)=&gt;</span>res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">subscribe</span>(<span class="function"><span class="params">list</span> =&gt;</span> <span class="title function_">render</span>(list));</span><br></pre></td></tr></table></figure>

<p>如此一來我們打字就能看到結果出現在input下方了</p>
<img src="2019-07-18_10_01_12_Image.png" style="zoom:80%;" />

<p>只是目前還不能點選，先讓我們來做點選的功能，這裡點選的功能我們需要用到delegation event的小技巧，利用ul的click事件，來篩選是否點到了li，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">selectItem$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="title function_">matches</span>(<span class="string">&quot;li&quot;</span>))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>上面我們利用DOM物件的matches方法(裡面的字串放css的selector)來過濾出有點擊到li的事件，再用map轉出我們要的值並寫入input。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">selectItem$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="title function_">matches</span>(<span class="string">&quot;li&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">innerText</span>),</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">text</span> =&gt;</span> searchInput.<span class="property">value</span> = text)</span><br></pre></td></tr></table></figure>

<p>現在我們就能點擊建議清單了，但是點擊後清單沒有消失，這裡我們要在點擊後重新render, 所以把上面的程式碼改一下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">selectItem$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="title function_">matches</span>(<span class="string">&quot;li&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">innerText</span>),</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">text</span> =&gt;</span> &#123;</span><br><span class="line">    searchInput.<span class="property">value</span> = text;</span><br><span class="line">    <span class="title function_">render</span>();</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>這樣一來我們就完成最基本的功能了。</p>
<p>還記得我們前面說每次打完字要等待100毫秒在發送request嗎?這樣能避免過多的request發送，可以降低server的負載也會有比較好的使用者體驗，要做到這件使很簡單只要加上<code>debounceTime(100)</code>就完成了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">debounceTime</span>(<span class="number">100</span>),  </span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>), <span class="function">(<span class="params">e, res</span>) =&gt;</span> res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">list</span> =&gt;</span> <span class="title function_">render</span>(list));</span><br></pre></td></tr></table></figure>

<p>當然這個數值可以依照需求或是請UX針對這個細節作調整。</p>
<p>用了不到30行的程式碼就完成了autocomplete的基本功能，當我們能夠自已從頭到尾的完成這樣的功能，在面對個各種不同的需求，我們就能很方更的針對需求作調整，而不受到套件的牽制！比如說我們希望使用者打了2個字以上在發送request，這時我們只要加上一行filter就可以了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span>=&gt;</span> e.<span class="property">target</span>.<span class="property">value</span>.<span class="property">length</span> &gt;<span class="number">2</span>),  </span><br><span class="line">  <span class="title function_">debounceTime</span>(<span class="number">100</span>),  </span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>), <span class="function">(<span class="params">e, res</span>) =&gt;</span> res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">list</span> =&gt;</span> <span class="title function_">render</span>(list));</span><br></pre></td></tr></table></figure>

<p>又或者網站的使用量很大，可能API在量大的時候會回傳失敗，主管希望可以在API失敗的時候重新嘗試3次，我們只要加個<code>retry(3)</code>就完成了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">value</span>.<span class="property">length</span> &gt; <span class="number">2</span>),</span><br><span class="line">  <span class="title function_">debounceTime</span>(<span class="number">100</span>),</span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>)).<span class="title function_">pipe</span>(<span class="title function_">retry</span>(<span class="number">3</span>)), <span class="function">(<span class="params">e, res</span>) =&gt;</span> res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">list</span> =&gt;</span> <span class="title function_">render</span>(list));</span><br></pre></td></tr></table></figure>

<p>大家會發現我們的靈活度變的非常高，又同時兼顧了程式碼的可讀性，短𠞽的幾行程式碼就完成了一個複雜的需求，這就是RxJS的魅力啊</p>
<h4 id="window-windowToggle"><a href="#window-windowToggle" class="headerlink" title="window, windowToggle"></a>window, windowToggle</h4><p>上面有提到能把Higher Order Observable轉成一般的Observable的operators，今天我們要講能夠把一般的Observable轉成Hight Order Observable的operators。其實前端不太有機會用到這類型的Operators，都是在比較特殊的需求下才會看到，但還是會有遇到的時候。</p>
<h5 id="window"><a href="#window" class="headerlink" title="window"></a>window</h5><p>window是一整個家族總共有五個相關的operators</p>
<ul>
<li><p>window</p>
</li>
<li><p>windowCount</p>
</li>
<li><p>windowTime</p>
</li>
<li><p>windowToggle</p>
</li>
<li><p>windowWhen</p>
</li>
</ul>
<p>我們只介紹window跟windowToggle這兩個方法，其他三個的用法相對都簡單很多，大家如果有需要可以再自行到官網查看。</p>
<p>window很類似buffer可以把一段時間內送出的元素拆出來，只是buffer是把元素拆分到陣列中變成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Observable</span>&lt;T&gt; =&gt; <span class="title class_">Observable</span>&lt;<span class="title class_">Array</span>&lt;T&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>而window則是會把元素拆分出來放到新的observable變成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;T&gt; =&gt; Observable&lt;Observable&lt;T&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>buffer是把拆分出來的元素放到陣列並送出陣列；window是把拆分出來的元素放到observable並送出observable來𢒆一個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; switchAll,<span class="variable language_">window</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> click$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$= source$.<span class="title function_">pipe</span>(<span class="title function_">window</span>(click$));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">pipe</span>(<span class="title function_">switchAll</span>())</span><br><span class="line">    .<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5 ...</span></span><br></pre></td></tr></table></figure>

<p>首先window要傳入一個observable，每當這個observable送出元素時，就會把正在處理的observable所送出的元素放到新的observable中並送出，這裡看Marble Diagram會比較好解䆁</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">click$ : -----------c----------c------------c--</span><br><span class="line"><span class="built_in">source</span>$: ----0----1----2----3----4----5----6---..</span><br><span class="line">            window(click$)</span><br><span class="line">example$:o----------o----------o------------o--   </span><br><span class="line">         \          \          \</span><br><span class="line">          ---0----1-|--2----3--|-4----5----6|</span><br><span class="line">              switchAll()</span><br><span class="line">       : ----0----1----2----3----4----5----6---...     </span><br></pre></td></tr></table></figure>

<p>這裡可看到example$變成發送observable會在每次click事件發送出來後結束，並繼續下一個observable，這裡我們用switchAll把它攤平。</p>
<p>當然這固範例只是想單純的表達widow的作用，沒有什麼太大的意義，實務上window會搭配其他的operators使用，例如我們想計算一秒鐘內觸發了幾次click事件<a href="https://js-jc7wys.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> click$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, switchAll, <span class="variable language_">window</span>, count &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = click$.<span class="title function_">pipe</span>(<span class="title function_">window</span>(source$));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="title function_">count</span>()),</span><br><span class="line">  <span class="title function_">switchAll</span>()</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);= click$.<span class="title function_">pipe</span>(<span class="title function_">window</span>(source$));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="title function_">count</span>())</span><br><span class="line">    <span class="title function_">switchAll</span>()</span><br><span class="line">)</span><br><span class="line">    .<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>這裡我們把source$跟click$對調了，並用到了observable的一個方法<code>count()</code>,可以用來取得observable總共送出了幾個元素，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ---------0---------1---------2--...</span><br><span class="line">           window(<span class="built_in">source</span>$)</span><br><span class="line">click$  : o--------o---------o---------o--..</span><br><span class="line">          \        \         \         \</span><br><span class="line">          -cc---cc|---c-c---|---------|--..</span><br><span class="line">              map(count())</span><br><span class="line">        : o--------o---------o---------o--</span><br><span class="line">         \        \         \         \</span><br><span class="line">          -------4|--------2|--------0|--..</span><br><span class="line">                    switchAll()</span><br><span class="line">        : ---------4---------2---------0--...       </span><br></pre></td></tr></table></figure>

<p>從Marble Diagram中可以看出來，我們把部分元素放到新的observable中，就可以利用Observable的方法做更靈活的操作</p>
<h5 id="windowToggle"><a href="#windowToggle" class="headerlink" title="windowToggle"></a>windowToggle</h5><p>windowToggle不像window只能控制內部observable的結束，windowToggle可以傳入兩個參數，第一個是開始的observable，第二個是一個callback可以回傳一個結束的observable，看範例<a href="https://js-bywet3.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source$= <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> mouseDown$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;mousedown&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> mouseUp$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;mouseup&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">windowToggle</span>(mouseDown$,<span class="function">()=&gt;</span> mouseUp$),</span><br><span class="line">    <span class="title function_">switchAll</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p>一樣用 Marble Diagram 會比較好解釋</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$   : ----0----1----2----3----4----5--...</span><br><span class="line"></span><br><span class="line">mouseDown$: -------D------------------------...</span><br><span class="line">mouseUp$  : ---------------------------U----...</span><br><span class="line"></span><br><span class="line">        windowToggle(mouseDown, () =&gt; mouseUp)</span><br><span class="line"></span><br><span class="line">          : -------o-------------------------...</span><br><span class="line">                  \</span><br><span class="line">                   -1----2----3----4--|</span><br><span class="line">                   switchAll()</span><br><span class="line">example$  : ---------1----2----3----4---------...  </span><br></pre></td></tr></table></figure>

<p>從 Marble Diagram 可以看得出來，我們用 windowToggle 拆分出來內部的 observable 始於 mouseDown 終於 mouseUp。</p>
<h5 id="groubBy"><a href="#groubBy" class="headerlink" title="groubBy"></a>groubBy</h5><p>一個實務上比較常用的operators-groupBy, 它可以幫我們把相同條𤗣的元素拆分成一個Observable，其實就跟平常在下SQL是一樣的概念，我們先來看個例子<a href="https://js-dvlbxt.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, switchAll, windowToggle, count,take ,groupBy&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ =<span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">groupBy</span>(<span class="function"><span class="params">x</span> =&gt;</span> x % <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">// GroupObservable &#123; key: 0, ...&#125;</span></span><br><span class="line"><span class="comment">// GroupObservable &#123; key: 1, ...&#125;</span></span><br></pre></td></tr></table></figure>

<p>上面的例子，我們傳入了一個callback function並回傳groupBy的條件，就能區分每個元素到不同的Observable中，用Marble Diagram表示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ---0---1---2---3---4|</span><br><span class="line">             groupBy(x =&gt; x % 2)</span><br><span class="line">example$: ---o---o------------|</span><br><span class="line">            \   \</span><br><span class="line">            \   1-------3----|</span><br><span class="line">            0-------2-------4|</span><br></pre></td></tr></table></figure>

<p>在實務上，我們可以拿groupBy做完元素四區分後，再對inner Observable操作，例如下面這個例子我們將每個人的分數作加總再送出<a href="https://js-rcq59q.stackblitz.io/">stackblitz.</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip, map, switchAll, mergeAll, count, take, groupBy, reduce &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> people = [</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Anna&#x27;</span>, <span class="attr">score</span>: <span class="number">100</span>, <span class="attr">subject</span>: <span class="string">&#x27;English&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Anna&#x27;</span>, <span class="attr">score</span>: <span class="number">90</span>, <span class="attr">subject</span>: <span class="string">&#x27;Math&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Anna&#x27;</span>, <span class="attr">score</span>: <span class="number">96</span>, <span class="attr">subject</span>: <span class="string">&#x27;Chinese&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Jerry&#x27;</span>, <span class="attr">score</span>: <span class="number">80</span>, <span class="attr">subject</span>: <span class="string">&#x27;English&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Jerry&#x27;</span>, <span class="attr">score</span>: <span class="number">100</span>, <span class="attr">subject</span>: <span class="string">&#x27;Math&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Jerry&#x27;</span>, <span class="attr">score</span>: <span class="number">90</span>, <span class="attr">subject</span>: <span class="string">&#x27;Chinese&#x27;</span> &#125;,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(people);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">groupBy</span>(<span class="function"><span class="params">person</span> =&gt;</span> person.<span class="property">name</span>),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">group</span> =&gt;</span> group.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, curr</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">name</span>: curr.<span class="property">name</span>,</span><br><span class="line">      <span class="attr">score</span>: curr.<span class="property">score</span> + acc.<span class="property">score</span></span><br><span class="line">    &#125;))</span><br><span class="line">  )),</span><br><span class="line">  <span class="title function_">mergeAll</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">// &#123; name: &quot;Anna&quot;, score: 286 &#125;</span></span><br><span class="line"><span class="comment">// &#123; name: &#x27;Jerry&#x27;, score: 270 &#125;</span></span><br></pre></td></tr></table></figure>

<p>這裡我們範例是想把 Jerry 跟 Anna 的分數個別作加總，畫成 Marble Diagram 如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --o--o--o--o--o--o|</span><br><span class="line">  </span><br><span class="line">  groupBy(person =&gt; person.name)</span><br><span class="line">     </span><br><span class="line">       : --i--------i------|</span><br><span class="line">           \        \</span><br><span class="line">           \         o--o--o|</span><br><span class="line">            o--o--o--|</span><br><span class="line">            </span><br><span class="line">	   map(group =&gt; group.pipe(reduce(...)))</span><br><span class="line">	     </span><br><span class="line">       : --i---------i------|</span><br><span class="line">           \         \</span><br><span class="line">           o|        o|</span><br><span class="line">        </span><br><span class="line">             mergeAll()</span><br><span class="line">example$: --o---------o------|          </span><br></pre></td></tr></table></figure>

<h3 id="深入Observable"><a href="#深入Observable" class="headerlink" title="深入Observable"></a>深入Observable</h3><p>以上將大部分的operators都介紹完了，沒有機會好好的解䆁Observable的operators運作方式，一開始是以陣列(Array)的operators(map,filter,concatAll)作為切入點，在學習observable時會更容更接受跟理解，但實際上observable的operators跟陣列的有很大的不同，主要的差異有兩點</p>
<ol>
<li><p>延遲運算</p>
</li>
<li><p>漸進式取值</p>
</li>
</ol>
<h4 id="延遲運算"><a href="#延遲運算" class="headerlink" title="延遲運算"></a>延遲運算</h4><p>延遲運算很好理解，所有Observable一定會等到訂閱後才開始對元素做運算，如果沒有訂閱就不會有運算的行為</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x+<span class="number">1</span>));</span><br></pre></td></tr></table></figure>

<p>上面這段程式因為Observable還沒有訂閱，所以不會真的對元素做運算，這跟陣列的操作不一樣，如下</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">var</span> example = source.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>);ty</span><br></pre></td></tr></table></figure>

<p>上面這段程式執行完，example就已經取得所有元素的返回值了。</p>
<h4 id="漸進式取值"><a href="#漸進式取值" class="headerlink" title="漸進式取值"></a>漸進式取值</h4><p>陣列的operators都必須完整的運算出每個元素的返回值並組成一個陣列，再做下一個operator的運算，我們看下面這段程式碼</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source =p[<span class="number">1</span>,<span class="number">2</span>,<span class="keyword">var</span> source = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> example = source</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function"><span class="params">x</span> =&gt;</span> x % <span class="number">2</span> === <span class="number">0</span>)<span class="comment">// 這裡會運算並返回一個完整的陣列</span></span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>);<span class="comment">// 這裡也會運算並返品一個完整的陣列]</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，有注意到<code>source.filter(...)</code>就會返回整個新陣列，再接下一個operator又會再返回一個新的陣列，這一點其實在我們實作map跟filter時就能觀察到</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">map</span> = <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> result = []; <span class="comment">// 建立新陣列</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">item, index, array</span>) &#123;</span><br><span class="line">        result.<span class="title function_">push</span>(<span class="title function_">callback</span>(item, index, array))</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result; <span class="comment">// 返回新陣列</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每一次的operator的運算都會建立一個新的陣列，並在每個元素都運算完後返回這個新陣列。</p>
<p>Opservable operator的運算方式跟陣列的是完全的不同，雖然Obserbale的operator也都會回傳一個新的observable，但因為元素是漸進式取得的關系，所以每次的運算是一個元素運算到底，而不是運算完全部的元素再返回。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">filter</span>(<span class="function"><span class="params">x</span> =&gt;</span> x === <span class="number">2</span>),<span class="comment">//</span></span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>),</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>目前測試<code>x % 2 ===2 </code>有問題，所以以此來代替</p>
<p>上面這段程式碼運行的方式是這樣的</p>
<ol>
<li><p>送出<code>1</code>到filter被過濾掉</p>
</li>
<li><p>送出<code>2</code>到filter在被送到map轉成<code>3</code>，送到observe<code>console.log</code>印出</p>
</li>
<li><p>送出<code>3</code>到filter被過濾掉</p>
</li>
</ol>
<p>每個元素送出後就是運算到底，在這個過程中不會等待其他的元素運算，這就就是漸進式取值的特性，在提到Iterator跟Observer時，就特別強調這兩個Pattern的共同特性是漸進式值，而我們在實作Iteraotr的過程中其實就能看出這個特性的運作方式</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IteratorFromArray</span> &#123;</span><br><span class="line">	<span class="title function_">constructor</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">_array</span> = arr;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">_cursor</span> = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	<span class="title function_">next</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_cursor</span> &lt; <span class="variable language_">this</span>.<span class="property">_array</span>.<span class="property">length</span> ?</span><br><span class="line">		&#123; <span class="attr">value</span>: <span class="variable language_">this</span>.<span class="property">_array</span>[<span class="variable language_">this</span>.<span class="property">_cursor</span>++], <span class="attr">done</span>: <span class="literal">false</span> &#125; :</span><br><span class="line">		&#123; <span class="attr">done</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="title function_">map</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">		<span class="keyword">const</span> iterator = <span class="keyword">new</span> <span class="title class_">IteratorFromArray</span>(<span class="variable language_">this</span>.<span class="property">_array</span>);</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			<span class="attr">next</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">				<span class="keyword">const</span> &#123; done, value &#125; = iterator.<span class="title function_">next</span>();</span><br><span class="line">				<span class="keyword">return</span> &#123;</span><br><span class="line">					<span class="attr">done</span>: done,</span><br><span class="line">					<span class="attr">value</span>: done ? <span class="literal">undefined</span> : <span class="title function_">callback</span>(value)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> myIterator = <span class="keyword">new</span> <span class="title class_">IteratorFromArray</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);</span><br><span class="line"><span class="keyword">var</span> newIterator = myIterator.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>);</span><br><span class="line">newIterator.<span class="title function_">next</span>(); <span class="comment">// &#123; done: false, value: 2 &#125;</span></span><br></pre></td></tr></table></figure>

<p>上面這段程碼是一個非常簡單的示範，但可以𢒆得出來每一次map雖然都會返回一個新的operator，但實際上在做元素運算時，因為漸進式的特性會使一個元素運算到底，Observable也是相同的概念。</p>
<p>漸進式取值的靣念在Observable中其實非常重要，這個特性也使得Observable相較於Array的operator在做運算時來的高效很多，尤其是在處理大量資料的時候會非常明顯！</p>
<h3 id="什麼是Subject"><a href="#什麼是Subject" class="headerlink" title="什麼是Subject?"></a>什麼是Subject?</h3><h4 id="Subject基本觀念"><a href="#Subject基本觀念" class="headerlink" title="Subject基本觀念"></a>Subject基本觀念</h4><p>我們之前的範例，每個observable都只訂閱一次，而實際上observable是可以多次訂閱的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> observerA$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(observerA$);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(observerB$);</span><br><span class="line"><span class="comment">// &quot;A next: 0&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 0&quot;</span></span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;A complete!&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;B complete!&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，分別用observerA$與observerB$訂閱了source$, 從log可以看出來observerA$跟observerB$都各自收到了元素，但請記得這兩個observer其實是<strong>分開執行</strong>的也就是說他們是完全獨立的，我們把observerB$延遲訂閱來證明看看</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> observerA$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(observerA$);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    source$.<span class="title function_">subscribe</span>(observerB$);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//A next:0 </span></span><br><span class="line"><span class="comment">//A next:1 </span></span><br><span class="line"><span class="comment">//B next:0 </span></span><br><span class="line"><span class="comment">//A next:2 </span></span><br><span class="line"><span class="comment">//A complete </span></span><br><span class="line"><span class="comment">//B next:1 </span></span><br><span class="line"><span class="comment">//B next:2 </span></span><br><span class="line"><span class="comment">//B complete </span></span><br></pre></td></tr></table></figure>

<p>這裡我們延遲一秒再用observerB$訂閱，可以從log中看出1秒後observerA$已經印到了1，這時observerB$開始印卻是從0開始，而不是接著observerA$的進度，代表這兩次的訂閱是完全分開來執行的、或者說是每次的訂閱都建立了一個新一執行。</p>
<p>這樣的行為在大部分的情境下適用，但有些案例下我們會希望第二次訂閱source$不會從頭開始接收元素，而是從第一次訂閱到當前處理的元素開始發送，我們把這種處理方式稱為組播(multicast)，那我們要如何做到組播呢?</p>
<h4 id="手動建立subject"><a href="#手動建立subject" class="headerlink" title="手動建立subject"></a>手動建立subject</h4><p>或許已經有讀者想到解法了，其實我們可以建立一個中間人來訂閱source再由中間人轉送資料出去，就可以達到我們想要的效果</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> observerA$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = &#123;</span><br><span class="line">    <span class="attr">observers</span>: [],</span><br><span class="line">    <span class="attr">addObserver</span>: <span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">push</span>(observer);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">next</span>(value))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observer</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">error</span>(error));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">complete</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">subject$.<span class="title function_">addObserver</span>(observerA$);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">addObserver</span>(observerB$);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//A next:0 </span></span><br><span class="line"><span class="comment">//A next:1 </span></span><br><span class="line"><span class="comment">//B next:1 </span></span><br><span class="line"><span class="comment">//A next:2 </span></span><br><span class="line"><span class="comment">//B next:2 </span></span><br><span class="line"><span class="comment">//A complete </span></span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看到，我們先建立了一個物件叫subject，這個物件具備observer所有的方法(next,error,complete), 並且還能addObserver把observer加到內部的清㽞中，每當有值送出就會遍歷清單中的所有observer並把值再次送出，這樣一來不管多久之後加進來的observer，都會是從當前處理到的元素接續往下走，就像範例中所示，我們用subject＄訂閱source並把observerA$加到subject$中，一秒後再把observerB$加到subject$，這時就可以看到observerB$是直接接教1開始，這就是組播(multicast)的行為。</p>
<p>讓我們把subject$的<code>addObserver</code>改名成<code>subscribe</code>如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> subject$ = &#123;</span><br><span class="line">    <span class="attr">observers</span>: [],</span><br><span class="line">    <span class="attr">subscribe</span>: <span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">push</span>(observer);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">next</span>(value))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observer</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">error</span>(error));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">complete</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>subject其實𣄵是用了Observer Pattern。但這邊為了不履混淆Observer Patter跟RxJS的observer就不再內文提及。</p>
</blockquote>
<p>雖然上面是我們自已手寫的subject，但運作方式跟RxJS的Subject實例是幾乎一樣的，我們把前面的程式碼改成RxJS提供的Subject試試</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> observerA$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA$);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB$);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//A next:0 </span></span><br><span class="line"><span class="comment">//A next:1 </span></span><br><span class="line"><span class="comment">//B next:1 </span></span><br><span class="line"><span class="comment">//A next:2 </span></span><br><span class="line"><span class="comment">//B next:2 </span></span><br><span class="line"><span class="comment">//A complete </span></span><br><span class="line"><span class="comment">//B complete </span></span><br></pre></td></tr></table></figure>

<p>大家會發現使用方法跟前面是相凹的，建立一個subject$先拿去訂閱observable(source$),再把我們真正的observer加到subject$中，這樣一來就能完成訂閱，而每個加到subject$中的observer都能整組的接收到相同的元素。</p>
<h4 id="什麼是Subjet"><a href="#什麼是Subjet" class="headerlink" title="什麼是Subjet?"></a>什麼是Subjet?</h4><p>雖然前面我們已經示範直接手寫一個簡單的subject, 但到底RxJS中的Subject的概念到底是什麼呢？</p>
<p>首先Subject可以拿去訂閱Observable(source)代表他是一個Observer，同時Subject𦙆可以被Observer(observerA$,observerB$)訂閱，代表他是一個Observable。</p>
<p>總結成兩句話</p>
<ul>
<li>Subject同時是Observable又是Observer</li>
<li>Subject會對內部的observers清單進行組(multicast)</li>
</ul>
<h3 id="Subject-BehaviorSubject-ReplaySubject-AsyncSubject"><a href="#Subject-BehaviorSubject-ReplaySubject-AsyncSubject" class="headerlink" title="Subject, BehaviorSubject, ReplaySubject, AsyncSubject"></a>Subject, BehaviorSubject, ReplaySubject, AsyncSubject</h3><p>上面介紹Subject是什麼，今天要講Subject一些應用方式，以及Subject的另外三種變形。</p>
<h4 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h4><p>實際上Subject就是Observer Pattern的實作，他會在內部管理一份observer的清單，並在接收到值時遍歷這份清單並送出值，所以我們可以這樣用Subject</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 1&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 2&quot;</span></span><br></pre></td></tr></table></figure>

<p>這裡我們可以直接用subject的next方法傳送值，所有訂閱的obsrver就會接收到，又因為Subject本身是Observable，所以這樣的使用方式很適合用在某些無法直接使用Observable的前端框架中，例如在React想對DOM的事件做監聽</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyButton</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subject</span> = <span class="keyword">new</span> <span class="title class_">Rx</span>.<span class="title class_">Subject</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subject</span></span><br><span class="line">            .<span class="title function_">mapTo</span>(<span class="number">1</span>)</span><br><span class="line">            .<span class="title function_">scan</span>(<span class="function">(<span class="params">origin, next</span>) =&gt;</span> origin + next)</span><br><span class="line">            .<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">count</span>: x &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;event</span> =&gt;</span> this.subject.next(event)&#125;&gt;&#123;this.state.count&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看出來，𦙲為React本身API的關系，如果我們想要用React自訂的事件，我們沒辦法直接使用Observable的creation operator建立observable，這時就可以靠Subject來做到這件事。</p>
<p>Subject因為同時是observer和observable，所以應用面很廣除了前面所提的之外，還有之前有提到的組播(multicase)特性也會在接下來的文章做更多應用的介紹，這裡先來看看Subject的三個變形。</p>
<h4 id="BehaviorSubject"><a href="#BehaviorSubject" class="headerlink" title="BehaviorSubject"></a>BehaviorSubject</h4><p>很多時候我們會希望Subject能代表當下的狀態，而不是單純的事件發送，也就是說如果今天有一個新的訂閱，我們希望Subject能立即給出最新的值，而不是沒有回應，例如下面這個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 3&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);<span class="comment">// 3 秒後才訂閱，observerB 不會收到任何值。</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>以上這個例子來說，observerB訂閱的之後，是不會有任何元素送給observerB的，因為在這之後沒有執行何何<code>subject$.next()</code>, 但很多時候我們會希望subject能夠表達當前的狀態，在一訂閱時就能收到最新的狀態是什麼，而不是訂閱後要等到有變動才能接收到新的狀態，以這個例子來說，我們希望observerB訂閱時就能立即收到<code>3</code>, 希望做到這樣的效果就可以用BehaviorSubject。</p>
<p>BehaviroSubject跟Subject最大的不同就是BehaviorSubject是用來呈現當前的值，而不是單純的發送事件。BehaviorSubject會記住最新一次發送的元素，並把該元素當作目前的值，在使用上BehaviroSubject建構式需要傳入一個參數來代表起始的狀態，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BehaviorSubject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">BehaviorSubject</span>(<span class="number">0</span>);<span class="comment">// 0 為起始值</span></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"><span class="comment">// &quot;A next: 0&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 3&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// &quot;B next: 3&quot;</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>從上面這個範例可以看得出來BehaviorSubject在建立時就需要給𡥞一個狀態，並在任何一次訂閱，就會先送出最新的狀態。其實這種行為就是一種狀態的表達而非單純的事件，就像是年齡跟生日一樣，年齡是一種狀態而生日就是事件；所以當我們想要用一個steam來達年齡時，就應用BehaviroSubject。</p>
<h4 id="ReplaySubject"><a href="#ReplaySubject" class="headerlink" title="ReplaySubject"></a>ReplaySubject</h4><p>在某些時候我們會希望Subject代表事件，但又能在新訂閱重新發送最後的幾個元素，這時我們新可以用ReplaySubject範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ReplaySubject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">ReplaySubject</span>(<span class="number">2</span>);<span class="comment">//重複發送最後2個元素</span></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 3&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// &quot;B next: 2&quot;</span></span><br><span class="line">    <span class="comment">// &quot;B next: 3&quot;</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>可能會有人以為<code>ReplaySubject(1)</code>是不是就等同於BehaviroSubject，其實是不一樣的，BehaviorSubject在建立時就會有起始值，比如<code>BehaviroSubject(0)</code>起始值就是<code>0</code>, BehaviorSubject是代表著狀態而ReplaySubject只是事件的重放而已。</p>
<h4 id="AsyncSubject"><a href="#AsyncSubject" class="headerlink" title="AsyncSubject"></a>AsyncSubject</h4><p>AsyncSubject是最怪的一個變形，他有點像是operator<code>last</code>，會在subject結事後送出最一個值，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AsyncSubject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">AsyncSubject</span>();</span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">subject$.<span class="title function_">complete</span>();</span><br><span class="line"><span class="comment">// &quot;A next: 3&quot;</span></span><br><span class="line"><span class="comment">// &quot;A complete!&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// &quot;B next: 3&quot;</span></span><br><span class="line">    <span class="comment">// &quot;B complete!&quot;</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看出來，AsyncSubject會在subject結束後才送出最後一個值，其實這個行為跟Promise很像，絕大部分的時候都是使用BehaviorSubject跟ReplaySubject或Subject。</p>
<h3 id="multicast-refCount-publish-share"><a href="#multicast-refCount-publish-share" class="headerlink" title="multicast, refCount, publish, share"></a>multicast, refCount, publish, share</h3><p>有講到Subject時，是希望能夠讓Observable有新訂閱時，可以共用前一個訂閱而不要從頭開始，如下面的例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 0&quot;</span></span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;A complete!&quot;</span></span><br><span class="line"><span class="comment">// &quot;B complete!&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼我們用subject訂閱了source$, 再把observerA跟observerB一個僤訂閱到subject, 這樣就可以讓observarA跟observerB共用同一個執行，但這樣的寫法會讓程式碼看起來太過複雜，我們可以用Observable的multicast operator來簡化這段程式</p>
<h4 id="multicast"><a href="#multicast" class="headerlink" title="multicast"></a>multicast</h4><p>multicast可以用來載subject並回傳一個可連結(connectable)的observable，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, multicast &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">3</span>),</span><br><span class="line">    <span class="title function_">multicast</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Subject</span>())</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line">source$.<span class="title function_">connect</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    source$.<span class="title function_">subscribe</span>(observerB)</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>上面這段程試碼我們透過multicast來掛載一個subject$之後這個observable(source$)的訂閱其實都是訂閱到subject$上。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source$.<span class="title function_">subscribe</span>(observerA);<span class="comment">// subject.subscribe(observerA)</span></span><br></pre></td></tr></table></figure>

<p>必須真的等到執行<code>connect()</code>後才會真的用subject$訂閱source$,並開始送出元素，如果沒有執行<code>connect()</code>observable是不會真正執行的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source$.<span class="title function_">connect</span>();</span><br></pre></td></tr></table></figure>

<p>另外值得注意的是這裡要退訂的話要把<code>connect()</code>回傳的subscription退訂才會直正停止observable的執行，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;send: &quot;</span> + x)),</span><br><span class="line">    <span class="title function_">multicast</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Subject</span>())<span class="comment">// 無限的 observable </span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionA = source$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"><span class="keyword">var</span> realSubscription = source$.<span class="title function_">connect</span>();</span><br><span class="line"><span class="keyword">var</span> subscriptionB;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionB = source$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionA.<span class="title function_">unsubscribe</span>();</span><br><span class="line">    subscriptionB.<span class="title function_">unsubscribe</span>();</span><br><span class="line">    <span class="comment">// 這裡雖然 A 跟 B 都退訂了，但 source 還會繼續送元素</span></span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    realSubscription.<span class="title function_">unsubscribe</span>();</span><br><span class="line">    <span class="comment">// 這裡 source 才會真正停止送元素</span></span><br><span class="line">&#125;, <span class="number">7000</span>);</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，必須等到<code>realSubscription.unsubscribe()</code>執行完，source$才會真的結束。</p>
<p>雖然用了multicast感覺會讓我們處理的對象少一點，但必須搭配connect一起使用還是讓程式碼有點複雜，通常我們會希望有observer訂閱時，就立即執行並發送元素，而不要再多執行一個方法(connect)，這時我們就可以用refCount</p>
<h4 id="refCount"><a href="#refCount" class="headerlink" title="refCount"></a>refCount</h4><p>refCount必須搭配multicast一起使用，他可以建立一個只要有訂閱就會自動connect的observable,範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;send: &quot;</span> + x)),</span><br><span class="line">    <span class="title function_">multicast</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Subject</span>()),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionA = source$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"><span class="comment">//訂閱數 0 =&gt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionB;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionB = source$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// 訂閱數 0 =&gt; 2</span></span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，當source$一被observerA訂閱時(訂閱數從0變成1)，就會立即執行並發送元素，我們就不需要再額外執行connect。</p>
<p>同樣的在退訂時只要訂閱數變成0就會自動停止發送</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;send: &quot;</span> + x)),</span><br><span class="line">    <span class="title function_">multicast</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Subject</span>()),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionA = source$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"><span class="comment">//訂閱數 0 =&gt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionB;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionB = source$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// 訂閱數 0 =&gt; 2</span></span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionA.<span class="title function_">unsubscribe</span>();<span class="comment">// 訂閱數 2 =&gt; 1</span></span><br><span class="line">    subscriptionB.<span class="title function_">unsubscribe</span>();<span class="comment">// 訂閱數 1 =&gt; 0，source 停止發送元素</span></span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>

<h4 id="publish"><a href="#publish" class="headerlink" title="publish"></a>publish</h4><p>其實<code>multicast(()=&gt; new Subject())</code>很常用到，我們有一個簡化的寫法那就是publish,下面這兩段程式碼是完全等價的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">publish</span>(),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new Subject()),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br></pre></td></tr></table></figure>

<p>加上Subject的三種變形</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, publishReplay, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">publishReplay</span>(<span class="number">1</span>),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new publishReplay(1)),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, publishReplay, publishBehavior, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">publishBehavior</span>(<span class="number">1</span>),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new publishBehavior(0)),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, publishReplay, publishBehavior, publishLast, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">publishLast</span>(),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new publishLast()),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br></pre></td></tr></table></figure>

<h4 id="share"><a href="#share" class="headerlink" title="share"></a>share</h4><p>另外publish+ refCount可以在簡寫成share</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, publishReplay, publishBehavior, publishLast, refCount, share &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">share</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     publish(),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new Subject()),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Subject總結"><a href="#Subject總結" class="headerlink" title="Subject總結"></a>Subject總結</h3><p>Subject其實在RxJS中最常被誤解的一部份，因為Subject可以讓你用命令式的方式送值到一個observable的串流中。很多人會直接把這個特性拿來用在<strong>不知道如何建立Observable的狀況</strong>。</p>
<h4 id="Subject與Observable的差異"><a href="#Subject與Observable的差異" class="headerlink" title="Subject與Observable的差異"></a>Subject與Observable的差異</h4><p>永遠記得Subject其實是Observer Design Pattern的實作，所以當observer訂閱到subject時，subject會把訂閱者塞到一份訂閱者清單，在元素發送時就是在遍歷這份清單，並把元素一一送出，這跟Obserbable像是一個function執𢓝是完全不同的。</p>
<p>Subject之所以具有Observable的所有方法，是因為Subject繼承了Observerable的型別，其實Subject型別中主要實做的方法只有next、error、complete、subscribe及unsubscribe這五個方法。而這五個方法就是依照Observer Pattern下法實作的。</p>
<p>總而言之，Subject是Observable的子類別，這個子類別當中用上述的五個方法實作了Observer Pattern，所以他同時具有Observable與Observer的特性。而跟Observable最大的差異就是Subject是具有狀態的，也就是儲存的那份清單！</p>
<p>因為Subject在訂閱時，是把observer放到一分清單當中，並在元素要送出(next)的時候遍歷這份清單，大概就像下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="title function_">next</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// observers 是一個陣列存所有的observer</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i &lt; observers.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        observers[i].<span class="title function_">next</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p>這會衍伸一個大問題，就是在某個observer發生錯誤卻沒有做錯誤處理時，就會影響到別的訂閱，看下面這個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">const</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"><span class="keyword">const</span> example$ = subject$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;oops&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A,&quot;</span>, x));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B,&quot;</span>, x));</span><br><span class="line">subject$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C,&quot;</span>, x));</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br></pre></td></tr></table></figure>

<p>上面這個例子，可能會預期B會在送出1的時候掛掉，另外A跟C會持續發送元素，確實正常應該像這樣運作，但目前RxJX的版植中會B報錯之後，A跟C也同時停止運行。原因就像之前所提的，在遍歷所有的obsever時發生了例外會導到之後的行為停止。</p>
<p>那要如何解決這個問題呢？目前最簡單的方式，當然是盡可能地把所有observer的錯誤處理加進去，這樣一來就不會有例外發生</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">const</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"><span class="keyword">const</span> example$ = subject$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;oops&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A,&quot;</span>, x),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A Error:&quot;</span> + error));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B,&quot;</span>, x),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B Error:&quot;</span> + error));</span><br><span class="line">subject$.<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C,&quot;</span>, x),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C Error:&quot;</span> + error));</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br></pre></td></tr></table></figure>

<p>像上面這段程式碼，當B發生錯誤時就只有B會停止，而不會影響A跟C。</p>
<h4 id="一定需要使用Subject的時機"><a href="#一定需要使用Subject的時機" class="headerlink" title="一定需要使用Subject的時機"></a>一定需要使用Subject的時機</h4><p>Subject正常應該是當我們一個observable的操作過程中發生了side-effect而我們不希望這個side-effect因為多個subscribe而被觸發多次，比如下面這段程式碼？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, asapScheduler &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> result$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">6</span>),</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="title class_">Math</span>.<span class="title function_">random</span>())<span class="comment">// side-effect，平常有可能是呼叫 API 或其他 side effect</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subA$ = result$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A: &quot;</span> + x));</span><br><span class="line"><span class="keyword">var</span> subB$ = result$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B: &quot;</span> + x));</span><br></pre></td></tr></table></figure>

<p>這段程式碼A跟B印出來的亂數就不一樣，代表random(side-effect)被執行了兩次，這種情況就一定會用到subject(或其相關的operators)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, asapScheduler, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, take, multicast, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> result$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">6</span>),</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="title class_">Math</span>.<span class="title function_">random</span>()),<span class="comment">// side-effect</span></span><br><span class="line">    <span class="title function_">multicast</span>(<span class="keyword">new</span> <span class="title class_">Subject</span>()),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subA$ = result$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A: &quot;</span> + x));</span><br><span class="line"><span class="keyword">var</span> subB$ = result$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B: &quot;</span> + x));</span><br></pre></td></tr></table></figure>

<p>改成這樣後我們就讓side-effect不因為訂閱數而多執行，這種情狀就是一定要用subject的。</p>
<h3 id="簡易實作Observable-一"><a href="#簡易實作Observable-一" class="headerlink" title="簡易實作Observable(一)"></a>簡易實作Observable(一)</h3><p>為什麼是簡易實作而不是完整實作呢？實作Observable其實只是幫助我們理解Observable的運作方式，所以會盡可能地簡單，容易理解及吸收。</p>
<h4 id="重點觀念"><a href="#重點觀念" class="headerlink" title="重點觀念"></a>重點觀念</h4><p>Observable跟Observer Pattern是不同的，Observable內部並沒有管理一份訂閱清單，<strong>訂閱Observable就像是執行一個function一樣！</strong></p>
<p>所以實作過程的重點</p>
<ul>
<li><p>訂閱就是執行一個function</p>
</li>
<li><p>訂閱接收的物件具備next,error,complete三個方法</p>
</li>
<li><p>訂閱會返回一個可退訂(unsubscribe)的物件</p>
</li>
</ul>
<h4 id="基本observable實作"><a href="#基本observable實作" class="headerlink" title="基本observable實作"></a>基本observable實作</h4><p>先用最簡單的function來建立observable物件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">subscriber</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> observable = &#123;</span><br><span class="line">        <span class="attr">subscribe</span>: <span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">            <span class="title function_">subscriber</span>(observer)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼就可以做最簡單的訂閱，像下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">subscriber</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> observable = &#123;</span><br><span class="line">        <span class="attr">subscribe</span>: <span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">            <span class="title function_">subscriber</span>(observer)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>這時候我們已經有最簡單的功能了，但這裡有一個大問題，就是observable在結束(complete)就不應該再發送元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&quot;still work&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// &quot;complete!&quot;</span></span><br><span class="line"><span class="comment">// &quot;still work&quot;</span></span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看到comlete之後還是能送出元素來，另外還有一個問題就是observer，如果不完整的就會出錯，這也不是我們希望看到的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&quot;still work&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br><span class="line"><span class="comment">//observer.complete is not a function </span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼可以看出來，當使用者observe物件沒有complete方法時，就會報錯。我們應該修正這兩個問題！</p>
<h4 id="實作簡易Observer"><a href="#實作簡易Observer" class="headerlink" title="實作簡易Observer"></a>實作簡易Observer</h4><p>要修正這兩個問題其實並不難，我們只要實作一個Observer的類別，每次使用者傳入的observer都會利用這個類別轉乘我們想要Observer物件。</p>
<p>首先訂閱時有可能傳入一個observer物件，或是一到三個function,error,complete,所以我們要建立一個類別可以接受各重可能的參數</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">arguments</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="comment">// 空的 observer</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (!destinationOrNext) &#123;</span><br><span class="line">                    <span class="comment">// 空的 observer</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> destinationOrNext === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 傳入了observer物件</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="comment">//如果上面都不是，代表應該是傳入了一到三個function</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>寫一個方法(safeObserver)來回傳正常的observer</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">         <span class="comment">// ... 一些程式碼</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">safeObserver</span>(<span class="params">observerOrNext, error, complete</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> next;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> (observerOrNext) === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">            <span class="comment">// observerOrNext 是 next function</span></span><br><span class="line">            next = observerOrNext;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (observerOrNext) &#123;</span><br><span class="line">            <span class="comment">// observerOrNext 是 observer 物件</span></span><br><span class="line">            next = observerOrNext.<span class="property">next</span> || <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;;</span><br><span class="line">            error = observerOrNext.<span class="property">error</span> || <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> err;</span><br><span class="line">            &#125;;</span><br><span class="line">            complete = observerOrNext.<span class="property">complete</span> || <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//最後回傳我們預期的 observer 物件</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">next</span>: next,</span><br><span class="line">            <span class="attr">error</span>: error,</span><br><span class="line">            <span class="attr">complete</span>: complete</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再把constructor完成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 預設空的 observer</span></span><br><span class="line"><span class="keyword">const</span> emptyObserver = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">() =&gt;</span> &#123; &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="keyword">throw</span> err; &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">arguments</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="comment">// 空的 observer</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(emptyObserver);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (!destinationOrNext) &#123;</span><br><span class="line">                    <span class="comment">// 空的 observer</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(emptyObserver);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> destinationOrNext === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 傳入了observer物件</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(destinationOrNext);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="comment">//如果上面都不是，代表應該是傳入了一到三個function</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(destinationOrNext, error, complete);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">safeObserver</span>(<span class="params">observerOrNext, error, complete</span>) &#123;</span><br><span class="line">       <span class="comment">// ... 一些程式碼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡我們把真正的observer塞到<code>this.destination</code> 接著完成obsserver的方法。</p>
<p>Observer的三個主要的方法(next,error,complete)都應該結束或退訂後不能再被執行，所以我們在物件內部偷塞一個boolean值來作為是否曾經結束的依據。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 一些程式碼</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">safeObserver</span>(<span class="params">observerOrNext, error, complete</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 一些程式碼</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">unsubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStopped</span> = <span class="literal">true</span>; <span class="comment">// 偷塞一個屬性 isStopped</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著實作三個主要的方法就很簡單了，只要先判斷<code>isStopped</code>在使用<code>this.destination</code>物件來傳送值就可以了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 一些程式碼</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">safeObserver</span>(<span class="params">observerOrNext, error, complete</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 一些程式碼</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">next</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isStopped</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">next</span>) &#123;</span><br><span class="line">      <span class="comment">// 先判斷是否停止過</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">next</span>(value); <span class="comment">// 傳送值</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">error</span>(<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isStopped</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">error</span>) &#123;</span><br><span class="line">      <span class="comment">// 先判斷是否停止過</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">error</span>(err); <span class="comment">// 傳送錯誤</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (anotherError) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">        <span class="keyword">throw</span> anotherError;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">complete</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isStopped</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">complete</span>) &#123;</span><br><span class="line">      <span class="comment">// 先判斷是否停止過</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">complete</span>(); <span class="comment">// 發送停止訊息</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>(); <span class="comment">// 發送停止訊息後退訂</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">unsubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStopped</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到這裡我們就完成基本的Observer實作了，接著我讓我們拿到基本版的observable中使用吧。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">subscriber</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observable = &#123;</span><br><span class="line">        <span class="attr">subscribe</span>: <span class="keyword">function</span> (<span class="params">observerOnNext, error, complete</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> realObserver = <span class="keyword">new</span> <span class="title class_">Observer</span>(observerOnNext, error, complete)</span><br><span class="line">            <span class="title function_">subscriber</span>(realObserver);</span><br><span class="line">            <span class="keyword">return</span> realObserver;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// complete!</span></span><br></pre></td></tr></table></figure>

<p>到這裡我們就完成基本的observable了，至少基本的行為都跟我們期望的一致。</p>
<h3 id="簡易實作Observable-二"><a href="#簡易實作Observable-二" class="headerlink" title="簡易實作Observable(二)"></a>簡易實作Observable(二)</h3><p>在上面的文章，我們已經完成了基本的observable以及Observer的簡易實作，這裏會接續上面的文章來實作簡易的Observable類別，以及一個creation operator和一個transform operator。</p>
<h4 id="建立簡易Observable類別"><a href="#建立簡易Observable類別" class="headerlink" title="建立簡易Observable類別"></a>建立簡易Observable類別</h4><p>這是我們上面文章建屯的observable物件的函式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observable = &#123;</span><br><span class="line">        <span class="attr">subscribe</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> realObserver = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">            <span class="title function_">subscribe</span>(realObserver);</span><br><span class="line">            <span class="keyword">return</span> realObserver;</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從這個函式可以看出來，回傳的observable物件至少會有subscribe方法，所以最簡單的Observable類別大概長像下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// ...做某些事</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外create的函式在執行時會傳入一個subscribe的function，這個function會決定observable的行為</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span>(<span class="params">observer</span>)&#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>把上面這一段改成下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="keyword">function</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">  observer.<span class="title function_">complete</span>();</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>所以我們的Observable的建構式應該會接收一個subscribe function</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (subscribe) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_subscribe</span> = subscribe;<span class="comment">//把subscribe存到 _subscribe屬性中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);<span class="comment">//就是執行一個function對吧</span></span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到這裡我們就成功的把create的函式改成Observable的類別了，我們可以直接來使用看看</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (subscribe) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_subscribe</span> = subscribe;<span class="comment">//把subscribe存到 _subscribe屬性中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);<span class="comment">//就是執行一個function對吧</span></span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br></pre></td></tr></table></figure>

<p>當然我們可以仿RxJS在靜態方法中加入create如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (subscribe) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_subscribe</span> = subscribe;<span class="comment">//把subscribe存到 _subscribe屬性中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);<span class="comment">//就是執行一個function對吧</span></span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Observable</span>.<span class="property">create</span> = <span class="keyword">function</span> (<span class="params">subscribe</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observable</span>(subscribe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這樣一來我們就可以用<code>Observable.create</code>建立observable物件實例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="keyword">function</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">  observer.<span class="title function_">complete</span>();</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="建立creation-operator-fromArray"><a href="#建立creation-operator-fromArray" class="headerlink" title="建立creation operator - fromArray"></a>建立creation operator - fromArray</h4><p>當我們有Obserbable類別後要建立creation operator就不難了，這裡我們建立一個fromArray的方法，可以接收array來建立observable，算是Rx的Observable.from的簡化版本，記得creation operators都屬於static方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(subscribe) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_subscribe</span> = subscribe; <span class="comment">// 把 subscribe 存到屬性中</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);</span><br><span class="line">    <span class="keyword">return</span> observer;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立靜態方法 </span></span><br><span class="line"><span class="title class_">Observable</span>.<span class="property">fromArray</span> = <span class="keyword">function</span>(<span class="params">array</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(array)) &#123;</span><br><span class="line">        <span class="comment">// 如果傳入的參數不是陣列，則拋出例外</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;params need to be an array&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="keyword">function</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 遍歷每個元素並送出</span></span><br><span class="line">            array.<span class="title function_">forEach</span>(<span class="function"><span class="params">value</span> =&gt;</span> observer.<span class="title function_">next</span>(value))</span><br><span class="line">            observer.<span class="title function_">complete</span>()</span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            observer.<span class="title function_">error</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observable = <span class="title class_">Observable</span>.<span class="title function_">fromArray</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]);</span><br></pre></td></tr></table></figure>

<p>上面的程式碼我們只是簡單的用new Observable就可以輕鬆地實現我們要的功能，之後就可以用fromArray來建立observable物件。</p>
<h4 id="建立transform-operator-map"><a href="#建立transform-operator-map" class="headerlink" title="建立transform operator - map"></a>建立transform operator - map</h4><p>相信很多人在實作Observable都是卡在這個階段，因為operators都是回傳一個新的observable這中間有很多細節需要注意，並且有些小技巧才能比較好的實現，在開始實作之前，先釐清幾個重點。</p>
<ul>
<li><p>operators(transform,filter,conditional…)都是回傳一個新的observable</p>
</li>
<li><p>大部分的operator其實就是在原本observer外包裹一層物件，讓執行next方法前先把元素做一次處理</p>
</li>
<li><p>operator回傳的opservable訂閱時，還是需要執行原本的observable(資料源)，也就說我們要想辦法保留原本的observable</p>
</li>
</ul>
<p>讓我們一步一步來，首先operators執行完會回傳一個新的observable，這個observable在訂閱時會先去執行operator的行為再發送元素，所以observable的訂閱方法就不能像現在這樣直接把observer傳給subscribe執行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(subscribe)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_subscribe</span>=subscribe;<span class="comment">// 把subscribe存到屬性中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Obserer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="comment">// 先做某個判斷是否當前的observable是具有operator的</span></span><br><span class="line">        <span class="keyword">if</span>(??)&#123;</span><br><span class="line">           <span class="comment">// 用operator 的操作</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="comment">// 如果沒有operator再直接把observer丟給_subscribe</span></span><br><span class="line">           <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer) </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以我們的Observable實作為例，這裡最重要的就是this._subscribe執行，每當執行時就是開始發送元素</p>
</blockquote>
<p>這裡我們可以想像一下當一個map產生的observable訂閱時，應該先判斷出有map這個operator並且傳入原本的資料源以及當前的observer，也就是說我們的map至少有以下這幾件事要做</p>
<ul>
<li><p>建立新的observable</p>
</li>
<li><p>保存原本的observable(資料源)，之後訂閱才有辦法執行</p>
</li>
<li><p>建立並保存operator本身的行為，等到訂閱時執行</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="comment">// 一些程式碼...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">       <span class="comment">// 一些程式碼...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">map</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>();<span class="comment">//邁立新的observable</span></span><br><span class="line">        observable.<span class="property">source</span> = <span class="variable language_">this</span>;<span class="comment">//保存當前的observable(資料源)</span></span><br><span class="line">        opservable.<span class="property">operator</span> = &#123;</span><br><span class="line">            <span class="attr">call</span>: <span class="function">(<span class="params">observer, source</span>) =&gt;</span> &#123;<span class="comment">//執行這個operator的行障</span></span><br><span class="line"></span><br><span class="line">            &#125;<span class="comment">// 儲存當前operator行為，並作為是否有operator的依據</span></span><br><span class="line">        &#125;;<span class="comment">//</span></span><br><span class="line">        <span class="keyword">return</span> observable;<span class="comment">//返回這個新的observable</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面這三個步驟都是必要的，特別是用了<code>observalbe.source=this</code>這個小技巧，來保存原本的observable。但這裡我們還有一個地方沒完成就是operator要做的事，這個部分我們等一下再補，先把subscribe寫完</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="comment">// 一些程式碼...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="comment">//先用this.operator判斷當前的observable是否具有operator</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">operator</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">operator</span>.<span class="title function_">call</span>(observer, <span class="variable language_">this</span>.<span class="property">source</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果沒有operator再直接把observer丟給_subscribe</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">map</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>();<span class="comment">//邁立新的observable</span></span><br><span class="line">        observable.<span class="property">source</span> = <span class="variable language_">this</span>;<span class="comment">//保存當前的observable(資料源)</span></span><br><span class="line">        opservable.<span class="property">operator</span> = &#123;</span><br><span class="line">            <span class="attr">call</span>: <span class="function">(<span class="params">observer, source</span>) =&gt;</span> &#123;<span class="comment">//執行這個operator的行障</span></span><br><span class="line"></span><br><span class="line">            &#125;<span class="comment">// 儲存當前operator行為，並作為是否有operator的依據</span></span><br><span class="line">        &#125;;<span class="comment">//</span></span><br><span class="line">        <span class="keyword">return</span> observable;<span class="comment">//返回這個新的observable</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>記得這裡補的subscribe行為，已經是map回傳新observable的行為，不是原本的observable了。</p>
<p>到這裡我們就幾乎要完成了，接著只要實作map這個operator的行為就可以囉！記得我們前面講的operator其實就是在原本的observer做一層包裏，讓next執行前先對元素做處理。所以我們改寫一下Observer並建立一個MapObserver來做這件事</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">arguments</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="comment">// 空的 observer</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(emptyObserver);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (!destinationOrNext) &#123;</span><br><span class="line">                    <span class="comment">// 空的 observer</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(emptyObserver);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//多一個判斷，是否傳入的destinationOrNext原本就是Observer的實例，如果是就不用在用執行`this.safeObserver`</span></span><br><span class="line">                <span class="keyword">if</span> (destinationOrNext <span class="keyword">instanceof</span> <span class="title class_">Observer</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = destinationOrNext;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> destinationOrNext === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 傳入了observer物件</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(destinationOrNext);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="comment">//如果上面都不是，代表應該是傳入了一到三個function</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(destinationOrNext, error, complete);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...下面都一樣</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MapObserver</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">observer, callback</span>) &#123;</span><br><span class="line">        <span class="comment">// 這裡會傳入原來的observer跟map的callback</span></span><br><span class="line">        <span class="variable language_">super</span>(observer);<span class="comment">//因為有繼承所以要先執行一次父層的建構式</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">callback</span> = callback;<span class="comment">//保存callback</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">next</span> = <span class="variable language_">this</span>.<span class="property">next</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);<span class="comment">//確保next的this</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">next</span>(<span class="variable language_">this</span>.<span class="title function_">callback</span>(value));</span><br><span class="line">            <span class="comment">//this.destination是父層Observer保存的observer物件</span></span><br><span class="line">            <span class="comment">//這裡this.callback(value)就是map的操作</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">error</span>(err);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼就可以讓我們包裹observer物件，利用物件的繼承覆寫原本的next方法。</p>
<p>最後我們就只要補完map方法就可以了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">    <span class="comment">// 一些程式碼...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 一些程式碼...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">map</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>(); </span><br><span class="line">    observable.<span class="property">source</span> = <span class="variable language_">this</span>;</span><br><span class="line">    observable.<span class="property">operator</span> = &#123;</span><br><span class="line">      <span class="attr">call</span>: <span class="function">(<span class="params">observer, source</span>) =&gt;</span> &#123; </span><br><span class="line">        <span class="comment">// 執行這個 operator 的行為</span></span><br><span class="line">        <span class="keyword">const</span> newObserver = <span class="keyword">new</span> <span class="title class_">MapObserver</span>(observer, callback);</span><br><span class="line">        <span class="comment">// 建立包裹後的 observer</span></span><br><span class="line">        <span class="comment">// 訂閱原本的資料源，並回傳</span></span><br><span class="line">        <span class="keyword">return</span> source.<span class="title function_">subscribe</span>(newObserver);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;    </span><br><span class="line">    <span class="keyword">return</span> observable; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡做的事情就簡單很多，我們只要建立包裹過的observer，並用這個包裹後的observer訂閱原本的source。(記得這個function是在subscribe時執行的)</p>
<h4 id="Scheduler基本觀念"><a href="#Scheduler基本觀念" class="headerlink" title="Scheduler基本觀念"></a>Scheduler基本觀念</h4><p>在前面的文章中有提到Scheduler是為了解決RxJS衍生的最後一個問題。</p>
<p>其實RxJS用久了之後就會發現Observable有一個優勢是可以同時處理同步和非同步行為，但這個優勢也帶來了一個問題，就是我們常常會搞不清楚現在的observable執行方式是同步的還是非同步的。換句話話，我們很容易搞不清楚observable到什麼時候開如發送元素！</p>
<p>舉例來說，我們可能很清楚<code>interval</code>是非同步送出元素的，但<code>range</code>呢？<code>from</code>呢?他們可能有時候是非同步有時候是同步，這就會變得有點困擾，尤其在除錯執行順序就非常重要。</p>
<p>而Scheduler其本上就是拿來處理這個問題的!</p>
<h4 id="什麼是Scheduler"><a href="#什麼是Scheduler" class="headerlink" title="什麼是Scheduler?"></a>什麼是Scheduler?</h4><p>Scheduler控制一個observable的訂閱什麼時候開始，以及發送元素什麼時候送達，主要由以下三個元素所組成</p>
<ul>
<li><p>Scheduler是一個資料結構，它知道如何根據優先級或其他標準來儲存並佇列任務。</p>
</li>
<li><p>Scheduler是一個執行環境。它意味著任務何時何地被執行，比如像是立即執行、在回呼(callback)中執行、setTimeout中執行、animation frame中執行</p>
</li>
<li><p>Scheduler是一個虛擬時鐘。它透過<code>now()</code>這個方法提供了時間的概念，我們可以讓任務在特定的時間點被執行。</p>
</li>
</ul>
<p>簡言之Scheduler會影響Observable開始執行及元素送達的時機，比如下這個例子  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span>, asyncScheduler &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; observeOn &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observable = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;before subscribe&quot;</span>);</span><br><span class="line">observable.<span class="title function_">pipe</span>(<span class="title function_">observeOn</span>(asyncScheduler)).<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;after subscribe&quot;</span>);    </span><br><span class="line"><span class="comment">// &quot;before subscribe&quot;</span></span><br><span class="line"><span class="comment">// &quot;after subscribe&quot;</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// &quot;complete&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼原本是同步執行的，但我們用了<code>observable.pipe(observeOn(asyncScheduler))</code>原本是同步執行的就變成了非同步執行了。</p>
<h4 id="有哪些Scheduler可以用"><a href="#有哪些Scheduler可以用" class="headerlink" title="有哪些Scheduler可以用"></a>有哪些Scheduler可以用</h4><p>目前有下面幾種以版本6來說</p>
<ul>
<li>queue</li>
<li>asap</li>
<li>async</li>
<li>animatonFrame</li>
</ul>
<p>會在下面搭配程式碼一一講解</p>
<h4 id="使用Scheduler"><a href="#使用Scheduler" class="headerlink" title="使用Scheduler"></a>使用Scheduler</h4><p>其實我們在使用各種不同的operator時，這些operator就會各自預設不同的scheduler，例如一個無限的observable就會預設為<code>queur</code>Scheduler，而timer相關的operator則預設為<code>async</code>Scheduler。</p>
<p>要使用Scheduler除了前面用到的<code>observeOn()</code>方法外，以下這幾個creation operators最後一個參都能接收Scheduler</p>
<ul>
<li>bindCallback</li>
<li>bindNodeCallback</li>
<li>empty</li>
<li>from</li>
<li>interval</li>
<li>merge</li>
<li>of</li>
<li>range</li>
<li>throw</li>
<li>timer</li>
</ul>
<p>例如下面這個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, asyncScheduler &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; observeOn &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> observable = <span class="title function_">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">observeOn</span>(asyncScheduler)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>另外還有多個operators最後一個參數可以傳入Scheduler這邊就不一一列出，可以參考<a href="https://rxjs-dev.firebaseapp.com/api">官方</a>文件，最通用的方式還是<code>observeOn()</code>只要是observable就可以用這個方法。</p>
<h4 id="queue"><a href="#queue" class="headerlink" title="queue"></a>queue</h4><p>queue的運作方式跟預設的立即執行很像，但是當我們使用到遞回方法時，他會佇列這些行為而非直接執行，一個遞回的operator就是他會執行另一個operator, 最好的例子就是<code>repeat()</code>，如果我們不給他參數的話，他會執行無限多次，像下面這個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, asyncScheduler, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; repeat, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="title function_">of</span>(<span class="number">10</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">repeat</span>(),</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">1</span>)</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p>在RxJS6中他預設了無限的observable為queue所以他會把repeat的next行為先佇列起來，因為前一個complete還在執行中，而這時repeat就會回傳一個可退訂的物件給<code>take(1)</code>等到repeat的next被第一次執行時就會結束，因為<code>take(1)</code>會直接收到值。</p>
<h5 id="使用情境"><a href="#使用情境" class="headerlink" title="使用情境"></a>使用情境</h5><p>quere很適合用在會有遞回的operator且具有大量資料時使用，在這個情況下queue能避免不必要的效能損秏。</p>
<h4 id="asap"><a href="#asap" class="headerlink" title="asap"></a>asap</h4><p>asap的行為很好理解，它是非同步的執行，在瀏覽器其實就是setTimeout設為0秒(在NodeJS中是用process.nextTick)，因為行為很好理解這解就不寫例子了。</p>
<h5 id="使用情境-1"><a href="#使用情境-1" class="headerlink" title="使用情境"></a>使用情境</h5><p>asap因為都是在setTimeout中執行，所以不會有block event loop的問題，很適合用在永遠不會退訂的observable，例如在背景下持續監聽server送來的通知。</p>
<h4 id="async"><a href="#async" class="headerlink" title="async"></a>async</h4><p>它跟asap很像但是使用setInterval來運作，通常是跟時間相關的operator才會用到。</p>
<h4 id="animationFrame"><a href="#animationFrame" class="headerlink" title="animationFrame"></a>animationFrame</h4><p>這個相信大家應該都知道，他是稅用<code>Window.requrestAnimationFrame</code>這個API去實作的，所以執行週期就跟<code>Window.requestAnimationFrame</code>一模一樣。</p>
<h5 id="使用情境-2"><a href="#使用情境-2" class="headerlink" title="使用情境"></a>使用情境</h5><p>在做複雜運算，且高頻率觸發UI動畫時，就很適合使用animationFrame，所以可以搭配throttle operator使用。</p>
<h3 id="Cold-Hot-Observable"><a href="#Cold-Hot-Observable" class="headerlink" title="Cold&amp;Hot Observable"></a>Cold&amp;Hot Observable</h3><blockquote>
<p>Hot Observable跟Cole Observable的差別，其實就是**資料源(Data Source)**在Observable內部建立還是外部建立。</p>
</blockquote>
<p>在RxJS中很常會看偌Cold Observable跟Hot Observable這兩個名詞，其實他們是在區分不同行為的Observable，所謂的Cold Observable就是指每次訂閱都是<strong>獨立的執行</strong>，而Hot Observable則是<strong>共用的訂閱</strong>。</p>
<h4 id="Cold-Observable"><a href="#Cold-Observable" class="headerlink" title="Cold Observable"></a>Cold Observable</h4><p>Cold Observable代表Observable的每個訂閱都是獨立的，他們不會互相影響，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub1: &quot;</span> + value));</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub2: &quot;</span> + value));</span><br><span class="line">&#125;, <span class="number">3500</span>);</span><br><span class="line"><span class="comment">// sub1: 0</span></span><br><span class="line"><span class="comment">// sub1: 1</span></span><br><span class="line"><span class="comment">// sub1: 2</span></span><br><span class="line"><span class="comment">// sub1: 3</span></span><br><span class="line"><span class="comment">// sub2: 0</span></span><br><span class="line"><span class="comment">// sub1: 4</span></span><br><span class="line"><span class="comment">// sub2: 1</span></span><br><span class="line"><span class="comment">// sub2: 2</span></span><br><span class="line"><span class="comment">// sub2: 3</span></span><br><span class="line"><span class="comment">// sub2: 4</span></span><br></pre></td></tr></table></figure>

<p>從上面時程式碼可以看出來每次訂閱<code>source$</code>都是獨立運行的，這種每次訂閱都是<strong>獨立執行</strong>的Observable就稱為Cold Observable。</p>
<p>如果從Observable內部來看，代表<strong>資料源(Data Source)<strong>是在Observable</strong>內部</strong>建立的，大概會長像下面</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    <span class="comment">// 訂閱時，才建立新的資料源</span></span><br><span class="line">    <span class="keyword">const</span> someDataSource$ = <span class="title function_">getSomeDataSource</span>();</span><br><span class="line">    someDataSource$.<span class="title function_">addEventListener</span>(<span class="string">&quot;message&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>因為每次訂閱都建立一個新的資料源，就會使資料從頭開始傳送。</p>
<h4 id="Hot-Observable"><a href="#Hot-Observable" class="headerlink" title="Hot Observable"></a>Hot Observable</h4><p>Hot Observable代表Observable的每個訂閱是共用的，所謂的共用訂閱就是指一個Observable在多次訂閱時，不會每次都從新開始發送元素，例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, share &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">5</span>),</span><br><span class="line">    <span class="title function_">share</span>()</span><br><span class="line">);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub1: &quot;</span> + value));</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub2: &quot;</span> + value));</span><br><span class="line">&#125;, <span class="number">3500</span>);</span><br><span class="line"><span class="comment">// sub1: 0</span></span><br><span class="line"><span class="comment">// sub1: 1</span></span><br><span class="line"><span class="comment">// sub1: 2</span></span><br><span class="line"><span class="comment">// sub1: 3</span></span><br><span class="line"><span class="comment">// sub2: 3</span></span><br><span class="line"><span class="comment">// sub1: 4</span></span><br><span class="line"><span class="comment">// sub2: 4</span></span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看出，當我們對source第二次做訂閱時，接收到的元素是接續第一個訂閱往下發送的，而不是從(0)開始，這種<strong>共用訂閱</strong>的Observable就稱為Hot Observable。</p>
<p>如果從Observable內部來看，就是資料源是在Observable<strong>外部</strong>建立的，程式碼大概就會像下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只有一個資料源，每次訂閱都是用同一個</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> someDataSource = <span class="title function_">getSomeDataSource</span>();</span><br><span class="line"><span class="keyword">const</span> source = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="keyword">function</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">    someDataSource.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="Cold與Hot"><a href="#Cold與Hot" class="headerlink" title="Cold與Hot"></a>Cold與Hot</h4><p>一般的情況下Observable都是Cold的，這樣不同的訂閱才不會有Side Effect互相影響。但在需要多次訂閱的情境下，我們就很有可能需要Hot Observable，而讓RxJS提供了很多讓Cold Observable變成Hot Observable的方法。</p>
<h4 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h4><p>Hot Observable跟Cold Observable的差異就是多次訂閱時，是否共用訂閱或是獨立執行，而這一切的差異就是來自於資料源是在Observable內部建立還是外部建立。</p>
<h3 id="如何Debug？"><a href="#如何Debug？" class="headerlink" title="如何Debug？"></a>如何Debug？</h3><p>Debug一直是RxJS的難題，原因是當我們使用RxJS後，程式碼就會變得高度<strong>抽象化</strong>；實際上抽象並不是什麼壞事，抽象會讓程式碼顯得簡潔、乾淨，但同成也帶來了除鏌上的因難。</p>
<p>在撰寫程式時，我們都會希望程式碼是簡潔且可讀的。𪝂當我們用<strong>簡潔</strong>的程式碼來處理<strong>複雜</strong>的問題，就表示我們的程式碼會變得<strong>高度抽象！</strong>其實人 在思考複雜的問題都會偏好用抽象的方式來處理，例如說在下圍棋時，常常說的<strong>棋形</strong>或是黑白哪一邊的<strong>勢</strong>比較好，這都是在抽象化處理問題。</p>
<h4 id="RxJS如何除錯？"><a href="#RxJS如何除錯？" class="headerlink" title="RxJS如何除錯？"></a>RxJS如何除錯？</h4><h5 id="tap"><a href="#tap" class="headerlink" title="tap"></a>tap</h5><p>在RxJS的世界中有一個Operator叫做<code>tap</code>，它不會對元素產生任何影響，在實務上很常來做錯的追蹤，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, tap, map &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">const</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;tap log: &quot;</span> + x)),</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">X</span> =&gt;</span> X + <span class="number">1</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">X</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;subscirption log: &quot;</span> + X)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// do log: 0</span></span><br><span class="line"><span class="comment">// subscription log: 1</span></span><br><span class="line"><span class="comment">// do log: 1</span></span><br><span class="line"><span class="comment">// subscription log: 2</span></span><br><span class="line"><span class="comment">// do log: 2</span></span><br><span class="line"><span class="comment">// subscription log: 3</span></span><br></pre></td></tr></table></figure>

<p>從上面的例子可以看出來，我們可以傳入一個callback function給<code>tap</code>, 我們可以在tap的內部對元素作任何操作(像是log)，但不會兩元素產生影響。這很適合用在檢測每一步送出的元素是否符合我們的預期。</p>
<blockquote>
<p><code>tap(...)</code>的行為跟<code>map(x =&gt; &#123; ... return x;&#125;)</code>本質上是一樣的</p>
</blockquote>
<h4 id="Observable間的關聯圖"><a href="#Observable間的關聯圖" class="headerlink" title="Observable間的關聯圖"></a>Observable間的關聯圖</h4><p>當程式有點複雜時，我們最好是能先畫出Observable與Observable之間的關聯，在釐清各個Observable間的關系後，我們就能更輕易地找出問題在哪。範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent ,<span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mapTo, merge ,scan&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> addButton= <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;addButton&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> minusButtion= <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;minusButton&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> state =<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;state&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> initialState = <span class="title function_">of</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> addClick= <span class="title function_">fromEvent</span>(addButton,<span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> minusClick=<span class="title function_">fromEvent</span>(minusButton,<span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> numberState= initialState.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">merge</span>(</span><br><span class="line">        addClick.<span class="title function_">pipe</span>(<span class="title function_">mapTo</span>(<span class="number">1</span>)) ,</span><br><span class="line">        minusClick.<span class="title function_">pipe</span>(<span class="title function_">mapTo</span>(-<span class="number">1</span>))</span><br><span class="line">    ),</span><br><span class="line">    <span class="title function_">scan</span>(<span class="function">(<span class="params">origin,next</span>)=&gt;</span> origin+ next)</span><br><span class="line">);</span><br><span class="line">numberState.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span>&#123; state.<span class="property">innerHTML</span> = value;&#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>)=&gt;</span>&#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span>+err);&#125;,</span><br><span class="line">    <span class="attr">complete</span>:<span class="function">()=&gt;</span>&#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>);&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a href="https://js-c7bh5a.stackblitz.io/">stackblitz</a></p>
<p>上面這段程式碼，我們可以把關聯圖畫成以下的樣子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">--------------        --------------        --------------</span><br><span class="line"><span class="string">&#x27;            &#x27;</span>        <span class="string">&#x27;            &#x27;</span>        <span class="string">&#x27;            &#x27;</span> </span><br><span class="line"><span class="string">&#x27;initialState&#x27;</span>        <span class="string">&#x27;  addClcik  &#x27;</span>        <span class="string">&#x27; minusClick &#x27;</span></span><br><span class="line"><span class="string">&#x27;            &#x27;</span>        <span class="string">&#x27;            &#x27;</span>        <span class="string">&#x27;            &#x27;</span></span><br><span class="line">--------------        --------------        --------------</span><br><span class="line">      |                     |                      |</span><br><span class="line">      |                     |  mapTo(1)            | mapTo(-1)</span><br><span class="line">merge | ____________________|                      |</span><br><span class="line">      | \__________________________________________|</span><br><span class="line">      |                      </span><br><span class="line">     \|/</span><br><span class="line">      |</span><br><span class="line">      | scan((origin, next) =&gt; origin + next)</span><br><span class="line">      |</span><br><span class="line">     \|/</span><br><span class="line">-------------</span><br><span class="line">&#x27;           &#x27;</span><br><span class="line">&#x27;numberState&#x27;  </span><br><span class="line">&#x27;           &#x27;</span><br><span class="line">-------------</span><br></pre></td></tr></table></figure>

<p>把每一個observable物件都框起來，並畫出之間的關聯，以及中間使用的Operators，這樣一來我們就能夠很清楚的了解這段程式碼在做什麼事，以及如何運作。最後我們只要在每一估環節去確認送出的元素就能找出錯誤出現在哪裡。</p>
<h4 id="Marble-Diagram"><a href="#Marble-Diagram" class="headerlink" title="Marble Diagram"></a>Marble Diagram</h4><p>在釐清每個observable之間的關系並找出間題出現在哪個環節之 ，我們只要畫出該環節的Marble Diagram前後變化就能清楚地知道間題是如何發生。接續上面的例子，如果今天問題出在<code>merge()</code>之後，那我們就把<code>merge()</code>前後的Marble Diagram畫出來</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">initialState: 0|</span><br><span class="line">addClick    : ----------1---------1--1-------</span><br><span class="line">minusClick  : -----(-1)---(-1)---------------</span><br><span class="line"></span><br><span class="line">                       merge(...)</span><br><span class="line"></span><br><span class="line">            : 0----(-1)-1-(-1)----1--1-------</span><br><span class="line">           </span><br><span class="line">           scan((origin, next) =&gt; origin +next)</span><br><span class="line"></span><br><span class="line">numberState : <span class="number">0</span>----(-<span class="number">1</span>)-<span class="number">0</span>-(-<span class="number">1</span>)----<span class="number">0</span>--<span class="number">1</span>-------     </span><br></pre></td></tr></table></figure>

<p>到這裡我們應該就能清楚地知道問題出在哪，最後就只要想如何解決問題就行了。</p>
<blockquote>
<p>如果還不知道間題在哪，很有可能是Marble Diagram畫鏌，可以再利用<code>tap</code>進行檢查</p>
</blockquote>
<p>只要照著以上三個步驟做除錯，基本上就不用擔心會有解決不了的錯誤，但是這三個步驟仍然顯得太過繁瑣，或許我們應該做一個工具來簡化這整個流程！</p>
<h6 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h6><ul>
<li><a href="https://ithelp.ithome.com.tw/users/20103367/ironman/1199">30 天精通 RxJS</a></li>
<li><a href="https://www.jianshu.com/p/869a3f74d3ca">番外：Rx–隐藏在Angular 2.x中利剑</a></li>
<li><a href="http://rxmarbles.com/#from">rxmarbles</a></li>
<li><a href="https://www.imooc.com/article/70323">RxJS v6 学习指南</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E4%B8%80%E5%80%8BJS%E5%AD%B8%E7%BF%92%E8%80%85%E7%9A%84%E6%97%A5%E5%B8%B8/%E4%B8%80%E5%80%8BJS%E5%AD%B8%E7%BF%92%E8%80%85%E7%9A%84%E6%97%A5%E5%B8%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E4%B8%80%E5%80%8BJS%E5%AD%B8%E7%BF%92%E8%80%85%E7%9A%84%E6%97%A5%E5%B8%B8/%E4%B8%80%E5%80%8BJS%E5%AD%B8%E7%BF%92%E8%80%85%E7%9A%84%E6%97%A5%E5%B8%B8/" class="post-title-link" itemprop="url">一個JS學習者的日常</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-05-24 09:28:00" itemprop="dateCreated datePublished" datetime="2019-05-24T09:28:00+00:00">2019-05-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/javascript/" itemprop="url" rel="index"><span itemprop="name">javascript</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>這是參考鐵人賽的一個JS學習者的日常所得來的，就只是記錄一下</p>
<h3 id="day01陣列相關"><a href="#day01陣列相關" class="headerlink" title="day01陣列相關"></a>day01陣列相關</h3><p>我們會用很多的陣列處理方法，<code>forEach</code>,<code>map</code>,<code>reduce</code>,<code>filter</code></p>
<p>測試資料</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> people = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jim&#x27;</span>,</span><br><span class="line">    <span class="attr">nickname</span>: <span class="string">&#x27;Hamburger&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">28</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Andy&#x27;</span>,</span><br><span class="line">    <span class="attr">nickname</span>: <span class="string">&#x27;Spaghetti&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">27</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Kevin&#x27;</span>,</span><br><span class="line">    <span class="attr">nickname</span>: <span class="string">&#x27;Curry&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">27</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Arel&#x27;</span>,</span><br><span class="line">    <span class="attr">like</span>: <span class="string">&#x27;Sushi&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">27</span></span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>過了一年，所有人都長了一歲怎麼辦？要在每一個age上面加一歲</p>
<p>先將資料簡化成更單純的樣子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> age = [<span class="number">28</span>, <span class="number">27</span>, <span class="number">27</span>, <span class="number">27</span>]</span><br><span class="line">age.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">item,index</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item,index);</span><br><span class="line">&#125;);</span><br><span class="line">age.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item,index</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item,index);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 28 0</span></span><br><span class="line"><span class="comment">// 27 1</span></span><br><span class="line"><span class="comment">// 27 2</span></span><br><span class="line"><span class="comment">// 27 3</span></span><br></pre></td></tr></table></figure>

<p><strong>forEach</strong> 只把資料丟給內部的<code>callback function</code>去進行處理</p>
<p><strong>map</strong> 把資料丟給內部的<code>callback function</code>去進行處理，並回組一組<strong>陣列</strong>資料</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> result=age.<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">item, index</span>) &#123;</span><br><span class="line">    item = item + index</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">result= age.<span class="title function_">map</span>(<span class="function">(<span class="params">item,index</span>)=&gt;</span>&#123;</span><br><span class="line">    item= item+index;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br></pre></td></tr></table></figure>

<p><strong>reduce</strong>抓取初始值與下一個值，並回傳一個結果值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rsreduce = age.<span class="title function_">reduce</span>(<span class="keyword">function</span> (<span class="params">item, item2</span>) &#123;</span><br><span class="line">    item = item + item2;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 28 + 27 + 27 + 27 = 109</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rsreduce);</span><br><span class="line">rsreduce = age.<span class="title function_">reduce</span>(<span class="function">(<span class="params">item, item2</span>) =&gt;</span> &#123;</span><br><span class="line">    item = item + item2;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 28 + 27 + 27 + 27 = 109</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rsreduce);</span><br></pre></td></tr></table></figure>

<p><strong>filter</strong>回傳Boolesn值true或false判斷引人處理後是否為要回傳的值，最後回一組陣列</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//filter</span></span><br><span class="line"><span class="keyword">var</span> rsfilter = age.<span class="title function_">filter</span>(<span class="keyword">function</span> (<span class="params">item</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (item &lt; <span class="number">28</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rsfilter);</span><br><span class="line">rsfilter = age.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (item &lt; <span class="number">28</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rsfilter);</span><br></pre></td></tr></table></figure>

<p>但回到原本的資料，如何把所有的年齡加1</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">people.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    item.<span class="property">age</span> += <span class="number">1</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(people);</span><br></pre></td></tr></table></figure>

<h3 id="day02"><a href="#day02" class="headerlink" title="day02"></a>day02</h3><p>一個物件資料， 想要複製樣的格式給下一個，並修改結果被更動到了原本的人資料,這是因為是指同一個位置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Jim</span> = &#123;</span><br><span class="line">    <span class="attr">favMovie</span>: <span class="string">&quot;LaLaLand&quot;</span>,</span><br><span class="line">    <span class="attr">favBook</span>: <span class="string">&quot;Thid Hitchhiker&#x27;s Guide to the Galaxy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Albert</span> = <span class="title class_">Jim</span>;</span><br><span class="line"><span class="title class_">Albert</span>.<span class="property">favMovie</span> = <span class="string">&quot;Fight Club&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Jim</span>.<span class="property">favMovie</span>);</span><br><span class="line"><span class="comment">//Fight Club</span></span><br></pre></td></tr></table></figure>
<p>使用Object.assign</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用Object.assign</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Jim</span> = &#123;</span><br><span class="line">    <span class="attr">favMovie</span>: <span class="string">&quot;LaLaLand&quot;</span>,</span><br><span class="line">    <span class="attr">favBook</span>: <span class="string">&quot;Thid Hitchhiker&#x27;s Guide to the Galaxy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Albert</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, <span class="title class_">Jim</span>);</span><br><span class="line"><span class="title class_">Albert</span>.<span class="property">favMovie</span> = <span class="string">&quot;back to the future&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Jim</span>.<span class="property">favMovie</span>)</span><br><span class="line"><span class="comment">//LaLaLand</span></span><br></pre></td></tr></table></figure>

<p><strong>const</strong> 指定常數，不可改變，但是是陣列時內容是可以改變</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">PI</span>=<span class="number">3.14159</span>;</span><br><span class="line"><span class="variable constant_">PI</span>=<span class="number">1.141</span>;<span class="comment">//有錯誤，不可再指定</span></span><br><span class="line"><span class="comment">//Assignment to constant variable. </span></span><br><span class="line"><span class="comment">//  at ​day02.js:21:0​</span></span><br><span class="line"><span class="comment">//  at ​​​Object.&lt;anonymous&gt;​​​</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">arr.<span class="title function_">push</span>(<span class="number">4</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr);</span><br><span class="line">arr[<span class="number">3</span>]=<span class="number">999</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr)</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">arr2=[<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>]</span><br><span class="line">arr= arr2;<span class="comment">//有錯誤，不可再指定</span></span><br></pre></td></tr></table></figure>

<p>函式沒有傳入參數，卻有這個變數可以用？回傳的這是啥</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>.<span class="property">length</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hello</span>(<span class="string">&#x27;echoooo&#x27;</span>);</span><br><span class="line"><span class="comment">//1 ​​​​​at ​​​arguments.length</span></span><br><span class="line"><span class="comment">//&#123; [Iterator]  0: &#x27;echoooo&#x27;, [Symbol(Symbol.iterator)]: [λ: values] &#125; at ​​​arguments​​​ </span></span><br></pre></td></tr></table></figure>

<p>this是“這”的意思嗎？this到底指到哪裏？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">sayHi</span>: <span class="string">&quot;How ar you?&quot;</span>,</span><br><span class="line">    <span class="attr">sayHello</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">sayHi</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayHelo</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(obj);</span><br><span class="line">    obj.<span class="title function_">sayHello</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">sayHelo</span>(obj);</span><br><span class="line"><span class="comment">// &#123; sayHi: &#x27;How ar you?&#x27;, sayHello: [λ: sayHello] &#125;   at ​​​obj​​​ </span></span><br><span class="line"><span class="comment">// How ar you? ​​​​​at ​​​this.sayHi</span></span><br></pre></td></tr></table></figure>

<h3 id="day03基本型別"><a href="#day03基本型別" class="headerlink" title="day03基本型別"></a>day03基本型別</h3><p>有六種基本型別</p>
<ul>
<li>string</li>
<li>number</li>
<li>boolean</li>
<li>null</li>
<li>undefined</li>
<li>object</li>
</ul>
<p>物件的宣告方式為兩種</p>
<p>物件宣告第一種</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//物件宣告第一種</span></span><br><span class="line"><span class="keyword">var</span> myObj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myObj.<span class="property">name</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myObj.<span class="property">age</span>)</span><br></pre></td></tr></table></figure>

<p>物件宣告第二種</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> curObj= <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">curObj.<span class="property">name</span>=<span class="string">&quot;456&quot;</span>;</span><br><span class="line">curObj.<span class="property">age</span>=<span class="number">28</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(curObj.<span class="property">name</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(curObj.<span class="property">age</span>)</span><br></pre></td></tr></table></figure>

<p>物件就像是一個群集，包含了資料跟處理資料的方法，他可能長成這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> introduction=&#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&#x27;Jim&#x27;</span>,</span><br><span class="line">    <span class="attr">favFood</span>:<span class="string">&#x27;Sushi&#x27;</span>,</span><br><span class="line">    <span class="attr">breakIce</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hello I am <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>,My favFood is <span class="subst">$&#123;<span class="variable language_">this</span>.favFood&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">introduction.<span class="title function_">breakIce</span>();</span><br></pre></td></tr></table></figure>

<p>我們有了一個績件後如何呼叫與存取有兩種方式為特性存取<strong>property access</strong>與鍵值存取<strong>key access</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> firstName = <span class="string">&#x27;Hu&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> ages = &#123;</span><br><span class="line">    <span class="title class_">FirstName</span>: <span class="string">&#x27;Hu&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;firstName&#x27;</span>: <span class="string">&#x27;Hu&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Hu Jim&#x27;</span>: <span class="number">28</span>,</span><br><span class="line">    <span class="string">&#x27;Hu Koa&#x27;</span>: <span class="number">60</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//特性存取(property access)</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ages.<span class="property">FirstName</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ages.<span class="property">firstName</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//鍵值存取(key access)</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ages[firstName + <span class="string">&#x27; Jim&#x27;</span>]);</span><br><span class="line"><span class="comment">//加入一個新的</span></span><br><span class="line">ages[firstName + <span class="string">&#x27; Ge&#x27;</span>] = <span class="number">30</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ages);</span><br></pre></td></tr></table></figure>

<p>物件的複製</p>
<p>Shallow Clone</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> firstName = <span class="string">&#x27;Hu&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ages = &#123;</span><br><span class="line">    <span class="string">&#x27;Hu Jim&#x27;</span>: <span class="number">28</span>,</span><br><span class="line">    <span class="string">&#x27;Hu Koa&#x27;</span>: <span class="number">60</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Shallow Clone</span></span><br><span class="line"><span class="keyword">var</span> agesNextYear = ages;</span><br><span class="line">agesNextYear[firstName + <span class="string">&#x27; Jim&#x27;</span>] = <span class="number">29</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Shallow Clone ages:&#x27;</span> + ages[firstName + <span class="string">&#x27; Jim&#x27;</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Shallow Clone agesNextYear&#x27;</span> + agesNextYear[firstName + <span class="string">&#x27; Jim&#x27;</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Deep Clone</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Deep Clone</span></span><br><span class="line"><span class="keyword">var</span> firstName = <span class="string">&#x27;Hu&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ages = &#123;</span><br><span class="line">    <span class="string">&#x27;Hu Jim&#x27;</span>: <span class="number">28</span>,</span><br><span class="line">    <span class="string">&#x27;Hu Koa&#x27;</span>: <span class="number">60</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> agesNextYear= <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;,ages);</span><br><span class="line">agesNextYear[firstName + <span class="string">&#x27; Jim&#x27;</span>] = <span class="number">29</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Deep Clone ages:&#x27;</span> + ages[firstName + <span class="string">&#x27; Jim&#x27;</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Deep Clone agesNextYear&#x27;</span> + agesNextYear[firstName + <span class="string">&#x27; Jim&#x27;</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="day04-callback相關"><a href="#day04-callback相關" class="headerlink" title="day04 callback相關"></a>day04 callback相關</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">example</span>(<span class="params">msg, callback</span>) &#123;</span><br><span class="line">    <span class="title function_">callback</span>(msg)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">example</span>(<span class="string">&#x27;hello callback&#x27;</span>, <span class="keyword">function</span> (<span class="params">sayHi</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sayHi)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//結果 hello callback</span></span><br></pre></td></tr></table></figure>

<p>什麼是callback,專有名詞來說就是一種高階函式的用法，可以把函式當作變數傳遞，當然函數也可以返回函數，而這樣做我們可以在需要的時候再去使用它或者解決非同步阻塞的問題。在處理陣列時我們也使用同樣的方法來處理我們的陣列資料。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> total = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="keyword">var</span> res = total.<span class="title function_">reduce</span>(<span class="function">(<span class="params">initvalue, nextitem</span>) =&gt;</span> &#123;</span><br><span class="line">    initvalue += nextitem</span><br><span class="line">    <span class="keyword">return</span> initvalue;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line"><span class="comment">// 結果 15</span></span><br></pre></td></tr></table></figure>

<p>在撰寫邏輯上，我們可以直接的方式撰寫，變很快速理解，但直正使用的理由是，當我們事件與服務要求次數變多，要達到不阻塞I&#x2F;O或多緒執行的 益時，更需要思考我們撰寫程式的邏輯與方式並非單純直覺的以單線作為考量</p>
<h3 id="day05-API"><a href="#day05-API" class="headerlink" title="day05 API"></a>day05 API</h3><p>當我們做一個會員登人系統，接到API後，拿到一個像這樣子的一筆JSON資料</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$.<span class="title function_">get</span>(<span class="string">&#x27;https://randomuser.me/api/&#x27;</span>,<span class="keyword">function</span>(<span class="params">result</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(result)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hu&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jim&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;streetAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;21 2nd Street&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;New York&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NY&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;postalCode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10021&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;phoneNumber&quot;</span><span class="punctuation">:</span> </span><br><span class="line">    <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;home&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;212 555-1234&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fax&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;646 555-4567&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>什麼又是JSON</p>
<p>通常我們會拿到一個物件或陣列格式，包含物件或陣列的資料。這樣的結構我們稱為JSON</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;results&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;firstCol1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;firstCol2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;firstCol3&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;firstCol4&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;firstCol5&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span><span class="attr">&quot;SecCol1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span><span class="attr">&quot;SecCol2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span><span class="attr">&quot;SecCol3&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span><span class="attr">&quot;SecCol4&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span> </span><br><span class="line">  <span class="punctuation">]</span>     </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>看起來是物件或陣列，但在網路上傳遞資料的方式，是以字串的方式去處理的，所以我們必須使用<strong>JSON.stringify</strong>轉成字串或<strong>JSON.parse</strong>去轉回物件或陣列。</p>
<p>再往回看一點點，我們到底在程式上要如何去接一個 API，可以使用 JS 原生的功能或者用套件，針對接 API 功能去處理，這裡提供五個例子，包含原始 XMLHttpRequest、jQuery、axios、superAgent、fetch。</p>
<p><a href="https://codepen.io/JimHu1492/pen/JOPNYX">接API的五種方式</a></p>
<h3 id="day06同步和非同步"><a href="#day06同步和非同步" class="headerlink" title="day06同步和非同步"></a>day06同步和非同步</h3><p>當你程式的某部份現在(now)立即執行而另外一部分要在之後(later)執行時，會發生什麼事，在這個now和loater之間有個間隙(gap)存在，期間你的程式並有積極執行</p>
<p>什麼是非同步？非同步包括，網路連線要求之類的I&#x2F;O(例如AJAX，DOM事件處理，動畫流程處理，計時器)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;c&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>我們可以看到執行結果A-&gt;B-&gt;C，但是我們要處理的狀態越來越多，結構越來越雜的時候，callback也許就不夠用山，事件的交錯與不確定資料處理的期間，不斷增加開發中理解與撰寫上的困難，再進一步學習中，處理相關的問題Promise是其中一個選項</p>
<h3 id="day07多判斷switch-case"><a href="#day07多判斷switch-case" class="headerlink" title="day07多判斷switch case"></a>day07多判斷switch case</h3><p>當我們需要多個判斷的時候，使用swith case的小細節</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fruit = <span class="string">&#x27;apple&#x27;</span>;</span><br><span class="line"><span class="keyword">switch</span> (fruit) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;banana&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;It is a banana&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;peach&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;It is a peach&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;apple&#x27;</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;It is a apple&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;I don\&#x27;t know what is it&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在switch case中如果要中斷，要加入<strong>break</strong>這關鍵字不然會一直執行下去。</p>
<h3 id="day08-ES6常用語法"><a href="#day08-ES6常用語法" class="headerlink" title="day08 ES6常用語法"></a>day08 ES6常用語法</h3><p>ES6它的全名是ECMAScript6。便是我們所學的JS的語言核心。從第五版ES5到第六版ES6日漸普遍，而ES7也蓄勢待發</p>
<ol>
<li><p>解構賦值</p>
<p>說明:我們可以將一個陣列以<strong>…</strong>的形式，一次展開或者一次打包起來</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="comment">//展開</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(...arr);</span><br><span class="line"><span class="comment">//結果 1 2 3 4 5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showArr</span>(<span class="params">num1, num2, ...num3</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(num1);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(num2);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(num3);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//打包</span></span><br><span class="line"><span class="title function_">showArr</span>(...arr);</span><br><span class="line"><span class="comment">//結果 </span></span><br><span class="line"><span class="comment">// 1 </span></span><br><span class="line"><span class="comment">// 2 </span></span><br><span class="line"><span class="comment">// [ 3, 4, 5 ]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>模板字變量和多行字符串</p>
<p>說明:可以在``(注意此為鍵盤左上方``符號非’’單引號)之間包含字串，邺以＄{}包𨭎變數，甚至換行也可以。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayMyName</span>(<span class="params">firstName, lastName</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hollo My Name</span></span><br><span class="line"><span class="string">    is <span class="subst">$&#123;firstName&#125;</span> <span class="subst">$&#123;lastName&#125;</span></span></span><br><span class="line"><span class="string">    `</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">sayMyName</span>(<span class="string">&quot;tom&quot;</span>, <span class="string">&quot;tang&quot;</span>);</span><br><span class="line"><span class="comment">//結果 Hollo My Name </span></span><br><span class="line"><span class="comment">//    is tom tang </span></span><br></pre></td></tr></table></figure>
</li>
<li><p>箭頭函數</p>
<p>說明:寫法(引數)&#x3D;&gt;{函式內容}</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> res=arr.<span class="title function_">reduce</span>(<span class="function">(<span class="params">total,items</span>)=&gt;</span>&#123;</span><br><span class="line">    total +=items;</span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line"><span class="comment">//結果 15 </span></span><br></pre></td></tr></table></figure>
</li>
<li><p>let 宣告</p>
<p>說明:JS本來是以function去分辨解析變名稱所使用的範圍，意思是在一各物綿內具有一個或往更上層找或是全域等等，也就是大家常說的scope，有別於其他語言可能以大括號**{}<strong>作為範圍的選擇，所以當使用var在物件宣告的時候，一樣會變宣告成往上找到最上層fucnton的範圍。而如果使用let，更會改以</strong>{}**去判斷scope</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> test =<span class="string">&quot;test&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(test==<span class="string">&quot;test&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> num5=<span class="number">10</span>;</span><br><span class="line">    <span class="keyword">let</span> num6=<span class="number">20</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(num5);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(num6);</span><br><span class="line"><span class="comment">//結果 10</span></span><br><span class="line"><span class="comment">// num6 is not defined </span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>5.預設參數</p>
<p>  說明:一般來 說來如果引數與對應的參數不符合時，就會出錯。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">num1=<span class="number">1</span></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> num1+num2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">add</span>(<span class="number">10</span>);</span><br><span class="line"><span class="comment">//結果 num2 is not defined </span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">num1=<span class="number">1</span>,num2=<span class="number">1</span></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> num1+num2;</span><br><span class="line">&#125;</span><br><span class="line">res=<span class="title function_">add</span>(<span class="number">10</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line"><span class="comment">//結果 11</span></span><br></pre></td></tr></table></figure>

<p>其它還未使用到的:</p>
<p>Module的import export功能、OOP的class寫法</p>
<p>補充:</p>
<p>當我們所使用的語法。瀏覽器可能過舊或不支援，本身無法被解析的時候，我們便需要使用polyfill，便是那麼一段程式碼，好讓新的語法也能解析。而事實上自已也可以針對語法的格式去寫出要的功能，但你必須對語言背後的行為邏輯有正確的理解</p>
<h3 id="day09閉包Closure"><a href="#day09閉包Closure" class="headerlink" title="day09閉包Closure"></a>day09閉包Closure</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">saveMoney</span>(<span class="params">newSaving = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> myAccount = <span class="number">20000</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> myAccount + newSaving;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">total = <span class="title function_">saveMoney</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">total</span>());</span><br><span class="line"><span class="comment">//結果 21000</span></span><br></pre></td></tr></table></figure>

<p>第一次看到這個寫法覺得很𫋵奇，卻不知道它就是所謂鼎鼎大名的閉包(Closure)</p>
<p>什麼是閉包?看code，是由兩個函式搆成的而且互為表裡。</p>
<p>JS用function去界定變數名稱的作用範圍，當我們它一固函式用另一個函式包起來，便會形成一個封閉的空間，而裡面的變數名稱，也只在範圍內可以使用，我們稱無private變數。使用它來達到隱藏資訊的效果。</p>
<p>再看一個累加的例子</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">accumulation</span>(<span class="params"><span class="built_in">number</span>=<span class="number">0</span></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">number</span>++);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> total= <span class="title function_">accumulation</span>();</span><br><span class="line"><span class="title function_">total</span>();</span><br><span class="line"><span class="title function_">total</span>();</span><br><span class="line"><span class="title function_">total</span>();</span><br><span class="line"><span class="comment">//結果</span></span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2 </span></span><br></pre></td></tr></table></figure>

<p>為什麼number會一直累加上去，而因為每次執行而開始重新計算，這更是閉包達到的效果。藉由雙層函式的架構將number變數存在記憶體當中，並藉由accumulation去執行裡面的匿名函式去改變值。</p>
<p>閉包博大精深，網路上有很多不同的資訊，但基本的function產生作用域用雙層function去達到封閉作用空間，是我對閉包基本認知。</p>
<h3 id="day10強制轉型"><a href="#day10強制轉型" class="headerlink" title="day10強制轉型"></a>day10強制轉型</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">conditionA = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (conditionA) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//無結果</span></span><br><span class="line">conditionB = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (conditionB) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//結果 hello</span></span><br></pre></td></tr></table></figure>

<p>在修件判斷中，為什麼conditionA為什麼不會通過條件判斷？</p>
<p>在條件判斷中，我們需要得到一個true或false才能去判斷接下來要不要執行𧟕面的程式，但如果裡面不是一個單純的比較，是一個物件或者其他東西會發生什麼事情？</p>
<p>從JS的強制轉型搆起，看以下程式碼</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a=<span class="number">42</span>;</span><br><span class="line"><span class="keyword">var</span> b=a+<span class="string">&quot;&quot;</span>;<span class="comment">//隱含的強制轉型</span></span><br><span class="line"><span class="keyword">var</span> c= <span class="title class_">String</span>(a);<span class="comment">//明確的強制轉型</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c);</span><br><span class="line"><span class="comment">//42 ​​​​​at ​​​b​​​ </span></span><br><span class="line"><span class="comment">//42 ​​​​​at ​​​c​​​</span></span><br></pre></td></tr></table></figure>

<p>當我們的操作不符合正常狀況時，JS語言會幫我們進一步處理。回到我們條件判斷，我們應該給予一個Boolean值或一個得出Boolean值的比較，但如果是其他的東西，JS會幫我們進行強制轉型而要變為Boolean的true或fals就是用所謂的Truthy值或Falsy值去判斷。那我們現在給的東西是哪一種值呢？</p>
<p>其㲒可以很簡單，除了以下Falsy的，都是Truthy</p>
<ul>
<li><p>undefined</p>
</li>
<li><p>null</p>
</li>
<li><p>false</p>
</li>
<li><p>+0、-0 以及NaN</p>
</li>
<li><p>“”</p>
</li>
</ul>
<p>最上面的例子，其實常常用在判斷是否為空值時的判斷，我們也可以寫成以下，去判斷資料是否為空。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">conditionA = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!conditionA) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;目前沒有值&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 結果 </span></span><br><span class="line"><span class="comment">//目前沒有值 ​​​​​</span></span><br></pre></td></tr></table></figure>

<p>另外使用三元運算式將我們原本的程式改寫成更簡潔的狀態。</p>
<blockquote>
<p>語法：</p>
<p>判斷式?如果符合:如果不符合</p>
</blockquote>
<p>以下改寫</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">conditionA=<span class="string">&quot;&quot;</span>;</span><br><span class="line">!conditionA ? <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;目前沒有值&quot;</span>):<span class="variable language_">console</span>.<span class="title function_">log</span>(conditionA);</span><br><span class="line"><span class="comment">//結果 目前沒有值</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">conditionA=<span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">!conditionA ? <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;目前沒有值&quot;</span>):<span class="variable language_">console</span>.<span class="title function_">log</span>(conditionA);</span><br><span class="line"><span class="comment">//結果 Hello</span></span><br></pre></td></tr></table></figure>

<h3 id="day11鏈式函式"><a href="#day11鏈式函式" class="headerlink" title="day11鏈式函式"></a>day11鏈式函式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> $ = <span class="keyword">function</span> (<span class="params">Person</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">breakTheIce</span>: <span class="keyword">function</span> (<span class="params">message</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(message + <span class="string">&quot; My name is &quot;</span> + <span class="title class_">Person</span>.<span class="property">name</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">introduce</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;I&#x27;m a &quot;</span> + <span class="title class_">Person</span>.<span class="property">intro</span> + <span class="string">&quot; Do you want to program with me?&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Jim</span> = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;Jim Hu&quot;</span>,</span><br><span class="line">    <span class="attr">intro</span>: <span class="string">&quot;Programmer!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">$(<span class="title class_">Jim</span>).<span class="title function_">breakTheIce</span>(<span class="string">&quot;Hi&quot;</span>).<span class="title function_">introduce</span>();</span><br></pre></td></tr></table></figure>

<h3 id="day12修改網頁背景"><a href="#day12修改網頁背景" class="headerlink" title="day12修改網頁背景"></a>day12修改網頁背景</h3><p>把 google 首頁背景變成黃色的三種方式。</p>
<ol>
<li>利用開發者模式功能</li>
</ol>
<blockquote>
<p>在開法者模式下選擇 HTML tag <body></body>的部分，<br>然後在後面style欄位填上 background: yellow</p>
</blockquote>
<ol start="2">
<li>利用 JS 原生語法</li>
</ol>
<blockquote>
<p>利用 JavaScript 原生語法， getElementsByTagName 抓到<br>body 選項，再加上 style 改變顏色</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;body&quot;</span>);</span><br><span class="line">x[<span class="number">0</span>].<span class="property">style</span>.<span class="property">background</span> = <span class="string">&#x27;yellow&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>利用 jQuery 函式庫</li>
</ol>
<blockquote>
<p>先創建一個包含引入函式庫的 <script></script> 標籤，再來抓取 <head><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head> 標頭，將標籤附加上去。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> el = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">el.<span class="property">src</span> = <span class="string">&quot;https://code.jquery.com/jquery-3.2.1.js&quot;</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;head&#x27;</span>)[<span class="number">0</span>].<span class="title function_">appendChild</span>(el);</span><br><span class="line"></span><br><span class="line"><span class="comment">//jQuery語法</span></span><br><span class="line">$(<span class="string">&quot;body&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;background-color&quot;</span>, <span class="string">&quot;yellow&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="day13網頁重繪的流程"><a href="#day13網頁重繪的流程" class="headerlink" title="day13網頁重繪的流程"></a>day13網頁重繪的流程</h3><p>要如何決定今天我們要製作一個移動的動畫，要用 translate 還是去改變 position 呢？<br>那我們就要了解一下重排（reflow）跟重繪（repaint）</p>
<p>五個步驟：</p>
<ol>
<li>HTML 轉換成 DOM</li>
<li>CSS 轉換成 CSSOM</li>
<li>將兩個東西結合，生成一刻渲染樹 （包含每個節點的視覺訊息）</li>
<li>生成佈局（layout），即將所有渲染入的節點進行平面合成</li>
<li>將佈局繪製（paint）在平面上</li>
</ol>
<p>而大致上網頁的變動都不斷在重複 4. 跟 5. 的動作，而效能選擇上的差異便在降低這兩項事情的發生。</p>
<p>需要重排跟重繪的狀況分為</p>
<ol>
<li>修改DOM</li>
<li>修改樣式表</li>
<li>觸發事件</li>
</ol>
<p>避免重新渲染，我們可以看看 CSStrigger 這個網站對於 transform 跟 position 的差異。就可以知道哪個選擇上比較合適。</p>
<p>參考資料：<br><a href="http://www.ruanyifeng.com/blog/2015/09/web-page-performance-in-depth.html">阮一峰的网络日志</a><br><a href="https://csstriggers.com/">CSStrigger</a></p>
<h3 id="day14網頁事件"><a href="#day14網頁事件" class="headerlink" title="day14網頁事件"></a>day14網頁事件</h3><p>事件表</p>
<table>
<thead>
<tr>
<th align="center">事件</th>
<th align="center">行為</th>
<th align="center">例子</th>
</tr>
</thead>
<tbody><tr>
<td align="center">onchange</td>
<td align="center">當元素改變</td>
<td align="center">selector</td>
</tr>
<tr>
<td align="center">onclick</td>
<td align="center">當點下 HTML 元素</td>
<td align="center">點擊後送出資料或選擇該元素</td>
</tr>
<tr>
<td align="center">onmouseover</td>
<td align="center">當滑鼠通過 HTML 元素</td>
<td align="center">提示效果，通常會搭配 onclick</td>
</tr>
<tr>
<td align="center">onmouseout</td>
<td align="center">當滑鼠離開 HTML 元素</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">onkeydown</td>
<td align="center">當按下鍵盤</td>
<td align="center">抓取值顯示</td>
</tr>
<tr>
<td align="center">onload</td>
<td align="center">當瀏覽器載入頁面時後</td>
<td align="center">串接 API 更改資料列</td>
</tr>
</tbody></table>
<p>其實寫法很簡單，都是在 tag 裡面<br>加上你要執行的 function 名稱</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;element event=&#x27;some JavaScript&#x27;&gt;</span><br></pre></td></tr></table></figure>

<p>在例子中我們通常很難感受到效果，直到實際去操作。而 W3School 提供很多有趣的例子跟實驗平台，可以快速地以實踐為學習。推薦一開始從此下手。<br><a href="https://www.w3schools.com/js/js_events_examples.asp">學習連結</a></p>
<h3 id="day16亂數的取法"><a href="#day16亂數的取法" class="headerlink" title="day16亂數的取法"></a>day16亂數的取法</h3><p>思考：</p>
<p>如何取40~80間(不包含80)的亂數</p>
<p>我們用Math.random()的語法，可以得到一個0~1之間穴包含1的亂數</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> res=<span class="title class_">Math</span>.<span class="title function_">random</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line"><span class="comment">//0.8273783802602397</span></span><br></pre></td></tr></table></figure>

<p>取亂數的方法:</p>
<ol>
<li><p>將Math.random結果換算成取1～*並去掉小數點</p>
</li>
<li><p>用取餘數得到想要的亂數範圍</p>
</li>
<li><p>如果不是從0開始，加上要從多少開始數字</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> res = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">100</span>) % <span class="number">40</span> + <span class="number">40</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br></pre></td></tr></table></figure>

<p>逐一拆解便為</p>
<ol>
<li>Math.random()*100 &#x2F;&#x2F;可取0～99之間的數字</li>
<li>Math.floor(Math.random()*100) &#x2F;&#x2F;去掉小數點</li>
<li>Math.floor(Math.random()*100)%40 &#x2F;&#x2F;可取0～39之間的餘數</li>
<li>Math.floor(Math.random()*100)%40+40&#x2F;&#x2F;可霰40～79之間的餘數</li>
</ol>
<h3 id="day17畫圓"><a href="#day17畫圓" class="headerlink" title="day17畫圓"></a>day17畫圓</h3><p><a href="https://stackblitz.com/edit/js-nrw4zh?file=index.js">stackblitz</a><br>用Canvas畫圓，並做成一個簡單的小動畫，想要畫的圓是同心圓，並搭配Fibonacci數列，讓圓圈大小更自然的變化, 在HTML的碼 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;canvas&quot;</span> <span class="attr">width</span>=<span class="string">&quot;1000px&quot;</span> <span class="attr">height</span>=<span class="string">&quot;1000px&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>畫同心圓</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import stylesheets</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"><span class="comment">// 畫圓功能</span></span><br><span class="line"><span class="keyword">var</span> circle= <span class="keyword">function</span> (<span class="params">x, y, radius</span>) &#123;</span><br><span class="line">   ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">   ctx.<span class="title function_">arc</span>(x, y, radius, <span class="number">0</span>, <span class="number">2</span>*<span class="title class_">Math</span>.<span class="property">PI</span>, <span class="literal">false</span>);</span><br><span class="line">   ctx.<span class="title function_">stroke</span>();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Write Javascript code!</span></span><br><span class="line"><span class="keyword">const</span> appDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>);</span><br><span class="line"><span class="comment">//appDiv.innerHTML = `&lt;h1&gt;JS Starter&lt;/h1&gt;`;</span></span><br><span class="line"><span class="keyword">let</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;canvas&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line">ctx.<span class="property">lineWidth</span> = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&quot;Red&quot;</span>;</span><br><span class="line"><span class="title function_">circle</span>(<span class="number">200</span>,<span class="number">150</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&quot;orange&quot;</span>;</span><br><span class="line"><span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&quot;yellow&quot;</span>;</span><br><span class="line"><span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&quot;Green&quot;</span>;</span><br><span class="line"><span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&quot;Blue&quot;</span>;</span><br><span class="line"><span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, <span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&quot;Purple&quot;</span>;</span><br><span class="line"><span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, <span class="number">130</span>);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>用for loop 優化程式</p>
<p>因為位置是重複的，所以可以試著把同樣的東西，用陣列與迴圈整理出來</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import stylesheets</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"><span class="comment">// Write Javascript code!</span></span><br><span class="line"><span class="keyword">const</span> appDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>);</span><br><span class="line"><span class="comment">// 畫圓功能</span></span><br><span class="line"><span class="keyword">var</span> circle= <span class="keyword">function</span> (<span class="params">x, y, radius</span>) &#123;</span><br><span class="line">   ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">   ctx.<span class="title function_">arc</span>(x, y, radius, <span class="number">0</span>, <span class="number">2</span>*<span class="title class_">Math</span>.<span class="property">PI</span>, <span class="literal">false</span>);</span><br><span class="line">   ctx.<span class="title function_">stroke</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;canvas&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line">ctx.<span class="property">lineWidth</span> = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> styles = [<span class="string">&quot;Red&quot;</span>,<span class="string">&quot;orange&quot;</span>,<span class="string">&quot;yellow&quot;</span>,<span class="string">&quot;Green&quot;</span>,<span class="string">&quot;Blue&quot;</span>,<span class="string">&quot;Purple&quot;</span>,<span class="string">&quot;Gray&quot;</span>]</span><br><span class="line"><span class="keyword">let</span> size = [<span class="number">10</span>,<span class="number">20</span>,<span class="number">30</span>,<span class="number">50</span>,<span class="number">80</span>,<span class="number">130</span>,<span class="number">210</span>]</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">    ctx.<span class="property">strokeStyle</span> = styles[i];</span><br><span class="line">    <span class="title function_">circle</span>(<span class="number">200</span>,<span class="number">150</span>,size[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>用setInterval反覆畫圖，將其變成動畫</p>
<p>因為是動態的，所以不會一開始就色所有的線都畫出來，並且會一直執行畫線的動作，所以利用setInterval並改變半徑大小畫出不同的圓</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import stylesheets</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"><span class="comment">// Write Javascript code!</span></span><br><span class="line"><span class="keyword">const</span> appDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>);</span><br><span class="line"><span class="comment">// 畫圓功能</span></span><br><span class="line"><span class="keyword">var</span> circle= <span class="keyword">function</span> (<span class="params">x, y, radius</span>) &#123;</span><br><span class="line">   ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">   ctx.<span class="title function_">arc</span>(x, y, radius, <span class="number">0</span>, <span class="number">2</span>*<span class="title class_">Math</span>.<span class="property">PI</span>, <span class="literal">false</span>);</span><br><span class="line">   ctx.<span class="title function_">stroke</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;canvas&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line">ctx.<span class="property">lineWidth</span> = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> styles = [<span class="string">&quot;Red&quot;</span>, <span class="string">&quot;orange&quot;</span>,<span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;Green&quot;</span>, <span class="string">&quot;Blue&quot;</span>, <span class="string">&quot;Purple&quot;</span>, <span class="string">&quot;Gray&quot;</span>];</span><br><span class="line"><span class="keyword">let</span> size = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">50</span>, <span class="number">80</span>, <span class="number">130</span>, <span class="number">210</span>];</span><br><span class="line"><span class="keyword">let</span> styleClear = <span class="string">&quot;white&quot;</span></span><br><span class="line"><span class="keyword">let</span> i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  ctx.<span class="property">lineWidth</span> = <span class="number">4</span>;</span><br><span class="line">  ctx.<span class="property">strokeStyle</span> = styles[i];</span><br><span class="line">  <span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, size[i]);</span><br><span class="line">  ctx.<span class="property">lineWidth</span> = <span class="number">5</span>;</span><br><span class="line">  ctx.<span class="property">strokeStyle</span> = styleClear;</span><br><span class="line">  <span class="title function_">circle</span>(<span class="number">200</span>, <span class="number">150</span>, size[i-<span class="number">3</span>]); </span><br><span class="line">  </span><br><span class="line">  i += <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( i &gt; <span class="number">9</span> ) &#123;</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="day18錯誤處理"><a href="#day18錯誤處理" class="headerlink" title="day18錯誤處理"></a>day18錯誤處理</h3><p>通常錯誤處理的格式為try,catch,throw.</p>
<p>一個字典查詢的功能，這裡用一個陣列來看看如何處理錯誤。當我們有找到值的時候，會回傳這個值，如果沒有就會進行錯誤處理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkDictionary</span>(<span class="params">key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> words = &#123;</span><br><span class="line">        <span class="string">&#x27;apple&#x27;</span>: <span class="string">&quot;蘋果&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;banana&#x27;</span>: <span class="string">&quot;香蕉&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;peach&#x27;</span>: <span class="string">&quot;桃子&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (words[key]) &#123;</span><br><span class="line">        <span class="keyword">return</span> words[key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>if(words[key]) 的寫法我們從if(wordd[key] !&#x3D; null) 簡化而來，因為null是falsy物件，所以當沒有值時結果會與判斷式寫法相等。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> res = <span class="title function_">checkDictionary</span>(<span class="string">&quot;apple&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;We don\&#x27;t know this world: &quot;</span> + e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//蘋果</span></span><br></pre></td></tr></table></figure>

<p>用try去執行一個function並在裡面加入流程控制，除了正常的功能外，如有錯誤也用throw指令，直接跳往catch進行進一步的處理，傳遞參數可以是任何型態 ，由catch去接收。而當在try中直接發生錯誤或我們沒有使用throw時，發生錯誤<em>不會執行catch裡的功能</em>，所以我們可能無法掌握錯誤的中斷之處。</p>
<blockquote>
<p><strong>所以有try catch的語句一定記得要有throw</strong></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkDictionary</span>(<span class="params">key</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> words = &#123;</span><br><span class="line">        <span class="string">&#x27;apple&#x27;</span>: <span class="string">&quot;蘋果&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;banana&#x27;</span>: <span class="string">&quot;香蕉&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;peach&#x27;</span>: <span class="string">&quot;桃子&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (words[key]) &#123;</span><br><span class="line">        <span class="keyword">return</span> words[key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> key; <span class="comment">//有try catch 一定要有 不然會undefie</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> res = <span class="title function_">checkDictionary</span>(<span class="string">&quot;mongo&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;We don\&#x27;t know this world: &quot;</span> + e);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="day19-chrome-工具"><a href="#day19-chrome-工具" class="headerlink" title="day19 chrome 工具"></a>day19 chrome 工具</h3><p>在chrome在按下<code>F12</code>按下時，會出現debug的工具，有可以設定的選項。</p>
<p>在Performance的部分可以記錄效能，可以勾選記憶體使用以燭幕擷取的選項，它提供數字，畫面甚至圖表資料，讓我們進一步分析程式效能</p>
<h3 id="day20-時間的精度"><a href="#day20-時間的精度" class="headerlink" title="day20 時間的精度"></a>day20 時間的精度</h3><p>一直以來都以為要用 setTimeout 或 setInterval 來製作動畫，但 setTimeout 最快也只能到 10 毫秒，可能造成畫面遺失的問題，而我們就可以用 requestAnimationFrame 這個方法。 一起來看一下 MicroSoft Developer Network 提供的這個例子，在裡面學到不少東西。</p>
<p>說明：<br>window.performance.now 高精準的時間戳，可以取到一毫秒的千分之一<br>elm.style.left &#x3D; ((lpos +&#x3D; 3) % 600) + “px”; 利用累加方式調整矩形位置，並用餘數值來限定範圍<br>requestId &#x3D; window.requestAFrame(render) 計算 requestAFrame 執行的次數， requestAFrame 的回傳值會從 1 開始持續往上累加</p>
<p><a href="https://stackblitz.com/edit/js-p6cism?file=index.html">stackblitz</a></p>
<p>在<code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;animated&quot;</span>&gt;</span>Hello there.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btnstart&quot;</span> &gt;</span>Start<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;bnstop&quot;</span> &gt;</span>Stop<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import stylesheets</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"><span class="comment">//多瀏覽器的支援</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">cancelAFrame</span> = (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="property">cancelAnimationFrame</span> ||</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">webkitCancelAnimationFrame</span> ||</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">mozCancelAnimationFrame</span> ||</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">oCancelAnimationFrame</span> ||</span><br><span class="line">    <span class="keyword">function</span> (<span class="params">id</span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="built_in">clearTimeout</span>(id);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> requestId = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> startime = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> lpos = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> elm;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;init&quot;</span>);</span><br><span class="line">  elm = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;animated&quot;</span>);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  elm.<span class="property">style</span>.<span class="property">left</span> = ((lpos += <span class="number">3</span>) % <span class="number">600</span>) + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">  requestId = <span class="variable language_">window</span>.<span class="title function_">requestAFrame</span>(render);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">performance</span>.<span class="property">now</span>) &#123;</span><br><span class="line">    startime = <span class="variable language_">window</span>.<span class="property">performance</span>.<span class="title function_">now</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    startime = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  requestId = <span class="variable language_">window</span>.<span class="title function_">requestAFrame</span>(render);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;stop&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (requestId)</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">cancelAFrame</span>(requestId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// handle multiple browsers for requestAnimationFrame()</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">requestAFrame</span> = (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="property">requestAnimationFrame</span> ||</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">webkitRequestAnimationFrame</span> ||</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">mozRequestAnimationFrame</span> ||</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">oRequestAnimationFrame</span> ||</span><br><span class="line">    <span class="comment">// if all else fails, use setTimeout</span></span><br><span class="line">    <span class="keyword">function</span> (<span class="params">callback</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="built_in">setTimeout</span>(callback, <span class="number">1000</span> / <span class="number">60</span>); <span class="comment">// shoot for 60 fps</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;load&quot;</span>, <span class="title function_">init</span>(), <span class="literal">false</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;btnstart&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, start);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;bnstop&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, stop);</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h3 id="day21-DOM"><a href="#day21-DOM" class="headerlink" title="day21 DOM"></a>day21 DOM</h3><p>W3School介紹HTMLDOM時，有一個觀念會被一直強調</p>
<blockquote>
<p>DOM是一個樹狀模型中，所有東西都是結點(node)。所有結點分為ACDET</p>
<ol>
<li>docment根(document)</li>
<li>HTML元素(element)</li>
<li>屬性(attribute)</li>
<li>文字(text)</li>
<li>註解(comment)</li>
</ol>
</blockquote>
<p>當HTML文件被載入瀏覽器的時候，就會產生一個document物件做為根節點。而document物件是所有節點的擁有者，並提供屬性跟方法去操控其它結點。</p>
<p>Elemnt object<br>NodeList object(集合，有序)<br>Att object<br>NamedNodeMap objcet(集合，沒有順序)<br>Style object</p>
<p>思考：<br>Attr Object 和 Style Object 在哪？結果發現自己總是把CSS 調整的 style 跟 HTML 本身的 attribute 搞混。Attribute 是跟 HTML 標籤一起出現的，例如我們使用 placeholder 去提示要輸入的訊息。而屬性分為兩種，content（HTML）跟 IDL (JavaScript)，也可以自定屬性。<a href="https://pjchender.blogspot.tw/2017/01/html-5-data-attribute.html">補充資料。內容為更多屬性介紹，作者：PJ</a></p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes">完整的 attribute 列表</a></p>
<p>說明：<br>當我們開始操控 JS ，我們會使用 document 的方法，去抓取節點。然後用串接（chain）的方式，進行之後動作。下面的例子，我們選取到的不是單一元素，因為有多個 P tag，行程所謂的 Node list ，再藉由 item 去選取到要針對的元素。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.getElementsByTagName(&quot;P&quot;).item(0).innerHTML;</span><br></pre></td></tr></table></figure>

<p>所以排下來的順序大概是這樣的：<br>Document &gt; Element + NodeList &gt; Attr + NamedNodeMap + style + DOM Events &gt; style</p>
<h3 id="day22程式邏輯"><a href="#day22程式邏輯" class="headerlink" title="day22程式邏輯"></a>day22程式邏輯</h3><p>上LeetCode去練習程式邏輯，人家所謂的bug就是思考上的缺陷，有時候𤆧法能解，但是思考角度不對，其實就會在測試中出現問題。</p>
<p>下面的例子是給定一個陣列，真一個目標，找尋是否陣列裡有一對元素，相加等於目標數字。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Given nums = [2,7,11,15] ,target =9,</span><br><span class="line">Because nums[0] + num[1] = 2+7 =9</span><br><span class="line">return [0,1]</span><br></pre></td></tr></table></figure>

<p>在這個例子中，當如果輸入兩個不同數字，結果正確。但如果兩個數字相同，就會出現錯誤。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nums = [<span class="number">3</span>,<span class="number">3</span>]</span><br><span class="line"><span class="keyword">var</span> target = <span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> twoSum = <span class="keyword">function</span>(<span class="params">nums, target</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; target ; i++)</span><br><span class="line">    <span class="keyword">if</span> (nums.<span class="title function_">indexOf</span>(i) + <span class="number">1</span> &amp;&amp; nums.<span class="title function_">indexOf</span>(target - i) + <span class="number">1</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> [nums.<span class="title function_">indexOf</span>(i), nums.<span class="title function_">indexOf</span>(target - i)]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>( i == target - <span class="number">1</span>) &#123;</span><br><span class="line">		  <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Sorry&quot;</span>)</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>而正確的作法應該要用兩個迴圈。以下為pseudocode</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span>[] <span class="title">twoSum</span>(<span class="params"><span class="built_in">int</span>[] nums, <span class="built_in">int</span> target</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = i + <span class="number">1</span>; j &lt; nums.length; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[j] == target - nums[i]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">int</span>[] &#123; i, j &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;No two sum solution&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="day23-Html的ID"><a href="#day23-Html的ID" class="headerlink" title="day23 Html的ID"></a>day23 Html的ID</h3><p>當你在HTML標籤裡宣告ID的時候，其實就同時在JS裡宣告一僤全域變數。</p>
<p>說明：</p>
<p>用不同抓取element的方式(除ID之外)去更改tag裡面的內容，最後用createElement製造一個按鈕，然後用addEventListener去監聽按下的事件來執行。</p>
<p><a href="https://js-uycrnh.stackblitz.io/">stackblitz</a></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>My Friend<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">&quot;lion&quot;</span> &gt;</span>My Class<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h4</span> <span class="attr">id</span>=<span class="string">&quot;king&quot;</span> &gt;</span>My ID<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import stylesheets</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> btn =<span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;button&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;h1&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example2 = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;h2&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example3 = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;lion&quot;</span>);</span><br><span class="line"></span><br><span class="line">btn.<span class="property">innerHTML</span>=<span class="string">&quot;按鈕比大顆&quot;</span>;</span><br><span class="line">btn.<span class="property">style</span>.<span class="property">width</span>=<span class="string">&quot;100px&quot;</span>;</span><br><span class="line">btn.<span class="property">style</span>.<span class="property">height</span>=<span class="string">&quot;100px&quot;</span>;</span><br><span class="line">btn.<span class="property">style</span>.<span class="property">background</span>=<span class="string">&quot;yellow&quot;</span>;</span><br><span class="line">btn.<span class="property">style</span>.<span class="property">fontSize</span>=<span class="string">&quot;25px&quot;</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(btn);</span><br><span class="line"></span><br><span class="line">btn.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>,<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">  example[<span class="number">0</span>].<span class="property">innerHTML</span>=<span class="string">&quot;Ha Ha&quot;</span>;</span><br><span class="line">  example2[<span class="number">0</span>].<span class="property">innerHTML</span>=<span class="string">&quot;My My&quot;</span>;</span><br><span class="line">  example3[<span class="number">0</span>].<span class="property">innerHTML</span>=<span class="string">&quot;Hi Hi&quot;</span>;</span><br><span class="line">  <span class="comment">//殺出一個程咬金</span></span><br><span class="line">  king.<span class="property">innerHTML</span> =<span class="string">&quot;Bye Bye&quot;</span>;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到最後一行，其實是直接用&#x3D;&#x3D;ID名稱&#x3D;&#x3D;，沒有getElementById,去串接innerHTML屬性來指派值，卻成功了</p>
<h3 id="day24-html屬性"><a href="#day24-html屬性" class="headerlink" title="day24 html屬性"></a>day24 html屬性</h3><p>釐清一下HTML屬性與JS的關系，如何去叫用HTML裡面的屬性。我們可以把每個HTML tag 想成是一個物件，擁有自已的屬性，並且以element.propertyName的方式叫用。</p>
<p><a href="https://stackblitz.com/edit/js-fz2pzb?file=index.js">stackblitz</a><br>以下例子，去判斷屬性名稱為特定姓名的話，將placeholder裡面的值修改<code>html</code>檔</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;json&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Jason&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;一&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;json&quot;</span> <span class="attr">name</span>=<span class="string">&quot;John&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;二&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;json&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Peter&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;三&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;json&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Jim&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;四&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">&quot;json&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Amy&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;五&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;changePlaceholder&quot;</span>&gt;</span>Action<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>js</code>的cdoe</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;changePlaceholder&quot;</span>)[<span class="number">0</span>].<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;INPUT&quot;</span>).<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">node</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">name</span> == <span class="string">&#x27;Jim&#x27;</span>) &#123;</span><br><span class="line">      node.<span class="property">placehlder</span> = <span class="string">&#x27;Jim&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是在HTML裡面他不是一個真實的物件，不是你自已加上名稱就會擁有，所以當我們要自訂屬緎的時候，必須符合它的規則。把資料屬緎在HTML tag裡寫成data-protertyName,並在JS中用element.dataset.propertyName取值</p>
<p>說明：</p>
<p>自訂一個屬性，當按下按金，秀出屬性內容</p>
<p>在<code>html</code>的cdoe</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">data-hint</span>=<span class="string">&quot;insert Data&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Json&quot;</span>&gt;</span>My data<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;showData&quot;</span>&gt;</span>Action<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在jscode</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;showData&quot;</span>)[<span class="number">0</span>].<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> myData = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;H1&quot;</span>)[<span class="number">0</span>].<span class="property">dataset</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(myData);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="day25-抓取輸入"><a href="#day25-抓取輸入" class="headerlink" title="day25 抓取輸入"></a>day25 抓取輸入</h3><p>當熟悉抓element裡面的值之後，就可以把輸入振解成“監聽事件”觸發加上“抓取值”。input就是一個盒子，當事事件觸發的時候，動手去拿裡面的東西。然後清空裡 的東西，才不會盒子看起來髒髒的。</p>
<p><a href="https://stackblitz.com/edit/js-s7frt5?file=index.js">stackblitz</a></p>
<p>說明：<br>最簡易的用兩個HTML tag，包括input與button(甚至只用一個input, 按enter觸發，但記得考慮手機可能會不方便觸發輸入)</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>有沒有頻果的產品<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;現在搜尋&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;showData&quot;</span>&gt;</span>Action<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>說明:<br>input的初始設定placeholder是靠左，且字是與邊框貼齊的，所以我們會使用text-align與padding去調整文字位置與空出邊空的距離。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">insert&#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">padding-right</span>: <span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">15px</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: right;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>說明:</p>
<p>這裡用一個array來暫時記錄apple產品包含的資料，實際資料也可以是接api的資料庫、瀏覽器的localstrage或cookie。於是當我們輸入的時候，用includes去搜尋陣列，回傳true or false，來判斷是否有這個值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> apples = [<span class="string">&#x27;手機&#x27;</span>, <span class="string">&#x27;電腦&#x27;</span>, <span class="string">&#x27;滑鼠&#x27;</span>, <span class="string">&#x27;支付&#x27;</span>, <span class="string">&#x27;電視&#x27;</span>, <span class="string">&#x27;音響&#x27;</span>];</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;showData&quot;</span>)[<span class="number">0</span>].<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> insert = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;insert&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">var</span> result = apples.<span class="title function_">includes</span>(insert.<span class="property">value</span>);</span><br><span class="line">  <span class="keyword">if</span> (result) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;有喔有喔&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;等你發明&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  insert.<span class="property">value</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="day26置換class網頁效能的方法一"><a href="#day26置換class網頁效能的方法一" class="headerlink" title="day26置換class網頁效能的方法一"></a>day26置換class網頁效能的方法一</h3><p>提高網頁效能的方法一用JS置換class。<br>我們做一個checkbox，可以使用加上class的方式，來呈現checked效果。</p>
<p><a href="https://js-rzamqo.stackblitz.io/">stackblitz</a></p>
<p>說明：<br>我們用sprite的方式，來切換”部分”背景圖片，製造圖片切換的效果。而不需要重新載入一個圖片進行切換。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>戳我戳我<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sampleClass&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.sampleClass</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>:<span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">330px</span>;</span><br><span class="line">  <span class="attribute">background</span>:<span class="built_in">url</span>(<span class="string">&#x27;https://image.freepik.com/free-vector/check-and-cross-signs-paint-design_1102-228.jpg&#x27;</span>) no-repeat;</span><br><span class="line">  <span class="attribute">background-position</span>: <span class="number">100%</span> <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">background-size</span>:cover;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.active</span>&#123;</span><br><span class="line">   <span class="attribute">background-position</span>: <span class="number">0%</span> <span class="number">50%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>說明：<br>使用className這個屬性，抓出元素的class名稱字串，再去針對字串處理加減class來達到效果。而下面的程式碼用includes去判斷是否是checked的狀態，也就是有加上active的class，如果有就切換回原本的名稱，如果沒有就加上active。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> checkBar = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;div&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">checkBar.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//console.log(&quot;checkBar.className=&quot;+checkBar.className);</span></span><br><span class="line">  <span class="keyword">if</span> (checkBar.<span class="property">className</span>.<span class="title function_">includes</span>(<span class="string">&quot;active&quot;</span>)) &#123;</span><br><span class="line">    checkBar.<span class="property">className</span> = <span class="string">&quot;sampleClass&quot;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    checkBar.<span class="property">className</span> += <span class="string">&quot; active&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="day27置換css屬性網頁效能的方法二"><a href="#day27置換css屬性網頁效能的方法二" class="headerlink" title="day27置換css屬性網頁效能的方法二"></a>day27置換css屬性網頁效能的方法二</h3><p>用cssText來置換屬性。每當點擊橘色盒子的時候，盒子就會向左偏移。並做一個按鈕可以讓盒子回到原來位置。</p>
<p><a href="https://js-qsgwpj.stackblitz.io/">stackblitz</a></p>
<p>說明：<br>我們把原本的<code>rectangle.style.left = left + &#39;px&#39;;</code><br>置換成<code>rectangle.style.sytle.cssText+=left: $&#123;left&#125;px;</code>來避免reflow</p>
<p>小提醒：<br>因為cssText是直接複寫css內容，所以我們用+&#x3D;累加的方式，將要修改的樣式字串加到後面。</p>
<p>HTML code:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;move where&quot;</span>&gt;</span>點我向右走<span class="tag">&lt;/<span class="name">dvi</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;reset&quot;</span>&gt;</span>reset<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>CSS code:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.move</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">line-height</span>:<span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">background</span>:orange;</span><br><span class="line">    <span class="attribute">position</span>:absolute;</span><br><span class="line">    <span class="attribute">top</span>:<span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">cursor</span>:pointer;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="selector-class">.where</span>&#123;</span><br><span class="line">    <span class="attribute">left</span>:<span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.reset</span>&#123;</span><br><span class="line">    <span class="attribute">border-radius</span>:<span class="number">50px</span>; </span><br><span class="line">    <span class="attribute">font-weight</span>:bold;</span><br><span class="line">    <span class="attribute">background</span>:black;</span><br><span class="line">    <span class="attribute">color</span>:white;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JS code:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import stylesheets</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> left = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">var</span> top = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rectangle = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;where&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> reset = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;reset&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">rectangle.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  left += <span class="number">10</span>;</span><br><span class="line">  rectangle.<span class="property">style</span>.<span class="property">cssText</span> = <span class="string">`left:<span class="subst">$&#123;left&#125;</span>px`</span>;</span><br><span class="line">  <span class="comment">//rectangle.style.left= left+&#x27;px&#x27;;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">reset.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  rectangle.<span class="property">style</span>.<span class="property">cssText</span> = <span class="string">&quot;left:10px&quot;</span>;</span><br><span class="line">  left = <span class="number">10</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="day28處理時間"><a href="#day28處理時間" class="headerlink" title="day28處理時間"></a>day28處理時間</h3><p>javascript如何處理時間</p>
<p><a href="https://js-twvnya.stackblitz.io/">stackblitz</a></p>
<p>在<code>html</code>中</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;time&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;transTime&quot;</span>&gt;</span>現在是幾年<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>javascript</code>中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ele = <span class="variable language_">document</span>.<span class="title function_">getelementsByClassName</span>(<span class="string">&quot;time&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> trans = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&quot;transTime&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getFullYear</span>()</span><br><span class="line">ele.<span class="property">innerHTML</span>= now;</span><br><span class="line">trans.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    now = now - <span class="number">1911</span>;</span><br><span class="line">    ele.<span class="property">innerHTML</span> = <span class="string">&#x27;民 &#x27;</span>+now;</span><br><span class="line">    trans.<span class="property">disabled</span> = <span class="string">&#x27;disabled&#x27;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="day29-一些小技巧"><a href="#day29-一些小技巧" class="headerlink" title="day29 一些小技巧"></a>day29 一些小技巧</h3><blockquote>
<p> 總要進步，總能更好，保持學習。</p>
</blockquote>
<p>以下一個清除陣列的小技巧</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">list.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list);</span><br><span class="line"><span class="comment">//[]</span></span><br></pre></td></tr></table></figure>

<p>下一步，JS框架。<br>思考：為什麼要用框架?<br>如果只是寫JS的一些小東西，可能不需要用到框架。但當專案的規模越來越大，更需要有效的管理程式碼，考慮擴展與降低重複問題。很多東西是一體的兩面，框架用得好可以幫助我們產生更好的成果與增加可維謢性，用得不好可能綁手綁腳，本末導致。除了規模上的總則，選擇框架也會考慮技術的成熟度，社群的支援度，甚至是學習曲線。而下面是始一個Vue.js的例子。</p>
<p>說明：</p>
<p>兩個大括號中間是渲染的文字，然後把資料分離到JS裡面。data的部分就是儲存文字資料的地方。所以當我們之後要改變資料內容。就不需要直接改html畫面的檔案，而是去調整JS裡的資料內容，</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    &#123;&#123; text &#125;&#125; Nice to meet Vue.</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line"> <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line"> <span class="attr">data</span>: &#123;</span><br><span class="line">   <span class="attr">text</span>: <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>





















































































































<h6 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h6><p><a href="https://ithelp.ithome.com.tw/users/20107703/ironman/1489">一個 JS 學習者的日常 共 30 篇</a></p>
<p><a href="https://rxjs-dev.firebaseapp.com/api">https://rxjs-dev.firebaseapp.com/api</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E5%8B%95%E6%85%8Bnamespace%E7%9A%84%E6%B8%AC%E8%A9%A6/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E5%8B%95%E6%85%8Bnamespace%E7%9A%84%E6%B8%AC%E8%A9%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E5%8B%95%E6%85%8Bnamespace%E7%9A%84%E6%B8%AC%E8%A9%A6/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E5%8B%95%E6%85%8Bnamespace%E7%9A%84%E6%B8%AC%E8%A9%A6/" class="post-title-link" itemprop="url">學習Flask-SocketIO的動態namespace的測試</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-05-15 15:27:00" itemprop="dateCreated datePublished" datetime="2019-05-15T15:27:00+00:00">2019-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/" itemprop="url" rel="index"><span itemprop="name">學習</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/Python/Flask-SocketIO/" itemprop="url" rel="index"><span itemprop="name">Flask-SocketIO</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>之前在<code>nodejs</code>下有成功的建立動態的<code>namespace</code>,因為後端是使用<code>python</code>所以來測試一下是否可以動態的來產生<code>namespace</code></p>
<h3 id="服務端"><a href="#服務端" class="headerlink" title="服務端"></a>服務端</h3><p>一樣是建立<code>Flask-SocketIO</code>的服務器，可以參考之前的建立的專案在<code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> SocketIO, send, emit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&quot;SECRET_KEY&quot;</span>] = <span class="string">&quot;secret1&quot;</span></span><br><span class="line">socketio = SocketIO(app)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello Flask-SocketIO&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;connect&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onconnect</span>():</span><br><span class="line">    <span class="comment"># socket id</span></span><br><span class="line">    currentSocketId = request.sid</span><br><span class="line">    <span class="comment"># socketio namespace</span></span><br><span class="line">    <span class="built_in">print</span>(request.namespace)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;connect&gt; socket.id=%s&quot;</span> % (currentSocketId))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;connected&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onConnected</span>(<span class="params">data</span>):</span><br><span class="line">    currentSocketId = request.sid</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;connected&gt; socket.id=%s msg=%s&quot;</span> %</span><br><span class="line">          (currentSocketId, data))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;disconnect&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ondisconnect</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;disconnect&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;chatmessage&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onchatmessage</span>(<span class="params">data</span>):</span><br><span class="line">    msg = <span class="string">&quot;[server]&lt;chatmessage&gt;:%s&quot;</span> % (data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;chatmessage&gt;:%s&quot;</span>, msg)</span><br><span class="line">    <span class="comment">## emit(&quot;chatmessage&quot;, data)</span></span><br><span class="line">    <span class="comment">## emit(&quot;chatmessage&quot;, data, broadcast=True)</span></span><br><span class="line">    emit(<span class="string">&quot;chatmessage&quot;</span>, data, broadcast=<span class="literal">True</span>, include_self=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span>  <span class="comment"># vscode 才可以偵錯</span></span><br><span class="line">    socketio.run(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">5000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在<code>server</code>起動時，如果要修改<code>port</code>可以修改<code>.vscode\launch.json</code>中的args</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;run&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--port=6000&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-debugger&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-reload&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>在送<code>json</code>給客戶端有個坑，只要在送的時候設定一下<code>json=True</code>如下的部份程式碼</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">senddata = &#123;<span class="string">&#x27;result&#x27;</span>: self.namespace_queue&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[server]&lt;updateNamespaceList&gt; socket.id=%s result=%s&quot;</span> %</span><br><span class="line">             (currentSocketId, senddata))</span><br><span class="line">emit(<span class="string">&#x27;updateNamespaceList&#x27;</span>, senddata, broadcast=<span class="literal">True</span>, json=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h3 id="客戶端"><a href="#客戶端" class="headerlink" title="客戶端"></a>客戶端</h3><p>可以參考之前建立的專案<a href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E8%81%8A%E5%A4%A9%E8%A8%8A%E6%81%AF/">學習Flask-SocketIO的聊天訊息</a></p>
<p>因為要有多台的電腦可以連線來測試，所以要修改<code>angular.json</code>的內容，要加入<code>&quot;host&quot;: &quot;0.0.0.0&quot;</code>如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;serve&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;builder&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@angular-devkit/build-angular:dev-server&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;browserTarget&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatclient:build&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>



<h3 id="主要的程式碼"><a href="#主要的程式碼" class="headerlink" title="主要的程式碼"></a>主要的程式碼</h3><p>我是以手冊上建議的<code>Class-Based Namespaces</code>的方式來處理動態的<code>namespace</code>一開始先建立一個預設的<code>namespace</code>先就是空字串給它</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">init_app</span>(<span class="params">self, app</span>):</span><br><span class="line">        self.app = app</span><br><span class="line">        socketio.init_app(app)</span><br><span class="line">        self.createClassNamepace(<span class="string">&quot;&quot;</span>, <span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># self.createClassNamepace(&quot;/&quot;)</span></span><br><span class="line">        <span class="comment"># self.createClassNamepace(&quot;/bb&quot;)</span></span><br></pre></td></tr></table></figure>

<p>在<code>createClassNamepace</code>的程式中是在<code>server</code>中有一個<strong>list</strong>來保留有多少被建立的<code>namespace</code>和建立真正有網路事件中處理的物件<code>MyCustomNamespace</code>之後要掛起來<code>socketio.on_namespace(myclsns)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">createClassNamepace</span>(<span class="params">self, nsname, startup=<span class="literal">False</span></span>):</span><br><span class="line">        self.createNamespace(nsname, startup)</span><br><span class="line">        myclsns = MyCustomNamespace(<span class="string">&quot;/&quot;</span>+nsname)</span><br><span class="line">        self.CustomNamespace.append(myclsns)</span><br><span class="line">        socketio.on_namespace(myclsns)</span><br></pre></td></tr></table></figure>

<p>在物件<code>MyCustomNamespace</code>要注意的是物件功能的名稱例如你的事件是<code>connect</code>那你的物件的方法名稱是<code>on_connect</code>此外在加入<code>namespace</code>只要通知自已</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyCustomNamespace</span>(<span class="title class_ inherited__">Namespace</span>):</span><br><span class="line">    ChatServer = <span class="literal">None</span></span><br><span class="line">    <span class="comment"># 客戶connect的事件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_connect</span>(<span class="params">self</span>):</span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        fmt = <span class="string">&quot;[myns ns=%s]&lt;connect&gt;&quot;</span> % (sckns)</span><br><span class="line">        <span class="built_in">print</span>(fmt)</span><br><span class="line">        self.sendUpdateNamespace()</span><br><span class="line">    <span class="comment"># 客戶disconnect的事件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_disconnect</span>(<span class="params">self</span>):</span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        fmt = <span class="string">&quot;[myns ns=%s]&lt;disconnect&gt;&quot;</span> % (sckns)</span><br><span class="line">        <span class="built_in">print</span>(fmt)</span><br><span class="line">    <span class="comment"># 客戶已連線connected的事件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_connected</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="comment"># socket id</span></span><br><span class="line">        currentSocketId = request.sid</span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        fmt = <span class="string">&quot;[myns ns=%s]&lt;connected&gt; socket.id=%s msg=%s&quot;</span> % (</span><br><span class="line">            sckns, currentSocketId, data)</span><br><span class="line">        <span class="built_in">print</span>(fmt)</span><br><span class="line">    <span class="comment"># 聊天chatmessage的事件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_chatmessage</span>(<span class="params">self, data</span>):</span><br><span class="line">        currentSocketId = request.sid</span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        fmt = <span class="string">&quot;[myns ns=%s]&lt;chatmessage&gt;:%s&quot;</span> % (sckns, data)</span><br><span class="line">        <span class="built_in">print</span>(fmt)</span><br><span class="line">        <span class="comment"># emit(&quot;chatmessage&quot;, data)</span></span><br><span class="line">        emit(<span class="string">&quot;chatmessage&quot;</span>, data, broadcast=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># emit(&quot;chatmessage&quot;, data, broadcast=True, include_self=False)</span></span><br><span class="line">    <span class="comment"># 建立createNamespace的事件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_createNamespace</span>(<span class="params">self, data</span>):</span><br><span class="line">        currentSocketId = request.sid</span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[myns ns=%s]&lt;createNamespace&gt; socket.id=%s nsname=%s&quot;</span> %</span><br><span class="line">              (sckns, currentSocketId, data[<span class="string">&quot;name&quot;</span>]))</span><br><span class="line">        self.ChatServer.createClassNamepace(data[<span class="string">&quot;name&quot;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 傳送namespace列表</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sendUpdateNamespace</span>(<span class="params">self</span>):</span><br><span class="line">        currentSocketId = request.sid</span><br><span class="line">        sckns = request.namespace</span><br><span class="line">        senddata = &#123;<span class="string">&#x27;result&#x27;</span>: self.ChatServer.namespace_queue&#125;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[myns ns=%s]&lt;updateNamespaceList&gt; socket.id=%s result=%s&quot;</span> %</span><br><span class="line">              (sckns, currentSocketId, senddata))</span><br><span class="line">        emit(<span class="string">&#x27;updateNamespaceList&#x27;</span>, senddata, broadcast=<span class="literal">True</span>, json=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 加入JoinToApp事件加入某個namespace</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_JoinToApp</span>(<span class="params">self, data</span>):</span><br><span class="line">        namespaceToConnect = self.ChatServer.searchObjectOnArray(</span><br><span class="line">            data[<span class="string">&quot;namespace&quot;</span>])</span><br><span class="line">        <span class="keyword">if</span> namespaceToConnect != <span class="literal">None</span>:</span><br><span class="line">            sendmsg = &#123;<span class="string">&quot;namespace&quot;</span>: namespaceToConnect&#125;</span><br><span class="line">            emit(<span class="string">&#x27;JoinToApp&#x27;</span>, sendmsg, json=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>可以參考<a href="https://github.com/ttom921/StudyPython">github</a>的<code>TestFlaskSocketIONs</code>專案</p>
<p>因為要處理影像相關的程式所以要來建立新的<code>service</code>的處理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g service services/imagefile </span><br></pre></td></tr></table></figure>

<h3 id="客戶端一次開8個"><a href="#客戶端一次開8個" class="headerlink" title="客戶端一次開8個"></a>客戶端一次開8個</h3><p>將傳送端分開先產生頁面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g c \chat\sendchannel</span><br></pre></td></tr></table></figure>

<p>將之的<code>room1</code>, 掛到這個元件的下面在<code>src\app\chat\sendchannel\sendchannel.component.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">  不顯示只傳送: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;myCheck&quot;</span> [(<span class="attr">ngModel</span>)]=<span class="string">&quot;myCheck&quot;</span> [<span class="attr">value</span>]=<span class="string">&quot;myCheck&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;CheckClick()&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">app-room1</span> [<span class="attr">isVisiableImg</span>]=<span class="string">&quot;myCheck&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">app-room1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>先產生頁面<code>chat\room</code>,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g c \chat\room</span><br></pre></td></tr></table></figure>

<p>在加入路由表在<code>src\app\app-routing.module.ts</code>的內容</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">redirectTo</span>: <span class="string">&#x27;room&#x27;</span>, <span class="attr">pathMatch</span>: <span class="string">&#x27;full&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;sendchannel&#x27;</span>, <span class="attr">component</span>: <span class="title class_">SendchannelComponent</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;room&#x27;</span>, <span class="attr">component</span>: <span class="title class_">RoomComponent</span> &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>每一個是獨立的<code>charRoom</code>,所以來產生</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g c \chat\charRoom</span><br></pre></td></tr></table></figure>



<p>因為要有4個頻道所以來產生<code>char\channel</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g c \chat\channel</span><br></pre></td></tr></table></figure>

<p>問題目前同時連線到服務器，上限只有5個，超個5個不能動作，原因還不知道是因為沒有使用<code>winsocket</code>的協議，在<code>python</code>中要安裝<code>gevent-websocket</code>這個套件</p>
<h6 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h6><p><a href="https://www.itread01.com/content/1531210942.html">結合manage.py，在flask項目中使用 flask-socketio</a><br><a href="https://gwj41.iteye.com/blog/2399535">ular 4 上传多个文件到Spring boot</a><br><a href="https://codertw.com/%E5%89%8D%E7%AB%AF%E9%96%8B%E7%99%BC/230955/">Angular2裡獲取（input file）上傳檔案的內容的方法</a><br><a href="https://stackoverflow.com/questions/43492354/how-to-allow-access-outside-localhost">How to allow access outside localhost</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E8%81%8A%E5%A4%A9%E8%A8%8A%E6%81%AF/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E8%81%8A%E5%A4%A9%E8%A8%8A%E6%81%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E8%81%8A%E5%A4%A9%E8%A8%8A%E6%81%AF/%E5%AD%B8%E7%BF%92Flask-SocketIO%E7%9A%84%E8%81%8A%E5%A4%A9%E8%A8%8A%E6%81%AF/" class="post-title-link" itemprop="url">學習Flask-SocketIO的聊天訊息</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-05-15 10:21:30" itemprop="dateCreated datePublished" datetime="2019-05-15T10:21:30+00:00">2019-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/" itemprop="url" rel="index"><span itemprop="name">學習</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/Python/Flask-SocketIO/" itemprop="url" rel="index"><span itemprop="name">Flask-SocketIO</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>這是為了了解Flask-SocketIO的特性和是否可以使用動態的<code>namespace</code>來建立的測試程式</p>
<h3 id="設定環境"><a href="#設定環境" class="headerlink" title="設定環境"></a>設定環境</h3><p>先建立來使用虛擬環境來建立Flask的環境</p>
<p>可以參考之前<a href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92Flask%E8%B5%B7%E6%89%8B%E5%BC%8F/">學習Flask起手式</a>因為我之前有建立好的虛擬環境，所以只要起動它就可以，在下面建立<code>app.py</code>的內容如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello flask&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span>  <span class="comment"># vscode 才可以偵錯</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p>在設定<code>vscode</code>的工作區設定裏將虛擬環境的python執行路徑加入到<code>python:Venv Path</code>如下的圖示</p>
<img src="2019-05-15_10_59_07_Image.jpg" style="zoom:80%;" />

<p>目前的內容如下，這是虛擬環境的<code>python</code>的執行檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:\Project\github\StudyPython\pyvirenv\pyenv37\Scripts</span><br></pre></td></tr></table></figure>

<p>要設定<code>launch.json</code>的內容如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 使用 IntelliSense 以得知可用的屬性。</span></span><br><span class="line">    <span class="comment">// 暫留以檢視現有屬性的描述。</span></span><br><span class="line">    <span class="comment">// 如需詳細資訊，請瀏覽: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python：Flask&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flask&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="comment">// 選擇虛擬環境中的python版本</span></span><br><span class="line">            <span class="attr">&quot;pythonPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:/Project/github/StudyPython/pyvirenv/pyenv37/Scripts/python.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;FLASK_APP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app.py&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;FLASK_ENV&quot;</span><span class="punctuation">:</span> <span class="string">&quot;development&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;FLASK_DEBUG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;run&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-debugger&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-reload&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;jinja&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>安裝<strong>Flask-SocketIO</strong></p>
<p>啟動虛擬環境來安裝</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-socketio</span><br><span class="line">pip install gevent</span><br></pre></td></tr></table></figure>

<p>修改<code>app.py</code>如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> SocketIO, send, emit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&quot;SECRET_KEY&quot;</span>] = <span class="string">&quot;secret1&quot;</span></span><br><span class="line">socketio = SocketIO(app)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello Flask-SocketIO&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;connect&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onconnect</span>():</span><br><span class="line">    <span class="comment"># socket id</span></span><br><span class="line">    currentSocketId = request.sid</span><br><span class="line">    <span class="comment"># socketio namespace</span></span><br><span class="line">    <span class="built_in">print</span>(request.namespace)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;connect&gt; socket.id=%s&quot;</span> % (currentSocketId))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;connected&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onConnected</span>(<span class="params">data</span>):</span><br><span class="line">    currentSocketId = request.sid</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;connected&gt; socket.id=%s msg=%s&quot;</span> %</span><br><span class="line">          (currentSocketId, data))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;disconnect&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ondisconnect</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;disconnect&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&quot;chatmessage&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onchatmessage</span>(<span class="params">data</span>):</span><br><span class="line">    msg = <span class="string">&quot;[server]&lt;chatmessage&gt;:%s&quot;</span> % (data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[server]&lt;chatmessage&gt;:%s&quot;</span>, msg)</span><br><span class="line">    <span class="comment">##emit(&quot;chatmessage&quot;, &#123;&#x27;data&#x27;: data&#125;)</span></span><br><span class="line">    emit(<span class="string">&quot;chatmessage&quot;</span>, data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span>  <span class="comment"># vscode 才可以偵錯</span></span><br><span class="line">    socketio.run(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">5000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="客戶端"><a href="#客戶端" class="headerlink" title="客戶端"></a>客戶端</h3><p>設定<code>client</code>端是用<code>Angular</code>可以參考之前的<a href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92typescript%E5%92%8Csocket-io%E7%9A%84%E4%BD%BF%E7%94%A8/">學習typescript和socket-io的使用</a>有關客戶端的設定</p>
<p>建立新的<code>angular</code>的客戶端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng new chatclient</span><br></pre></td></tr></table></figure>

<p>建立<code>chat</code>下的<code>room1</code>的頁面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g c chat/room1</span><br></pre></td></tr></table></figure>

<p>安裝用到的模組</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install socket.io --save</span><br></pre></td></tr></table></figure>

<p>加入連線用到的服務</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g service chat/services/socket</span><br></pre></td></tr></table></figure>
<p>在<code>src\app\chat\services\socket.service.ts</code>如下</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> socketIo <span class="keyword">from</span> <span class="string">&quot;socket.io-client&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Event</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../model/event&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">SocketService</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">socket</span>: socketIo;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">initSocket</span>(<span class="params">ns_url: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span> = <span class="title function_">socketIo</span>(ns_url);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">onEvent</span>(<span class="attr">event</span>: <span class="title class_">Event</span>): <span class="title class_">Observable</span>&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observable</span>&lt;<span class="title class_">Event</span>&gt;(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">on</span>(event, <span class="function">() =&gt;</span> observer.<span class="title function_">next</span>());</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title class_">SendConnect</span>() &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">emit</span>(<span class="string">&quot;connected&quot;</span>, <span class="string">&quot;我已連線了&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title class_">Sendchatmessage</span>(<span class="attr">msg</span>: <span class="built_in">string</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">emit</span>(<span class="string">&quot;chatmessage&quot;</span>, msg);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title class_">Onchatmessage</span>(): <span class="title class_">Observable</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observable</span>&lt;<span class="built_in">string</span>&gt;(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">on</span>(<span class="string">&quot;chatmessage&quot;</span>, <span class="function">(<span class="params">data: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(data)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// public disconnect()&#123;</span></span><br><span class="line">  <span class="comment">//   this.socket.disconnect();</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>剩下的可以參考一下<a href="https://github.com/ttom921/StudyPython">github</a>中的TestFlaskSocketIOchat</p>
<p><strong>注意</strong>在<code>app.py</code>中的<code>emit</code>使用上要注意</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">emit(<span class="string">&quot;chatmessage&quot;</span>, data) <span class="comment">##只傳送給自已</span></span><br><span class="line">emit(<span class="string">&quot;chatmessage&quot;</span>, data, broadcast=<span class="literal">True</span>) <span class="comment">## 會傳送給所有在這namespace和room包括自已</span></span><br><span class="line">emit(<span class="string">&quot;chatmessage&quot;</span>, data, broadcast=<span class="literal">True</span>, include_self=<span class="literal">False</span>) <span class="comment">## 會傳送給所有在這namespace和room不包括自已</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E8%A8%98%E9%8C%84Nodejs-Socket-io%E5%A4%9A%E9%80%9A%E9%81%93%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs-Socket-io%E5%A4%9A%E9%80%9A%E9%81%93%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%A8%98%E9%8C%84Nodejs-Socket-io%E5%A4%9A%E9%80%9A%E9%81%93%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs-Socket-io%E5%A4%9A%E9%80%9A%E9%81%93%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">記錄Nodejs-Socket_io多通道使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-05-08 11:13:20" itemprop="dateCreated datePublished" datetime="2019-05-08T11:13:20+00:00">2019-05-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A8%98%E9%8C%84/" itemprop="url" rel="index"><span itemprop="name">記錄</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A8%98%E9%8C%84/Nodejs/" itemprop="url" rel="index"><span itemprop="name">Nodejs</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>先來測試一個在Socket.IO裏的<code>namespace</code>和<code>room</code>的使用，先有一個<code>namespce</code>下面有一個聊天的頻道，在有一個<code>namespace</code>加上有4個<code>room</code>來傳送和接收圖片</p>
<p>先建立專案和之前的方式一樣先建立一個資料夾<code>namespace-example</code>,在下其它的指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br><span class="line">npm install --save express</span><br><span class="line">npm install --save socket.io</span><br></pre></td></tr></table></figure>
<h3 id="單一namespace和單一room頻道的測試"><a href="#單一namespace和單一room頻道的測試" class="headerlink" title="單一namespace和單一room頻道的測試"></a>單一<code>namespace</code>和單一<code>room</code>頻道的測試</h3><h4 id="服務端的設定"><a href="#服務端的設定" class="headerlink" title="服務端的設定"></a>服務端的設定</h4><p>先設定有幾個<code>namespace</code>,可以處理多個<code>namespace</code>在<code>app.js</code>下設定</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//建立socket.io的namespace</span></span><br><span class="line"><span class="keyword">var</span> namespaces = [</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/nsp_chat&#x27;</span>),</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/ns2&#x27;</span>),</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/ns3&#x27;</span>)</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>在設定有幾個<code>room</code>房間,目前先設定四個</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//建立room</span></span><br><span class="line"><span class="keyword">let</span> registeredRooms = [<span class="string">&quot;channel1&quot;</span>, <span class="string">&quot;channel2&quot;</span>, <span class="string">&quot;channel3&quot;</span>,<span class="string">&quot;channel4&quot;</span>]; </span><br></pre></td></tr></table></figure>

<p>在加入可以回傳處理的函式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> namespaces) &#123;</span><br><span class="line">    namespaces[i].<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="title function_">handleConnection</span>(namespaces[i]));  </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleConnection</span>(<span class="params">ns</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">socket</span>)&#123; <span class="comment">//connection</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connected &quot;</span>);</span><br><span class="line">    socket.<span class="title function_">emit</span>(<span class="string">&quot;connected&quot;</span>,registeredRooms);</span><br><span class="line">    <span class="comment">//socket.on(&#x27;setUsername&#x27;,setUsernameCallback(socket,ns));                       </span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>, <span class="title function_">disconnectCallback</span>(socket,ns));   </span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;chatmessage&#x27;</span>,<span class="title function_">chatMessageCallback</span>(socket,ns));                     </span><br><span class="line">    <span class="comment">//socket.on(&#x27;messageChat&#x27;,messageChatCallback(socket,ns));</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;createJoinRoom&#x27;</span>,<span class="title function_">createJoinRoomCallback</span>(socket,ns));  </span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;bytemessage&#x27;</span>,<span class="title function_">byteMessaecCallback</span>(socket,ns));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每個<code>namespace</code>有自已處理的函式</p>
<p>在流程是</p>
<ul>
<li><code>client</code>先設定好連線到<code>server</code></li>
<li><code>server</code>收到連線後會回傳房間列表</li>
<li><code>client</code>端收到房間列表，送<code>createJoinRoom</code>和那一個房間到<code>server</code></li>
<li><code>server</code>收到<code>createJoinRoom</code>, 將<code>client</code>加入它送上來的房間和回傳<code>success</code></li>
<li><code>client</code>收到有效房間的訊息<br>如下圖所示</li>
</ul>
<img src="2019-05-09_12_27_39_Image.jpg" style="zoom:80%;" />

<p>在<code>app.js</code>的程式碼如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"><span class="keyword">var</span> io  = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)(http);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname+<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//有關Socket.IO的設定</span></span><br><span class="line"><span class="comment">//建立socket.io的namespace</span></span><br><span class="line"><span class="keyword">var</span> namespaces = [</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/nsp_chat&#x27;</span>),</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/ns2&#x27;</span>),</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/ns3&#x27;</span>)</span><br><span class="line">];</span><br><span class="line"><span class="comment">//建立room</span></span><br><span class="line"><span class="keyword">let</span> registeredRooms = [<span class="string">&quot;channel1&quot;</span>, <span class="string">&quot;channel2&quot;</span>, <span class="string">&quot;channel3&quot;</span>,<span class="string">&quot;channel4&quot;</span>]; </span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> namespaces) &#123;</span><br><span class="line">    namespaces[i].<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="title function_">handleConnection</span>(namespaces[i]));  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleConnection</span>(<span class="params">ns</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">socket</span>)&#123; <span class="comment">//connection</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connection &quot;</span>);</span><br><span class="line">    socket.<span class="title function_">emit</span>(<span class="string">&quot;connection&quot;</span>,registeredRooms);</span><br><span class="line">    <span class="comment">//socket.on(&#x27;setUsername&#x27;,setUsernameCallback(socket,ns));                       </span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>, <span class="title function_">disconnectCallback</span>(socket,ns));   </span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;chatmessage&#x27;</span>,<span class="title function_">chatMessageCallback</span>(socket,ns));                     </span><br><span class="line">    <span class="comment">//socket.on(&#x27;messageChat&#x27;,messageChatCallback(socket,ns));</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;createJoinRoom&#x27;</span>,<span class="title function_">createJoinRoomCallback</span>(socket,ns));  </span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;bytemessage&#x27;</span>,<span class="title function_">byteMessaecCallback</span>(socket,ns));</span><br><span class="line"> </span><br><span class="line">   &#125;;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">byteMessaecCallback</span>(<span class="params">socket,ns</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">bufdata</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;bytemessage &quot;</span>);</span><br><span class="line">        socket.<span class="title function_">emit</span>(<span class="string">&quot;bytemessage&quot;</span>,bufdata);</span><br><span class="line">      &#125;;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">connectedCallback</span>(<span class="params">socket, ns</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connected &quot;</span>);</span><br><span class="line">        <span class="comment">//socket.broadcast.send(&quot;It works!&quot;);</span></span><br><span class="line">      &#125;;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 加入房間</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createJoinRoomCallback</span>(<span class="params">socket, ns</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">room</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Joining Room...: &quot;</span> + room);</span><br><span class="line">        <span class="keyword">if</span>(registeredRooms.<span class="title function_">includes</span>(room))&#123;</span><br><span class="line">            <span class="comment">//socket已加入房間</span></span><br><span class="line">            socket.<span class="title function_">emit</span>(<span class="string">&quot;success&quot;</span>,<span class="string">&quot;有效房間名:&quot;</span>+room);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 沒有此房間</span></span><br><span class="line">            socket.<span class="title function_">emit</span>(<span class="string">&quot;err&quot;</span>,<span class="string">&quot;無效房間名:&quot;</span>+room);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">//斷線處理</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">disconnectCallback</span>(<span class="params">socket,ns</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Disconnected &quot;</span>);</span><br><span class="line">     socket.<span class="property">broadcast</span>.<span class="title function_">send</span>(<span class="string">&quot;It works!&quot;</span>);</span><br><span class="line">   &#125;;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 聊天訊息</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">chatMessageCallback</span>(<span class="params">socket,ns</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;chatmessage: &#x27;</span>+ msg);</span><br><span class="line">        socket.<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//有關Socket.IO的處理</span></span><br><span class="line"><span class="comment">//有關chat</span></span><br><span class="line"><span class="comment">// 有client連線</span></span><br><span class="line"><span class="comment">// nsp_chat.on(&#x27;connection&#x27;,function(socket)&#123;</span></span><br><span class="line"><span class="comment">//     socket.broadcast.emit(&#x27;chat message&#x27;,&#x27;hi&#x27;);</span></span><br><span class="line"><span class="comment">//     console.log(&#x27;an user connected&#x27;);</span></span><br><span class="line"><span class="comment">//      //client斷線</span></span><br><span class="line"><span class="comment">//      nsp_chat.on(&#x27;disconnect&#x27;,function()&#123;</span></span><br><span class="line"><span class="comment">//         console.log(&#x27;user disconnected&#x27;);</span></span><br><span class="line"><span class="comment">//     &#125;);</span></span><br><span class="line"><span class="comment">//     nsp_chat.on(&#x27;chat message&#x27;,function(msg)&#123;</span></span><br><span class="line"><span class="comment">//         console.log(&#x27;message: &#x27;+ msg);</span></span><br><span class="line"><span class="comment">//         //收到訊息後，回傳給自已</span></span><br><span class="line"><span class="comment">//         socket.emit(&#x27;chat message&#x27;,msg);</span></span><br><span class="line"><span class="comment">//     &#125;);</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listen on *:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="客戶端的設定"><a href="#客戶端的設定" class="headerlink" title="客戶端的設定"></a>客戶端的設定</h4><p>在<code>index.html</code>的程式碼如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">box-sizing</span>: border-box;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.imgshow</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>:<span class="number">20%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>:<span class="number">200px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">float</span>: left;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.inputdiv</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">224</span>, <span class="number">188</span>, <span class="number">188</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: .<span class="number">5%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">float</span>: left;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">3px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">bottom</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">20%</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.clsmsginput</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: .<span class="number">5%</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#msgbtn</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: none;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">1px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">list-style-type</span>: none;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#eee</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-bottom</span>: <span class="number">40px</span></span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    不顯示只傳送: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;myCheck&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo1&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%; height:100%&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo2&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%; height:100%&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo3&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%; height:100%&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo4&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%; height:100%&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&quot;clear: left;&quot;</span>&gt;</span>群聊<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span> &gt;</span></span><br><span class="line">            輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput1&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn1&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile1&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn1&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">            輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn2&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile2&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn2&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">            輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput3&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn3&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile3&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn3&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">            輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn4&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile4&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn4&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-1.11.1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> channellist=[];</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//網路相關</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//建立連接</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> socket_chat = <span class="title function_">io</span>(<span class="string">&#x27;http://localhost:3000/nsp_chat&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            socket_chat.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">chlist</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;connection:&#x27;</span>+chlist);</span></span><br><span class="line"><span class="language-javascript">                channellist=chlist;</span></span><br><span class="line"><span class="language-javascript">                socket_chat.<span class="title function_">emit</span>(<span class="string">&#x27;createJoinRoom&#x27;</span>,channellist[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket_chat.<span class="title function_">on</span>(<span class="string">&#x27;chatmessage&#x27;</span>, <span class="keyword">function</span> (<span class="params">msg</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;收到:&#x27;+msg);</span></span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(msg));</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket_chat.<span class="title function_">on</span>(<span class="string">&#x27;success&#x27;</span>,<span class="keyword">function</span>(<span class="params">room</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> limsg=<span class="string">&#x27;成功加入此房間:&#x27;</span>+room;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;成功加入:&#x27;+room);</span></span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(limsg));</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket_chat.<span class="title function_">on</span>(<span class="string">&#x27;err&#x27;</span>,<span class="keyword">function</span>(<span class="params">room</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> limsg=<span class="string">&#x27;無效房間名:&#x27;</span>+room;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;無效房間名:&#x27;+room);</span></span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(limsg));</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket_chat.<span class="title function_">on</span>(<span class="string">&#x27;bytemessage&#x27;</span>, <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;byte message&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//var bufView = new Uint8Array(data);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(data.buffer);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// Get the checkbox</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> checkBox = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;myCheck&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (checkBox.<span class="property">checked</span> != <span class="literal">true</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([data], &#123; <span class="attr">type</span>: <span class="string">&quot;image/jpeg&quot;</span> &#125;);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> urlCreator = <span class="variable language_">window</span>.<span class="property">URL</span> || <span class="variable language_">window</span>.<span class="property">webkitURL</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> imageUrl = urlCreator.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> img = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#photo1&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    img.<span class="property">src</span> = imageUrl;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                data.<span class="property">length</span>=<span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//------------------------------------------</span></span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#msgbtn1&#x27;</span>).<span class="title function_">click</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> msg = $(<span class="string">&#x27;#msginput1&#x27;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;發射:[&#x27;</span> + msg + <span class="string">&#x27;]&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                socket_chat.<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>, msg);</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#msginput1&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//發送圖片</span></span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#imgbtn1&#x27;</span>).<span class="title function_">click</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;imgbtn1:click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//讀所有的圖檔</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> uploadPromises = [];</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> files=$(<span class="string">&#x27;#imgfile1&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> <span class="title class_">Bufferary</span>= <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(files.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">for</span>(i=<span class="number">0</span> ;i&lt;files.<span class="property">length</span>;i++)&#123;</span></span><br><span class="line"><span class="language-javascript">                     <span class="keyword">var</span> uploadPromise=<span class="title function_">getBufferFromFile</span>(files[i]);</span></span><br><span class="line"><span class="language-javascript">                     uploadPromises.<span class="title function_">push</span>(uploadPromise);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Promise</span>.<span class="title function_">all</span>(uploadPromises).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title class_">Bufferary</span>[i] = result[i];</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//測試</span></span></span><br><span class="line"><span class="language-javascript">                    socket_chat.<span class="title function_">emit</span>(<span class="string">&#x27;bytemessage&#x27;</span>, <span class="title class_">Bufferary</span>[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//socket_chat.emit(&#x27;byte message&#x27;, Bufferary[0]);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//開始發射</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//     setInterval(() =&gt; &#123;</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//         for (i = 0; i &lt; files.length; i++) &#123;</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//             var file = files[i]</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//             //console.log(&#x27;發射:&#x27;+file.name )</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//             //socket.emit(&#x27;byte message&#x27;, &#123; image: true, buffer: Bufferary[i] &#125;);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//             socket.emit(&#x27;byte message&#x27;, Bufferary[i]);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//         &#125;</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//     &#125;, 500);</span></span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">getBufferFromFile</span>(<span class="params">file</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                reader.<span class="title function_">readAsArrayBuffer</span>(file);</span></span><br><span class="line"><span class="language-javascript">                reader.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> buf = reader.<span class="property">result</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">resolve</span>(buf);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                reader.<span class="property">onerror</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">reject</span>(<span class="string">&#x27;讀取檔案失敗&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="單一namespace和4個room頻道的測試"><a href="#單一namespace和4個room頻道的測試" class="headerlink" title="單一namespace和4個room頻道的測試"></a>單一<code>namespace</code>和4個<code>room</code>頻道的測試</h3><h4 id="服務端的設定-1"><a href="#服務端的設定-1" class="headerlink" title="服務端的設定"></a>服務端的設定</h4><p>要在預設的<code>namespace</code>不然之後會操作上會有問題<code>app.js</code>的程式碼</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)(http);</span><br><span class="line"><span class="comment">// 服務那一個Port</span></span><br><span class="line">http.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listen on *:3000&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//首頁</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname+<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//建立room</span></span><br><span class="line"><span class="keyword">let</span> registeredRooms = [<span class="string">&quot;room1&quot;</span>, <span class="string">&quot;room2&quot;</span>, <span class="string">&quot;room3&quot;</span>,<span class="string">&quot;room4&quot;</span>]; </span><br><span class="line"></span><br><span class="line"><span class="comment">//default namespace</span></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="keyword">function</span> (<span class="params">socket</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> ip = socket.<span class="property">conn</span>.<span class="property">remoteAddress</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;default_ns:a user connected IP:&#x27;</span>+ip);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;default_ns:user disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> namespaces = [</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/aaa-123&#x27;</span>),</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/bbb-123&#x27;</span>),</span><br><span class="line">    io.<span class="title function_">of</span>(<span class="string">&#x27;/ccc-123&#x27;</span>),</span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> ns_name = namespaces[<span class="number">0</span>];</span><br><span class="line">ns_name.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 取得房間</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;getRooms&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&lt;getRooms&gt;: &quot;</span>,ns_name.<span class="property">name</span>);</span><br><span class="line">        socket.<span class="title function_">emit</span>(<span class="string">&#x27;rooomsData&#x27;</span>,registeredRooms);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 加入房間</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;createJoinRoom&#x27;</span>, <span class="keyword">function</span> (<span class="params">room</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;&lt;createJoinRoom&gt; :&#x27;</span> + room);</span><br><span class="line">        <span class="keyword">if</span> (registeredRooms.<span class="title function_">includes</span>(room)) &#123;</span><br><span class="line">            <span class="comment">//socket已加入房間</span></span><br><span class="line">            socket.<span class="title function_">emit</span>(<span class="string">&#x27;success&#x27;</span>, room);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;有效房間名:&#x27;</span> + room);</span><br><span class="line">            socket.<span class="title function_">join</span>(room);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 沒有此房間</span></span><br><span class="line">            socket.<span class="title function_">emit</span>(<span class="string">&#x27;err&#x27;</span>, room);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;無效房間名:&#x27;</span> + room);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//收到聊天訊息</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;chatmessage&#x27;</span>,<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;&lt;chatmessage&gt; :&#x27;</span> + <span class="string">&#x27;msg:&#x27;</span>+data.<span class="property">msg</span> + <span class="string">&#x27; room:&#x27;</span>+data.<span class="property">room</span>);</span><br><span class="line">        ns_name.<span class="title function_">to</span>(data.<span class="property">room</span>).<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>,data);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//收到二進位資料</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;bytemessage&#x27;</span>,<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//console.log(&#x27;&lt;bytemessage&gt; :&#x27; + &#x27; room:&#x27;+data.room);</span></span><br><span class="line">        ns_name.<span class="title function_">to</span>(data.<span class="property">room</span>).<span class="title function_">emit</span>(<span class="string">&#x27;bytemessage&#x27;</span>,data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="客戶端的設定-1"><a href="#客戶端的設定-1" class="headerlink" title="客戶端的設定"></a>客戶端的設定</h4><p>在客戶端的<code>index.html</code>的程式碼</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO 多頻道<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">box-sizing</span>: border-box;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.imgshow</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">200px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.clsimage</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>:<span class="number">100%</span>; </span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>:<span class="number">100%</span></span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.clschannel</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">20%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">float</span>: left;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#eee</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.clsmessages</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">list-style-type</span>: none;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        ;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-bottom</span>: <span class="number">40px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.inputdiv</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">224</span>, <span class="number">188</span>, <span class="number">188</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: .<span class="number">5%</span>;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">3px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">bottom</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.clsmsginput</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: .<span class="number">5%</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#msgbtn</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: none;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">1px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages1</span> <span class="selector-tag">li</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages1</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#eee</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        不顯示只傳送: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;myCheck&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&quot;clear: left;&quot;</span>&gt;</span>頻道<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;clschannel&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span> &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsimage&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;messages1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmessages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">                輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput1&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn1&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile1&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn1&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;clschannel&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsimage&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;clsmessages&quot;</span> <span class="attr">id</span>=<span class="string">&quot;messages2&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">                輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput2&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn2&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile2&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn2&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;clschannel&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsimage&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;clsmessages&quot;</span> <span class="attr">id</span>=<span class="string">&quot;messages3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">                輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput3&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn3&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile3&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn3&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;clschannel&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;imgshow&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo4&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsimage&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;clsmessages&quot;</span> <span class="attr">id</span>=<span class="string">&quot;messages4&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">                輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;clsmsginput&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn4&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile4&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;multiple&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn4&quot;</span>&gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-1.11.1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;doucument ready!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> ns_sockets = [</span></span><br><span class="line"><span class="language-javascript">            io.<span class="title function_">connect</span>(<span class="string">&#x27;http://localhost:3000/aaa-123&#x27;</span>),</span></span><br><span class="line"><span class="language-javascript">            io.<span class="title function_">connect</span>(<span class="string">&#x27;http://localhost:3000/aaa-123&#x27;</span>),</span></span><br><span class="line"><span class="language-javascript">            io.<span class="title function_">connect</span>(<span class="string">&#x27;http://localhost:3000/aaa-123&#x27;</span>),</span></span><br><span class="line"><span class="language-javascript">            io.<span class="title function_">connect</span>(<span class="string">&#x27;http://localhost:3000/aaa-123&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        ];</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> roomlst=[];</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//建立回調函數</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">for</span> (i <span class="keyword">in</span> ns_sockets) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;處理ns_sockets-&gt;&#x27;</span>+i);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 連線處理</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;connect&#x27;</span>, <span class="title function_">handleConnect</span>(ns_sockets[i], i));</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 房間列表</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;rooomsData&#x27;</span>, <span class="title function_">handlerooomsData</span>(ns_sockets[i], i));</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// success 處理</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;success&#x27;</span>, <span class="title function_">handleSuccess</span>(ns_sockets[i]),i);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// err 處理</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;err&#x27;</span>, <span class="title function_">handleErr</span>(ns_sockets[i]),i);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 斷線處理</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>, <span class="title function_">handleDisconnect</span>(ns_sockets[i]),i);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 聊天處理</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;chatmessage&#x27;</span>, <span class="title function_">handleChatmessage</span>(ns_sockets[i]),i);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 二進位處理</span></span></span><br><span class="line"><span class="language-javascript">            ns_sockets[i].<span class="title function_">on</span>(<span class="string">&#x27;bytemessage&#x27;</span>, <span class="title function_">handleBytemessage</span>(ns_sockets[i]),i);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//UI</span></span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#msgbtn1&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;msgbtn1 click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> msg = $(<span class="string">&#x27;#msginput1&#x27;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">            ns_sockets[<span class="number">0</span>].<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>, &#123; <span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room1&#x27;</span>, <span class="string">&quot;msg&quot;</span>: msg &#125;);</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#msginput1&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#msgbtn2&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;msgbtn2 click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> msg = $(<span class="string">&#x27;#msginput2&#x27;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">            ns_sockets[<span class="number">1</span>].<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>, &#123; <span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room2&#x27;</span>, <span class="string">&quot;msg&quot;</span>: msg &#125;);</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#msginput2&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#msgbtn3&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;msgbtn3 click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> msg = $(<span class="string">&#x27;#msginput3&#x27;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">            ns_sockets[<span class="number">2</span>].<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>, &#123; <span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room3&#x27;</span>, <span class="string">&quot;msg&quot;</span>: msg &#125;);</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#msginput3&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#msgbtn4&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;msgbtn4 click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> msg = $(<span class="string">&#x27;#msginput4&#x27;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">            ns_sockets[<span class="number">3</span>].<span class="title function_">emit</span>(<span class="string">&#x27;chatmessage&#x27;</span>, &#123; <span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room4&#x27;</span>, <span class="string">&quot;msg&quot;</span>: msg &#125;);</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#msginput4&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//發送圖片</span></span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#imgbtn1&#x27;</span>).<span class="title function_">click</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;imgbtn1:click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//讀所有的圖檔</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> uploadPromises = [];</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> files = $(<span class="string">&#x27;#imgfile1&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> <span class="title class_">Bufferary</span> = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(files.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> uploadPromise = <span class="title function_">getBufferFromFile</span>(files[i]);</span></span><br><span class="line"><span class="language-javascript">                uploadPromises.<span class="title function_">push</span>(uploadPromise);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="title class_">Promise</span>.<span class="title function_">all</span>(uploadPromises).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">Bufferary</span>[i] = result[i];</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//開始發射</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//ns_sockets[0].emit(&#x27;bytemessage&#x27;,&#123; &quot;room&quot;: &#x27;room1&#x27;, &quot;bufdata&quot;: Bufferary[0] &#125; );</span></span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">var</span> file = files[i]</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//console.log(&#x27;發射:&#x27;+file.name )</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//socket.emit(&#x27;byte message&#x27;, &#123; image: true, buffer: Bufferary[i] &#125;);</span></span></span><br><span class="line"><span class="language-javascript">                            ns_sockets[<span class="number">0</span>].<span class="title function_">emit</span>(<span class="string">&#x27;bytemessage&#x27;</span>, &#123;<span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room1&#x27;</span>, <span class="string">&quot;bufdata&quot;</span>: <span class="title class_">Bufferary</span>[i]&#125;);</span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;,<span class="number">600</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#imgbtn2&#x27;</span>).<span class="title function_">click</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;imgbtn2:click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//讀所有的圖檔</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> uploadPromises = [];</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> files = $(<span class="string">&#x27;#imgfile2&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> <span class="title class_">Bufferary</span> = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(files.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> uploadPromise = <span class="title function_">getBufferFromFile</span>(files[i]);</span></span><br><span class="line"><span class="language-javascript">                uploadPromises.<span class="title function_">push</span>(uploadPromise);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="title class_">Promise</span>.<span class="title function_">all</span>(uploadPromises).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">Bufferary</span>[i] = result[i];</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//開始發射</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//ns_sockets[0].emit(&#x27;bytemessage&#x27;,&#123; &quot;room&quot;: &#x27;room1&#x27;, &quot;bufdata&quot;: Bufferary[0] &#125; );</span></span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">var</span> file = files[i]</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//console.log(&#x27;發射:&#x27;+file.name )</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//socket.emit(&#x27;byte message&#x27;, &#123; image: true, buffer: Bufferary[i] &#125;);</span></span></span><br><span class="line"><span class="language-javascript">                            ns_sockets[<span class="number">1</span>].<span class="title function_">emit</span>(<span class="string">&#x27;bytemessage&#x27;</span>, &#123;<span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room2&#x27;</span>, <span class="string">&quot;bufdata&quot;</span>: <span class="title class_">Bufferary</span>[i]&#125;);</span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;,<span class="number">600</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#imgbtn3&#x27;</span>).<span class="title function_">click</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;imgbtn3:click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//讀所有的圖檔</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> uploadPromises = [];</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> files = $(<span class="string">&#x27;#imgfile3&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> <span class="title class_">Bufferary</span> = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(files.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> uploadPromise = <span class="title function_">getBufferFromFile</span>(files[i]);</span></span><br><span class="line"><span class="language-javascript">                uploadPromises.<span class="title function_">push</span>(uploadPromise);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="title class_">Promise</span>.<span class="title function_">all</span>(uploadPromises).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">Bufferary</span>[i] = result[i];</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//開始發射</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//ns_sockets[0].emit(&#x27;bytemessage&#x27;,&#123; &quot;room&quot;: &#x27;room1&#x27;, &quot;bufdata&quot;: Bufferary[0] &#125; );</span></span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">var</span> file = files[i]</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//console.log(&#x27;發射:&#x27;+file.name )</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//socket.emit(&#x27;byte message&#x27;, &#123; image: true, buffer: Bufferary[i] &#125;);</span></span></span><br><span class="line"><span class="language-javascript">                            ns_sockets[<span class="number">1</span>].<span class="title function_">emit</span>(<span class="string">&#x27;bytemessage&#x27;</span>, &#123;<span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room3&#x27;</span>, <span class="string">&quot;bufdata&quot;</span>: <span class="title class_">Bufferary</span>[i]&#125;);</span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;,<span class="number">600</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#imgbtn4&#x27;</span>).<span class="title function_">click</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;imgbtn4:click&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//讀所有的圖檔</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> uploadPromises = [];</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> files = $(<span class="string">&#x27;#imgfile4&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> <span class="title class_">Bufferary</span> = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(files.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> uploadPromise = <span class="title function_">getBufferFromFile</span>(files[i]);</span></span><br><span class="line"><span class="language-javascript">                uploadPromises.<span class="title function_">push</span>(uploadPromise);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="title class_">Promise</span>.<span class="title function_">all</span>(uploadPromises).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">Bufferary</span>[i] = result[i];</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//開始發射</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//ns_sockets[0].emit(&#x27;bytemessage&#x27;,&#123; &quot;room&quot;: &#x27;room1&#x27;, &quot;bufdata&quot;: Bufferary[0] &#125; );</span></span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.<span class="property">length</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">var</span> file = files[i]</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//console.log(&#x27;發射:&#x27;+file.name )</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">//socket.emit(&#x27;byte message&#x27;, &#123; image: true, buffer: Bufferary[i] &#125;);</span></span></span><br><span class="line"><span class="language-javascript">                            ns_sockets[<span class="number">1</span>].<span class="title function_">emit</span>(<span class="string">&#x27;bytemessage&#x27;</span>, &#123;<span class="string">&quot;room&quot;</span>: <span class="string">&#x27;room4&#x27;</span>, <span class="string">&quot;bufdata&quot;</span>: <span class="title class_">Bufferary</span>[i]&#125;);</span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;,<span class="number">600</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 二進位處理</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span>    <span class="title function_">handleBytemessage</span>(<span class="params">ns, idx</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;收到:&lt;bytemessage&gt;&#x27; + data.room + &#x27; buffdata :&#x27; + data.bufdata);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> checkBox = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;myCheck&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (checkBox.<span class="property">checked</span> != <span class="literal">true</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    idx = <span class="title function_">getidxfromroom</span>(data.<span class="property">room</span>) + <span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([data.<span class="property">bufdata</span>], &#123; <span class="attr">type</span>: <span class="string">&quot;image/jpeg&quot;</span> &#125;);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> urlCreator = <span class="variable language_">window</span>.<span class="property">URL</span> || <span class="variable language_">window</span>.<span class="property">webkitURL</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> imageUrl = urlCreator.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> img = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#photo&quot;</span> + idx);</span></span><br><span class="line"><span class="language-javascript">                    img.<span class="property">src</span> = imageUrl;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                data.<span class="property">bufdata</span>.<span class="property">length</span>=<span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 聊天處理</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleChatmessage</span>(<span class="params">ns, idx</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&lt;chatmessage&gt;&#x27;</span> + data.<span class="property">room</span> + <span class="string">&#x27; msg:&#x27;</span> + data.<span class="property">msg</span>);</span></span><br><span class="line"><span class="language-javascript">                idx = <span class="title function_">getidxfromroom</span>(data.<span class="property">room</span>)+<span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;idx&#x27; + idx);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> msglst = <span class="string">&#x27;#messages&#x27;</span> + idx;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(msglst);</span></span><br><span class="line"><span class="language-javascript">                $(msglst).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(data.<span class="property">msg</span>));</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// err 處理</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleErr</span>(<span class="params">ns, idx</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">room</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(ns.<span class="property">id</span>+<span class="string">&#x27; 收到:&lt;err&gt;加入&#x27;</span> + room);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// success 處理</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleSuccess</span>(<span class="params">ns, idx</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">room</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(ns.<span class="property">id</span>+<span class="string">&#x27; 收到:&lt;success&gt;加入&#x27;</span> + room);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 房間列表</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handlerooomsData</span>(<span class="params">ns, idx</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">roomlist</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&lt;rooomsData&gt;&#x27;</span> + roomlist);</span></span><br><span class="line"><span class="language-javascript">                roomlst = roomlist;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//加入房間</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> myroom = roomlist[idx];</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;client: &lt;createJoinRoom&gt;-room=&#x27;</span> + myroom);</span></span><br><span class="line"><span class="language-javascript">                ns.<span class="title function_">emit</span>(<span class="string">&#x27;createJoinRoom&#x27;</span>, myroom);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 斷線處理</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleDisconnect</span>(<span class="params">ns, idx</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&lt;disconnect&gt; ns-id:&#x27;</span>+ns.<span class="property">id</span>);</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 連線處理</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">handleConnect</span>(<span class="params">ns, idx</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&lt;connect&gt; ns-id:&#x27;</span>+ns.<span class="property">id</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 要求房間列表</span></span></span><br><span class="line"><span class="language-javascript">                ns.<span class="title function_">emit</span>(<span class="string">&#x27;getRooms&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">       </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">getidxfromroom</span>(<span class="params">room</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;roomlst.<span class="property">length</span>;i++)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span>(roomlst[i]== room) <span class="keyword">return</span> i;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> -<span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">getBufferFromFile</span>(<span class="params">file</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>( <span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                reader.<span class="title function_">readAsArrayBuffer</span>(file);</span></span><br><span class="line"><span class="language-javascript">                reader.<span class="property">onload</span>=<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> buf = reader.<span class="property">result</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">resolve</span>(buf);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                reader.<span class="property">onerror</span>=<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">reject</span>(<span class="string">&#x27;讀取檔案失敗&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h6 id="參考資訊"><a href="#參考資訊" class="headerlink" title="參考資訊"></a>參考資訊</h6><p><a href="https://gist.github.com/companje/0a42eb25dd3caff92ab7">https://gist.github.com/companje/0a42eb25dd3caff92ab7</a></p>
<p><a href="http://marklin-blog.logdown.com/posts/2907665-socket-io-talking-island">Socket.io 的說話島</a><br><a href="https://ipenywis.com/tutorials/Node.js-Socket.io-Namespaces,-Rooms-and-Connections-02">Node.js Socket.io Namespaces, Rooms and Connections 02</a><br><a href="https://www.jianshu.com/p/40d8bc17529f">socket.io+express多房间聊天应用</a><br><a href="https://stackoverflow.com/questions/13143945/dynamic-namespaces-socket-io">Dynamic Namespaces Socket.IO</a><br><a href="https://stackoverflow.com/questions/13504320/socket-io-namespaces-channels-co">Socket.io: Namespaces, channels &amp; co</a><br><a href="https://ithelp.ithome.com.tw/articles/10103528">且戰且走HTML5(5) 更深入Socket.IO</a><br><a href="http://psitsmike.com/2011/10/node-js-and-socket-io-multiroom-chat-tutorial/">node.js and socket.io multiroom chat tutorial</a><br><a href="https://stackoverflow.com/questions/29511404/connect-to-socket-io-server-with-specific-path-and-namespace">Connect to Socket.IO server with specific path and namespace</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E8%A8%98%E9%8C%84Nodejs-%E8%81%8A%E5%A4%A9%E5%92%8C%E5%9C%96%E7%89%87%E5%82%B3%E9%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs-%E8%81%8A%E5%A4%A9%E5%92%8C%E5%9C%96%E7%89%87%E5%82%B3%E9%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%A8%98%E9%8C%84Nodejs-%E8%81%8A%E5%A4%A9%E5%92%8C%E5%9C%96%E7%89%87%E5%82%B3%E9%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs-%E8%81%8A%E5%A4%A9%E5%92%8C%E5%9C%96%E7%89%87%E5%82%B3%E9%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">記錄Nodejs-聊天和圖片傳送的基本使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-05-07 13:42:30" itemprop="dateCreated datePublished" datetime="2019-05-07T13:42:30+00:00">2019-05-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A8%98%E9%8C%84/" itemprop="url" rel="index"><span itemprop="name">記錄</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A8%98%E9%8C%84/Nodejs/" itemprop="url" rel="index"><span itemprop="name">Nodejs</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>因為之前有測試可以使用陣列來相互傳送資料，這此想以之前的聊天的基礎上加入可以傳送圖片，只不過圖片是以byte陣列的方式來傳送，在收到之後在顯示，目前只能傳送jpg類型</p>
<h3 id="建立專案"><a href="#建立專案" class="headerlink" title="建立專案"></a>建立專案</h3><p>和聊天的專案是一樣的建立方式，先建立資料夾<code>byte-img-example</code> 剩下的參考基本聊天的設定在服務端的程式<code>index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)(http);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname+<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 有client連線</span></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    socket.<span class="property">broadcast</span>.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="string">&#x27;hi&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;an user connected&#x27;</span>);</span><br><span class="line">    <span class="comment">//client斷線</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;user disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;byte message&#x27;</span>,<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">        <span class="comment">//console.log(&#x27;byte message: &#x27;+ data.buffer);</span></span><br><span class="line">        <span class="comment">//收到訊息後，回傳給自已</span></span><br><span class="line">        io.<span class="title function_">emit</span>(<span class="string">&#x27;byte message&#x27;</span>,data);</span><br><span class="line">    &#125;);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;message: &#x27;</span>+ msg);</span><br><span class="line">        <span class="comment">//收到訊息後，回傳給自已</span></span><br><span class="line">        io.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,msg);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">http.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on *:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在客戶端的<code>index.html</code>裏</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>;<span class="attribute">box-sizing</span>: border-box; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123; <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#inputdiv</span> &#123; <span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">224</span>, <span class="number">188</span>, <span class="number">188</span>);<span class="attribute">padding</span>: <span class="number">3px</span>;<span class="attribute">position</span>: fixed;<span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">width</span>: <span class="number">50%</span>; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#msginput</span> &#123;<span class="attribute">border</span>: <span class="number">0</span>; <span class="attribute">width</span>: <span class="number">90%</span>; <span class="attribute">margin-right</span>: .<span class="number">5%</span> &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#msgbtn</span> &#123;<span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);<span class="attribute">border</span>: none;<span class="attribute">padding</span>: <span class="number">1px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123; <span class="attribute">list-style-type</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span> &#123; <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123; <span class="attribute">background</span>: <span class="number">#eee</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123; <span class="attribute">margin-bottom</span>: <span class="number">40px</span> &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;photo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>群聊<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;inputdiv&quot;</span>&gt;</span></span><br><span class="line">        輸入:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;msginput&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;msgbtn&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;imgfile&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;imgbtn&quot;</span> &gt;</span>發送圖片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-1.11.1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//網路相關</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> socket = <span class="title function_">io</span>();</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">on</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;收到:&#x27;+msg);</span></span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(msg));</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);    </span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">on</span>(<span class="string">&#x27;byte message&#x27;</span>, <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;byte message&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> bufView = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(data.<span class="property">buffer</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">buffer</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([data.<span class="property">buffer</span>], &#123; <span class="attr">type</span>: <span class="string">&quot;image/jpeg&quot;</span> &#125;);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> urlCreator = <span class="variable language_">window</span>.<span class="property">URL</span> || <span class="variable language_">window</span>.<span class="property">webkitURL</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> imageUrl = urlCreator.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//var img = document.querySelector(&quot;#photo&quot;);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//img.src = imageUrl;</span></span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">append</span>(</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&#x27;&lt;img&gt;&#x27;</span>).<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">100</span>).<span class="title function_">attr</span>(<span class="string">&#x27;src&#x27;</span>,imageUrl)</span></span><br><span class="line"><span class="language-javascript">                ));</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);    </span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//</span></span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#msgbtn&#x27;</span>).<span class="title function_">click</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> msg = $(<span class="string">&#x27;#msginput&#x27;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;發射:[&#x27; + msg + &#x27;]&#x27;);</span></span></span><br><span class="line"><span class="language-javascript">                socket.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>, msg);</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#msginput&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//發送圖片</span></span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#imgbtn&#x27;</span>).<span class="title function_">click</span>(<span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//console.log(&#x27;imgbtn:click&#x27;);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> file = $(<span class="string">&#x27;#imgfile&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>[<span class="number">0</span>];</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span></span><br><span class="line"><span class="language-javascript">                reader.<span class="title function_">readAsArrayBuffer</span>(file);</span></span><br><span class="line"><span class="language-javascript">                reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> arrayBuffer = e.<span class="property">target</span>.<span class="property">result</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//var bytes = new Uint8Array(arrayBuffer);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(arrayBuffer);</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    socket.<span class="title function_">emit</span>(<span class="string">&#x27;byte message&#x27;</span>, &#123; <span class="attr">image</span>: <span class="literal">true</span>, <span class="attr">buffer</span>: arrayBuffer &#125;);</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// var blob = new Blob([arrayBuffer], &#123; type: &quot;image/jpeg&quot; &#125;);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// var urlCreator = window.URL || window.webkitURL;</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// var imageUrl = urlCreator.createObjectURL(blob);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// var img = document.querySelector(&quot;#photo&quot;);</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// img.src = imageUrl;</span></span></span><br><span class="line"><span class="language-javascript">                &#125; </span></span><br><span class="line"><span class="language-javascript">               </span></span><br><span class="line"><span class="language-javascript">                <span class="comment">/* var selectedFile = $(&#x27;#imgfile&#x27;).get(0).files[0];</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                let reader = new FileReader();</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                reader.readAsArrayBuffer (selectedFile);  </span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                reader.onload = function () &#123;</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                    var arrayBuffer = this.result;</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                    var bufView = new Uint8Array(arrayBuffer);</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                    socket.emit(&#x27;byte message&#x27;, bufView);</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                &#125; */</span></span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>比較要注意的是在<strong>Socket.IO</strong>在陣列上只能傳送</p>
<ul>
<li><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/Blob">Blob</a> in the browser</p>
</li>
<li><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer</a> and <a href="https://nodejs.org/api/buffer.html">Buffer</a> in Node.js</p>
</li>
</ul>
<p>以下是讀取圖片資料和傳送到<strong>Socket.IO</strong>的程式片段</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">reader.<span class="title function_">readAsArrayBuffer</span>(file);</span><br><span class="line">reader.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> arrayBuffer = e.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(arrayBuffer);</span><br><span class="line">  socket.<span class="title function_">emit</span>(<span class="string">&#x27;byte message&#x27;</span>, &#123; <span class="attr">image</span>: <span class="literal">true</span>, <span class="attr">buffer</span>: arrayBuffer &#125;);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>以下是收到圖片資料和轉成html的圖片</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">socket.<span class="title function_">on</span>(<span class="string">&#x27;byte message&#x27;</span>, <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;byte message&#x27;</span>);</span><br><span class="line">            <span class="keyword">var</span> bufView = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(data.<span class="property">buffer</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">buffer</span>);</span><br><span class="line">            <span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([data.<span class="property">buffer</span>], &#123; <span class="attr">type</span>: <span class="string">&quot;image/jpeg&quot;</span> &#125;);</span><br><span class="line">            <span class="keyword">var</span> urlCreator = <span class="variable language_">window</span>.<span class="property">URL</span> || <span class="variable language_">window</span>.<span class="property">webkitURL</span>;</span><br><span class="line">            <span class="keyword">var</span> imageUrl = urlCreator.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line">           </span><br><span class="line">             $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">append</span>(</span><br><span class="line">                    $(<span class="string">&#x27;&lt;img&gt;&#x27;</span>).<span class="title function_">width</span>(<span class="number">100</span>).<span class="title function_">height</span>(<span class="number">100</span>).<span class="title function_">attr</span>(<span class="string">&#x27;src&#x27;</span>,imageUrl)</span><br><span class="line">                ));</span><br><span class="line">             <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);    </span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>

<h4 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h4><p><a href="https://socket.io/docs/#Sending-and-getting-data-acknowledgements">Socket.IO</a></p>
<p><a href="http://marklin-blog.logdown.com/posts/2907665-socket-io-talking-island">Socket.io 的說話島</a></p>
<p><a href="https://stackoverflow.com/questions/34056705/how-to-send-binary-data-with-socket-io">How to send binary data with socket.io?</a></p>
<p><a href="https://stackoverflow.com/questions/31433413/return-the-array-of-bytes-from-filereader">Return the Array of Bytes from FileReader()</a></p>
<p><a href="https://stackoverflow.com/questions/32556664/getting-byte-array-through-input-type-file">Getting byte array through input type &#x3D; file</a></p>
<p><a href="https://ithelp.ithome.com.tw/articles/10195525">DAY 30. JavaScript Blob, Buffer</a></p>
<p><a href="https://blog.csdn.net/NEUQ_zxy/article/details/77531126">socket.io简易教程</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E8%A8%98%E9%8C%84Nodejs-byte%E9%99%A3%E5%88%97%E5%82%B3%E9%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs-byte%E9%99%A3%E5%88%97%E5%82%B3%E9%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%A8%98%E9%8C%84Nodejs-byte%E9%99%A3%E5%88%97%E5%82%B3%E9%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs-byte%E9%99%A3%E5%88%97%E5%82%B3%E9%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">記錄Nodejs-byte陣列傳送的基本使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-05-06 16:25:25" itemprop="dateCreated datePublished" datetime="2019-05-06T16:25:25+00:00">2019-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A8%98%E9%8C%84/" itemprop="url" rel="index"><span itemprop="name">記錄</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A8%98%E9%8C%84/Nodejs/" itemprop="url" rel="index"><span itemprop="name">Nodejs</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="建立的步驟和聊天的一樣"><a href="#建立的步驟和聊天的一樣" class="headerlink" title="建立的步驟和聊天的一樣"></a>建立的步驟和聊天的一樣</h4><ul>
<li><p>設定資料夾<code>byte-example</code></p>
</li>
<li><p>設定<code>package.json</code> <code>npm init</code></p>
</li>
<li><p>安裝express <code>npm install -- save express</code></p>
</li>
<li><p>安裝 Sokcet.IO <code>npm install --save socket.io</code></p>
</li>
<li><p>將使用原來的<code>index.htm</code></p>
</li>
</ul>
<p>修改<code>index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app= <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)(http);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname+<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 有client連線</span></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    socket.<span class="property">broadcast</span>.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="string">&#x27;hi&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;an user connected&#x27;</span>);</span><br><span class="line">    <span class="comment">//client斷線</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;user disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;byte message&#x27;</span>,<span class="keyword">function</span>(<span class="params">byteary</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> bystring = byteary.<span class="title function_">toString</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;byte message: &#x27;</span>+ bystring);</span><br><span class="line">        <span class="comment">//收到訊息後，回傳給自已</span></span><br><span class="line">        io.<span class="title function_">emit</span>(<span class="string">&#x27;byte message&#x27;</span>,byteary);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">http.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on *:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p> 修改<code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>;<span class="attribute">box-sizing</span>: border-box; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123; <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> &#123; <span class="attribute">background</span>: <span class="number">#000</span>;<span class="attribute">padding</span>: <span class="number">3px</span>;<span class="attribute">position</span>: fixed;<span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">width</span>: <span class="number">100%</span>; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">input</span> &#123;<span class="attribute">border</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">10px</span>; <span class="attribute">width</span>: <span class="number">90%</span>; <span class="attribute">margin-right</span>: .<span class="number">5%</span> &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">button</span> &#123;<span class="attribute">width</span>: <span class="number">9%</span>;<span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);<span class="attribute">border</span>: none;<span class="attribute">padding</span>: <span class="number">10px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123; <span class="attribute">list-style-type</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span> &#123; <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123; <span class="attribute">background</span>: <span class="number">#eee</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123; <span class="attribute">margin-bottom</span>: <span class="number">40px</span> &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;m&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">button</span>&gt;</span>送出<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-1.11.1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> socket = <span class="title function_">io</span>();</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;form&#x27;</span>).<span class="title function_">submit</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                e.<span class="title function_">preventDefault</span>();<span class="comment">//prevent page reloading</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> bufArr = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">4</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> bufView = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(bufArr);</span></span><br><span class="line"><span class="language-javascript">                bufView[<span class="number">0</span>]=<span class="number">6</span>;</span></span><br><span class="line"><span class="language-javascript">                bufView[<span class="number">1</span>]=<span class="number">7</span>;</span></span><br><span class="line"><span class="language-javascript">                bufView[<span class="number">2</span>]=<span class="number">8</span>;</span></span><br><span class="line"><span class="language-javascript">                bufView[<span class="number">3</span>]=<span class="number">9</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> bystring = bufView.<span class="title function_">toString</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> msg=$(<span class="string">&#x27;#m&#x27;</span>).<span class="property">val</span>=bystring;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;發射:[&#x27;</span>+msg+<span class="string">&#x27;]&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                socket.<span class="title function_">emit</span>(<span class="string">&#x27;byte message&#x27;</span>, msg);</span></span><br><span class="line"><span class="language-javascript">               </span></span><br><span class="line"><span class="language-javascript">                <span class="comment">//$(&#x27;#m&#x27;).val(&#x27;&#x27;);</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">on</span>(<span class="string">&#x27;byte message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&#x27;</span>+msg);</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(msg));</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);    </span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">on</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&#x27;</span>+msg);</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(msg));</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E8%A8%98%E9%8C%84Nodejs-%E8%81%8A%E5%A4%A9%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs-%E8%81%8A%E5%A4%A9%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%A8%98%E9%8C%84Nodejs-%E8%81%8A%E5%A4%A9%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/%E8%A8%98%E9%8C%84Nodejs-%E8%81%8A%E5%A4%A9%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">記錄Nodejs-聊天的基本使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-05-06 13:35:34" itemprop="dateCreated datePublished" datetime="2019-05-06T13:35:34+00:00">2019-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A8%98%E9%8C%84/" itemprop="url" rel="index"><span itemprop="name">記錄</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A8%98%E9%8C%84/Nodejs/" itemprop="url" rel="index"><span itemprop="name">Nodejs</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="建立基本卿天架構"><a href="#建立基本卿天架構" class="headerlink" title="建立基本卿天架構"></a>建立基本卿天架構</h3><p>先在資料夾建立<code>chat-example</code>的資料夾</p>
<h4 id="設定package-json"><a href="#設定package-json" class="headerlink" title="設定package.json"></a>設定package.json</h4><p>先建立一個資料夾叫helloexpress, 在到它的目錄下使用命令列，下下面的指令<code>npm init</code>先建立<code>package.json</code>,它會問些問題，會將資料寫入<code>package.json</code>按照需要輸入或是直接按下不輸入</p>
<h4 id="安裝express"><a href="#安裝express" class="headerlink" title="安裝express"></a>安裝express</h4><p>在命令列下<code>npm install --save express</code>,它會建立<code>node_modules</code>的資料夾和將相關的程式碼放到此目錄</p>
<h4 id="建立index-js"><a href="#建立index-js" class="headerlink" title="建立index.js"></a>建立index.js</h4><p>在和<code>package.json</code>的相同目錄下，建立<code>index.js</code>，這是程式執行的地方輸入如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;&lt;h1&gt;Hello express&lt;/h1&gt;&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on *:3000&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在命令列下輸入<code>node index.js</code>接下來在瀏覽器中輸入<code>http://127.0.0.1:3000</code>在瀏覽器的畫面會顯示<code>&lt;h1&gt;Hello express&lt;/h1&gt;</code></p>
<h3 id="建立網頁"><a href="#建立網頁" class="headerlink" title="建立網頁"></a>建立網頁</h3><p>我們要向client送出設定好的網頁，可以修改<code>index.js</code>的碼如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app= <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname+<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">http.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on *:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>向client端送的<code>index.html</code>的內容如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>;<span class="attribute">box-sizing</span>: border-box; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123; <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> &#123; <span class="attribute">background</span>: <span class="number">#000</span>;<span class="attribute">padding</span>: <span class="number">3px</span>;<span class="attribute">position</span>: fixed;<span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">width</span>: <span class="number">100%</span>; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">input</span> &#123;<span class="attribute">border</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">10px</span>; <span class="attribute">width</span>: <span class="number">90%</span>; <span class="attribute">margin-right</span>: .<span class="number">5%</span> &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">button</span> &#123;<span class="attribute">width</span>: <span class="number">9%</span>;<span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);<span class="attribute">border</span>: none;<span class="attribute">padding</span>: <span class="number">10px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#message</span> &#123;<span class="attribute">list-style-type</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#message</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123; <span class="attribute">background</span>: <span class="number">#eee</span> &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;message&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;m&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">button</span>&gt;</span>送出<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="加入Socket-IO"><a href="#加入Socket-IO" class="headerlink" title="加入Socket.IO"></a>加入Socket.IO</h3><p>以下的指令來安裝</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save socket.io</span><br></pre></td></tr></table></figure>

<p>來修改index.js如下加入<code>var io = require(&#39;socket.io&#39;)(http);</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app= <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).<span class="title function_">createServer</span>(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)(http);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname+<span class="string">&#x27;/index.html&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;an user connected&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">http.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on *:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在修改給client端的<code>index.html</code>的端如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>;<span class="attribute">box-sizing</span>: border-box; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123; <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> &#123; <span class="attribute">background</span>: <span class="number">#000</span>;<span class="attribute">padding</span>: <span class="number">3px</span>;<span class="attribute">position</span>: fixed;<span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">width</span>: <span class="number">100%</span>; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">input</span> &#123;<span class="attribute">border</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">10px</span>; <span class="attribute">width</span>: <span class="number">90%</span>; <span class="attribute">margin-right</span>: .<span class="number">5%</span> &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">button</span> &#123;<span class="attribute">width</span>: <span class="number">9%</span>;<span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);<span class="attribute">border</span>: none;<span class="attribute">padding</span>: <span class="number">10px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#message</span> &#123;<span class="attribute">list-style-type</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#message</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123; <span class="attribute">background</span>: <span class="number">#eee</span> &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;message&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;m&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">button</span>&gt;</span>送出<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> socket = <span class="title function_">io</span>();</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在console的模式下顯示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listening on *:3000</span><br><span class="line">index.js:13</span><br><span class="line">an user connected</span><br><span class="line">index.js:10</span><br><span class="line">an user connected</span><br><span class="line">index.js:10</span><br><span class="line">an user connected</span><br></pre></td></tr></table></figure>

<p>加入<code>disconnect</code>的事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;an user connected&#x27;</span>);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;user disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在console的模式下顯示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">an user connected</span><br><span class="line">index.js:10</span><br><span class="line">user disconnected</span><br><span class="line">index.js:12</span><br><span class="line">an user connected</span><br><span class="line">index.js:10</span><br><span class="line">user disconnected</span><br><span class="line">index.js:12</span><br><span class="line">an user connected</span><br></pre></td></tr></table></figure>

<h3 id="發射事件"><a href="#發射事件" class="headerlink" title="發射事件"></a>發射事件</h3><p>使用JQuery來取得html上的元件和資料來發送聊天訊息在<code>index.html</code>中修改</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>;<span class="attribute">box-sizing</span>: border-box; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123; <span class="attribute">font</span>: <span class="number">13px</span> Helvetica, Arail; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> &#123; <span class="attribute">background</span>: <span class="number">#000</span>;<span class="attribute">padding</span>: <span class="number">3px</span>;<span class="attribute">position</span>: fixed;<span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">width</span>: <span class="number">100%</span>; &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">input</span> &#123;<span class="attribute">border</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">10px</span>; <span class="attribute">width</span>: <span class="number">90%</span>; <span class="attribute">margin-right</span>: .<span class="number">5%</span> &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">form</span> <span class="selector-tag">button</span> &#123;<span class="attribute">width</span>: <span class="number">9%</span>;<span class="attribute">background</span>: <span class="built_in">rgb</span>(<span class="number">130</span>, <span class="number">224</span>, <span class="number">225</span>);<span class="attribute">border</span>: none;<span class="attribute">padding</span>: <span class="number">10px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123; <span class="attribute">list-style-type</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span> &#123; <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) &#123; <span class="attribute">background</span>: <span class="number">#eee</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#messages</span> &#123; <span class="attribute">margin-bottom</span>: <span class="number">40px</span> &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;m&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">button</span>&gt;</span>送出<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-1.11.1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> socket = <span class="title function_">io</span>();</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;form&#x27;</span>).<span class="title function_">submit</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                e.<span class="title function_">preventDefault</span>();<span class="comment">//prevent page reloading</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> msg=$(<span class="string">&#x27;#m&#x27;</span>).<span class="title function_">val</span>()</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(msg);</span></span><br><span class="line"><span class="language-javascript">                socket.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>, msg);</span></span><br><span class="line"><span class="language-javascript">               </span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#m&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>index.js</code>中修改</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有client連線</span></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;an user connected&#x27;</span>);</span><br><span class="line">    <span class="comment">//client斷線</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;user disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//接收到事件</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;message: &#x27;</span>+ msg);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="廣播訊息"><a href="#廣播訊息" class="headerlink" title="廣播訊息"></a>廣播訊息</h4><p>要將訊息傳給client端可以使用<code>emit</code>這個功能,使用如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">socket.<span class="property">broadcast</span>.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,msg);<span class="comment">//除了自已不會收到，其餘的會收到</span></span><br><span class="line">io.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,msg);<span class="comment">//全部都會收到，包括自已</span></span><br></pre></td></tr></table></figure>

<p>在<code>index.js</code>中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有client連線</span></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>,<span class="keyword">function</span>(<span class="params">socket</span>)&#123;</span><br><span class="line">    socket.<span class="property">broadcast</span>.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="string">&#x27;hi&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;an user connected&#x27;</span>);</span><br><span class="line">    <span class="comment">//client斷線</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;user disconnected&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span><br><span class="line">        <span class="comment">//console.log(&#x27;message: &#x27;+ msg);</span></span><br><span class="line">        <span class="comment">//收到訊息後，回傳給自已</span></span><br><span class="line">        io.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>,msg);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在<code>index.html</code>中</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;m&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">button</span>&gt;</span>送出<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-1.11.1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> socket = <span class="title function_">io</span>();</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;form&#x27;</span>).<span class="title function_">submit</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                e.<span class="title function_">preventDefault</span>();<span class="comment">//prevent page reloading</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> msg=$(<span class="string">&#x27;#m&#x27;</span>).<span class="title function_">val</span>()</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;發射:&#x27;</span>+msg);</span></span><br><span class="line"><span class="language-javascript">                socket.<span class="title function_">emit</span>(<span class="string">&#x27;chat message&#x27;</span>, msg);</span></span><br><span class="line"><span class="language-javascript">               </span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#m&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">on</span>(<span class="string">&#x27;chat message&#x27;</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到:&#x27;</span>+msg);</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&#x27;#messages&#x27;</span>).<span class="title function_">append</span>($(<span class="string">&#x27;&lt;li&gt;&#x27;</span>).<span class="title function_">text</span>(msg));</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);    </span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>








      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一頁" aria-label="上一頁" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="下一頁" aria-label="下一頁" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2018 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Tom Tang</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="回到頂端">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '60px',
  right: 'unset',
  left: '60px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
