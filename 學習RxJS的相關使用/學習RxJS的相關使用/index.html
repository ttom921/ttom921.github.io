<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ttom921.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言學習一下Rxjs的相關使用,目前的範例大多是v5之前，所以記錄和學習v6的相關修改 以下的例子可以看到，當b$和c$有變化時，a$也會跟著變化 123456789101112131415161718192021import &#123; from &#125; from &#x27;rxjs&#x27;;import &#123; zip, of &#125; from &#x27;rxjs&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="學習Rxjs的相關使用">
<meta property="og:url" content="https://ttom921.github.io/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="被施工的Tom的記錄">
<meta property="og:description" content="前言學習一下Rxjs的相關使用,目前的範例大多是v5之前，所以記錄和學習v6的相關修改 以下的例子可以看到，當b$和c$有變化時，a$也會跟著變化 123456789101112131415161718192021import &#123; from &#125; from &#x27;rxjs&#x27;;import &#123; zip, of &#125; from &#x27;rxjs&amp;">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://ttom921.github.io/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/getBoundingClientRect.png">
<meta property="og:image" content="https://ttom921.github.io/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/2019-07-17_09_46_19_Image.png">
<meta property="og:image" content="https://ttom921.github.io/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/2019-07-18_09_42_04_Image.png">
<meta property="og:image" content="https://ttom921.github.io/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/2019-07-18_10_01_12_Image.png">
<meta property="article:published_time" content="2019-05-29T09:58:50.000Z">
<meta property="article:modified_time" content="2024-03-03T14:22:03.394Z">
<meta property="article:author" content="Tom Tang">
<meta property="article:tag" content="RxJS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ttom921.github.io/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/getBoundingClientRect.png">


<link rel="canonical" href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-TW","comments":true,"permalink":"https://ttom921.github.io/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/","path":"學習RxJS的相關使用/學習RxJS的相關使用/","title":"學習Rxjs的相關使用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>學習Rxjs的相關使用 | 被施工的Tom的記錄</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">被施工的Tom的記錄</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">異想世界</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜尋" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RxJS%E7%9A%84%E4%BD%BF%E7%94%A8%E5%8F%83%E8%80%83"><span class="nav-number">2.</span> <span class="nav-text">RxJS的使用參考</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RxJS%E8%A6%81%E9%BB%9E"><span class="nav-number">3.</span> <span class="nav-text">RxJS要點</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E9%BA%BC%E6%98%AF-Observable"><span class="nav-number">4.</span> <span class="nav-text">什麼是 Observable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%80%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.</span> <span class="nav-text">觀察者模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%B5%E5%BB%BAObservable"><span class="nav-number">6.</span> <span class="nav-text">創建Observable</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="nav-number">6.1.</span> <span class="nav-text">同步的例子</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%95%B0%E6%AD%A5%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="nav-number">6.2.</span> <span class="nav-text">異步的例子</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%80%E5%AF%9F%E8%80%85Observer"><span class="nav-number">7.</span> <span class="nav-text">觀察者Observer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%A6%E4%BD%9C%E7%B4%B0%E7%AF%80"><span class="nav-number">8.</span> <span class="nav-text">實作細節</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-Observable-%E4%BA%8C"><span class="nav-number">9.</span> <span class="nav-text">建立 Observable(二)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#of"><span class="nav-number">9.1.</span> <span class="nav-text">of</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#from"><span class="nav-number">9.2.</span> <span class="nav-text">from</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fromEvent"><span class="nav-number">9.3.</span> <span class="nav-text">fromEvent</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#fromEventPattern"><span class="nav-number">9.3.1.</span> <span class="nav-text">fromEventPattern</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#empty-never-throw"><span class="nav-number">9.4.</span> <span class="nav-text">empty,never,throw</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#interval-timer"><span class="nav-number">9.5.</span> <span class="nav-text">interval,timer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Subscription"><span class="nav-number">9.6.</span> <span class="nav-text">Subscription</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Observable-Operators-Marble-Diagrams"><span class="nav-number">10.</span> <span class="nav-text">Observable Operators &amp; Marble Diagrams</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E9%BA%BC%E6%98%AFOperator"><span class="nav-number">10.1.</span> <span class="nav-text">什麼是Operator?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Marble-diagrams"><span class="nav-number">10.2.</span> <span class="nav-text">Marble diagrams</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Operators"><span class="nav-number">10.3.</span> <span class="nav-text">Operators</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#map"><span class="nav-number">10.3.1.</span> <span class="nav-text">map</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mapTo"><span class="nav-number">10.3.2.</span> <span class="nav-text">mapTo</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#filter"><span class="nav-number">10.3.3.</span> <span class="nav-text">filter</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#take"><span class="nav-number">10.3.4.</span> <span class="nav-text">take</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#first"><span class="nav-number">10.3.5.</span> <span class="nav-text">first</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#takeUntil"><span class="nav-number">10.3.6.</span> <span class="nav-text">takeUntil</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#concatAll"><span class="nav-number">10.3.7.</span> <span class="nav-text">concatAll</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%B0%A1%E6%98%93%E6%8B%96%E6%8B%89"><span class="nav-number">10.3.8.</span> <span class="nav-text">簡易拖拉</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#skip"><span class="nav-number">10.3.9.</span> <span class="nav-text">skip</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#takeLast"><span class="nav-number">10.3.10.</span> <span class="nav-text">takeLast</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#last"><span class="nav-number">10.3.11.</span> <span class="nav-text">last</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#concat"><span class="nav-number">10.3.12.</span> <span class="nav-text">concat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#startWith"><span class="nav-number">10.3.13.</span> <span class="nav-text">startWith</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#merge"><span class="nav-number">10.3.14.</span> <span class="nav-text">merge</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#combineLatest"><span class="nav-number">10.3.15.</span> <span class="nav-text">combineLatest</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#zip"><span class="nav-number">10.3.16.</span> <span class="nav-text">zip</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#withLastestFrom"><span class="nav-number">10.3.17.</span> <span class="nav-text">withLastestFrom</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AF%A6%E5%8B%99%E7%AF%84%E4%BE%8B-%E5%AE%8C%E6%95%B4%E6%8B%96%E6%8B%89%E6%87%89%E7%94%A8"><span class="nav-number">10.3.18.</span> <span class="nav-text">實務範例-完整拖拉應用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-number">10.3.18.1.</span> <span class="nav-text">需求分析</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%8F%96%E5%BE%97%E6%9C%83%E7%94%A8%E5%88%B0%E7%9A%84DOM"><span class="nav-number">10.3.18.2.</span> <span class="nav-text">第一步取得會用到的DOM</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E5%BB%BA%E7%AB%8B%E6%9C%83%E7%94%A8%E5%88%B0%E7%9A%84observable"><span class="nav-number">10.3.18.3.</span> <span class="nav-text">第二步建立會用到的observable</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%E6%92%B0%E5%AF%AB%E7%A8%8B%E5%BC%8F%E9%82%8F%E8%BC%AF"><span class="nav-number">10.3.18.4.</span> <span class="nav-text">第三步撰寫程式邏輯</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%8F%96%E5%BE%97%E6%9C%83%E7%94%A8%E5%88%B0%E7%9A%84DOM-1"><span class="nav-number">10.3.18.5.</span> <span class="nav-text">第一步取得會用到的DOM</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E5%BB%BA%E7%AB%8B%E6%9C%83%E7%94%A8%E5%88%B0%E7%9A%84observable-1"><span class="nav-number">10.3.18.6.</span> <span class="nav-text">第二步建立會用到的observable</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%E6%92%B0%E5%AF%AB%E7%A8%8B%E5%BC%8F%E9%82%8F%E8%BC%AF-1"><span class="nav-number">10.3.18.7.</span> <span class="nav-text">第三步撰寫程式邏輯</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#scan-buffer"><span class="nav-number">10.4.</span> <span class="nav-text">scan,buffer</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#scan"><span class="nav-number">10.4.1.</span> <span class="nav-text">scan</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#buffer"><span class="nav-number">10.4.2.</span> <span class="nav-text">buffer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#delay-delayWhen"><span class="nav-number">10.5.</span> <span class="nav-text">delay,delayWhen</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#delay"><span class="nav-number">10.5.1.</span> <span class="nav-text">delay</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#delayWhen"><span class="nav-number">10.5.2.</span> <span class="nav-text">delayWhen</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#throttle-debounce"><span class="nav-number">10.6.</span> <span class="nav-text">throttle,debounce</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#debounce"><span class="nav-number">10.6.1.</span> <span class="nav-text">debounce</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#throttle"><span class="nav-number">10.6.2.</span> <span class="nav-text">throttle</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#distinct-distinctUntilChanged"><span class="nav-number">10.7.</span> <span class="nav-text">distinct,distinctUntilChanged</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#distinct"><span class="nav-number">10.7.1.</span> <span class="nav-text">distinct</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#distinctUntilChanged"><span class="nav-number">10.7.2.</span> <span class="nav-text">distinctUntilChanged</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#catchError-retry-retryWhen-repeat"><span class="nav-number">10.8.</span> <span class="nav-text">catchError,retry,retryWhen,repeat</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#catchError"><span class="nav-number">10.8.1.</span> <span class="nav-text">catchError</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#retry"><span class="nav-number">10.8.2.</span> <span class="nav-text">retry</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#retyrWhen"><span class="nav-number">10.8.3.</span> <span class="nav-text">retyrWhen</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#repeat"><span class="nav-number">10.8.4.</span> <span class="nav-text">repeat</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#switchAll-mergeAll-concatAll"><span class="nav-number">10.9.</span> <span class="nav-text">switchAll, mergeAll, concatAll</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#concatAll-1"><span class="nav-number">10.9.1.</span> <span class="nav-text">concatAll</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#switchAll"><span class="nav-number">10.9.2.</span> <span class="nav-text">switchAll</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#margeAll"><span class="nav-number">10.9.3.</span> <span class="nav-text">margeAll</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#switchMap-mergeMap-concatMap"><span class="nav-number">10.10.</span> <span class="nav-text">switchMap, mergeMap, concatMap</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#concatMap"><span class="nav-number">10.10.1.</span> <span class="nav-text">concatMap</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#switchMap"><span class="nav-number">10.10.2.</span> <span class="nav-text">switchMap</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mergeMap"><span class="nav-number">10.10.3.</span> <span class="nav-text">mergeMap</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B0%A1%E6%98%93Auto-Complete%E5%AF%A6%E4%BD%9C"><span class="nav-number">10.11.</span> <span class="nav-text">簡易Auto Complete實作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1"><span class="nav-number">10.12.</span> <span class="nav-text">需求分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%8F%96%E5%BE%97%E9%9C%80%E8%A6%81%E7%9A%84DOM%E7%89%A9%E4%BB%B6"><span class="nav-number">10.12.1.</span> <span class="nav-text">第一步取得需要的DOM物件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%8C%E5%BB%BA%E7%AB%8B%E6%89%80%E9%9C%80%E7%9A%84Observable"><span class="nav-number">10.12.2.</span> <span class="nav-text">第二步，建立所需的Observable</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%8C%E6%92%B0%E5%AF%AB%E7%A8%8B%E5%BC%8F%E9%82%8F%E8%BC%AF"><span class="nav-number">10.12.3.</span> <span class="nav-text">第三步，撰寫程式邏輯</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#window-windowToggle"><span class="nav-number">10.13.</span> <span class="nav-text">window, windowToggle</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#window"><span class="nav-number">10.13.1.</span> <span class="nav-text">window</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#windowToggle"><span class="nav-number">10.13.2.</span> <span class="nav-text">windowToggle</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#groubBy"><span class="nav-number">10.13.3.</span> <span class="nav-text">groubBy</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B1%E5%85%A5Observable"><span class="nav-number">11.</span> <span class="nav-text">深入Observable</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%B6%E9%81%B2%E9%81%8B%E7%AE%97"><span class="nav-number">11.1.</span> <span class="nav-text">延遲運算</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%B8%E9%80%B2%E5%BC%8F%E5%8F%96%E5%80%BC"><span class="nav-number">11.2.</span> <span class="nav-text">漸進式取值</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E9%BA%BC%E6%98%AFSubject"><span class="nav-number">12.</span> <span class="nav-text">什麼是Subject?</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Subject%E5%9F%BA%E6%9C%AC%E8%A7%80%E5%BF%B5"><span class="nav-number">12.1.</span> <span class="nav-text">Subject基本觀念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%8B%E5%8B%95%E5%BB%BA%E7%AB%8Bsubject"><span class="nav-number">12.2.</span> <span class="nav-text">手動建立subject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E9%BA%BC%E6%98%AFSubjet"><span class="nav-number">12.3.</span> <span class="nav-text">什麼是Subjet?</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Subject-BehaviorSubject-ReplaySubject-AsyncSubject"><span class="nav-number">13.</span> <span class="nav-text">Subject, BehaviorSubject, ReplaySubject, AsyncSubject</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Subject"><span class="nav-number">13.1.</span> <span class="nav-text">Subject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BehaviorSubject"><span class="nav-number">13.2.</span> <span class="nav-text">BehaviorSubject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ReplaySubject"><span class="nav-number">13.3.</span> <span class="nav-text">ReplaySubject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AsyncSubject"><span class="nav-number">13.4.</span> <span class="nav-text">AsyncSubject</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#multicast-refCount-publish-share"><span class="nav-number">14.</span> <span class="nav-text">multicast, refCount, publish, share</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#multicast"><span class="nav-number">14.1.</span> <span class="nav-text">multicast</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#refCount"><span class="nav-number">14.2.</span> <span class="nav-text">refCount</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#publish"><span class="nav-number">14.3.</span> <span class="nav-text">publish</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#share"><span class="nav-number">14.4.</span> <span class="nav-text">share</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Subject%E7%B8%BD%E7%B5%90"><span class="nav-number">15.</span> <span class="nav-text">Subject總結</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Subject%E8%88%87Observable%E7%9A%84%E5%B7%AE%E7%95%B0"><span class="nav-number">15.1.</span> <span class="nav-text">Subject與Observable的差異</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E5%AE%9A%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8Subject%E7%9A%84%E6%99%82%E6%A9%9F"><span class="nav-number">15.2.</span> <span class="nav-text">一定需要使用Subject的時機</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B0%A1%E6%98%93%E5%AF%A6%E4%BD%9CObservable-%E4%B8%80"><span class="nav-number">16.</span> <span class="nav-text">簡易實作Observable(一)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E9%BB%9E%E8%A7%80%E5%BF%B5"><span class="nav-number">16.1.</span> <span class="nav-text">重點觀念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%ACobservable%E5%AF%A6%E4%BD%9C"><span class="nav-number">16.2.</span> <span class="nav-text">基本observable實作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%A6%E4%BD%9C%E7%B0%A1%E6%98%93Observer"><span class="nav-number">16.3.</span> <span class="nav-text">實作簡易Observer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B0%A1%E6%98%93%E5%AF%A6%E4%BD%9CObservable-%E4%BA%8C"><span class="nav-number">17.</span> <span class="nav-text">簡易實作Observable(二)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E7%B0%A1%E6%98%93Observable%E9%A1%9E%E5%88%A5"><span class="nav-number">17.1.</span> <span class="nav-text">建立簡易Observable類別</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8Bcreation-operator-fromArray"><span class="nav-number">17.2.</span> <span class="nav-text">建立creation operator - fromArray</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8Btransform-operator-map"><span class="nav-number">17.3.</span> <span class="nav-text">建立transform operator - map</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Scheduler%E5%9F%BA%E6%9C%AC%E8%A7%80%E5%BF%B5"><span class="nav-number">17.4.</span> <span class="nav-text">Scheduler基本觀念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E9%BA%BC%E6%98%AFScheduler"><span class="nav-number">17.5.</span> <span class="nav-text">什麼是Scheduler?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%89%E5%93%AA%E4%BA%9BScheduler%E5%8F%AF%E4%BB%A5%E7%94%A8"><span class="nav-number">17.6.</span> <span class="nav-text">有哪些Scheduler可以用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Scheduler"><span class="nav-number">17.7.</span> <span class="nav-text">使用Scheduler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#queue"><span class="nav-number">17.8.</span> <span class="nav-text">queue</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%83%85%E5%A2%83"><span class="nav-number">17.8.1.</span> <span class="nav-text">使用情境</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#asap"><span class="nav-number">17.9.</span> <span class="nav-text">asap</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%83%85%E5%A2%83-1"><span class="nav-number">17.9.1.</span> <span class="nav-text">使用情境</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#async"><span class="nav-number">17.10.</span> <span class="nav-text">async</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#animationFrame"><span class="nav-number">17.11.</span> <span class="nav-text">animationFrame</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%83%85%E5%A2%83-2"><span class="nav-number">17.11.1.</span> <span class="nav-text">使用情境</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cold-Hot-Observable"><span class="nav-number">18.</span> <span class="nav-text">Cold&amp;Hot Observable</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Cold-Observable"><span class="nav-number">18.1.</span> <span class="nav-text">Cold Observable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hot-Observable"><span class="nav-number">18.2.</span> <span class="nav-text">Hot Observable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Cold%E8%88%87Hot"><span class="nav-number">18.3.</span> <span class="nav-text">Cold與Hot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8F%E7%B5%90"><span class="nav-number">18.4.</span> <span class="nav-text">小結</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95Debug%EF%BC%9F"><span class="nav-number">19.</span> <span class="nav-text">如何Debug？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RxJS%E5%A6%82%E4%BD%95%E9%99%A4%E9%8C%AF%EF%BC%9F"><span class="nav-number">19.1.</span> <span class="nav-text">RxJS如何除錯？</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#tap"><span class="nav-number">19.1.1.</span> <span class="nav-text">tap</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Observable%E9%96%93%E7%9A%84%E9%97%9C%E8%81%AF%E5%9C%96"><span class="nav-number">19.2.</span> <span class="nav-text">Observable間的關聯圖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Marble-Diagram"><span class="nav-number">19.3.</span> <span class="nav-text">Marble Diagram</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><span class="nav-number">19.3.0.1.</span> <span class="nav-text">參考資料</span></a></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Tom Tang</p>
  <div class="site-description" itemprop="description">記錄有的沒有的</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92RxJS%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="學習Rxjs的相關使用 | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          學習Rxjs的相關使用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-05-29 09:58:50" itemprop="dateCreated datePublished" datetime="2019-05-29T09:58:50+00:00">2019-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/" itemprop="url" rel="index"><span itemprop="name">學習</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/Angular/" itemprop="url" rel="index"><span itemprop="name">Angular</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/Angular/RxJS/" itemprop="url" rel="index"><span itemprop="name">RxJS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>學習一下Rxjs的相關使用,目前的範例大多是v5之前，所以記錄和學習v6的相關修改</p>
<p>以下的例子可以看到，當<code>b$</code>和<code>c$</code>有變化時，<code>a$</code>也會跟著變化</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b$ = <span class="title function_">from</span>([<span class="number">1</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="keyword">var</span> c$ = <span class="title function_">from</span>([<span class="number">2</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="keyword">var</span> a$ = <span class="title function_">zip</span>(b$, c$, <span class="function">(<span class="params">b, c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;b=&#x27;</span> + b);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;c=&#x27;</span> + c);</span><br><span class="line">    <span class="keyword">return</span> b + c;</span><br><span class="line">&#125;);</span><br><span class="line">a$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">a</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;a=&#x27;</span> + a);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//b=1 ​​​​​at ​​​&#x27;b=&#x27; + b​​​</span></span><br><span class="line"><span class="comment">//c=2 ​​​​​at ​​​&#x27;c=&#x27; + c​​​ </span></span><br><span class="line"><span class="comment">//a=3 ​​​​​at ​​​&#x27;a=&#x27; + a​​​ </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//b=3 ​​​​​at ​​​&#x27;b=&#x27; + b​​​ </span></span><br><span class="line"><span class="comment">//c=2 ​​​​​at ​​​&#x27;c=&#x27; + c​​​ </span></span><br><span class="line"><span class="comment">//a=5 ​​​​​at ​​​&#x27;a=&#x27; + a​​​ </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="RxJS的使用參考"><a href="#RxJS的使用參考" class="headerlink" title="RxJS的使用參考"></a>RxJS的使用參考</h3><ol>
<li><p>創建Obserable的方法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span>, <span class="title class_">Subject</span>, asapScheduler, pipe, <span class="keyword">of</span>, <span class="keyword">from</span>, interval, merge, fromEvent, <span class="title class_">SubscriptionLike</span>, <span class="title class_">PartialObserver</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>操作符operators</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; map, filter, scan &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>websocket</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; webSocket &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/webSocket&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>ajax</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ajax &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/ajax&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>代表流的變量用＄符號結尾，是RxJS中的一種慣例</strong></p>
<h3 id="RxJS要點"><a href="#RxJS要點" class="headerlink" title="RxJS要點"></a>RxJS要點</h3><p>RxJS有一個核心和三個重點，一個核心是<code>Obserable</code> 再加上相關的<code>Operators</code>,三個重點分別是<code>Observer</code>,<code>Subject</code>,<code>Schedulers</code>。</p>
<h3 id="什麼是-Observable"><a href="#什麼是-Observable" class="headerlink" title="什麼是 Observable"></a>什麼是 Observable</h3><p>在文檔中說的<strong>Observable</strong>更確切的說法是<strong>Observable Stream</strong>，也就是Rx的響應式數據流。</p>
<p>在RxJS中<strong>Observable</strong>是可被觀察者，觀察者則是<strong>Observer</strong>，它們通過Observable的subscribe方法進行關聯</p>
<p>前面提到了RxJS結合了觀察者模式和迭代器模式</p>
<p>對于觀察者模式，我們其實比較熟悉的比如各種DOM事的監聽，也是觀察者模式的一種實踐。核心就是發佈者發佈事件，觀察者選擇時機去訂閱(subscibe)事件。</p>
<p>在ES6中Array,String等可遍歷的數據結構原生部署了迭代器(iterator)接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">const</span> iterator= numbers[<span class="title class_">Symbol</span>.<span class="property">iterator</span>]();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(iterator.<span class="title function_">next</span>());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(iterator.<span class="title function_">next</span>());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(iterator.<span class="title function_">next</span>());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(iterator.<span class="title function_">next</span>());</span><br><span class="line"><span class="comment">//&#123; value: 1, done: false &#125; </span></span><br><span class="line"><span class="comment">//&#123; value: 2, done: false &#125; </span></span><br><span class="line"><span class="comment">//&#123; value: 3, done: false &#125; </span></span><br><span class="line"><span class="comment">//&#123; value: undefined, done: true &#125; </span></span><br></pre></td></tr></table></figure>

<p>觀察者模式和迭代器模式的相同之處是兩者都是漸進式使用數據的，只不過從數據使用者的角度來說，觀察者模式數據是推送<strong>push</strong>過來的，而迭代器模式𣆞自已去拉取<strong>pull</strong>的，Rx中的數據是Observable推送的，觀察者不需要主重去拉取。</p>
<p>Obserable與Array相當類似，都可以看作是Collection只不過Observable是<code>a collection of items over time</code>是隨時間發出的一序列元素，所以下面會看到Obserable的一些操作符與Array的方法極其相似</p>
<h3 id="觀察者模式"><a href="#觀察者模式" class="headerlink" title="觀察者模式"></a>觀察者模式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//觀察者模式</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">addListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> listener === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">push</span>(listener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;listener 必須是 function&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">removeListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">splice</span>(<span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">indexOf</span>(listener), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">notify</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">listener</span>(message);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> egghead = <span class="keyword">new</span> <span class="title class_">Producer</span>();</span><br><span class="line"><span class="comment">// new 出一個 Producer 實例叫 egghead</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">listerner1</span>(<span class="params">message</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(message + <span class="string">&#x27; from listener1&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">listerner2</span>(<span class="params">message</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(message+ <span class="string">&#x27; from listener2&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">egghead.<span class="title function_">addListener</span>(listerner1);<span class="comment">// 註冊監聽</span></span><br><span class="line">egghead.<span class="title function_">addListener</span>(listerner2);</span><br><span class="line"></span><br><span class="line">egghead.<span class="title function_">notify</span>(<span class="string">&#x27;A new course!!&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h3 id="創建Observable"><a href="#創建Observable" class="headerlink" title="創建Observable"></a>創建Observable</h3><p>要創建一個Observable，只要給<strong>new Observable</strong>傳遞一個接收<strong>observer</strong>參數的回調函數，在這個函數中去定義如何發送數據</p>
<h4 id="同步的例子"><a href="#同步的例子" class="headerlink" title="同步的例子"></a>同步的例子</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//創建Observable</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> source$ = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//發射數據</span></span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> observercb = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">item</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(item)</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">source$.<span class="title function_">subscribe</span>(observercb)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>另一種寫法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="comment">//建立流物件</span></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//發射數據</span></span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//訂閱它</span></span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="異步的例子"><a href="#異步的例子" class="headerlink" title="異步的例子"></a>異步的例子</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> source$ = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> number = <span class="number">1</span></span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(number++)</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> source$ = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> number = <span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> message = &#123;</span><br><span class="line">        <span class="attr">count</span>: number,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;message &quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        number++;</span><br><span class="line">        message.<span class="property">count</span> = number;</span><br><span class="line">        observer.<span class="title function_">next</span>(message)</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>Obserable</strong>同時可以處理同步與非同步的行為</p>
<h3 id="觀察者Observer"><a href="#觀察者Observer" class="headerlink" title="觀察者Observer"></a>觀察者Observer</h3><p>Obserable可以被訂閱(subscirbe)或說可以被觀察，而訂閱Obserable的物件又稱為**觀察者(Observer)**。觀察者是一個具有三個方法(method)的物件，每當Obserable發生事件時，更會呼叫觀察者相對應方法。</p>
<blockquote>
<p>意這裡的觀察者(Observer)跟上一篇講的觀察者模式(Observer Pattern)無關，觀察者模式是一種設計模式，是思考問題的解決過程，而這裡講的觀察者是○被定義的物件。</p>
</blockquote>
<p>觀察者的三個方法(method):</p>
<ul>
<li><p>next:每當Obserable發送出新的值，next方法就會被呼叫。</p>
</li>
<li><p>complete:在Obserable沒有其他的資料可以取得時，complete方法就會被呼叫，在complete被呼叫之後，next方法就不會再起作用。</p>
</li>
<li><p>error:每𡮝Obserable內發生錯誤時，error方法就會被呼叫。</p>
</li>
</ul>
<p>說了這麼多，我們還是直接來建立一個觀察者吧！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> observable$= <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function">(<span class="params">observer</span>)=&gt;</span>&#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//宣告一個觀察者，具備next , error, complete 三個方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observer =&#123;</span><br><span class="line">    <span class="attr">next</span>:<span class="keyword">function</span>(<span class="params">value</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>:<span class="keyword">function</span>(<span class="params">error</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用我們定義好的觀察者，來訂閱這個observale</span></span><br><span class="line">observable$.<span class="title function_">subscribe</span>(observer);</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼會印出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Jerry ​​​​​at ​​​value​​​ ​day05rxjs.js:13:8​</span><br><span class="line">Anna ​​​​​at ​​​value​​​ ​day05rxjs.js:13:8​</span><br><span class="line">complete ​​​​​at ​day05rxjs.js:19:8​</span><br></pre></td></tr></table></figure>

<p>上面的範例可以看得出來在complete執行後，next就會自動失效，所以沒有印出<code>not work</code> 。</p>
<p>下面則是送出錯誤的範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> observable$ = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function">(<span class="params">observer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line">        observer.<span class="title function_">next</span>(<span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&#x27;some exception&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        observer.<span class="title function_">error</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 宣告一個觀察者，具備 next,error,complete 三個方法</span></span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span>, error);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 用我們定義好的觀察者，來訂閱這個observable</span></span><br><span class="line">observable$.<span class="title function_">subscribe</span>(observer);</span><br></pre></td></tr></table></figure>

<p>會印出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Jerry </span><br><span class="line">Anna </span><br><span class="line">Error:  some exception </span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>這裡就會執行error的function印印出<code>Error:  some exception</code></p>
<blockquote>
<p>有時候Observable會是一個無限的序列，例如click事件，這時<code>complete</code>方法就有可能永遠不會被呼叫！</p>
</blockquote>
<p>我們也可以直接把next,error,complete三個function依序傳入<code>obserable.subscrive</code>如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">observable$.<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">value</span> =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span>, error); &#125;,</span><br><span class="line">    <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="實作細節"><a href="#實作細節" class="headerlink" title="實作細節"></a>實作細節</h3><p>我們之前提到了，其實Observable的訂閱跟addEventListener在實作上有蠻大的差異，雖然他們的行為很像！</p>
<p>addEventListener本質上就是Observer Pattern的實作，在內部會有一份訂閱清單，像是我們實作的Producer</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">addListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> listener === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">push</span>(listener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;listener 必須是 function&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">removeListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">splice</span>(<span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">indexOf</span>(listener), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">notify</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">listener</span>(message);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們在內部儲存了一份所有的監聽者清單’this.listeners’，在要發佈通知時會對逐一的呼叫這份清單的監聽者。</p>
<p>但在Observable不是這樣實作的，在其內部沒有一份訂閱者的清單。訂閱Observable的行無比較像是執行一個物件的方法，並把資料傳進這個方法。</p>
<p>我們以下面的程式碼做說明</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> observable$ = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function">(<span class="params">observer</span>) =&gt;</span> &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">observable$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>像上面這段程式，他的行為比較像這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">subscribe</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡可以看到subscribe是一個function，這個function執行時會傳入觀察者，而我們在這個function內部去執行觀察者的方法。</p>
<p><strong>訂閱一個Observable就像是執行一個function</strong></p>
<h3 id="建立-Observable-二"><a href="#建立-Observable-二" class="headerlink" title="建立 Observable(二)"></a>建立 Observable(二)</h3><p>Obaerable有許多創建實例的方法，稱為creation operator，下面會有RxJS常用的creation operator</p>
<h4 id="of"><a href="#of" class="headerlink" title="of"></a>of</h4><p>當我們想要<strong>同步的</strong>傳遞幾個值時，就可以用<code>of</code>這個opertor來簡潔的表達</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">of</span>(<span class="string">&#x27;Jery&#x27;</span>, <span class="string">&#x27;Anna&#x27;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="from"><a href="#from" class="headerlink" title="from"></a>from</h4><p>其實<code>of</code>operator的一個一個參數其實就是一個list，而list在JavaScript中最常見的形式是陣列(array) ,那我們可以用<code>from</code>來按收任何可列舉的參數</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Jerry&#x27;</span>, <span class="string">&#x27;Anna&#x27;</span>, <span class="number">2016</span>, <span class="number">2017</span>, <span class="string">&#x27;30 days&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(arr);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//結果</span></span><br><span class="line"><span class="comment">//Jerry </span></span><br><span class="line"><span class="comment">//Anna </span></span><br><span class="line"><span class="comment">//2016 </span></span><br><span class="line"><span class="comment">//2017 </span></span><br><span class="line"><span class="comment">//30 days </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>記得任何可列舉的參數可以用，也就是說像Set,WeakSet,Iterator等都可以當作參數</p>
<blockquote>
<p>因為ES6出現後可列舉(iterable)的型別變多了，所以<code>fromArray</code>就被移除了。</p>
</blockquote>
<p>另外<code>from</code>還能接收字串(string)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(<span class="string">&#x27;鐵人賽&#x27;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//結果</span></span><br><span class="line"><span class="comment">//鐵 </span></span><br><span class="line"><span class="comment">//人 </span></span><br><span class="line"><span class="comment">//賽 </span></span><br><span class="line"><span class="comment">//complete </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也可以傳入Promise物件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&#x27;Hello RxJs&#x27;</span>);</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//結果</span></span><br><span class="line"><span class="comment">// Hello RxJs </span></span><br><span class="line"><span class="comment">// complete </span></span><br></pre></td></tr></table></figure>

<h4 id="fromEvent"><a href="#fromEvent" class="headerlink" title="fromEvent"></a>fromEvent</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source = <span class="title class_">Rx</span>.<span class="property">Observable</span>.<span class="title function_">fromEvent</span>(<span class="variable language_">document</span>.<span class="property">body</span>, <span class="string">&#x27;click&#x27;</span>);</span><br><span class="line"></span><br><span class="line">source.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="fromEventPattern"><a href="#fromEventPattern" class="headerlink" title="fromEventPattern"></a>fromEventPattern</h5><p>要用 Event 來建立 Observable 實例還有另一個方法 <code>fromEventPattern</code>，這個方法是給類事件使用。所謂的類事件就是指其行為跟事件相像，同時具有註冊監聽及移除監聽兩種行為，就像 DOM Event 有 <code>addEventListener</code> 及 <code>removeEventListener</code> 一樣！舉一個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEventPattern &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">addListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> listener === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">push</span>(listener)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;listener 必須是 function&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">removeListener</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">splice</span>(<span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">indexOf</span>(listener), <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">notify</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">listener</span>(message);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ------- 以上都是之前的程式碼 -------- //</span></span><br><span class="line"><span class="keyword">var</span> egghead = <span class="keyword">new</span> <span class="title class_">Producer</span>();</span><br><span class="line"><span class="comment">// egghead 同時具有 註冊監聽者及移除監聽者 兩種方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEventPattern</span>(</span><br><span class="line">    <span class="function">(<span class="params">handler</span>) =&gt;</span> egghead.<span class="title function_">addListener</span>(handler),</span><br><span class="line">    <span class="function">(<span class="params">handler</span>) =&gt;</span> egghead.<span class="title function_">removeListener</span>(handler)</span><br><span class="line"></span><br><span class="line">);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">egghead.<span class="title function_">notify</span>(<span class="string">&#x27;Hello! Can you hear me?&#x27;</span>);</span><br><span class="line"><span class="comment">//結果 Hello! Can you hear me? </span></span><br></pre></td></tr></table></figure>

<p>上面的程式碼可以看到，<code>egghead</code> 是 <code>Producer</code> 的實例，同時具有 註冊監聽及移除監聽兩種方法，我們可以將這兩個方法依序傳入 <code>fromEventPattern</code> 來建立 Observable 的物件實例！</p>
<blockquote>
<p>這裡要注意不要直接將方法傳入，避免 this 出錯！也可以用 <code>bind</code> 來寫。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Rx.Observable</span><br><span class="line">    .fromEventPattern(</span><br><span class="line">        egghead.addListener.bind(egghead), </span><br><span class="line">        egghead.removeListener.bind(egghead)</span><br><span class="line">    )</span><br><span class="line">    .subscribe(console.log)</span><br></pre></td></tr></table></figure>

<h4 id="empty-never-throw"><a href="#empty-never-throw" class="headerlink" title="empty,never,throw"></a>empty,never,throw</h4><p>有點像是數學上的**零(0)**，雖然有時候好像沒什麼，但卻非常的重要。在Observable的世界裡也有類似的東西，像是<code>empty</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">empty</span>();</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>:<span class="keyword">function</span>(<span class="params">value</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p><code>empty</code> 會給我們一個<strong>空</strong>的 observable，如果我們訂閱這個 observable 會發生什麼事呢？ 它會立即送出 complete 的訊息！</p>
<blockquote>
<p>可以直接把 <code>empty</code> 想成沒有做任何事，但它至少會告訴你它沒做任何事。</p>
</blockquote>
<p>數學上還有一個跟零(0)很像的數，那就是<strong>無窮(∞)</strong>, 在Observable的世界裡我們用 <code>never</code> 來建立無窮的 observable</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; never &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">never</span>();</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>never 會給我們一個無窮的 observable，如果我們訂閱它又會發生什麼事呢？…什麼事都不會發生，它就是一個一直存在但卻什麼都不做的 observable。</p>
<blockquote>
<p>可以把 never 想像成一個結束在無窮久以後的 observable，但你永遠等不到那一天！</p>
</blockquote>
<blockquote>
<p>題外話，筆者一直很喜歡平行線的解釋： 兩條平行線就是它們相交於無窮遠</p>
</blockquote>
<p>最後還有一個 operator <code>throw</code>，它也就只做一件事就是拋出錯誤。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; throwError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">throwError</span>(<span class="string">&#x27;Oop!&#x27;</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Throw Error: Oop!</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼就只會 log 出 <code>&#39;Throw Error: Oop!&#39;</code>。</p>
<h4 id="interval-timer"><a href="#interval-timer" class="headerlink" title="interval,timer"></a>interval,timer</h4><p>接著我們要看兩個跟時間有關的operators、在JS中我們可以用<code>setInterval</code>來建立一個持續的行為，這也能用在Observable中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(i++);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，會每隔一秒送出一個從零開始遞增的整數，在Observable的世界也有一個operator可以更方便地做到這件事，就是<code>interval</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p><code>interval</code>有一個參數是數值(Number), 這數值代表發出訊號的間隔時間(ms), 這兩段程式碼基本上是等價的會持續每隔一秒送出一個從零開始遞增的數值</p>
<p>另外有一很相似的operator叫<code>timer</code>,<code>timer</code>可以給兩個參數，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; timer &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">timer</span>(<span class="number">1000</span>, <span class="number">5000</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>當<code>timer</code>有兩個參數時，第一個參數代表要發出第一個值的等待時間(ms),第二個參數代表第一次之後發送值的間隔時間，所以上面這段程式碼會先等一秒送出0之後每5秒送出1，2，3，4…</p>
<p><code>timer</code>第一個參睥除了可以是數值(Number)之外，也可以是日期(Date), 就會等到指定的時間在發送䇪一個值。</p>
<p>另外<code>timer</code>也可以只接收一個參數</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; timer &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">timer</span>(<span class="number">1000</span>);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼就會等一秒後送出1同時通知結束。</p>
<h4 id="Subscription"><a href="#Subscription" class="headerlink" title="Subscription"></a>Subscription</h4><p>有提到很多無窮的Observable，例如interval,never。但有時候我們可能會在某些行為後不需要這些資源，要做到這件事最簡單的方法就是<code>unsubscribe</code>。</p>
<p>其實在訂閱Observable後，會回傳一個subscription物件，這個物件具有釋放資源的<code>unsubscribe</code>方法。範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; timer &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">timer</span>(<span class="number">1000</span>, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//取得subscription</span></span><br><span class="line"><span class="keyword">var</span> subscription = source$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Throw Error: &#x27;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscription.<span class="title function_">unsubscribe</span>();<span class="comment">//停止訂閱(退訂)</span></span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2 </span></span><br><span class="line"><span class="comment">//3 </span></span><br></pre></td></tr></table></figure>

<p>這裡我們用了<code>setTimeout</code>在5秒後，執行了<code>subscription.unsubscribe()</code>來停止訂閱並釋放資源。另外subscription物件還有其他合併訂閱等作用。</p>
<blockquote>
<p>Events observable盡畫不要用<code>unsubscribe</code>,通常我們會使用<code>takeUntil</code>,在某個載件發生後來完成Eventobservable</p>
</blockquote>
<h3 id="Observable-Operators-Marble-Diagrams"><a href="#Observable-Operators-Marble-Diagrams" class="headerlink" title="Observable Operators &amp; Marble Diagrams"></a>Observable Operators &amp; Marble Diagrams</h3><blockquote>
<p>Observable的Operators是實數應用上最重要的部份，我們需要了解各種Operators的使用方式，才能輕鬆實作各種需求！</p>
</blockquote>
<p>關於轉換(Transformation)、過濾(Filter)、合併(Combination)等操作方法，先來知道什麼是Operator</p>
<h4 id="什麼是Operator"><a href="#什麼是Operator" class="headerlink" title="什麼是Operator?"></a>什麼是Operator?</h4><p>Operators就是一個個被附加到Observable型別的函式，例如像是mag,filter,contactall…等等，所有這些函式都拿到原來的Observable並回傳一個新的observable，有像下面的樣子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span>, <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> people = <span class="title function_">of</span>(<span class="string">&quot;Jerry&quot;</span>, <span class="string">&quot;Anna&quot;</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">map</span>(<span class="params">source$, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="function">(<span class="params">observer</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> source$.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                observer.<span class="title function_">next</span>(<span class="title function_">callback</span>(value));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                observer.<span class="title function_">error</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">            <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; observer.<span class="title function_">error</span>(e); &#125;,</span><br><span class="line">            <span class="function">() =&gt;</span> &#123; observer.<span class="title function_">complete</span>(); &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> helloPeople = <span class="title function_">map</span>(people, <span class="function">(<span class="params">item</span>) =&gt;</span> item + <span class="string">&quot; Hello~&quot;</span>);</span><br><span class="line">helloPeople.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br><span class="line"><span class="comment">//Jerry Hello~ ​​​​​</span></span><br><span class="line"><span class="comment">// Anna Hello~ ​​​​​</span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到我們寫了一個map的函式，它接收兩個參數，第一個是原本的observable, 䇪二個是map的callback function。map內部第一件事就是用<code>create</code>建立一個新的observable並回傳，並且在內部訂閱原本的observable。</p>
<p>這裡有兩個重點是我們一定要知道的，每個operator都會回傳一個新的ooservable,而我們可以透過<code>create</code>的方法建立各種operator</p>
<p>我們需要先訂定一個簡單的方式來表達observable</p>
<h4 id="Marble-diagrams"><a href="#Marble-diagrams" class="headerlink" title="Marble diagrams"></a>Marble diagrams</h4><p>我們在傳達事物時，文字其實是最糟的手段，雖然文字是我們平時溝通的基礎，但常常千言萬語也比不過一張清楚的圖。如果我們能訂定observable的圖示，就能讓我自更方便的溝通及理解observable的各種operators!</p>
<p>我們把描繪 observable 的圖示稱為 Marble diagrams，在網路上 RxJS 有非常多的 Marble diagrams，規則大致上都是相同的，這裡為了方便撰寫以及跟讀者的留言互動，所以採用類似 ASCII 的繪畫方式。</p>
<p>我們用<code>-</code>來表達一小段時𫂾，這些<code>-</code>串起來就代表一個observable</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-----------</span><br></pre></td></tr></table></figure>

<p><code>X</code>(大寫X)則代表有錯誤發生</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-----------X</span><br></pre></td></tr></table></figure>

<p><code>|</code>則代表observable結束</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-----------|</span><br></pre></td></tr></table></figure>

<p>在這個時間序當中，我們可能會發出值(value), 如果值是數字則直接用阿拉伯數字取代，其他的資料型別則用相近的英文符號代表，𫍇裡我們用<code>interval</code>舉例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source$=<span class="title function_">interval</span>(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p><code>source$</code>的圖型就會長像這樣</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">----0-----1-----2-----3--...</span><br></pre></td></tr></table></figure>

<p> 當observable是同步送值的時候，例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source$=<span class="title function_">of</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p><code>source$</code>的圖形就會長像這樣</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1234)|</span><br></pre></td></tr></table></figure>

<p>小括號代表著同步發生</p>
<p>另外的Marble diagrams也能夠表達operator的前後轉換，例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source=<span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> newest =source.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>這時候Marble diagrams就會長像這樣</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>: -----0-----1-----2-----3--...</span><br><span class="line">            map(x =&gt; x + 1)</span><br><span class="line">newest: -----1-----2-----3-----4--...</span><br></pre></td></tr></table></figure>

<p>最上面原本的observable, 中間是operator，下面則是新的observable</p>
<p>Marble Diagrams 相關資源：<a href="http://rxmarbles.com/">http://rxmarbles.com/</a></p>
<h4 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h4><h5 id="map"><a href="#map" class="headerlink" title="map"></a>map</h5><p>Observable的map方法使用上跟陣列的map是一樣的，我們傳入一個callback function，這個callback function會帶入每次發送出來的元素，然後我們回傳新的元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> newest$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line">newest$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">//2 ​​​​​</span></span><br><span class="line"><span class="comment">//3 ​​​​​</span></span><br><span class="line"><span class="comment">//4 ​​​​​</span></span><br><span class="line"><span class="comment">//5 ... ​​​​​</span></span><br></pre></td></tr></table></figure>

<p>用Marble diagrams表達就是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>: -----0-----1-----2-----3--...</span><br><span class="line">			map(x =&gt; x + 2)</span><br><span class="line">newest: -----2-----3-----4-----5--...			</span><br></pre></td></tr></table></figure>

<p>有另外一個方法跟map很像叫mapTo</p>
<h5 id="mapTo"><a href="#mapTo" class="headerlink" title="mapTo"></a>mapTo</h5><p>mapTo可把傳進來的值改成一固定的值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mapTo &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> newest$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">mapTo</span>(<span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line">newest$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">//2 ​​​​​</span></span><br><span class="line"><span class="comment">//2 ​​​​​</span></span><br><span class="line"><span class="comment">//2 ....</span></span><br></pre></td></tr></table></figure>

<p>mapTo用Marble diagrams表達</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>: -----0-----1-----2-----3--...</span><br><span class="line">			mapTo(2)</span><br><span class="line">newest: -----2-----2-----2-----2--...			</span><br></pre></td></tr></table></figure>

<h5 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h5><p>filter在使用上也跟陣列的相同，我們要傳入一個callback function，這個function會傳入每個被送出的元素，並且回傳一個boolean值，如果為true的話就會保留，如果為false就會被濾掉</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mapTo, filter &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> newest$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">filter</span>(<span class="function"><span class="params">x</span> =&gt;</span> x % <span class="number">2</span> === <span class="number">0</span>)</span><br><span class="line">);</span><br><span class="line">newest$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">//0 ​​​​​</span></span><br><span class="line"><span class="comment">//2 ​​​​​</span></span><br><span class="line"><span class="comment">//4 ​​​​​</span></span><br><span class="line"><span class="comment">//6 ...</span></span><br></pre></td></tr></table></figure>

<p>filter用Marble diagrams表達</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source: -----0-----1-----2-----3-----4--...</span><br><span class="line">			filter(x =&gt; x%2 === 0)</span><br><span class="line">newest: -----0-----------2-----------4---...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>map ,filter這些方法其實都跟陣列的相同，因為這些都是fucntional programming的通用函式。</p>
</blockquote>
<blockquote>
<p>實際上Observable跟Array的operators(map,filter)，在行為上還是有極大的差異，當我們的資料量很大時，Observable的效能會好上非常多。</p>
</blockquote>
<h5 id="take"><a href="#take" class="headerlink" title="take"></a>take</h5><p>take 是一個很簡單的operator, 顧名思義就是取前幾個元素後就結束</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mapTo, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//1 </span></span><br><span class="line"><span class="comment">//2 </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到我們的<code>source$</code>原本是會發出無限元素的，但這裡我們用<code>take(3)</code>就會只取前3個元素，取完後就直接結束(complete), 用Marble diagram表如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$:-----0-----1-----2-----3--..</span><br><span class="line">		take(3)</span><br><span class="line">example:-----0-----1-----2|</span><br></pre></td></tr></table></figure>

<h5 id="first"><a href="#first" class="headerlink" title="first"></a>first</h5><p>first會取observable送出的第一個元素之後就直接結束，行為跟takb(1)一樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; first, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">first</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//0 </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>用Marble diagram表示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source$ :-----0-----1-----2-----3--..</span><br><span class="line">example$:-----0|</span><br></pre></td></tr></table></figure>

<h5 id="takeUntil"><a href="#takeUntil" class="headerlink" title="takeUntil"></a>takeUntil</h5><p>在實數上takeUntil很常使用到，他可以在某件事情發生時，讓一個observable直送出完成(complete)訊息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, fromEvent &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; first, takeUntil &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> click = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>.<span class="property">body</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(click));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a href="https://stackblitz.com/edit/rxjs-arycee?devtoolsheight=60">stackblitz</a></p>
<p>這裏我們一開始先用<code>interval</code>建立一個observable，這個observable每隔1秒會送出一個從0開𤖥遞增的數值，接著我們用<code>takeUntil</code>,傳人另一個observable.</p>
<p>當<code>tabkeUntil</code>傳入的observable發送值時，原本的observable就會直托進人完成(complete)狀態，並且發送完成訊息。也就是說上面這沒程式碼的行為，會先每一秒印出一個數字(從0遞增)直到我們點擊body為止，他才會送出complete訊息。如果畫成Maribe diagram則會像下面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source$ :-----0-----1-----2-----3--..</span><br><span class="line">click   :---------------------c------</span><br><span class="line">			takeUntil(click)</span><br><span class="line">example$:-----0-----1-----2---|			</span><br></pre></td></tr></table></figure>

<p>當click一發送元素的時候，observable就會直接完縑(complete)</p>
<h5 id="concatAll"><a href="#concatAll" class="headerlink" title="concatAll"></a>concatAll</h5><p>有時我們的Observable送出的元素又是一個observable就像是二維陣列，陣列裡面的元素是陣列，這時我們就可以用<code>concatAll</code> 它攤平成一維陣列，也可以直接把<code>concatAll</code>想成把所有元素concat起來。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span>, fromEvent &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,concatAll &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> click = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>.<span class="property">body</span>, <span class="string">&#x27;click&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">of</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concatAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a href="https://stackblitz.com/edit/rxjs-en1m7j?file=index.ts">stackblitz</a></p>
<p>這個範例我們每點一次body就會立刻送出1,2,3，如果用Marble diagram表示則如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">click  : ------c----------c-----------</span><br><span class="line">		  map(e =&gt; of(1, 2, 3))</span><br><span class="line"><span class="built_in">source</span> : ------o----------o-----------</span><br><span class="line">                \          \</span><br><span class="line">                 (123)|     (123)|</span><br><span class="line">example:-------(123)------(123)-------</span><br></pre></td></tr></table></figure>

<p>這裡可以看到<code>source</code>observable內部每次發送的值也是observable，這時我們用concatAll就可以把source攤平成example</p>
<p>這裡需要注意的是<code>concatAll</code>會處理source先發出來的observable，必須等到這個observable結事，才會再處理下一固source發出來的observable，以下面這個範例說明。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, concatAll &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> obs1$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">var</span> obs2$ = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">2</span>));</span><br><span class="line"><span class="keyword">var</span> obs3$ = <span class="title function_">interval</span>(<span class="number">2000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">of</span>(obs1$, obs2$, obs3$);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concatAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到<code>source</code>會送出3個observable，但是<code>concatAll</code>後的行為永遠都是先處理第一個observable,<strong>等到當前處理的結事後才會再處理下一個</strong></p>
<p>用Marble diagram表示如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">source : (o1)               o2     o3)|</span><br><span class="line">           \                 \      \</span><br><span class="line">            --0--1--2--3--4|  -0-1|  ----0|</span><br><span class="line">                 concatAll()</span><br><span class="line">example: --0--1--2--3--4-0-1----0</span><br></pre></td></tr></table></figure>

<h5 id="簡易拖拉"><a href="#簡易拖拉" class="headerlink" title="簡易拖拉"></a>簡易拖拉</h5><p>當看完前面幾個operator後，我們就很輕鬆地做出拖拉的功能，先讓我們來看一下需求</p>
<ol>
<li><p>首先畫面上有一僤元件(#drag)</p>
</li>
<li><p>當滑鼠在元件(#drag)上按下左鍵(mousedwon)時，開始監聽滑鼠移動(mousemove)的位置</p>
</li>
<li><p>當滑鼠左鍵放掉(mouseup)時，結束監聽滑鼠移動</p>
</li>
<li><p>當滑鼠移動(mousemove)被監聽時，跟著修改元件的樣式屬性</p>
</li>
</ol>
<p>第一步如下<br><a href="https://stackblitz.com/edit/rxjs-agprjt">stackblitz</a></p>
<p>第二步我們要先取得各個 DOM 物件，元件(#drag) 跟 body。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dragDOM = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;drag&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> body = <span class="variable language_">document</span>.<span class="property">body</span>;</span><br></pre></td></tr></table></figure>

<p>要取得body的原因是因為滑鼠移動(moudemove)跟滑鼠左鍵放掉(mouseup)都應該是在整個body監聽</p>
<p>第三步我們寫出各個會用的監聽事件，並用<code>fromEvent</code>來取得各個observable. </p>
<ul>
<li><p>對#drag監聽moudedown</p>
</li>
<li><p>對body監聽mouseup</p>
</li>
<li><p>對body監聽mousemove</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mouseDown = <span class="title function_">fromEvent</span>(dragDOM, <span class="string">&#x27;mousedown&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mouseUp = <span class="title function_">fromEvent</span>(body, <span class="string">&#x27;mouseup&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mouseMove = <span class="title function_">fromEvent</span>(body, <span class="string">&#x27;mousemove&#x27;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>還沒<code>subscribe</code>之前都不會開始監聽，一定會𨬓到subscribe之後obserable才會開始送值</p>
</blockquote>
<p>當mouseDown時，轉成mouseMove的事件</p>
<p>mouseMove要在mouseUp後結束加上<code>takeUntil(mouseup)</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> source = mouseDown.<span class="title function_">pipe</span>(</span><br><span class="line"> <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> mouseMove.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp)))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>這時source大概長像這樣</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>: -------e--------------------e--------</span><br><span class="line">                \                    \</span><br><span class="line">                  --m-m-m-m/           -m--m-m--m-m/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>m 代表mousemove event</p>
</blockquote>
<p>用<code>concatAll()</code>攤平source成一維</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> source = mouseDown.<span class="title function_">pipe</span>(</span><br><span class="line"> <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> mouseMove.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp))),</span><br><span class="line"> <span class="title function_">concatAll</span>()   </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>用map把mousemove event轉成x,y的位置，並且訂閱</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> source = mouseDown.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> mouseMove.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp))),</span><br><span class="line">  <span class="title function_">concatAll</span>(),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">event</span> =&gt;</span> (&#123; <span class="attr">x</span>: event.<span class="property">clientX</span>, <span class="attr">y</span>: event.<span class="property">clientY</span> &#125;))</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="function"><span class="params">pos</span> =&gt;</span> &#123;</span><br><span class="line">  dragDOM.<span class="property">style</span>.<span class="property">left</span> = pos.<span class="property">x</span> + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">  dragDOM.<span class="property">style</span>.<span class="property">top</span> = pos.<span class="property">y</span> + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>雖然這只是一個簡單的拖拉實現，但已經展示出 RxJS 帶來的威力，它讓我們的程式碼更加的簡潔，也更好的維護！</p>
<h5 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h5><p><code>take</code>可以取前幾個送出的元素，而可以略出前幾個送出的元素<code>skip</code>, 範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; skip &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">skip</span>(<span class="number">3</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//3 ​​​​​at ​​​value​​​ ​day09rxjs.js:9​</span></span><br><span class="line"><span class="comment">//4 ​​​​​at ​​​value​​​ ​day09rxjs.js:9​</span></span><br><span class="line"><span class="comment">//5 ...</span></span><br></pre></td></tr></table></figure>

<p>原本從0開𤖥的就會變成從3開𤖥，但是記得原本元素的等得時𫂾仍然存在，也就是說此範例第一個取得的元素需要等4秒，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----0----1----2----3----4----5--...</span><br><span class="line">                skip(3)</span><br><span class="line">example$: -------------------3----4----5--...               </span><br></pre></td></tr></table></figure>

<h5 id="takeLast"><a href="#takeLast" class="headerlink" title="takeLast"></a>takeLast</h5><p>除了可以用<code>take</code>取前幾個之外，我們也可以倒過來取最後幾個，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, takeLast &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">takeLast</span>(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//4 </span></span><br><span class="line"><span class="comment">//5 </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>



<p>這裡我們先取了前6個元素，再取最後兩個，所以最後會送出4,5,complete，有一個重點。就是<code>takeLast</code>必須等到整個observable完成(complete), 才能知道最後的元素有哪些，並且<strong>同步送出</strong>,如果有Marbe Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$  : ----0----1----2----3----4----5|</span><br><span class="line">                    takeLast(2)</span><br><span class="line">example$ : ------------------------------(45)|                    </span><br></pre></td></tr></table></figure>

<p>可以看到takeLast後，必需等到原本的observable完成後，才立即同步送出4,5,complete</p>
<h5 id="last"><a href="#last" class="headerlink" title="last"></a>last</h5><p>跟<code>take(1)</code>相同，我們有一個<code>takeLast(1)</code>的簡化寫法，那就是<code>last()</code>用來取得最後一個元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; last, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"><span class="keyword">let</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">last</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$  : ----0----1----2----3----5|</span><br><span class="line">                   last()</span><br><span class="line">example$ : --------------------------(5)|                   </span><br></pre></td></tr></table></figure>

<h5 id="concat"><a href="#concat" class="headerlink" title="concat"></a>concat</h5><p><code>concat</code>可以把多個observable實例合併成一個</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concat, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">let</span> source2$ = <span class="title function_">of</span>(<span class="number">3</span>);</span><br><span class="line"><span class="keyword">let</span> source3$ = <span class="title function_">of</span>(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concat</span>(source2$, source3$));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>跟<code>concatAll</code>一樣，必須先等前一個observable完成(complete), 才會繼續下一個，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ :----0----1----2|</span><br><span class="line">source2$:(3)|</span><br><span class="line">source3$:(456)|</span><br><span class="line">            concat()</span><br><span class="line">example$:----0-----1----2(3456)|            </span><br></pre></td></tr></table></figure>

<h5 id="startWith"><a href="#startWith" class="headerlink" title="startWith"></a>startWith</h5><p><code>startWith</code>可以在observable的一開始塞要發送的元素，有點像<code>concat</code>但參數不是observable而是要發送的元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; startWith &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">let</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">startWith</span>(<span class="number">0</span>));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3...</span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到我們在source$一開始塞了一個<code>0</code>, 讓example$會在一開始就立即送出<code>0</code>，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ :----0----1----2----3--...</span><br><span class="line">             startWith(0)</span><br><span class="line">example :(0)----0----1----2----3-...             </span><br></pre></td></tr></table></figure>

<p>記得 startWith 的值是一開始就同步發出的，這個 operator 很常被用來保存程式的起始狀態！</p>
<h5 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h5><p><code>merge</code>跟<code>concat</code>一樣都是用來合併observable，但他們在行為上有非常大的不同</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, merge &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> source$ = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">let</span> source2$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"><span class="keyword">let</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">merge</span>(source2$));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p><code>merge</code>把多個observable同時處理，這跟<code>concat</code>一次處理一個observable是完全不一樣的，由於是同時處理行為會變得較為複雜，用Marble Diagram會較好解釋</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source$ : ----0----1----2|</span><br><span class="line">source2$: --0--1--2--3--4--5|</span><br><span class="line">                merge()</span><br><span class="line">example$: --0-01--21-3--(24)--5|                </span><br></pre></td></tr></table></figure>

<p>這裡可以看到<code>mergr</code>之後的example在時間序上同時在跑source$與source2$,當兩件事情同時發生時，會同步送出資料(被merge的在後面),當兩個observable都結事時才會真的結束。</p>
<p>merge的邏輯有點像是OR(||)就是當兩個observable其中一個被觸發時都可以被處理，這很常用一個以上的按鈕具有部分相同的行為。</p>
<p>例如一個影片播放器有兩個按鈕，一個是暫停(||) 另一個是結束播放(□)。這兩個按鈕都具有相同的行為就是影片會被停止，只是結束播放會讓影片回到00秒，這時我們就可以把這兩個按鈕的事件merge起來處理影片暫停這件事。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var stopVideo= stopButton.pipe(merge(endbutton));</span><br><span class="line">stopVideo.subscribe(()=&gt;&#123;</span><br><span class="line">    //暫停播放影片</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="combineLatest"><a href="#combineLatest" class="headerlink" title="combineLatest"></a>combineLatest</h5><p>它會取得各個observable最後送出的值，再輸出成一個值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, combineLatest &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> newest$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">combineLatest</span>(newest$, <span class="function">(<span class="params">x, y</span>) =&gt;</span> x + y));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="comment">// 7</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>看Marble diagram</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----0----1----2|</span><br><span class="line">newest$ : --0--1--2--3--4--5|</span><br><span class="line">    combineLatest(newest$,(x,y)=&gt;x+y);</span><br><span class="line">example$: ----01--23-4--(56)--7|    </span><br></pre></td></tr></table></figure>

<p>首先<code>combineLatest</code>可以接收多個observable,最後一個參數是callback function,這個callback function接收的參睥數量跟合併的observable數量相同，依照範例來說，因為我們這裡合併了兩個observable所以後面的callback function就接教收x,y兩個參數，x會接收從source$發送出來的值，y會接收newest$發送出來的值。</p>
<p>最後一個重點就是一定會等兩個observable都<strong>曾有送值</strong>出來才會呼叫我們傳入的callback，所以這段程式是這樣運行的</p>
<ul>
<li>newest$送出了<code>0</code>, 但此時source$並沒有送出過任何值，所以不會執行callback</li>
<li>source$送出了<code>0</code>,但此時newest$最後一次送出的值為<code>0</code>,把這兩個數傳入callback得到<code>0</code></li>
<li>newest$送出了<code>1</code>此時source$最後一次送出的值為<code>0</code>, 把這兩個數傳入callback得到<code>1</code></li>
<li>newest$送出了 <code>2</code>，此時 source$ 最後一次送出的值為 <code>0</code>，把這兩個數傳入 callback 得到 <code>2</code>。</li>
<li>source$ 送出了 <code>1</code>，此時 newest$ 最後一次送出的值為 <code>2</code>，把這兩個數傳入 callback 得到 <code>3</code>。</li>
<li>newest$ 送出了 <code>3</code>，此時 source$ 最後一次送出的值為 <code>1</code>，把這兩個數傳入 callback 得到 <code>4</code>。</li>
<li>source$ 送出了 <code>2</code>，此時 newest$ 最後一次送出的值為 <code>3</code>，把這兩個數傳入 callback 得到 <code>5</code>。</li>
<li>source$ 結束，但 newest$ 還沒結束，所以 example 還不會結束。</li>
<li>newest$ 送出了 <code>4</code>，此時 source$ 最後一次送出的值為 <code>2</code>，把這兩個數傳入 callback 得到 <code>6</code>。</li>
<li>newest$ 送出了 <code>5</code>，此時 source$ 最後一次送出的值為 <code>2</code>，把這兩個數傳入 callback 得到 <code>7</code>。</li>
<li>newest$ 結束，因為 source$ 也結束了，所以 example$ 結束。</li>
</ul>
<p>不管是source$還是newest$送出值來，只要另一方曾有送出過值(有最後的值)，就會執行callback並送出新的值，𫍇就是combineLastest</p>
<p>combineLastest很常用在運算多個因子的結果，例如最常見的BMI計算，我們身高變動時就拿上一次的體重計算新的BMI，當體重變動時則拿上次的身高計算BMI，這就很適合用combineLastest來處理</p>
<h5 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h5><p>zip會取每個observable相同順位的元素並傳入callback, 也就是說每個observable的第n個元素會一起被傳入callback</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take,zip&#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> newest$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">6</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">zip</span>(newest$, <span class="function">(<span class="params">x, y</span>) =&gt;</span> x + y));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----0----1----2|</span><br><span class="line">newest$ : --0--1--2--3--4--5|</span><br><span class="line">          zip(newest$,(x,y)=&gt;x+y)</span><br><span class="line">example$: ----0----2----4|          </span><br></pre></td></tr></table></figure>

<p>zip會等到source$跟newest$<strong>都送出了第一個元素</strong>，再傳入callback，下次則等到soure$跟newest$<strong>都送出了䇪二個元素</strong>再一起傳入callback，所以運行的步驟如下</p>
<ul>
<li>newest$ 送出了<strong>第一個</strong>值 <code>0</code>，但此時 source$ 並沒有送出<strong>第一個</strong>值，所以不會執行 callback。</li>
<li>source$ 送出了<strong>第一個</strong>值 <code>0</code>，newest$ 之前送出的<strong>第一個</strong>值為 <code>0</code>，把這兩個數傳入 callback 得到 <code>0</code>。</li>
<li>newest$ 送出了<strong>第二個</strong>值 <code>1</code>，但此時 source$ 並沒有送出<strong>第二個</strong>值，所以不會執行 callback。</li>
<li>newest$ 送出了<strong>第三個</strong>值 <code>2</code>，但此時 source$ 並沒有送出<strong>第三個</strong>值，所以不會執行 callback。</li>
<li>source$ 送出了<strong>第二個</strong>值 <code>1</code>，newest$ 之前送出的<strong>第二個</strong>值為 <code>1</code>，把這兩個數傳入 callback 得到 <code>2</code>。</li>
<li>newest$ 送出了<strong>第四個</strong>值 <code>3</code>，但此時 source$ 並沒有送出<strong>第四個</strong>值，所以不會執行 callback。</li>
<li>source$ 送出了<strong>第三個</strong>值 <code>2</code>，newest$ 之前送出的<strong>第三個</strong>值為 <code>2</code>，把這兩個數傳入 callback 得到 <code>4</code>。</li>
<li>source$ 結束 example$ 就直接結束，因為 source$ 跟 newest$ 不會再有對應順位的值</li>
</ul>
<p>zip會把各個observable相同順位送出的值傳入callback, 這很常拿來做demo使用。比如我們想要間隔100ms送出’h’,’e’,’l’,’l’,’o’,就可以這麼做</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(<span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> source2$ = <span class="title function_">interval</span>(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">zip</span>(source2$, <span class="function">(<span class="params">x, y</span>) =&gt;</span> x));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡的 Marble Diagram 就很簡單</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : (hello)|</span><br><span class="line">source2$: -0-1-2-3-4-...</span><br><span class="line">        zip(source2$, (x, y) =&gt; x)</span><br><span class="line">example$: -h-e-l-l-o|</span><br></pre></td></tr></table></figure>

<p>這裡我們利用 zip 來達到原本只能同步送出的資料變成了非同步的，很適合用在建立示範用的資料。</p>
<blockquote>
<p>建議大家平常沒事不要亂用 zip，除非真的需要。因為 zip 必須 cache 住還沒處理的元素，當我們兩個 observable 一個很快一個很慢時，就會 cache 非常多的元素，等待比較慢的那個 observable。這很有可能造成記憶體相關的問題！</p>
</blockquote>
<h5 id="withLastestFrom"><a href="#withLastestFrom" class="headerlink" title="withLastestFrom"></a>withLastestFrom</h5><p>withLatestFrom運作方式跟combineLastest有點像，只是他有主從的關系，只有在主要的observable送出新的值時，才會執行callback, 附隨的observable只有在背景下運作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip, withLatestFrom &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> main$ = <span class="title function_">from</span>(<span class="string">&quot;hello&quot;</span>).<span class="title function_">pipe</span>(<span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x));</span><br><span class="line"><span class="keyword">var</span> some$ = <span class="title function_">from</span>([<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]).<span class="title function_">pipe</span>(<span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = main$.<span class="title function_">pipe</span>(<span class="title function_">withLatestFrom</span>(some$, <span class="function">(<span class="params">x, y</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> y === <span class="number">1</span> ? x.<span class="title function_">toUpperCase</span>() : x;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error: &#x27;</span> + err) &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//h </span></span><br><span class="line"><span class="comment">//e </span></span><br><span class="line"><span class="comment">//l </span></span><br><span class="line"><span class="comment">//L </span></span><br><span class="line"><span class="comment">//O </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>看一下Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">main$   : ----h----e----l----l----o|</span><br><span class="line">some$   : --0--1--0--0--0--1|</span><br><span class="line"> withLastestFrom(some$,(x,y) =&gt; y === 1 ? x.toUpperCase() : x)</span><br><span class="line">example$: ----h----e----l----L----O|</span><br></pre></td></tr></table></figure>

<p>withLatestFrom會在main送出值的時候執行callback,但注意如果main$送出值時some$之前沒有送出過任何值callback仍然不會執行</p>
<p>這陆鄉們在main送出值時，去判斷some$最後一 送的值是不是1來決定是否要切換大小寫</p>
<ul>
<li>main$送出了<code>h</code>, 此時some$上一次送出的值為<code>0</code>, 把這兩個參數傳入callback得到<code>h</code> 。</li>
<li>main$送出了<code>e</code>, 此時some$上一次送出的值為<code>0</code>, 把這兩個參數傳入callback得到<code>e</code> 。</li>
<li>main$送出了<code>l</code>, 此時some$上一次送出的值為<code>0</code>, 把這兩個參數傳入callback得到<code>l</code> 。</li>
<li>main$送出了<code>l</code>, 此時some$上一次送出的值為<code>1</code>, 把這兩個參數傳入callback得到<code>L</code> 。</li>
<li>main$送出了<code>o</code>, 此時some$上一次送出的值為<code>1</code>, 把這兩個參數傳入callback得到<code>O</code>。</li>
</ul>
<p>withLastestFrom很常用在一些checkbox型的功能，例如說一個編輯器，我們開啟粗體後，打出的字就都要變粗體，粗體就像是some observable，而我們打字就是main observable</p>
<h5 id="實務範例-完整拖拉應用"><a href="#實務範例-完整拖拉應用" class="headerlink" title="實務範例-完整拖拉應用"></a>實務範例-完整拖拉應用</h5><p>當我們在優酷看影片時往下滾動畫面，影片會變成一個小視窗在右下角，這個視窗還能夠拖挽移動位置。這個功能可以讓使用者一邊看留言同時又能看影片，且不影響其他的資訊顯示，真是不錯的feature。來實作這個功能，同時補完拖拉所需要注意的細節吧！</p>
<h6 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h6><p>首先我們會有一個影片在最上方，原本是位置是靜態(static)的，捲軸滾到低於影片高度後，影片改為相對於視窗的絕對位置(fixed),往回滾會再變回原來的狀態。當影片為fixed時，滑鼠移至影片上方(hover)會有遮罩(masker)與鼠標變化(cursor)，可以拖拉移動(drag)，且移動範圍不超過可視區間！</p>
<p>上面可以拆成以下幾個步驟</p>
<ul>
<li>準備static樣式與fixed樣式</li>
<li>HTML要有一固定位置的錨點(anchor)</li>
<li>當滾動超過錨點，則影片變成fixed</li>
<li>當往回滾動過錨點上方，則影片變回static</li>
<li>影片fixed時，要能夠拖拉</li>
<li>拖拉範圍限制在當前可視區間</li>
</ul>
<p>其本的HTML跟CSS可以到此連結<a href="https://stackblitz.com/edit/js-cje2qm?file=index.js">stackblitz</a></p>
<p>先讓我們看一下HTML，首先在HTML裡有一個div(#anchor), 這個div(#anchor)就是待會要做錨點用的，它內部有一個div(#video), 則是滾動後要改變成fixed的元件</p>
<p>CSS的部分我們只需要知道滾動到下方後，要把div(#video)加入<code>videx-fixed</code>這個class。</p>
<p>接著我們就開始實作滾動的效果切探class的效果吧！</p>
<h6 id="第一步取得會用到的DOM"><a href="#第一步取得會用到的DOM" class="headerlink" title="第一步取得會用到的DOM"></a>第一步取得會用到的DOM</h6><p>因為先做滾動切換class, 所有這裡用到的DOM只有#video,#anchor。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> video =<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;video&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> anchor = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;anchor&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h6 id="第二步建立會用到的observable"><a href="#第二步建立會用到的observable" class="headerlink" title="第二步建立會用到的observable"></a>第二步建立會用到的observable</h6><p>這裡做滾動效果，所以只需要監聽滾動事件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">const</span> scroll$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&#x27;scroll&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h6 id="第三步撰寫程式邏輯"><a href="#第三步撰寫程式邏輯" class="headerlink" title="第三步撰寫程式邏輯"></a>第三步撰寫程式邏輯</h6><p>這裡我們要取得了scroll事件的observable，當滾過#anchor最底部時，就改變#video的class。</p>
<p>首先我們會需要滾動事件發生時，去判斷是否<strong>滾過#anchor最底部</strong>，所以把原來的滾動事件變成是否滾動最底部的true or false。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scroll$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span>=&gt;</span> anchor.<span class="title function_">getBoundingClientRect</span>().<span class="property">bottom</span>&lt;<span class="number">0</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>這裡我們用山<code>getBoundingClientRect</code>這個瀏覽器原生的API，他可以取得DOM物件的寬高以及上下左右離螢幕可視區間上(左)的距離如下圖</p>
<img src="getBoundingClientRect.png" style="zoom:80%;" />

<p>當我們可視範圍區間滾過#ancor底部時，<code>anchor.getBoundingClientRect().bottom</code>就會變成負值，此時我們就改變#video的class。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scroll$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span>=&gt;</span> anchor.<span class="title function_">getBoundingClientRect</span>().<span class="property">bottom</span>&lt;<span class="number">0</span>)</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="function"><span class="params">bool</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(bool)&#123;</span><br><span class="line">    video.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;video-fixed&#x27;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    video.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;video-fixed&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們就已經完成滾動變更樣式的效果了</p>
<p>全部的JS程式碼如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.scss&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fromEvent &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> video =<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;video&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> anchor = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;anchor&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> scroll$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&#x27;scroll&#x27;</span>);</span><br><span class="line">scroll$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span>=&gt;</span> anchor.<span class="title function_">getBoundingClientRect</span>().<span class="property">bottom</span>&lt;<span class="number">0</span>)</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="function"><span class="params">bool</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(bool)&#123;</span><br><span class="line">    video.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;video-fixed&#x27;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    video.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;video-fixed&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>當然這段還能在用 debounce&#x2F;throttle 或 requestAnimationFrame 做優化</p>
</blockquote>
<p>擒下來我們就可以接著做<strong>拖拉的行為</strong>了。</p>
<h6 id="第一步取得會用到的DOM-1"><a href="#第一步取得會用到的DOM-1" class="headerlink" title="第一步取得會用到的DOM"></a>第一步取得會用到的DOM</h6><p>這裡我們會用到的DOM跟前面是一樣的(#video)，所以不用多做什麼。</p>
<h6 id="第二步建立會用到的observable-1"><a href="#第二步建立會用到的observable-1" class="headerlink" title="第二步建立會用到的observable"></a>第二步建立會用到的observable</h6><p>這裡跟上次一樣，我們會用到mousedown,mouseup,mousemove三個事件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mouseDown$ = <span class="title function_">fromEvent</span>(video,<span class="string">&#x27;mousedown&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mouseUp$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&quot;mouseup&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> mouseMove$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&quot;mousemove&quot;</span>); </span><br></pre></td></tr></table></figure>

<h6 id="第三步撰寫程式邏輯-1"><a href="#第三步撰寫程式邏輯-1" class="headerlink" title="第三步撰寫程式邏輯"></a>第三步撰寫程式邏輯</h6><p>跟上次是差不多的，首先我們會點擊#video元件，點擊(mousedown)後要變成移動事件(mousemove),而移動事件會在滑鼠收開(mouseup)時結事(takeUntil)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>()</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因為把moudeDown$ observable發送出來的<strong>事件</strong>換成了mouseMove$ observable，所以變成了observable(mouseDown$)送出observable(mouseMove$)。因此最後用concalAll把後面送出的元素變成mousemove的事件。</p>
<p>但這裡會有一個問題，就是我們的𫍇段拖拉事件其實只能做用到video-fixed的時候，所以我們要加上<code>filter</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span>=&gt;</span> video.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;video-fixed&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>()</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這裡我們用filter如果當下#video沒有<code>video-fixed</code>class的話，事件就不會送出。</p>
<p>再來我們就能跟上次一樣，把mousemove事件變成{x,y}的物件，並訂閱來改變#video元件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> video.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;video-fixed&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>(),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">m</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">x</span>: m.<span class="property">clientX</span>,</span><br><span class="line">      <span class="attr">y</span>: m.<span class="property">clientY</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">pos</span> =&gt;</span> &#123;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">top</span> = pos.<span class="property">y</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">left</span> = pos.<span class="property">x</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>到這裡我們基本上已經完成了所有功能和之前簡易拖拉的方法是一樣的。</p>
<p>但這裡有兩個大問題我們還沒有解決</p>
<ol>
<li><p>第一次拉動的時候會閃一下，不像優酷那麼順。</p>
</li>
<li><p>拖拉會跑出當前可視區間，跑出去後就抓不回來了</p>
</li>
</ol>
<p>讓我們一個一個解決，首先第一個問題是因為我們的拖拉直接給元件滑鼠的位置(clientC,clientY),而非給滑鼠相對移動的距離！</p>
<p>所以要解決這個問題很簡單，我們只要把點擊目標的左上角當作(0,0), 並以此改變元件的樣式，就不會有閃動的問題。   這個要怎麼做呢？很簡單，使用withLatestFrom的operator我們可以用它來把mousedown與mousemove兩個Event的值同時傳入callback。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> video.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;video-fixed&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>(),</span><br><span class="line">  <span class="title function_">withLatestFrom</span>(mouseDown$, <span class="function">(<span class="params">move, down</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="attr">x</span>: move.<span class="property">clientX</span> - down.<span class="property">offsetX</span>,</span><br><span class="line">      <span class="attr">y</span>: move.<span class="property">clientY</span> - down.<span class="property">offsetY</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">pos</span> =&gt;</span> &#123;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">top</span> = pos.<span class="property">y</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">left</span> = pos.<span class="property">x</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>當我們能夠同時得到mousemove跟mousedown的事件，接著就只要把滑鼠相對可視區間的距離(client)減掉點按下去時，滑鼠相對元件邊界的距離(offset)就行了。這時拖拉就不會先閃動一下囉！</p>
<blockquote>
<p>大家只要想一下，其實client-offset就是元件相對於可視區間的距離，也就是他一開始沒動的位置！</p>
</blockquote>
<p>接著讓我們解決第二個問題，拖拉會超出可視範圍。這個問題其實只史給最大最小值就行了，因無需求的關系，這裡我們的元件是相對可視的區間的絕對位置(fixed),也就是就說</p>
<ul>
<li>top 最小是0</li>
<li>left 最小是0</li>
<li>top 最大是<strong>可視高度</strong>扣掉<strong>元件本身高度</strong></li>
<li>left 最大是<strong>可視寬度</strong>扣掉<strong>元件本身寬度</strong></li>
</ul>
<p>這裡我們先宣告一個function來處理這件事</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">validValue</span> = (<span class="params">value, max, min</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="title class_">Math</span>.<span class="title function_">max</span>(value, min), max)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一個參數給原本要給的位置值，後面給最大跟最小，如果今天大於最大值我們就取最大值，如果今天小於最小值則取最小值。</p>
<p>再來我們就可以直接把這個問題解掉了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mouseDown$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> video.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;video-fixed&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> mouseMove$.<span class="title function_">pipe</span>(<span class="title function_">takeUntil</span>(mouseUp$))),</span><br><span class="line">  <span class="title function_">concatAll</span>(),</span><br><span class="line">  <span class="title function_">withLatestFrom</span>(mouseDown$, <span class="function">(<span class="params">move, down</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">x</span>: <span class="title function_">validValue</span>(move.<span class="property">clientX</span> - down.<span class="property">offsetX</span>, <span class="variable language_">window</span>.<span class="property">innerWidth</span> - <span class="number">320</span>, <span class="number">0</span>),</span><br><span class="line">      <span class="attr">y</span>: <span class="title function_">validValue</span>(move.<span class="property">clientY</span> - down.<span class="property">offsetY</span>, <span class="variable language_">window</span>.<span class="property">innerHeight</span> - <span class="number">180</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">pos</span> =&gt;</span> &#123;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">top</span> = pos.<span class="property">y</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">    video.<span class="property">style</span>.<span class="property">left</span> = pos.<span class="property">x</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這裡偷懶了一下，直接寫死元件的寬高(320,180)，實際上應用<code>getBoundingClientRect</code>計算是比較好的。</p>
<h4 id="scan-buffer"><a href="#scan-buffer" class="headerlink" title="scan,buffer"></a>scan,buffer</h4><p>兩個簡單的transformation operators並帶一些小範例，這兩個operators都是實數上很常用到的方法。</p>
<h5 id="scan"><a href="#scan" class="headerlink" title="scan"></a>scan</h5><p>scan其實就是Observable版本的reduce只是命名不同。如果熟悉陣列操作的話，應該會知道原生的JS Array就有reduce的方法，使用方式如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="keyword">var</span> result = arr.<span class="title function_">reduce</span>(<span class="function">(<span class="params">origin, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(origin);</span><br><span class="line">    <span class="keyword">return</span> origin + next;</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="comment">// 10</span></span><br></pre></td></tr></table></figure>

<p>reduce方法需要傳兩個參數，第一個是callback第二個則是起始狀態，這個callback執行時，會傳入兩個參睥一個是原本的狀態，第二個是修改原本狀態的參數，最後回傳一個新的狀態，再繼續執行。</p>
<p>所以這段程式碼是這樣執行的</p>
<ul>
<li><p>第一次執行callback起始狀態是0所以origin傳入0，next為arr的第一個元素1，相加之後變成1回傳並當作下一次的狀態。</p>
</li>
<li><p>第二次執行callback，這時原本的狀態(origin)就變成了1，next為arr的第二個元素2，相加之後變成3回傳並當作下一次的狀態。</p>
</li>
<li><p>第三次執行callback，這時原本的狀態(origin)就變成了3，next為arr的第三個元素3，相加之後變成6回傳並當作下一次的狀態。</p>
</li>
<li><p>第四次執行callback, 這時原本的狀態(origin)就變成了6，next為arr的第四個元素4，相之後變成10回傳並當作下一次的狀態。</p>
</li>
<li><p>這時arr的元素都已經遍歷過了，所以不會直接把10回傳。</p>
</li>
</ul>
<p>scan整體的運作方式都跟reduce一樣，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip, scan &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(<span class="string">&quot;hello&quot;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">600</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">scan</span>(<span class="function">(<span class="params">origin, next</span>) =&gt;</span> origin + next, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// h</span></span><br><span class="line"><span class="comment">// he</span></span><br><span class="line"><span class="comment">// hel</span></span><br><span class="line"><span class="comment">// hell</span></span><br><span class="line"><span class="comment">// hello</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$  : ----h-----e-----l----l----o|</span><br><span class="line">        scan((origin, next) =&gt; origin + next, &#x27;&#x27;)</span><br><span class="line">example$ : ----h----(he)----(hel)----(hello)----(hello)|        </span><br></pre></td></tr></table></figure>

<p>這裡可以看到第一次傳入<code>&#39;h&#39;</code>跟<code>&#39;&#39;</code>相加，返回<code>&#39;h&#39;</code>當作下一次的初始狀態，一直重複下去。</p>
<blockquote>
<p>scan跟reduce最大的差別就在scan一定會回傳一固observable實例，而reduce最後回傳的值有可能是任何資料型別，必須看使用者傳入的callback才態決定reduce最後的返回值。</p>
</blockquote>
<blockquote>
<p>Jafar Husain 就曾說：「JavaScript 的 reduce 是錯了，它最後應該永遠回傳陣列才對！」</p>
</blockquote>
<blockquote>
<p>如果大家之前有到<a href="http://reactivex.io/learnrx/">這裡</a>練習的話，會發現 reduce 被設計成一定回傳陣列，而這個網頁就是 Jafar 做的。</p>
</blockquote>
<p>scan很常用狀態的計算處理，最簡單的就是對一個數字的加減，我們可以綁定一個button的click事件，並用map把click event 轉成1，之後送到scan計算值再做顯示。</p>
<p><a href="https://js-ubgduv.stackblitz.io/">stackblitz</a></p>
<p>在<code>html</code>中</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;addButton&quot;</span>&gt;</span>Add<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;minusButton&quot;</span>&gt;</span>Minus<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">&quot;state&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>javascript</code>中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mapTo, startWith, merge,scan &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> addButton = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;addButton&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> minusButon = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;minusButton&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> state = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;state&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> addClick = <span class="title function_">fromEvent</span>(addButton, <span class="string">&quot;click&quot;</span>).<span class="title function_">pipe</span>(<span class="title function_">mapTo</span>(<span class="number">1</span>));</span><br><span class="line"><span class="keyword">const</span> minusClick = <span class="title function_">fromEvent</span>(minusButton, <span class="string">&quot;click&quot;</span>).<span class="title function_">pipe</span>(<span class="title function_">mapTo</span>(-<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> numberState = <span class="title function_">empty</span>().<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">startWith</span>(<span class="number">0</span>),</span><br><span class="line">  <span class="title function_">merge</span>(addClick, minusClick),</span><br><span class="line">  <span class="title function_">scan</span>(<span class="function">(<span class="params">origin, next</span>) =&gt;</span> origin + next, <span class="number">0</span>)</span><br><span class="line">);</span><br><span class="line">numberState</span><br><span class="line">  .<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; state.<span class="property">innerHTML</span> = value;&#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們用了兩個button，一個是add按鈕，一個是minus按鈕。</p>
<p>我們把這兩個按鈕的點擊事件各建立了<code>addClick</code>,<code>minusClick</code>兩個observable，這兩個observable摎托mapTo(1)跟mapTp(-1),代表被點擊後各自送出的數字！</p>
<p>按著我們用了<code>empty()</code>建立一個空的observable代表畫面上數字的狀態，搭配<code>startWith(0)</code>來設定初始值，接著用<code>merge</code>把兩個observable合併透過scan處理之後的邏輯，最後在subscribe來更改畫面的顯示。</p>
<h5 id="buffer"><a href="#buffer" class="headerlink" title="buffer"></a>buffer</h5><p>buffer是一整個家族，總共有五個相關的operators</p>
<ul>
<li><p>buffer</p>
</li>
<li><p>bufferCount</p>
</li>
<li><p>bufferToggle</p>
</li>
<li><p>bufferWhen</p>
</li>
</ul>
<p>這裡比較常用到的是buffer,bufferCount跟bufferTime這三個，我們直接來看範例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; buffer &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>);</span><br><span class="line"><span class="keyword">var</span> source2$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">buffer</span>(source2$)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// [0,1,2]</span></span><br><span class="line"><span class="comment">// [3,4,5]</span></span><br><span class="line"><span class="comment">// [6,7,8]...</span></span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram則像是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --0--1--2--3--4--5--6--7--</span><br><span class="line">source2$: ---------0---------1--------...</span><br><span class="line">           buffer(source2$)</span><br><span class="line">example$: ---------([0,1,2])---------([3,4,5])           </span><br></pre></td></tr></table></figure>

<p>buffer要傳入一個observable(source2$), 它會把原本的observable(source$)送出的元素緩存在陣列中，等到傳入的observable(source2$)送出元素時，就會觸發把緩存的元素送出。</p>
<p>這裡的範例source$2是每一秒就會送出一個元素，我們柯以改用bufferTime簡潔的表達如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; buffer, bufferTime &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">bufferTime</span>(<span class="number">1000</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// [0,1,2]</span></span><br><span class="line"><span class="comment">// [3,4,5]</span></span><br><span class="line"><span class="comment">// [6,7,8]...</span></span><br></pre></td></tr></table></figure>

<p>除了用時𫂾來作緩存外，我們更常用數量來做緩存，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; bufferCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">bufferCount</span>(<span class="number">3</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// [0,1,2]</span></span><br><span class="line"><span class="comment">// [3,4,5]</span></span><br><span class="line"><span class="comment">// [6,7,8]...</span></span><br></pre></td></tr></table></figure>

<p>在實務上，我們可以用buffer來做某個事件的過濾，例如像是滑鼠連點才能直的執行，這裡我們一樣寫了一個小範例</p>
<p><a href="https://js-mny21w.stackblitz.io/">stackblitz</a></p>
<p>在<code>html</code>中</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span>&gt;</span>double click!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>javascript</code>中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; bufferTime, filter &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> button = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;demo&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> click$ = <span class="title function_">fromEvent</span>(button, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> example$ = click$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">bufferTime</span>(<span class="number">500</span>),</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">arr</span> =&gt;</span> arr.<span class="property">length</span> &gt;= <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;success&#x27;</span>); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們只有在500毫秒內連點兩下，才能成功印出<code>success</code>,這個功能在某些特殊的需求中非常的好用，也能用在批次處理來降低request傳送的次數</p>
<h4 id="delay-delayWhen"><a href="#delay-delayWhen" class="headerlink" title="delay,delayWhen"></a>delay,delayWhen</h4><blockquote>
<p>在所有非同步行為中， 最麻煩的大概就是UI操作了，因為UI是直接影響使用者的感受，如果處理的不好對使用者體會大大的扣分 </p>
</blockquote>
<p>UI大概是所有非同步行為中最不好處理的，不只是因為它直接影響了用戶體驗，更大的問題是UI互動常常是高頻𠅋觸發的事件，而且多個元件間的時間序需要不一致，要做這樣的UI互動就不太可能用Promise或async&#x2F;await，但是用RxJS仍然能輕易地處理！</p>
<p>有兩個Operators，delay跟deleyWhen都是跟UI互動比較相關的。當我們的網頁越來越像應用程式，UI互動就變得越重要，讓我們來試試如何用RxJS完成基本的UI互動！</p>
<h5 id="delay"><a href="#delay" class="headerlink" title="delay"></a>delay</h5><p>delay可以延遲observable一開始發送元素的時間點，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">5</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">delay</span>(<span class="number">500</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>當然直接從log出來的訊息看，是完全看不出差異的</p>
<p>讓我們直接看Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --0--1--2--3--4|</span><br><span class="line">         dely(500)</span><br><span class="line">example$: -------0--1--2--3--4|         </span><br></pre></td></tr></table></figure>

<p>從Marble Diagram可以看得出來，第一次送出元素的時間變慢了，雖然在這裡看起來沒有什麼用，但是在UI操作上是非常有用的。</p>
<p>delay除了可以傳入毫秒以外，也可以傳入Date型別的資料，如下使用方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">5</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">delay</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() + <span class="number">1000</span>))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><del>這好像也能用在預定某個日期，讓程式掛掉</del></p>
<h5 id="delayWhen"><a href="#delayWhen" class="headerlink" title="delayWhen"></a>delayWhen</h5><p>delayWhen的作用跟delay很像，最大的差別是delayWhen可以影響每個元素，而且需要傳一個callback並回傳一個observable範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, delayWhen, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">5</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">delayWhen</span>(</span><br><span class="line">        <span class="function"><span class="params">x</span> =&gt;</span> <span class="title function_">empty</span>().<span class="title function_">pipe</span>(<span class="title function_">delay</span>(<span class="number">100</span> * x * x)</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這時我們的Marble Diagram</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --0--1--2--3--4|</span><br><span class="line">	  delayWhen(x =&gt; empty().pipe(delay(100 * x * x))</span><br><span class="line">example$: --0---1----2------3-----4|	  </span><br></pre></td></tr></table></figure>

<p>這裡傳進來的x就是source$送出的每個元素，這樣我們就能對每一個做延遲。</p>
<p>這裡我們用delay來做一個小功能，這個功能很簡單就是讓多張照片跟著滑鼠跑，但每張照片不能跑一樣快！</p>
<p>首先我們先泮備六張大頭照，並且寫進HTML</p>
<p>在<code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover6.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover5.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover4.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover3.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover2.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://res.cloudinary.com/dohtkyi84/image/upload/c_scale,w_50/v1483019072/head-cover1.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>用CSS把img改成圓形，並加上邊框以及絕對位置</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-tag">img</span>&#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">border-radius</span>:<span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">border</span>:<span class="number">3</span> px white solid;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate3d</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再來寫JS, 一樣第一步先抓DOM</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> imgList = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;img&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>第二步建立observable</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> movePos = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;mousemove&quot;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> (&#123; <span class="attr">x</span>: e.<span class="property">clientX</span>, <span class="attr">y</span>: e.<span class="property">clientY</span> &#125;))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>第三步撰寫邏輯</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">followMouse</span>(<span class="params">DOMArr</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> delayTime = <span class="number">600</span>;</span><br><span class="line">  <span class="title class_">DOMArr</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">    movePos.<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">delay</span>(delayTime * (<span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">0.65</span>, index) + <span class="title class_">Math</span>.<span class="title function_">cos</span>(index / <span class="number">4</span>)) / <span class="number">2</span>)</span><br><span class="line">    ).<span class="title function_">subscribe</span>(<span class="keyword">function</span> (<span class="params">pos</span>) &#123;</span><br><span class="line">      item.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&#x27;translate3d(&#x27;</span> + pos.<span class="property">x</span> + <span class="string">&#x27;px, &#x27;</span> + pos.<span class="property">y</span> + <span class="string">&#x27;px, 0)&#x27;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">followMouse</span>(<span class="title class_">Array</span>.<span class="title function_">from</span>(imgList));</span><br></pre></td></tr></table></figure>

<p>這裡我們把imgList從Collection轉成Array後傳入<code>followMouse()</code>並用forEach把每個img取出並利用index來達不同的delay時間，這個delay時間的邏輯大家可以自已想，不用跟我一樣，最後subscribe就完成了</p>
<p><a href="https://js-6xzgmu.stackblitz.io/">stackblitz</a></p>
<h4 id="throttle-debounce"><a href="#throttle-debounce" class="headerlink" title="throttle,debounce"></a>throttle,debounce</h4><p>在做效能優化時不可或缺的好工具</p>
<h5 id="debounce"><a href="#debounce" class="headerlink" title="debounce"></a>debounce</h5><p>跟buffer,bufferTime一樣，Rx有debounce跟debounceTime一個是傳入observable另一個則是傳人毫秒，比較常用到的是debounceTime, 看範例</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, debounceTime &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">debounceTime</span>(<span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>這裡只印出<code>4</code>然後就結束了，因為<strong>debounce運作的方式是每次收到元素，他會先把元素cache住並等得一段時間，如果這段時間內已經沒有收到依何元素，則把元素送出； 如果這段時𫂾內又收到新的元素，則會把原本cache住的元素釋放掉並重新計時，不斷動覆。</strong></p>
<p>以現在這個範例來講，我們每300毫秒就會送出一個數值，但我們的debounceTime是1000毫秒，也就是說每次debounce收到元素還等不到1000毫秒，就會收到下一個新元素，然後重新等待1000毫秒，如此重複直到第五個元素送出時，observable結束(complete)了，debounce就直接送出元素。</p>
<p>以Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --0--1--2--3--4|</span><br><span class="line">          debounceTime(1000)</span><br><span class="line">example$: --------------4|</span><br></pre></td></tr></table></figure>

<p>debounce會在收到元素後等待一段時間，這很適合用來處理<strong>間歇行為</strong>，間歇行為就是指這個行為是一段一段的，例如要做AutoComplete時，我們要打字搜尋不會一直不斷的打字，可以等我們停了一小段時間後再送出，才不會每打一固字就送一次request!</p>
<p>這裡舉一個簡單的例子，假設我們想要自動傳送使用者打的字到後端</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> searchInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;searchInput&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> theRequestValue = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;theRequestValue&quot;</span>);</span><br><span class="line"><span class="title function_">fromEvent</span>(searchInput, <span class="string">&quot;input&quot;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    theRequestValue.<span class="property">textContent</span> = value;</span><br><span class="line">    <span class="comment">//在這裏發request</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>如果用上面這段程式碼，就每打一個字就送一次request，當很多人在使用時就會對server造成很大的負擔，實際上我們只需要使用者最後打出來的文字就好了，不用每次都送，這時就能用debouceTime做優化。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, debounceTime &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> searchInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;searchInput&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> theRequestValue = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;theRequestValue&quot;</span>);</span><br><span class="line"><span class="title function_">fromEvent</span>(searchInput, <span class="string">&quot;input&quot;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">debounceTime</span>(<span class="number">300</span>),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">  theRequestValue.<span class="property">textContent</span> = value;</span><br><span class="line">  <span class="comment">//在這裏發request</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a href="https://js-hlsjvm.stackblitz.io/">stackblitz</a></p>
<h5 id="throttle"><a href="#throttle" class="headerlink" title="throttle"></a>throttle</h5><p>其本上每次看到debounce就會看到throttle,他們兩個的作用都是要降低事件的觸發頻率，但行為上有得大的不同。</p>
<p>跟debouce一樣RxJS有throttle跟throttleTime兩個方法，一個是傳入observable另一個是傳入毫秒，比較常用到的也是throttleTime, 直接看範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, throttleTime &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">throttleTime</span>(<span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>跟debounce的不同是throttle會先開放送出元素，等到有元素被送出就會沈默一段時間，等到時間過了又會開放發送元素。</p>
<p>throttlw比較像是控制行為的最高頻率，也就是說如果我們設定<strong>1000毫秒</strong>，那該事件頻率的最大值就是<strong>每秒觸發一次</strong>不會再更快，debouce則比較像是必須等得的時間，要等到一定的時間過了才會收到元素。</p>
<p>throttlw更適合用在<strong>連續性行為</strong>，比如說UI動畫的運算過程，因為UI動畫是連續的，像我們之前在做拖拉時，就可以加上<code>throttleTime(12)</code>讓mousemove event不要發送的太快，避免畫面更新的速度跟不上樣式的切換速度。</p>
<blockquote>
<p>瀏覽器有一個 <a href="https://developer.mozilla.org/zh-TW/docs/Web/API/Window.requestAnimationFrame">requestAnimationFrame</a> API 是專門用來優化 UI 運算的，通常用這個的效果會比 throttle 好，但並不是絕對還是要看最終效果。</p>
</blockquote>
<blockquote>
<p>RxJS 也能用 requestAnimationFrame 做優化，而且使用方法很簡單，這個部份會在 Scheduler 提到。</p>
</blockquote>
<h4 id="distinct-distinctUntilChanged"><a href="#distinct-distinctUntilChanged" class="headerlink" title="distinct,distinctUntilChanged"></a>distinct,distinctUntilChanged</h4><p>除了throttle和debounce兩個方法來做效能優化，其實還有另一個方法可以做效能的優化處理，那就是distinct</p>
<h5 id="distinct"><a href="#distinct" class="headerlink" title="distinct"></a>distinct</h5><p>如果會下SQL指令的應該都對distinct不陌生，它能幫我們把相同值的資料濾掉只留一筆，RxJS裡的distinct也是相同的作用，看範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, zip, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; distinct &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">distinct</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>) &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// a</span></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// c</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>如果有Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --a--b--c--a--b|</span><br><span class="line">            distince()</span><br><span class="line">example$: --a--b--c------|             </span><br></pre></td></tr></table></figure>

<p>從上面的範例可以看得出來，當我們用distinct後，只要有重複出現的值就會被過濾掉。</p>
<p>另外我們可以傳入一個selector callback functon，這個callback function會傳入一個接收到的元素，並回傳我們真正希望比對的值，如下例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, zip, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; distinct &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([&#123; <span class="attr">value</span>: <span class="string">&quot;a&quot;</span> &#125;, &#123; <span class="attr">value</span>: <span class="string">&quot;b&quot;</span> &#125;, &#123; <span class="attr">value</span>: <span class="string">&quot;c&quot;</span> &#125;, &#123; <span class="attr">value</span>: <span class="string">&quot;a&quot;</span> &#125;, &#123; <span class="attr">value</span>: <span class="string">&quot;c&quot;</span> &#125;]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">distinct</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> x.<span class="property">value</span></span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>) &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// &#123;value: &quot;a&quot;&#125;</span></span><br><span class="line"><span class="comment">// &#123;value: &quot;b&quot;&#125;</span></span><br><span class="line"><span class="comment">// &#123;value: &quot;c&quot;&#125;</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>這裡可以看到，因為source$送出的都是物件，而js物件比對是比對記憶體位置，所以在這個例子中這些物件永遠不會相等，但實際上我們想比對的是物件中的value, 這時我們就可以傳入selector callback，來選擇我們要比對的值。</p>
<p>實際上<code>distinct()</code>會在背地裡建立一個Set，當接收到元素時會先去判斷Set內是否有相同的值，如果有就不送出，如果沒有則存到Set並送出。所以記得盡量不要直接把distinct用在一個無限的observable裡，這樣很可能會讓Set越來越大，建議大家可以放第二個參數flushes或用distinctUntilChanged.</p>
<blockquote>
<p>這裡指的 Set 其實是 RxJS 自己實作的，跟 ES6 原生的 Set 行為也都一致，只是因為 ES6 的 Set 支援程度還並不理想，所以這裡是直接用 JS 實作。</p>
</blockquote>
<p>distinct可以傳入第二個參數flushed observable用來清除暫存的資料，例子如下(目前有問題)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, zip, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; distinct &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;c&quot;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> flushes$ = <span class="title function_">interval</span>(<span class="number">1300</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">distinct</span>(<span class="literal">null</span>, flushes$)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>) &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們用Marble Diagram比較好表示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --a--b--c--a--c|</span><br><span class="line">flushed$: ------------0---...</span><br><span class="line">          distinct(null,fluehes$)</span><br><span class="line">examples$:--a--b--c-----c|          </span><br></pre></td></tr></table></figure>

<p>其實flushes observable就是在送出元素時，會把distinct的暫存清空，所以之後的暫存就會從頭來過，這樣就不用擔心暫存的Set越來愈大的問題，但其實我們平常不太會用這樣的方式來處理，通常會用另一個方法distinctUntilChanged</p>
<h5 id="distinctUntilChanged"><a href="#distinctUntilChanged" class="headerlink" title="distinctUntilChanged"></a>distinctUntilChanged</h5><p>distinctUntilChanged跟distinct一樣會把相同的元素過濾掉，但distinctUntilChanged只會跟最後一次送出的元素比較，不會每個都比，例子如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, zip, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; distinctUntilChanged &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;b&#x27;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">distinctUntilChanged</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>) &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// a</span></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// c</span></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// complete</span></span><br></pre></td></tr></table></figure>

<p>這裡distinctUntilChanged只會暫存一個元素，並在收到元素時跟暫存的元素比對，如果一樣就不送出，如果不一樣就色暫存的元素換成剛接收到的新元素並送出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --a--b--c--c--b|</span><br><span class="line">        distinctUntilChanged()</span><br><span class="line">example$: --a--b--c-----b|</span><br></pre></td></tr></table></figure>

<p>從 Marble Diagram 中可以看到，第二個 c 送出時剛好上一個就是 c 所以就被濾掉了，但最後一個 b 則跟上一個不同所以沒被濾掉。</p>
<p>distinctUntilChanged 是比較常在實務上使用的，最常見的狀況是我們在做多方同步時。當我們有多個 Client，且每個 Client 有著各自的狀態，Server 會再一個 Client 需要變動時通知所有 Client 更新，但可能某些 Client 接收到新的狀態其實跟上一次收到的是相同的，這時我們就可用 distinctUntilChanged 方法只處理跟最後一次不相同的訊息，像是多方通話、多裝置的資訊同步都會有類似的情境。</p>
<h4 id="catchError-retry-retryWhen-repeat"><a href="#catchError-retry-retryWhen-repeat" class="headerlink" title="catchError,retry,retryWhen,repeat"></a>catchError,retry,retryWhen,repeat</h4><p>在dayrxjs.js的檔案，𫍇是錯誤處理(Error Hangling)的operators,錯誤處理是非同步行為中的一大難題，尤其有多個交錯的非同步行為時，更容易凸顯錯誤處理的困難。注意上版是catch</p>
<h5 id="catchError"><a href="#catchError" class="headerlink" title="catchError"></a>catchError</h5><p>catchError是很常見的非同步錯諤處理方法，在RxJS中也能夠直接用catch來處理錯誤，在RxJS中的catch可以回傳一個observable來送出新的值，看範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="title function_">of</span>(<span class="string">&quot;h&quot;</span>))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);  </span><br><span class="line"><span class="comment">//A </span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//h </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>這個範例我們每隔500毫秒會送出一個字串(String)並用字串的方法<code>toUpperCase()</code>來把字串的英文字母改成大寫，過程中可能未知的原因送出了一個數值(Number)<code>2</code>導致發生例外(數值沒有toUpperCase的方法)，這時我們在後面接的catchError就能抓到錯誤。</p>
<p>catchError可以回傳一個新的Observable，Promise，Array或何Iterable的物件，來傳送之後的元素。</p>
<p>以例子來說最後就會在送出<code>X</code>就結束，畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c----d----2|</span><br><span class="line">          map(x=&gt; x.toUpperCase())</span><br><span class="line">          ----A----B----c----d----X|</span><br><span class="line">          catchError(error =&gt; of(<span class="string">&quot;h&quot;</span>))</span><br><span class="line">example$: ----A----B----C----D----h|          </span><br></pre></td></tr></table></figure>

<p>可以看到，當錯誤發生後就會進到catchError並重新處理一個新的observable，我們可以利用這個新的observable來送出我們想送的值。</p>
<p>也可以在遇到錯誤後，讓observable結束如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="title function_">empty</span>())</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br><span class="line"><span class="comment">//A </span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>回傳一個empty的observable來直接結事(complete)</p>
<p>另外catchError的callback能接收第二個參數，這個參數會接收當前的observable，我們可以回傳當前的observable來做到重新執行，範例如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function">(<span class="params">error, obs</span>) =&gt;</span> obs)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p>這裡可以看到我們直接回傳了當前的obserable(其實就是example)來重新執行，畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c----d----2|</span><br><span class="line">          map(x =&gt; x.toUpperCase())</span><br><span class="line">          ----A----B----C----D----X|</span><br><span class="line">          catchError((error, obs) =&gt; obs)</span><br><span class="line">example$: ----A----B----C----D--------A----B----C----D--..          </span><br></pre></td></tr></table></figure>

<p>因為我們只是簡單的示範，所以這裡會一直無限循環，實務上通常會用在斷線重連的情境。</p>
<p>另上面的處理方式有一個簡化的寫法，叫做<code>retry()</code>。</p>
<h5 id="retry"><a href="#retry" class="headerlink" title="retry"></a>retry</h5><p>如果我們想要一個observable發生錯誤時，重新嘗式就可以用retry這個𤆧法 ，跟我們前一個講範例的行為是一致</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, retry &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">retry</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通常這種無限的<code>retry</code>會㪜在即時同步的重新連接，讓我們在連線斷掉後，不斷的嘗式。另外我們也可以設定只嘗試幾次，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, retry &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">retry</span>(<span class="number">1</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//A </span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//A</span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//Error: TypeError: x.toUpperCase is not a function</span></span><br></pre></td></tr></table></figure>

<p>這裡我們對retry傳入一個數值<code>1</code>, 能夠讓我們只重複嘗試1次後送出錯誤，畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c----d----2|</span><br><span class="line">          map(x =&gt; x.toUpperCase()),</span><br><span class="line">          ----A----B----C----D----X|</span><br><span class="line">                retry(1)</span><br><span class="line">example$: ----A----B----C----D--------A----B----C----D----X|                </span><br></pre></td></tr></table></figure>

<p>這種處理方式很適合用在Http request失敗的場景中，我們可以設定重新發幾次後，再秀出錯誤訊息</p>
<h5 id="retyrWhen"><a href="#retyrWhen" class="headerlink" title="retyrWhen"></a>retyrWhen</h5><p>RxJS還提供了另一種方法<code>retryWhen</code>，他可以把例外發生的元素放到一個observable中，讓我們可以直接操作這個observable,並等到這個observable操作完後再重新訂閱一次原來的observable。看範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, retryWhen, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">retryWhen</span>(<span class="function"><span class="params">errorObs</span> =&gt;</span> errorObs.<span class="title function_">pipe</span>(<span class="title function_">delay</span>(<span class="number">1000</span>)))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br><span class="line"><span class="comment">//A </span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br><span class="line"><span class="comment">//一秒</span></span><br><span class="line"><span class="comment">//A</span></span><br><span class="line"><span class="comment">//B </span></span><br><span class="line"><span class="comment">//C </span></span><br><span class="line"><span class="comment">//D </span></span><br></pre></td></tr></table></figure>

<p>這裡retyrWhen我們傳入一個callback，這個callback有一個參數會傳入一個observable這個observable不是原本的observable(example), 而是例外事件送出的錯誤所組成的一個observable，我們可以對這個由錯誤所組成的observable做操作，等而這次的處理完成後就會重新訂閱我們原本的observable。</p>
<p>這個範例我們是把錯誤的observable送出錯誤延遲1秒，這會使後面重新訂閱動作延遲1秒才執行，Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c----d----2|</span><br><span class="line">         map(x =&gt; x.toUpperCase())</span><br><span class="line">          ----A----B----C----D----X|</span><br><span class="line">         retryWhen(errorObs =&gt; errorObs.pipe(delay(1000)))</span><br><span class="line">example$: ----A----B----C----D-------------------A----B----C----D----.....          </span><br></pre></td></tr></table></figure>

<p>從上圖可以看到後續動新訂閱的為就被延後山，但實務上我們不太會用retryWhen來做重新訂閱的延遲，通常是直接用catchError做到這件事。這裡只是為了示範retryWhen的行為，實務上我們通常會把retyrWhen拿來做錯誤通知或是例外收集範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, retryWhen, delay &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>()),</span><br><span class="line">    <span class="title function_">retryWhen</span>(<span class="function"><span class="params">errorObs</span> =&gt;</span> errorObs.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">err</span>=&gt;</span> <span class="title function_">fetch</span>(<span class="string">&#x27;....&#x27;</span>))))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p>這裡的<code>errorObs.pipe(map(err=&gt; fetch(&#39;....&#39;)))</code>可以把errorObs裡的每個錯誤變成API的發送，通常這裡的API會像是送訊息到公司的通訊頻道(Slack等等)，這樣可以讓工程師馬上知道可服哪個API掛了，這樣我們就能即時地處理，</p>
<blockquote>
<p>retryWhen實際上是在背地裡建立一個Subject並把錯誤放入，會在對這個Subject進行內部的訂閱，因為我們還沒有講到Subject的觀念，大舉可以先把它當作Observable就好了。另外記得這個observable預設是無限的，如果我們把它結束，原本的observable也會跟著結束。</p>
</blockquote>
<h5 id="repeat"><a href="#repeat" class="headerlink" title="repeat"></a>repeat</h5><p>我們有時候可能想要retry一直重複訂閱的效果，但沒有錯誤發生，這時就可以用repeat來做到這件事，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; repeat &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">repeat</span>(<span class="number">1</span>));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br><span class="line"><span class="comment">//a </span></span><br><span class="line"><span class="comment">//b </span></span><br><span class="line"><span class="comment">//c </span></span><br><span class="line"><span class="comment">//complete </span></span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ----a----b----c|</span><br><span class="line">		  repeat(1)</span><br><span class="line">exapmle$: ----a----b----c|		  </span><br></pre></td></tr></table></figure>

<p>我們可以不給參數讓它無限循環如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; repeat &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>]);</span><br><span class="line"><span class="title function_">zip</span>(<span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">repeat</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p>這樣我們就可以做不斷重複的行為，這個可以在建立輪詢時使用，讓我們不斷地發request來更新畫面。</p>
<p>我們來看一個錯誤處理在實務應用中的小範例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval, zip, <span class="keyword">of</span>, empty &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError, concat &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; startWith &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs-compat/operator/startWith&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> title = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;title&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">500</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="title function_">toUpperCase</span>())</span><br><span class="line">    <span class="comment">// 通常 source 會是建立即時同步的連線，像是 web socket</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function">(<span class="params">error, obs</span>) =&gt;</span> obs.<span class="title function_">pipe</span>(</span><br><span class="line">        <span class="title function_">empty</span>(),</span><br><span class="line">        <span class="title function_">startWith</span>(<span class="string">&#x27;連線發生錯誤： 5秒後重連&#x27;</span>),</span><br><span class="line">        <span class="title function_">concat</span>(obs.<span class="title function_">delay</span>(<span class="number">5000</span>))</span><br><span class="line">    ))</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p>這個範例其實就是模仿在即時同步斷線特，利用catchErroy返品一個新的observable，這固observable會先送出錯誤訊息並且把原本的observable延遲5秒再做合併，雖然這只是一個模仿，但它清楚的展示了 RxJS 在做錯誤處理時的靈活性。</p>
<h4 id="switchAll-mergeAll-concatAll"><a href="#switchAll-mergeAll-concatAll" class="headerlink" title="switchAll, mergeAll, concatAll"></a>switchAll, mergeAll, concatAll</h4><p>這三個operators都是用來處理Higher Order Observable。所謂的Higher Order Observable就是指一個Observable送出的元素還是一個Observable，就像是二維陣列一樣，一個陣列中的每個元素都是陣列。如果用泛型來表達就像是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;Observable&lt;T&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>通常我們需要的是第二層Observable送出的元素，所以我們希望可以把二維的Observable改成一維的，像是下面這樣</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;Observable&lt;T&gt;&gt; =&gt; Observable&lt;T&gt;</span><br></pre></td></tr></table></figure>

<p>其實想要做到這件事有三個方法switchAll、mergeAll、concatAll</p>
<h5 id="concatAll-1"><a href="#concatAll-1" class="headerlink" title="concatAll"></a>concatAll</h5><p>在簡易拖拉的範例時有講過這個operator,concatAll最動要的重點就是他會處理完前一個observable, 才會在處理下一個observable, 讓我們來看一個例子<a href="https://js-f1cdwc.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,concatAll&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>)));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concatAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// (點擊後)</span></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5 ...</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，當我們點擊畫面時就會開始送出數值，如果用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \    </span><br><span class="line">                     \ ----0----1----2----3----4--...</span><br><span class="line">                      ----0----1----2----3----4--...</span><br><span class="line">                      concatAll()</span><br><span class="line">example$: ----------------0----1----2----3----4--..                      </span><br></pre></td></tr></table></figure>

<p>從Marble Diagram可以看得出來，當我們點擊一下click事件會被轉成一個observable而這個observable會每一秒送出一個遞增的數值，當我們用concatAll之後會把二維的observable攤平成一維的observable，但<strong>concatAll會一個一個處理，一定是等前一個observable完成(complete)才會處理下一個observable</strong>，因為現在送出observable是無限的永遠不會完成(complete)，就導致他永遠不會處理第二個送出的observable!</p>
<p>再看一個例子<a href="https://js-wdl2qz.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,concatAll,take&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">concatAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>現在我們把送出的observable限制只取前三個元素，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000).pipe(take(3)))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \                  \ </span><br><span class="line">                     \ ----0----1----2|   ----0----1----2</span><br><span class="line">                      ----0----1----2|</span><br><span class="line">                      concatAll()</span><br><span class="line">example$: ----------------0----1----2----0----1--..   </span><br></pre></td></tr></table></figure>

<p>這裡我們把送出的observable變成有限的，只會送出三個元素，這時就能看得出來concatAll不管兩個observable送出的時間多麼相近，一定會先處理前一個observable再處理下一個。</p>
<h5 id="switchAll"><a href="#switchAll" class="headerlink" title="switchAll"></a>switchAll</h5><p>switchAll同樣能把二維的observable攤平一維的，但他們在行為上有很大的不同，我們來看下面這個範例<a href="https://stackblitz.com/edit/js-ur4ceo?file=index.js">stackblitz.</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,switchAll,take&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>)));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">switchAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \                  \----0----1--..</span><br><span class="line">                     \ ----0----1----2----3----4--...</span><br><span class="line">                      ----0----1----2----3----4--...</span><br><span class="line">                      switch()</span><br><span class="line">example$: ----------------0----1----2--------0----1--..   </span><br></pre></td></tr></table></figure>

<p>switch最重要的就是他會<strong>在新的observable送出後直接處理新的observable不管前一個observable是否完成，每當有新的observable送出就會直接把舊的observable退訂(unsubscribe), 永遠只處理最新的observable!</strong></p>
<p>所以在這上面的Marble Diagram可以看得出來第一次送出的observable跟第二次送出的observable時間點太近，導致第一個observable還來不及送出元素就直接被退訂了，當下一次送出observable就又會把前一次的observable退訂。</p>
<h5 id="margeAll"><a href="#margeAll" class="headerlink" title="margeAll"></a>margeAll</h5><p>它會把二維的observable轉成一維的，並且能夠同時處理所有的observable，讓我們來看這個範例<a href="https://js-k6g4x6.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,mergeAll,take&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>)));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">mergeAll</span>());</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \                  \----0----1--..</span><br><span class="line">                     \ ----0----1----2----3----4--...</span><br><span class="line">                      ----0----1----2----3----4--...</span><br><span class="line">                      switch()</span><br><span class="line">example$: ----------------00---11---22---33---(04)4--..   </span><br></pre></td></tr></table></figure>

<p>從Marble Diagram可以看出來，所有的observable是並行(Parallel)處理的，也就是說mergeAll不會像switchAll一樣退訂(unsubscribe)原先的observable而是並行處理多個observable。以範例來說，當我們點擊越多下，最後送出的頻率就會越快。另外mergeAll可以傳入一個數值，這個數值代表他可以同時處理的observable數量，來看一個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent,interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map,mergeAll,take&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = click$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">mergeAll</span>(<span class="number">2</span>));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們送出的observable改成取前三個，並且讓mergeAll最多只能同時處理2個observable, 用Darble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">click$  : ---------c-c------------------c--.. </span><br><span class="line">            map(e =&gt; interval(1000).pipe(take(3))</span><br><span class="line"><span class="built_in">source</span>$ : ---------o-o------------------o--..</span><br><span class="line">                    \ \                  \----0----1----2|</span><br><span class="line">                     \ ----0----1----2|</span><br><span class="line">                      ----0----1----2|</span><br><span class="line">                      mergeAll(2)</span><br><span class="line">example$: ----------------00---11---22---0----1----2..   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>當mergeAll傳入參數後，就會等處理中的其中一個observable完成，再去處理下一個。以我們的例子來說，前面兩個observable可以被並行處理，但第三個observable必須等到第一個observable束後，才會開始。</p>
<p>我們可以利用這個參數來決定要同時處理幾個observable。如果我們傳入<code>1</code>其行為就會跟<code>concatAll</code>是一模一樣的。</p>
<h4 id="switchMap-mergeMap-concatMap"><a href="#switchMap-mergeMap-concatMap" class="headerlink" title="switchMap, mergeMap, concatMap"></a>switchMap, mergeMap, concatMap</h4><p>這三個operators在很多的RxJS相關的library的使用範例上都會看到。</p>
<h5 id="concatMap"><a href="#concatMap" class="headerlink" title="concatMap"></a>concatMap</h5><p>concatMap其實就是map加上concatAll的簡化寫法，看範例<a href="https://js-f7bstc.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, concatAll, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))),</span><br><span class="line">  <span class="title function_">concatAll</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面這個範例就可以簡化成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concatMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">concatMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">100</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>)))</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>注意時間有改變</strong>, 前後兩個行為是一致，記得concatMap也會先處理前一個送出的observable在處理下一個observable，畫成Marble Diagram如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : -----------c--c------------------...</span><br><span class="line">         concatMap(e =&gt; interval(100).pipe(take(3)))</span><br><span class="line">example$: -----------0-1-2-0-1-2-----------...         </span><br></pre></td></tr></table></figure>

<p>這樣的行為也很常被用在發送request如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concatMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">concatMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()) )</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們每點擊一下畫面就會送出一個HTTP request,如果我們快速的連續點擊，可以在開發工具的network看到每個request是等到前一個request完成才會送出下一個request如下圖</p>
<img src="2019-07-17_09_46_19_Image.png" style="zoom:80%;" />

<p>從newwork的圖形可以看得出來，第二個request的發送時間是接在第一個request之後的，我們可以確保每一個request會等前一個request完成才做處理。</p>
<p>concatMap還有第二個參數是一個selector callback, 這個callback會傳入四個參數，分別是</p>
<ol>
<li><p>外部observable送出的元素</p>
</li>
<li><p>內部observable送出的元素</p>
</li>
<li><p>外部observable送出的元素的index</p>
</li>
<li><p>內部observable送出的元素三index</p>
</li>
</ol>
<p>回傳值我們想要的值，範例如下<a href="https://js-phxvjv.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concatMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">concatMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()),<span class="function">(<span class="params">e,res,eIndex,resIndex</span>)=&gt;</span> res.<span class="property">title</span> )</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這個範例的外部observable送出的元素就是click event物件，內部observable送出的元素就是response物件，這裡我們回傳response物件的title屬性，這樣一來我們就可以直接到到title, 這個方法很適合在response要選取的值跟前一個事件或順位(index)相關時。</p>
<h5 id="switchMap"><a href="#switchMap" class="headerlink" title="switchMap"></a>switchMap</h5><p>switchMap其實就是map加上switchAll簡化的寫法，如下<a href="https://js-aqx4tt.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, switchAll, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))),</span><br><span class="line">  <span class="title function_">switchAll</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面的程式碼可以簡化成<a href="https://js-aqx4tt.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, switchMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">100</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))),</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : -----------c--c-----------------...</span><br><span class="line">          switchMap(e =&gt; interval(100).pipe(take(3)))</span><br><span class="line">example$: -----------0--0-1-2-------------...          </span><br></pre></td></tr></table></figure>

<p>只要注意一個重點switchMap會在下一個observable被送出後直接退訂前一個未處理完的observable。</p>
<p>另外我們也可以把switchMap用在發送HTTP request<a href="https://js-mfg7zu.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; switchMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()) )</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果我們快速的連續點擊五下，可以在開發工具的network看到每個request會在點擊時發送，雖然我們發送了多個rquest但最後真正印出來的log只會有一個, 代表前面發送的request已經不會造成任何的side-effect了，這個很適合用在只看最後一次request的情境，比如說自動完成(auto complete),我們只需要顯示使用者最後一次打在畫面上的文字，來做建議選項而不用每一次的。</p>
<p>switchMap跟concatMap一樣有第二個參數selector callback可用來回傳我們要的值，這部分的行為跟concatMap是一樣的，這裡就不再贅述。</p>
<h5 id="mergeMap"><a href="#mergeMap" class="headerlink" title="mergeMap"></a>mergeMap</h5><p>mergeMap其實就是map加上mergeAll簡化的寫法如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mergeAll, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>))),</span><br><span class="line">  <span class="title function_">mergeAll</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面的程式碼可以簡化成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, mergeMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">mergeMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">interval</span>(<span class="number">100</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>)))</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>畫成Marble Diagram表示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : -----------c-c------------------...</span><br><span class="line">          mergeMap(e =&gt; interval(100).pipe(take(3)))</span><br><span class="line">example$: -------------0-(10)-(21)-2------...          </span><br></pre></td></tr></table></figure>

<p>記得mergeMap可以並行處理多個observable，以個例子來說當我們快速按兩下，元素發送的時間點是有機會重疊的。</p>
<p>另外我們也可以把mergeMap用在發送HTTP request<a href="https://js-j4o2di.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mergeMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">mergeMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()) )</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果我們快速的連續點擊五下，大家可以在開發者工具的 network 看到每個 request 會在點擊時發送並且會 log 出五個物件</p>
<p>mergeMap也能傳入第二個參數selector callback，這個selector callback跟concatMap第二個參睥也是完全一樣的，但mergeMap的重點是我們可以傳入第三個參數，來限制並行處理的數量<a href="https://js-ps6esy.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mergeMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">mergeMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getPostData</span>()), <span class="function">(<span class="params">e, res, eIndex, resIndex</span>) =&gt;</span> res.<span class="property">title</span>, <span class="number">3</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡我們傳入 3 就能限制，HTTP request 最多只能同時送出 3 個，並且要等其中一個完成在處理下一個</p>
<p>switchMap, mergeMap, concatMap</p>
<p>這三個 operators 還有一個共同的特性，那就是這三個 operators 可以把第一個參數所回傳的 promise 物件直接轉成 observable，這樣我們就不用再用 <code>from</code> 轉一次，如下<a href="https://js-ttxeyr.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; concatMap, take &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPersonData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">concatMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getPersonData</span>())<span class="comment">//直接回傳 promise 物件</span></span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span> + err); &#125;,</span><br><span class="line">  <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>至於在使用上要如何選擇這三個operators?其實都還是看使用情境而定，這裡簡單列一下大部分的使用情境</p>
<ul>
<li><p>concatMap用在可以確定<strong>內部的observable結束時間比外部observable發送時間來快的情境</strong>。並且不希望有任何並行處理行為，適合少數要一次一次完成到底的UI動畫或特別的HTTP request行為。</p>
</li>
<li><p>switchMap用在只要最後一次行為的結果，適合絕大多數的使用情境。</p>
</li>
<li><p>mergeMap用在並行處理多個observable，適合需要並行處理的行為，像是多個I&#x2F;O的並行處理。</p>
<blockquote>
<p>建議初學者不確定選哪一個時，使用 switchMap</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>在使用 concatAll 或 concatMap 時，請注意內部的 observable 一定要能夠的結束，且外部的 observable 發送元素的速度不能比內部的 observable 結束時間快太多，不然會有 memory issues</p>
</blockquote>
<h4 id="簡易Auto-Complete實作"><a href="#簡易Auto-Complete實作" class="headerlink" title="簡易Auto Complete實作"></a>簡易Auto Complete實作</h4><p>RxJS的經典範例-自動完成(Auto Complete)，自動完成在實數上的應用非常廣泛，幾乎隨處可見這樣的功能，只履是跟表單、搜尋相關的都會看到。雖然是個很常見的功能，但多數工程師都只是直接套套件來完成，很少有人會自已從頭到尾把完整的邏輯寫一次。如果有自已實作過這個功能的工程師，應該就會知道這個功能在實作的過程中很多細節會讓程式碼變的非常複雜，像是要如何取消上一次發送出去的request、要如何優化請求次數…等等，這些小細節都會讓程式碼變的非常複雜且很難維護。</p>
<h4 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h4><p>首先我們會有一個尋框(input#search),當我們在上面打字並停頓超100毫秒就發送HTTP Request來取得建議選項並顯示在收尋框下方(ul#suggest-list),如果使用者在前一次發送的請求還沒有回來就打了下一個字，此時前一個發送的請求就要捨棄掉，當建議選項顯示之後可以用滑鼠點擊取建議選項代替搜尋框的文字。</p>
<p>上面的敘述可以拆分成以下幾個步驟</p>
<ul>
<li><p>準備input#search以及ul#suggest-list的HTML與CSS</p>
</li>
<li><p>在input#search輸入文字時，等得100毫秒再輸入，就發送HTTP Request</p>
</li>
<li><p>當Response還沒回來時，使用者又輸入了下一個文字就捨棄前一次的輸入並再發送一次新的Request</p>
</li>
<li><p>接受到Response之後顯示建議選項</p>
</li>
<li><p>滑鼠點擊後取代input#search的文字</p>
</li>
</ul>
<p><a href="https://js-2d9ntg.stackblitz.io/">stackblitz</a>在<code>html</code>  中,首先在HTML裡有一個input(#search),這個input(#search)就是要用來輸入的欄位，它下方有一固ul(#suggest-list),則是放建議選項的地方</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;autocomplete&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span> <span class="attr">type</span>=<span class="string">&quot;search&quot;</span> <span class="attr">id</span>=<span class="string">&quot;search&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;suggest-list&quot;</span> <span class="attr">class</span>=<span class="string">&quot;suggest&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>css</code>中</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-tag">html</span>, <span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: white;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.autocomplete</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.input</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">border</span>: none;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid black;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">24px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line">  &amp;<span class="selector-pseudo">:focus</span> &#123;</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">    <span class="attribute">border-bottom-color</span>: blue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.suggest</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">list-style</span>: none;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  -webkit-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">4px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.2</span>);</span><br><span class="line">  <span class="selector-tag">li</span> &#123;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span>;</span><br><span class="line">    &amp;<span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">      <span class="attribute">background-color</span>: lightblue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>javascript</code>中已經寫好了要發送API的url跟方法<code>getSuggestList</code>,接著就開始實作自動完成的效果吧！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url = <span class="string">&#x27;https://zh.wikipedia.org/w/api.php?action=opensearch&amp;format=json&amp;limit=5&amp;origin=*&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getSuggestList</span> = (<span class="params">keyword</span>) =&gt; <span class="title function_">fetch</span>(url + <span class="string">&#x27;&amp;search=&#x27;</span> + keyword, &#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">mode</span>: <span class="string">&#x27;cors&#x27;</span> &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>())</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="第一步取得需要的DOM物件"><a href="#第一步取得需要的DOM物件" class="headerlink" title="第一步取得需要的DOM物件"></a>第一步取得需要的DOM物件</h5><p>這裡我們會用到#search以及#suggest-list這兩個DOM</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> searchInput= <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;search&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> suggestList= <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;suggest-list&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="第二步，建立所需的Observable"><a href="#第二步，建立所需的Observable" class="headerlink" title="第二步，建立所需的Observable"></a>第二步，建立所需的Observable</h5><p>這裡我們要監聽收尋欄位的input事件，以及建議選項的點擊事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> keyword$ = <span class="title function_">fromEvent</span>(searchInput,<span class="string">&quot;input&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> selectItem$= <span class="title function_">fromEvent</span>(suggestList,<span class="string">&quot;click&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="第三步，撰寫程式邏輯"><a href="#第三步，撰寫程式邏輯" class="headerlink" title="第三步，撰寫程式邏輯"></a>第三步，撰寫程式邏輯</h5><p>每當使用者輸入文字就要發送HTTP request並且有新的值被輸入後就捨棄前一次發送的，所以這裡用switchMap</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>這裡我們先試著訂閱，看一下API會回傳什麼樣的資料</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>))</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p>在search欄位亂打幾個字</p>
<img src="2019-07-18_09_42_04_Image.png" style="zoom:80%;" />

<p>可以在console看到資料長相這樣，會回傳一個陣列帶有四個元素，其中第一個元素是我們輸入的值，第二個元素才是我們要的建議選項清單。</p>
<p>所以我們要取的是response陣列的第二的元素，用switchMap的第二個參睥來選取我們要的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>),<span class="function">(<span class="params">e,res</span>)=&gt;</span>res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p>寫一個render方法，把陣列轉成li並寫入suggestList</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">render</span> = (<span class="params">suggestArr=[]</span>)=&gt;&#123;</span><br><span class="line">    suggestList.<span class="property">innerHTML</span> = suggestArr</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">&quot;&lt;li&gt;&quot;</span>+ item+<span class="string">&quot;&lt;/li&gt;&quot;</span>)</span><br><span class="line">    	.<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這時我們就可用render方法把取得的陣列傳入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">render</span> = (<span class="params">suggestArr = []</span>) =&gt; &#123;</span><br><span class="line">  suggestList.<span class="property">innerHTML</span> = suggestArr</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">&quot;&lt;li&gt;&quot;</span> + item + <span class="string">&quot;&lt;/li&gt;&quot;</span>)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>),<span class="function">(<span class="params">e,res</span>)=&gt;</span>res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">.<span class="title function_">subscribe</span>(<span class="function"><span class="params">list</span> =&gt;</span> <span class="title function_">render</span>(list));</span><br></pre></td></tr></table></figure>

<p>如此一來我們打字就能看到結果出現在input下方了</p>
<img src="2019-07-18_10_01_12_Image.png" style="zoom:80%;" />

<p>只是目前還不能點選，先讓我們來做點選的功能，這裡點選的功能我們需要用到delegation event的小技巧，利用ul的click事件，來篩選是否點到了li，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">selectItem$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="title function_">matches</span>(<span class="string">&quot;li&quot;</span>))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>上面我們利用DOM物件的matches方法(裡面的字串放css的selector)來過濾出有點擊到li的事件，再用map轉出我們要的值並寫入input。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">selectItem$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="title function_">matches</span>(<span class="string">&quot;li&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">innerText</span>),</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">text</span> =&gt;</span> searchInput.<span class="property">value</span> = text)</span><br></pre></td></tr></table></figure>

<p>現在我們就能點擊建議清單了，但是點擊後清單沒有消失，這裡我們要在點擊後重新render, 所以把上面的程式碼改一下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">selectItem$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="title function_">matches</span>(<span class="string">&quot;li&quot;</span>)),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">innerText</span>),</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">text</span> =&gt;</span> &#123;</span><br><span class="line">    searchInput.<span class="property">value</span> = text;</span><br><span class="line">    <span class="title function_">render</span>();</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>這樣一來我們就完成最基本的功能了。</p>
<p>還記得我們前面說每次打完字要等待100毫秒在發送request嗎?這樣能避免過多的request發送，可以降低server的負載也會有比較好的使用者體驗，要做到這件使很簡單只要加上<code>debounceTime(100)</code>就完成了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">debounceTime</span>(<span class="number">100</span>),  </span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>), <span class="function">(<span class="params">e, res</span>) =&gt;</span> res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">list</span> =&gt;</span> <span class="title function_">render</span>(list));</span><br></pre></td></tr></table></figure>

<p>當然這個數值可以依照需求或是請UX針對這個細節作調整。</p>
<p>用了不到30行的程式碼就完成了autocomplete的基本功能，當我們能夠自已從頭到尾的完成這樣的功能，在面對個各種不同的需求，我們就能很方更的針對需求作調整，而不受到套件的牽制！比如說我們希望使用者打了2個字以上在發送request，這時我們只要加上一行filter就可以了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span>=&gt;</span> e.<span class="property">target</span>.<span class="property">value</span>.<span class="property">length</span> &gt;<span class="number">2</span>),  </span><br><span class="line">  <span class="title function_">debounceTime</span>(<span class="number">100</span>),  </span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>), <span class="function">(<span class="params">e, res</span>) =&gt;</span> res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">list</span> =&gt;</span> <span class="title function_">render</span>(list));</span><br></pre></td></tr></table></figure>

<p>又或者網站的使用量很大，可能API在量大的時候會回傳失敗，主管希望可以在API失敗的時候重新嘗試3次，我們只要加個<code>retry(3)</code>就完成了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">keyword$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">target</span>.<span class="property">value</span>.<span class="property">length</span> &gt; <span class="number">2</span>),</span><br><span class="line">  <span class="title function_">debounceTime</span>(<span class="number">100</span>),</span><br><span class="line">  <span class="title function_">switchMap</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">from</span>(<span class="title function_">getSuggestList</span>(e.<span class="property">target</span>.<span class="property">value</span>)).<span class="title function_">pipe</span>(<span class="title function_">retry</span>(<span class="number">3</span>)), <span class="function">(<span class="params">e, res</span>) =&gt;</span> res[<span class="number">1</span>])</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="function"><span class="params">list</span> =&gt;</span> <span class="title function_">render</span>(list));</span><br></pre></td></tr></table></figure>

<p>大家會發現我們的靈活度變的非常高，又同時兼顧了程式碼的可讀性，短𠞽的幾行程式碼就完成了一個複雜的需求，這就是RxJS的魅力啊</p>
<h4 id="window-windowToggle"><a href="#window-windowToggle" class="headerlink" title="window, windowToggle"></a>window, windowToggle</h4><p>上面有提到能把Higher Order Observable轉成一般的Observable的operators，今天我們要講能夠把一般的Observable轉成Hight Order Observable的operators。其實前端不太有機會用到這類型的Operators，都是在比較特殊的需求下才會看到，但還是會有遇到的時候。</p>
<h5 id="window"><a href="#window" class="headerlink" title="window"></a>window</h5><p>window是一整個家族總共有五個相關的operators</p>
<ul>
<li><p>window</p>
</li>
<li><p>windowCount</p>
</li>
<li><p>windowTime</p>
</li>
<li><p>windowToggle</p>
</li>
<li><p>windowWhen</p>
</li>
</ul>
<p>我們只介紹window跟windowToggle這兩個方法，其他三個的用法相對都簡單很多，大家如果有需要可以再自行到官網查看。</p>
<p>window很類似buffer可以把一段時間內送出的元素拆出來，只是buffer是把元素拆分到陣列中變成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Observable</span>&lt;T&gt; =&gt; <span class="title class_">Observable</span>&lt;<span class="title class_">Array</span>&lt;T&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>而window則是會把元素拆分出來放到新的observable變成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;T&gt; =&gt; Observable&lt;Observable&lt;T&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>buffer是把拆分出來的元素放到陣列並送出陣列；window是把拆分出來的元素放到observable並送出observable來𢒆一個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; switchAll,<span class="variable language_">window</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> click$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$= source$.<span class="title function_">pipe</span>(<span class="title function_">window</span>(click$));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">pipe</span>(<span class="title function_">switchAll</span>())</span><br><span class="line">    .<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5 ...</span></span><br></pre></td></tr></table></figure>

<p>首先window要傳入一個observable，每當這個observable送出元素時，就會把正在處理的observable所送出的元素放到新的observable中並送出，這裡看Marble Diagram會比較好解䆁</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">click$ : -----------c----------c------------c--</span><br><span class="line"><span class="built_in">source</span>$: ----0----1----2----3----4----5----6---..</span><br><span class="line">            window(click$)</span><br><span class="line">example$:o----------o----------o------------o--   </span><br><span class="line">         \          \          \</span><br><span class="line">          ---0----1-|--2----3--|-4----5----6|</span><br><span class="line">              switchAll()</span><br><span class="line">       : ----0----1----2----3----4----5----6---...     </span><br></pre></td></tr></table></figure>

<p>這裡可看到example$變成發送observable會在每次click事件發送出來後結束，並繼續下一個observable，這裡我們用switchAll把它攤平。</p>
<p>當然這固範例只是想單純的表達widow的作用，沒有什麼太大的意義，實務上window會搭配其他的operators使用，例如我們想計算一秒鐘內觸發了幾次click事件<a href="https://js-jc7wys.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> click$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>,<span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, switchAll, <span class="variable language_">window</span>, count &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> example$ = click$.<span class="title function_">pipe</span>(<span class="title function_">window</span>(source$));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">map</span>(<span class="title function_">count</span>()),</span><br><span class="line">  <span class="title function_">switchAll</span>()</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);= click$.<span class="title function_">pipe</span>(<span class="title function_">window</span>(source$));</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="title function_">count</span>())</span><br><span class="line">    <span class="title function_">switchAll</span>()</span><br><span class="line">)</span><br><span class="line">    .<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>這裡我們把source$跟click$對調了，並用到了observable的一個方法<code>count()</code>,可以用來取得observable總共送出了幾個元素，用Marble Diagram表示如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ---------0---------1---------2--...</span><br><span class="line">           window(<span class="built_in">source</span>$)</span><br><span class="line">click$  : o--------o---------o---------o--..</span><br><span class="line">          \        \         \         \</span><br><span class="line">          -cc---cc|---c-c---|---------|--..</span><br><span class="line">              map(count())</span><br><span class="line">        : o--------o---------o---------o--</span><br><span class="line">         \        \         \         \</span><br><span class="line">          -------4|--------2|--------0|--..</span><br><span class="line">                    switchAll()</span><br><span class="line">        : ---------4---------2---------0--...       </span><br></pre></td></tr></table></figure>

<p>從Marble Diagram中可以看出來，我們把部分元素放到新的observable中，就可以利用Observable的方法做更靈活的操作</p>
<h5 id="windowToggle"><a href="#windowToggle" class="headerlink" title="windowToggle"></a>windowToggle</h5><p>windowToggle不像window只能控制內部observable的結束，windowToggle可以傳入兩個參數，第一個是開始的observable，第二個是一個callback可以回傳一個結束的observable，看範例<a href="https://js-bywet3.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source$= <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> mouseDown$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;mousedown&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> mouseUp$= <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&quot;mouseup&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">windowToggle</span>(mouseDown$,<span class="function">()=&gt;</span> mouseUp$),</span><br><span class="line">    <span class="title function_">switchAll</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p>一樣用 Marble Diagram 會比較好解釋</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$   : ----0----1----2----3----4----5--...</span><br><span class="line"></span><br><span class="line">mouseDown$: -------D------------------------...</span><br><span class="line">mouseUp$  : ---------------------------U----...</span><br><span class="line"></span><br><span class="line">        windowToggle(mouseDown, () =&gt; mouseUp)</span><br><span class="line"></span><br><span class="line">          : -------o-------------------------...</span><br><span class="line">                  \</span><br><span class="line">                   -1----2----3----4--|</span><br><span class="line">                   switchAll()</span><br><span class="line">example$  : ---------1----2----3----4---------...  </span><br></pre></td></tr></table></figure>

<p>從 Marble Diagram 可以看得出來，我們用 windowToggle 拆分出來內部的 observable 始於 mouseDown 終於 mouseUp。</p>
<h5 id="groubBy"><a href="#groubBy" class="headerlink" title="groubBy"></a>groubBy</h5><p>一個實務上比較常用的operators-groupBy, 它可以幫我們把相同條𤗣的元素拆分成一個Observable，其實就跟平常在下SQL是一樣的概念，我們先來看個例子<a href="https://js-dvlbxt.stackblitz.io/">stackblitz</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, switchAll, windowToggle, count,take ,groupBy&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ =<span class="title function_">interval</span>(<span class="number">300</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">groupBy</span>(<span class="function"><span class="params">x</span> =&gt;</span> x % <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">// GroupObservable &#123; key: 0, ...&#125;</span></span><br><span class="line"><span class="comment">// GroupObservable &#123; key: 1, ...&#125;</span></span><br></pre></td></tr></table></figure>

<p>上面的例子，我們傳入了一個callback function並回傳groupBy的條件，就能區分每個元素到不同的Observable中，用Marble Diagram表示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : ---0---1---2---3---4|</span><br><span class="line">             groupBy(x =&gt; x % 2)</span><br><span class="line">example$: ---o---o------------|</span><br><span class="line">            \   \</span><br><span class="line">            \   1-------3----|</span><br><span class="line">            0-------2-------4|</span><br></pre></td></tr></table></figure>

<p>在實務上，我們可以拿groupBy做完元素四區分後，再對inner Observable操作，例如下面這個例子我們將每個人的分數作加總再送出<a href="https://js-rcq59q.stackblitz.io/">stackblitz.</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; zip, map, switchAll, mergeAll, count, take, groupBy, reduce &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> people = [</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Anna&#x27;</span>, <span class="attr">score</span>: <span class="number">100</span>, <span class="attr">subject</span>: <span class="string">&#x27;English&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Anna&#x27;</span>, <span class="attr">score</span>: <span class="number">90</span>, <span class="attr">subject</span>: <span class="string">&#x27;Math&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Anna&#x27;</span>, <span class="attr">score</span>: <span class="number">96</span>, <span class="attr">subject</span>: <span class="string">&#x27;Chinese&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Jerry&#x27;</span>, <span class="attr">score</span>: <span class="number">80</span>, <span class="attr">subject</span>: <span class="string">&#x27;English&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Jerry&#x27;</span>, <span class="attr">score</span>: <span class="number">100</span>, <span class="attr">subject</span>: <span class="string">&#x27;Math&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Jerry&#x27;</span>, <span class="attr">score</span>: <span class="number">90</span>, <span class="attr">subject</span>: <span class="string">&#x27;Chinese&#x27;</span> &#125;,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>(people);</span><br><span class="line"><span class="title function_">zip</span>(source$, <span class="title function_">interval</span>(<span class="number">300</span>), <span class="function">(<span class="params">x, y</span>) =&gt;</span> x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">  <span class="title function_">groupBy</span>(<span class="function"><span class="params">person</span> =&gt;</span> person.<span class="property">name</span>),</span><br><span class="line">  <span class="title function_">map</span>(<span class="function"><span class="params">group</span> =&gt;</span> group.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, curr</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">name</span>: curr.<span class="property">name</span>,</span><br><span class="line">      <span class="attr">score</span>: curr.<span class="property">score</span> + acc.<span class="property">score</span></span><br><span class="line">    &#125;))</span><br><span class="line">  )),</span><br><span class="line">  <span class="title function_">mergeAll</span>()</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">// &#123; name: &quot;Anna&quot;, score: 286 &#125;</span></span><br><span class="line"><span class="comment">// &#123; name: &#x27;Jerry&#x27;, score: 270 &#125;</span></span><br></pre></td></tr></table></figure>

<p>這裡我們範例是想把 Jerry 跟 Anna 的分數個別作加總，畫成 Marble Diagram 如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span>$ : --o--o--o--o--o--o|</span><br><span class="line">  </span><br><span class="line">  groupBy(person =&gt; person.name)</span><br><span class="line">     </span><br><span class="line">       : --i--------i------|</span><br><span class="line">           \        \</span><br><span class="line">           \         o--o--o|</span><br><span class="line">            o--o--o--|</span><br><span class="line">            </span><br><span class="line">	   map(group =&gt; group.pipe(reduce(...)))</span><br><span class="line">	     </span><br><span class="line">       : --i---------i------|</span><br><span class="line">           \         \</span><br><span class="line">           o|        o|</span><br><span class="line">        </span><br><span class="line">             mergeAll()</span><br><span class="line">example$: --o---------o------|          </span><br></pre></td></tr></table></figure>

<h3 id="深入Observable"><a href="#深入Observable" class="headerlink" title="深入Observable"></a>深入Observable</h3><p>以上將大部分的operators都介紹完了，沒有機會好好的解䆁Observable的operators運作方式，一開始是以陣列(Array)的operators(map,filter,concatAll)作為切入點，在學習observable時會更容更接受跟理解，但實際上observable的operators跟陣列的有很大的不同，主要的差異有兩點</p>
<ol>
<li><p>延遲運算</p>
</li>
<li><p>漸進式取值</p>
</li>
</ol>
<h4 id="延遲運算"><a href="#延遲運算" class="headerlink" title="延遲運算"></a>延遲運算</h4><p>延遲運算很好理解，所有Observable一定會等到訂閱後才開始對元素做運算，如果沒有訂閱就不會有運算的行為</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x+<span class="number">1</span>));</span><br></pre></td></tr></table></figure>

<p>上面這段程式因為Observable還沒有訂閱，所以不會真的對元素做運算，這跟陣列的操作不一樣，如下</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">var</span> example = source.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>);ty</span><br></pre></td></tr></table></figure>

<p>上面這段程式執行完，example就已經取得所有元素的返回值了。</p>
<h4 id="漸進式取值"><a href="#漸進式取值" class="headerlink" title="漸進式取值"></a>漸進式取值</h4><p>陣列的operators都必須完整的運算出每個元素的返回值並組成一個陣列，再做下一個operator的運算，我們看下面這段程式碼</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source =p[<span class="number">1</span>,<span class="number">2</span>,<span class="keyword">var</span> source = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> example = source</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function"><span class="params">x</span> =&gt;</span> x % <span class="number">2</span> === <span class="number">0</span>)<span class="comment">// 這裡會運算並返回一個完整的陣列</span></span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>);<span class="comment">// 這裡也會運算並返品一個完整的陣列]</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，有注意到<code>source.filter(...)</code>就會返回整個新陣列，再接下一個operator又會再返回一個新的陣列，這一點其實在我們實作map跟filter時就能觀察到</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">map</span> = <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> result = []; <span class="comment">// 建立新陣列</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">item, index, array</span>) &#123;</span><br><span class="line">        result.<span class="title function_">push</span>(<span class="title function_">callback</span>(item, index, array))</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result; <span class="comment">// 返回新陣列</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每一次的operator的運算都會建立一個新的陣列，並在每個元素都運算完後返回這個新陣列。</p>
<p>Opservable operator的運算方式跟陣列的是完全的不同，雖然Obserbale的operator也都會回傳一個新的observable，但因為元素是漸進式取得的關系，所以每次的運算是一個元素運算到底，而不是運算完全部的元素再返回。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]);</span><br><span class="line"><span class="keyword">var</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">filter</span>(<span class="function"><span class="params">x</span> =&gt;</span> x === <span class="number">2</span>),<span class="comment">//</span></span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>),</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>目前測試<code>x % 2 ===2 </code>有問題，所以以此來代替</p>
<p>上面這段程式碼運行的方式是這樣的</p>
<ol>
<li><p>送出<code>1</code>到filter被過濾掉</p>
</li>
<li><p>送出<code>2</code>到filter在被送到map轉成<code>3</code>，送到observe<code>console.log</code>印出</p>
</li>
<li><p>送出<code>3</code>到filter被過濾掉</p>
</li>
</ol>
<p>每個元素送出後就是運算到底，在這個過程中不會等待其他的元素運算，這就就是漸進式取值的特性，在提到Iterator跟Observer時，就特別強調這兩個Pattern的共同特性是漸進式值，而我們在實作Iteraotr的過程中其實就能看出這個特性的運作方式</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IteratorFromArray</span> &#123;</span><br><span class="line">	<span class="title function_">constructor</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">_array</span> = arr;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">_cursor</span> = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	<span class="title function_">next</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_cursor</span> &lt; <span class="variable language_">this</span>.<span class="property">_array</span>.<span class="property">length</span> ?</span><br><span class="line">		&#123; <span class="attr">value</span>: <span class="variable language_">this</span>.<span class="property">_array</span>[<span class="variable language_">this</span>.<span class="property">_cursor</span>++], <span class="attr">done</span>: <span class="literal">false</span> &#125; :</span><br><span class="line">		&#123; <span class="attr">done</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="title function_">map</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">		<span class="keyword">const</span> iterator = <span class="keyword">new</span> <span class="title class_">IteratorFromArray</span>(<span class="variable language_">this</span>.<span class="property">_array</span>);</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			<span class="attr">next</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">				<span class="keyword">const</span> &#123; done, value &#125; = iterator.<span class="title function_">next</span>();</span><br><span class="line">				<span class="keyword">return</span> &#123;</span><br><span class="line">					<span class="attr">done</span>: done,</span><br><span class="line">					<span class="attr">value</span>: done ? <span class="literal">undefined</span> : <span class="title function_">callback</span>(value)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> myIterator = <span class="keyword">new</span> <span class="title class_">IteratorFromArray</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);</span><br><span class="line"><span class="keyword">var</span> newIterator = myIterator.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">1</span>);</span><br><span class="line">newIterator.<span class="title function_">next</span>(); <span class="comment">// &#123; done: false, value: 2 &#125;</span></span><br></pre></td></tr></table></figure>

<p>上面這段程碼是一個非常簡單的示範，但可以𢒆得出來每一次map雖然都會返回一個新的operator，但實際上在做元素運算時，因為漸進式的特性會使一個元素運算到底，Observable也是相同的概念。</p>
<p>漸進式取值的靣念在Observable中其實非常重要，這個特性也使得Observable相較於Array的operator在做運算時來的高效很多，尤其是在處理大量資料的時候會非常明顯！</p>
<h3 id="什麼是Subject"><a href="#什麼是Subject" class="headerlink" title="什麼是Subject?"></a>什麼是Subject?</h3><h4 id="Subject基本觀念"><a href="#Subject基本觀念" class="headerlink" title="Subject基本觀念"></a>Subject基本觀念</h4><p>我們之前的範例，每個observable都只訂閱一次，而實際上observable是可以多次訂閱的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> observerA$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(observerA$);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(observerB$);</span><br><span class="line"><span class="comment">// &quot;A next: 0&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 0&quot;</span></span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;A complete!&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;B complete!&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，分別用observerA$與observerB$訂閱了source$, 從log可以看出來observerA$跟observerB$都各自收到了元素，但請記得這兩個observer其實是<strong>分開執行</strong>的也就是說他們是完全獨立的，我們把observerB$延遲訂閱來證明看看</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> observerA$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(observerA$);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    source$.<span class="title function_">subscribe</span>(observerB$);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//A next:0 </span></span><br><span class="line"><span class="comment">//A next:1 </span></span><br><span class="line"><span class="comment">//B next:0 </span></span><br><span class="line"><span class="comment">//A next:2 </span></span><br><span class="line"><span class="comment">//A complete </span></span><br><span class="line"><span class="comment">//B next:1 </span></span><br><span class="line"><span class="comment">//B next:2 </span></span><br><span class="line"><span class="comment">//B complete </span></span><br></pre></td></tr></table></figure>

<p>這裡我們延遲一秒再用observerB$訂閱，可以從log中看出1秒後observerA$已經印到了1，這時observerB$開始印卻是從0開始，而不是接著observerA$的進度，代表這兩次的訂閱是完全分開來執行的、或者說是每次的訂閱都建立了一個新一執行。</p>
<p>這樣的行為在大部分的情境下適用，但有些案例下我們會希望第二次訂閱source$不會從頭開始接收元素，而是從第一次訂閱到當前處理的元素開始發送，我們把這種處理方式稱為組播(multicast)，那我們要如何做到組播呢?</p>
<h4 id="手動建立subject"><a href="#手動建立subject" class="headerlink" title="手動建立subject"></a>手動建立subject</h4><p>或許已經有讀者想到解法了，其實我們可以建立一個中間人來訂閱source再由中間人轉送資料出去，就可以達到我們想要的效果</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> observerA$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = &#123;</span><br><span class="line">    <span class="attr">observers</span>: [],</span><br><span class="line">    <span class="attr">addObserver</span>: <span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">push</span>(observer);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">next</span>(value))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observer</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">error</span>(error));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">complete</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">subject$.<span class="title function_">addObserver</span>(observerA$);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">addObserver</span>(observerB$);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//A next:0 </span></span><br><span class="line"><span class="comment">//A next:1 </span></span><br><span class="line"><span class="comment">//B next:1 </span></span><br><span class="line"><span class="comment">//A next:2 </span></span><br><span class="line"><span class="comment">//B next:2 </span></span><br><span class="line"><span class="comment">//A complete </span></span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看到，我們先建立了一個物件叫subject，這個物件具備observer所有的方法(next,error,complete), 並且還能addObserver把observer加到內部的清㽞中，每當有值送出就會遍歷清單中的所有observer並把值再次送出，這樣一來不管多久之後加進來的observer，都會是從當前處理到的元素接續往下走，就像範例中所示，我們用subject＄訂閱source並把observerA$加到subject$中，一秒後再把observerB$加到subject$，這時就可以看到observerB$是直接接教1開始，這就是組播(multicast)的行為。</p>
<p>讓我們把subject$的<code>addObserver</code>改名成<code>subscribe</code>如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> subject$ = &#123;</span><br><span class="line">    <span class="attr">observers</span>: [],</span><br><span class="line">    <span class="attr">subscribe</span>: <span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">push</span>(observer);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">next</span>(value))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observer</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">error</span>(error));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">observers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="title function_">complete</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>subject其實𣄵是用了Observer Pattern。但這邊為了不履混淆Observer Patter跟RxJS的observer就不再內文提及。</p>
</blockquote>
<p>雖然上面是我們自已手寫的subject，但運作方式跟RxJS的Subject實例是幾乎一樣的，我們把前面的程式碼改成RxJS提供的Subject試試</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">var</span> observerA$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB$ = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next:&quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error: &quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA$);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB$);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">//A next:0 </span></span><br><span class="line"><span class="comment">//A next:1 </span></span><br><span class="line"><span class="comment">//B next:1 </span></span><br><span class="line"><span class="comment">//A next:2 </span></span><br><span class="line"><span class="comment">//B next:2 </span></span><br><span class="line"><span class="comment">//A complete </span></span><br><span class="line"><span class="comment">//B complete </span></span><br></pre></td></tr></table></figure>

<p>大家會發現使用方法跟前面是相凹的，建立一個subject$先拿去訂閱observable(source$),再把我們真正的observer加到subject$中，這樣一來就能完成訂閱，而每個加到subject$中的observer都能整組的接收到相同的元素。</p>
<h4 id="什麼是Subjet"><a href="#什麼是Subjet" class="headerlink" title="什麼是Subjet?"></a>什麼是Subjet?</h4><p>雖然前面我們已經示範直接手寫一個簡單的subject, 但到底RxJS中的Subject的概念到底是什麼呢？</p>
<p>首先Subject可以拿去訂閱Observable(source)代表他是一個Observer，同時Subject𦙆可以被Observer(observerA$,observerB$)訂閱，代表他是一個Observable。</p>
<p>總結成兩句話</p>
<ul>
<li>Subject同時是Observable又是Observer</li>
<li>Subject會對內部的observers清單進行組(multicast)</li>
</ul>
<h3 id="Subject-BehaviorSubject-ReplaySubject-AsyncSubject"><a href="#Subject-BehaviorSubject-ReplaySubject-AsyncSubject" class="headerlink" title="Subject, BehaviorSubject, ReplaySubject, AsyncSubject"></a>Subject, BehaviorSubject, ReplaySubject, AsyncSubject</h3><p>上面介紹Subject是什麼，今天要講Subject一些應用方式，以及Subject的另外三種變形。</p>
<h4 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h4><p>實際上Subject就是Observer Pattern的實作，他會在內部管理一份observer的清單，並在接收到值時遍歷這份清單並送出值，所以我們可以這樣用Subject</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 1&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 2&quot;</span></span><br></pre></td></tr></table></figure>

<p>這裡我們可以直接用subject的next方法傳送值，所有訂閱的obsrver就會接收到，又因為Subject本身是Observable，所以這樣的使用方式很適合用在某些無法直接使用Observable的前端框架中，例如在React想對DOM的事件做監聽</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyButton</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subject</span> = <span class="keyword">new</span> <span class="title class_">Rx</span>.<span class="title class_">Subject</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subject</span></span><br><span class="line">            .<span class="title function_">mapTo</span>(<span class="number">1</span>)</span><br><span class="line">            .<span class="title function_">scan</span>(<span class="function">(<span class="params">origin, next</span>) =&gt;</span> origin + next)</span><br><span class="line">            .<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">count</span>: x &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;event</span> =&gt;</span> this.subject.next(event)&#125;&gt;&#123;this.state.count&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看出來，𦙲為React本身API的關系，如果我們想要用React自訂的事件，我們沒辦法直接使用Observable的creation operator建立observable，這時就可以靠Subject來做到這件事。</p>
<p>Subject因為同時是observer和observable，所以應用面很廣除了前面所提的之外，還有之前有提到的組播(multicase)特性也會在接下來的文章做更多應用的介紹，這裡先來看看Subject的三個變形。</p>
<h4 id="BehaviorSubject"><a href="#BehaviorSubject" class="headerlink" title="BehaviorSubject"></a>BehaviorSubject</h4><p>很多時候我們會希望Subject能代表當下的狀態，而不是單純的事件發送，也就是說如果今天有一個新的訂閱，我們希望Subject能立即給出最新的值，而不是沒有回應，例如下面這個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 3&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);<span class="comment">// 3 秒後才訂閱，observerB 不會收到任何值。</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>以上這個例子來說，observerB訂閱的之後，是不會有任何元素送給observerB的，因為在這之後沒有執行何何<code>subject$.next()</code>, 但很多時候我們會希望subject能夠表達當前的狀態，在一訂閱時就能收到最新的狀態是什麼，而不是訂閱後要等到有變動才能接收到新的狀態，以這個例子來說，我們希望observerB訂閱時就能立即收到<code>3</code>, 希望做到這樣的效果就可以用BehaviorSubject。</p>
<p>BehaviroSubject跟Subject最大的不同就是BehaviorSubject是用來呈現當前的值，而不是單純的發送事件。BehaviorSubject會記住最新一次發送的元素，並把該元素當作目前的值，在使用上BehaviroSubject建構式需要傳入一個參數來代表起始的狀態，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BehaviorSubject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">BehaviorSubject</span>(<span class="number">0</span>);<span class="comment">// 0 為起始值</span></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"><span class="comment">// &quot;A next: 0&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 3&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// &quot;B next: 3&quot;</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>從上面這個範例可以看得出來BehaviorSubject在建立時就需要給𡥞一個狀態，並在任何一次訂閱，就會先送出最新的狀態。其實這種行為就是一種狀態的表達而非單純的事件，就像是年齡跟生日一樣，年齡是一種狀態而生日就是事件；所以當我們想要用一個steam來達年齡時，就應用BehaviroSubject。</p>
<h4 id="ReplaySubject"><a href="#ReplaySubject" class="headerlink" title="ReplaySubject"></a>ReplaySubject</h4><p>在某些時候我們會希望Subject代表事件，但又能在新訂閱重新發送最後的幾個元素，這時我們新可以用ReplaySubject範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ReplaySubject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">ReplaySubject</span>(<span class="number">2</span>);<span class="comment">//重複發送最後2個元素</span></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 3&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// &quot;B next: 2&quot;</span></span><br><span class="line">    <span class="comment">// &quot;B next: 3&quot;</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>可能會有人以為<code>ReplaySubject(1)</code>是不是就等同於BehaviroSubject，其實是不一樣的，BehaviorSubject在建立時就會有起始值，比如<code>BehaviroSubject(0)</code>起始值就是<code>0</code>, BehaviorSubject是代表著狀態而ReplaySubject只是事件的重放而已。</p>
<h4 id="AsyncSubject"><a href="#AsyncSubject" class="headerlink" title="AsyncSubject"></a>AsyncSubject</h4><p>AsyncSubject是最怪的一個變形，他有點像是operator<code>last</code>，會在subject結事後送出最一個值，範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AsyncSubject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">AsyncSubject</span>();</span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">subject$.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">subject$.<span class="title function_">complete</span>();</span><br><span class="line"><span class="comment">// &quot;A next: 3&quot;</span></span><br><span class="line"><span class="comment">// &quot;A complete!&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// &quot;B next: 3&quot;</span></span><br><span class="line">    <span class="comment">// &quot;B complete!&quot;</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看出來，AsyncSubject會在subject結束後才送出最後一個值，其實這個行為跟Promise很像，絕大部分的時候都是使用BehaviorSubject跟ReplaySubject或Subject。</p>
<h3 id="multicast-refCount-publish-share"><a href="#multicast-refCount-publish-share" class="headerlink" title="multicast, refCount, publish, share"></a>multicast, refCount, publish, share</h3><p>有講到Subject時，是希望能夠讓Observable有新訂閱時，可以共用前一個訂閱而不要從頭開始，如下面的例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subject$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">// &quot;A next: 0&quot;</span></span><br><span class="line"><span class="comment">// &quot;A next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 1&quot;</span></span><br><span class="line"><span class="comment">// &quot;A next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;B next: 2&quot;</span></span><br><span class="line"><span class="comment">// &quot;A complete!&quot;</span></span><br><span class="line"><span class="comment">// &quot;B complete!&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼我們用subject訂閱了source$, 再把observerA跟observerB一個僤訂閱到subject, 這樣就可以讓observarA跟observerB共用同一個執行，但這樣的寫法會讓程式碼看起來太過複雜，我們可以用Observable的multicast operator來簡化這段程式</p>
<h4 id="multicast"><a href="#multicast" class="headerlink" title="multicast"></a>multicast</h4><p>multicast可以用來載subject並回傳一個可連結(connectable)的observable，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, multicast &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">3</span>),</span><br><span class="line">    <span class="title function_">multicast</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Subject</span>())</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line">source$.<span class="title function_">connect</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    source$.<span class="title function_">subscribe</span>(observerB)</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>上面這段程試碼我們透過multicast來掛載一個subject$之後這個observable(source$)的訂閱其實都是訂閱到subject$上。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source$.<span class="title function_">subscribe</span>(observerA);<span class="comment">// subject.subscribe(observerA)</span></span><br></pre></td></tr></table></figure>

<p>必須真的等到執行<code>connect()</code>後才會真的用subject$訂閱source$,並開始送出元素，如果沒有執行<code>connect()</code>observable是不會真正執行的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source$.<span class="title function_">connect</span>();</span><br></pre></td></tr></table></figure>

<p>另外值得注意的是這裡要退訂的話要把<code>connect()</code>回傳的subscription退訂才會直正停止observable的執行，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;send: &quot;</span> + x)),</span><br><span class="line">    <span class="title function_">multicast</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Subject</span>())<span class="comment">// 無限的 observable </span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionA = source$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"><span class="keyword">var</span> realSubscription = source$.<span class="title function_">connect</span>();</span><br><span class="line"><span class="keyword">var</span> subscriptionB;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionB = source$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionA.<span class="title function_">unsubscribe</span>();</span><br><span class="line">    subscriptionB.<span class="title function_">unsubscribe</span>();</span><br><span class="line">    <span class="comment">// 這裡雖然 A 跟 B 都退訂了，但 source 還會繼續送元素</span></span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    realSubscription.<span class="title function_">unsubscribe</span>();</span><br><span class="line">    <span class="comment">// 這裡 source 才會真正停止送元素</span></span><br><span class="line">&#125;, <span class="number">7000</span>);</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，必須等到<code>realSubscription.unsubscribe()</code>執行完，source$才會真的結束。</p>
<p>雖然用了multicast感覺會讓我們處理的對象少一點，但必須搭配connect一起使用還是讓程式碼有點複雜，通常我們會希望有observer訂閱時，就立即執行並發送元素，而不要再多執行一個方法(connect)，這時我們就可以用refCount</p>
<h4 id="refCount"><a href="#refCount" class="headerlink" title="refCount"></a>refCount</h4><p>refCount必須搭配multicast一起使用，他可以建立一個只要有訂閱就會自動connect的observable,範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;send: &quot;</span> + x)),</span><br><span class="line">    <span class="title function_">multicast</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Subject</span>()),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionA = source$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"><span class="comment">//訂閱數 0 =&gt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionB;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionB = source$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// 訂閱數 0 =&gt; 2</span></span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼，當source$一被observerA訂閱時(訂閱數從0變成1)，就會立即執行並發送元素，我們就不需要再額外執行connect。</p>
<p>同樣的在退訂時只要訂閱數變成0就會自動停止發送</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;send: &quot;</span> + x)),</span><br><span class="line">    <span class="title function_">multicast</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">Subject</span>()),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerA = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observerB = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B next: &quot;</span> + value),</span><br><span class="line">    <span class="attr">error</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B error:&quot;</span> + error),</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B complete&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionA = source$.<span class="title function_">subscribe</span>(observerA);</span><br><span class="line"><span class="comment">//訂閱數 0 =&gt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscriptionB;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionB = source$.<span class="title function_">subscribe</span>(observerB);</span><br><span class="line">    <span class="comment">// 訂閱數 0 =&gt; 2</span></span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscriptionA.<span class="title function_">unsubscribe</span>();<span class="comment">// 訂閱數 2 =&gt; 1</span></span><br><span class="line">    subscriptionB.<span class="title function_">unsubscribe</span>();<span class="comment">// 訂閱數 1 =&gt; 0，source 停止發送元素</span></span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>

<h4 id="publish"><a href="#publish" class="headerlink" title="publish"></a>publish</h4><p>其實<code>multicast(()=&gt; new Subject())</code>很常用到，我們有一個簡化的寫法那就是publish,下面這兩段程式碼是完全等價的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">publish</span>(),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new Subject()),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br></pre></td></tr></table></figure>

<p>加上Subject的三種變形</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, publishReplay, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">publishReplay</span>(<span class="number">1</span>),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new publishReplay(1)),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, publishReplay, publishBehavior, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">publishBehavior</span>(<span class="number">1</span>),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new publishBehavior(0)),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, publishReplay, publishBehavior, publishLast, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">publishLast</span>(),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new publishLast()),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br></pre></td></tr></table></figure>

<h4 id="share"><a href="#share" class="headerlink" title="share"></a>share</h4><p>另外publish+ refCount可以在簡寫成share</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, multicast, publish, publishReplay, publishBehavior, publishLast, refCount, share &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">share</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     publish(),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// var source$ = interval(1000).pipe(</span></span><br><span class="line"><span class="comment">//     multicast(() =&gt; new Subject()),</span></span><br><span class="line"><span class="comment">//     refCount()</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Subject總結"><a href="#Subject總結" class="headerlink" title="Subject總結"></a>Subject總結</h3><p>Subject其實在RxJS中最常被誤解的一部份，因為Subject可以讓你用命令式的方式送值到一個observable的串流中。很多人會直接把這個特性拿來用在<strong>不知道如何建立Observable的狀況</strong>。</p>
<h4 id="Subject與Observable的差異"><a href="#Subject與Observable的差異" class="headerlink" title="Subject與Observable的差異"></a>Subject與Observable的差異</h4><p>永遠記得Subject其實是Observer Design Pattern的實作，所以當observer訂閱到subject時，subject會把訂閱者塞到一份訂閱者清單，在元素發送時就是在遍歷這份清單，並把元素一一送出，這跟Obserbable像是一個function執𢓝是完全不同的。</p>
<p>Subject之所以具有Observable的所有方法，是因為Subject繼承了Observerable的型別，其實Subject型別中主要實做的方法只有next、error、complete、subscribe及unsubscribe這五個方法。而這五個方法就是依照Observer Pattern下法實作的。</p>
<p>總而言之，Subject是Observable的子類別，這個子類別當中用上述的五個方法實作了Observer Pattern，所以他同時具有Observable與Observer的特性。而跟Observable最大的差異就是Subject是具有狀態的，也就是儲存的那份清單！</p>
<p>因為Subject在訂閱時，是把observer放到一分清單當中，並在元素要送出(next)的時候遍歷這份清單，大概就像下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="title function_">next</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// observers 是一個陣列存所有的observer</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i &lt; observers.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        observers[i].<span class="title function_">next</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p>這會衍伸一個大問題，就是在某個observer發生錯誤卻沒有做錯誤處理時，就會影響到別的訂閱，看下面這個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">const</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"><span class="keyword">const</span> example$ = subject$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;oops&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A,&quot;</span>, x));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B,&quot;</span>, x));</span><br><span class="line">subject$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C,&quot;</span>, x));</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br></pre></td></tr></table></figure>

<p>上面這個例子，可能會預期B會在送出1的時候掛掉，另外A跟C會持續發送元素，確實正常應該像這樣運作，但目前RxJX的版植中會B報錯之後，A跟C也同時停止運行。原因就像之前所提的，在遍歷所有的obsever時發生了例外會導到之後的行為停止。</p>
<p>那要如何解決這個問題呢？目前最簡單的方式，當然是盡可能地把所有observer的錯誤處理加進去，這樣一來就不會有例外發生</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">const</span> subject$ = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"><span class="keyword">const</span> example$ = subject$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;oops&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">subject$.<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A,&quot;</span>, x),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A Error:&quot;</span> + error));</span><br><span class="line">example$.<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B,&quot;</span>, x),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B Error:&quot;</span> + error));</span><br><span class="line">subject$.<span class="title function_">subscribe</span>(</span><br><span class="line">    <span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C,&quot;</span>, x),</span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C Error:&quot;</span> + error));</span><br><span class="line"></span><br><span class="line">source$.<span class="title function_">subscribe</span>(subject$);</span><br></pre></td></tr></table></figure>

<p>像上面這段程式碼，當B發生錯誤時就只有B會停止，而不會影響A跟C。</p>
<h4 id="一定需要使用Subject的時機"><a href="#一定需要使用Subject的時機" class="headerlink" title="一定需要使用Subject的時機"></a>一定需要使用Subject的時機</h4><p>Subject正常應該是當我們一個observable的操作過程中發生了side-effect而我們不希望這個side-effect因為多個subscribe而被觸發多次，比如下面這段程式碼？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, asapScheduler &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> result$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">6</span>),</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="title class_">Math</span>.<span class="title function_">random</span>())<span class="comment">// side-effect，平常有可能是呼叫 API 或其他 side effect</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subA$ = result$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A: &quot;</span> + x));</span><br><span class="line"><span class="keyword">var</span> subB$ = result$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B: &quot;</span> + x));</span><br></pre></td></tr></table></figure>

<p>這段程式碼A跟B印出來的亂數就不一樣，代表random(side-effect)被執行了兩次，這種情況就一定會用到subject(或其相關的operators)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, asapScheduler, <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, take, multicast, refCount &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> result$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">6</span>),</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="title class_">Math</span>.<span class="title function_">random</span>()),<span class="comment">// side-effect</span></span><br><span class="line">    <span class="title function_">multicast</span>(<span class="keyword">new</span> <span class="title class_">Subject</span>()),</span><br><span class="line">    <span class="title function_">refCount</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subA$ = result$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A: &quot;</span> + x));</span><br><span class="line"><span class="keyword">var</span> subB$ = result$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B: &quot;</span> + x));</span><br></pre></td></tr></table></figure>

<p>改成這樣後我們就讓side-effect不因為訂閱數而多執行，這種情狀就是一定要用subject的。</p>
<h3 id="簡易實作Observable-一"><a href="#簡易實作Observable-一" class="headerlink" title="簡易實作Observable(一)"></a>簡易實作Observable(一)</h3><p>為什麼是簡易實作而不是完整實作呢？實作Observable其實只是幫助我們理解Observable的運作方式，所以會盡可能地簡單，容易理解及吸收。</p>
<h4 id="重點觀念"><a href="#重點觀念" class="headerlink" title="重點觀念"></a>重點觀念</h4><p>Observable跟Observer Pattern是不同的，Observable內部並沒有管理一份訂閱清單，<strong>訂閱Observable就像是執行一個function一樣！</strong></p>
<p>所以實作過程的重點</p>
<ul>
<li><p>訂閱就是執行一個function</p>
</li>
<li><p>訂閱接收的物件具備next,error,complete三個方法</p>
</li>
<li><p>訂閱會返回一個可退訂(unsubscribe)的物件</p>
</li>
</ul>
<h4 id="基本observable實作"><a href="#基本observable實作" class="headerlink" title="基本observable實作"></a>基本observable實作</h4><p>先用最簡單的function來建立observable物件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">subscriber</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> observable = &#123;</span><br><span class="line">        <span class="attr">subscribe</span>: <span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">            <span class="title function_">subscriber</span>(observer)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼就可以做最簡單的訂閱，像下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">subscriber</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> observable = &#123;</span><br><span class="line">        <span class="attr">subscribe</span>: <span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">            <span class="title function_">subscriber</span>(observer)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>這時候我們已經有最簡單的功能了，但這裡有一個大問題，就是observable在結束(complete)就不應該再發送元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&quot;still work&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// &quot;complete!&quot;</span></span><br><span class="line"><span class="comment">// &quot;still work&quot;</span></span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看到comlete之後還是能送出元素來，另外還有一個問題就是observer，如果不完整的就會出錯，這也不是我們希望看到的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&quot;still work&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br><span class="line"><span class="comment">//observer.complete is not a function </span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">//3</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼可以看出來，當使用者observe物件沒有complete方法時，就會報錯。我們應該修正這兩個問題！</p>
<h4 id="實作簡易Observer"><a href="#實作簡易Observer" class="headerlink" title="實作簡易Observer"></a>實作簡易Observer</h4><p>要修正這兩個問題其實並不難，我們只要實作一個Observer的類別，每次使用者傳入的observer都會利用這個類別轉乘我們想要Observer物件。</p>
<p>首先訂閱時有可能傳入一個observer物件，或是一到三個function,error,complete,所以我們要建立一個類別可以接受各重可能的參數</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">arguments</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="comment">// 空的 observer</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (!destinationOrNext) &#123;</span><br><span class="line">                    <span class="comment">// 空的 observer</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> destinationOrNext === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 傳入了observer物件</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="comment">//如果上面都不是，代表應該是傳入了一到三個function</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>寫一個方法(safeObserver)來回傳正常的observer</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">         <span class="comment">// ... 一些程式碼</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">safeObserver</span>(<span class="params">observerOrNext, error, complete</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> next;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> (observerOrNext) === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">            <span class="comment">// observerOrNext 是 next function</span></span><br><span class="line">            next = observerOrNext;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (observerOrNext) &#123;</span><br><span class="line">            <span class="comment">// observerOrNext 是 observer 物件</span></span><br><span class="line">            next = observerOrNext.<span class="property">next</span> || <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;;</span><br><span class="line">            error = observerOrNext.<span class="property">error</span> || <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> err;</span><br><span class="line">            &#125;;</span><br><span class="line">            complete = observerOrNext.<span class="property">complete</span> || <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//最後回傳我們預期的 observer 物件</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">next</span>: next,</span><br><span class="line">            <span class="attr">error</span>: error,</span><br><span class="line">            <span class="attr">complete</span>: complete</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再把constructor完成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 預設空的 observer</span></span><br><span class="line"><span class="keyword">const</span> emptyObserver = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">() =&gt;</span> &#123; &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="keyword">throw</span> err; &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">arguments</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="comment">// 空的 observer</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(emptyObserver);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (!destinationOrNext) &#123;</span><br><span class="line">                    <span class="comment">// 空的 observer</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(emptyObserver);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> destinationOrNext === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 傳入了observer物件</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(destinationOrNext);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="comment">//如果上面都不是，代表應該是傳入了一到三個function</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(destinationOrNext, error, complete);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">safeObserver</span>(<span class="params">observerOrNext, error, complete</span>) &#123;</span><br><span class="line">       <span class="comment">// ... 一些程式碼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡我們把真正的observer塞到<code>this.destination</code> 接著完成obsserver的方法。</p>
<p>Observer的三個主要的方法(next,error,complete)都應該結束或退訂後不能再被執行，所以我們在物件內部偷塞一個boolean值來作為是否曾經結束的依據。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 一些程式碼</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">safeObserver</span>(<span class="params">observerOrNext, error, complete</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 一些程式碼</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">unsubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStopped</span> = <span class="literal">true</span>; <span class="comment">// 偷塞一個屬性 isStopped</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著實作三個主要的方法就很簡單了，只要先判斷<code>isStopped</code>在使用<code>this.destination</code>物件來傳送值就可以了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 一些程式碼</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">safeObserver</span>(<span class="params">observerOrNext, error, complete</span>) &#123;</span><br><span class="line">    <span class="comment">// ... 一些程式碼</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">next</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isStopped</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">next</span>) &#123;</span><br><span class="line">      <span class="comment">// 先判斷是否停止過</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">next</span>(value); <span class="comment">// 傳送值</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">error</span>(<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isStopped</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">error</span>) &#123;</span><br><span class="line">      <span class="comment">// 先判斷是否停止過</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">error</span>(err); <span class="comment">// 傳送錯誤</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (anotherError) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">        <span class="keyword">throw</span> anotherError;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">complete</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isStopped</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">complete</span>) &#123;</span><br><span class="line">      <span class="comment">// 先判斷是否停止過</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">complete</span>(); <span class="comment">// 發送停止訊息</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>();</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>(); <span class="comment">// 發送停止訊息後退訂</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">unsubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStopped</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到這裡我們就完成基本的Observer實作了，接著我讓我們拿到基本版的observable中使用吧。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">subscriber</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observable = &#123;</span><br><span class="line">        <span class="attr">subscribe</span>: <span class="keyword">function</span> (<span class="params">observerOnNext, error, complete</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> realObserver = <span class="keyword">new</span> <span class="title class_">Observer</span>(observerOnNext, error, complete)</span><br><span class="line">            <span class="title function_">subscriber</span>(realObserver);</span><br><span class="line">            <span class="keyword">return</span> realObserver;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// complete!</span></span><br></pre></td></tr></table></figure>

<p>到這裡我們就完成基本的observable了，至少基本的行為都跟我們期望的一致。</p>
<h3 id="簡易實作Observable-二"><a href="#簡易實作Observable-二" class="headerlink" title="簡易實作Observable(二)"></a>簡易實作Observable(二)</h3><p>在上面的文章，我們已經完成了基本的observable以及Observer的簡易實作，這裏會接續上面的文章來實作簡易的Observable類別，以及一個creation operator和一個transform operator。</p>
<h4 id="建立簡易Observable類別"><a href="#建立簡易Observable類別" class="headerlink" title="建立簡易Observable類別"></a>建立簡易Observable類別</h4><p>這是我們上面文章建屯的observable物件的函式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observable = &#123;</span><br><span class="line">        <span class="attr">subscribe</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> realObserver = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">            <span class="title function_">subscribe</span>(realObserver);</span><br><span class="line">            <span class="keyword">return</span> realObserver;</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> observable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從這個函式可以看出來，回傳的observable物件至少會有subscribe方法，所以最簡單的Observable類別大概長像下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// ...做某些事</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外create的函式在執行時會傳入一個subscribe的function，這個function會決定observable的行為</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="title function_">create</span>(<span class="keyword">function</span>(<span class="params">observer</span>)&#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>把上面這一段改成下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="keyword">function</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">  observer.<span class="title function_">complete</span>();</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>所以我們的Observable的建構式應該會接收一個subscribe function</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (subscribe) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_subscribe</span> = subscribe;<span class="comment">//把subscribe存到 _subscribe屬性中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);<span class="comment">//就是執行一個function對吧</span></span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到這裡我們就成功的把create的函式改成Observable的類別了，我們可以直接來使用看看</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (subscribe) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_subscribe</span> = subscribe;<span class="comment">//把subscribe存到 _subscribe屬性中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);<span class="comment">//就是執行一個function對吧</span></span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">observable.<span class="title function_">subscribe</span>(observer);</span><br></pre></td></tr></table></figure>

<p>當然我們可以仿RxJS在靜態方法中加入create如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (subscribe) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_subscribe</span> = subscribe;<span class="comment">//把subscribe存到 _subscribe屬性中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);<span class="comment">//就是執行一個function對吧</span></span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Observable</span>.<span class="property">create</span> = <span class="keyword">function</span> (<span class="params">subscribe</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observable</span>(subscribe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這樣一來我們就可以用<code>Observable.create</code>建立observable物件實例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="keyword">function</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">  observer.<span class="title function_">complete</span>();</span><br><span class="line">  observer.<span class="title function_">next</span>(<span class="string">&#x27;not work&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="建立creation-operator-fromArray"><a href="#建立creation-operator-fromArray" class="headerlink" title="建立creation operator - fromArray"></a>建立creation operator - fromArray</h4><p>當我們有Obserbable類別後要建立creation operator就不難了，這裡我們建立一個fromArray的方法，可以接收array來建立observable，算是Rx的Observable.from的簡化版本，記得creation operators都屬於static方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(subscribe) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_subscribe</span> = subscribe; <span class="comment">// 把 subscribe 存到屬性中</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);</span><br><span class="line">    <span class="keyword">return</span> observer;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立靜態方法 </span></span><br><span class="line"><span class="title class_">Observable</span>.<span class="property">fromArray</span> = <span class="keyword">function</span>(<span class="params">array</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(array)) &#123;</span><br><span class="line">        <span class="comment">// 如果傳入的參數不是陣列，則拋出例外</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;params need to be an array&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="keyword">function</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 遍歷每個元素並送出</span></span><br><span class="line">            array.<span class="title function_">forEach</span>(<span class="function"><span class="params">value</span> =&gt;</span> observer.<span class="title function_">next</span>(value))</span><br><span class="line">            observer.<span class="title function_">complete</span>()</span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            observer.<span class="title function_">error</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observable = <span class="title class_">Observable</span>.<span class="title function_">fromArray</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]);</span><br></pre></td></tr></table></figure>

<p>上面的程式碼我們只是簡單的用new Observable就可以輕鬆地實現我們要的功能，之後就可以用fromArray來建立observable物件。</p>
<h4 id="建立transform-operator-map"><a href="#建立transform-operator-map" class="headerlink" title="建立transform operator - map"></a>建立transform operator - map</h4><p>相信很多人在實作Observable都是卡在這個階段，因為operators都是回傳一個新的observable這中間有很多細節需要注意，並且有些小技巧才能比較好的實現，在開始實作之前，先釐清幾個重點。</p>
<ul>
<li><p>operators(transform,filter,conditional…)都是回傳一個新的observable</p>
</li>
<li><p>大部分的operator其實就是在原本observer外包裹一層物件，讓執行next方法前先把元素做一次處理</p>
</li>
<li><p>operator回傳的opservable訂閱時，還是需要執行原本的observable(資料源)，也就說我們要想辦法保留原本的observable</p>
</li>
</ul>
<p>讓我們一步一步來，首先operators執行完會回傳一個新的observable，這個observable在訂閱時會先去執行operator的行為再發送元素，所以observable的訂閱方法就不能像現在這樣直接把observer傳給subscribe執行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(subscribe)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_subscribe</span>=subscribe;<span class="comment">// 把subscribe存到屬性中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Obserer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="comment">// 先做某個判斷是否當前的observable是具有operator的</span></span><br><span class="line">        <span class="keyword">if</span>(??)&#123;</span><br><span class="line">           <span class="comment">// 用operator 的操作</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="comment">// 如果沒有operator再直接把observer丟給_subscribe</span></span><br><span class="line">           <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer) </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以我們的Observable實作為例，這裡最重要的就是this._subscribe執行，每當執行時就是開始發送元素</p>
</blockquote>
<p>這裡我們可以想像一下當一個map產生的observable訂閱時，應該先判斷出有map這個operator並且傳入原本的資料源以及當前的observer，也就是說我們的map至少有以下這幾件事要做</p>
<ul>
<li><p>建立新的observable</p>
</li>
<li><p>保存原本的observable(資料源)，之後訂閱才有辦法執行</p>
</li>
<li><p>建立並保存operator本身的行為，等到訂閱時執行</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="comment">// 一些程式碼...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">       <span class="comment">// 一些程式碼...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">map</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>();<span class="comment">//邁立新的observable</span></span><br><span class="line">        observable.<span class="property">source</span> = <span class="variable language_">this</span>;<span class="comment">//保存當前的observable(資料源)</span></span><br><span class="line">        opservable.<span class="property">operator</span> = &#123;</span><br><span class="line">            <span class="attr">call</span>: <span class="function">(<span class="params">observer, source</span>) =&gt;</span> &#123;<span class="comment">//執行這個operator的行障</span></span><br><span class="line"></span><br><span class="line">            &#125;<span class="comment">// 儲存當前operator行為，並作為是否有operator的依據</span></span><br><span class="line">        &#125;;<span class="comment">//</span></span><br><span class="line">        <span class="keyword">return</span> observable;<span class="comment">//返回這個新的observable</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面這三個步驟都是必要的，特別是用了<code>observalbe.source=this</code>這個小技巧，來保存原本的observable。但這裡我們還有一個地方沒完成就是operator要做的事，這個部分我們等一下再補，先把subscribe寫完</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">        <span class="comment">// 一些程式碼...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">Observer</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="comment">//先用this.operator判斷當前的observable是否具有operator</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">operator</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">operator</span>.<span class="title function_">call</span>(observer, <span class="variable language_">this</span>.<span class="property">source</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果沒有operator再直接把observer丟給_subscribe</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">_subscribe</span>(observer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> observer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">map</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>();<span class="comment">//邁立新的observable</span></span><br><span class="line">        observable.<span class="property">source</span> = <span class="variable language_">this</span>;<span class="comment">//保存當前的observable(資料源)</span></span><br><span class="line">        opservable.<span class="property">operator</span> = &#123;</span><br><span class="line">            <span class="attr">call</span>: <span class="function">(<span class="params">observer, source</span>) =&gt;</span> &#123;<span class="comment">//執行這個operator的行障</span></span><br><span class="line"></span><br><span class="line">            &#125;<span class="comment">// 儲存當前operator行為，並作為是否有operator的依據</span></span><br><span class="line">        &#125;;<span class="comment">//</span></span><br><span class="line">        <span class="keyword">return</span> observable;<span class="comment">//返回這個新的observable</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>記得這裡補的subscribe行為，已經是map回傳新observable的行為，不是原本的observable了。</p>
<p>到這裡我們就幾乎要完成了，接著只要實作map這個operator的行為就可以囉！記得我們前面講的operator其實就是在原本的observer做一層包裏，讓next執行前先對元素做處理。所以我們改寫一下Observer並建立一個MapObserver來做這件事</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">destinationOrNext, error, complete</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">arguments</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="comment">// 空的 observer</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(emptyObserver);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (!destinationOrNext) &#123;</span><br><span class="line">                    <span class="comment">// 空的 observer</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(emptyObserver);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//多一個判斷，是否傳入的destinationOrNext原本就是Observer的實例，如果是就不用在用執行`this.safeObserver`</span></span><br><span class="line">                <span class="keyword">if</span> (destinationOrNext <span class="keyword">instanceof</span> <span class="title class_">Observer</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = destinationOrNext;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> destinationOrNext === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">                    <span class="comment">// 傳入了observer物件</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(destinationOrNext);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="comment">//如果上面都不是，代表應該是傳入了一到三個function</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">destination</span> = <span class="variable language_">this</span>.<span class="title function_">safeObserver</span>(destinationOrNext, error, complete);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...下面都一樣</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MapObserver</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Observer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">observer, callback</span>) &#123;</span><br><span class="line">        <span class="comment">// 這裡會傳入原來的observer跟map的callback</span></span><br><span class="line">        <span class="variable language_">super</span>(observer);<span class="comment">//因為有繼承所以要先執行一次父層的建構式</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">callback</span> = callback;<span class="comment">//保存callback</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">next</span> = <span class="variable language_">this</span>.<span class="property">next</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);<span class="comment">//確保next的this</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">next</span>(<span class="variable language_">this</span>.<span class="title function_">callback</span>(value));</span><br><span class="line">            <span class="comment">//this.destination是父層Observer保存的observer物件</span></span><br><span class="line">            <span class="comment">//這裡this.callback(value)就是map的操作</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">destination</span>.<span class="title function_">error</span>(err);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面這段程式碼就可以讓我們包裹observer物件，利用物件的繼承覆寫原本的next方法。</p>
<p>最後我們就只要補完map方法就可以了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">subscribe</span>) &#123;</span><br><span class="line">    <span class="comment">// 一些程式碼...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 一些程式碼...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">map</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>(); </span><br><span class="line">    observable.<span class="property">source</span> = <span class="variable language_">this</span>;</span><br><span class="line">    observable.<span class="property">operator</span> = &#123;</span><br><span class="line">      <span class="attr">call</span>: <span class="function">(<span class="params">observer, source</span>) =&gt;</span> &#123; </span><br><span class="line">        <span class="comment">// 執行這個 operator 的行為</span></span><br><span class="line">        <span class="keyword">const</span> newObserver = <span class="keyword">new</span> <span class="title class_">MapObserver</span>(observer, callback);</span><br><span class="line">        <span class="comment">// 建立包裹後的 observer</span></span><br><span class="line">        <span class="comment">// 訂閱原本的資料源，並回傳</span></span><br><span class="line">        <span class="keyword">return</span> source.<span class="title function_">subscribe</span>(newObserver);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;    </span><br><span class="line">    <span class="keyword">return</span> observable; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡做的事情就簡單很多，我們只要建立包裹過的observer，並用這個包裹後的observer訂閱原本的source。(記得這個function是在subscribe時執行的)</p>
<h4 id="Scheduler基本觀念"><a href="#Scheduler基本觀念" class="headerlink" title="Scheduler基本觀念"></a>Scheduler基本觀念</h4><p>在前面的文章中有提到Scheduler是為了解決RxJS衍生的最後一個問題。</p>
<p>其實RxJS用久了之後就會發現Observable有一個優勢是可以同時處理同步和非同步行為，但這個優勢也帶來了一個問題，就是我們常常會搞不清楚現在的observable執行方式是同步的還是非同步的。換句話話，我們很容易搞不清楚observable到什麼時候開如發送元素！</p>
<p>舉例來說，我們可能很清楚<code>interval</code>是非同步送出元素的，但<code>range</code>呢？<code>from</code>呢?他們可能有時候是非同步有時候是同步，這就會變得有點困擾，尤其在除錯執行順序就非常重要。</p>
<p>而Scheduler其本上就是拿來處理這個問題的!</p>
<h4 id="什麼是Scheduler"><a href="#什麼是Scheduler" class="headerlink" title="什麼是Scheduler?"></a>什麼是Scheduler?</h4><p>Scheduler控制一個observable的訂閱什麼時候開始，以及發送元素什麼時候送達，主要由以下三個元素所組成</p>
<ul>
<li><p>Scheduler是一個資料結構，它知道如何根據優先級或其他標準來儲存並佇列任務。</p>
</li>
<li><p>Scheduler是一個執行環境。它意味著任務何時何地被執行，比如像是立即執行、在回呼(callback)中執行、setTimeout中執行、animation frame中執行</p>
</li>
<li><p>Scheduler是一個虛擬時鐘。它透過<code>now()</code>這個方法提供了時間的概念，我們可以讓任務在特定的時間點被執行。</p>
</li>
</ul>
<p>簡言之Scheduler會影響Observable開始執行及元素送達的時機，比如下這個例子  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span>, asyncScheduler &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; observeOn &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> observable = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">1</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">2</span>);</span><br><span class="line">    observer.<span class="title function_">next</span>(<span class="number">3</span>);</span><br><span class="line">    observer.<span class="title function_">complete</span>();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;before subscribe&quot;</span>);</span><br><span class="line">observable.<span class="title function_">pipe</span>(<span class="title function_">observeOn</span>(asyncScheduler)).<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: &#x27;</span> + err); &#125;,</span><br><span class="line">    <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;complete&#x27;</span>); &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;after subscribe&quot;</span>);    </span><br><span class="line"><span class="comment">// &quot;before subscribe&quot;</span></span><br><span class="line"><span class="comment">// &quot;after subscribe&quot;</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// &quot;complete&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面這段程式碼原本是同步執行的，但我們用了<code>observable.pipe(observeOn(asyncScheduler))</code>原本是同步執行的就變成了非同步執行了。</p>
<h4 id="有哪些Scheduler可以用"><a href="#有哪些Scheduler可以用" class="headerlink" title="有哪些Scheduler可以用"></a>有哪些Scheduler可以用</h4><p>目前有下面幾種以版本6來說</p>
<ul>
<li>queue</li>
<li>asap</li>
<li>async</li>
<li>animatonFrame</li>
</ul>
<p>會在下面搭配程式碼一一講解</p>
<h4 id="使用Scheduler"><a href="#使用Scheduler" class="headerlink" title="使用Scheduler"></a>使用Scheduler</h4><p>其實我們在使用各種不同的operator時，這些operator就會各自預設不同的scheduler，例如一個無限的observable就會預設為<code>queur</code>Scheduler，而timer相關的operator則預設為<code>async</code>Scheduler。</p>
<p>要使用Scheduler除了前面用到的<code>observeOn()</code>方法外，以下這幾個creation operators最後一個參都能接收Scheduler</p>
<ul>
<li>bindCallback</li>
<li>bindNodeCallback</li>
<li>empty</li>
<li>from</li>
<li>interval</li>
<li>merge</li>
<li>of</li>
<li>range</li>
<li>throw</li>
<li>timer</li>
</ul>
<p>例如下面這個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, asyncScheduler &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; observeOn &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> observable = <span class="title function_">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">observeOn</span>(asyncScheduler)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>另外還有多個operators最後一個參數可以傳入Scheduler這邊就不一一列出，可以參考<a href="https://rxjs-dev.firebaseapp.com/api">官方</a>文件，最通用的方式還是<code>observeOn()</code>只要是observable就可以用這個方法。</p>
<h4 id="queue"><a href="#queue" class="headerlink" title="queue"></a>queue</h4><p>queue的運作方式跟預設的立即執行很像，但是當我們使用到遞回方法時，他會佇列這些行為而非直接執行，一個遞回的operator就是他會執行另一個operator, 最好的例子就是<code>repeat()</code>，如果我們不給他參數的話，他會執行無限多次，像下面這個例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, asyncScheduler, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; repeat, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"><span class="title function_">of</span>(<span class="number">10</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">repeat</span>(),</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">1</span>)</span><br><span class="line">).<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br></pre></td></tr></table></figure>

<p>在RxJS6中他預設了無限的observable為queue所以他會把repeat的next行為先佇列起來，因為前一個complete還在執行中，而這時repeat就會回傳一個可退訂的物件給<code>take(1)</code>等到repeat的next被第一次執行時就會結束，因為<code>take(1)</code>會直接收到值。</p>
<h5 id="使用情境"><a href="#使用情境" class="headerlink" title="使用情境"></a>使用情境</h5><p>quere很適合用在會有遞回的operator且具有大量資料時使用，在這個情況下queue能避免不必要的效能損秏。</p>
<h4 id="asap"><a href="#asap" class="headerlink" title="asap"></a>asap</h4><p>asap的行為很好理解，它是非同步的執行，在瀏覽器其實就是setTimeout設為0秒(在NodeJS中是用process.nextTick)，因為行為很好理解這解就不寫例子了。</p>
<h5 id="使用情境-1"><a href="#使用情境-1" class="headerlink" title="使用情境"></a>使用情境</h5><p>asap因為都是在setTimeout中執行，所以不會有block event loop的問題，很適合用在永遠不會退訂的observable，例如在背景下持續監聽server送來的通知。</p>
<h4 id="async"><a href="#async" class="headerlink" title="async"></a>async</h4><p>它跟asap很像但是使用setInterval來運作，通常是跟時間相關的operator才會用到。</p>
<h4 id="animationFrame"><a href="#animationFrame" class="headerlink" title="animationFrame"></a>animationFrame</h4><p>這個相信大家應該都知道，他是稅用<code>Window.requrestAnimationFrame</code>這個API去實作的，所以執行週期就跟<code>Window.requestAnimationFrame</code>一模一樣。</p>
<h5 id="使用情境-2"><a href="#使用情境-2" class="headerlink" title="使用情境"></a>使用情境</h5><p>在做複雜運算，且高頻率觸發UI動畫時，就很適合使用animationFrame，所以可以搭配throttle operator使用。</p>
<h3 id="Cold-Hot-Observable"><a href="#Cold-Hot-Observable" class="headerlink" title="Cold&amp;Hot Observable"></a>Cold&amp;Hot Observable</h3><blockquote>
<p>Hot Observable跟Cole Observable的差別，其實就是**資料源(Data Source)**在Observable內部建立還是外部建立。</p>
</blockquote>
<p>在RxJS中很常會看偌Cold Observable跟Hot Observable這兩個名詞，其實他們是在區分不同行為的Observable，所謂的Cold Observable就是指每次訂閱都是<strong>獨立的執行</strong>，而Hot Observable則是<strong>共用的訂閱</strong>。</p>
<h4 id="Cold-Observable"><a href="#Cold-Observable" class="headerlink" title="Cold Observable"></a>Cold Observable</h4><p>Cold Observable代表Observable的每個訂閱都是獨立的，他們不會互相影響，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">5</span>));</span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub1: &quot;</span> + value));</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub2: &quot;</span> + value));</span><br><span class="line">&#125;, <span class="number">3500</span>);</span><br><span class="line"><span class="comment">// sub1: 0</span></span><br><span class="line"><span class="comment">// sub1: 1</span></span><br><span class="line"><span class="comment">// sub1: 2</span></span><br><span class="line"><span class="comment">// sub1: 3</span></span><br><span class="line"><span class="comment">// sub2: 0</span></span><br><span class="line"><span class="comment">// sub1: 4</span></span><br><span class="line"><span class="comment">// sub2: 1</span></span><br><span class="line"><span class="comment">// sub2: 2</span></span><br><span class="line"><span class="comment">// sub2: 3</span></span><br><span class="line"><span class="comment">// sub2: 4</span></span><br></pre></td></tr></table></figure>

<p>從上面時程式碼可以看出來每次訂閱<code>source$</code>都是獨立運行的，這種每次訂閱都是<strong>獨立執行</strong>的Observable就稱為Cold Observable。</p>
<p>如果從Observable內部來看，代表<strong>資料源(Data Source)<strong>是在Observable</strong>內部</strong>建立的，大概會長像下面</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="keyword">function</span> (<span class="params">observer</span>) &#123;</span><br><span class="line">    <span class="comment">// 訂閱時，才建立新的資料源</span></span><br><span class="line">    <span class="keyword">const</span> someDataSource$ = <span class="title function_">getSomeDataSource</span>();</span><br><span class="line">    someDataSource$.<span class="title function_">addEventListener</span>(<span class="string">&quot;message&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>因為每次訂閱都建立一個新的資料源，就會使資料從頭開始傳送。</p>
<h4 id="Hot-Observable"><a href="#Hot-Observable" class="headerlink" title="Hot Observable"></a>Hot Observable</h4><p>Hot Observable代表Observable的每個訂閱是共用的，所謂的共用訂閱就是指一個Observable在多次訂閱時，不會每次都從新開始發送元素，例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, share &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">take</span>(<span class="number">5</span>),</span><br><span class="line">    <span class="title function_">share</span>()</span><br><span class="line">);</span><br><span class="line">source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub1: &quot;</span> + value));</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    source$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub2: &quot;</span> + value));</span><br><span class="line">&#125;, <span class="number">3500</span>);</span><br><span class="line"><span class="comment">// sub1: 0</span></span><br><span class="line"><span class="comment">// sub1: 1</span></span><br><span class="line"><span class="comment">// sub1: 2</span></span><br><span class="line"><span class="comment">// sub1: 3</span></span><br><span class="line"><span class="comment">// sub2: 3</span></span><br><span class="line"><span class="comment">// sub1: 4</span></span><br><span class="line"><span class="comment">// sub2: 4</span></span><br></pre></td></tr></table></figure>

<p>從上面的程式碼可以看出，當我們對source第二次做訂閱時，接收到的元素是接續第一個訂閱往下發送的，而不是從(0)開始，這種<strong>共用訂閱</strong>的Observable就稱為Hot Observable。</p>
<p>如果從Observable內部來看，就是資料源是在Observable<strong>外部</strong>建立的，程式碼大概就會像下面這樣</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只有一個資料源，每次訂閱都是用同一個</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> someDataSource = <span class="title function_">getSomeDataSource</span>();</span><br><span class="line"><span class="keyword">const</span> source = <span class="title class_">Observable</span>.<span class="title function_">create</span>(<span class="keyword">function</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">    someDataSource.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        observer.<span class="title function_">next</span>(data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="Cold與Hot"><a href="#Cold與Hot" class="headerlink" title="Cold與Hot"></a>Cold與Hot</h4><p>一般的情況下Observable都是Cold的，這樣不同的訂閱才不會有Side Effect互相影響。但在需要多次訂閱的情境下，我們就很有可能需要Hot Observable，而讓RxJS提供了很多讓Cold Observable變成Hot Observable的方法。</p>
<h4 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h4><p>Hot Observable跟Cold Observable的差異就是多次訂閱時，是否共用訂閱或是獨立執行，而這一切的差異就是來自於資料源是在Observable內部建立還是外部建立。</p>
<h3 id="如何Debug？"><a href="#如何Debug？" class="headerlink" title="如何Debug？"></a>如何Debug？</h3><p>Debug一直是RxJS的難題，原因是當我們使用RxJS後，程式碼就會變得高度<strong>抽象化</strong>；實際上抽象並不是什麼壞事，抽象會讓程式碼顯得簡潔、乾淨，但同成也帶來了除鏌上的因難。</p>
<p>在撰寫程式時，我們都會希望程式碼是簡潔且可讀的。𪝂當我們用<strong>簡潔</strong>的程式碼來處理<strong>複雜</strong>的問題，就表示我們的程式碼會變得<strong>高度抽象！</strong>其實人 在思考複雜的問題都會偏好用抽象的方式來處理，例如說在下圍棋時，常常說的<strong>棋形</strong>或是黑白哪一邊的<strong>勢</strong>比較好，這都是在抽象化處理問題。</p>
<h4 id="RxJS如何除錯？"><a href="#RxJS如何除錯？" class="headerlink" title="RxJS如何除錯？"></a>RxJS如何除錯？</h4><h5 id="tap"><a href="#tap" class="headerlink" title="tap"></a>tap</h5><p>在RxJS的世界中有一個Operator叫做<code>tap</code>，它不會對元素產生任何影響，在實務上很常來做錯的追蹤，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; take, tap, map &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source$ = <span class="title function_">interval</span>(<span class="number">1000</span>).<span class="title function_">pipe</span>(<span class="title function_">take</span>(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">const</span> example$ = source$.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">tap</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;tap log: &quot;</span> + x)),</span><br><span class="line">    <span class="title function_">map</span>(<span class="function"><span class="params">X</span> =&gt;</span> X + <span class="number">1</span>)</span><br><span class="line">);</span><br><span class="line">example$.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">X</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;subscirption log: &quot;</span> + X)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// do log: 0</span></span><br><span class="line"><span class="comment">// subscription log: 1</span></span><br><span class="line"><span class="comment">// do log: 1</span></span><br><span class="line"><span class="comment">// subscription log: 2</span></span><br><span class="line"><span class="comment">// do log: 2</span></span><br><span class="line"><span class="comment">// subscription log: 3</span></span><br></pre></td></tr></table></figure>

<p>從上面的例子可以看出來，我們可以傳入一個callback function給<code>tap</code>, 我們可以在tap的內部對元素作任何操作(像是log)，但不會兩元素產生影響。這很適合用在檢測每一步送出的元素是否符合我們的預期。</p>
<blockquote>
<p><code>tap(...)</code>的行為跟<code>map(x =&gt; &#123; ... return x;&#125;)</code>本質上是一樣的</p>
</blockquote>
<h4 id="Observable間的關聯圖"><a href="#Observable間的關聯圖" class="headerlink" title="Observable間的關聯圖"></a>Observable間的關聯圖</h4><p>當程式有點複雜時，我們最好是能先畫出Observable與Observable之間的關聯，在釐清各個Observable間的關系後，我們就能更輕易地找出問題在哪。範例如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent ,<span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mapTo, merge ,scan&#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> addButton= <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;addButton&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> minusButtion= <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;minusButton&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> state =<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;state&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> initialState = <span class="title function_">of</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> addClick= <span class="title function_">fromEvent</span>(addButton,<span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> minusClick=<span class="title function_">fromEvent</span>(minusButton,<span class="string">&quot;click&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> numberState= initialState.<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">merge</span>(</span><br><span class="line">        addClick.<span class="title function_">pipe</span>(<span class="title function_">mapTo</span>(<span class="number">1</span>)) ,</span><br><span class="line">        minusClick.<span class="title function_">pipe</span>(<span class="title function_">mapTo</span>(-<span class="number">1</span>))</span><br><span class="line">    ),</span><br><span class="line">    <span class="title function_">scan</span>(<span class="function">(<span class="params">origin,next</span>)=&gt;</span> origin+ next)</span><br><span class="line">);</span><br><span class="line">numberState.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">value</span>) =&gt;</span>&#123; state.<span class="property">innerHTML</span> = value;&#125;,</span><br><span class="line">    <span class="attr">error</span>: <span class="function">(<span class="params">err</span>)=&gt;</span>&#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error: &quot;</span>+err);&#125;,</span><br><span class="line">    <span class="attr">complete</span>:<span class="function">()=&gt;</span>&#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;complete&quot;</span>);&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a href="https://js-c7bh5a.stackblitz.io/">stackblitz</a></p>
<p>上面這段程式碼，我們可以把關聯圖畫成以下的樣子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">--------------        --------------        --------------</span><br><span class="line"><span class="string">&#x27;            &#x27;</span>        <span class="string">&#x27;            &#x27;</span>        <span class="string">&#x27;            &#x27;</span> </span><br><span class="line"><span class="string">&#x27;initialState&#x27;</span>        <span class="string">&#x27;  addClcik  &#x27;</span>        <span class="string">&#x27; minusClick &#x27;</span></span><br><span class="line"><span class="string">&#x27;            &#x27;</span>        <span class="string">&#x27;            &#x27;</span>        <span class="string">&#x27;            &#x27;</span></span><br><span class="line">--------------        --------------        --------------</span><br><span class="line">      |                     |                      |</span><br><span class="line">      |                     |  mapTo(1)            | mapTo(-1)</span><br><span class="line">merge | ____________________|                      |</span><br><span class="line">      | \__________________________________________|</span><br><span class="line">      |                      </span><br><span class="line">     \|/</span><br><span class="line">      |</span><br><span class="line">      | scan((origin, next) =&gt; origin + next)</span><br><span class="line">      |</span><br><span class="line">     \|/</span><br><span class="line">-------------</span><br><span class="line">&#x27;           &#x27;</span><br><span class="line">&#x27;numberState&#x27;  </span><br><span class="line">&#x27;           &#x27;</span><br><span class="line">-------------</span><br></pre></td></tr></table></figure>

<p>把每一個observable物件都框起來，並畫出之間的關聯，以及中間使用的Operators，這樣一來我們就能夠很清楚的了解這段程式碼在做什麼事，以及如何運作。最後我們只要在每一估環節去確認送出的元素就能找出錯誤出現在哪裡。</p>
<h4 id="Marble-Diagram"><a href="#Marble-Diagram" class="headerlink" title="Marble Diagram"></a>Marble Diagram</h4><p>在釐清每個observable之間的關系並找出間題出現在哪個環節之 ，我們只要畫出該環節的Marble Diagram前後變化就能清楚地知道間題是如何發生。接續上面的例子，如果今天問題出在<code>merge()</code>之後，那我們就把<code>merge()</code>前後的Marble Diagram畫出來</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">initialState: 0|</span><br><span class="line">addClick    : ----------1---------1--1-------</span><br><span class="line">minusClick  : -----(-1)---(-1)---------------</span><br><span class="line"></span><br><span class="line">                       merge(...)</span><br><span class="line"></span><br><span class="line">            : 0----(-1)-1-(-1)----1--1-------</span><br><span class="line">           </span><br><span class="line">           scan((origin, next) =&gt; origin +next)</span><br><span class="line"></span><br><span class="line">numberState : <span class="number">0</span>----(-<span class="number">1</span>)-<span class="number">0</span>-(-<span class="number">1</span>)----<span class="number">0</span>--<span class="number">1</span>-------     </span><br></pre></td></tr></table></figure>

<p>到這裡我們應該就能清楚地知道問題出在哪，最後就只要想如何解決問題就行了。</p>
<blockquote>
<p>如果還不知道間題在哪，很有可能是Marble Diagram畫鏌，可以再利用<code>tap</code>進行檢查</p>
</blockquote>
<p>只要照著以上三個步驟做除錯，基本上就不用擔心會有解決不了的錯誤，但是這三個步驟仍然顯得太過繁瑣，或許我們應該做一個工具來簡化這整個流程！</p>
<h6 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h6><ul>
<li><a href="https://ithelp.ithome.com.tw/users/20103367/ironman/1199">30 天精通 RxJS</a></li>
<li><a href="https://www.jianshu.com/p/869a3f74d3ca">番外：Rx–隐藏在Angular 2.x中利剑</a></li>
<li><a href="http://rxmarbles.com/#from">rxmarbles</a></li>
<li><a href="https://www.imooc.com/article/70323">RxJS v6 学习指南</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/RxJS/" rel="tag"># RxJS</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E4%B8%80%E5%80%8BJS%E5%AD%B8%E7%BF%92%E8%80%85%E7%9A%84%E6%97%A5%E5%B8%B8/%E4%B8%80%E5%80%8BJS%E5%AD%B8%E7%BF%92%E8%80%85%E7%9A%84%E6%97%A5%E5%B8%B8/" rel="prev" title="一個JS學習者的日常">
                  <i class="fa fa-angle-left"></i> 一個JS學習者的日常
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%E8%A8%98%E9%8C%84Flask-SocketIO%E7%9A%84%E5%9D%91/%E8%A8%98%E9%8C%84Flask-SocketIO%E7%9A%84%E5%9D%91/" rel="next" title="記錄Flask-SocketIO的坑">
                  記錄Flask-SocketIO的坑 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2018 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Tom Tang</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="回到頂端">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '60px',
  right: 'unset',
  left: '60px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
