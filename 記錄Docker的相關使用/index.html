<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ttom921.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言因為之後的專案有可能會用到，所以來記錄一下，新的Docker的使用">
<meta property="og:type" content="article">
<meta property="og:title" content="記錄Docker的相關使用">
<meta property="og:url" content="https://ttom921.github.io/%E8%A8%98%E9%8C%84Docker%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="被施工的Tom的記錄">
<meta property="og:description" content="前言因為之後的專案有可能會用到，所以來記錄一下，新的Docker的使用">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://ttom921.github.io/%E8%A8%98%E9%8C%84Docker%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/docker-container-log-rotation-02.jpg">
<meta property="article:published_time" content="2019-12-09T16:17:52.000Z">
<meta property="article:modified_time" content="2024-03-03T14:22:03.745Z">
<meta property="article:author" content="Tom Tang">
<meta property="article:tag" content="Docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ttom921.github.io/%E8%A8%98%E9%8C%84Docker%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/docker-container-log-rotation-02.jpg">


<link rel="canonical" href="https://ttom921.github.io/%E8%A8%98%E9%8C%84Docker%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-TW","comments":true,"permalink":"https://ttom921.github.io/%E8%A8%98%E9%8C%84Docker%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/","path":"記錄Docker的相關使用/","title":"記錄Docker的相關使用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>記錄Docker的相關使用 | 被施工的Tom的記錄</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">被施工的Tom的記錄</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">異想世界</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜尋" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Docker%E5%AE%89%E8%A3%9D"><span class="nav-number">2.</span> <span class="nav-text">Docker安裝</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A8%AD%E5%AE%9A%E9%96%8B%E6%A9%9F%E5%95%9F%E5%8B%95"><span class="nav-number">2.1.</span> <span class="nav-text">設定開機啟動</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker%E7%9A%84%E8%A8%AD%E5%AE%9A"><span class="nav-number">2.2.</span> <span class="nav-text">docker的設定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-%E5%AE%B9%E5%99%A8%E8%A8%AD%E7%BD%AE%E6%97%A5%E8%AA%8C%E8%BC%AA%E6%9B%BF"><span class="nav-number">2.3.</span> <span class="nav-text">Docker 容器設置日誌輪替</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%BB%98%E8%AA%8D%E7%9A%84%E6%97%A5%E8%AA%8C%E9%A9%85%E5%8B%95%E7%A8%8B%E5%BC%8F"><span class="nav-number">2.3.1.</span> <span class="nav-text">默認的日誌驅動程式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%8B%E5%8B%95%E6%B8%85%E9%99%A4%E6%97%A5%E8%AA%8C"><span class="nav-number">2.3.2.</span> <span class="nav-text">手動清除日誌</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%BB%98%E8%AA%8D%E7%9A%84%E6%97%A5%E8%AA%8C%E9%A9%85%E5%8B%95%E7%A8%8B%E5%BC%8F"><span class="nav-number">2.3.3.</span> <span class="nav-text">配置默認的日誌驅動程式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%82%BA%E5%80%8B%E5%88%A5%E5%AE%B9%E5%99%A8%E9%85%8D%E7%BD%AE%E6%97%A5%E8%AA%8C%E9%A9%85%E5%8B%95%E7%A8%8B%E5%BC%8F"><span class="nav-number">2.3.4.</span> <span class="nav-text">為個別容器配置日誌驅動程式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-docker-run-%E5%91%BD%E4%BB%A4"><span class="nav-number">2.3.5.</span> <span class="nav-text">使用 docker run 命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-docker-compose"><span class="nav-number">2.3.6.</span> <span class="nav-text">使用 docker-compose</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8Bnginx-v1-19-10-with-stream%E7%9A%84Dockerfile"><span class="nav-number">2.4.</span> <span class="nav-text">建立nginx:v1.19.10_with_stream的Dockerfile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8Buwsgi-nginx-docker%E7%9A%84Dockerfile"><span class="nav-number">2.5.</span> <span class="nav-text">建立uwsgi-nginx-docker的Dockerfile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uwsgi-nginx-python3-7%E6%B8%AC%E8%A9%A6"><span class="nav-number">2.6.</span> <span class="nav-text">uwsgi-nginx:python3.7測試</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#alpine%E7%9B%B8%E9%97%9C"><span class="nav-number">2.7.</span> <span class="nav-text">alpine相關</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uwsgi-gevent-buster%E7%9B%B8%E9%97%9C"><span class="nav-number">2.8.</span> <span class="nav-text">uwsgi-gevent-buster相關</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Docker%E6%8C%87%E4%BB%A4"><span class="nav-number">3.</span> <span class="nav-text">Docker指令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E6%AD%A3%E5%9C%A8%E9%81%8B%E8%A1%8C%E7%9A%84docker"><span class="nav-number">3.1.</span> <span class="nav-text">查看所有正在運行的docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89%E7%9A%84%E5%AE%B9%E5%99%A8-ID"><span class="nav-number">3.2.</span> <span class="nav-text">列出所有的容器 ID</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4%E6%89%80%E6%9C%89%E4%B8%8D%E5%9F%B7%E8%A1%8C%E7%9A%84contaner"><span class="nav-number">3.3.</span> <span class="nav-text">移除所有不執行的contaner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%81%9C%E6%AD%A2%E6%89%80%E6%9C%89%E7%9A%84%E5%AE%B9%E5%99%A8"><span class="nav-number">3.4.</span> <span class="nav-text">停止所有的容器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E6%89%80%E6%9C%89%E4%BF%A1%E6%81%AF"><span class="nav-number">3.5.</span> <span class="nav-text">查看容器所有信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E6%97%A5%E8%AA%8C"><span class="nav-number">3.6.</span> <span class="nav-text">查看容器日誌</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%B2%E5%85%A5%E5%AE%B9%E5%99%A8"><span class="nav-number">3.7.</span> <span class="nav-text">進入容器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%AA%E9%99%A4%E5%AE%B9%E5%99%A8"><span class="nav-number">3.8.</span> <span class="nav-text">刪除容器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4%E6%89%80%E6%9C%89%E6%9C%AA%E4%BD%BF%E7%94%A8%E7%9A%84-Docker-%E9%A0%85%E7%9B%AE"><span class="nav-number">3.9.</span> <span class="nav-text">移除所有未使用的 Docker 項目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%89%80%E6%9C%89%E7%9A%84%E5%AE%B9%E5%99%A8"><span class="nav-number">3.10.</span> <span class="nav-text">删除所有的容器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%89%80%E6%9C%89%E7%9A%84%E9%95%9C%E5%83%8F"><span class="nav-number">3.11.</span> <span class="nav-text">删除所有的镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6"><span class="nav-number">3.12.</span> <span class="nav-text">复制文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AA%A2%E6%9F%A5%E8%A8%AD%E5%AE%9A%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A2%BA"><span class="nav-number">3.13.</span> <span class="nav-text">檢查設定是否正確</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#docker-io%E7%9A%84%E7%99%BB%E5%85%A5"><span class="nav-number">4.</span> <span class="nav-text">docker.io的登入</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Push-Image"><span class="nav-number">4.1.</span> <span class="nav-text">Push Image</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Docker-compose"><span class="nav-number">5.</span> <span class="nav-text">Docker compose</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%9D"><span class="nav-number">5.1.</span> <span class="nav-text">安裝</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%AF%ABdocker-compose"><span class="nav-number">5.2.</span> <span class="nav-text">如何寫docker-compose</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8"><span class="nav-number">5.3.</span> <span class="nav-text">如何使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><span class="nav-number">5.4.</span> <span class="nav-text">參考資料</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Openstreetmap%E7%9A%84Docker%E7%9B%B8%E9%97%9C"><span class="nav-number">6.</span> <span class="nav-text">Openstreetmap的Docker相關</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%9DDocker"><span class="nav-number">6.1.</span> <span class="nav-text">安裝Docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker%E7%9B%B8%E9%97%9C%E6%93%8D%E4%BD%9C"><span class="nav-number">6.2.</span> <span class="nav-text">Docker相關操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BC%89openrouteservice"><span class="nav-number">6.3.</span> <span class="nav-text">下載openrouteservice</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%AE%83%E7%9A%84DockerImage"><span class="nav-number">6.4.</span> <span class="nav-text">建立它的DockerImage</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-1-%E5%B0%87%E7%95%B6%E5%89%8D%E7%94%A8%E6%88%B6%E5%8A%A0%E5%85%A5-docker-%E7%BE%A4%E7%B5%84"><span class="nav-number">6.4.0.1.</span> <span class="nav-text">Step 1. 將當前用戶加入 docker 群組</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-2-%E9%80%80%E5%87%BA%E7%95%B6%E5%89%8D%E7%94%A8%E6%88%B6"><span class="nav-number">6.4.0.2.</span> <span class="nav-text">Step 2. 退出當前用戶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-3-%E5%86%8D%E6%AC%A1%E5%88%87%E6%8D%A2%E5%88%B0-ubuntu-%E7%94%A8%E6%88%B6"><span class="nav-number">6.4.0.3.</span> <span class="nav-text">Step 3. 再次切换到 ubuntu 用戶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-4-%E5%95%9F%E5%8B%95-docker-compose"><span class="nav-number">6.4.0.4.</span> <span class="nav-text">Step 4. 啟動 docker-compose</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E5%9C%B0%E5%9C%96"><span class="nav-number">6.5.</span> <span class="nav-text">更新地圖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99-1"><span class="nav-number">6.6.</span> <span class="nav-text">參考資料</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Tom Tang</p>
  <div class="site-description" itemprop="description">記錄有的沒有的</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E8%A8%98%E9%8C%84Docker%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="記錄Docker的相關使用 | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          記錄Docker的相關使用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-12-09 16:17:52" itemprop="dateCreated datePublished" datetime="2019-12-09T16:17:52+00:00">2019-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A8%98%E9%8C%84/" itemprop="url" rel="index"><span itemprop="name">記錄</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A8%98%E9%8C%84/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>因為之後的專案有可能會用到，所以來記錄一下，新的Docker的使用</p>
<span id="more"></span>

<h1 id="Docker安裝"><a href="#Docker安裝" class="headerlink" title="Docker安裝"></a>Docker安裝</h1><p>先移除上一版的Docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br></pre></td></tr></table></figure>

<p>使用repository來安裝</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br></pre></td></tr></table></figure>

<p>Add Docker’s official GPG key:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br></pre></td></tr></table></figure>

<p>設定stable版的庫</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br></pre></td></tr></table></figure>

<p>安裝Docker引擎</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<p>列出Docker版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-cache madison docker-ce</span><br></pre></td></tr></table></figure>

<p>將第四列的字串代入ex<code>5:18.09.1~3-0~ubuntu-xenial</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install docker-ce=&lt;VERSION_STRING&gt; docker-ce-cli=&lt;VERSION_STRING&gt; containerd.io</span><br><span class="line">sudo apt-get install docker-ce=5:19.03.15~3-0~ubuntu-bionic docker-ce-cli=5:19.03.15~3-0~ubuntu-bionic containerd.io</span><br><span class="line">sudo apt-get install docker-ce=5:20.10.8~3-0~ubuntu-bionic docker-ce-cli=5:20.10.8~3-0~ubuntu-bionic containerd.io</span><br></pre></td></tr></table></figure>

<p>測試是否正常</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run hello-world</span><br></pre></td></tr></table></figure>

<p>移除docker engine</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get purge docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<p>移除docker相關的資料</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/docker</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/containerd</span><br></pre></td></tr></table></figure>



<h2 id="設定開機啟動"><a href="#設定開機啟動" class="headerlink" title="設定開機啟動"></a>設定開機啟動</h2><p>開始和關畢的指令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line">sudo systemctl start docker</span><br><span class="line">sudo systemctl stop docker</span><br></pre></td></tr></table></figure>

<h2 id="docker的設定"><a href="#docker的設定" class="headerlink" title="docker的設定"></a>docker的設定</h2><p>設定檔的位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

<p>設定的資料</p>
<p> bip:設定docker的ip</p>
<p> data-root:docker的使用資料</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /data/docker</span><br></pre></td></tr></table></figure>

<p>live-restore:容器掛了，是否執行</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">    <span class="attr">&quot;bip&quot;</span><span class="punctuation">:</span><span class="string">&quot;172.17.0.1/24&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data-root&quot;</span><span class="punctuation">:</span><span class="string">&quot;/data/docker&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;live-restore&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>相關的指令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run hello-world</span><br><span class="line">sudo docker info</span><br></pre></td></tr></table></figure>

<p>查詢,pull, 列出 docker image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo docker search alpine</span><br><span class="line">sudo docker pull alpine</span><br><span class="line">sudo docker pull alpine:3.10.3</span><br><span class="line">sudo docker images</span><br><span class="line">sudo docker image ls</span><br></pre></td></tr></table></figure>

<p>將image id 打上自已的標籤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@nvt-nginx-1:~$ sudo docker image <span class="built_in">ls</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hello-world         latest              d1165f221234        2 months ago        13.3kB</span><br><span class="line">alpine              3.10.3              965ea09ff2eb        18 months ago       5.55MB</span><br></pre></td></tr></table></figure>

<p>打上tag sudo docker tag imageid name:version</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker tag 965ea09ff2eb myaline:v3.10.3</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@nvt-nginx-1:~$ sudo docker image <span class="built_in">ls</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hello-world         latest              d1165f221234        2 months ago        13.3kB</span><br><span class="line">alpine              3.10.3              965ea09ff2eb        18 months ago       5.55MB</span><br><span class="line">myaline             v3.10.3             965ea09ff2eb        18 months ago       5.55MB</span><br></pre></td></tr></table></figure>

<h2 id="Docker-容器設置日誌輪替"><a href="#Docker-容器設置日誌輪替" class="headerlink" title="Docker 容器設置日誌輪替"></a>Docker 容器設置日誌輪替</h2><h3 id="默認的日誌驅動程式"><a href="#默認的日誌驅動程式" class="headerlink" title="默認的日誌驅動程式"></a>默認的日誌驅動程式</h3><p>我們可以為容器配置不同的日誌記錄驅動程式，默認情況下容器的 <strong>stdout</strong> 和 <strong>stderr</strong> 會被寫入到 <em>&#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers&#x2F;[container-id]&#x2F;[container-id]-json.log</em> 的 json 文件。如果一直無人理會，這個文件最終會佔用大量的磁盤空間，如下圖所示：</p>
<img src="docker-container-log-rotation-02.jpg" style="zoom:80%;" />

<h3 id="手動清除日誌"><a href="#手動清除日誌" class="headerlink" title="手動清除日誌"></a>手動清除日誌</h3><p>若果這個 json 日誌文件佔用了大量的磁盤空間，我們可以使用下面的命令清除它。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truncate -s 0 &lt;logfile&gt;</span><br></pre></td></tr></table></figure>

<p>或者我們可以考慮設置一個 cronjob 來定期清除這些 json 日誌文件，但從長遠來看，最好還是設置日誌輪替。</p>
<h3 id="配置默認的日誌驅動程式"><a href="#配置默認的日誌驅動程式" class="headerlink" title="配置默認的日誌驅動程式"></a>配置默認的日誌驅動程式</h3><p>默認的日誌驅動程式可以通過在 <em>&#x2F;etc&#x2F;docker&#x2F;daemon.json</em> 中定義。如果該文件不存在，可以建立該文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>



<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;log-driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;json-file&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;max-size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10m&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max-file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>以 <em>json-file</em> 作日誌記錄驅動程式還有幾個其它選項，我們甚至可以更改為其他日誌記錄驅動程式，如 <em>syslog</em> 。有關更多信息，請參閱 <a href="https://docs.docker.com/config/containers/logging/configure/">Docker Docs - Configure logging drivers</a>。</p>
<p>執行以下命令來重新加載更新後的 <em>daemon.js</em> 。新的配置將在重新啟動後適用於所有新建立的容器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="為個別容器配置日誌驅動程式"><a href="#為個別容器配置日誌驅動程式" class="headerlink" title="為個別容器配置日誌驅動程式"></a>為個別容器配置日誌驅動程式</h3><p>如果您不想作全局配置，也可以在個別容器級作日誌驅動程式改動。</p>
<h3 id="使用-docker-run-命令"><a href="#使用-docker-run-命令" class="headerlink" title="使用 docker run 命令"></a>使用 docker run 命令</h3><p>我們可以在 <em>docker run</em> 命令中指定日誌記錄驅動程式與其選項。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">    --log-driver json-file \</span><br><span class="line">    --log-opt max-size=10m \</span><br><span class="line">    --log-opt max-file=10 \</span><br><span class="line">    alpine echo hello world</span><br></pre></td></tr></table></figure>



<h3 id="使用-docker-compose"><a href="#使用-docker-compose" class="headerlink" title="使用 docker-compose"></a>使用 docker-compose</h3><p>日誌記錄驅動程式與其選項也可以使用 <em>docker-compose</em> 進行配置。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3.2&#x27;</span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    image: &#x27;nginx:latest&#x27;</span><br><span class="line">    ports:</span><br><span class="line">      - &#x27;80:80&#x27;</span><br><span class="line">    logging:</span><br><span class="line">      driver: &quot;json-file&quot;</span><br><span class="line">      options:</span><br><span class="line">        max-size: &quot;1k&quot;</span><br><span class="line">        max-file: &quot;3&quot;</span><br></pre></td></tr></table></figure>

<p>來看看配置是否成功。</p>
<p><a href="https://blog.boatswain.io/zh/post/docker-container-log-rotation/">為 Docker 容器設置日誌輪替</a></p>
<h2 id="建立nginx-v1-19-10-with-stream的Dockerfile"><a href="#建立nginx-v1-19-10-with-stream的Dockerfile" class="headerlink" title="建立nginx:v1.19.10_with_stream的Dockerfile"></a>建立nginx:v1.19.10_with_stream的Dockerfile</h2><p>來建立nginx版加上stream的功能</p>
<p>參別人的dockfile </p>
<ul>
<li><a href="https://github.com/tekn0ir/nginx-stream/blob/master/Dockerfile">nginx-stream</a></li>
<li><a href="https://github.com/tiangolo/nginx-rtmp-docker/blob/master/Dockerfile">ngix-rtmp</a></li>
</ul>
<p>參考資料</p>
<p><a href="https://www.alibabacloud.com/blog/how-to-use-nginx-as-an-https-forward-proxy-server_595799">https://www.alibabacloud.com/blog/how-to-use-nginx-as-an-https-forward-proxy-server_595799</a></p>
<p><a href="https://www.nginx.com/blog/tcp-load-balancing-udp-load-balancing-nginx-tips-tricks/">https://www.nginx.com/blog/tcp-load-balancing-udp-load-balancing-nginx-tips-tricks/</a></p>
<p>建立資料夾</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> dockerfile</span><br><span class="line"><span class="built_in">cd</span> dockerfile/</span><br><span class="line">vim Dockerfile</span><br></pre></td></tr></table></figure>

<p>Dockerfile的內容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">FROM debian:stretch</span><br><span class="line"></span><br><span class="line">LABEL mantainer =&quot;ttom &lt;ttom921@hotmail.com&gt;&quot;</span><br><span class="line"></span><br><span class="line"># Version of Nginx to use</span><br><span class="line">ENV NGINX_VERSION nginx-1.12.2</span><br><span class="line"></span><br><span class="line"># Install dependencies</span><br><span class="line">RUN apt-get update &amp;&amp;  \</span><br><span class="line"> 	apt-get install -y wget libpcre3-dev build-essential libssl-dev zlib1g-dev ca-certificates openssl  &amp;&amp; \</span><br><span class="line">    rm -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line"># Download and decompress Nginx</span><br><span class="line">RUN mkdir -p /tmp/build/nginx &amp;&amp; \</span><br><span class="line">	cd /tmp/build/nginx &amp;&amp; \</span><br><span class="line">    wget -O $&#123;NGINX_VERSION&#125;.tar.gz https://nginx.org/download/$&#123;NGINX_VERSION&#125;.tar.gz &amp;&amp; \</span><br><span class="line">	tar -zxf $&#123;NGINX_VERSION&#125;.tar.gz</span><br><span class="line"></span><br><span class="line"># Build and instll Nginx</span><br><span class="line"># The default puts everything under /usr/local/nginx,so it&#x27;s neede to change</span><br><span class="line"># it explicitly. Not jst for order but to have it in the PATH</span><br><span class="line">RUN cd /tmp/build/nginx/$&#123;NGINX_VERSION&#125; &amp;&amp; \</span><br><span class="line">    ./configure \</span><br><span class="line">        --sbin-path=/usr/local/sbin/nginx \</span><br><span class="line">        --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">        --error-log-path=/var/log/nginx/error.log \</span><br><span class="line">        --pid-path=/var/run/nginx/nginx.pid \</span><br><span class="line">        --lock-path=/var/lock/nginx/nginx.lock \</span><br><span class="line">        --http-log-path=/var/log/nginx/access.log \</span><br><span class="line">        --http-client-body-temp-path=/tmp/nginx-client-body \</span><br><span class="line">        --with-http_ssl_module \</span><br><span class="line">        --with-threads \</span><br><span class="line">        --with-ipv6 \</span><br><span class="line">		--with-stream \</span><br><span class="line">		--with-stream_ssl_module &amp;&amp; \</span><br><span class="line">	make -j $(getconf _NPROCESSORS_ONLN) &amp;&amp; \</span><br><span class="line">    make install &amp;&amp; \</span><br><span class="line">    mkdir /var/lock/nginx &amp;&amp; \</span><br><span class="line">    rm -rf /tmp/build</span><br><span class="line"></span><br><span class="line"># Forward logs to Docker</span><br><span class="line">RUN ln -sf /dev/stdout /var/log/nginx/access.log &amp;&amp; \</span><br><span class="line">    ln -sf /dev/stderr /var/log/nginx/error.log</span><br><span class="line"></span><br><span class="line"># Set up config file</span><br><span class="line">COPY nginx.conf /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">EXPOSE 80 443</span><br><span class="line">CMD [&quot;nginx&quot;,&quot;-g&quot;,&quot;daemon off;&quot;]</span><br></pre></td></tr></table></figure>

<p>建立docker image</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker build  . -t mynginx:1.12.2_with_stream</span><br><span class="line">sudo docker run --<span class="built_in">rm</span> -it --name ngix00 -p 80:80 mynginx:1.12.2_with_stream</span><br></pre></td></tr></table></figure>

<p>有修改Dockerfile成1.19.10</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo docker build  .  -t nginx:v1.19.10_with_stream</span><br><span class="line">sudo docker run --<span class="built_in">rm</span> -it --name ngix00 -p 80:80 nginx:v1.19.10_with_stream</span><br><span class="line"></span><br><span class="line">sudo docker <span class="built_in">exec</span> -it 4e655a93330f /bin/bash</span><br></pre></td></tr></table></figure>

<p>執行的設定檔的連結</p>
<p>將原來的設定檔拷貝出來</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp &lt;containerId&gt;:/file/path/within/container /host/path/target</span><br></pre></td></tr></table></figure>
<p>設定檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker cp a5bc56424878:/etc/nginx /etc/nginx</span><br></pre></td></tr></table></figure>

<p>html檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/</span><br><span class="line">sudo mkdir nginx</span><br><span class="line">cd ~</span><br><span class="line">sudo docker cp a5bc56424878:/usr/local/nginx /usr/local/nginx</span><br></pre></td></tr></table></figure>

<p>起動連接host的資料</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --rm -it --name nginx00 -p 80:80 -v /etc/nginx:/etc/nginx -v /usr/local/nginhtml:/usr/local/nginx/html nginx:v1.19.10_with_stream</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --rm -it --name nginx00 -p 80:80 -v /etc/nginx:/etc/nginx -v /usr/local/nginhtml:/usr/local/nginx/html ttom921/nginx:v1.19.10_with_stream</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --rm -it --name nginx00 -p 80:80 -p 7000:7000 -v /etc/nginx:/etc/nginx -v /usr/local/nginx/html:/usr/local/nginx/html ttom921/nginx:v1.19.10_with_stream</span><br></pre></td></tr></table></figure>

<h2 id="建立uwsgi-nginx-docker的Dockerfile"><a href="#建立uwsgi-nginx-docker的Dockerfile" class="headerlink" title="建立uwsgi-nginx-docker的Dockerfile"></a>建立uwsgi-nginx-docker的Dockerfile</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir mkdockerfile</span><br><span class="line">cd mkdockerfile</span><br></pre></td></tr></table></figure>

<p>Dockerfile的內容</p>
<p><a href="https://github.com/tiangolo/uwsgi-nginx-docker/blob/master/docker-images/python3.6.dockerfile">參考</a></p>
<p><a href="https://stackoverflow.com/questions/17466699/not-able-to-build-a-specific-dockerfile">https://stackoverflow.com/questions/17466699/not-able-to-build-a-specific-dockerfile</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ttom921/uwsgi-nginx-docker.git</span><br><span class="line">cd uwsgi-nginx-docker/</span><br><span class="line">cd docker-images/</span><br><span class="line">sudo service docker restart</span><br><span class="line">sudo docker image build  -f python3.6.dockerfile . -t ttom/uwsgi-nginx:python3.6</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo docker image build  . -t ttom/ubuntu18:python3.6.9</span><br><span class="line">sudo docker image build  -f python3.6.9.dockerfile . -t ttom/uwsgi-nginx:python3.6</span><br><span class="line">sudo docker build -f Dockerfile -t hisharp_webfms:python3.6 . </span><br><span class="line"></span><br><span class="line">sudo docker build -f Dockerfile -t ttom/nginx_uwsgi_py3:alpine3.9 . </span><br><span class="line">sudo docker build -f Dockerfile -t webapp .</span><br><span class="line">sudo docker run -p 9999:6666 webapp</span><br></pre></td></tr></table></figure>





<p>測試</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --rm -it --name uwngix00 -p 80:80 ttom/uwsgi-nginx:python3.6</span><br><span class="line"></span><br><span class="line">curl http://10.4.7.131</span><br><span class="line">Hello World from a default Nginx uWSGI Python 3.6 app in a Docker container (default)</span><br></pre></td></tr></table></figure>

<h2 id="uwsgi-nginx-python3-7測試"><a href="#uwsgi-nginx-python3-7測試" class="headerlink" title="uwsgi-nginx:python3.7測試"></a>uwsgi-nginx:python3.7測試</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker image build  -f python3.8-alpine.dockerfile . -t ttom/uwsgi-nginx:python3.8-alpine</span><br><span class="line">sudo docker build -f Dockerfile -t hisharp_webfms:python3.8 .</span><br></pre></td></tr></table></figure>





<h2 id="alpine相關"><a href="#alpine相關" class="headerlink" title="alpine相關"></a>alpine相關</h2><p><a href="http://5.9.10.113/56021952/gevent-uwsgi-plugin-not-loading-in-alpine-docker">http://5.9.10.113/56021952/gevent-uwsgi-plugin-not-loading-in-alpine-docker</a></p>
<p><a href="https://github.com/moshangguang/docker-nginx-uwsgi-flask-py3">https://github.com/moshangguang/docker-nginx-uwsgi-flask-py3</a></p>
<p><a href="https://www.itread01.com/content/1546680669.html">https://www.itread01.com/content/1546680669.html</a></p>
<p><a href="https://stackoverflow.com/questions/57787424/django-docker-python-unable-to-install-pillow-on-python-alpine">https://stackoverflow.com/questions/57787424/django-docker-python-unable-to-install-pillow-on-python-alpine</a></p>
<p><a href="https://stackoverflow.com/questions/56021952/gevent-uwsgi-plugin-not-loading-in-alpine-docker">https://stackoverflow.com/questions/56021952/gevent-uwsgi-plugin-not-loading-in-alpine-docker</a></p>
<h2 id="uwsgi-gevent-buster相關"><a href="#uwsgi-gevent-buster相關" class="headerlink" title="uwsgi-gevent-buster相關"></a>uwsgi-gevent-buster相關</h2><p><a href="https://medium.com/into-the-night/flask-app-with-boto3-uwsgi-and-gevent-in-docker-i-uwsgi-and-gevent-on-python3-7-alpine-image-f0d9c9ac1f5c">https://medium.com/into-the-night/flask-app-with-boto3-uwsgi-and-gevent-in-docker-i-uwsgi-and-gevent-on-python3-7-alpine-image-f0d9c9ac1f5c</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 移除所有未使用的 Docker 項目</span></span><br><span class="line">$ sudo docker system prune</span><br><span class="line"><span class="comment"># 重新編譯時需要加上--no-cache</span></span><br><span class="line">sudo docker build -t gavin/python:latest . --no-cache</span><br><span class="line"><span class="comment"># ------------------------------------------------------------------------------------------------------</span></span><br><span class="line">sudo docker build --tag uwsgi-gevent:buster .</span><br><span class="line">curl http://10.4.7.131/long-polling</span><br><span class="line">siege -c100 -t60  -v http://10.4.7.131/long-polling</span><br><span class="line"></span><br><span class="line">sudo docker build --tag tiangolo/uwsgi-nginx:python3.6 -f python3.6.dockerfile . --no-cache</span><br><span class="line"></span><br><span class="line">sudo docker build --tag nginx-uwsgi-gevent:3.6 .</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">sudo docker build -f Dockerfile -t gevent_webfms .</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">siege -c20 -t60  -v http://127.0.0.1:5000/long-polling</span><br><span class="line">siege -c100 -t60  -v http://10.4.7.131/long-polling</span><br><span class="line">curl http://10.4.7.131/long-polling</span><br><span class="line"></span><br><span class="line">curl http://192.168.40.191/long-polling</span><br><span class="line">siege -c100 -t60  -v http://192.168.40.191/long-polling</span><br><span class="line"></span><br><span class="line">curl http://192.168.40.191:8880/long-polling</span><br></pre></td></tr></table></figure>

<h1 id="Docker指令"><a href="#Docker指令" class="headerlink" title="Docker指令"></a>Docker指令</h1><p>記錄一下使用到的指令</p>
<h2 id="查看所有正在運行的docker"><a href="#查看所有正在運行的docker" class="headerlink" title="查看所有正在運行的docker"></a>查看所有正在運行的docker</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps -a</span><br></pre></td></tr></table></figure>
<h2 id="列出所有的容器-ID"><a href="#列出所有的容器-ID" class="headerlink" title="列出所有的容器 ID"></a>列出所有的容器 ID</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -aq</span><br></pre></td></tr></table></figure>


<h2 id="移除所有不執行的contaner"><a href="#移除所有不執行的contaner" class="headerlink" title="移除所有不執行的contaner"></a>移除所有不執行的contaner</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker <span class="built_in">rm</span> $(sudo docker ps -aq)</span><br></pre></td></tr></table></figure>

<h2 id="停止所有的容器"><a href="#停止所有的容器" class="headerlink" title="停止所有的容器"></a>停止所有的容器</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stop $(sudo docker ps -aq)</span><br></pre></td></tr></table></figure>

<h2 id="查看容器所有信息"><a href="#查看容器所有信息" class="headerlink" title="查看容器所有信息"></a>查看容器所有信息</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker inspect CONTAINER_ID</span><br></pre></td></tr></table></figure>

<h2 id="查看容器日誌"><a href="#查看容器日誌" class="headerlink" title="查看容器日誌"></a>查看容器日誌</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker container logs CONTAINER_ID</span><br></pre></td></tr></table></figure>

<h2 id="進入容器"><a href="#進入容器" class="headerlink" title="進入容器"></a>進入容器</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker exec -it CONTAINER_ID /bin/bash</span><br></pre></td></tr></table></figure>

<h2 id="刪除容器"><a href="#刪除容器" class="headerlink" title="刪除容器"></a>刪除容器</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rm CONTAINER_ID</span><br></pre></td></tr></table></figure>

<h2 id="移除所有未使用的-Docker-項目"><a href="#移除所有未使用的-Docker-項目" class="headerlink" title="移除所有未使用的 Docker 項目"></a>移除所有未使用的 Docker 項目</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker system prune</span><br></pre></td></tr></table></figure>

<h2 id="删除所有的容器"><a href="#删除所有的容器" class="headerlink" title="删除所有的容器"></a>删除所有的容器</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rm $(sudo docker ps -aq)</span><br></pre></td></tr></table></figure>

<h2 id="删除所有的镜像"><a href="#删除所有的镜像" class="headerlink" title="删除所有的镜像"></a>删除所有的镜像</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rmi $(sudo docker images -q)</span><br></pre></td></tr></table></figure>

<h2 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker cp mycontainer:/opt/file.txt /opt/local/</span><br><span class="line">sudo docker cp /opt/local/file.txt mycontainer:/opt/</span><br></pre></td></tr></table></figure>

<h2 id="檢查設定是否正確"><a href="#檢查設定是否正確" class="headerlink" title="檢查設定是否正確"></a>檢查設定是否正確</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker-compose config</span><br></pre></td></tr></table></figure>



<h1 id="docker-io的登入"><a href="#docker-io的登入" class="headerlink" title="docker.io的登入"></a>docker.io的登入</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker login docker.io</span><br></pre></td></tr></table></figure>

<h2 id="Push-Image"><a href="#Push-Image" class="headerlink" title="Push Image"></a>Push Image</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@nvt-nginx-1:~$ sudo docker image <span class="built_in">ls</span></span><br><span class="line">REPOSITORY          TAG                    IMAGE ID            CREATED             SIZE</span><br><span class="line">nginx               v1.19.10_with_stream   9149e4e0458c        46 minutes ago      356MB</span><br><span class="line">nginx               v1.12_with_stream      4e520a7877a5        About an hour ago   355MB</span><br><span class="line">mynginx             1.12.2_with_stream     4e520a7877a5        About an hour ago   355MB</span><br><span class="line">&lt;none&gt;              &lt;none&gt;                 13a3798ad3a2        2 hours ago         132MB</span><br><span class="line">&lt;none&gt;              &lt;none&gt;                 5130402b6304        2 hours ago         117MB</span><br><span class="line">debian              stretch                fe718d1e4082        3 weeks ago         101MB</span><br><span class="line">hello-world         latest                 d1165f221234        2 months ago        13.3kB</span><br><span class="line">alpine              3.10.3                 965ea09ff2eb        18 months ago       5.55MB</span><br><span class="line">myaline             v3.10.3                965ea09ff2eb        18 months ago       5.55MB</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 替 image 建立一個版號</span></span><br><span class="line">sudo docker tag nginx:v1.19.10_with_stream ttom921/nginx:v1.19.10_with_stream</span><br><span class="line"><span class="comment"># 推至設定好的庫</span></span><br><span class="line">sudo docker push ttom921/nginx:v1.19.10_with_stream</span><br></pre></td></tr></table></figure>

<h1 id="Docker-compose"><a href="#Docker-compose" class="headerlink" title="Docker compose"></a>Docker compose</h1><p>當想要佈署的 docker container 超過一個以上時，會突然發現 docker run 這個指令打到手軟，特別是當要跑起來的容器還要掛載一堆本地端資料夾，一直寫 <code>-v /home/.../.../HostData1:/home/mountData -v /home/.../HostData2:/home/mountData2 </code>簡直是記憶力大考驗。這時候就是拿出 <strong>Docker Compose</strong> 這個工具的時候了~~</p>
<h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><p>最新版下載</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.24.0/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>



<p>更新權限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line">sudo docker-compose -version</span><br></pre></td></tr></table></figure>

<p>移除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rm /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove docker-compose</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get autoremove</span><br></pre></td></tr></table></figure>

<h2 id="如何寫docker-compose"><a href="#如何寫docker-compose" class="headerlink" title="如何寫docker-compose"></a>如何寫docker-compose</h2><p>先來檢查docker image</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo docker image <span class="built_in">ls</span></span><br><span class="line">REPOSITORY          TAG                    IMAGE ID            CREATED             SIZE</span><br><span class="line">ttom921/nginx       v1.19.10_with_stream   114608bbca8f        3 days ago          356MB</span><br><span class="line">&lt;none&gt;              &lt;none&gt;                 13a3798ad3a2        3 days ago          132MB</span><br><span class="line">&lt;none&gt;              &lt;none&gt;                 5130402b6304        3 days ago          117MB</span><br><span class="line">debian              stretch                fe718d1e4082        4 weeks ago         101MB</span><br><span class="line">hello-world         latest                 d1165f221234        2 months ago        13.3kB</span><br><span class="line">alpine              3.10.3                 965ea09ff2eb        18 months ago       5.55MB</span><br><span class="line">myaline             v3.10.3                965ea09ff2eb        18 months ago       5.55MB</span><br></pre></td></tr></table></figure>

<p>因為要使用nginx, 因為參數太多了所以使用docker compose</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd  ~</span><br><span class="line">vim docker-compose.yml</span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span>                                                                                                                                          </span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx_server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ttom921/nginx:v1.19.10_with_stream</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;1935:1935&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;2181:2181&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9091:9091&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9092:9092&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9093:9093&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/nginx:/etc/nginx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/local/nginx/html:/usr/local/nginx/html</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx00</span> </span><br></pre></td></tr></table></figure>

<p>第一行 version 一定要寫</p>
<p>services 定義所有的容器內容及相關細項</p>
<p>image:docker pull 的 image 名稱和 tag</p>
<ul>
<li>ports 這邊指明 8000:8000 的對映關係，就跟 docker run -p 8000:8000 一樣意思</li>
<li>volumes 這邊指定需要掛載本地端到容器內的資料夾，就跟 docker run -v aaa:bbb 一樣意思甚至這邊可以掛載多個還可以一次寫滿寫好</li>
<li>container_name 可以指定當容器啟動時的預設名稱</li>
</ul>
<h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><p>首先，請確定沒有任何其他複本的應用程式和資料庫正在執行 (<code>docker ps</code> 和 <code>docker rm -f &lt;ids&gt;</code>)</p>
<p>起動</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>關畢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker-compose  down</span><br></pre></td></tr></table></figure>





<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><p><a href="https://www.coderbridge.com/@Jemmy1234/6d48f03f39284fe98ae9808f1243ef98">利用 Docker Compose 管理多個容器</a></p>
<h1 id="Openstreetmap的Docker相關"><a href="#Openstreetmap的Docker相關" class="headerlink" title="Openstreetmap的Docker相關"></a>Openstreetmap的Docker相關</h1><p>因為在使用openstreetmap時，需要有路徑導航的api，有人有open source，但是需要Docker來安裝，所以就也先來安裝Ubuntu18.04.3服務版</p>
<h2 id="安裝Docker"><a href="#安裝Docker" class="headerlink" title="安裝Docker"></a>安裝Docker</h2><p>先在Ubuntu來安裝</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -sSL https://get.docker.com/ | sh</span><br></pre></td></tr></table></figure>

<p> 使用者加入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG docker ttom</span><br></pre></td></tr></table></figure>

<p>更新Docker run</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get upgrade</span><br></pre></td></tr></table></figure>

<p>目前 Docker 有支援 Linux、Mac 跟 Windows，到 <a href="https://store.docker.com/search?offering=community&q=&type=edition">Docker Store</a> 找到適合自己的版本，安裝完之後跑 <code>docker version</code>，有跑出版本就代表安裝成功了～</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull ubuntu</span><br></pre></td></tr></table></figure>

<p>完成後跑 <code>docker image ls</code> 可以看到有一個 ubuntu 的 image</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu              latest              775349758637        5 weeks ago         64.2MB</span><br></pre></td></tr></table></figure>

<p>首先透過下列指令安裝 Docker Compose。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.25.0/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<p>安裝完畢之後我們需要給予 Docker Compose 一定的執行權限。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<h2 id="Docker相關操作"><a href="#Docker相關操作" class="headerlink" title="Docker相關操作"></a>Docker相關操作</h2><p><strong>stop all containers:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker kill $(sudo docker ps -q)</span><br></pre></td></tr></table></figure>


<p>remove all containers**</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rm $(sudo docker ps -a -q)</span><br></pre></td></tr></table></figure>

<p><strong>remove all docker images</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rmi $(sudo docker images -q)</span><br></pre></td></tr></table></figure>

<p>查看所有docker的運行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps -a</span><br></pre></td></tr></table></figure>

<p>查看docker的運作的container</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps</span><br></pre></td></tr></table></figure>

<p>停止運行的container</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stop &lt;container_id&gt; </span><br></pre></td></tr></table></figure>

<p>列出docker的image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker image ls</span><br></pre></td></tr></table></figure>

<p>刪除用不到的image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rmi &lt;container_id&gt;</span><br></pre></td></tr></table></figure>





<h2 id="下載openrouteservice"><a href="#下載openrouteservice" class="headerlink" title="下載openrouteservice"></a>下載<a href="https://github.com/GIScience/openrouteservice">openrouteservice</a></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/GIScience/openrouteservice.git</span><br></pre></td></tr></table></figure>

<h2 id="建立它的DockerImage"><a href="#建立它的DockerImage" class="headerlink" title="建立它的DockerImage"></a>建立它的DockerImage</h2><p>到它的目錄下<code>ttom@ub64docktest:~/openrouteservice/docker$</code>，執行<code>sudo docker-compose up -d</code>會有下面的錯誤，以下面步驟來解決</p>
<p>出現<code>啟動 docker-compose 發生 ERROR: Couldn’t connect to Docker daemon at http+docker://localunixsocket - is it running? 錯誤</code></p>
<h4 id="Step-1-將當前用戶加入-docker-群組"><a href="#Step-1-將當前用戶加入-docker-群組" class="headerlink" title="Step 1. 將當前用戶加入 docker 群組"></a>Step 1. 將當前用戶加入 docker 群組</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gpasswd -a $&#123;USER&#125; docker</span><br></pre></td></tr></table></figure>

<h4 id="Step-2-退出當前用戶"><a href="#Step-2-退出當前用戶" class="headerlink" title="Step 2. 退出當前用戶"></a>Step 2. 退出當前用戶</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br></pre></td></tr></table></figure>

<h4 id="Step-3-再次切换到-ubuntu-用戶"><a href="#Step-3-再次切换到-ubuntu-用戶" class="headerlink" title="Step 3. 再次切换到 ubuntu 用戶"></a>Step 3. 再次切换到 ubuntu 用戶</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su ttom</span><br></pre></td></tr></table></figure>

<h4 id="Step-4-啟動-docker-compose"><a href="#Step-4-啟動-docker-compose" class="headerlink" title="Step 4. 啟動 docker-compose"></a>Step 4. 啟動 docker-compose</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>重新建置dock</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker-compose build</span><br></pre></td></tr></table></figure>



<p>最後產生它的DockerImage如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker_ors-app      latest              cc179fe7c398        17 hours ago        1.03GB</span><br><span class="line">openjdk             8-jdk               09df0563bdfc        2 weeks ago         488MB</span><br><span class="line">ubuntu              latest              775349758637        5 weeks ago         64.2MB</span><br></pre></td></tr></table></figure>

<p>使用指令來進入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker exec -it &lt;container_id&gt; /bin/bash</span><br></pre></td></tr></table></figure>

<p>查看docker里面的logs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker logs &lt;container_id&gt;</span><br></pre></td></tr></table></figure>

<p>可以瀏覽器來測試</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://172.18.2.48:8080/ors/health</span><br><span class="line">http://172.18.2.48:8080/ors/status </span><br></pre></td></tr></table></figure>

<h2 id="更新地圖"><a href="#更新地圖" class="headerlink" title="更新地圖"></a>更新地圖</h2><ol>
<li>將下載後的地圖檔放在<code>docker/data</code>下</li>
<li>修改<code>docker-compose.yml</code>中的<code>OSM_FILE</code>的pbf檔</li>
<li>重新建置dockimage</li>
</ol>
<p><strong>注意</strong>如果有更換地圖，要重新來建置dock的image，地圖大小會影響地圖準備好的時間，可以下查看一下log是否有錯誤<code>sudo docker logs &lt;container_id&gt;</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="attr">ors-app:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">ors-app</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line">        <span class="attr">build:</span></span><br><span class="line">            <span class="attr">context:</span> <span class="string">../</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">                <span class="attr">APP_CONFIG:</span> <span class="string">./docker/conf/app.config.sample</span></span><br><span class="line">                <span class="attr">OSM_FILE:</span> <span class="string">./docker/data/heidelberg.osm.gz</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./graphs:/ors-core/data/graphs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./elevation_cache:/ors-core/data/elevation_cache</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./logs/ors/:/var/log/ors/</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./logs/tomcat/:/usr/local/tomcat/logs</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">JAVA_OPTS=-Djava.awt.headless=true</span> <span class="string">-server</span> <span class="string">-XX:TargetSurvivorRatio=75</span> <span class="string">-XX:SurvivorRatio=64</span> <span class="string">-XX:MaxTenuringThreshold=3</span> <span class="string">-XX:+UseConcMarkSweepGC</span> <span class="string">-XX:+UseParNewGC</span> <span class="string">-XX:ParallelGCThreads=4</span> <span class="string">-Xms1g</span> <span class="string">-Xmx2g</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">CATALINA_OPTS=</span> <span class="string">-Dcom.sun.management.jmxremote</span> <span class="string">-Dcom.sun.management.jmxremote.port=9001</span> <span class="string">-Dcom.sun.management.jmxremote.rmi.port=9001</span> <span class="string">-Dcom.sun.management.jmxremote.authenticate=false</span> <span class="string">-Dcom.sun.management.jmxremote.ssl=false</span> <span class="string">-Djava.rmi.server.hostname=localhost</span></span><br></pre></td></tr></table></figure>














<h2 id="參考資料-1"><a href="#參考資料-1" class="headerlink" title="參考資料"></a>參考資料</h2><p><a href="https://larrylu.blog/step-by-step-dockerize-your-app-ecd8940696f4">Docker 實戰系列（一）：一步一步帶你 dockerize 你的應用</a></p>
<p><a href="https://oranwind.org/-solution-qi-dong-docker-compose-fa-sheng-error-couldnt-connect-to-docker-daemon-at-httpdockerlocalunixsocket-is-it-running-cuo-wu/">啟動 docker-compose 發生 ERROR: Couldn’t connect to Docker daemon at http+docker:&#x2F;&#x2F;localunixsocket - is it running? 錯誤</a></p>
<p><a href="https://hub.docker.com/_/ubuntu">https://hub.docker.com/_/ubuntu</a></p>
<p><a href="https://extract.bbbike.org/">地圖分割</a></p>
<p><a href="https://gist.github.com/evanscottgray/8571828">dock操作</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Docker/" rel="tag"># Docker</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E8%A8%98%E9%8C%84SSL%E7%9B%B8%E9%97%9C/%E8%A8%98%E9%8C%84pfx%E8%AD%89%E6%9B%B8%E7%9A%84%E7%94%A2%E7%94%9F/%E8%A8%98%E9%8C%84pfx%E8%AD%89%E6%9B%B8%E7%9A%84%E7%94%A2%E7%94%9F/" rel="prev" title="記錄pfx證書的產生">
                  <i class="fa fa-angle-left"></i> 記錄pfx證書的產生
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%E5%AD%B8%E7%BF%92FlaskSSE%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/%E5%AD%B8%E7%BF%92FlaskSSE%E7%9A%84%E7%9B%B8%E9%97%9C%E4%BD%BF%E7%94%A8/" rel="next" title="學習FlaskSSE的相關使用">
                  學習FlaskSSE的相關使用 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2018 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Tom Tang</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="回到頂端">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '60px',
  right: 'unset',
  left: '60px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
