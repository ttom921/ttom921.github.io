<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ttom921.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言 因在學習相關的Flask的教學在此記錄起來，以後可以來查閱">
<meta property="og:type" content="article">
<meta property="og:title" content="記錄Flask相關教學">
<meta property="og:url" content="https://ttom921.github.io/%E8%A8%98%E9%8C%84Flask%E7%9B%B8%E9%97%9C%E6%95%99%E5%AD%B8/%E8%A8%98%E9%8C%84Flask%E7%9B%B8%E9%97%9C%E6%95%99%E5%AD%B8/index.html">
<meta property="og:site_name" content="被施工的Tom的記錄">
<meta property="og:description" content="前言 因在學習相關的Flask的教學在此記錄起來，以後可以來查閱">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2020-11-13T09:46:33.000Z">
<meta property="article:modified_time" content="2024-03-03T14:22:03.405Z">
<meta property="article:author" content="Tom Tang">
<meta property="article:tag" content="Flask">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://ttom921.github.io/%E8%A8%98%E9%8C%84Flask%E7%9B%B8%E9%97%9C%E6%95%99%E5%AD%B8/%E8%A8%98%E9%8C%84Flask%E7%9B%B8%E9%97%9C%E6%95%99%E5%AD%B8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-TW","comments":true,"permalink":"https://ttom921.github.io/%E8%A8%98%E9%8C%84Flask%E7%9B%B8%E9%97%9C%E6%95%99%E5%AD%B8/%E8%A8%98%E9%8C%84Flask%E7%9B%B8%E9%97%9C%E6%95%99%E5%AD%B8/","path":"記錄Flask相關教學/記錄Flask相關教學/","title":"記錄Flask相關教學"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>記錄Flask相關教學 | 被施工的Tom的記錄</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">被施工的Tom的記錄</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">異想世界</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜尋" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E5%A7%8B%E7%9A%84github"><span class="nav-number">1.1.</span> <span class="nav-text">原始的github</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%9DUbuntu"><span class="nav-number">2.</span> <span class="nav-text">安裝Ubuntu</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%9DMariaDB"><span class="nav-number">2.1.</span> <span class="nav-text">安裝MariaDB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E4%BA%AB%E8%B3%87%E6%96%99%E5%A4%BE"><span class="nav-number">2.2.</span> <span class="nav-text">分享資料夾</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%9DFlask-%E5%9C%A8%E8%99%9B%E6%93%AC%E7%92%B0%E5%A2%83%E4%B8%8B"><span class="nav-number">2.3.</span> <span class="nav-text">安裝Flask(在虛擬環境下)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%9Dnginx"><span class="nav-number">2.4.</span> <span class="nav-text">安裝nginx</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#flask-%E6%A1%86%E6%9E%B6%E5%85%A5%E9%96%80%E5%9F%BA%E7%A4%8E%E7%9F%A5%E8%AD%98"><span class="nav-number">3.</span> <span class="nav-text">flask 框架入門基礎知識</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8blueprint"><span class="nav-number">3.1.</span> <span class="nav-text">使用blueprint</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%8F%88%E6%8E%A5%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">3.2.</span> <span class="nav-text">鏈接管理器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A5%E8%AA%8C%E7%B3%BB%E7%B5%B1"><span class="nav-number">3.3.</span> <span class="nav-text">日誌系統</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%8C%AF%E8%AA%A4%E8%99%95%E7%90%86"><span class="nav-number">3.4.</span> <span class="nav-text">錯誤處理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E5%BA%ABORM"><span class="nav-number">3.5.</span> <span class="nav-text">資料庫ORM</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#flask%E6%A1%86%E6%9E%B6%E5%85%A5%E9%96%80%E5%AF%A6%E4%BD%9C"><span class="nav-number">4.</span> <span class="nav-text">flask框架入門實作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%AA%AA%E6%98%8E"><span class="nav-number">4.1.</span> <span class="nav-text">基本說明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5%E9%9C%80%E8%A6%81%E7%9A%84lib"><span class="nav-number">4.2.</span> <span class="nav-text">加入需要的lib</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%9F%BA%E7%A4%8E"><span class="nav-number">4.3.</span> <span class="nav-text">建立基礎</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#flask-script"><span class="nav-number">4.4.</span> <span class="nav-text">flask_script</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E7%92%B0%E5%A2%83%E7%9A%84%E5%8A%A0%E8%BC%89"><span class="nav-number">4.5.</span> <span class="nav-text">不同環境的加載</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%AC%E8%A9%A6index"><span class="nav-number">4.6.</span> <span class="nav-text">測試index</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BE%8C%E5%8F%B0%E5%B8%B3%E6%88%B6%E6%A8%A1%E5%A1%8A%E9%96%8B%E7%99%BC"><span class="nav-number">5.</span> <span class="nav-text">後台帳戶模塊開發</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AA%8D%E8%AD%89%E5%8A%9F%E8%83%BD"><span class="nav-number">5.1.</span> <span class="nav-text">認證功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%99%BB%E9%8C%84%E9%80%80%E5%87%BA"><span class="nav-number">5.1.1.</span> <span class="nav-text">登錄退出</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%88%E4%BE%86%E9%87%8D%E6%96%B0%E9%85%8D%E7%BD%AE%E7%B6%B2%E9%A0%81%E5%92%8Cnginx"><span class="nav-number">5.2.</span> <span class="nav-text">先來重新配置網頁和nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%88%E4%BE%86%E5%BB%BA%E7%BD%AE%E7%B6%B2%E9%A0%81"><span class="nav-number">5.2.1.</span> <span class="nav-text">先來建置網頁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5login"><span class="nav-number">5.3.</span> <span class="nav-text">加入login</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5404%E9%A0%81"><span class="nav-number">5.4.</span> <span class="nav-text">加入404頁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B6%B2%E9%A0%81%E5%8F%83%E6%95%B8%E7%9A%84%E5%88%A4%E6%96%B7"><span class="nav-number">5.4.1.</span> <span class="nav-text">網頁參數的判斷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B3%E8%99%9F%E5%92%8C%E5%AF%86%E7%A2%BC%E7%9A%84%E5%88%A4%E6%96%B7"><span class="nav-number">5.4.2.</span> <span class="nav-text">帳號和密碼的判斷</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8Bauth-code"><span class="nav-number">5.5.</span> <span class="nav-text">建立auth code</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8client%E5%BB%BA%E7%AB%8B%E5%9B%9E%E5%82%B3%E5%80%BC%E7%9A%84dialog"><span class="nav-number">5.6.</span> <span class="nav-text">在client建立回傳值的dialog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%94%E5%8A%AB%E5%99%A8"><span class="nav-number">5.7.</span> <span class="nav-text">攔劫器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#client%E7%AB%AF"><span class="nav-number">5.7.1.</span> <span class="nav-text">client端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%A6%E6%98%AF%E9%9C%80%E8%A6%81%E6%AA%A2%E6%9F%A5%E7%99%BB%E5%85%A5"><span class="nav-number">5.7.2.</span> <span class="nav-text">否是需要檢查登入</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8BPython%E7%9A%84%E8%B7%AF%E5%BE%91"><span class="nav-number">6.</span> <span class="nav-text">查看Python的路徑</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%9Duwsgi"><span class="nav-number">7.</span> <span class="nav-text">安裝uwsgi</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WebSocket%E7%9B%B8%E9%97%9C"><span class="nav-number">8.</span> <span class="nav-text">WebSocket相關</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Flask-Sockets-%E6%B8%AC%E8%A9%A6%E4%B8%8A%E5%95%8F%E9%A1%8C"><span class="nav-number">8.1.</span> <span class="nav-text">使用Flask-Sockets(測試上問題)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#flask-uwsgi-websocket"><span class="nav-number">8.2.</span> <span class="nav-text">flask-uwsgi-websocket</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Tom Tang</p>
  <div class="site-description" itemprop="description">記錄有的沒有的</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://ttom921.github.io/%E8%A8%98%E9%8C%84Flask%E7%9B%B8%E9%97%9C%E6%95%99%E5%AD%B8/%E8%A8%98%E9%8C%84Flask%E7%9B%B8%E9%97%9C%E6%95%99%E5%AD%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tom Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="被施工的Tom的記錄">
      <meta itemprop="description" content="記錄有的沒有的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="記錄Flask相關教學 | 被施工的Tom的記錄">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          記錄Flask相關教學
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2020-11-13 09:46:33" itemprop="dateCreated datePublished" datetime="2020-11-13T09:46:33+00:00">2020-11-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-03-03 14:22:03" itemprop="dateModified" datetime="2024-03-03T14:22:03+00:00">2024-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/" itemprop="url" rel="index"><span itemprop="name">學習</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%B8%E7%BF%92/Python/Flask/" itemprop="url" rel="index"><span itemprop="name">Flask</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p> 因在學習相關的Flask的教學在此記錄起來，以後可以來查閱<br> <span id="more"></span> </p>
<h2 id="原始的github"><a href="#原始的github" class="headerlink" title="原始的github"></a>原始的github</h2><p><a href="https://github.com/mooc-class/python-flask-minapp">https://github.com/mooc-class/python-flask-minapp</a></p>
<h1 id="安裝Ubuntu"><a href="#安裝Ubuntu" class="headerlink" title="安裝Ubuntu"></a>安裝Ubuntu</h1><p>安裝ubuntu的系統，可以參考網路上的教學，目前只針對套件的安裝來記錄一下。</p>
<h2 id="安裝MariaDB"><a href="#安裝MariaDB" class="headerlink" title="安裝MariaDB"></a>安裝MariaDB</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install software-properties-common dirmngr apt-transport-https</span><br><span class="line">sudo apt-key adv --fetch-keys &#x27;https://mariadb.org/mariadb_release_signing_key.asc&#x27;</span><br><span class="line">sudo add-apt-repository &#x27;deb [arch=amd64,arm64,ppc64el] https://ftp.ubuntu-tw.org/mirror/mariadb/repo/10.5/ubuntu bionic main&#x27;</span><br></pre></td></tr></table></figure>

<p>接下來</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install mariadb-server</span><br></pre></td></tr></table></figure>

<p>檢查版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -V</span><br></pre></td></tr></table></figure>

<p>設定root</p>
<p>安裝MariaDB過程中沒有問root密碼要設什麼，也沒有預設密碼，那之後用什麼密碼連呢？紀錄一下，免得忘記：<br>用sudo使用無密碼進入mysql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql -u root</span><br></pre></td></tr></table></figure>

<p>建立使用者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;</span><br><span class="line">CREATE USER &#x27;imooc&#x27; IDENTIFIED BY &#x27;12345678&#x27;;</span><br><span class="line">GRANT USAGE ON *.* TO &#x27;imooc&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;12345678&#x27;;</span><br><span class="line">GRANT USAGE ON *.* TO &#x27;imooc&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;12345678&#x27;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">//檢查</span><br><span class="line">SHOW GRANTS FOR &#x27;imooc&#x27;@&#x27;localhost&#x27;;  </span><br><span class="line"></span><br><span class="line">grant all privileges on *.* to &#x27;imooc&#x27;@&#x27;localhost&#x27; identified by &#x27;12345678&#x27; with grant option;</span><br><span class="line">grant all privileges on *.* to &#x27;imooc&#x27;@&#x27;%&#x27; identified by &#x27;12345678&#x27; with grant option;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p>不能遠端連線</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/mysql/mariadb.conf.d/50-server.cnf</span><br></pre></td></tr></table></figure>

<p><a href="https://websiteforstudents.com/allow-remote-access-to-mariadb-database-server-on-ubuntu-18-04/">https://websiteforstudents.com/allow-remote-access-to-mariadb-database-server-on-ubuntu-18-04/</a></p>
<p>主要是將bind-address &#x3D; 127.0.0.1 修改成 bind-address &#x3D; 0.0.0.0</p>
<p>命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop mariadb.service</span><br><span class="line">sudo systemctl start mariadb.service</span><br><span class="line">sudo systemctl enable mariadb.service</span><br></pre></td></tr></table></figure>

<h2 id="分享資料夾"><a href="#分享資料夾" class="headerlink" title="分享資料夾"></a>分享資料夾</h2><p><a href="https://askubuntu.com/questions/29284/how-do-i-mount-shared-folders-in-ubuntu-using-vmware-tools">https://askubuntu.com/questions/29284/how-do-i-mount-shared-folders-in-ubuntu-using-vmware-tools</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /mnt/cdrom</span><br><span class="line">sudo mount /dev/cdrom /mnt/cdrom/</span><br><span class="line">cd /mnt/cdrom</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>令檢視當前有哪些共享的目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vmware-hgfsclient</span><br><span class="line">sudo vmhgfs-fuse .host:/imooc /mnt/hgfs/ -o allow_other -o uid=1000</span><br></pre></td></tr></table></figure>

<p>You may have use a specific folder instead of <code>.host:/</code>. In that case you can find out the share’s name with <code>vmware-hgfsclient</code>. For example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vmware-hgfsclient</span><br><span class="line">my-shared-folder</span><br><span class="line">$ sudo vmhgfs-fuse .host:/my-shared-folder /mnt/hgfs/ -o allow_other -o uid=1000</span><br></pre></td></tr></table></figure>

<p>If you want them mounted on startup, update <code>/etc/fstab</code> with the following:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Use shared folders between VMWare guest and host</span><br><span class="line">.host:/    /mnt/hgfs/    fuse.vmhgfs-fuse    defaults,allow_other,uid=1000     0    0</span><br></pre></td></tr></table></figure>

<p>I choose to mount them on demand and have them ignored by <code>sudo mount -a</code> and the such with the <code>noauto</code> option, because I noticed the shares have an impact on VM performance.</p>
<p>在<code>/mnt/hgfs/imooc</code>下建立目錄www</p>
<p>然後建立symbolylink</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /mnt/hgfs/imooc/www/ /home/ttom/www</span><br></pre></td></tr></table></figure>

<p>之後會在<code>/home/ttom</code>下面出www的連結，可以在此下面建立程式和資料，這在windwo也會出現資料夾和資料</p>
<p>安裝pip3</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python3-pip</span><br></pre></td></tr></table></figure>

<p>安裝虛擬環境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python3-venv</span><br></pre></td></tr></table></figure>

<p>起動虛擬環境</p>
<p>先在家目錄建立環境，將其複制到分享的資料夾，之後可以移除原來建立的資料夾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">python3 -m venv test_env</span><br><span class="line">cp -Lr test_env/ www</span><br><span class="line">cd www</span><br><span class="line">source test_env/bin/activate</span><br><span class="line">deactivate</span><br></pre></td></tr></table></figure>

<p>可以移除原來建立的資料夾</p>
<p>先來建立imooc_env的虛擬環境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">python3 -m venv imooc_env</span><br><span class="line">cp -Lr imooc_env/ www</span><br><span class="line">rm -rf imooc_env</span><br><span class="line">cd www</span><br><span class="line">source immoc_env/bin/activate</span><br></pre></td></tr></table></figure>

<h2 id="安裝Flask-在虛擬環境下"><a href="#安裝Flask-在虛擬環境下" class="headerlink" title="安裝Flask(在虛擬環境下)"></a>安裝Flask(在虛擬環境下)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install flask</span><br></pre></td></tr></table></figure>

<p>測試一下</p>
<p>建立order的目錄和hello.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)  </span><br></pre></td></tr></table></figure>

<p>打開瀏覽器，網址是ubuntu的ip加5000,例如<code>http://192.168.83.128:5000/</code></p>
<h2 id="安裝nginx"><a href="#安裝nginx" class="headerlink" title="安裝nginx"></a>安裝nginx</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure>

<p>檢查nginx的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status nginx</span><br></pre></td></tr></table></figure>

<p>nginx的相關命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop nginx</span><br><span class="line">sudo systemctl start nginx</span><br><span class="line">sudo systemctl restart nginx</span><br><span class="line">sudo systemctl reload nginx</span><br></pre></td></tr></table></figure>



<h1 id="flask-框架入門基礎知識"><a href="#flask-框架入門基礎知識" class="headerlink" title="flask 框架入門基礎知識"></a>flask 框架入門基礎知識</h1><h2 id="使用blueprint"><a href="#使用blueprint" class="headerlink" title="使用blueprint"></a>使用blueprint</h2><p>修改一下nginx的設定檔的名稱叫<code>imooc.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">                <span class="attribute">root</span> /home/ttom/www;<span class="comment"># server 靜態檔案位置</span></span><br><span class="line">                <span class="attribute">index</span> index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#以下是api的webservice</span></span><br><span class="line">        <span class="section">location</span><span class="regexp"> ^~</span> /v0.<span class="number">0</span>/ &#123; <span class="comment"># 當api prefix是v0.0開頭 rquest過來會proxy 給5000 port的 local api service</span></span><br><span class="line">                <span class="attribute">proxy_pass</span> http://127.0.0.1:5000;</span><br><span class="line">                <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;<span class="comment"># 在proxy request 時保留client 的header</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新增檔案叫<code>imooc.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line">route_imooc = Blueprint(<span class="string">&quot;imooc_page&quot;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@route_imooc.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;imooc index page&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@route_imooc.route(<span class="params"><span class="string">&quot;/hello&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index_hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;imooc hello page&quot;</span></span><br></pre></td></tr></table></figure>

<p>在修改一下<code>hello2.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,jsonify,jsonify</span><br><span class="line"><span class="keyword">from</span> imooc <span class="keyword">import</span> route_imooc</span><br><span class="line">API_VERSION=<span class="string">&quot;v0.0&quot;</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.register_blueprint(route_imooc,url_prefix=<span class="string">&#x27;/&#123;0&#125;/api/imooc&#x27;</span>.<span class="built_in">format</span>(API_VERSION))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">v0_0index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello world /v0.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello world /v0.0/api&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/movies&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_movies_api</span>():</span><br><span class="line">    movies=[&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;刺激1995&#x27;</span>&#125;,&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;教父&#x27;</span>&#125;]</span><br><span class="line">    <span class="keyword">return</span> jsonify(movies) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>在瀏覽器下可以取得到資料</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.83.128/v0.0/</span><br><span class="line">http://192.168.83.128/v0.0/api</span><br><span class="line">http://192.168.83.128/v0.0/api/movies</span><br><span class="line">使用blueprint</span><br><span class="line">http://192.168.83.128/v0.0/api/imooc</span><br><span class="line">http://192.168.83.128/v0.0/api/imooc/hello</span><br></pre></td></tr></table></figure>

<h2 id="鏈接管理器"><a href="#鏈接管理器" class="headerlink" title="鏈接管理器"></a>鏈接管理器</h2><p>在order下建立common\libs\UrlManager.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UrlManager</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUrl</span>(<span class="params">path</span>):</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildStaticUrl</span>(<span class="params">path</span>):</span><br><span class="line">        <span class="keyword">return</span> path   </span><br></pre></td></tr></table></figure>

<p>測試</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,url_for,jsonify</span><br><span class="line"><span class="keyword">from</span> imooc <span class="keyword">import</span> route_imooc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> common.libs.UrlManager <span class="keyword">import</span> UrlManager</span><br><span class="line"></span><br><span class="line">API_VERSION=<span class="string">&quot;v0.0&quot;</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.register_blueprint(route_imooc,url_prefix=<span class="string">&#x27;/&#123;0&#125;/api/imooc&#x27;</span>.<span class="built_in">format</span>(API_VERSION))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">v0_0index</span>():</span><br><span class="line">    url = url_for(<span class="string">&quot;hello_world&quot;</span>)</span><br><span class="line">    url1_1= UrlManager.buildUrl(<span class="string">&quot;/v0.0/api&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello world url=%s , url1_1=%s &quot;</span> %(url,url1_1)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello world /v0.0/api&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/movies&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_movies_api</span>():</span><br><span class="line">    movies=[&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;刺激1995&#x27;</span>&#125;,&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;教父&#x27;</span>&#125;]</span><br><span class="line">    <span class="keyword">return</span> jsonify(movies) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>瀏覽器”<a href="http://192.168.83.128/v0.0/">http://192.168.83.128/v0.0/</a>“</p>
<h2 id="日誌系統"><a href="#日誌系統" class="headerlink" title="日誌系統"></a>日誌系統</h2><p>Flask有內建一的日誌系統，來測試一下, 有三個級別，只有error是在所有情況下輸出資訊</p>
<p>以下是範例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.logger.debug(<span class="string">&#x27;A value for debugging&#x27;</span>)</span><br><span class="line">app.logger.warning(<span class="string">&#x27;A warning occurred (%d apples)&#x27;</span>, <span class="number">42</span>)</span><br><span class="line">app.logger.error(<span class="string">&#x27;An error occurred&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>修改一下<code>hello2.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,url_for,jsonify</span><br><span class="line"><span class="keyword">from</span> imooc <span class="keyword">import</span> route_imooc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> common.libs.UrlManager <span class="keyword">import</span> UrlManager</span><br><span class="line"></span><br><span class="line">API_VERSION=<span class="string">&quot;v0.0&quot;</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.register_blueprint(route_imooc,url_prefix=<span class="string">&#x27;/&#123;0&#125;/api/imooc&#x27;</span>.<span class="built_in">format</span>(API_VERSION))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">v0_0index</span>():</span><br><span class="line">    url = url_for(<span class="string">&quot;hello_world&quot;</span>)</span><br><span class="line">    url1_1= UrlManager.buildUrl(<span class="string">&quot;/v0.0/api&quot;</span>)</span><br><span class="line">    msg =  <span class="string">&quot;hello world url=%s , url1_1=%s &quot;</span> %(url,url1_1)</span><br><span class="line">    app.logger.debug(msg)</span><br><span class="line">    app.logger.warning(msg)</span><br><span class="line">    app.logger.error(msg)   </span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello world /v0.0/api&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/movies&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_movies_api</span>():</span><br><span class="line">    movies=[&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;刺激1995&#x27;</span>&#125;,&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;教父&#x27;</span>&#125;]</span><br><span class="line">    <span class="keyword">return</span> jsonify(movies) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>瀏覽器”<a href="http://192.168.83.128/v0.0/%22%E5%9C%A8console%E4%B8%AD%E5%A6%82%E4%B8%8B%E7%9A%84%E9%A1%AF%E7%A4%BA">http://192.168.83.128/v0.0/&quot;在console中如下的顯示</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> * Serving Flask app <span class="string">&quot;hello2&quot;</span> (lazy loading)</span><br><span class="line"> * Environment: production</span><br><span class="line">   WARNING: This is a development server. Do not use it <span class="keyword">in</span> a production deployment.</span><br><span class="line">   Use a production WSGI server instead.</span><br><span class="line"> * Debug mode: off</span><br><span class="line"> * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</span><br><span class="line">[2020-11-19 01:26:40,227] WARNING <span class="keyword">in</span> hello2: hello world url=/v0.0/api , url1_1=/v0.0/api</span><br><span class="line">[2020-11-19 01:26:40,227] ERROR <span class="keyword">in</span> hello2: hello world url=/v0.0/api , url1_1=/v0.0/api</span><br><span class="line">127.0.0.1 - - [19/Nov/2020 01:26:40] <span class="string">&quot;GET /v0.0/ HTTP/1.0&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<p>如果要全部輸出的話，要將Debug mode打開<code>hello2.py</code>修改如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以上不變</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run( debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>輸出如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> * Serving Flask app &quot;hello2&quot; (lazy loading)</span><br><span class="line"> * Environment: production</span><br><span class="line">   WARNING: This is a development server. Do not use it in a production deployment.</span><br><span class="line">   Use a production WSGI server instead.</span><br><span class="line"> * Debug mode: on</span><br><span class="line"> * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</span><br><span class="line"> * Restarting with stat</span><br><span class="line"> * Debugger is active!</span><br><span class="line"> * Debugger PIN: 153-792-531</span><br><span class="line">[2020-11-19 01:33:02,534] DEBUG in hello2: hello world url=/v0.0/api , url1_1=/v0.0/api</span><br><span class="line">[2020-11-19 01:33:02,534] WARNING in hello2: hello world url=/v0.0/api , url1_1=/v0.0/api</span><br><span class="line">[2020-11-19 01:33:02,535] ERROR in hello2: hello world url=/v0.0/api , url1_1=/v0.0/api</span><br><span class="line">127.0.0.1 - - [19/Nov/2020 01:33:02] &quot;GET /v0.0/ HTTP/1.0&quot; 200 -</span><br></pre></td></tr></table></figure>

<h2 id="錯誤處理"><a href="#錯誤處理" class="headerlink" title="錯誤處理"></a>錯誤處理</h2><p>目前測試是以找不到網頁來測試，以下是範例程式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page_not_found</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;This page does not exist&#x27;</span>, <span class="number">404</span></span><br></pre></td></tr></table></figure>

<p>在hello2.py中修改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,url_for,jsonify</span><br><span class="line"><span class="keyword">from</span> imooc <span class="keyword">import</span> route_imooc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> common.libs.UrlManager <span class="keyword">import</span> UrlManager</span><br><span class="line"></span><br><span class="line">API_VERSION=<span class="string">&quot;v0.0&quot;</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.register_blueprint(route_imooc,url_prefix=<span class="string">&#x27;/&#123;0&#125;/api/imooc&#x27;</span>.<span class="built_in">format</span>(API_VERSION))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">v0_0index</span>():</span><br><span class="line">    url = url_for(<span class="string">&quot;hello_world&quot;</span>)</span><br><span class="line">    url1_1= UrlManager.buildUrl(<span class="string">&quot;/v0.0/api&quot;</span>)</span><br><span class="line">    msg =  <span class="string">&quot;hello world url=%s , url1_1=%s &quot;</span> %(url,url1_1)</span><br><span class="line">    app.logger.debug(msg)</span><br><span class="line">    app.logger.warning(msg)</span><br><span class="line">    app.logger.error(msg)   </span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello world /v0.0/api&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/movies/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_movies_api</span>():</span><br><span class="line">    movies=[&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;刺激1995&#x27;</span>&#125;,&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;教父&#x27;</span>&#125;]</span><br><span class="line">    <span class="keyword">return</span> jsonify(movies) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 找不到網頁的error handler</span></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page_not_found</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;This page does not exist&#x27;</span>, <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run( debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>當找不到網頁時，會顯示<code>This page does not exist</code></p>
<h2 id="資料庫ORM"><a href="#資料庫ORM" class="headerlink" title="資料庫ORM"></a>資料庫ORM</h2><p>先來安裝相關的套件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y install default-libmysqlclient-dev software-properties-common</span><br><span class="line">pip3 install mysqlclient SQLAlchemy flask-sqlalchemy</span><br></pre></td></tr></table></figure>

<p>在hello2.py中修改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,url_for,jsonify</span><br><span class="line"><span class="keyword">from</span> imooc <span class="keyword">import</span> route_imooc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> common.libs.UrlManager <span class="keyword">import</span> UrlManager</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line">API_VERSION=<span class="string">&quot;v0.0&quot;</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料庫相關</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&quot;mysql://imooc:12345678@127.0.0.1:3306/mysql&quot;</span></span><br><span class="line">db=SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line">app.register_blueprint(route_imooc,url_prefix=<span class="string">&#x27;/&#123;0&#125;/api/imooc&#x27;</span>.<span class="built_in">format</span>(API_VERSION))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">v0_0index</span>():</span><br><span class="line">    url = url_for(<span class="string">&quot;hello_world&quot;</span>)</span><br><span class="line">    url1_1= UrlManager.buildUrl(<span class="string">&quot;/v0.0/api&quot;</span>)</span><br><span class="line">    msg =  <span class="string">&quot;hello world url=%s , url1_1=%s &quot;</span> %(url,url1_1)</span><br><span class="line">    app.logger.debug(msg)</span><br><span class="line">    app.logger.warning(msg)</span><br><span class="line">    app.logger.error(msg)   </span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> text</span><br><span class="line">    sql= text(<span class="string">&quot;SELECT * from `user`&quot;</span>)</span><br><span class="line">    result = db.engine.execute(sql)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        app.logger.info(row)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello world /v0.0/api&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v0.0/api/movies/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_movies_api</span>():</span><br><span class="line">    movies=[&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;刺激1995&#x27;</span>&#125;,&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;教父&#x27;</span>&#125;]</span><br><span class="line">    <span class="keyword">return</span> jsonify(movies) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 找不到網頁的error handler</span></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page_not_found</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;This page does not exist&#x27;</span>, <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run( debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h1 id="flask框架入門實作"><a href="#flask框架入門實作" class="headerlink" title="flask框架入門實作"></a>flask框架入門實作</h1><p>這是一個基礎的框架，可以來使用到很多的地方</p>
<h2 id="基本說明"><a href="#基本說明" class="headerlink" title="基本說明"></a>基本說明</h2><p>目前所使用到的目錄結構</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">order                               # 主要目錄</span><br><span class="line">│  application.py                   # 封裝的Flask的全局變量，包括app，資料庫等</span><br><span class="line">│  manage.py                        # 啟動入口</span><br><span class="line">│  readme.md                        # 使用文檔</span><br><span class="line">│  requirements.txt                 # python 擴展</span><br><span class="line">│  www.py                           # HTTP 模塊相關起動</span><br><span class="line">│</span><br><span class="line">├─common                            # 存放公用部分        </span><br><span class="line">│  ├─libs                           # 公用方法或者類</span><br><span class="line">│  └─models                         # 所有的資料庫model</span><br><span class="line">├─config                            # 配置文件</span><br><span class="line">│      base_setting.py              # 基礎配置</span><br><span class="line">│      local_setting_demo.py        # 本地開發環境配置demo</span><br><span class="line">│      production_setting.py        # 生產環境的配置</span><br><span class="line">│</span><br><span class="line">├─docs                              # 文檔存放</span><br><span class="line">│      mariadb.md                   # 所有資料庫變更必須在這里記錄</span><br><span class="line">│</span><br><span class="line">├─jobs                              # 定時任務</span><br><span class="line">│  └─tasks                          # 所有定時任務都存放在這里</span><br><span class="line">└─web                               # HTTP 存放</span><br></pre></td></tr></table></figure>

<h2 id="加入需要的lib"><a href="#加入需要的lib" class="headerlink" title="加入需要的lib"></a>加入需要的lib</h2><p>在requirements.txt中加入需要的lib</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flask</span><br><span class="line">SQLAlchemy</span><br><span class="line">flask-sqlalchemy</span><br><span class="line">mysqlclient</span><br></pre></td></tr></table></figure>



<h2 id="建立基礎"><a href="#建立基礎" class="headerlink" title="建立基礎"></a>建立基礎</h2><p>先來處理<code>application.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Application</span>(<span class="title class_ inherited__">Flask</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,import_name</span>):</span><br><span class="line">        <span class="built_in">super</span>(Application,self).__init__(import_name)</span><br><span class="line">        self.config.from_pyfile(<span class="string">&#x27;config/base_setting.py&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        db.init_app(self)</span><br><span class="line">        </span><br><span class="line">db = SQLAlchemy()</span><br><span class="line">app = Application(__name__)</span><br></pre></td></tr></table></figure>

<p>處理<code>manager.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">#app.run(host=&#x27;0.0.0.0&#x27;,debug=&#x27;True&#x27;)</span></span><br><span class="line">    app.run(debug=<span class="string">&#x27;True&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        sys.exit(main())</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc()</span><br></pre></td></tr></table></figure>

<p>加入資料庫配置文件<code>base_setting.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">&#x27;mysql://imooc:12345678@127.0.0.1:3306/mysql&#x27;</span></span><br><span class="line"></span><br><span class="line">SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<h2 id="flask-script"><a href="#flask-script" class="headerlink" title="flask_script"></a>flask_script</h2><p>可以在執行<code>manager.py</code>時代入參數在<code>requirements.txt</code>中加入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flask</span><br><span class="line">SQLAlchemy</span><br><span class="line">flask-sqlalchemy</span><br><span class="line">mysqlclient</span><br><span class="line">flask_script</span><br></pre></td></tr></table></figure>

<p>安裝</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install -r  requirements.txt</span><br></pre></td></tr></table></figure>

<p>在<code>application.py</code>中加入它的管理器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Manager</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Application</span>(<span class="title class_ inherited__">Flask</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,import_name</span>):</span><br><span class="line">        <span class="built_in">super</span>(Application,self).__init__(import_name)</span><br><span class="line">        self.config.from_pyfile(<span class="string">&#x27;config/base_setting.py&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        db.init_app(self)</span><br><span class="line">        </span><br><span class="line">db = SQLAlchemy()</span><br><span class="line">app = Application(__name__)</span><br><span class="line">manager = Manager(app)</span><br></pre></td></tr></table></figure>

<p>在<code>manage.py</code>中加入Server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app,manager</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Server</span><br><span class="line"></span><br><span class="line"><span class="comment">## web server</span></span><br><span class="line">manager.add_command(<span class="string">&quot;runserver&quot;</span>,Server(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=<span class="number">5000</span>,use_debugger=<span class="literal">True</span>,use_reloader=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">#app.run(host=&#x27;0.0.0.0&#x27;,debug=&#x27;True&#x27;)</span></span><br><span class="line">    <span class="comment">#app.run(debug=&#x27;True&#x27;)</span></span><br><span class="line">    manager.run();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        sys.exit(main())</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc()</span><br></pre></td></tr></table></figure>

<p>如何使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 manager.py runserver</span><br></pre></td></tr></table></figure>

<p>如果要修改port，可以從設定檔來取得修改一下<code>config\base_setting.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SERVER_PORT = <span class="number">8999</span></span><br><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">&#x27;mysql://imooc:12345678@127.0.0.1:3306/mysql&#x27;</span></span><br><span class="line">SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>在<code>manage.py</code>中修改 port&#x3D;app.config[‘SERVER_PORT’]</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app,manager</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Server</span><br><span class="line"></span><br><span class="line"><span class="comment">## web server</span></span><br><span class="line">manager.add_command(<span class="string">&quot;runserver&quot;</span>,Server(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=app.config[<span class="string">&#x27;SERVER_PORT&#x27;</span>],use_debugger=<span class="literal">True</span>,use_reloader=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">#app.run(host=&#x27;0.0.0.0&#x27;,debug=&#x27;True&#x27;)</span></span><br><span class="line">    <span class="comment">#app.run(debug=&#x27;True&#x27;)</span></span><br><span class="line">    manager.run();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        sys.exit(main())</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc()</span><br></pre></td></tr></table></figure>

<p>就可以起動時修改port</p>
<h2 id="不同環境的加載"><a href="#不同環境的加載" class="headerlink" title="不同環境的加載"></a>不同環境的加載</h2><p>使用os.environ的變數來加載不同的設定檔</p>
<p>在<code>application.py</code>中來修改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Manager</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Application</span>(<span class="title class_ inherited__">Flask</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,import_name</span>):</span><br><span class="line">        <span class="built_in">super</span>(Application,self).__init__(import_name)</span><br><span class="line">        self.config.from_pyfile(<span class="string">&#x27;config/base_setting.py&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;ops_config&quot;</span> <span class="keyword">in</span> os.environ:</span><br><span class="line">            self.config.from_pyfile(<span class="string">&#x27;config/%s_setting.py&#x27;</span> % os.environ[<span class="string">&#x27;ops_config&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        db.init_app(self)</span><br><span class="line">        </span><br><span class="line">db = SQLAlchemy()</span><br><span class="line">app = Application(__name__)</span><br><span class="line">manager = Manager(app)</span><br></pre></td></tr></table></figure>

<p>在linux的命令行中，加入系統變數</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export ops_config=local</span><br></pre></td></tr></table></figure>

<p>在配置中的環境是不一樣的</p>
<p>在<code>config\base_setting.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SERVER_PORT = <span class="number">5000</span></span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line">SQLALCHEMY_ECHO = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>在<code>config\local_setting.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DEBUG = <span class="literal">True</span></span><br><span class="line">SQLALCHEMY_ECHO = <span class="literal">True</span></span><br><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">&#x27;mysql://imooc:12345678@127.0.0.1:3306/mysql&#x27;</span></span><br><span class="line">SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">False</span></span><br><span class="line">SQLALCHEMY_ENCODING = <span class="string">&#x27;utf-8&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="測試index"><a href="#測試index" class="headerlink" title="測試index"></a>測試index</h2><p>controller層在<code>web\controller\index.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line">router_index = Blueprint(<span class="string">&#x27;index_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_index.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>

<p>在<code>www.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> web.controller.index <span class="keyword">import</span> router_index</span><br><span class="line"></span><br><span class="line">app.register_blueprint(router_index,url_prefix=<span class="string">&quot;/&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>在<code>manage.py</code>中引入www</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app,manager</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Server</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> www <span class="comment">#引入</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## web server</span></span><br><span class="line">manager.add_command(<span class="string">&quot;runserver&quot;</span>,Server(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=app.config[<span class="string">&#x27;SERVER_PORT&#x27;</span>],use_debugger=<span class="literal">True</span>,use_reloader=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">#app.run(host=&#x27;0.0.0.0&#x27;,debug=&#x27;True&#x27;)</span></span><br><span class="line">    <span class="comment">#app.run(debug=&#x27;True&#x27;)</span></span><br><span class="line">    manager.run();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        sys.exit(main())</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc()</span><br></pre></td></tr></table></figure>

<p>在nginx的設定檔有修改<code>/etc/nginx/sites-available/imooc.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#location / &#123;</span></span><br><span class="line">        <span class="comment">#       root /home/ttom/www;# server 靜態檔案位置</span></span><br><span class="line">        <span class="comment">#        index index.html;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">        <span class="comment">#以下是api的webservice</span></span><br><span class="line">        <span class="comment">#location ^~ /v0.0/ &#123; # 當api prefix是v0.0開頭 rquest過來會proxy 給5000 port的 local api service</span></span><br><span class="line">        <span class="comment">#       proxy_pass http://127.0.0.1:5000;</span></span><br><span class="line">        <span class="comment">#       proxy_set_header Host $host;# 在proxy request 時保留client 的header</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="section">location</span> / &#123; <span class="comment"># 當api prefix是v0.0開頭 rquest過來會proxy 給5000 port的 local api service</span></span><br><span class="line">               <span class="attribute">proxy_pass</span> http://127.0.0.1:5000;</span><br><span class="line">               <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;<span class="comment"># 在proxy request 時保留client 的header</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="後台帳戶模塊開發"><a href="#後台帳戶模塊開發" class="headerlink" title="後台帳戶模塊開發"></a>後台帳戶模塊開發</h1><h2 id="認證功能"><a href="#認證功能" class="headerlink" title="認證功能"></a>認證功能</h2><h3 id="登錄退出"><a href="#登錄退出" class="headerlink" title="登錄退出"></a>登錄退出</h3><ul>
<li><p>新建數據庫</p>
<p>數據庫名：food_db</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE `food_db` DEFAULT CHARACTER SET = `utf8mb4`;</span><br></pre></td></tr></table></figure>


</li>
<li><p>新建管理員數據表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS `user`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `user` (</span><br><span class="line">  `uid` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;用户uid&#x27;,</span><br><span class="line">  `nickname` varchar(100) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;用户名&#x27;,</span><br><span class="line">  `mobile` varchar(20) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;手机号码&#x27;,</span><br><span class="line">  `email` varchar(100) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;邮箱地址&#x27;,</span><br><span class="line">  `sex` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;1：男 2：女 0：没填写&#x27;,</span><br><span class="line">  `avatar` varchar(64) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;头像&#x27;,</span><br><span class="line">  `login_name` varchar(20) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;登录用户名&#x27;,</span><br><span class="line">  `login_pwd` varchar(32) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;登录密码&#x27;,</span><br><span class="line">  `login_salt` varchar(32) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;登录密码的随机加密秘钥&#x27;,</span><br><span class="line">  `status` tinyint(1) NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;1：有效 0：无效&#x27;,</span><br><span class="line">  `updated_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;最后一次更新时间&#x27;,</span><br><span class="line">  `created_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;插入时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`uid`),</span><br><span class="line">  UNIQUE KEY `login_name` (`login_name`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;用户表（管理员）&#x27;;</span><br></pre></td></tr></table></figure>


</li>
<li><p>使用<code>flask-sqlacodegen</code>擴展方便快速生成ORM model</p>
<p>安裝flask-sqlacodegen</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install flask-sqlacodegen</span><br></pre></td></tr></table></figure>

<p>使用方法<strong>注意路徑</strong>主要使用一張表一個py檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flask-sqlacodegen &#x27;mysql://root:密碼@127.0.0.1/food_db?charset=utf8mb4&#x27; --outfile &quot;common/models/model.py&quot;  --flask</span><br><span class="line">flask-sqlacodegen &#x27;mysql://root:密碼@127.0.0.1/food_db?charset=utf8mb4&#x27; --tables user --outfile &quot;common/models/user.py&quot;  --flask</span><br><span class="line">//</span><br><span class="line">flask-sqlacodegen &#x27;mysql://imooc:12345678@127.0.0.1/food_db?charset=utf8mb4&#x27; --tables user --outfile &quot;common/models/user.py&quot;  --flask</span><br></pre></td></tr></table></figure>


</li>
<li><p>修改自動生成的model中的db變量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from application impor db</span><br></pre></td></tr></table></figure>


</li>
<li><p>修改配置文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">&#x27;mysql://imooc:12345678@127.0.0.1/food_db&#x27;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>開始寫代碼</p>
</li>
</ul>
<h2 id="先來重新配置網頁和nginx"><a href="#先來重新配置網頁和nginx" class="headerlink" title="先來重新配置網頁和nginx"></a>先來重新配置網頁和nginx</h2><h3 id="先來建置網頁"><a href="#先來建置網頁" class="headerlink" title="先來建置網頁"></a>先來建置網頁</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng new foodwebbackend</span><br></pre></td></tr></table></figure>

<p>設定nginx的設定檔<code>sudo vim /etc/nginx/sites-enabled/imooc.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="comment">#主網頁的位置</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">                <span class="comment">#root /home/ttom/www;# server 靜態檔案位置</span></span><br><span class="line">                <span class="comment">#index index.html;</span></span><br><span class="line">                <span class="comment">#alias /usr/share/nginx/html/;</span></span><br><span class="line">                <span class="attribute">alias</span> /home/ttom/www/foodwebbackend/dist/foodwebbackend/;</span><br><span class="line">                <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/  /index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#以下是api的webservice</span></span><br><span class="line">        <span class="section">location</span><span class="regexp"> ^~</span> /v0.<span class="number">0</span>/ &#123; <span class="comment"># 當api prefix是v0.0開頭 rquest過來會proxy 給5000 port的 local api service</span></span><br><span class="line">                <span class="attribute">proxy_pass</span> http://127.0.0.1:5000;</span><br><span class="line">                <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;<span class="comment"># 在proxy request 時保留client 的header</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>config\base_setting.py</code>中加入API_VERSION</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SERVER_PORT = 5000</span><br><span class="line">DEBUG = False</span><br><span class="line">SQLALCHEMY_ECHO = False</span><br><span class="line">API_VERSION = &#x27;v0.0&#x27;</span><br></pre></td></tr></table></figure>

<p>加入<code>web\controller\user\User.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;login&quot;</span></span><br></pre></td></tr></table></figure>

<p>要給angular的RXJS正確的返回值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,make_response,jsonify</span><br><span class="line"></span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login&quot;</span>), <span class="number">200</span>)</span><br></pre></td></tr></table></figure>

<p>在<code>www.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> web.controller.index <span class="keyword">import</span> router_index</span><br><span class="line"><span class="keyword">from</span> web.controller.user.User <span class="keyword">import</span> router_user</span><br><span class="line"><span class="comment">#註冊api</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#app.register_blueprint(router_index,url_prefix=&quot;/&quot;)</span></span><br><span class="line"><span class="comment">#app.register_blueprint(router_user,url_prefix = &quot;/v0.0/user&quot;)</span></span><br><span class="line">app.register_blueprint(router_index,url_prefix=<span class="string">&#x27;/&#123;0&#125;/&#x27;</span>.<span class="built_in">format</span>(app.config[<span class="string">&#x27;API_VERSION&#x27;</span>]))</span><br><span class="line">app.register_blueprint(router_user,url_prefix=<span class="string">&#x27;/&#123;0&#125;/user&#x27;</span>.<span class="built_in">format</span>(app.config[<span class="string">&#x27;API_VERSION&#x27;</span>]))</span><br></pre></td></tr></table></figure>

<h2 id="加入login"><a href="#加入login" class="headerlink" title="加入login"></a>加入login</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g c login</span><br></pre></td></tr></table></figure>



<h2 id="加入404頁"><a href="#加入404頁" class="headerlink" title="加入404頁"></a>加入404頁</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g c pages/not-found</span><br></pre></td></tr></table></figure>

<p>在<code>web\controller\user\User.py</code></p>
<p>加入request來取得”GET”,”POST”</p>
<p>加入mak_response產生web的頭</p>
<p>加入jsonify產生json</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"></span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login get&quot;</span>), <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;用戶登入&quot;</span>), <span class="number">200</span>)    </span><br></pre></td></tr></table></figure>

<p>在登入的網頁有修改<code>src\app\login\login.component.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> [<span class="attr">formGroup</span>]=<span class="string">&quot;formModel&quot;</span> (<span class="attr">ngSubmit</span>)=<span class="string">&quot;onSubmit($event)&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mat-card</span> <span class="attr">class</span>=<span class="string">&quot;login-card mat-elevation-z4&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;login100-form-title p-b-26&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;zmdi&quot;</span>&gt;</span>Welcome to Food<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-form-field</span> <span class="attr">class</span>=<span class="string">&quot;full-width&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-icon</span> <span class="attr">matPrefix</span> <span class="attr">style</span>=<span class="string">&quot;margin-right: 10px;&quot;</span>&gt;</span>mail<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">matInput</span> <span class="attr">placeholder</span>=<span class="string">&quot;登入名字&quot;</span> <span class="attr">formControlName</span>=<span class="string">&quot;login_name&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-error</span> *<span class="attr">ngIf</span>=<span class="string">&quot;formErrors.login_name&quot;</span>&gt;</span>&#123;&#123;formErrors.login_name&#125;&#125;<span class="tag">&lt;/<span class="name">mat-error</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-form-field</span> <span class="attr">class</span>=<span class="string">&quot;full-width&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-icon</span> <span class="attr">matPrefix</span> <span class="attr">style</span>=<span class="string">&quot;margin-right: 10px;&quot;</span>&gt;</span>vpn_key<span class="tag">&lt;/<span class="name">mat-icon</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">matInput</span> <span class="attr">placeholder</span>=<span class="string">&quot;password&quot;</span> <span class="attr">formControlName</span>=<span class="string">&quot;login_pwd&quot;</span> [<span class="attr">type</span>]=<span class="string">&quot;hide ? &#x27;password&#x27; : &#x27;text&#x27;&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- &lt;mat-icon matSuffix (click)=&quot;hide = !hide&quot;&gt;&#123;&#123;hide ? &#x27;visibility_off&#x27; : &#x27;visibility&#x27;&#125;&#125;&lt;/mat-icon&gt; --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mat-error</span> *<span class="attr">ngIf</span>=<span class="string">&quot;formErrors.login_pwd&quot;</span>&gt;</span>&#123;&#123;formErrors.login_pwd&#125;&#125;<span class="tag">&lt;/<span class="name">mat-error</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-form-field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mat-card-actions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">mat-raised-button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> [<span class="attr">disabled</span>]=<span class="string">&quot;!formModel.valid&quot;</span> <span class="attr">color</span>=<span class="string">&quot;primary&quot;</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mat-card-actions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mat-card</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\login\login.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FormBuilder</span>, <span class="title class_">FormGroup</span>, <span class="title class_">Validators</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../_service/user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-login&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./login.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./login.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="comment">//#region form 相關</span></span><br><span class="line">  <span class="attr">formModel</span>: <span class="title class_">FormGroup</span>;</span><br><span class="line">  hide = <span class="literal">true</span>;</span><br><span class="line">  <span class="attr">userInfo</span>: <span class="built_in">any</span> = &#123;&#125;;</span><br><span class="line">  formErrors = &#123;</span><br><span class="line">    <span class="string">&quot;login_name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;login_pwd&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;formError&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  vaildationMessages = &#123;</span><br><span class="line">    <span class="string">&quot;login_name&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: <span class="string">&quot;郵箱必須輸入&quot;</span>,</span><br><span class="line">      <span class="string">&quot;minlength&quot;</span>: <span class="string">&quot;請輸入至少要4位&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;login_pwd&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: <span class="string">&quot;密碼必須輸入&quot;</span>,</span><br><span class="line">      <span class="string">&quot;minlength&quot;</span>: <span class="string">&quot;密碼至少要4位&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">//#endregion form 相關</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> fb: FormBuilder,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> router: Router,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> userService: UserService</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">buildForm</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">buildForm</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">formModel</span> = <span class="variable language_">this</span>.<span class="property">fb</span>.<span class="title function_">group</span>(&#123;</span><br><span class="line">      <span class="string">&quot;login_name&quot;</span>: [</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_name</span>,</span><br><span class="line">        [</span><br><span class="line">          <span class="title class_">Validators</span>.<span class="property">required</span>,</span><br><span class="line">          <span class="title class_">Validators</span>.<span class="title function_">minLength</span>(<span class="number">4</span>),</span><br><span class="line">        ]</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;login_pwd&quot;</span>: [</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_pwd</span>,</span><br><span class="line">        [</span><br><span class="line">          <span class="title class_">Validators</span>.<span class="property">required</span>,</span><br><span class="line">          <span class="title class_">Validators</span>.<span class="title function_">minLength</span>(<span class="number">4</span>),</span><br><span class="line">        ]</span><br><span class="line">      ]</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">valueChanges</span>.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onValueChange</span>(data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onValueChange</span>(<span class="params">data?: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">formModel</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//檢查是否有錯誤和顯示錯誤訊息</span></span><br><span class="line">    <span class="keyword">const</span> form = <span class="variable language_">this</span>.<span class="property">formModel</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> field <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">formErrors</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">formErrors</span>[field] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">const</span> control = form.<span class="title function_">get</span>(field);</span><br><span class="line">      <span class="keyword">if</span> (control &amp;&amp; control.<span class="property">dirty</span> &amp;&amp; !control.<span class="property">valid</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> messages = <span class="variable language_">this</span>.<span class="property">vaildationMessages</span>[field];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> control.<span class="property">errors</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">formErrors</span>[field] += messages[key] + <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onSubmit</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">valid</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title class_">Post</span>(<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>).<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>web\controller\user\User.py</code>先將資料轉成json來處理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        app.logger.debug(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login get&quot;</span>), <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if request.method == &quot;POST&quot;:</span></span><br><span class="line">    <span class="comment">#     return make_response(jsonify(&quot;用戶登入&quot;), 200) </span></span><br><span class="line">    <span class="comment"># 取值</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment">#app.logger.debug(&quot;POST&quot;)</span></span><br><span class="line">        <span class="comment">#取得JSON的值因為angular是這樣傳值的</span></span><br><span class="line">        data = json.loads(request.data)</span><br><span class="line">        app.logger.debug(data)</span><br><span class="line">        <span class="comment">#req= request.values</span></span><br><span class="line">        login_name = data[<span class="string">&#x27;login_name&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_name&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">        login_pwd = data[<span class="string">&#x27;login_pwd&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_pwd&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        resmsg=<span class="string">&quot;%s-%s&quot;</span> % (login_name,login_pwd)</span><br><span class="line">        app.logger.debug(resmsg)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(resmsg),<span class="number">200</span>)  </span><br></pre></td></tr></table></figure>

<h3 id="網頁參數的判斷"><a href="#網頁參數的判斷" class="headerlink" title="網頁參數的判斷"></a>網頁參數的判斷</h3><p>在<code>web\controller\user\User.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        app.logger.debug(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login get&quot;</span>), <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if request.method == &quot;POST&quot;:</span></span><br><span class="line">    <span class="comment">#     return make_response(jsonify(&quot;用戶登入&quot;), 200) </span></span><br><span class="line">    <span class="comment"># 取值</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment">#app.logger.debug(&quot;POST&quot;)</span></span><br><span class="line">        <span class="comment">#取得JSON的值因為angular是傳json值的</span></span><br><span class="line">        data = json.loads(request.data)</span><br><span class="line">        app.logger.debug(data)</span><br><span class="line">        <span class="comment"># 返回值</span></span><br><span class="line">        resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登錄成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">        login_name = data[<span class="string">&#x27;login_name&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_name&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">        login_pwd = data[<span class="string">&#x27;login_pwd&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_pwd&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        resmsg=<span class="string">&quot;%s-%s&quot;</span> % (login_name,login_pwd)</span><br><span class="line">        app.logger.debug(resmsg)</span><br><span class="line">        <span class="comment"># return make_response(jsonify(resmsg),200)  </span></span><br><span class="line">        <span class="comment"># 檢查參數值</span></span><br><span class="line">        <span class="keyword">if</span> login_name <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_name) &lt; <span class="number">1</span> :</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span></span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄用戶名~~&quot;</span></span><br><span class="line">            app.logger.debug(resp)</span><br><span class="line">            <span class="keyword">return</span> make_response(jsonify(resp))</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> login_pwd <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_pwd) &lt;<span class="number">1</span>:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span></span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄密碼~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> make_response(jsonify(resp),<span class="number">200</span>)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(resmsg),<span class="number">200</span>)  </span><br></pre></td></tr></table></figure>

<h3 id="帳號和密碼的判斷"><a href="#帳號和密碼的判斷" class="headerlink" title="帳號和密碼的判斷"></a>帳號和密碼的判斷</h3><p>先來使用sql來逼立第一個帳號和密碼</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` (`uid`, `nickname`, `mobile`, `email`, `sex`, `avatar`, `login_name`, `login_pwd`, `login_salt`, `status`, `updated_time`, `created_time`)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">	(<span class="number">1</span>, <span class="string">&#x27;正點學院&#x27;</span>, <span class="string">&#x27;11012345679&#x27;</span>, <span class="string">&#x27;apanly@163.com&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;54php&#x27;</span>, <span class="string">&#x27;816440c40b7a9d55ff9eb7b20760862c&#x27;</span>, <span class="string">&#x27;cF3JfH5FJfQ8B2Ba&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;2017-03-15 14:08:48&#x27;</span>, <span class="string">&#x27;2017-03-15 14:08:48&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>他的帳號<code>54php</code>,密碼<code>123456</code></p>
<p>建立加密服務在<code>common\libs\user\UserService.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib,base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span>():</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">genePwd</span>(<span class="params">pwd,salt</span>):</span><br><span class="line">        <span class="comment"># 啟動md5</span></span><br><span class="line">        m= hashlib.md5()</span><br><span class="line">        <span class="built_in">str</span>=<span class="string">&quot;%s-%s&quot;</span>%( base64.encodebytes(pwd.encode(<span class="string">&quot;utf-8&quot;</span>)),salt)</span><br><span class="line">        <span class="comment"># 產生md5</span></span><br><span class="line">        m.update(<span class="built_in">str</span>.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> m.hexdigest()</span><br></pre></td></tr></table></figure>

<p>在<code>web\controller\user\User.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"><span class="keyword">from</span> common.models.User <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> common.libs.user.UserService <span class="keyword">import</span> UserService</span><br><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        app.logger.debug(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login get&quot;</span>), <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if request.method == &quot;POST&quot;:</span></span><br><span class="line">    <span class="comment">#     return make_response(jsonify(&quot;用戶登入&quot;), 200) </span></span><br><span class="line">    <span class="comment"># 取值</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment">#app.logger.debug(&quot;POST&quot;)</span></span><br><span class="line">        <span class="comment">#取得JSON的值因為angular是傳json值的</span></span><br><span class="line">        data = json.loads(request.data)</span><br><span class="line">        app.logger.debug(data)</span><br><span class="line">        <span class="comment"># 返回值</span></span><br><span class="line">        resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登錄成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">        login_name = data[<span class="string">&#x27;login_name&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_name&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">        login_pwd = data[<span class="string">&#x27;login_pwd&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_pwd&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        resmsg=<span class="string">&quot;%s-%s&quot;</span> % (login_name,login_pwd)</span><br><span class="line">        app.logger.debug(resmsg)</span><br><span class="line">        <span class="comment"># return make_response(jsonify(resmsg),200)  </span></span><br><span class="line">        <span class="comment"># 檢查參數值</span></span><br><span class="line">        <span class="keyword">if</span> login_name <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_name) &lt; <span class="number">1</span> :</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span></span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄用戶名~~&quot;</span></span><br><span class="line">            app.logger.debug(resp)</span><br><span class="line">            <span class="keyword">return</span> make_response(jsonify(resp))</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> login_pwd <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_pwd) &lt;<span class="number">1</span>:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span></span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄密碼~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> make_response(jsonify(resp),<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 資料庫相關</span></span><br><span class="line">        user_info = User.query.filter_by( login_name= login_name).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_info:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span></span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的用戶名和密碼-1~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> make_response(jsonify(resp),<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 檢查密碼</span></span><br><span class="line">        <span class="keyword">if</span> user_info.login_pwd != UserService.genePwd(login_pwd,user_info.login_salt):</span><br><span class="line">           resp[<span class="string">&#x27;code&#x27;</span>]=-<span class="number">1</span></span><br><span class="line">           resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的用戶名和密碼-2~~&quot;</span></span><br><span class="line">           <span class="keyword">return</span> make_response(jsonify(resp),<span class="number">200</span>) </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(resmsg),<span class="number">200</span>)  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="建立auth-code"><a href="#建立auth-code" class="headerlink" title="建立auth code"></a>建立auth code</h2><p>在<code>config\base_setting.py</code>中先建立回傳的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SERVER_PORT = <span class="number">5000</span></span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line">SQLALCHEMY_ECHO = <span class="literal">False</span></span><br><span class="line">API_VERSION = <span class="string">&#x27;v0.0&#x27;</span></span><br><span class="line"></span><br><span class="line">AUTH_TOKEN_NAME=<span class="string">&quot;authtoken&quot;</span></span><br></pre></td></tr></table></figure>

<p>在<code>common\libs\user\UserService.py</code>中來產生auth code </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib,base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span>():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 產生auth code</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">geneAuthCode</span>(<span class="params">user_info</span>):</span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        <span class="built_in">str</span> = <span class="string">&quot;%s-%s-%s-%s&quot;</span>%(user_info.uid,user_info.login_name,user_info.login_pwd,user_info.login_salt)</span><br><span class="line">        <span class="comment"># 產生md5</span></span><br><span class="line">        m.update(<span class="built_in">str</span>.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">genePwd</span>(<span class="params">pwd,salt</span>):</span><br><span class="line">        <span class="comment"># 啟動md5</span></span><br><span class="line">        m= hashlib.md5()</span><br><span class="line">        <span class="built_in">str</span>=<span class="string">&quot;%s-%s&quot;</span>%( base64.encodebytes(pwd.encode(<span class="string">&quot;utf-8&quot;</span>)),salt)</span><br><span class="line">        <span class="comment"># 產生md5</span></span><br><span class="line">        m.update(<span class="built_in">str</span>.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> m.hexdigest()</span><br></pre></td></tr></table></figure>

<p>在登入成功後，回傳給client在<code>web\controller\user\User.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"><span class="keyword">from</span> common.models.User <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> common.libs.user.UserService <span class="keyword">import</span> UserService</span><br><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">   	<span class="comment"># ----</span></span><br><span class="line">    <span class="comment"># 取值</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">         	<span class="comment"># ----</span></span><br><span class="line">        <span class="comment"># 返回值</span></span><br><span class="line">        resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登錄成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">        login_name = data[<span class="string">&#x27;login_name&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_name&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">        login_pwd = data[<span class="string">&#x27;login_pwd&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_pwd&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      	<span class="comment"># ----</span></span><br><span class="line">        <span class="comment"># 檢查參數值</span></span><br><span class="line">        <span class="comment"># ----</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 資料庫相關</span></span><br><span class="line">        <span class="comment"># ----</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 檢查密碼</span></span><br><span class="line">        <span class="comment"># ----</span></span><br><span class="line">        <span class="comment"># 登入成功 時，返回 auth code </span></span><br><span class="line">        tokenData=<span class="built_in">dict</span>()</span><br><span class="line">        <span class="comment">#tokenData[&quot;mooc_foo&quot;]=&quot;%s#%s&quot;%(&quot;aaaaa&quot;,user_info.uid)</span></span><br><span class="line">        tokenData[app.config[<span class="string">&quot;AUTH_TOKEN_NAME&quot;</span>]]=<span class="string">&quot;%s#%s&quot;</span>%(UserService.geneAuthCode(user_info),user_info.uid)</span><br><span class="line">        </span><br><span class="line">        resp[<span class="string">&#x27;data&#x27;</span>]=tokenData</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(resp),<span class="number">200</span>)  </span><br></pre></td></tr></table></figure>

<p>在client端的JS將此資料儲在localStorage</p>
<p>在client建立服務<code>src\app\_service\auth\authentication.service.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./../../_models/user-info&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthenticationService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line">  <span class="title function_">loginSuccess</span>(<span class="params">username: <span class="built_in">string</span>, password: <span class="built_in">string</span>, resdata: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(resdata);</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">new</span> <span class="title class_">UserInfo</span>;</span><br><span class="line">    user.<span class="property">login_name</span> = username;</span><br><span class="line">    user.<span class="property">user_token</span> = resdata.<span class="property">data</span>.<span class="property">authtoken</span>;</span><br><span class="line">    <span class="comment">//console.log(user);</span></span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;foodUser&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user));</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在client的login中修改如下</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FormBuilder</span>, <span class="title class_">FormGroup</span>, <span class="title class_">Validators</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/forms&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthenticationService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../_service/auth/authentication.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../_service/user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-login&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./login.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./login.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="comment">//#region form 相關</span></span><br><span class="line">  <span class="attr">formModel</span>: <span class="title class_">FormGroup</span>;</span><br><span class="line">  hide = <span class="literal">true</span>;</span><br><span class="line">  <span class="attr">userInfo</span>: <span class="built_in">any</span> = &#123;&#125;;</span><br><span class="line">  formErrors = &#123;</span><br><span class="line">    <span class="string">&quot;login_name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;login_pwd&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;formError&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  vaildationMessages = &#123;</span><br><span class="line">    <span class="string">&quot;login_name&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: <span class="string">&quot;必須輸入&quot;</span>,</span><br><span class="line">      <span class="string">&quot;minlength&quot;</span>: <span class="string">&quot;請輸入至少要4位&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;login_pwd&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: <span class="string">&quot;密碼必須輸入&quot;</span>,</span><br><span class="line">      <span class="string">&quot;minlength&quot;</span>: <span class="string">&quot;密碼至少要4位&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">//#endregion form 相關</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> fb: FormBuilder,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> router: Router,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> userService: UserService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> authenticationService: AuthenticationService</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">buildForm</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">buildForm</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">formModel</span> = <span class="variable language_">this</span>.<span class="property">fb</span>.<span class="title function_">group</span>(&#123;</span><br><span class="line">      <span class="string">&quot;login_name&quot;</span>: [</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_name</span>,</span><br><span class="line">        [</span><br><span class="line">          <span class="comment">// Validators.required,</span></span><br><span class="line">          <span class="comment">// Validators.minLength(4),</span></span><br><span class="line">        ]</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;login_pwd&quot;</span>: [</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_pwd</span>,</span><br><span class="line">        [</span><br><span class="line">          <span class="comment">// Validators.required,</span></span><br><span class="line">          <span class="comment">// Validators.minLength(4),</span></span><br><span class="line">        ]</span><br><span class="line">      ]</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">valueChanges</span>.<span class="title function_">subscribe</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onValueChange</span>(data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onValueChange</span>(<span class="params">data?: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">formModel</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//檢查是否有錯誤和顯示錯誤訊息</span></span><br><span class="line">    <span class="keyword">const</span> form = <span class="variable language_">this</span>.<span class="property">formModel</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> field <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">formErrors</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">formErrors</span>[field] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">const</span> control = form.<span class="title function_">get</span>(field);</span><br><span class="line">      <span class="keyword">if</span> (control &amp;&amp; control.<span class="property">dirty</span> &amp;&amp; !control.<span class="property">valid</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> messages = <span class="variable language_">this</span>.<span class="property">vaildationMessages</span>[field];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> control.<span class="property">errors</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">formErrors</span>[field] += messages[key] + <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onSubmit</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">valid</span>) &#123;</span><br><span class="line">      <span class="comment">//console.log(this.formModel.value);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userInfo</span> = <span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title class_">Post</span>(<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>).<span class="title function_">subscribe</span>(</span><br><span class="line">        <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="title function_">loginSuccess</span>(<span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_name</span>, <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_pwd</span>, res);</span><br><span class="line">          <span class="comment">//console.log(res);</span></span><br><span class="line">          <span class="keyword">let</span> url = <span class="string">&#x27;/dashboard&#x27;</span>;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">`<span class="subst">$&#123;url&#125;</span>`</span>]);</span><br><span class="line">          <span class="comment">//this.router.navigate([&#x27;&#x27;]);</span></span><br><span class="line">          <span class="comment">//this.router.navigate([&#x27;/dashboard&#x27;]);</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="在client建立回傳值的dialog"><a href="#在client建立回傳值的dialog" class="headerlink" title="在client建立回傳值的dialog"></a>在client建立回傳值的dialog</h2><p>先來建立資料夾<code>src\app\_dialog</code>，在將元件放在此</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g component _dialog/SimpleDialog</span><br></pre></td></tr></table></figure>

<p>加入服務</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g service _services/messagebox/Messagebox</span><br></pre></td></tr></table></figure>

<p>建立ts檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_dialog/message-box.ts</span><br><span class="line">_dialog/message-enums.ts</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\app.module.ts</code>加入對話框</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">entryComponents</span>: [</span><br><span class="line">    <span class="title class_">SimpleDialogComponent</span>,</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\_services\messagebox\messagebox.service.ts</code>中加入部分的回傳值</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialog</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MessageBox</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_dialog/message-box&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MessageBoxButton</span>, <span class="title class_">MessageBoxStyle</span>, <span class="title class_">RespCode</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_dialog/message-enums&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">MessageboxService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialog: MatDialog,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> router: Router,</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line">  <span class="title class_">ResponseErrorMsg</span>(error, message = <span class="string">&#x27;Please login again.&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(&quot;ResponseErrorMsg-&gt;&quot; + error.status);</span></span><br><span class="line">    <span class="keyword">switch</span> (error.<span class="property">status</span>) &#123;</span><br><span class="line">      <span class="comment">// case RespCode.ARGS_ERROR:// = 912,//# 上傳參數錯誤</span></span><br><span class="line">      <span class="comment">//   message = &quot;912 Parameter error&quot;;</span></span><br><span class="line">      <span class="comment">//   MessageBox.show(this.dialog, message);</span></span><br><span class="line">      <span class="comment">//   break;</span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">RespCode</span>.<span class="property">UNDEFINERROR</span>:<span class="comment">// = 999 //# 未定義的錯誤</span></span><br><span class="line">        message = <span class="string">&quot;999 Undefine error&quot;</span>;</span><br><span class="line">        <span class="title class_">MessageBox</span>.<span class="title function_">show</span>(<span class="variable language_">this</span>.<span class="property">dialog</span>, message);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        message = <span class="string">`<span class="subst">$&#123;error.status&#125;</span> <span class="subst">$&#123;error.statusText&#125;</span>`</span>;</span><br><span class="line">        <span class="title class_">MessageBox</span>.<span class="title function_">show</span>(<span class="variable language_">this</span>.<span class="property">dialog</span>, message);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服務器回傳成功訊息顯示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="title class_">SuccessDialog</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> message = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> title = <span class="string">&quot;Info&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> information = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> button = <span class="title class_">MessageBoxButton</span>.<span class="property">Ok</span>;</span><br><span class="line">    <span class="keyword">let</span> allow_outside_click = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> style = <span class="title class_">MessageBoxStyle</span>.<span class="property">Full</span>;</span><br><span class="line">    <span class="keyword">let</span> width = <span class="string">&quot;450px&quot;</span>;</span><br><span class="line">    <span class="title class_">MessageBox</span>.<span class="title function_">show</span>(<span class="variable language_">this</span>.<span class="property">dialog</span>, message, title, information, button, allow_outside_click, style, width);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\login\login.component.ts</code>中修改</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onSubmit</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">valid</span>) &#123;</span><br><span class="line">      <span class="comment">//console.log(this.formModel.value);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userInfo</span> = <span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title class_">Post</span>(<span class="variable language_">this</span>.<span class="property">formModel</span>.<span class="property">value</span>).<span class="title function_">subscribe</span>(</span><br><span class="line">        <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="title function_">loginSuccess</span>(<span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_name</span>, <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">login_pwd</span>, res);</span><br><span class="line">          <span class="comment">//console.log(res);</span></span><br><span class="line">          <span class="keyword">let</span> url = <span class="string">&#x27;/dashboard&#x27;</span>;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">`<span class="subst">$&#123;url&#125;</span>`</span>]);</span><br><span class="line">          <span class="comment">//this.router.navigate([&#x27;&#x27;]);</span></span><br><span class="line">          <span class="comment">//this.router.navigate([&#x27;/dashboard&#x27;]);</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// console.log(&quot;----------------------&quot;);</span></span><br><span class="line">          <span class="comment">// console.log(error);</span></span><br><span class="line">          <span class="comment">// console.log(&quot;----------------------&quot;);</span></span><br><span class="line">          <span class="comment">//this.authenticationService.loginFail(error);</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">messageboxService</span>.<span class="title class_">ResponseErrorMsg</span>(error);</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;/login&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在Python端</p>
<p>在增加回傳碼<code>common\libs\response\RespCode.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RespCode</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    UNDEFINERROR = <span class="number">999</span> <span class="comment"># 未定義的錯誤</span></span><br></pre></td></tr></table></figure>

<p>在<code>web\controller\user\User.py</code>修改一下回傳的方式，有錯誤值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> common.models.User <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> common.libs.user.UserService <span class="keyword">import</span> UserService</span><br><span class="line"><span class="keyword">from</span> common.libs.response.RespCode <span class="keyword">import</span> RespCode</span><br><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        app.logger.debug(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login get&quot;</span>), <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if request.method == &quot;POST&quot;:</span></span><br><span class="line">    <span class="comment">#     return make_response(jsonify(&quot;用戶登入&quot;), 200) </span></span><br><span class="line">    <span class="comment"># 取值</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment">#app.logger.debug(&quot;POST&quot;)</span></span><br><span class="line">        <span class="comment">#取得JSON的值因為angular是傳json值的</span></span><br><span class="line">        data = json.loads(request.data)</span><br><span class="line">        app.logger.debug(data)</span><br><span class="line">        <span class="comment"># 返回值</span></span><br><span class="line">        resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登錄成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">        login_name = data[<span class="string">&#x27;login_name&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_name&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">        login_pwd = data[<span class="string">&#x27;login_pwd&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_pwd&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        resmsg=<span class="string">&quot;%s-%s&quot;</span> % (login_name,login_pwd)</span><br><span class="line">        app.logger.debug(resmsg)</span><br><span class="line">        <span class="comment"># return make_response(jsonify(resmsg),200)  </span></span><br><span class="line">        <span class="comment"># 檢查參數值</span></span><br><span class="line">        <span class="keyword">if</span> login_name <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_name) &lt; <span class="number">1</span> :</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄用戶名~~&quot;</span></span><br><span class="line">            app.logger.debug(resp)</span><br><span class="line">            <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> login_pwd <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_pwd) &lt;<span class="number">1</span>:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄密碼~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 資料庫相關</span></span><br><span class="line">        user_info = User.query.filter_by( login_name= login_name).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_info:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的用戶名和密碼-1~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 檢查密碼</span></span><br><span class="line">        <span class="keyword">if</span> user_info.login_pwd != UserService.genePwd(login_pwd,user_info.login_salt):</span><br><span class="line">           resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">           resp[<span class="string">&#x27;msg&#x27;</span>] =<span class="string">&quot;請輸入正確的用戶名和密碼-2~~&quot;</span></span><br><span class="line">           <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line">        <span class="comment"># 登入成功 時，返回 auth code </span></span><br><span class="line">        tokenData=<span class="built_in">dict</span>()</span><br><span class="line">        <span class="comment">#tokenData[&quot;mooc_foo&quot;]=&quot;%s#%s&quot;%(&quot;aaaaa&quot;,user_info.uid)</span></span><br><span class="line">        tokenData[app.config[<span class="string">&quot;AUTH_TOKEN_NAME&quot;</span>]]=<span class="string">&quot;%s#%s&quot;</span>%(UserService.geneAuthCode(user_info),user_info.uid)</span><br><span class="line">        </span><br><span class="line">        resp[<span class="string">&#x27;data&#x27;</span>]=tokenData</span><br><span class="line">        <span class="comment">#return make_response(jsonify(resp),200)  </span></span><br><span class="line">        <span class="keyword">return</span> jsonify(resp)  </span><br></pre></td></tr></table></figure>

<h2 id="攔劫器"><a href="#攔劫器" class="headerlink" title="攔劫器"></a>攔劫器</h2><p>這是為了判斷使用者是不是合法的登入，在client端和server端都要來判斷</p>
<h3 id="client端"><a href="#client端" class="headerlink" title="client端"></a>client端</h3><p>在每次傳送時，要將authkey代入，傳給server端，來檢查是否可以來進行操作</p>
<p>加入攔劫器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g interceptor _helpers/HttpConfig --flat</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\_helpers\httpconfig.interceptor.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">HttpRequest</span>,</span><br><span class="line">  <span class="title class_">HttpHandler</span>,</span><br><span class="line">  <span class="title class_">HttpEvent</span>,</span><br><span class="line">  <span class="title class_">HttpInterceptor</span>,</span><br><span class="line">  <span class="title class_">HttpResponse</span>,</span><br><span class="line">  <span class="title class_">HttpErrorResponse</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span>, throwError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map, catchError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthenticationService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../_service/auth/authentication.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HttpConfigInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HttpInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> authenticationService: AuthenticationService</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">intercept</span>(<span class="attr">request</span>: <span class="title class_">HttpRequest</span>&lt;<span class="built_in">unknown</span>&gt;, <span class="attr">next</span>: <span class="title class_">HttpHandler</span>): <span class="title class_">Observable</span>&lt;<span class="title class_">HttpEvent</span>&lt;<span class="built_in">unknown</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">//有token</span></span><br><span class="line">    <span class="comment">// add authorization header with basic auth credentials if available</span></span><br><span class="line">    <span class="keyword">const</span> currentUser = <span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="property">currentUserValue</span>;</span><br><span class="line">    <span class="keyword">if</span> (currentUser) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">token</span>: <span class="built_in">string</span> = currentUser.<span class="property">user_token</span>;</span><br><span class="line">      <span class="keyword">if</span> (token) &#123;</span><br><span class="line">        request = request.<span class="title function_">clone</span>(&#123; <span class="attr">headers</span>: request.<span class="property">headers</span>.<span class="title function_">set</span>(<span class="string">&#x27;Authorization&#x27;</span>, token) &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if (!request.headers.has(&#x27;Content-Type&#x27;)) &#123;</span></span><br><span class="line">    <span class="comment">//   request = request.clone(&#123; headers: request.headers.set(&#x27;Content-Type&#x27;, &#x27;application/json&#x27;) &#125;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//request = request.clone(&#123; headers: request.headers.set(&#x27;Accept&#x27;, &#x27;application/json&#x27;) &#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next.<span class="title function_">handle</span>(request).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">map</span>(<span class="function">(<span class="params">event: HttpEvent&lt;<span class="built_in">any</span>&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> <span class="title class_">HttpResponse</span>) &#123;</span><br><span class="line">          <span class="comment">//console.log(&#x27;event---&gt;&gt;&gt;&#x27;, event);</span></span><br><span class="line">          <span class="comment">// this.errorDialogService.openDialog(event);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> event;</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="title function_">catchError</span>(<span class="function">(<span class="params">error: HttpErrorResponse</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> data = &#123;&#125;;</span><br><span class="line">        data = &#123;</span><br><span class="line">          <span class="attr">reason</span>: error &amp;&amp; error.<span class="property">error</span> &amp;&amp; error.<span class="property">error</span>.<span class="property">reason</span> ? error.<span class="property">error</span>.<span class="property">reason</span> : <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">          <span class="attr">status</span>: error.<span class="property">status</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//this.errorDialogService.openDialog(data);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">throwError</span>(error);</span><br><span class="line">      &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在未認證的清況下，可以在client端的dashboard中使用api</p>
<p>在<code>web\controller\user\User.py</code>中加入測試的API</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint,request,make_response,jsonify</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> common.models.User <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> common.libs.user.UserService <span class="keyword">import</span> UserService</span><br><span class="line"><span class="keyword">from</span> common.libs.response.RespCode <span class="keyword">import</span> RespCode</span><br><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line">router_user = Blueprint(<span class="string">&#x27;user_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 目前login方法用不到</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        app.logger.debug(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> make_response(jsonify(<span class="string">&quot;login get&quot;</span>), <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if request.method == &quot;POST&quot;:</span></span><br><span class="line">    <span class="comment">#     return make_response(jsonify(&quot;用戶登入&quot;), 200) </span></span><br><span class="line">    <span class="comment"># 取值</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="comment">#app.logger.debug(&quot;POST&quot;)</span></span><br><span class="line">        <span class="comment">#取得JSON的值因為angular是傳json值的</span></span><br><span class="line">        data = json.loads(request.data)</span><br><span class="line">        app.logger.debug(data)</span><br><span class="line">        <span class="comment"># 返回值</span></span><br><span class="line">        resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登錄成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">        login_name = data[<span class="string">&#x27;login_name&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_name&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line">        login_pwd = data[<span class="string">&#x27;login_pwd&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;login_pwd&#x27;</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        resmsg=<span class="string">&quot;%s-%s&quot;</span> % (login_name,login_pwd)</span><br><span class="line">        app.logger.debug(resmsg)</span><br><span class="line">        <span class="comment"># return make_response(jsonify(resmsg),200)  </span></span><br><span class="line">        <span class="comment"># 檢查參數值</span></span><br><span class="line">        <span class="keyword">if</span> login_name <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_name) &lt; <span class="number">1</span> :</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄用戶名~~&quot;</span></span><br><span class="line">            app.logger.debug(resp)</span><br><span class="line">            <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> login_pwd <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(login_pwd) &lt;<span class="number">1</span>:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的登錄密碼~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 資料庫相關</span></span><br><span class="line">        user_info = User.query.filter_by( login_name= login_name).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_info:</span><br><span class="line">            resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">            resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;請輸入正確的用戶名和密碼-1~~&quot;</span></span><br><span class="line">            <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 檢查密碼</span></span><br><span class="line">        <span class="keyword">if</span> user_info.login_pwd != UserService.genePwd(login_pwd,user_info.login_salt):</span><br><span class="line">           resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.UNDEFINERROR</span><br><span class="line">           resp[<span class="string">&#x27;msg&#x27;</span>] =<span class="string">&quot;請輸入正確的用戶名和密碼-2~~&quot;</span></span><br><span class="line">           <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line">        <span class="comment"># 登入成功 時，返回 auth code </span></span><br><span class="line">        tokenData=<span class="built_in">dict</span>()</span><br><span class="line">        <span class="comment">#tokenData[&quot;mooc_foo&quot;]=&quot;%s#%s&quot;%(&quot;aaaaa&quot;,user_info.uid)</span></span><br><span class="line">        tokenData[app.config[<span class="string">&quot;AUTH_TOKEN_NAME&quot;</span>]]=<span class="string">&quot;%s#%s&quot;</span>%(UserService.geneAuthCode(user_info),user_info.uid)</span><br><span class="line">        </span><br><span class="line">        resp[<span class="string">&#x27;data&#x27;</span>]=tokenData</span><br><span class="line">        <span class="comment">#return make_response(jsonify(resp),200)  </span></span><br><span class="line">        <span class="keyword">return</span> jsonify(resp)  </span><br><span class="line"></span><br><span class="line"><span class="meta">@router_user.route(<span class="params"><span class="string">&quot;/example&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">userexample</span>():</span><br><span class="line">    <span class="comment"># 返回值</span></span><br><span class="line">    resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;測試成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">    <span class="keyword">return</span> jsonify(resp)  </span><br></pre></td></tr></table></figure>

<p>在<code>src\app\_service\user.service.ts</code>中加入服務的API</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; environment &#125; <span class="keyword">from</span> <span class="string">&#x27;src/environments/environment&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">  api = <span class="string">`<span class="subst">$&#123;environment.apiUrl&#125;</span>/user/login`</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient</span>) &#123; &#125;</span><br><span class="line">  <span class="title class_">Gets</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="built_in">any</span>&gt;(<span class="variable language_">this</span>.<span class="property">api</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Post</span>(data) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">post</span>&lt;<span class="built_in">any</span>&gt;(<span class="variable language_">this</span>.<span class="property">api</span>, data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">example</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> url = <span class="string">`<span class="subst">$&#123;environment.apiUrl&#125;</span>/user/example`</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="property">get</span>&lt;<span class="built_in">any</span>&gt;(url);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src\app\pages\dashboard\dashboard.component.ts</code>中來呼叫</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_service/user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-dashboard&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./dashboard.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./dashboard.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DashboardComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> userService: UserService,</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">example</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在服務端要檢查，所以加入攔劫器<code>web\interceptors\AuthInterceptor.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">before_request</span>():</span><br><span class="line">    path= request.path</span><br><span class="line">    check_login()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">判斷用戶是否已經登錄</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_login</span>():</span><br><span class="line">    <span class="comment">#app.logger.info(&quot;headers=&#123;&#125;&quot;.format(request.headers))  </span></span><br><span class="line">    token = request.headers.get(<span class="string">&#x27;Authorization&#x27;</span>)</span><br><span class="line">    app.logger.info(<span class="string">&quot;token=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(token))    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>www.py</code>中來調用它</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line">#註冊攔劫器</span><br><span class="line"><span class="keyword">from</span> web.<span class="property">interceptors</span>.<span class="property">AuthInterceptor</span> <span class="keyword">import</span> *</span><br><span class="line">#註冊攔劫器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#藍圖功能，對所有的url進行藍圖功能配置</span><br><span class="line"><span class="keyword">from</span> web.<span class="property">controller</span>.<span class="property">index</span> <span class="keyword">import</span> router_index</span><br><span class="line"><span class="keyword">from</span> web.<span class="property">controller</span>.<span class="property">user</span>.<span class="property">User</span> <span class="keyword">import</span> router_user</span><br><span class="line">#app.<span class="title function_">register_blueprint</span>(router_index,url_prefix=<span class="string">&quot;/&quot;</span>)</span><br><span class="line">#app.<span class="title function_">register_blueprint</span>(router_user,url_prefix = <span class="string">&quot;/v0.0/user&quot;</span>)</span><br><span class="line">app.<span class="title function_">register_blueprint</span>(router_index,url_prefix=<span class="string">&#x27;/&#123;0&#125;/&#x27;</span>.<span class="title function_">format</span>(app.<span class="property">config</span>[<span class="string">&#x27;API_VERSION&#x27;</span>]))</span><br><span class="line">app.<span class="title function_">register_blueprint</span>(router_user,url_prefix=<span class="string">&#x27;/&#123;0&#125;/user&#x27;</span>.<span class="title function_">format</span>(app.<span class="property">config</span>[<span class="string">&#x27;API_VERSION&#x27;</span>]))</span><br><span class="line">#藍圖功能，對所有的url進行藍圖功能配置</span><br></pre></td></tr></table></figure>

<p>在client端配置好，可以在debug 訊息中看到取到token</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2020-12-11 02:55:00,312] INFO <span class="keyword">in</span> AuthInterceptor: token=c51aec6a2f71ea77208bf7bad53da850<span class="comment">#1</span></span><br><span class="line">127.0.0.1 - - [11/Dec/2020 02:55:00] <span class="string">&quot;GET /v0.0/user/example HTTP/1.0&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<h3 id="否是需要檢查登入"><a href="#否是需要檢查登入" class="headerlink" title="否是需要檢查登入"></a>否是需要檢查登入</h3><p>有些網址不需要檢查是否已登入，例如登入的網址</p>
<p>加入不用檢查的網址在<code>config\base_setting.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SERVER_PORT = <span class="number">5000</span></span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line">SQLALCHEMY_ECHO = <span class="literal">False</span></span><br><span class="line">API_VERSION = <span class="string">&#x27;v0.0&#x27;</span></span><br><span class="line"></span><br><span class="line">AUTH_TOKEN_NAME=<span class="string">&quot;authtoken&quot;</span></span><br><span class="line"><span class="comment"># 過濾url</span></span><br><span class="line">IGNORE_URLS=[</span><br><span class="line">    <span class="string">&quot;^/&#123;0&#125;/user/login&quot;</span>.<span class="built_in">format</span>(API_VERSION),</span><br><span class="line">]</span><br><span class="line">IGNORE_CHECK_LOGIN_URLS=[</span><br><span class="line">    <span class="string">&quot;^/favicon.ico&quot;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="comment"># 過濾url</span></span><br></pre></td></tr></table></figure>

<p>在<code>web\interceptors\AuthInterceptor.py</code>來判斷</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> common.models.User <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> common.libs.user.UserService <span class="keyword">import</span> UserService</span><br><span class="line"><span class="keyword">from</span> common.libs.response.RespCode <span class="keyword">import</span> RespCode</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">before_request</span>():</span><br><span class="line">    path= request.path</span><br><span class="line">    <span class="comment"># 返回值</span></span><br><span class="line">    resp =&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">200</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登錄成功&#x27;</span>,<span class="string">&#x27;data&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#不用檢查</span></span><br><span class="line">    ignore_urls= app.config[<span class="string">&#x27;IGNORE_URLS&#x27;</span>]</span><br><span class="line">    ignore_check_login_urls=app.config[<span class="string">&#x27;IGNORE_CHECK_LOGIN_URLS&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    pattern=re.<span class="built_in">compile</span>(<span class="string">&#x27;%s&#x27;</span> % <span class="string">&quot;|&quot;</span>.join(ignore_check_login_urls))</span><br><span class="line">    <span class="keyword">if</span> pattern.<span class="keyword">match</span>(path):</span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">   </span><br><span class="line">    user_info=check_login()</span><br><span class="line"></span><br><span class="line">    pattern=re.<span class="built_in">compile</span>(<span class="string">&#x27;%s&#x27;</span> % <span class="string">&quot;|&quot;</span>.join(ignore_urls))</span><br><span class="line">    <span class="comment">#app.logger.info(&quot;pattern=&#123;&#125;&quot;.format(pattern)) </span></span><br><span class="line">    <span class="comment">#app.logger.info(&quot;path=&#123;&#125;&quot;.format(path)) </span></span><br><span class="line">    <span class="keyword">if</span> pattern.<span class="keyword">match</span>(path):</span><br><span class="line">        <span class="comment">#app.logger.info(&quot;match=&#123;&#125;&quot;.format(ignore_urls)) </span></span><br><span class="line">        <span class="comment">#return resp[&#x27;msg&#x27;],resp[&#x27;code&#x27;]  </span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_info:</span><br><span class="line">       resp[<span class="string">&#x27;code&#x27;</span>]=RespCode.TOKEN_ERROR</span><br><span class="line">       resp[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;Token 無法解析&quot;</span></span><br><span class="line">       <span class="keyword">return</span> resp[<span class="string">&#x27;msg&#x27;</span>],resp[<span class="string">&#x27;code&#x27;</span>]  </span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">判斷用戶是否已經登錄</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_login</span>():</span><br><span class="line">    <span class="comment">#app.logger.info(&quot;headers=&#123;&#125;&quot;.format(request.headers))  </span></span><br><span class="line">    token_info = request.headers.get(<span class="string">&#x27;Authorization&#x27;</span>)</span><br><span class="line">    <span class="comment">#app.logger.info(&quot;token=&#123;&#125;&quot;.format(token)) </span></span><br><span class="line">    <span class="keyword">if</span> token_info <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>   </span><br><span class="line"></span><br><span class="line">    auth_info = token_info.split(<span class="string">&quot;#&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(auth_info) !=<span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user_info=User.query.filter_by( uid=auth_info[<span class="number">1</span>]).first()    </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        app.logger.error(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> user_info <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> auth_info[<span class="number">0</span>] != UserService.geneAuthCode(user_info):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> user_info        </span><br></pre></td></tr></table></figure>

<p>在client加入header和sidebar來登出在header</p>
<p>直接刪除localstorage在<code>src\app\pages\dashboard\header\header.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">EventEmitter</span>, <span class="title class_">OnInit</span>, <span class="title class_">Output</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MatDialog</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/material/dialog&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MessageBox</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_dialog/message-box&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MessageBoxButton</span>, <span class="title class_">MessageBoxStyle</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_dialog/message-enums&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthenticationService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_service/auth/authentication.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; isNullOrUndefined &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_util/custutil&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; environment &#125; <span class="keyword">from</span> <span class="string">&#x27;src/environments/environment&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-header&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./header.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./header.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HeaderComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="meta">@Output</span>() toggle = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>&lt;<span class="built_in">void</span>&gt;();</span><br><span class="line">  <span class="attr">isLoggedIn$</span>: <span class="title class_">Observable</span>&lt;<span class="built_in">boolean</span>&gt;;</span><br><span class="line">  <span class="attr">login_name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialog: MatDialog,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> router: Router,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> authenticationService: AuthenticationService</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoggedIn$</span> = <span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="title function_">isLoggedIn</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (environment.<span class="property">debug</span> != <span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_">isNullOrUndefined</span>(<span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="property">currentUserValue</span>)) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">login_name</span> = <span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="property">currentUserValue</span>.<span class="property">login_name</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">toggle</span>.<span class="title function_">emit</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(&quot;logout&quot;);</span></span><br><span class="line">    <span class="keyword">let</span> message = <span class="string">&quot;Are you sure logout?&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> title = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> information = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> button = <span class="title class_">MessageBoxButton</span>.<span class="property">YesNo</span>;</span><br><span class="line">    <span class="keyword">let</span> allow_outside_click = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> style = <span class="title class_">MessageBoxStyle</span>.<span class="property">Simple</span>;</span><br><span class="line">    <span class="keyword">let</span> width = <span class="string">&quot;450px&quot;</span>;</span><br><span class="line">    <span class="title class_">MessageBox</span>.<span class="title function_">show</span>(<span class="variable language_">this</span>.<span class="property">dialog</span>, message, title, information, button, allow_outside_click, style, width).<span class="title function_">subscribe</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(res);</span></span><br><span class="line">      <span class="keyword">if</span> (res.<span class="property">result</span> == <span class="string">&quot;yes&quot;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">authenticationService</span>.<span class="title function_">logout</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">router</span>.<span class="title function_">navigate</span>([<span class="string">&#x27;/login&#x27;</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// let respone = &quot;respones value=&quot; + res;</span></span><br><span class="line">      <span class="comment">// MessageBox.show(this.dialog, `The result is : $&#123;respone&#125;`);</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="查看Python的路徑"><a href="#查看Python的路徑" class="headerlink" title="查看Python的路徑"></a>查看Python的路徑</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install dialog</span><br><span class="line"></span><br><span class="line">sudo apt-get -y install git build-essential libpcre3 libpcre3-dev openssl zlib1g-dev cmake clang libclang-dev zlib1g-dev </span><br><span class="line">sudo apt-get -y install python3 python3-pip python3-dev python-dev python3-lxml libxml2-dev libxslt1-dev libffi-dev</span><br><span class="line"></span><br><span class="line">sudo pip3 install --upgrade pip</span><br><span class="line">sudo pip3 install virtualenv uwsgi flask Flask-HTTPAuth gevent zmq pillow qrcode pydes numpy psutil msgpack pytz</span><br><span class="line"></span><br><span class="line">sudo apt-get -y install default-libmysqlclient-dev software-properties-common</span><br><span class="line">sudo pip3 install mysqlclient SQLAlchemy flask-sqlalchemy flask_marshmallow marshmallow-sqlalchemy</span><br></pre></td></tr></table></figure>

<p>可以查看python的模組放在那個路徑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 -m site</span><br><span class="line">pip3 show flask</span><br></pre></td></tr></table></figure>

<h1 id="安裝uwsgi"><a href="#安裝uwsgi" class="headerlink" title="安裝uwsgi"></a>安裝uwsgi</h1><p>安裝 C 及 Python 開發工具</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential python-dev python-pip</span><br></pre></td></tr></table></figure>

<p>安裝 uwsgi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 install flask SQLAlchemy flask-sqlalchemy mysqlclient flask_script</span><br><span class="line">sudo pip3 install uwsgi</span><br><span class="line">sudo pip3 install gevent</span><br></pre></td></tr></table></figure>

<p>建立 uwsgi-hello.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">application</span>(<span class="params">env, start_response</span>):</span><br><span class="line">    start_response(<span class="string">&#x27;200 OK&#x27;</span>, [(<span class="string">&#x27;Content-Type&#x27;</span>,<span class="string">&#x27;text/html&#x27;</span>)])</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">b&quot;Hello World via uWSGI&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>執行 uWSGI, 作為 HTTP server&#x2F;router, 把 request pass 給 WSGI application uwsgi-hello.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uwsgi --http :9090 --wsgi-file uwsgi-hello.py</span><br></pre></td></tr></table></figure>

<p>使用chrom <a href="http://192.168.83.128:9090/">http://192.168.83.128:9090/</a></p>
<p>配置uwsgi</p>
<p>將程式連接到<code>/usr/share/nginx</code>下面來建立連結<code>sudo ln -s /home/ttom/www/order/ /usr/share/nginx/wa0_0</code>這是API的資料夾</p>
<p>建立服務</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/systemd/system/uwsgi.service</span><br></pre></td></tr></table></figure>

<p>內容</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=uWSGI Emperor <span class="number">0.5</span></span><br><span class="line"><span class="attr">After</span>=syslog.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="comment">#設定檔的位置</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/uwsgi --emperor /usr/share/nginx/wa<span class="number">0_0</span>/config/vassals --uid www-data --gid www-data</span><br><span class="line"><span class="comment"># Requires systemd version 211 or newer</span></span><br><span class="line"><span class="attr">RuntimeDirectory</span>=uwsgi</span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"><span class="attr">KillSignal</span>=SIGQUIT</span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">StandardError</span>=syslog</span><br><span class="line"><span class="attr">NotifyAccess</span>=all</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建立uwsgi設定檔在<code>config\vassals\config.ini</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[uwsgi]</span></span><br><span class="line"><span class="comment">#API程式的路徑</span></span><br><span class="line"><span class="attr">chdir</span> = /usr/share/nginx/wa<span class="number">0_0</span></span><br><span class="line"><span class="comment">#python的環境</span></span><br><span class="line"><span class="comment">#home=/usr/share/python3</span></span><br><span class="line"><span class="attr">module</span> = manage</span><br><span class="line"><span class="attr">callable</span> = app</span><br><span class="line"><span class="attr">master</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment">#processes = 4</span></span><br><span class="line"><span class="attr">processes</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">enable-threads</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">http-websockets</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">gevent-monkey-patch</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">gevent</span> = <span class="number">1024</span></span><br><span class="line"><span class="attr">py-autoreload</span> = <span class="number">3</span>     <span class="comment">#Release時要拿掉</span></span><br><span class="line"></span><br><span class="line"><span class="attr">chmod-socket</span> = <span class="number">660</span></span><br><span class="line"><span class="comment">#chown-socket = www-data:www-data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">uid</span> = www-data</span><br><span class="line"><span class="attr">gid</span> = www-data</span><br><span class="line"><span class="attr">vacuum</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">die-on-term</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment">#stats = 127.0.0.1:5000</span></span><br><span class="line"><span class="comment">#http = 0.0.0.0:5000</span></span><br><span class="line"><span class="attr">socket</span> = /tmp/app<span class="number">0_0</span>.sock</span><br><span class="line"><span class="comment">#daemonize=/var/log/uwsgi/uwsgi.log</span></span><br><span class="line"></span><br><span class="line"><span class="attr">post-buffering</span> = <span class="number">16384</span>    <span class="comment">#沒這行會一直有502錯誤</span></span><br><span class="line"><span class="attr">buffer-size</span> = <span class="number">131072</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#開啟log</span></span><br><span class="line"><span class="attr">log-maxsize</span> = <span class="number">5000000</span></span><br><span class="line"><span class="attr">logto</span> = /tmp/uwsgi_0.<span class="number">0</span>.log</span><br><span class="line"><span class="attr">log-master</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">threaded-log</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#要Debug才能開啟</span></span><br><span class="line"><span class="attr">catch-exceptions</span> = <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在linux的命令行中，加入系統變數</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -H vim /etc/environment</span><br><span class="line">ops_config=&quot;local&quot;</span><br></pre></td></tr></table></figure>

<p>在配置中的環境是不一樣的,登出和登入don’t forget to logout and login again to enable the environment variables.</p>
<p>目前無作用</p>
<h1 id="WebSocket相關"><a href="#WebSocket相關" class="headerlink" title="WebSocket相關"></a>WebSocket相關</h1><h2 id="使用Flask-Sockets-測試上問題"><a href="#使用Flask-Sockets-測試上問題" class="headerlink" title="使用Flask-Sockets(測試上問題)"></a>使用Flask-Sockets(測試上問題)</h2><p>最後在接上uwsgi和nginx時無法收到websocket的資訊</p>
<p>參考</p>
<p><a href="https://github.com/heroku-python/flask-sockets">https://github.com/heroku-python/flask-sockets</a></p>
<p>安裝</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 install Flask-Sockets</span><br></pre></td></tr></table></figure>

<p>在server端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Blueprint</span><br><span class="line"><span class="keyword">from</span> flask_sockets <span class="keyword">import</span> Sockets</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">html = Blueprint(<span class="string">r&#x27;html&#x27;</span>, __name__)</span><br><span class="line">ws = Blueprint(<span class="string">r&#x27;ws&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@html.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    now = datetime.datetime.now().isoformat()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World! &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(now)</span><br><span class="line"></span><br><span class="line"><span class="meta">@ws.route(<span class="params"><span class="string">&#x27;/echo&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">echo_socket</span>(<span class="params">socket</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> socket.closed:</span><br><span class="line">        message = socket.receive()</span><br><span class="line">        now = datetime.datetime.now().isoformat()</span><br><span class="line">        sendmsg=message+<span class="string">&#x27; &#x27;</span>+now</span><br><span class="line">        socket.send(sendmsg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">sockets = Sockets(app)</span><br><span class="line"></span><br><span class="line">app.register_blueprint(html, url_prefix=<span class="string">r&#x27;/&#x27;</span>)</span><br><span class="line">sockets.register_blueprint(ws, url_prefix=<span class="string">r&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">from</span> gevent <span class="keyword">import</span> pywsgi</span><br><span class="line">    <span class="keyword">from</span> geventwebsocket.handler <span class="keyword">import</span> WebSocketHandler</span><br><span class="line">    server = pywsgi.WSGIServer((<span class="string">&#x27;&#x27;</span>, <span class="number">5000</span>), app, handler_class=WebSocketHandler)</span><br><span class="line">    server.serve_forever()</span><br></pre></td></tr></table></figure>

<p>在client端<code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- message form --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;publish&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Send&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- div with messages --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&#x27;./index.js&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用 WebSocket 的網址向 Server 開啟連結</span></span><br><span class="line"><span class="keyword">let</span> ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&#x27;ws://192.168.83.128:5000/echo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//開啟後執行的動作，指定一個 function 會在連結 WebSocket 後執行</span></span><br><span class="line">ws.<span class="property">onopen</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;open connection&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//關閉後執行的動作，指定一個 function 會在連結中斷後執行</span></span><br><span class="line">ws.<span class="property">onclose</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Closed connect=<span class="subst">$&#123;event.code&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接收 Server 發送的訊息</span></span><br><span class="line">ws.<span class="property">onmessage</span> = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(event)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(event.<span class="property">data</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// send message from the form</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">forms</span>.<span class="property">publish</span>.<span class="property">onsubmit</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> outgoingMessage = <span class="variable language_">this</span>.<span class="property">message</span>.<span class="property">value</span>;</span><br><span class="line"></span><br><span class="line">    ws.<span class="title function_">send</span>(outgoingMessage);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><a href="https://blog.csdn.net/z_ipython/article/details/99305623">https://blog.csdn.net/z_ipython/article/details/99305623</a></p>
<p>在<code>manage.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> application <span class="keyword">import</span> app,manager</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Server</span><br><span class="line"><span class="keyword">import</span> www <span class="comment">#引入</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## web server</span></span><br><span class="line"><span class="comment">#manager.add_command(&quot;runserver&quot;,Server(host=&#x27;0.0.0.0&#x27;,port=app.config[&#x27;SERVER_PORT&#x27;],use_debugger=True,use_reloader=True))</span></span><br><span class="line"><span class="comment">#manager.add_command(&quot;runserver&quot;,runserver_gevent)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="meta">@manager.command </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">runserver</span>():</span><br><span class="line">    <span class="keyword">from</span> gevent <span class="keyword">import</span> pywsgi</span><br><span class="line">    <span class="keyword">from</span> geventwebsocket.handler <span class="keyword">import</span> WebSocketHandler</span><br><span class="line">    <span class="keyword">import</span> logging</span><br><span class="line">    logging.basicConfig(level=logging.DEBUG)</span><br><span class="line">    app.debug = <span class="literal">True</span></span><br><span class="line">    server = pywsgi.WSGIServer((<span class="string">&#x27;&#x27;</span>, <span class="number">5000</span>),application=app, handler_class=WebSocketHandler,log=app.logger)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">         server.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> (KeyboardInterrupt, SystemExit):</span><br><span class="line">        <span class="keyword">if</span> server.started:</span><br><span class="line">            server.stop()</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">#app.run(host=&#x27;0.0.0.0&#x27;,debug=&#x27;True&#x27;)</span></span><br><span class="line">    <span class="comment">#app.run(debug=&#x27;True&#x27;)</span></span><br><span class="line">    <span class="comment">#from gevent import pywsgi</span></span><br><span class="line">    <span class="comment">#from geventwebsocket.handler import WebSocketHandler</span></span><br><span class="line">    <span class="comment">#server = pywsgi.WSGIServer((&#x27;0.0.0.0&#x27;, 8540), manager, handler_class=WebSocketHandler)</span></span><br><span class="line">    manager.run()</span><br><span class="line">    <span class="comment">#server.serve_forever()</span></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        sys.exit(main())</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc()</span><br></pre></td></tr></table></figure>

<p>在<code>web\controller\wsocket\wsocket.py</code>建立服務</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">router_websocket = Blueprint(<span class="string">&#x27;websocket_page&#x27;</span>,__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@router_websocket.route(<span class="params"><span class="string">&quot;/echo&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">echo_socket</span>(<span class="params">socket</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> socket.closed:</span><br><span class="line">        msg = socket.receive()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;i received:<span class="subst">&#123;msg&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="comment"># message = socket.receive()</span></span><br><span class="line">        <span class="comment"># print(message)</span></span><br><span class="line">        <span class="keyword">if</span> msg:</span><br><span class="line">            now = datetime.datetime.now()</span><br><span class="line">            sendmsg=<span class="string">&#x27;&#123;&#125; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(msg,now)</span><br><span class="line">            socket.send(sendmsg)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;i sent:<span class="subst">&#123;sendmsg&#125;</span>&#x27;</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<p>測試用聊天室</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng new ngchat</span><br></pre></td></tr></table></figure>

<p>參考資料</p>
<p><a href="https://blog.csdn.net/diaolouan9546/article/details/101492264?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control">https://blog.csdn.net/diaolouan9546/article/details/101492264?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control</a></p>
<p>聊天室，有姓名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ng g component muc_nick</span><br><span class="line">ng g service muc-nick/_service/Chat</span><br></pre></td></tr></table></figure>

<p><code>src\app\muc-nick\_service\chat.service.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Subject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WebsocketService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/app/_service/websocket.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CHAT_URL</span> = <span class="string">&#x27;ws://192.168.83.128:5000/v0.0/ws/echo&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">  <span class="attr">author</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">message</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ChatService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="attr">messages</span>: <span class="title class_">Subject</span>&lt;<span class="title class_">Message</span>&gt;;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">websocketService: WebsocketService</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">messages</span> = &lt;<span class="title class_">Subject</span>&lt;<span class="title class_">Message</span>&gt;&gt;websocketService</span><br><span class="line">      .<span class="title function_">connect</span>(<span class="variable constant_">CHAT_URL</span>)</span><br><span class="line">      .<span class="title function_">pipe</span>(<span class="title function_">map</span>((<span class="attr">response</span>: <span class="title class_">MessageEvent</span>): <span class="function"><span class="params">Message</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(response.<span class="property">data</span>);</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">author</span>: data.<span class="property">author</span>,</span><br><span class="line">          <span class="attr">message</span>: data.<span class="property">message</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>src\app\muc-nick\muc-nick.component.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>用戶聊天nickname<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>請nickname：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;nickname1&quot;</span> #<span class="attr">nickname</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;chat_room&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>請輸入聊天內容：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> #<span class="attr">msg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;send&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;send()&quot;</span>&gt;</span>發送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> #<span class="attr">chat_content</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let item of messagelist&quot;</span>&gt;</span></span><br><span class="line">      &#123;&#123;item.author&#125;&#125; -&gt;&#123;&#123;item.message&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>src\app\muc-nick\muc-nick.component.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, <span class="title class_">ElementRef</span>, <span class="title class_">OnInit</span>, <span class="title class_">ViewChild</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ChatService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../muc-nonick/_service/chat.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;muc-nick&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./muc-nick.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./muc-nick.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">MucNickComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ViewChild</span>(<span class="string">&#x27;nickname&#x27;</span>, &#123; <span class="attr">static</span>: <span class="literal">true</span> &#125;) <span class="attr">nickname</span>: <span class="title class_">ElementRef</span>;</span><br><span class="line">  <span class="meta">@ViewChild</span>(<span class="string">&#x27;msg&#x27;</span>, &#123; <span class="attr">static</span>: <span class="literal">true</span> &#125;) <span class="attr">msg</span>: <span class="title class_">ElementRef</span>;</span><br><span class="line">  messagelist = [];</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> chatService: ChatService</span>) &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chatService</span>.<span class="property">messages</span>.<span class="title function_">subscribe</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(&quot;Response from websocket: &quot; + msg);</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">messagelist</span>.<span class="title function_">push</span>(msg);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">send</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sendmsg = &#123;</span><br><span class="line">      <span class="attr">author</span>: <span class="string">&#x27;tutorialedge&#x27;</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;this is a test message&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//console.log(this.msg.nativeElement.value);</span></span><br><span class="line">    sendmsg.<span class="property">author</span> = <span class="variable language_">this</span>.<span class="property">nickname</span>.<span class="property">nativeElement</span>.<span class="property">value</span>;</span><br><span class="line">    sendmsg.<span class="property">message</span> = <span class="variable language_">this</span>.<span class="property">msg</span>.<span class="property">nativeElement</span>.<span class="property">value</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chatService</span>.<span class="property">messages</span>.<span class="title function_">next</span>(sendmsg);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="flask-uwsgi-websocket"><a href="#flask-uwsgi-websocket" class="headerlink" title="flask-uwsgi-websocket"></a><a href="https://github.com/zeekay/flask-uwsgi-websocket">flask-uwsgi-websocket</a></h2><p>使用另外一套的python的lib</p>
<p>安裝</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 install Flask-uWSGI-WebSocket</span><br></pre></td></tr></table></figure>

<p>刪除起動的uwsgi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pkill -f uwsgi -9</span><br></pre></td></tr></table></figure>

<p>使用<code>GeventWebSocket</code>可以收到兩個client</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,debug=<span class="string">&#x27;True&#x27;</span>,gevent=<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>使用<code>WebSocket</code>，只可服務一個</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Flask/" rel="tag"># Flask</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E4%BF%AE%E7%90%86%E7%9B%B8%E9%97%9C/" rel="prev" title="修理相關">
                  <i class="fa fa-angle-left"></i> 修理相關
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%E5%AD%B8%E7%BF%92ES2015-ES6-%E7%9A%84%E7%9B%B8%E9%97%9C%E7%9F%A5%E8%AD%98/%E5%AD%B8%E7%BF%92ES2015-ES6-%E7%9A%84%E7%9B%B8%E9%97%9C%E7%9F%A5%E8%AD%98/" rel="next" title="學習ES2015(ES6)的相關知識">
                  學習ES2015(ES6)的相關知識 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2018 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Tom Tang</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="回到頂端">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '60px',
  right: 'unset',
  left: '60px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
